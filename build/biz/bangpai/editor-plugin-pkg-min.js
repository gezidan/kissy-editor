KISSY.Editor.add("bangpai-music",function(A){var k=KISSY,l=k.UA,z=k.Event,s=k.Editor,r=k.DOM,x=k.Node,m=s.Config.base+"theme/loading.gif",B=s.Flash,i="ke_xiami",p=A.htmlDataProcessor,t=p&&p.dataFilter,a="\u8f93\u5165\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d";t&&t.addRules({elements:{object:function(b){var c=b.attributes,d=b.attributes.title,e;if(!(c.classid&&String(c.classid).toLowerCase())){for(c=0;c<b.children.length;c++){e=b.children[c];if(e.name=="embed"){if(!B.isFlashEmbed(e))break;if(/xiami\.com/i.test(e.attributes.src))return p.createFakeParserElement(b,
i,"bangpai-music",true,{title:d})}}return null}for(c=0;c<b.children.length;c++){e=b.children[c];if(e.name=="param"&&e.attributes.name=="movie")if(/xiami\.com/i.test(e.attributes.value))return p.createFakeParserElement(b,i,"bangpai-music",true,{title:d})}},embed:function(b){if(!B.isFlashEmbed(b))return null;if(/xiami\.com/i.test(b.attributes.src))return p.createFakeParserElement(b,i,"bangpai-music",true,{title:b.attributes.title})}}},4);s.BangPaiMusic||function(){function b(h){b.superclass.constructor.apply(this,
arguments);h.cfg.disableObjectResizing||z.on(h.document.body,l.ie?"resizestart":"resize",function(f){r.hasClass(f.target,i)&&f.preventDefault()})}function c(h){return g.replace(/\${([^}]+)}/g,function(f,o){return h[o]})}function d(h,f,o){return"<a class='ke-xiami-page-item ke-button"+(h==f?" ke-xiami-curpage":"")+"' data-value='"+f+"' href='#'>"+(o||f)+"</a>"}function e(h){return h._4e_name()==="img"&&!!h.hasClass(i)&&h}r.addStyleSheet(".ke-xiami-list {margin:10px 0 10px 0;padding:10px 20px 0 20px;border-top:1px solid #CED5E0;display:none;}.ke-xiami-list li{border:1px solid #CED5E0;border-width:0 0 1px 0;overflow:hidden;zoom:1;color:#646464;height:24px;line-height:24px;padding:0 20px 0 10px;}.ke-xiami-list .ke-xiami-add {float:right;}.ke-xiami-list .ke-xiami-song {float:left;width:300px;white-space:nowrap;overflow:hidden;}.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; padding:1px 7px;margin:0 3px;}.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {color:red;text-decoration:none;}.ke-xiami-paging {text-align:center;margin:20px -10px 0 -10px;}.ke-xiami-page-more {padding:0 10px;}",
"BangPaiMusic");var g="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=KISSY.Editor.BangPaiMusic.bangpai_xiami";k.extend(b,B,{_config:function(){this._cls=i;this._type="bangpai-music";this._title="\u867e\u7c73\u97f3\u4e50";this._bodyHtml="<div style='padding:20px 0;'><form action='#' class='ke-xiami-form' style='margin:0 20px;'><p class='ke-xiami-title'></p><p class='ke-xiami-url-wrap'><input class='ke-xiami-url ke-input' style='width:374px;vertical-align:middle;'/> &nbsp;  <button class='ke-xiami-submit'>\u641c \u7d22</button></p><p style='margin:10px 0'><label>\u5bf9 \u9f50\uff1a <select class='ke-xiami-align'><option value='none'>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></label><label style='margin-left:70px;'>\u95f4\u8ddd\uff1a  <input  data-verify='^\\d+$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570' class='ke-xiami-margin ke-input' style='width:60px;vertical-align:middle;' value='5'/> \u50cf\u7d20</label></p></form><div class='ke-xiami-list'></div></div>";
this._footHtml="<a class='ke-xiami-ok ke-button' style='margin-right:20px;'>\u786e&nbsp;\u5b9a</a><a class='ke-xiami-cancel ke-button'>\u53d6&nbsp;\u6d88</a>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u867e\u7c73\u97f3\u4e50";this._contextMenu=v;this._flashRules=["img."+i]},_updateTip:function(h,f){var o=this.editor.restoreRealElement(f);if(o){h.html(f.attr("title"));h.attr("href",this._getFlashUrl(o))}},_initD:function(){function h(n){var j=w.val();if(j.replace(/[^\x00-\xff]/g,"@@").length>30)alert("\u957f\u5ea6\u4e0a\u965030\u4e2a\u5b57\u7b26\uff081\u4e2a\u6c49\u5b57=2\u4e2a\u5b57\u7b26\uff09");else if(!k.trim(j)||
j==a)alert("\u4e0d\u80fd\u4e3a\u7a7a\uff01");else{f._xiami_submit.disable();j={key:encodeURIComponent(w.val()),page:n,random:(new Date).valueOf()};j=c(j);u.instance=f;u.page=n;f._xiamia_list.html("<img style='display:block;width:32px;height:32px;margin:5px auto 0 auto;'src='"+m+"'/><p style='width: 130px; margin: 15px auto 0; color: rgb(150, 150, 150);'>\u6b63\u5728\u641c\u7d22\uff0c\u8bf7\u7a0d\u5019......</p>");f._xiamia_list.show();var y=k.getScript(j,{timeout:10,success:function(){},error:function(){y.src="";f._xiami_submit.enable();f._xiamia_list.html("<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u8d85\u65f6\u4e86\uff0c\u8bf7\u91cd\u8bd5\uff01</p>")}})}}
var f=this,o=f.editor,q=f.d;q.el.one(".ke-xiami-form");var w=q.el.one(".ke-xiami-url");f.dAlign=s.Select.decorate(q.el.one(".ke-xiami-align"));f._xiami_input=w;s.Utils.placeholder(w,a);f._xiamia_list=q.el.one(".ke-xiami-list");f._xiami_submit=new s.TripleButton({el:q.el.one(".ke-xiami-submit"),cls:"ke-button",text:"\u641c&nbsp;\u7d22"});f._xiami_submit.on("offClick",function(){h(1)});w.on("keydown",function(n){n.keyCode===13&&h(1)});f.dMargin=q.el.one(".ke-xiami-margin");f._xiami_url_wrap=q.el.one(".ke-xiami-url-wrap");
f._xiamia_title=q.el.one(".ke-xiami-title");var C=q.foot.one(".ke-xiami-ok");q.foot.one(".ke-xiami-cancel").on("click",function(){q.hide()});C.on("click",function(){var n=f.selectedFlash,j=o.restoreRealElement(n);f._dinfo={url:f._getFlashUrl(j),attrs:{title:n.attr("title"),style:"margin:"+(parseInt(f.dMargin.val())||0)+"px;float:"+f.dAlign.val()+";"}};f._gen()},f);f._xiamia_list.on("click",function(n){n.preventDefault();var j=new x(n.target);n=j._4e_ascendant(function(y){return f._xiamia_list._4e_contains(y)&&
y.hasClass("ke-xiami-add")},true);j=j._4e_ascendant(function(y){return f._xiamia_list._4e_contains(y)&&y.hasClass("ke-xiami-page-item")},true);if(n){f._dinfo={url:"http://www.xiami.com/widget/"+n.attr("data-value")+"/singlePlayer.swf",attrs:{title:n.attr("title"),style:"margin:"+(parseInt(f.dMargin.val())||0)+"px;float:"+f.dAlign.val()+";"}};f._gen()}else j&&h(parseInt(j.attr("data-value")))})},_listSearch:function(h){var f,o=h.results,q="";if(h.key==k.trim(this._xiami_input.val())){this._xiami_submit.enable();
if(o&&o.length){q="<ul>";for(f=0;f<o.length;f++){var w=o[f],C=decodeURIComponent(w.song_name)+" - "+decodeURIComponent(w.artist_name);q=q;var n="<li title='"+C+"'><span class='ke-xiami-song'>",j=C;if(j.length>35)j=j.substring(0,35)+"...";q=q+(n+j+"</span><a href='#' title='"+C+"' class='ke-xiami-add' data-value='"+(w.album_id+"_"+w.song_id)+"'>\u6dfb\u52a0</a></li>")}q+="</ul>";o=h.page;h=Math.floor(h.total/8);f=o-1;w=o+1;if(h>1){q+="<p class='ke-xiami-paging'>";if(f<=2){w=Math.min(2-f+w,h-1);f=2}w=Math.min(w,
h-1);if(w==h-1)f=Math.max(2,w-3);if(o!=1)q+=d(o,o-1,"\u4e0a\u4e00\u9875");q+=d(o,1,"1");if(f!=2)q+="<span class='ke-xiami-page-more'>...</span>";for(f=f;f<=w;f++)q+=d(o,f);if(w!=h){if(w!=h-1)q+="<span class='ke-xiami-page-more'>...</span>";q+=d(o,h,h)}if(o!=h)q+=d(o,o+1,"\u4e0b\u4e00\u9875");q+="</p>"}}else q="<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u6ca1\u6709\u627e\u5230\u7ed3\u679c\uff01</p>";this._xiamia_list.html(q)}},_updateD:function(){var h=this.selectedFlash;if(h){this._xiami_input.val(h.attr("title"));this._xiamia_title.html(h.attr("title"));
this.dAlign.val(h.css("float"));this.dMargin.val(parseInt(h._4e_style("margin"))||0);this._xiami_url_wrap.hide();this.d.foot.show();this._xiamia_title.show()}else{s.Utils.resetInput(this._xiami_input);this.dAlign.val("none");this.dMargin.val("5");this._xiami_url_wrap.show();this.d.foot.hide();this._xiamia_title.hide();this._xiami_submit.enable()}this._xiamia_list.hide();this._xiamia_list.html("")},_getDInfo:function(){k.mix(this._dinfo.attrs,{width:257,height:33});return this._dinfo}});var v={"\u867e\u7c73\u5c5e\u6027":function(h){var f=
h.getSelection();f=f&&f.getStartElement();f=e(f);h=h._toolbars["bangpai-music"];f&&h.show(null,f)}};B.registerBubble("bangpai-music","\u867e\u7c73\u97f3\u4e50\uff1a ",e);s.BangPaiMusic=b;s.BangPaiMusic.bangpai_xiami=function(h){var f=u.instance;h.page=u.page;f._listSearch(h)};var u=s.BangPaiMusic.bangpai_xiami}();A.addPlugin(function(){new s.BangPaiMusic(A)})},{attach:false,requires:["flashsupport"]});
KISSY.Editor.add("bangpai-sourcearea",function(A){var k=KISSY.Editor,l=KISSY,z=l.Node;if(!(l.UA.gecko<1.92)){k.BangPaiSourceArea||function(){function s(m){this.editor=m;this._init()}var r=k.SOURCE_MODE,x=k.WYSIWYG_MODE;l.augment(s,{_init:function(){var m=this.editor,B=m.statusDiv,i=this.el=(new z("<span style='zoom:1;display:inline-block;height:22px;line-height:22px;'><input style='margin:0 5px;vertical-align:middle;' type='checkbox' /><span style='vertical-align:middle;'>\u7f16\u8f91\u6e90\u4ee3\u7801</span></span>")).appendTo(B).one("input");
i.on("click",this._check,this);m.on("sourcemode",function(){i[0].checked=true});m.on("wysiwygmode",function(){i[0].checked=false})},_check:function(){this.el[0].checked?this._show():this._hide()},_show:function(){this.editor.execCommand("sourceAreaSupport",r)},_hide:function(){this.editor.execCommand("sourceAreaSupport",x)}});k.BangPaiSourceArea=s}();A.addPlugin(function(){new k.BangPaiSourceArea(A)})}},{attach:false,requires:["sourceareasupport"]});
KISSY.Editor.add("bangpai-upload",function(A){var k=KISSY,l=k.Editor,z=k.UA;l.BangPaiUpload||function(){function s(a){this.editor=a;this._init()}var r=k.DOM,x=k.JSON,m=k.Node,B=l.SimpleOverlay,i=window[l.STORE],p=l.Config.base+l.Utils.debugUrl("plugins/uploader/uploader.swf?t=201010231802"),t={};r.addStyleSheet(".ke-upload-btn-wrap {position:relative;padding:15px 20px 15px 10px;}.ke-upload-list {width:100%;}.ke-upload-list th {border-top:1px solid #c1c8d1;background-color: #E7E9ED;background: -webkit-gradient(linear, left top, left bottom, from(#E7E9ED), to(#F1F4F7));background: -moz-linear-gradient(top, #E7E9ED, #F1F4F7);}.ke-upload-list td,.ke-upload-list th {padding:0em;height:26px;line-height:26px;text-align:center;border-bottom:1px solid #c1c8d1;}",
"ke-BangPaiUpload");k.augment(s,k.EventTarget,{_prepareShow:function(){var a=this,b=a.editor,c=b.cfg.pluginConfig["bangpai-upload"];a.dialog=new B({title:"\u6279\u91cf\u4e0a\u4f20",mask:false,draggable:"all",focusMgr:false,width:"600px"});var d=a.dialog;d.foot.hide();var e=d.body,g=(new m("<div class='ke-upload-btn-wrap'><span style='margin:0 15px 0 0px;color:#969696;display:inline-block;vertical-align:middle;width:469px;'></span></div>")).appendTo(e),v=(new m("<div style='display:none'>")).appendTo(e),u=new l.TripleButton({text:"\u6d4f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u89c8",
cls:"ke-button",container:g}),h=(new m("<div><table class='ke-upload-list'><thead><tr><th>\u5e8f\u53f7</th><th>\u56fe\u7247</th><th>\u5927\u5c0f</th><th style='width:35%'>\u4e0a\u4f20\u8fdb\u5ea6</th><th>\u56fe\u7247\u64cd\u4f5c</th></tr></thead><tbody></tbody></table></div>")).appendTo(v),f=h.one("tbody"),o=(new m("<p style='margin:15px 15px 30px; 0;text-align:right;'><a class='ke-button ke-bangpiaupload-ok'>\u786e\u5b9a\u4e0a\u4f20</a><a class='ke-button ke-bangpiaupload-insertall' style='margin-left:20px;'>\u5168\u90e8\u63d2\u5165</a><a class='ke-button ke-bangpiaupload-delall' style='margin-left:20px;'>\u6e05\u7a7a\u5217\u8868</a></p>")).appendTo(v),
q=o.one(".ke-bangpiaupload-ok");e=o.one(".ke-bangpiaupload-insertall");var w=o.one(".ke-bangpiaupload-delall");k.guid("ke-bangpai-upload");o=(new m("<span>")).insertBefore(o[0].firstChild);a._sizeLimit=c.sizeLimit||1E3;a._numberLimit=c.numberLimit||15;var C="\u5141\u8bb8\u7528\u6237\u540c\u65f6\u4e0a\u4f20"+a._numberLimit+"\u5f20\u56fe\u7247\uff0c\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7"+a._sizeLimit/1E3+"M";z.fpvGEQ("10.0.0")||(C="\u60a8\u7684flash\u63d2\u4ef6\u7248\u672c\u8fc7\u4f4e\uff0c\u8be5\u529f\u80fd\u4e0d\u53ef\u7528\uff0c\u8bf7<a href='http://get.adobe.com/cn/flashplayer/' target='_blank'>\u70b9\u6b64\u5347\u7ea7</a>");u.disable();g.one("span").html(C);if(z.fpvGEQ("10.0.0")){c.extraHtml&&
h.append(c.extraHtml);a._list=f;a._listTable=f.parent("table");a._listWrap=v;a._ds=c.serverUrl;a._dsp=c.serverParams||{};a._fileInput=c.fileInput||"Filedata";a.statusText=o;a.btn=u;a.up=q;c=u.el.offset();h=u.el.width()*2;u=u.el.height()*1.5;g=(new m("<div style='"+("position:absolute;width:"+h+"px;height:"+u+"px;z-index:"+b.baseZIndex(9999)+";")+"'>")).appendTo(g);g.offset(c);a.flashPos=g;g=new l.FlashBridge({movie:p,methods:["removeFile","cancel","disable","enable","setAllowMultipleFiles","setFileFilters",
"uploadAll"],holder:g,attrs:{width:h,height:u},params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,menu:true}});a.uploader=g;e.on("click",function(){for(var n=f.all("tr"),j=0;j<n.length;j++){var y=new m(n[j]),D=y.attr("url");if(D){b.insertElement(new m("<p>&nbsp;<img src='"+D+"'/>&nbsp;</p>",null,b.document));a._removeTrFile(y);a._removeTrFile(y)}}if(D){v.hide();d.hide()}});w.on("click",function(){for(var n=f.all("tr"),j=0;j<n.length;j++){var y=new m(n[j]);a._removeTrFile(y)}v.hide()});
f.on("click",function(n){var j=new m(n.target);n.halt();if(j.hasClass("ke-upload-insert")){n=j.parent("tr");url=n.attr("url");b.insertElement(new m("<img src='"+url+"'/>",null,b.document))}if(j.hasClass("ke-upload-delete")||j.hasClass("ke-upload-insert")){n=j.parent("tr");a._removeTrFile(n)}});g.on("fileSelect",a._onSelect,a);g.on("uploadStart",a._onUploadStart,a);g.on("uploadProgress",a._onProgress,a);g.on("uploadComplete",a._onComplete,a);g.on("uploadCompleteData",a._onUploadCompleteData,a);g.on("swfReady",
a._ready,a);g.on("uploadError",a._uploadError,a);a._restore()}},_removeTrFile:function(a){var b=a.attr("fid"),c=this.uploader;if(b){try{c.cancel(b)}catch(d){}c.removeFile(b)}if(t[b]){t[b].destroy();delete t[b]}a._4e_remove();this.denable();this._syncStatus()},_init:function(){var a=this,b=a.editor,c=new l.TripleButton({contentCls:"ke-toolbar-mul-image",title:"\u6279\u91cf\u63d2\u56fe",container:b.toolBarDiv});c.on("offClick",a.show,a);a.el=c;l.Utils.lazyRun(a,"_prepareShow","_realShow");l.Utils.sourceDisable(b,a);a.disable();
l.storeReady(function(){a.enable()})},disable:function(){this.el.disable()},enable:function(){this.el.boff()},_realShow:function(){this.dialog.show()},show:function(){this._prepareShow()},_uploadError:function(a){var b=a.id,c=this._getFileTr(b);b=t[b];var d=a.status;if(!a._custom){k.log(d);d="\u670d\u52a1\u5668\u51fa\u9519\u6216\u683c\u5f0f\u4e0d\u6b63\u786e"}if(c){b&&b.destroy();c.one(".ke-upload-progress").html("<div style='color:red;'>"+d+"</div>")}},_getFileTr:function(a){for(var b=this._list.all("tr"),c=0;c<b.length;c++){var d=new m(b[c]);if(d.attr("fid")==
a)return d}},_onUploadStart:function(a){this.uploader.removeFile(a.id)},_onComplete:function(){},_onUploadCompleteData:function(a){var b=k.trim(a.data).replace(/\r|\n/g,"");a=a.id;if(b){b=x.parse(b);if(b.error)this._uploadError({id:a,_custom:1,status:b.error});else{if(a=this._getFileTr(a)){a.one(".ke-upload-insert").show();a.attr("url",b.imgUrl)}this._syncStatus()}}},_onProgress:function(a){var b=Math.floor(a.bytesLoaded*100/a.bytesTotal);(a=t[a.id])&&a.set("progress",b)},ddisable:function(){this.uploader.disable();
this.btn.disable();this.flashPos.offset({left:-9999,top:-9999})},denable:function(){this.uploader.enable();this.btn.enable();this.flashPos.offset(this.btn.el.offset())},_syncStatus:function(){var a=this._list,b=1,c=a.all("tr");if(c.length==0)this._listWrap.hide();else{a.all(".ke-upload-seq").each(function(e){e.html(b++)});for(var d=a=0;d<c.length;d++)(new m(c[d])).attr("url")||a++;this.statusText.html("\u961f\u5217\u4e2d\u5269\u4f59"+a+"\u5f20\u56fe\u7247\uff0c\u70b9\u51fb\u786e\u5b9a\u4e0a\u4f20\uff0c\u5f00\u59cb\u4e0a\u4f20\u3002 ")}this._save()},_restore:function(){var a=i.getItem("Multi-Upload-Save"),
b=this._list[0];if(a){a=x.parse(decodeURIComponent(a));for(var c=0;c<a.length;c++){var d=a[c];d.complete=1;d.fid="restore_"+c;this._createFileTr(b,d).attr("url",d.url)}if(d){this._listWrap.show();this._syncStatus()}}},_save:function(){for(var a=this._list.all("tr"),b=[],c=0;c<a.length;c++){var d=new m(a[c]),e=d.attr("url");if(e){var g=d.one(".ke-upload-filesize").html();d=d.one(".ke-upload-filename").html();b.push({name:d,size:g,url:e})}}i.setItem("Multi-Upload-Save",encodeURIComponent(x.stringify(b)))},
_getFilesSize:function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b},_createFileTr:function(a,b){var c=b.fid,d=a.insertRow(-1);r.attr(d,"fid",c);var e=d.insertCell(-1);r.attr(e,"class","ke-upload-seq");e=d.insertCell(-1);if(b.name.length>18)b.name=b.name.substring(0,18)+"...";r.html(e,b.name);r.attr(e,"class","ke-upload-filename");e=d.insertCell(-1);r.html(e,b.size);r.attr(e,"class","ke-upload-filesize");e=d.insertCell(-1);r.attr(e,"class","ke-upload-progress");e=d.insertCell(-1);r.html(e,
"<a href='#' class='ke-upload-insert' "+(b.complete?"":"style='display:none'")+">[\u63d2\u5165]</a> &nbsp; <a href='#' class='ke-upload-delete'>[\u5220\u9664]</a> &nbsp;");d=new m(d);d.one(".ke-upload-progress");if(parseInt(b.size)>this._sizeLimit){this._uploadError({id:c,_custom:1,status:"\u56fe\u7247\u592a\u5927\uff0c\u8bf7\u538b\u7f29\u81f3 n M\u4ee5\u4e0b".replace(/n/,this._sizeLimit/1E3)});this.uploader.removeFile(c)}else{t[c]=new l.ProgressBar({container:d.one(".ke-upload-progress"),width:"100px",height:"15px"});b.complete&&t[c].set("progress",100)}return d},_onSelect:function(a){var b=
this.uploader,c=this._list,d=0;a=a.fileList;var e=this._numberLimit;if(a){e=c.children("tr");for(c=0;c<e.length;c++){var g=r.attr(e[c],"fid");g&&a[g]&&delete a[g]}e=this._numberLimit-e.length;g=this._getFilesSize(a);g>e&&alert("\u7cfb\u7edf\u5c06\u53ea\u4fdd\u7559 n \u5f20".replace(/n/,this._numberLimit));g>=e&&this.ddisable();this._listWrap.show();g=this._list[0];for(c in a)if(a.hasOwnProperty(c)){d++;var v=a[c],u=Math.floor(v.size/1E3),h=v.id;d>e?b.removeFile(h):this._createFileTr(g,{size:u+"k",fid:h,name:v.name})}this._syncStatus()}},
_ready:function(){var a=this,b=a.uploader,c=a.up,d=a.btn,e=a.flashPos,g=l.Utils.normParams;d.enable();e.offset(d.el.offset());b.setAllowMultipleFiles(true);b.setFileFilters([{extensions:"*.jpeg;*.jpg;*.png;*.gif",description:"\u56fe\u7247\u6587\u4ef6( png,jpg,jpeg,gif )"}]);c.detach();c.on("click",function(v){v.halt();b.uploadAll(a._ds,"POST",g(a._dsp),a._fileInput)})}});l.BangPaiUpload=s}();A.addPlugin(function(){new l.BangPaiUpload(A)})},{attach:false,requires:["flashutils","progressbar","flashbridge","overlay","localStorage"]});
KISSY.Editor.add("bangpai-upload",function(A){var k=KISSY,l=k.Editor,z=k.UA;l.BangPaiUpload||function(){function s(a){this.editor=a;this._init()}var r=k.DOM,x=k.JSON,m=k.Node,B=l.SimpleOverlay;x=k.JSON;var i=window[l.STORE],p=l.Config.base+l.Utils.debugUrl("plugins/uploader/uploader.longzang.swf?t=201010231602"),t={};r.addStyleSheet(".ke-upload-btn-wrap {position:relative;padding:15px 20px 15px 10px;}.ke-upload-list {width:100%;}.ke-upload-list th {border-top:1px solid #c1c8d1;background-color: #E7E9ED;background: -webkit-gradient(linear, left top, left bottom, from(#E7E9ED), to(#F1F4F7));background: -moz-linear-gradient(top, #E7E9ED, #F1F4F7);}.ke-upload-list td,.ke-upload-list th {padding:0em;height:26px;line-height:26px;text-align:center;border-bottom:1px solid #c1c8d1;}",
"ke-BangPaiUpload");k.augment(s,k.EventTarget,{_prepareShow:function(){var a=this,b=a.editor,c=b.cfg.pluginConfig["bangpai-upload"];a.dialog=new B({title:"\u6279\u91cf\u4e0a\u4f20",mask:false,draggable:"all",focusMgr:false,width:"600px"});var d=a.dialog;d.foot.hide();var e=d.body,g=(new m("<div class='ke-upload-btn-wrap'><span style='margin:0 15px 0 0px;color:#969696;display:inline-block;vertical-align:middle;width:469px;'></span></div>")).appendTo(e),v=(new m("<div style='display:none'>")).appendTo(e),u=new l.TripleButton({text:"\u6d4f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u89c8",
cls:"ke-button",container:g}),h=(new m("<div><table class='ke-upload-list'><thead><tr><th>\u5e8f\u53f7</th><th>\u56fe\u7247</th><th>\u5927\u5c0f</th><th style='width:35%'>\u4e0a\u4f20\u8fdb\u5ea6</th><th>\u56fe\u7247\u64cd\u4f5c</th></tr></thead><tbody></tbody></table></div>")).appendTo(v),f=h.one("tbody"),o=(new m("<p style='margin:15px 15px 30px; 0;text-align:right;'><a class='ke-button ke-bangpiaupload-ok'>\u786e\u5b9a\u4e0a\u4f20</a><a class='ke-button ke-bangpiaupload-insertall' style='margin-left:20px;'>\u5168\u90e8\u63d2\u5165</a><a class='ke-button ke-bangpiaupload-delall' style='margin-left:20px;'>\u6e05\u7a7a\u5217\u8868</a></p>")).appendTo(v),
q=o.one(".ke-bangpiaupload-ok");e=o.one(".ke-bangpiaupload-insertall");var w=o.one(".ke-bangpiaupload-delall");k.guid("ke-bangpai-upload");o=(new m("<span>")).insertBefore(o[0].firstChild);a._sizeLimit=c.sizeLimit||1E4;a._numberLimit=c.numberLimit||15;var C="\u5141\u8bb8\u7528\u6237\u540c\u65f6\u4e0a\u4f20"+a._numberLimit+"\u5f20\u56fe\u7247\uff0c\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7"+a._sizeLimit/1E3+"M";z.fpvGEQ("10.0.0")||(C="\u60a8\u7684flash\u63d2\u4ef6\u7248\u672c\u8fc7\u4f4e\uff0c\u8be5\u529f\u80fd\u4e0d\u53ef\u7528\uff0c\u8bf7<a href='http://get.adobe.com/cn/flashplayer/' target='_blank'>\u70b9\u6b64\u5347\u7ea7</a>");u.disable();g.one("span").html(C);if(z.fpvGEQ("10.0.0")){c.extraHtml&&
h.append(c.extraHtml);a._list=f;a._listTable=f.parent("table");a._listWrap=v;a._ds=c.serverUrl;a._dsp=c.serverParams||{};a._fileInput=c.fileInput||"Filedata";a.statusText=o;a.btn=u;a.up=q;c=u.el.offset();h=u.el.width()*2;u=u.el.height()*1.5;g=(new m("<div style='"+("position:absolute;width:"+h+"px;height:"+u+"px;z-index:"+b.baseZIndex(9999)+";")+"'>")).appendTo(g);g.offset(c);a.flashPos=g;g=new l.FlashBridge({movie:p,ajbridge:true,methods:["cancel","removeFile","lock","unlock","setAllowMultipleFiles",
"setFileFilters","uploadAll"],holder:g,attrs:{width:h,height:u},params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,btn:true,hand:true}});a.uploader=g;e.on("click",function(){for(var n=f.all("tr"),j=0;j<n.length;j++){var y=new m(n[j]),D=y.attr("url");if(D){b.insertElement(new m("<p>&nbsp;<img src='"+D+"'/>&nbsp;</p>",null,b.document));a._removeTrFile(y)}}if(D){v.hide();d.hide()}});f.on("click",function(n){var j=new m(n.target);n.halt();if(j.hasClass("ke-upload-insert")){n=j.parent("tr");
url=n.attr("url");b.insertElement(new m("<img src='"+url+"'/>",null,b.document))}if(j.hasClass("ke-upload-delete")||j.hasClass("ke-upload-insert")){n=j.parent("tr");a._removeTrFile(n)}});w.on("click",function(){for(var n=f.all("tr"),j=0;j<n.length;j++){var y=new m(n[j]);a._removeTrFile(y)}v.hide()});g.on("fileSelect",a._onSelect,a);g.on("uploadStart",a._onUploadStart,a);g.on("uploadProgress",a._onProgress,a);g.on("uploadCompleteData",a._onUploadCompleteData,a);g.on("contentReady",a._ready,a);g.on("uploadError",
a._uploadError,a);a._restore()}},_removeTrFile:function(a){var b=a.attr("fid"),c=this.uploader;if(b){try{c.cancel(b)}catch(d){}c.removeFile(b)}if(t[b]){t[b].destroy();delete t[b]}a._4e_remove();this.denable();this._syncStatus()},_init:function(){var a=this,b=a.editor,c=new l.TripleButton({contentCls:"ke-toolbar-mul-image",title:"\u6279\u91cf\u63d2\u56fe",container:b.toolBarDiv});c.on("offClick",a.show,a);a.el=c;l.Utils.lazyRun(a,"_prepareShow","_realShow");l.Utils.sourceDisable(b,a);a.disable();l.storeReady(function(){a.enable()})},
disable:function(){this.el.disable()},enable:function(){this.el.boff()},_realShow:function(){this.dialog.show()},show:function(){this._prepareShow()},_uploadError:function(a){var b=a.id||a.file&&a.file.id;if(b){var c=this._getFileTr(b);b=t[b];var d=a.status;if(!a._custom){k.log(d);d="\u670d\u52a1\u5668\u51fa\u9519\u6216\u683c\u5f0f\u4e0d\u6b63\u786e"}if(c){b&&b.destroy();c.one(".ke-upload-progress").html("<div style='color:red;'>"+d+"</div>")}}else k.log(a)},_getFileTr:function(a){for(var b=this._list.all("tr"),c=0;c<b.length;c++){var d=new m(b[c]);if(d.attr("fid")==
a)return d}},_onUploadStart:function(a){this.uploader.removeFile(a.file.id)},_onUploadCompleteData:function(a){var b=k.trim(a.data).replace(/\r|\n/g,"");a=a.file.id;if(b){b=x.parse(b);if(b.error)this._uploadError({id:a,_custom:1,status:b.error});else{if(a=this._getFileTr(a)){a.one(".ke-upload-insert").show();a.attr("url",b.imgUrl)}this._syncStatus()}}},_onProgress:function(a){var b=Math.floor(a.bytesLoaded*100/a.bytesTotal);(a=t[a.file.id])&&a.set("progress",b)},ddisable:function(){this.uploader.lock();
this.btn.disable();this.flashPos.offset({left:-9999,top:-9999})},denable:function(){this.uploader.unlock();this.btn.enable();this.flashPos.offset(this.btn.el.offset())},_syncStatus:function(){var a=this._list,b=1,c=a.all("tr");if(c.length==0)this._listWrap.hide();else{a.all(".ke-upload-seq").each(function(e){e.html(b++)});for(var d=a=0;d<c.length;d++)(new m(c[d])).attr("url")||a++;this.statusText.html("\u961f\u5217\u4e2d\u5269\u4f59"+a+"\u5f20\u56fe\u7247\uff0c\u70b9\u51fb\u786e\u5b9a\u4e0a\u4f20\uff0c\u5f00\u59cb\u4e0a\u4f20\u3002 ")}this._save()},_restore:function(){var a=i.getItem("Multi-Upload-Save"),
b=this._list[0],c,d;if(a){a=x.parse(decodeURIComponent(a));for(var e=0;e<a.length;e++){c=a[e];c.complete=1;c.fid="restore_"+e;d=this._createFileTr(b,c);d.attr("url",c.url)}if(c){this._listWrap.show();this._syncStatus()}}},_save:function(){for(var a=this._list.all("tr"),b=[],c,d,e,g=0;g<a.length;g++){c=new m(a[g]);if(d=c.attr("url")){e=c.one(".ke-upload-filesize").html();c=c.one(".ke-upload-filename").html();b.push({name:c,size:e,url:d})}}i.setItem("Multi-Upload-Save",encodeURIComponent(x.stringify(b)))},
_getFilesSize:function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b},_createFileTr:function(a,b){var c=b.fid,d=a.insertRow(-1),e,g=this._sizeLimit;r.attr(d,"fid",c);e=d.insertCell(-1);r.attr(e,"class","ke-upload-seq");e=d.insertCell(-1);if(b.name.length>18)b.name=b.name.substring(0,18)+"...";r.html(e,b.name);r.attr(e,"class","ke-upload-filename");e=d.insertCell(-1);r.html(e,b.size);r.attr(e,"class","ke-upload-filesize");e=d.insertCell(-1);r.attr(e,"class","ke-upload-progress");e=d.insertCell(-1);
r.html(e,"<a href='#' class='ke-upload-insert' "+(b.complete?"":"style='display:none'")+">[\u63d2\u5165]</a> &nbsp; <a href='#' class='ke-upload-delete'>[\u5220\u9664]</a> &nbsp;");d=new m(d);d.one(".ke-upload-progress");if(parseInt(b.size)>g){this._uploadError({id:c,_custom:1,status:"\u56fe\u7247\u592a\u5927\uff0c\u8bf7\u538b\u7f29\u81f3 n M\u4ee5\u4e0b".replace(/n/,g/1E3)});this.uploader.removeFile(c)}else{t[c]=new l.ProgressBar({container:d.one(".ke-upload-progress"),width:"100px",height:"15px"});b.complete&&t[c].set("progress",100)}return d},_onSelect:function(a){var b=
this.uploader,c=this._list,d=0;a=a.fileList;var e=this._numberLimit,g;if(a){e=c.children("tr");for(c=0;c<e.length;c++)(g=r.attr(e[c],"fid"))&&a[g]&&delete a[g];e=this._numberLimit-e.length;g=this._getFilesSize(a);g>e&&alert("\u7cfb\u7edf\u5c06\u53ea\u4fdd\u7559 n \u5f20".replace(/n/,this._numberLimit));g>=e&&this.ddisable();this._listWrap.show();g=this._list[0];for(c in a)if(a.hasOwnProperty(c)){d++;var v=a[c],u=Math.floor(v.size/1E3),h=v.id;d>e?b.removeFile(h):this._createFileTr(g,{size:u+"k",fid:h,name:v.name})}this._syncStatus()}},
_ready:function(){var a=this,b=a.uploader,c=a.up,d=a.btn,e=a.flashPos,g=l.Utils.normParams;d.enable();e.offset(d.el.offset());b.setAllowMultipleFiles(true);b.setFileFilters([{ext:"*.jpeg;*.jpg;*.png;*.gif",desc:"\u56fe\u7247\u6587\u4ef6( png,jpg,jpeg,gif )"}]);c.detach();c.on("click",function(v){v.halt();b.uploadAll(a._ds,"POST",g(a._dsp),true,a._fileInput)})}});l.BangPaiUpload=s}();A.addPlugin(function(){new l.BangPaiUpload(A)})},{attach:false,requires:["flashutils","progressbar","flashbridge","overlay","localStorage"]});
KISSY.Editor.add("bangpai-video",function(A){function k(i){for(var p=0;p<B.length;p++){var t=B[p];if(t.reg.test(i))return t}}var l=KISSY,z=l.Editor,s="ke_video",r=z.Flash,x=A.htmlDataProcessor,m=x&&x.dataFilter;m&&m.addRules({elements:{object:function(i){var p=i.attributes;if(!(p.classid&&String(p.classid).toLowerCase())){for(p=0;p<i.children.length;p++)if(i.children[p].name=="embed"){if(!r.isFlashEmbed(i.children[p]))break;if(k(i.children[p].attributes.src))return x.createFakeParserElement(i,s,"bangpai-video",
true)}return null}for(p=0;p<i.children.length;p++){var t=i.children[p];if(t.name=="param"&&t.attributes.name=="movie")if(k(t.attributes.value))return x.createFakeParserElement(i,s,"bangpai-video",true)}},embed:function(i){if(!r.isFlashEmbed(i))return null;if(k(i.attributes.src))return x.createFakeParserElement(i,s,"bangpai-video",true)}}},4);var B=[{reg:/youku\.com/i,width:480,height:400,detect:function(i){var p=i.match(/id_([^.]+)\.html$/);if(p)return"http://player.youku.com/player.php/sid/"+p[1]+
"/v.swf";i.match(/v_playlist\/([^.]+)\.html$/);return i}},{reg:/tudou\.com/i,width:480,height:400,detect:function(i){return i}},{reg:/ku6\.com/i,width:480,height:400,detect:function(i){var p=i.match(/show[^\/]*\/([^.]+)\.html$/);if(p)return"http://player.ku6.com/refer/"+p[1]+"/v.swf";return i}}];z.BangPaiVideo||function(){function i(){i.superclass.constructor.apply(this,arguments)}function p(b){return b._4e_name()==="img"&&!!b.hasClass(s)&&b}var t=["img."+s];l.extend(i,r,{_config:function(){var b=
this.editor.cfg.pluginConfig;this._cls=s;this._type="bangpai-video";this._title="\u89c6\u9891";this._bodyHtml="<div style='padding:20px 20px 0 20px'><p><label>\u94fe\u63a5\uff1a <input class='ke-video-url ke-input' style='width:410px;vertical-align:middle;'/></label></p><table style='margin:10px 0 5px  40px;width:400px;'><tr><td><label>\u5bbd\u5ea6\uff1a  <input  data-verify='^(\u81ea\u52a8|((?!0$)\\d+))$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-video-width ke-input' style='width:60px;margin-left:2px;vertical-align:middle;' value='\u81ea\u52a8'/> \u50cf\u7d20</label></td><td><label> \u9ad8\u5ea6\uff1a  <input  data-verify='^(\u81ea\u52a8|((?!0$)\\d+))$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-video-height ke-input' style='width:60px;vertical-align:middle;' value='\u81ea\u52a8'/> \u50cf\u7d20</label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-video-align'><option value='none'>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label>\u95f4\u8ddd\uff1a <input  data-verify='^\\d+$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570' class='ke-video-margin ke-input' style='width:60px;vertical-align:middle;' value='5'/> \u50cf\u7d20</label></td></tr></table></div>";
this._footHtml="<a class='ke-video-ok ke-button' style='margin-left:40px;margin-right:20px;'>\u786e\u5b9a</button> <a class='ke-video-cancel ke-button'>\u53d6\u6d88</a>";this._contentCls="ke-toolbar-video";this._tip="\u63d2\u5165\u89c6\u9891";this._contextMenu=a;this._flashRules=t;this.urlCfg=b["bangpai-video"]&&b["bangpai-video"].urlCfg;this._urlTip="\u8bf7\u8f93\u5165\u4f18\u9177\u7f51\u3001\u571f\u8c46\u7f51\u3001\u91776\u7f51\u7684\u89c6\u9891\u64ad\u653e\u9875\u94fe\u63a5..."},_initD:function(){var b=this.d,c=b.el;this.dUrl=c.one(".ke-video-url");this.dAlign=z.Select.decorate(c.one(".ke-video-align"));this.dMargin=c.one(".ke-video-margin");
this.dWidth=c.one(".ke-video-width");this.dHeight=c.one(".ke-video-height");var d=c.one(".ke-video-ok");c=c.one(".ke-video-cancel");d.on("click",this._gen,this);c.on("click",function(){b.hide()});z.Utils.placeholder(this.dUrl,this._urlTip)},_getDInfo:function(){var b=this.dUrl.val(),c=k(b);if(c){if(b=c.detect(b))return{url:b,attrs:{height:parseInt(this.dHeight.val())||c.height,width:parseInt(this.dWidth.val())||c.width,style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;float:"+this.dAlign.val()+
";"}}}else alert("\u4e0d\u652f\u6301\u8be5\u94fe\u63a5\u6765\u6e90!")},_gen:function(){var b=this.dUrl.val(),c=this.urlCfg;if(c)for(var d=0;d<c.length;d++){var e=c[d];if(e.reg.test(b)){this.d.loading();i.dynamicUrl.origin=b;i.dynamicUrl.instance=this;setTimeout(function(){l.getScript(e.url.replace(/@url@/,encodeURIComponent(b)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")))},30);return}}i.superclass._gen.call(this)},_dynamicUrlPrepare:function(b){this.dUrl.val(b);this.d.unloading();i.superclass._gen.call(this)},
_updateD:function(){var b=this.editor,c=this.selectedFlash;if(c){b=b.restoreRealElement(c);this.dUrl.val(this._getFlashUrl(b));this.dAlign.val(c.css("float"));this.dMargin.val(parseInt(b._4e_style("margin"))||0);c.css("width")&&this.dWidth.val(parseInt(c.css("width")));c.css("height")&&this.dHeight.val(parseInt(c.css("height")))}else{z.Utils.resetInput(this.dUrl);this.dAlign.val("none");this.dMargin.val("5");this.dWidth.val("\u81ea\u52a8");this.dHeight.val("\u81ea\u52a8")}}});i.dynamicUrl=function(b,c){l.trim(b)==l.trim(i.dynamicUrl.origin)&&
i.dynamicUrl.instance._dynamicUrlPrepare(c)};r.registerBubble("bangpai-video","\u89c6\u9891\u94fe\u63a5\uff1a ",p);z.BangPaiVideo=i;var a={"\u89c6\u9891\u5c5e\u6027":function(b){var c=b.getSelection();c=(c=c&&c.getStartElement())&&p(c);b=b._toolbars["bangpai-video"];c&&b.show(null,c)}}}();A.addPlugin(function(){new z.BangPaiVideo(A)})},{attach:false,requires:["flashsupport"]});
