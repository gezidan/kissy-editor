KISSY.Editor.add("bangpai-music",function(u){var j=KISSY,s=j.UA,x=j.Event,p=j.Editor,q=j.DOM,y=j.Node,v=p.Config.base+"theme/loading.gif",f=p.Flash,a="ke_xiami",d=u.htmlDataProcessor,h=d&&d.dataFilter;h&&h.addRules({elements:{object:function(i){var c=i.attributes,g=i.attributes.title,n;if(!(c.classid&&String(c.classid).toLowerCase())){for(c=0;c<i.children.length;c++){n=i.children[c];if(n.name=="embed"){if(!f.isFlashEmbed(n))break;if(/xiami\.com/i.test(n.attributes.src))return d.createFakeParserElement(i,
a,"bangpai-music",true,{title:g})}}return null}for(c=0;c<i.children.length;c++){n=i.children[c];if(n.name=="param"&&n.attributes.name=="movie")if(/xiami\.com/i.test(n.attributes.value))return d.createFakeParserElement(i,a,"bangpai-music",true,{title:g})}},embed:function(i){if(!f.isFlashEmbed(i))return null;if(/xiami\.com/i.test(i.attributes.src))return d.createFakeParserElement(i,a,"bangpai-music",true,{title:i.attributes.title})}}},4);p.BangPaiMusic||function(){function i(e){i.superclass.constructor.apply(this,
arguments);e.cfg.disableObjectResizing||x.on(e.document.body,s.ie?"resizestart":"resize",function(b){q.hasClass(b.target,a)&&b.preventDefault()})}function c(e){return w.replace(/\${([^}]+)}/g,function(b,l){return e[l]})}function g(e,b,l){return"<a class='ke-xiami-page-item"+(e==b?" ke-xiami-curpage":"")+"' data-value='"+b+"' href='#'>"+(l||b)+"</a>"}function n(e){return e._4e_name()==="img"&&!!e.hasClass(a)&&e}q.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(e){var b=bangpai_xiami.instance;e.page=bangpai_xiami.page;b._listSearch(e)};var w="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";j.extend(i,f,{_config:function(){this._cls=a;this._type="bangpai-music";this._title="\u867e\u7c73\u5c5e\u6027";this._bodyHtml="<form action='#' class='ke-xiami-form'><p class='ke-xiami-title'></p><p class='ke-xiami-url-wrap'><input class='ke-xiami-url ke-input' style='width:300px;vertical-align:middle;'/> &nbsp;  <button class='ke-xiami-submit'>\u641c \u7d22 </button></p><p style='margin:10px 0'><label>\u5bf9 \u9f50\uff1a <select class='ke-xiami-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select><label style='margin-left:45px;'>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-xiami-margin ke-input' style='width:60px' value='5'/> \u50cf\u7d20</label></p></form><div class='ke-xiami-list'></div>";
this._footHtml="<button class='ke-xiami-ok ke-button'>\u786e&nbsp;\u5b9a</button><button class='ke-xiami-cancel ke-button' style='margin-left:20px;'>\u53d6&nbsp;\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u867e\u7c73\u97f3\u4e50";this._contextMenu=t;this._flashRules=["img."+a];this._config_dwidth="430px"},_updateTip:function(e,b){var l=this.editor.restoreRealElement(b);if(l){e.html(b.attr("title"));e.attr("href",this._getFlashUrl(l))}},_initD:function(){function e(r){var o=m.val();if(o.replace(/[^\x00-\xff]/g,"@@").length>
30)alert("\u957f\u5ea6\u4e0a\u965030\u4e2a\u5b57\u7b26\uff081\u4e2a\u6c49\u5b57=2\u4e2a\u5b57\u7b26\uff09");else if(j.trim(o)){b._xiami_submit.disable();o={key:encodeURIComponent(m.val()),page:r,random:(new Date).valueOf()};o=c(o);bangpai_xiami.instance=b;bangpai_xiami.page=r;b._xiamia_list.html("<img style='display:block;width:108px;margin:5px auto 0 auto;'src='"+v+"'/>");var z=j.getScript(o,{timeout:10,success:function(){},error:function(){z.src="";b._xiami_submit.enable();b._xiamia_list.html("<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u8d85\u65f6\u4e86\uff0c\u8bf7\u91cd\u8bd5\uff01</p>")}})}else alert("\u4e0d\u80fd\u4e3a\u7a7a\uff01")}
var b=this,l=b.editor,k=b.d;k.el.one(".ke-xiami-form");var m=k.el.one(".ke-xiami-url");b.dAlign=p.Select.decorate(k.el.one(".ke-xiami-align"));b._xiami_input=m;p.Utils.placeholder(m,"\u8f93\u5165\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d");b._xiamia_list=k.el.one(".ke-xiami-list");b._xiami_submit=new p.TripleButton({el:k.el.one(".ke-xiami-submit"),cls:"ke-button",text:"\u641c&nbsp;\u7d22"});b._xiami_submit.on("offClick",function(){e(1)});m.on("keydown",function(r){r.keyCode===13&&e(1)});b.dMargin=k.el.one(".ke-xiami-margin");b._xiami_url_wrap=k.el.one(".ke-xiami-url-wrap");
b._xiamia_title=k.el.one(".ke-xiami-title");var A=k.foot.one(".ke-xiami-ok");k.foot.one(".ke-xiami-cancel").on("click",function(){k.hide()});A.on("click",function(){var r=b.selectedFlash,o=l.restoreRealElement(r);b._dinfo={url:b._getFlashUrl(o),attrs:{title:r.attr("title"),align:b.dAlign.val(),style:"margin:"+(parseInt(b.dMargin.val())||0)+"px;"}};b._gen()},b);b._xiamia_list.on("click",function(r){r.preventDefault();var o=new y(r.target);r=o._4e_ascendant(function(z){return b._xiamia_list._4e_contains(z)&&
z.hasClass("ke-xiami-add")},true);o=o._4e_ascendant(function(z){return b._xiamia_list._4e_contains(z)&&z.hasClass("ke-xiami-page-item")},true);if(r){b._dinfo={url:"http://www.xiami.com/widget/"+r.attr("data-value")+"/singlePlayer.swf",attrs:{title:r.attr("title"),align:b.dAlign.val(),style:"margin:"+(parseInt(b.dMargin.val())||0)+"px;"}};b._gen()}else o&&e(parseInt(o.attr("data-value")))})},_listSearch:function(e){var b,l=e.results,k="";if(e.key==j.trim(this._xiami_input.val())){this._xiami_submit.enable();
if(l&&l.length){k="<ul>";for(b=0;b<l.length;b++){var m=l[b],A=decodeURIComponent(m.song_name)+" - "+decodeURIComponent(m.artist_name);k=k;var r="<li title='"+A+"'><span class='ke-xiami-song'>",o=A;if(o.length>35)o=o.substring(0,35)+"...";k=k+(r+o+"</span><a href='#' title='"+A+"' class='ke-xiami-add' data-value='"+(m.album_id+"_"+m.song_id)+"'>\u9009\u62e9</a></li>")}k+="</ul>";l=e.page;e=Math.floor(e.total/8);b=l-3;m=l+3;if(e>1){if(b<=2){m=Math.min(2-b+m,e-1);b=2}m=Math.min(m,e-1);if(m==e-1)b=Math.max(2,m-
6);k+="<p class='ke-xiami-paging'>"+g(l,1,"1"+(b!=2?"...":""));for(b=b;b<=m;b++)k+=g(l,b);if(m!=e)k+=g(l,e,(m!=e-1?"...":"")+e);k+="</p>"}}else k="<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u6ca1\u6709\u627e\u5230\u7ed3\u679c\uff01</p>";this._xiamia_list.html(k)}},_updateD:function(){var e=this.selectedFlash;if(e){this._xiami_input.val(e.attr("title"));this._xiamia_title.html(e.attr("title"));this.dAlign.val(e.attr("align"));this.dMargin.val(parseInt(e._4e_style("margin"))||0);this._xiami_url_wrap.hide();this.d.foot.show();
this._xiamia_title.show()}else{p.Utils.resetInput(this._xiami_input);this.dAlign.val("");this.dMargin.val("5");this._xiami_url_wrap.show();this.d.foot.hide();this._xiamia_title.hide()}this._xiamia_list.html("")},_getDInfo:function(){j.mix(this._dinfo.attrs,{width:257,height:33});return this._dinfo}});var t={"\u867e\u7c73\u5c5e\u6027":function(e){var b=e.getSelection();b=b&&b.getStartElement();b=n(b);e=e._toolbars["bangpai-music"];b&&e.show(null,b)}};f.registerBubble("bangpai-music","\u867e\u7c73\u97f3\u4e50\uff1a ",n);p.BangPaiMusic=i}();u.addPlugin(function(){new p.BangPaiMusic(u)})},
{attach:false,requires:["flashsupport"]});
KISSY.Editor.add("bangpai-upload",function(u){var j=KISSY,s=j.Editor;if(!s.BangPaiUpload){(function(){function x(f){this.editor=f;this._init()}var p=j.DOM,q=j.Node,y=s.Config.base+s.Utils.debugUrl("plugins/uploader/uploader.swf"),v={};name="ke-bangpai-upload";p.addStyleSheet(".ke-upload-list {width:100%;}.ke-upload-list th {border-top:1px solid #c1c8d1;background-color:#EBEDF1;}.ke-upload-list td,.ke-upload-list th {padding:0.5em;text-align:center;border-bottom:1px solid #c1c8d1;}","ke-BangPaiUpload");
j.augment(x,j.EventTarget,{_init:function(){var f=this.editor,a=f.cfg.pluginConfig["bangpai-upload"],d=a.holder;d=j.isString(d)?j.one(d):d;var h=(new q("<div style='position:relative;margin:10px;'>\u6279\u91cf\u4e0a\u4f20\u56fe\u7247\uff1a</div>")).appendTo(d);d=(new q("<div style='display:none'>")).appendTo(d);var i=(new q("<button disabled='disabled'>\u6d4f\u89c8</button>")).appendTo(h),c=i.offset();h.offset();h=(new q("<div style='"+("position:absolute;width:"+(i.width()+8)+"px;height:"+(i.height()+8)+"px;z-index:9999;")+"'>")).appendTo(h);
var g=(new q("<div><table class='ke-upload-list'><thead><tr><th>\u56fe\u7247</td><th>\u5927\u5c0f</td><th>\u4e0a\u4f20\u8fdb\u5ea6</td><th>\u56fe\u7247\u64cd\u4f5c</td></tr></thead><tbody></tbody></table></div>")).appendTo(d).one("tbody"),n=(new q("<p style='margin:10px;text-align:right;'><button>\u786e\u5b9a\u4e0a\u4f20</button></p>")).appendTo(d).one("button"),w=j.guid(name);this.btn=i;this.up=n;h.offset(c);var t=new s.FlashBridge({movie:y,methods:["removeFile","cancel","removeFile","setAllowMultipleFiles","setFileFilters","uploadAll"],holder:h,attrs:{width:i.width(),height:i.height()},
params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,menu:true}});this.uploader=t;this._list=g;this._listWrap=d;this._ds=a.serverUrl;this._dsp=a.serverParams||{};this._fileInput=a.fileInput||"Filedata";g.on("click",function(e){var b=new q(e.target);e.halt();if(b.hasClass("ke-upload-insert")){e=b.parent("tr");url=e.attr("url");f.insertElement(new q("<img src='"+url+"'/>",null,f.document))}else if(b.hasClass("ke-upload-delete")){e=b.parent("tr");w=e.attr("fid");try{t.cancel(w)}catch(l){}t.removeFile(w);
v[w].destroy();delete v[w];e._4e_remove()}});t.on("fileSelect",this._onSelect,this);t.on("uploadStart",this._onUploadStart,this);t.on("uploadProgress",this._onProgress,this);t.on("uploadComplete",this._onComplete,this);t.on("uploadCompleteData",this._onUploadCompleteData,this);t.on("swfReady",this._ready,this);t.on("uploadError",this._uploadError,this)},_uploadError:function(f){var a=f.id,d=this._getFileTr(a);a=v[a];if(d){a.destroy();d.one(".ke-upload-progress").html("<span style='color:red'>"+f.status+
"</span>")}},_getFileTr:function(f){for(var a=this._list.all("tr"),d=0;d<a.length;d++){var h=new q(a[d]);if(h.attr("fid")==f)return h}},_onUploadStart:function(f){this.uploader.removeFile(f.id)},_onComplete:function(){},_onUploadCompleteData:function(f){var a=j.trim(f.data).replace(/\\r||\\n/g,"");f=f.id;if(a){a=JSON.parse(a);if(a.error)this._uploadError({id:f,status:a.error});else if(f=this._getFileTr(f)){f.one(".ke-upload-insert").show();f.attr("url",a.imgUrl)}}},_onProgress:function(f){var a=Math.floor(f.bytesLoaded*
100/f.bytesTotal);(f=v[f.id])&&f.set("progress",a)},_onSelect:function(f){var a=this._list;if(f=f.fileList){this._listWrap.show();for(var d in f)if(f.hasOwnProperty(d)){var h=f[d];if(!this._getFileTr(h.id)){var i=(new q("<tr fid='"+h.id+"'><td>"+h.name+"</td><td>"+Math.floor(h.size/1E3)+"k</td><td class='ke-upload-progress'></td><td><a href='#' class='ke-upload-insert' style='display:none'>[\u63d2\u5165]</a> &nbsp; <a href='#' class='ke-upload-delete'>[\u5220\u9664]</a> &nbsp; </td></tr>")).appendTo(a);v[h.id]=new s.ProgressBar({container:i.one(".ke-upload-progress"),
width:"100px",height:"18px"})}}}},_ready:function(){var f=this,a=f.uploader,d=f.up;f.btn[0].disabled=false;a.setAllowMultipleFiles(true);a.setFileFilters([{extensions:"*.jpeg;*.jpg;*.png;*.gif",description:"\u56fe\u7247\u6587\u4ef6( png,jpg,jpeg,gif )"}]);d.on("click",function(h){h.halt();a.uploadAll(f._ds,"POST",f._dsp,f._fileInput)})}});s.BangPaiUpload=x})();u.addPlugin(function(){new s.BangPaiUpload(u)})}},{attach:false,requires:["flashutils","progressbar","flashbridge"]});
KISSY.Editor.add("bangpai-video",function(u){function j(a){for(var d=0;d<f.length;d++){var h=f[d];if(h.reg.test(a))return h}}var s=KISSY,x=s.Editor,p="ke_video",q=x.Flash,y=u.htmlDataProcessor,v=y&&y.dataFilter;v&&v.addRules({elements:{object:function(a){var d=a.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<a.children.length;d++)if(a.children[d].name=="embed"){if(!q.isFlashEmbed(a.children[d]))break;if(j(a.children[d].attributes.src))return y.createFakeParserElement(a,p,"bangpai-video",
true)}return null}for(d=0;d<a.children.length;d++){var h=a.children[d];if(h.name=="param"&&h.attributes.name=="movie")if(j(h.attributes.value))return y.createFakeParserElement(a,p,"bangpai-video",true)}},embed:function(a){if(!q.isFlashEmbed(a))return null;if(j(a.attributes.src))return y.createFakeParserElement(a,p,"bangpai-video",true)}}},4);var f=[{reg:/youku\.com/i,width:480,height:400,detect:function(a){var d=a.match(/id_([^.]+)\.html$/);if(d)return"http://player.youku.com/player.php/sid/"+d[1]+
"/v.swf";a.match(/v_playlist\/([^.]+)\.html$/);return a}},{reg:/tudou\.com/i,width:480,height:400,detect:function(a){return a}},{reg:/ku6\.com/i,width:480,height:400,detect:function(a){var d=a.match(/show[^\/]*\/([^.]+)\.html$/);if(d)return"http://player.ku6.com/refer/"+d[1]+"/v.swf";return a}}];x.BangPaiVideo||function(){function a(){a.superclass.constructor.apply(this,arguments)}function d(c){return c._4e_name()==="img"&&!!c.hasClass(p)&&c}var h=["img."+p];s.extend(a,q,{_config:function(){var c=
this.editor.cfg.pluginConfig;this._cls=p;this._type="bangpai-video";this._title="\u89c6\u9891\u5c5e\u6027";this._bodyHtml="<table><tr><td colspan='2'>\u9700\u8981\u5206\u4eab\u7684\u89c6\u9891\u94fe\u63a5\uff1a\u652f\u6301 \u571f\u8c46\uff0c\u4f18\u9177\uff0cku6 \u89c6\u9891\u5206\u4eab</td></tr><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>\u89c6\u9891\u94fe\u63a5\uff1a </span><input class='ke-video-url' style='width:230px' value='http://'/></label></td></tr><tr><td><label>\u5bbd\u5ea6\uff1a </span> <input  data-verify='^\u81ea\u52a8|((?!0$)\\d+(.\\d+)?)$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-video-width' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td><td><label> \u9ad8\u5ea6\uff1a </span> <input  data-verify='^\u81ea\u52a8|((?!0$)\\d+(.\\d+)?)$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-video-height' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-video-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-video-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>";
this._footHtml="<button class='ke-video-ok'>\u786e\u5b9a</button> <button class='ke-video-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-video";this._tip="\u63d2\u5165\u89c6\u9891";this._contextMenu=i;this._flashRules=h;this.urlCfg=c["bangpai-video"]&&c["bangpai-video"].urlCfg},_initD:function(){var c=this,g=c.d;c.dUrl=g.el.one(".ke-video-url");c.dAlign=g.el.one(".ke-video-align");c.dMargin=g.el.one(".ke-video-margin");c.dWidth=g.el.one(".ke-video-width");c.dHeight=g.el.one(".ke-video-height");var n=g.el.one(".ke-video-ok");
g=g.el.one(".ke-video-cancel");n.on("click",c._gen,c);g.on("click",function(){c.d.hide()})},_getDInfo:function(){var c=this.dUrl.val(),g=j(c);if(g)if(c=g.detect(c))return{url:c,attrs:{height:parseInt(this.dHeight.val())||g.height,width:parseInt(this.dWidth.val())||g.width,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}};else alert("http://");else alert("\u4e0d\u652f\u6301\u8be5\u94fe\u63a5\u6765\u6e90!")},_gen:function(){var c=this.dUrl.val(),g=this.urlCfg;if(g)for(var n=0;n<g.length;n++){var w=g[n];if(w.reg.test(c)){this.d.loading();
a.dynamicUrl.origin=c;a.dynamicUrl.instance=this;s.getScript(w.url.replace(/@url@/,encodeURIComponent(c)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")));return}}a.superclass._gen.call(this)},_dynamicUrlPrepare:function(c){this.dUrl.val(c);this.d.unloading();a.superclass._gen.call(this)},_updateD:function(){var c=this.editor,g=this.selectedFlash;if(g){c=c.restoreRealElement(g);this.dUrl.val(this._getFlashUrl(c));this.dAlign.val(c.attr("align"));this.dMargin.val(parseInt(c._4e_style("margin"))||
0);this.dWidth.val(c.attr("width"));this.dHeight.val(c.attr("height"))}else{this.dUrl.val("http://");this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("\u81ea\u52a8");this.dHeight.val("\u81ea\u52a8")}}});a.dynamicUrl=function(c,g){c===a.dynamicUrl.origin&&a.dynamicUrl.instance._dynamicUrlPrepare(g)};q.registerBubble("bangpai-video","\u89c6\u9891\u94fe\u63a5\uff1a ",d);x.BangPaiVideo=a;var i={"\u89c6\u9891\u5c5e\u6027":function(c){var g=c.getSelection();g=(g=g&&g.getStartElement())&&d(g);c=c._toolbars["bangpai-video"];g&&c.show(null,g)}}}();u.addPlugin(function(){new x.BangPaiVideo(u)})},
{attach:false,requires:["flashsupport"]});
