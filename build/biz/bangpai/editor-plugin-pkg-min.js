KISSY.Editor.add("bangpai-music",function(u){var h=KISSY,t=h.UA,v=h.Event,n=h.Editor,w=h.DOM,s=h.Node,g=n.Config.base+"theme/loading.gif",j=n.Flash,c="ke_xiami",d=u.htmlDataProcessor,o=d&&d.dataFilter;o&&o.addRules({elements:{object:function(k){var b=k.attributes,f=k.attributes.title,p;if(!(b.classid&&String(b.classid).toLowerCase())){for(b=0;b<k.children.length;b++){p=k.children[b];if(p.name=="embed"){if(!j.isFlashEmbed(p))break;if(/xiami\.com/i.test(p.attributes.src))return d.createFakeParserElement(k,
c,"bangpai-music",true,{title:f})}}return null}for(b=0;b<k.children.length;b++){p=k.children[b];if(p.name=="param"&&p.attributes.name=="movie")if(/xiami\.com/i.test(p.attributes.value))return d.createFakeParserElement(k,c,"bangpai-music",true,{title:f})}},embed:function(k){if(!j.isFlashEmbed(k))return null;if(/xiami\.com/i.test(k.attributes.src))return d.createFakeParserElement(k,c,"bangpai-music",true,{title:k.attributes.title})}}},4);n.BangPaiMusic||function(){function k(e){k.superclass.constructor.apply(this,
arguments);e.cfg.disableObjectResizing||v.on(e.document.body,t.ie?"resizestart":"resize",function(a){w.hasClass(a.target,c)&&a.preventDefault()})}function b(e){return A.replace(/\${([^}]+)}/g,function(a,l){return e[l]})}function f(e,a,l){return"<a class='ke-xiami-page-item"+(e==a?" ke-xiami-curpage":"")+"' data-value='"+a+"' href='#'>"+(l||a)+"</a>"}function p(e){return e._4e_name()==="img"&&!!e.hasClass(c)&&e}w.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(e){var a=bangpai_xiami.instance;e.page=bangpai_xiami.page;a._listSearch(e)};var z="<form action='#' class='ke-xiami-form'><p class='ke-xiami-title'></p><p class='ke-xiami-url-wrap'><input class='ke-xiami-url' style='width:300px' value='输入想要添加的歌曲名、专辑名、艺人名'/> &nbsp;  <input class='ke-xiami-submit' type='submit' style='vertical-align:middle;' value='搜 索 ' /></p><p style='margin:5px 0'><label>对 齐： <select class='ke-xiami-align'><option value=''>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select>"+
n.Utils.duplicateStr("&nbsp;",1)+"<label>间距： </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='间距请输入非负数字' class='ke-xiami-margin' style='width:60px' value='5'/> 像素</label></p></form><div class='ke-xiami-list'></div>",A="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";h.extend(k,j,{_config:function(){this._cls=c;this._type="bangpai-music";this._title="虾米属性";this._bodyHtml=z;this._footHtml="<button class='ke-xiami-ok'>确定</button>";
this._contentCls="ke-toolbar-music";this._tip="插入虾米音乐";this._contextMenu=B;this._flashRules=["img."+c];this._config_dwidth="400px"},_updateTip:function(e,a){var l=this.editor.restoreRealElement(a);if(l){e.html(a.attr("title"));e.attr("href",this._getFlashUrl(l))}},_initD:function(){function e(q){var m=x.val();if(m.replace(/[^\x00-\xff]/g,"@@").length>30)alert("长度上限30个字符（1个汉字=2个字符）");else if(h.trim(m)){a._xiami_submit[0].disabled=true;m={key:encodeURIComponent(x.val()),page:q,random:(new Date).valueOf()};
m=b(m);bangpai_xiami.instance=a;bangpai_xiami.page=q;a._xiamia_list.html("<img style='display:block;width:108px;margin:5px auto 0 auto;'src='"+g+"'/>");var y=h.getScript(m,{timeout:10,success:function(){},error:function(){y.src="";a._xiami_submit[0].disabled=false;a._xiamia_list.html("<p style='text-align:center;margin:10px 0;'>不好意思，超时了，请重试！</p>")}})}else alert("不能为空！")}var a=this,l=a.editor,i=a.d,r=i.el.one(".ke-xiami-form"),x=i.el.one(".ke-xiami-url");a.dAlign=i.el.one(".ke-xiami-align");a._xiami_input=
x;a._xiamia_list=i.el.one(".ke-xiami-list");a._xiami_submit=i.el.one(".ke-xiami-submit");a.dMargin=i.el.one(".ke-xiami-margin");a._xiami_url_wrap=i.el.one(".ke-xiami-url-wrap");a._xiamia_title=i.el.one(".ke-xiami-title");i.foot.one(".ke-xiami-ok").on("click",function(){var q=a.selectedFlash,m=l.restoreRealElement(q);a._dinfo={url:a._getFlashUrl(m),attrs:{title:q.attr("title"),align:a.dAlign.val(),style:"margin:"+(parseInt(a.dMargin.val())||0)+"px;"}};a._gen()},a);r.on("submit",function(q){e(1);q.halt()},
a);a._xiamia_list.on("click",function(q){q.preventDefault();var m=new s(q.target);q=m._4e_ascendant(function(y){return a._xiamia_list._4e_contains(y)&&y.hasClass("ke-xiami-add")},true);m=m._4e_ascendant(function(y){return a._xiamia_list._4e_contains(y)&&y.hasClass("ke-xiami-page-item")},true);if(q){a._dinfo={url:"http://www.xiami.com/widget/"+q.attr("data-value")+"/singlePlayer.swf",attrs:{title:q.attr("title"),align:a.dAlign.val(),style:"margin:"+(parseInt(a.dMargin.val())||0)+"px;"}};a._gen()}else m&&
e(parseInt(m.attr("data-value")))})},_listSearch:function(e){var a,l=e.results,i="";if(e.key==h.trim(this._xiami_input.val())){this._xiami_submit[0].disabled=false;if(l&&l.length){i="<ul>";for(a=0;a<l.length;a++){var r=l[a],x=decodeURIComponent(r.song_name)+" - "+decodeURIComponent(r.artist_name);i=i;var q="<li title='"+x+"'><span class='ke-xiami-song'>",m=x;if(m.length>35)m=m.substring(0,35)+"...";i=i+(q+m+"</span><a href='#' title='"+x+"' class='ke-xiami-add' data-value='"+(r.album_id+"_"+r.song_id)+
"'>选择</a></li>")}i+="</ul>";l=e.page;e=Math.floor(e.total/8);a=l-3;r=l+3;if(e>1){if(a<=2){r=Math.min(2-a+r,e-1);a=2}r=Math.min(r,e-1);if(r==e-1)a=Math.max(2,r-6);i+="<p class='ke-xiami-paging'>"+f(l,1,"1"+(a!=2?"...":""));for(a=a;a<=r;a++)i+=f(l,a);if(r!=e)i+=f(l,e,(r!=e-1?"...":"")+e);i+="</p>"}}else i="<p style='text-align:center;margin:10px 0;'>不好意思，没有找到结果！</p>";this._xiamia_list.html(i)}},_updateD:function(){var e=this.selectedFlash;if(e){this._xiami_input.val(e.attr("title"));this._xiamia_title.html(e.attr("title"));
this.dAlign.val(e.attr("align"));this.dMargin.val(parseInt(e._4e_style("margin"))||0);this._xiami_url_wrap.hide();this.d.foot.show();this._xiamia_title.show()}else{this._xiami_input.val("输入想要添加的歌曲名、专辑名、艺人名");this.dAlign.val("");this.dMargin.val("5");this._xiami_url_wrap.show();this.d.foot.hide();this._xiamia_title.hide()}this._xiami_submit[0].disabled=false;this._xiamia_list.html("")},_getDInfo:function(){h.mix(this._dinfo.attrs,{width:257,height:33});return this._dinfo}});var B={"虾米属性":function(e){var a=
e.getSelection();a=a&&a.getStartElement();a=p(a);e=e._toolbars["bangpai-music"];a&&e.show(null,a)}};j.registerBubble("bangpai-music","虾米音乐： ",p);n.BangPaiMusic=k}();u.addPlugin(function(){new n.BangPaiMusic(u)})},{attach:false,requires:["flashsupport"]});
KISSY.Editor.add("bangpai-upload",function(u){var h=KISSY,t=h.Editor;if(!t.BangPaiUpload){(function(){function v(g){this.editor=g;this._init()}var n=[],w=t.Config.base+t.Utils.debugUrl("biz/bangpai/plugins/upload/uploader.swf"),s=h.Node;h.augment(v,h.EventTarget,{_init:function(){var g=this.editor.cfg.pluginConfig["bangpai-upload"].holder,j=h.isString(g)?h.one(g):g,c=(new s("<div style='position:relative'>")).appendTo(j);g=(new s("<button disabled='disabled'>选择文件</button>")).appendTo(c);var d=g.offset(),
o=c.offset();c=(new s("<div style='"+("position:absolute;top:"+(o.top-d.top)+"px;left:"+(o.left-d.left)+"px;width:"+g.width()+"px;height:"+g.height()+"px;z-index:9999;")+"'>")).appendTo(c);d=(new s("<table>")).appendTo(j);j=(new s("<p><button>开始上传</button></p>")).appendTo(j);o=h.guid("ke-bangpai-upload");d=(new s("<tbody>")).appendTo(d);n[o]=this;this.btn=g;this.up=j;this.on("contentReady",this._ready,this);this.flash=t.Utils.flash.createSWFRuntime(w,{holder:c,attrs:{allowScriptAccess:"always",allowNetworking:"all",
scale:"noScale",width:g.width(),height:g.height()},flashVars:{allowedDomain:location.hostname,shareData:true,swfID:o,jsEntry:"KISSY.Editor.BangPaiUpload.EventHandler",browser:"ke-bangpai-upload",useCompression:true,hand:true,btn:true}});this._list=d;this.on("select",this._onSelect,this)},_onSelect:function(g){var j=this._list;if(g=g.files)for(var c=0;c<g.length;c++){var d=g[c];(new s("<tr><td>"+d.name+"</td><td>"+d.name+"</td></tr>")).appendTo(j)}},_ready:function(){var g=this.flash;this.btn[0].disabled=
false;g.browse(false,[{desc:"图片文件( png,jpg,jpeg,gif )",ext:"*.jpeg;*.jpg;*.png;*.gif"}])},_eventHandler:function(g){var j=g.type;if(j==="log")h.log(g.message);else j&&this.fire(j,g)}});v.EventHandler=function(g,j){n[g]._eventHandler.call(n[g],j)};t.BangPaiUpload=v})();u.addPlugin(function(){new t.BangPaiUpload(u)})}},{attach:false,requires:["flashutils"]});
KISSY.Editor.add("bangpai-video",function(u){function h(c){for(var d=0;d<j.length;d++){var o=j[d];if(o.reg.test(c))return o}}var t=KISSY,v=t.Editor,n="ke_video",w=v.Flash,s=u.htmlDataProcessor,g=s&&s.dataFilter;g&&g.addRules({elements:{object:function(c){var d=c.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<c.children.length;d++)if(c.children[d].name=="embed"){if(!w.isFlashEmbed(c.children[d]))break;if(h(c.children[d].attributes.src))return s.createFakeParserElement(c,n,"bangpai-video",
true)}return null}for(d=0;d<c.children.length;d++){var o=c.children[d];if(o.name=="param"&&o.attributes.name=="movie")if(h(o.attributes.value))return s.createFakeParserElement(c,n,"bangpai-video",true)}},embed:function(c){if(!w.isFlashEmbed(c))return null;if(h(c.attributes.src))return s.createFakeParserElement(c,n,"bangpai-video",true)}}},4);var j=[{reg:/youku\.com/i,width:480,height:400,detect:function(c){var d=c.match(/id_([^.]+)\.html$/);if(d)return"http://player.youku.com/player.php/sid/"+d[1]+
"/v.swf";return c}},{reg:/tudou\.com/i,width:480,height:400,detect:function(c){var d=c.match(/\/view\/([^/]+)\/$/);if(d)return"http://www.tudou.com/v/"+d[1]+"/v.swf";return c}},{reg:/ku6\.com/i,width:480,height:400,detect:function(c){var d=c.match(/show[^\/]*\/([^.]+)\.html$/);if(d)return"http://player.ku6.com/refer/"+d[1]+"/v.swf";return c}}];v.BangPaiVideo||function(){function c(){c.superclass.constructor.apply(this,arguments)}function d(b){return b._4e_name()==="img"&&!!b.hasClass(n)&&b}var o=
["img."+n];t.extend(c,w,{_config:function(){var b=this.editor.cfg.pluginConfig;this._cls=n;this._type="bangpai-video";this._title="视频属性";this._bodyHtml="<table><tr><td colspan='2'>需要分享的视频链接：支持 土豆，优酷，ku6 视频分享</td></tr><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>视频链接： </span><input class='ke-video-url' style='width:230px' value='http://'/></label></td></tr><tr><td><label>宽度： </span> <input  data-verify='^自动|((?!0$)\\d+(.\\d+)?)$'  data-warning='宽度请输入正数' class='ke-video-width' style='width:60px' value='自动'/> 像素 </label></td><td><label> 高度： </span> <input  data-verify='^自动|((?!0$)\\d+(.\\d+)?)$'  data-warning='高度请输入正数' class='ke-video-height' style='width:60px' value='自动'/> 像素 </label></td></tr><tr><td><label>对齐： <select class='ke-video-align'><option value=''>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select></td><td><label>间距： </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='间距请输入非负数字' class='ke-video-margin' style='width:60px' value='5'/> 像素</label></td></tr></table>";
this._footHtml="<button class='ke-video-ok'>确定</button> <button class='ke-video-cancel'>取消</button>";this._contentCls="ke-toolbar-video";this._tip="插入视频";this._contextMenu=k;this._flashRules=o;this.urlCfg=b["bangpai-video"]&&b["bangpai-video"].urlCfg},_initD:function(){var b=this,f=b.d;b.dUrl=f.el.one(".ke-video-url");b.dAlign=f.el.one(".ke-video-align");b.dMargin=f.el.one(".ke-video-margin");b.dWidth=f.el.one(".ke-video-width");b.dHeight=f.el.one(".ke-video-height");var p=f.el.one(".ke-video-ok");
f=f.el.one(".ke-video-cancel");p.on("click",b._gen,b);f.on("click",function(){b.d.hide()})},_getDInfo:function(){var b=this.dUrl.val(),f=h(b);if(f)if(b=f.detect(b))return{url:b,attrs:{height:parseInt(this.dHeight.val())||f.height,width:parseInt(this.dWidth.val())||f.width,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}};else alert("http://");else alert("不支持该链接来源!")},_gen:function(){var b=this.dUrl.val(),f=this.urlCfg;if(f)for(var p=0;p<f.length;p++){var z=f[p];if(z.reg.test(b)){this.d.loading();
c.dynamicUrl.origin=b;c.dynamicUrl.instance=this;t.getScript(z.url.replace(/@url@/,encodeURIComponent(b)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")));return}}c.superclass._gen.call(this)},_dynamicUrlPrepare:function(b){this.dUrl.val(b);this.d.unloading();c.superclass._gen.call(this)},_updateD:function(){var b=this.editor,f=this.selectedFlash;if(f){b=b.restoreRealElement(f);this.dUrl.val(this._getFlashUrl(b));this.dAlign.val(b.attr("align"));this.dMargin.val(parseInt(b._4e_style("margin"))||
0);this.dWidth.val(b.attr("width"));this.dHeight.val(b.attr("height"))}else{this.dUrl.val("http://");this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("自动");this.dHeight.val("自动")}}});c.dynamicUrl=function(b,f){b===c.dynamicUrl.origin&&c.dynamicUrl.instance._dynamicUrlPrepare(f)};w.registerBubble("bangpai-video","视频链接： ",d);v.BangPaiVideo=c;var k={"视频属性":function(b){var f=b.getSelection();f=(f=f&&f.getStartElement())&&d(f);b=b._toolbars["bangpai-video"];f&&b.show(null,f)}}}();u.addPlugin(function(){new v.BangPaiVideo(u)})},
{attach:false,requires:["flashsupport"]});
