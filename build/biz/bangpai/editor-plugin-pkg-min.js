KISSY.Editor.add("bangpai-music",function(u){var k=KISSY,s=k.UA,w=k.Event,p=k.Editor,q=k.DOM,x=k.Node,v=p.Config.base+"theme/loading.gif",b=p.Flash,a="ke_xiami",f=u.htmlDataProcessor,h=f&&f.dataFilter;h&&h.addRules({elements:{object:function(i){var d=i.attributes,g=i.attributes.title,j;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<i.children.length;d++){j=i.children[d];if(j.name=="embed"){if(!b.isFlashEmbed(j))break;if(/xiami\.com/i.test(j.attributes.src))return f.createFakeParserElement(i,
a,"bangpai-music",true,{title:g})}}return null}for(d=0;d<i.children.length;d++){j=i.children[d];if(j.name=="param"&&j.attributes.name=="movie")if(/xiami\.com/i.test(j.attributes.value))return f.createFakeParserElement(i,a,"bangpai-music",true,{title:g})}},embed:function(i){if(!b.isFlashEmbed(i))return null;if(/xiami\.com/i.test(i.attributes.src))return f.createFakeParserElement(i,a,"bangpai-music",true,{title:i.attributes.title})}}},4);p.BangPaiMusic||function(){function i(e){i.superclass.constructor.apply(this,
arguments);e.cfg.disableObjectResizing||w.on(e.document.body,s.ie?"resizestart":"resize",function(c){q.hasClass(c.target,a)&&c.preventDefault()})}function d(e){return t.replace(/\${([^}]+)}/g,function(c,m){return e[m]})}function g(e,c,m){return"<a class='ke-xiami-page-item"+(e==c?" ke-xiami-curpage":"")+"' data-value='"+c+"' href='#'>"+(m||c)+"</a>"}function j(e){return e._4e_name()==="img"&&!!e.hasClass(a)&&e}q.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;width:300px;white-space:nowrap;overflow:hidden;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(e){var c=bangpai_xiami.instance;e.page=bangpai_xiami.page;c._listSearch(e)};var t="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";k.extend(i,b,{_config:function(){this._cls=a;this._type="bangpai-music";this._title="\u867e\u7c73\u5c5e\u6027";this._bodyHtml="<form action='#' class='ke-xiami-form'><p class='ke-xiami-title'></p><p class='ke-xiami-url-wrap'><input class='ke-xiami-url ke-input' style='width:300px;vertical-align:middle;'/> &nbsp;  <button class='ke-xiami-submit'>\u641c \u7d22 </button></p><p style='margin:10px 0'><label>\u5bf9 \u9f50\uff1a <select class='ke-xiami-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select><label style='margin-left:45px;'>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-xiami-margin ke-input' style='width:60px' value='5'/> \u50cf\u7d20</label></p></form><div class='ke-xiami-list'></div>";
this._footHtml="<button class='ke-xiami-ok ke-button'>\u786e&nbsp;\u5b9a</button><button class='ke-xiami-cancel ke-button' style='margin-left:20px;'>\u53d6&nbsp;\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u867e\u7c73\u97f3\u4e50";this._contextMenu=y;this._flashRules=["img."+a];this._config_dwidth="430px"},_updateTip:function(e,c){var m=this.editor.restoreRealElement(c);if(m){e.html(c.attr("title"));e.attr("href",this._getFlashUrl(m))}},_initD:function(){function e(r){var o=n.val();if(o.replace(/[^\x00-\xff]/g,"@@").length>
30)alert("\u957f\u5ea6\u4e0a\u965030\u4e2a\u5b57\u7b26\uff081\u4e2a\u6c49\u5b57=2\u4e2a\u5b57\u7b26\uff09");else if(k.trim(o)){c._xiami_submit.disable();o={key:encodeURIComponent(n.val()),page:r,random:(new Date).valueOf()};o=d(o);bangpai_xiami.instance=c;bangpai_xiami.page=r;c._xiamia_list.html("<img style='display:block;width:108px;margin:5px auto 0 auto;'src='"+v+"'/>");var z=k.getScript(o,{timeout:10,success:function(){},error:function(){z.src="";c._xiami_submit.enable();c._xiamia_list.html("<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u8d85\u65f6\u4e86\uff0c\u8bf7\u91cd\u8bd5\uff01</p>")}})}else alert("\u4e0d\u80fd\u4e3a\u7a7a\uff01")}
var c=this,m=c.editor,l=c.d;l.el.one(".ke-xiami-form");var n=l.el.one(".ke-xiami-url");c.dAlign=p.Select.decorate(l.el.one(".ke-xiami-align"));c._xiami_input=n;p.Utils.placeholder(n,"\u8f93\u5165\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d");c._xiamia_list=l.el.one(".ke-xiami-list");c._xiami_submit=new p.TripleButton({el:l.el.one(".ke-xiami-submit"),cls:"ke-button",text:"\u641c&nbsp;\u7d22"});c._xiami_submit.on("offClick",function(){e(1)});n.on("keydown",function(r){r.keyCode===13&&e(1)});c.dMargin=l.el.one(".ke-xiami-margin");c._xiami_url_wrap=l.el.one(".ke-xiami-url-wrap");
c._xiamia_title=l.el.one(".ke-xiami-title");var A=l.foot.one(".ke-xiami-ok");l.foot.one(".ke-xiami-cancel").on("click",function(){l.hide()});A.on("click",function(){var r=c.selectedFlash,o=m.restoreRealElement(r);c._dinfo={url:c._getFlashUrl(o),attrs:{title:r.attr("title"),align:c.dAlign.val(),style:"margin:"+(parseInt(c.dMargin.val())||0)+"px;"}};c._gen()},c);c._xiamia_list.on("click",function(r){r.preventDefault();var o=new x(r.target);r=o._4e_ascendant(function(z){return c._xiamia_list._4e_contains(z)&&
z.hasClass("ke-xiami-add")},true);o=o._4e_ascendant(function(z){return c._xiamia_list._4e_contains(z)&&z.hasClass("ke-xiami-page-item")},true);if(r){c._dinfo={url:"http://www.xiami.com/widget/"+r.attr("data-value")+"/singlePlayer.swf",attrs:{title:r.attr("title"),align:c.dAlign.val(),style:"margin:"+(parseInt(c.dMargin.val())||0)+"px;"}};c._gen()}else o&&e(parseInt(o.attr("data-value")))})},_listSearch:function(e){var c,m=e.results,l="";if(e.key==k.trim(this._xiami_input.val())){this._xiami_submit.enable();
if(m&&m.length){l="<ul>";for(c=0;c<m.length;c++){var n=m[c],A=decodeURIComponent(n.song_name)+" - "+decodeURIComponent(n.artist_name);l=l;var r="<li title='"+A+"'><span class='ke-xiami-song'>",o=A;if(o.length>35)o=o.substring(0,35)+"...";l=l+(r+o+"</span><a href='#' title='"+A+"' class='ke-xiami-add' data-value='"+(n.album_id+"_"+n.song_id)+"'>\u9009\u62e9</a></li>")}l+="</ul>";m=e.page;e=Math.floor(e.total/8);c=m-3;n=m+3;if(e>1){if(c<=2){n=Math.min(2-c+n,e-1);c=2}n=Math.min(n,e-1);if(n==e-1)c=Math.max(2,n-
6);l+="<p class='ke-xiami-paging'>"+g(m,1,"1"+(c!=2?"...":""));for(c=c;c<=n;c++)l+=g(m,c);if(n!=e)l+=g(m,e,(n!=e-1?"...":"")+e);l+="</p>"}}else l="<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u6ca1\u6709\u627e\u5230\u7ed3\u679c\uff01</p>";this._xiamia_list.html(l)}},_updateD:function(){var e=this.selectedFlash;if(e){this._xiami_input.val(e.attr("title"));this._xiamia_title.html(e.attr("title"));this.dAlign.val(e.attr("align"));this.dMargin.val(parseInt(e._4e_style("margin"))||0);this._xiami_url_wrap.hide();this.d.foot.show();
this._xiamia_title.show()}else{p.Utils.resetInput(this._xiami_input);this.dAlign.val("");this.dMargin.val("5");this._xiami_url_wrap.show();this.d.foot.hide();this._xiamia_title.hide()}this._xiamia_list.html("")},_getDInfo:function(){k.mix(this._dinfo.attrs,{width:257,height:33});return this._dinfo}});var y={"\u867e\u7c73\u5c5e\u6027":function(e){var c=e.getSelection();c=c&&c.getStartElement();c=j(c);e=e._toolbars["bangpai-music"];c&&e.show(null,c)}};b.registerBubble("bangpai-music","\u867e\u7c73\u97f3\u4e50\uff1a ",j);p.BangPaiMusic=i}();u.addPlugin(function(){new p.BangPaiMusic(u)})},
{attach:false,requires:["flashsupport"]});
KISSY.Editor.add("bangpai-upload",function(u){var k=KISSY,s=k.Editor;if(!s.BangPaiUpload){(function(){function w(b){this.editor=b;this._init()}var p=k.DOM,q=k.Node,x=s.Config.base+s.Utils.debugUrl("plugins/uploader/uploader.swf"),v={};name="ke-bangpai-upload";p.addStyleSheet(".ke-upload-list {width:100%;}.ke-upload-list th {border-top:1px solid #c1c8d1;background-color:#EBEDF1;}.ke-upload-list td,.ke-upload-list th {padding:0.5em;text-align:center;border-bottom:1px solid #c1c8d1;}","ke-BangPaiUpload");
k.augment(w,k.EventTarget,{_init:function(){var b=this,a=b.editor,f=a.cfg.pluginConfig["bangpai-upload"],h=f.holder;h=k.isString(h)?k.one(h):h;var i=(new q("<div style='position:relative;margin:10px;'>\u6279\u91cf\u4e0a\u4f20\u56fe\u7247\uff1a</div>")).appendTo(h);h=(new q("<div style='display:none'>")).appendTo(h);var d=(new q("<button disabled='disabled'>\u6d4f\u89c8</button>")).appendTo(i),g=d.offset();i.offset();i=(new q("<div style='"+("position:absolute;width:"+(d.width()+8)+"px;height:"+(d.height()+8)+"px;z-index:9999;")+"'>")).appendTo(i);
var j=(new q("<div><table class='ke-upload-list'><thead><tr><th>\u5e8f\u53f7</th><th>\u56fe\u7247</th><th>\u5927\u5c0f</th><th>\u4e0a\u4f20\u8fdb\u5ea6</th><th>\u56fe\u7247\u64cd\u4f5c</th></tr></thead><tbody></tbody></table></div>")).appendTo(h).one("tbody"),t=(new q("<p style='margin:10px;text-align:right;'><button>\u786e\u5b9a\u4e0a\u4f20</button></p>")).appendTo(h).one("button"),y=k.guid(name);b.btn=d;b.up=t;i.offset(g);var e=new s.FlashBridge({movie:x,methods:["removeFile","cancel","removeFile","disable","enable","setAllowMultipleFiles","setFileFilters","uploadAll"],holder:i,attrs:{width:d.width(),
height:d.height()},params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,menu:true}});b.uploader=e;b._list=j;b._listWrap=h;b._ds=f.serverUrl;b._dsp=f.serverParams||{};b._fileInput=f.fileInput||"Filedata";j.on("click",function(c){var m=new q(c.target);c.halt();if(m.hasClass("ke-upload-insert")){c=m.parent("tr");url=c.attr("url");a.insertElement(new q("<img src='"+url+"'/>",null,a.document))}else if(m.hasClass("ke-upload-delete")){c=m.parent("tr");y=c.attr("fid");try{e.cancel(y)}catch(l){}e.removeFile(y);
v[y].destroy();delete v[y];c._4e_remove();b.enable();b._seqPics()}});e.on("fileSelect",b._onSelect,b);e.on("uploadStart",b._onUploadStart,b);e.on("uploadProgress",b._onProgress,b);e.on("uploadComplete",b._onComplete,b);e.on("uploadCompleteData",b._onUploadCompleteData,b);e.on("swfReady",b._ready,b);e.on("uploadError",b._uploadError,b)},_uploadError:function(b){var a=b.id,f=this._getFileTr(a);a=v[a];if(f){a&&a.destroy();f.one(".ke-upload-progress").html("<span style='color:red'>"+b.status+"</span>")}},
_getFileTr:function(b){for(var a=this._list.all("tr"),f=0;f<a.length;f++){var h=new q(a[f]);if(h.attr("fid")==b)return h}},_onUploadStart:function(b){this.uploader.removeFile(b.id)},_onComplete:function(){},_onUploadCompleteData:function(b){var a=k.trim(b.data).replace(/\\r||\\n/g,"");b=b.id;if(a){a=JSON.parse(a);if(a.error)this._uploadError({id:b,status:a.error});else if(b=this._getFileTr(b)){b.one(".ke-upload-insert").show();b.attr("url",a.imgUrl)}}},_onProgress:function(b){var a=Math.floor(b.bytesLoaded*
100/b.bytesTotal);(b=v[b.id])&&b.set("progress",a)},disable:function(){this.uploader.disable();this.btn[0].disabled=true},enable:function(){this.uploader.enable();this.btn[0].disabled=false},_seqPics:function(){var b=1;this._list.all(".ke-upload-seq").each(function(a){a.html(b++)})},_getFilesSize:function(b){var a=0,f;for(f in b)a++;return a},_onSelect:function(b){var a=this.uploader,f=this._list,h=0;b=b.fileList;var i=15-f.all("tr").length;if(b){var d=this._getFilesSize(b);d>i&&alert("\u7cfb\u7edf\u5c06\u53ea\u4fdd\u755915\u5f20");
d>=i&&this.disable();this._listWrap.show();for(var g in b)if(b.hasOwnProperty(g)){var j=b[g];if(!this._getFileTr(j.id)){d=Math.floor(j.size/1E3);var t=j.id;h++;if(h>i)a.removeFile(t);else{j=(new q("<tr fid='"+t+"'><td class='ke-upload-seq'></td><td>"+j.name+"</td><td>"+d+"k</td><td class='ke-upload-progress'></td><td><a href='#' class='ke-upload-insert' style='display:none'>[\u63d2\u5165]</a> &nbsp; <a href='#' class='ke-upload-delete'>[\u5220\u9664]</a> &nbsp; </td></tr>")).appendTo(f);j.one(".ke-upload-progress");
if(d>1E3){this._uploadError({id:t,status:"\u56fe\u7247\u4e0d\u80fd\u8d85\u8fc71M"});a.removeFile(t)}else v[t]=new s.ProgressBar({container:j.one(".ke-upload-progress"),width:"100px",height:"18px"})}}}this._seqPics()}},_ready:function(){var b=this,a=b.uploader,f=b.up;b.btn[0].disabled=false;a.setAllowMultipleFiles(true);a.setFileFilters([{extensions:"*.jpeg;*.jpg;*.png;*.gif",description:"\u56fe\u7247\u6587\u4ef6( png,jpg,jpeg,gif )"}]);f.on("click",function(h){h.halt();a.uploadAll(b._ds,"POST",b._dsp,b._fileInput)})}});s.BangPaiUpload=w})();u.addPlugin(function(){new s.BangPaiUpload(u)})}},
{attach:false,requires:["flashutils","progressbar","flashbridge"]});
KISSY.Editor.add("bangpai-video",function(u){function k(a){for(var f=0;f<b.length;f++){var h=b[f];if(h.reg.test(a))return h}}var s=KISSY,w=s.Editor,p="ke_video",q=w.Flash,x=u.htmlDataProcessor,v=x&&x.dataFilter;v&&v.addRules({elements:{object:function(a){var f=a.attributes;if(!(f.classid&&String(f.classid).toLowerCase())){for(f=0;f<a.children.length;f++)if(a.children[f].name=="embed"){if(!q.isFlashEmbed(a.children[f]))break;if(k(a.children[f].attributes.src))return x.createFakeParserElement(a,p,"bangpai-video",
true)}return null}for(f=0;f<a.children.length;f++){var h=a.children[f];if(h.name=="param"&&h.attributes.name=="movie")if(k(h.attributes.value))return x.createFakeParserElement(a,p,"bangpai-video",true)}},embed:function(a){if(!q.isFlashEmbed(a))return null;if(k(a.attributes.src))return x.createFakeParserElement(a,p,"bangpai-video",true)}}},4);var b=[{reg:/youku\.com/i,width:480,height:400,detect:function(a){var f=a.match(/id_([^.]+)\.html$/);if(f)return"http://player.youku.com/player.php/sid/"+f[1]+
"/v.swf";a.match(/v_playlist\/([^.]+)\.html$/);return a}},{reg:/tudou\.com/i,width:480,height:400,detect:function(a){return a}},{reg:/ku6\.com/i,width:480,height:400,detect:function(a){var f=a.match(/show[^\/]*\/([^.]+)\.html$/);if(f)return"http://player.ku6.com/refer/"+f[1]+"/v.swf";return a}}];w.BangPaiVideo||function(){function a(){a.superclass.constructor.apply(this,arguments)}function f(d){return d._4e_name()==="img"&&!!d.hasClass(p)&&d}var h=["img."+p];s.extend(a,q,{_config:function(){var d=
this.editor.cfg.pluginConfig;this._cls=p;this._type="bangpai-video";this._title="\u89c6\u9891\u5c5e\u6027";this._bodyHtml="<table><tr><td colspan='2'>\u9700\u8981\u5206\u4eab\u7684\u89c6\u9891\u94fe\u63a5\uff1a\u652f\u6301 \u571f\u8c46\uff0c\u4f18\u9177\uff0cku6 \u89c6\u9891\u5206\u4eab</td></tr><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>\u89c6\u9891\u94fe\u63a5\uff1a </span><input class='ke-video-url' style='width:230px' value='http://'/></label></td></tr><tr><td><label>\u5bbd\u5ea6\uff1a </span> <input  data-verify='^\u81ea\u52a8|((?!0$)\\d+(.\\d+)?)$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-video-width' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td><td><label> \u9ad8\u5ea6\uff1a </span> <input  data-verify='^\u81ea\u52a8|((?!0$)\\d+(.\\d+)?)$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-video-height' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-video-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-video-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>";
this._footHtml="<button class='ke-video-ok'>\u786e\u5b9a</button> <button class='ke-video-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-video";this._tip="\u63d2\u5165\u89c6\u9891";this._contextMenu=i;this._flashRules=h;this.urlCfg=d["bangpai-video"]&&d["bangpai-video"].urlCfg},_initD:function(){var d=this,g=d.d;d.dUrl=g.el.one(".ke-video-url");d.dAlign=g.el.one(".ke-video-align");d.dMargin=g.el.one(".ke-video-margin");d.dWidth=g.el.one(".ke-video-width");d.dHeight=g.el.one(".ke-video-height");var j=g.el.one(".ke-video-ok");
g=g.el.one(".ke-video-cancel");j.on("click",d._gen,d);g.on("click",function(){d.d.hide()})},_getDInfo:function(){var d=this.dUrl.val(),g=k(d);if(g)if(d=g.detect(d))return{url:d,attrs:{height:parseInt(this.dHeight.val())||g.height,width:parseInt(this.dWidth.val())||g.width,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}};else alert("http://");else alert("\u4e0d\u652f\u6301\u8be5\u94fe\u63a5\u6765\u6e90!")},_gen:function(){var d=this.dUrl.val(),g=this.urlCfg;if(g)for(var j=0;j<g.length;j++){var t=g[j];if(t.reg.test(d)){this.d.loading();
a.dynamicUrl.origin=d;a.dynamicUrl.instance=this;s.getScript(t.url.replace(/@url@/,encodeURIComponent(d)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")));return}}a.superclass._gen.call(this)},_dynamicUrlPrepare:function(d){this.dUrl.val(d);this.d.unloading();a.superclass._gen.call(this)},_updateD:function(){var d=this.editor,g=this.selectedFlash;if(g){d=d.restoreRealElement(g);this.dUrl.val(this._getFlashUrl(d));this.dAlign.val(d.attr("align"));this.dMargin.val(parseInt(d._4e_style("margin"))||
0);this.dWidth.val(d.attr("width"));this.dHeight.val(d.attr("height"))}else{this.dUrl.val("http://");this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("\u81ea\u52a8");this.dHeight.val("\u81ea\u52a8")}}});a.dynamicUrl=function(d,g){d===a.dynamicUrl.origin&&a.dynamicUrl.instance._dynamicUrlPrepare(g)};q.registerBubble("bangpai-video","\u89c6\u9891\u94fe\u63a5\uff1a ",f);w.BangPaiVideo=a;var i={"\u89c6\u9891\u5c5e\u6027":function(d){var g=d.getSelection();g=(g=g&&g.getStartElement())&&f(g);d=d._toolbars["bangpai-video"];g&&d.show(null,g)}}}();u.addPlugin(function(){new w.BangPaiVideo(u)})},
{attach:false,requires:["flashsupport"]});
