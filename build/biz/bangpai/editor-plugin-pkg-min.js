KISSY.Editor.add("bangpai-music",function(t){function j(c){return/xiami\.com/i.test(c)}var i=KISSY,u=i.UA,p=i.Event,o=i.Editor,q=i.DOM,g=i.Node,l=o.Config.base+"theme/loading.gif",e=o.Flash,f="ke_xiami",k=t.htmlDataProcessor,y=k&&k.dataFilter;y&&y.addRules({elements:{object:function(c){var d=c.attributes,w=c.attributes.title,r;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<c.children.length;d++){r=c.children[d];if(r.name=="embed"){if(!e.isFlashEmbed(r))return null;if(j(r.attributes.src))return k.createFakeParserElement(c,
f,"bangpai-music",true,{title:w})}}return null}for(d=0;d<c.children.length;d++){r=c.children[d];if(r.name=="param"&&r.attributes.name=="movie")if(j(r.attributes.value))return k.createFakeParserElement(c,f,"bangpai-music",true,{title:w})}},embed:function(c){if(!e.isFlashEmbed(c))return null;if(j(c.attributes.src))return k.createFakeParserElement(c,f,"bangpai-music",true,{title:c.attributes.title})}}},4);o.BangPaiMusic||function(){function c(b,a){if(b.length>a)b=b.substring(0,a)+"...";return b}function d(b){d.superclass.constructor.apply(this,
arguments);b.cfg.disableObjectResizing||p.on(b.document.body,u.ie?"resizestart":"resize",function(a){q.hasClass(a.target,f)&&a.preventDefault()})}function w(b){return A.replace(/\${([^}]+)}/g,function(a,h){return b[h]})}function r(b,a,h){return"<a class='ke-xiami-page-item"+(b==a?" ke-xiami-curpage":"")+"' data-value='"+a+"' href='#'>"+(h||a)+"</a>"}function B(b){return decodeURIComponent(b.song_name)+" - "+decodeURIComponent(b.artist_name)}function z(b){return b._4e_name()==="img"&&!!b.hasClass(f)&&
b}q.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(b){var a=bangpai_xiami.instance;b.page=bangpai_xiami.page;a._listSearch(b)};var C="<form action='#' class='ke-xiami-form'><p><input class='ke-xiami-url' style='width:300px' value='\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d'/> &nbsp;  <input class='ke-xiami-submit' type='submit' style='vertical-align:middle;' value='\u641c \u7d22 ' /></p><p style='margin:5px 0'><label>\u5bf9 \u9f50\uff1a <select class='ke-xiami-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
o.Utils.duplicateStr("&nbsp;",1)+"<label>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\s*\\d+(.\\d+)?\\s*'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-xiami-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></p></form><div class='ke-xiami-list'></div>",A="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";i.extend(d,e,{_config:function(){this._cls=f;this._type="bangpai-music";this._title="\u641c\u7d22\u97f3\u4e50";
this._bodyHtml=C;this._footHtml="";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u867e\u7c73\u97f3\u4e50";this._contextMenu=D;this._flashRules=["img."+f];this._config_dwidth="400px"},_updateTip:function(b,a){var h=this.editor.restoreRealElement(a);b.html(a.attr("title"));b.attr("href",this._getFlashUrl(h))},_initD:function(){function b(n){a._xiami_submit[0].disabled=true;var v={key:encodeURIComponent(m.val()),page:n,random:(new Date).valueOf()};v=w(v);bangpai_xiami.instance=a;bangpai_xiami.page=
n;a._xiamia_list.html("<img style='display:block;width:108px;margin:5px auto 0 auto;'src='"+l+"'/>");i.getScript(v)}var a=this,h=a.d,s=h.el.one(".ke-xiami-form"),m=h.el.one(".ke-xiami-url");a.dAlign=h.el.one(".ke-xiami-align");a._xiami_input=m;a._xiamia_list=h.el.one(".ke-xiami-list");a._xiami_submit=h.el.one(".ke-xiami-submit");a.dMargin=h.el.one(".ke-xiami-margin");s.on("submit",function(n){b(1);n.halt()},a);a._xiamia_list.on("click",function(n){n.preventDefault();var v=new g(n.target);n=v._4e_ascendant(function(x){return a._xiamia_list._4e_contains(x)&&
x.hasClass("ke-xiami-add")},true);v=v._4e_ascendant(function(x){return a._xiamia_list._4e_contains(x)&&x.hasClass("ke-xiami-page-item")},true);if(n){a._dinfo={url:"http://www.xiami.com/widget/"+n.attr("data-value")+"/singlePlayer.swf",attrs:{title:n.attr("title"),align:a.dAlign.val(),style:"margin:"+(parseInt(a.dMargin.val())||0)+"px;"}};a._gen()}else v&&b(parseInt(v.attr("data-value")))})},_listSearch:function(b){var a,h=b.results,s="";if(b.key==i.trim(this._xiami_input.val())){this._xiami_submit[0].disabled=
false;if(h&&h.length){s="<ul>";for(a=0;a<h.length;a++){var m=h[a],n=B(m);s+="<li title='"+n+"'><span class='ke-xiami-song'>"+c(n,35)+"</span><a href='#' title='"+n+"' class='ke-xiami-add' data-value='"+(m.album_id+"_"+m.song_id)+"'>\u9009\u62e9</a></li>"}s+="</ul>";h=b.page;b=Math.floor(b.total/8);a=h-3;m=h+3;if(b>1){if(a<=2){m=Math.min(2-a+m,b-1);a=2}m=Math.min(m,b-1);if(m==b-1)a=Math.max(2,m-6);s+="<p class='ke-xiami-paging'>"+r(h,1,"1"+(a!=2?"...":""));for(a=a;a<=m;a++)s+=r(h,a);if(m!=b)s+=r(h,
b,(m!=b-1?"...":"")+b);s+="</p>"}}else s="<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u6ca1\u6709\u627e\u5230\u7ed3\u679c\uff01</p>";this._xiamia_list.html(s)}},_updateD:function(){var b=this.selectedFlash;if(b){this._xiami_input.val(b.attr("title"));this.dAlign.val(b.attr("align"));this.dMargin.val(parseInt(b._4e_style("margin"))||0)}else{this._xiami_input.val("\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d");
this.dAlign.val("");this.dMargin.val("5")}this._xiami_submit[0].disabled=false;this._xiamia_list.html("")},_getDInfo:function(){i.mix(this._dinfo.attrs,{width:257,height:33});return this._dinfo}});var D={"\u867e\u7c73\u5c5e\u6027":function(b){var a=b.getSelection();a=a&&a.getStartElement();a=z(a);b=b._toolbars["bangpai-music"];a&&b.show(null,a)}};e.registerBubble("bangpai-music","\u867e\u7c73\u97f3\u4e50\uff1a ",z);o.BangPaiMusic=d}();t.addPlugin(function(){new o.BangPaiMusic(t)})},{attach:false,
requires:["flashsupport"]});
KISSY.Editor.add("bangpai-upload",function(t){var j=KISSY,i=j.Editor;if(!i.BangPaiUpload){(function(){function u(g){this.editor=g;this._init()}var p=[],o=i.Config.base+i.Utils.debugUrl("biz/bangpai/plugins/upload/uploader.swf"),q=j.Node;j.augment(u,j.EventTarget,{_init:function(){var g=this.editor.cfg.pluginConfig["bangpai-upload"].holder,l=j.isString(g)?j.one(g):g;g=(new q("<p><button disabled='disabled'>\u9009\u62e9\u6587\u4ef6</button></p>")).appendTo(l).one("button");var e=(new q("<div>")).appendTo(l);
l=(new q("<p><button>\u5f00\u59cb\u4e0a\u4f20</button></p>")).appendTo(l);var f=j.guid("ke-bangpai-upload"),k=g.offset();p[f]=this;this.btn=g;this.up=l;this.on("contentReady",this._ready,this);this.flash=i.Utils.flash.createSWFRuntime(o,{style:"position:absolute;top:"+k.top+"px;left:"+k.left+"px;width:"+g.width()+"px;height:"+g.height()+"px;z-index:9999;",attrs:{allowScriptAccess:"always",allowNetworking:"all",scale:"noScale",width:g.width(),height:g.height()},flashVars:{allowedDomain:location.hostname,
shareData:true,swfID:f,jsEntry:"KISSY.Editor.BangPaiUpload.EventHandler",browser:"ke-bangpai-upload",useCompression:true,hand:true,btn:true}});this._list=e;this.on("select",this._onSelect,this)},_onSelect:function(){},_ready:function(){var g=this.flash;this.btn[0].disabled=false;g.browse(false,[{desc:"\u56fe\u7247\u6587\u4ef6( png,jpg,jpeg,gif )",ext:"*.jpeg;*.jpg;*.png;*.gif"}])},_eventHandler:function(g){var l=g.type;if(l==="log")j.log(g.message);else l&&this.fire(l,g)}});u.EventHandler=function(g,
l){p[g]._eventHandler.call(p[g],l)};i.BangPaiUpload=u})();t.addPlugin(function(){new i.BangPaiUpload(t)})}},{attach:false,requires:["flashutils"]});
KISSY.Editor.add("bangpai-video",function(t){function j(e){for(var f=0;f<l.length;f++){var k=l[f];if(k.reg.test(e))return k}}var i=KISSY,u=i.Editor,p="ke_video",o=u.Flash,q=t.htmlDataProcessor,g=q&&q.dataFilter;g&&g.addRules({elements:{object:function(e){var f=e.attributes;if(!(f.classid&&String(f.classid).toLowerCase())){for(f=0;f<e.children.length;f++)if(e.children[f].name=="embed"){if(!o.isFlashEmbed(e.children[f]))return null;if(j(e.children[f].attributes.src))return q.createFakeParserElement(e,
p,"bangpai-video",true)}return null}for(f=0;f<e.children.length;f++){var k=e.children[f];if(k.name=="param"&&k.attributes.name=="movie")if(j(k.attributes.value))return q.createFakeParserElement(e,p,"bangpai-video",true)}},embed:function(e){if(!o.isFlashEmbed(e))return null;if(j(e.attributes.src))return q.createFakeParserElement(e,p,"bangpai-video",true)}}},4);var l=[{reg:/youku\.com/i,width:480,height:400,detect:function(e){if(/\.swf$/.test(e))return e}},{reg:/tudou\.com/i,width:480,height:400,detect:function(e){if(/\.swf$/.test(e))return e}},
{reg:/ku6\.com/i,width:480,height:400,detect:function(e){if(/\.swf$/.test(e))return e}}];u.BangPaiVideo||function(){function e(){e.superclass.constructor.apply(this,arguments)}function f(c){return c._4e_name()==="img"&&!!c.hasClass(p)&&c}var k=["img."+p];i.extend(e,o,{_config:function(){this._cls=p;this._type="bangpai-video";this._title="\u89c6\u9891\u5c5e\u6027";this._bodyHtml="<table><tr><td colspan='2'>\u9700\u8981\u5206\u4eab\u7684\u89c6\u9891\u94fe\u63a5\uff1a\u652f\u6301 \u571f\u8c46\uff0c\u4f18\u9177\uff0cku6 \u89c6\u9891\u5206\u4eab</td></tr><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>\u89c6\u9891\u94fe\u63a5\uff1a </span><input class='ke-video-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></td></tr><tr><td><label>\u5bbd\u5ea6\uff1a </span> <input  data-verify='^\\s*\u81ea\u52a8|((?!0)\\d+(.\\d+)?)\\s*'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-video-width' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td><td><label> \u9ad8\u5ea6\uff1a </span> <input  data-verify='^\\s*\u81ea\u52a8|((?!0)\\d+(.\\d+)?)\\s*'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-video-height' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-video-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\s*\\d+(.\\d+)?\\s*'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-video-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>";
this._footHtml="<button class='ke-video-ok'>\u786e\u5b9a</button> <button class='ke-video-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165\u89c6\u9891";this._contextMenu=y;this._flashRules=k},_initD:function(){var c=this,d=c.d;c.dUrl=d.el.one(".ke-video-url");c.dAlign=d.el.one(".ke-video-align");c.dMargin=d.el.one(".ke-video-margin");c.dWidth=d.el.one(".ke-video-width");c.dHeight=d.el.one(".ke-video-height");var w=d.el.one(".ke-video-ok");d=d.el.one(".ke-video-cancel");
w.on("click",c._gen,c);d.on("click",function(){c.d.hide()})},_getDInfo:function(){var c=this.dUrl.val(),d=j(c);if(d){(c=d.detect(c))||alert("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");return{url:c,attrs:{height:parseInt(this.dHeight.val())||d.height,width:parseInt(this.dWidth.val())||d.width,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}}else alert("\u4e0d\u652f\u6301\u8be5\u94fe\u63a5\u6765\u6e90!")},_updateD:function(){var c=this.editor,d=this.selectedFlash;
if(d){c=c.restoreRealElement(d);this.dUrl.val(this._getFlashUrl(c));this.dAlign.val(c.attr("align"));this.dMargin.val(parseInt(c._4e_style("margin"))||0);this.dWidth.val(c.attr("width"));this.dHeight.val(c.attr("height"))}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("\u81ea\u52a8");this.dHeight.val("\u81ea\u52a8")}}});o.registerBubble("bangpai-video","\u89c6\u9891\u94fe\u63a5\uff1a ",f);u.BangPaiVideo=e;var y={"\u89c6\u9891\u5c5e\u6027":function(c){var d=
c.getSelection();d=(d=d&&d.getStartElement())&&f(d);c=c._toolbars["bangpai-video"];d&&c.show(null,d)}}}();t.addPlugin(function(){new u.BangPaiVideo(t)})},{attach:false,requires:["flashsupport"]});
