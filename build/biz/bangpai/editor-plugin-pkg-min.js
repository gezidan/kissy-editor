KISSY.Editor.add("bangpai-music",function(s){function q(f){return/xiami\.com/i.test(f)}var n=KISSY,l=n.Editor,r=n.DOM,v=n.Node,t=l.Config.base+"theme/loading.gif",u=l.Flash,o="ke_xiami",e=s.htmlDataProcessor,h=e&&e.dataFilter;h&&h.addRules({elements:{object:function(f){var i=f.attributes,d=f.attributes.title,c;if(!(i.classid&&String(i.classid).toLowerCase())){for(i=0;i<f.children.length;i++){c=f.children[i];if(c.name=="embed"){if(!u.isFlashEmbed(c))return null;if(q(c.attributes.src))return e.createFakeParserElement(f,
o,"bangpai-music",true,{title:d})}}return null}for(i=0;i<f.children.length;i++){c=f.children[i];if(c.name=="param"&&c.attributes.name=="movie")if(q(c.attributes.value))return e.createFakeParserElement(f,o,"bangpai-music",true,{title:d})}},embed:function(f){if(!u.isFlashEmbed(f))return null;if(q(f.attributes.src))return e.createFakeParserElement(f,o,"bangpai-music",true,{title:f.attributes.title})}}},4);l.BangPaiMusic||function(){function f(b,a){if(b.length>a)b=b.substring(0,a)+"...";return b}function i(){i.superclass.constructor.apply(this,
arguments)}function d(b){return z.replace(/\${([^}]+)}/g,function(a,g){return b[g]})}function c(b,a,g){return"<a class='ke-xiami-page-item"+(b==a?" ke-xiami-curpage":"")+"' data-value='"+a+"' href='#'>"+(g||a)+"</a>"}function x(b){return decodeURIComponent(b.song_name)+" - "+decodeURIComponent(b.artist_name)}function y(b){return b._4e_name()==="img"&&!!b.hasClass(o)&&b}r.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(b){var a=bangpai_xiami.instance;b.page=bangpai_xiami.page;a._listSearch(b)};var A="<form action='#' class='ke-xiami-form'><p><input class='ke-xiami-url' style='width:300px' value='\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d'/> &nbsp;  <input class='ke-xiami-submit' type='submit' style='vertical-align:middle;' value='\u641c \u7d22 ' /></p><p style='margin:5px 0'><label>\u5bf9 \u9f50\uff1a <select class='ke-xiami-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
l.Utils.duplicateStr("&nbsp;",1)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-xiami-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></p></form><div class='ke-xiami-list'></div>",z="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";n.extend(i,u,{_config:function(){this._cls=o;this._type="bangpai-music";this._title="\u641c\u7d22\u97f3\u4e50";this._bodyHtml=A;this._footHtml="";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u867e\u7c73\u97f3\u4e50";
this._contextMenu=B;this._flashRules=["img."+o];this._config_dwidth="400px"},_updateTip:function(b,a){var g=this.editor.restoreRealElement(a);b.html(a.attr("title"));b.attr("href",this._getFlashUrl(g))},_initD:function(){function b(k){a._xiami_submit[0].disabled=true;var p={key:encodeURIComponent(j.val()),page:k,random:(new Date).valueOf()};p=d(p);bangpai_xiami.instance=a;bangpai_xiami.page=k;a._xiamia_list.html("<img style='display:block;width:108px;margin:5px auto 0 auto;'src='"+t+"'/>");n.getScript(p)}
var a=this,g=a.d,m=g.el.one(".ke-xiami-form"),j=g.el.one(".ke-xiami-url");a.dAlign=g.el.one(".ke-xiami-align");a._xiami_input=j;a._xiamia_list=g.el.one(".ke-xiami-list");a._xiami_submit=g.el.one(".ke-xiami-submit");a.dMargin=g.el.one(".ke-xiami-margin");m.on("submit",function(k){b(1);k.halt()},a);a._xiamia_list.on("click",function(k){k.preventDefault();var p=new v(k.target);k=p._4e_ascendant(function(w){return a._xiamia_list._4e_contains(w)&&w.hasClass("ke-xiami-add")},true);p=p._4e_ascendant(function(w){return a._xiamia_list._4e_contains(w)&&
w.hasClass("ke-xiami-page-item")},true);if(k){a._dinfo={url:"http://www.xiami.com/widget/"+k.attr("data-value")+"/singlePlayer.swf",attrs:{title:k.attr("title"),align:a.dAlign.val(),style:"margin:"+(parseInt(a.dMargin.val())||0)+"px;"}};a._gen()}else p&&b(parseInt(p.attr("data-value")))})},_listSearch:function(b){var a,g=b.results,m="";if(b.key==n.trim(this._xiami_input.val())){this._xiami_submit[0].disabled=false;if(g&&g.length){m="<ul>";for(a=0;a<g.length;a++){var j=g[a],k=x(j);m+="<li title='"+
k+"'><span class='ke-xiami-song'>"+f(k,35)+"</span><a href='#' title='"+k+"' class='ke-xiami-add' data-value='"+(j.album_id+"_"+j.song_id)+"'>\u9009\u62e9</a></li>"}m+="</ul>";g=b.page;b=Math.floor(b.total/8);a=g-3;j=g+3;if(b>1){if(a<=2){j=Math.min(2-a+j,b-1);a=2}j=Math.min(j,b-1);if(j==b-1)a=Math.max(2,j-6);m+="<p class='ke-xiami-paging'>"+c(g,1,"1"+(a!=2?"...":""));for(a=a;a<=j;a++)m+=c(g,a);if(j!=b)m+=c(g,b,(j!=b-1?"...":"")+b);m+="</p>"}}else m="<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u6ca1\u6709\u627e\u5230\u7ed3\u679c\uff01</p>";
this._xiamia_list.html(m)}},_updateD:function(){var b=this.selectedFlash;if(b){this._xiami_input.val(b.attr("title"));this.dAlign.val(b.attr("align"));this.dMargin.val(parseInt(b._4e_style("margin"))||0)}else{this._xiami_input.val("\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d");this.dAlign.val("");this.dMargin.val("5")}this._xiami_submit[0].disabled=false;this._xiamia_list.html("")},_getDInfo:function(){n.mix(this._dinfo.attrs,{width:257,
height:33});return this._dinfo}});var B={"\u867e\u7c73\u5c5e\u6027":function(b){var a=b.getSelection();a=a&&a.getStartElement();a=y(a);b=b._toolbars["bangpai-music"];a&&b.show(null,a)}};u.registerBubble("bangpai-music","\u867e\u7c73\u97f3\u4e50\uff1a ",y);l.BangPaiMusic=i}();s.addPlugin(function(){new l.BangPaiMusic(s)})},{attach:false,requires:["flashsupport"]});
KISSY.Editor.add("bangpai-video",function(s){function q(e){for(var h=0;h<o.length;h++){var f=o[h];if(f.reg.test(e))return f}}var n=KISSY,l=n.Editor,r="ke_video",v=l.Flash,t=s.htmlDataProcessor,u=t&&t.dataFilter;u&&u.addRules({elements:{object:function(e){var h=e.attributes;if(!(h.classid&&String(h.classid).toLowerCase())){for(h=0;h<e.children.length;h++)if(e.children[h].name=="embed"){if(!v.isFlashEmbed(e.children[h]))return null;if(q(e.children[h].attributes.src))return t.createFakeParserElement(e,
r,"bangpai-video",true)}return null}for(h=0;h<e.children.length;h++){var f=e.children[h];if(f.name=="param"&&f.attributes.name=="movie")if(q(f.attributes.value))return t.createFakeParserElement(e,r,"bangpai-video",true)}},embed:function(e){if(!v.isFlashEmbed(e))return null;if(q(e.attributes.src))return t.createFakeParserElement(e,r,"bangpai-video",true)}}},4);var o=[{reg:/youku\.com/i,width:480,height:400,detect:function(e){if(/\.swf$/.test(e))return e}},{reg:/tudou\.com/i,width:480,height:400,detect:function(e){if(/\.swf$/.test(e))return e}},
{reg:/ku6\.com/i,width:480,height:400,detect:function(e){if(/\.swf$/.test(e))return e}}];l.BangPaiVideo||function(){function e(){e.superclass.constructor.apply(this,arguments)}function h(d){return d._4e_name()==="img"&&!!d.hasClass(r)&&d}var f=["img."+r];n.extend(e,v,{_config:function(){this._cls=r;this._type="bangpai-video";this._title="\u89c6\u9891\u5c5e\u6027";this._bodyHtml="<table><tr><td colspan='2'>\u9700\u8981\u5206\u4eab\u7684\u89c6\u9891\u94fe\u63a5\uff1a\u652f\u6301 \u571f\u8c46\uff0c\u4f18\u9177\uff0cku6 \u89c6\u9891\u5206\u4eab</td></tr><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>\u89c6\u9891\u94fe\u63a5\uff1a </span><input class='ke-video-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></td></tr><tr><td><label>\u5bbd\u5ea6\uff1a </span> <input class='ke-video-width' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td><td><label> \u9ad8\u5ea6\uff1a </span> <input class='ke-video-height' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-video-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label>\u95f4\u8ddd\uff1a </span> <input class='ke-video-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>";
this._footHtml="<button class='ke-video-ok'>\u786e\u5b9a</button> <button class='ke-video-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165\u89c6\u9891";this._contextMenu=i;this._flashRules=f},_initD:function(){var d=this,c=d.d;d.dUrl=c.el.one(".ke-video-url");d.dAlign=c.el.one(".ke-video-align");d.dMargin=c.el.one(".ke-video-margin");d.dWidth=c.el.one(".ke-video-width");d.dHeight=c.el.one(".ke-video-height");var x=c.el.one(".ke-video-ok");c=c.el.one(".ke-video-cancel");
x.on("click",d._gen,d);c.on("click",function(){d.d.hide()})},_getDInfo:function(){var d=this.dUrl.val(),c=q(d);if(c){(d=c.detect(d))||alert("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");return{url:d,attrs:{height:parseInt(this.dHeight.val())||c.height,width:parseInt(this.dWidth.val())||c.width,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}}else alert("\u4e0d\u652f\u6301\u8be5\u94fe\u63a5\u6765\u6e90!")},_updateD:function(){var d=this.editor,c=this.selectedFlash;
if(c){d=d.restoreRealElement(c);this.dUrl.val(this._getFlashUrl(d));this.dAlign.val(d.attr("align"));this.dMargin.val(parseInt(d._4e_style("margin"))||0);this.dWidth.val(d.attr("width"));this.dHeight.val(d.attr("height"))}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("\u81ea\u52a8");this.dHeight.val("\u81ea\u52a8")}}});v.registerBubble("bangpai-video","\u89c6\u9891\u94fe\u63a5\uff1a ",h);l.BangPaiVideo=e;var i={"\u89c6\u9891\u5c5e\u6027":function(d){var c=
d.getSelection();c=(c=c&&c.getStartElement())&&h(c);d=d._toolbars["bangpai-video"];c&&d.show(null,c)}}}();s.addPlugin(function(){new l.BangPaiVideo(s)})},{attach:false,requires:["flashsupport"]});
