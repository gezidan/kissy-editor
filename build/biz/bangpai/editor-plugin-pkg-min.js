KISSY.Editor.add("bangpai-music",function(v){var i=KISSY,r=i.UA,w=i.Event,q=i.Editor,n=i.DOM,u=i.Node,A=q.Config.base+"theme/loading.gif",s=q.Flash,a="ke_xiami",d=v.htmlDataProcessor,h=d&&d.dataFilter;h&&h.addRules({elements:{object:function(g){var b=g.attributes,f=g.attributes.title,k;if(!(b.classid&&String(b.classid).toLowerCase())){for(b=0;b<g.children.length;b++){k=g.children[b];if(k.name=="embed"){if(!s.isFlashEmbed(k))break;if(/xiami\.com/i.test(k.attributes.src))return d.createFakeParserElement(g,
a,"bangpai-music",true,{title:f})}}return null}for(b=0;b<g.children.length;b++){k=g.children[b];if(k.name=="param"&&k.attributes.name=="movie")if(/xiami\.com/i.test(k.attributes.value))return d.createFakeParserElement(g,a,"bangpai-music",true,{title:f})}},embed:function(g){if(!s.isFlashEmbed(g))return null;if(/xiami\.com/i.test(g.attributes.src))return d.createFakeParserElement(g,a,"bangpai-music",true,{title:g.attributes.title})}}},4);q.BangPaiMusic||function(){function g(e){g.superclass.constructor.apply(this,
arguments);e.cfg.disableObjectResizing||w.on(e.document.body,r.ie?"resizestart":"resize",function(c){n.hasClass(c.target,a)&&c.preventDefault()})}function b(e){return B.replace(/\${([^}]+)}/g,function(c,l){return e[l]})}function f(e,c,l){return"<a class='ke-xiami-page-item"+(e==c?" ke-xiami-curpage":"")+"' data-value='"+c+"' href='#'>"+(l||c)+"</a>"}function k(e){return e._4e_name()==="img"&&!!e.hasClass(a)&&e}n.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(e){var c=bangpai_xiami.instance;e.page=bangpai_xiami.page;c._listSearch(e)};var t="<form action='#' class='ke-xiami-form'><p class='ke-xiami-title'></p><p class='ke-xiami-url-wrap'><input class='ke-xiami-url' style='width:300px' value='输入想要添加的歌曲名、专辑名、艺人名'/> &nbsp;  <input class='ke-xiami-submit' type='submit' style='vertical-align:middle;' value='搜 索 ' /></p><p style='margin:5px 0'><label>对 齐： <select class='ke-xiami-align'><option value=''>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select>"+
q.Utils.duplicateStr("&nbsp;",1)+"<label>间距： </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='间距请输入非负数字' class='ke-xiami-margin' style='width:60px' value='5'/> 像素</label></p></form><div class='ke-xiami-list'></div>",B="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";i.extend(g,s,{_config:function(){this._cls=a;this._type="bangpai-music";this._title="虾米属性";this._bodyHtml=t;this._footHtml="<button class='ke-xiami-ok'>确定</button>";
this._contentCls="ke-toolbar-music";this._tip="插入虾米音乐";this._contextMenu=x;this._flashRules=["img."+a];this._config_dwidth="400px"},_updateTip:function(e,c){var l=this.editor.restoreRealElement(c);if(l){e.html(c.attr("title"));e.attr("href",this._getFlashUrl(l))}},_initD:function(){function e(o){var m=y.val();if(m.replace(/[^\x00-\xff]/g,"@@").length>30)alert("长度上限30个字符（1个汉字=2个字符）");else if(i.trim(m)){c._xiami_submit[0].disabled=true;m={key:encodeURIComponent(y.val()),page:o,random:(new Date).valueOf()};
m=b(m);bangpai_xiami.instance=c;bangpai_xiami.page=o;c._xiamia_list.html("<img style='display:block;width:108px;margin:5px auto 0 auto;'src='"+A+"'/>");var z=i.getScript(m,{timeout:10,success:function(){},error:function(){z.src="";c._xiami_submit[0].disabled=false;c._xiamia_list.html("<p style='text-align:center;margin:10px 0;'>不好意思，超时了，请重试！</p>")}})}else alert("不能为空！")}var c=this,l=c.editor,j=c.d,p=j.el.one(".ke-xiami-form"),y=j.el.one(".ke-xiami-url");c.dAlign=j.el.one(".ke-xiami-align");c._xiami_input=
y;c._xiamia_list=j.el.one(".ke-xiami-list");c._xiami_submit=j.el.one(".ke-xiami-submit");c.dMargin=j.el.one(".ke-xiami-margin");c._xiami_url_wrap=j.el.one(".ke-xiami-url-wrap");c._xiamia_title=j.el.one(".ke-xiami-title");j.foot.one(".ke-xiami-ok").on("click",function(){var o=c.selectedFlash,m=l.restoreRealElement(o);c._dinfo={url:c._getFlashUrl(m),attrs:{title:o.attr("title"),align:c.dAlign.val(),style:"margin:"+(parseInt(c.dMargin.val())||0)+"px;"}};c._gen()},c);p.on("submit",function(o){e(1);o.halt()},
c);c._xiamia_list.on("click",function(o){o.preventDefault();var m=new u(o.target);o=m._4e_ascendant(function(z){return c._xiamia_list._4e_contains(z)&&z.hasClass("ke-xiami-add")},true);m=m._4e_ascendant(function(z){return c._xiamia_list._4e_contains(z)&&z.hasClass("ke-xiami-page-item")},true);if(o){c._dinfo={url:"http://www.xiami.com/widget/"+o.attr("data-value")+"/singlePlayer.swf",attrs:{title:o.attr("title"),align:c.dAlign.val(),style:"margin:"+(parseInt(c.dMargin.val())||0)+"px;"}};c._gen()}else m&&
e(parseInt(m.attr("data-value")))})},_listSearch:function(e){var c,l=e.results,j="";if(e.key==i.trim(this._xiami_input.val())){this._xiami_submit[0].disabled=false;if(l&&l.length){j="<ul>";for(c=0;c<l.length;c++){var p=l[c],y=decodeURIComponent(p.song_name)+" - "+decodeURIComponent(p.artist_name);j=j;var o="<li title='"+y+"'><span class='ke-xiami-song'>",m=y;if(m.length>35)m=m.substring(0,35)+"...";j=j+(o+m+"</span><a href='#' title='"+y+"' class='ke-xiami-add' data-value='"+(p.album_id+"_"+p.song_id)+
"'>选择</a></li>")}j+="</ul>";l=e.page;e=Math.floor(e.total/8);c=l-3;p=l+3;if(e>1){if(c<=2){p=Math.min(2-c+p,e-1);c=2}p=Math.min(p,e-1);if(p==e-1)c=Math.max(2,p-6);j+="<p class='ke-xiami-paging'>"+f(l,1,"1"+(c!=2?"...":""));for(c=c;c<=p;c++)j+=f(l,c);if(p!=e)j+=f(l,e,(p!=e-1?"...":"")+e);j+="</p>"}}else j="<p style='text-align:center;margin:10px 0;'>不好意思，没有找到结果！</p>";this._xiamia_list.html(j)}},_updateD:function(){var e=this.selectedFlash;if(e){this._xiami_input.val(e.attr("title"));this._xiamia_title.html(e.attr("title"));
this.dAlign.val(e.attr("align"));this.dMargin.val(parseInt(e._4e_style("margin"))||0);this._xiami_url_wrap.hide();this.d.foot.show();this._xiamia_title.show()}else{this._xiami_input.val("输入想要添加的歌曲名、专辑名、艺人名");this.dAlign.val("");this.dMargin.val("5");this._xiami_url_wrap.show();this.d.foot.hide();this._xiamia_title.hide()}this._xiami_submit[0].disabled=false;this._xiamia_list.html("")},_getDInfo:function(){i.mix(this._dinfo.attrs,{width:257,height:33});return this._dinfo}});var x={"虾米属性":function(e){var c=
e.getSelection();c=c&&c.getStartElement();c=k(c);e=e._toolbars["bangpai-music"];c&&e.show(null,c)}};s.registerBubble("bangpai-music","虾米音乐： ",k);q.BangPaiMusic=g}();v.addPlugin(function(){new q.BangPaiMusic(v)})},{attach:false,requires:["flashsupport"]});
KISSY.Editor.add("bangpai-upload",function(v){var i=KISSY,r=i.Editor;if(!r.BangPaiUpload){(function(){function w(a){this.editor=a;this._init()}var q=i.DOM,n=i.Node,u=[],A=r.Config.base+r.Utils.debugUrl("plugins/uploader/uploader.swf");n=i.Node;var s={};name="ke-bangpai-upload";q.addStyleSheet(".ke-upload-list {width:100%;}.ke-upload-list th {border-top:1px solid #c1c8d1;background-color:#EBEDF1;}.ke-upload-list td,.ke-upload-list th {padding:0.5em;text-align:center;border-bottom:1px solid #c1c8d1;}",
"ke-BangPaiUpload");i.augment(w,i.EventTarget,{_init:function(){var a=this.editor,d=a.cfg.pluginConfig["bangpai-upload"],h=d.holder,g=i.isString(h)?i.one(h):h,b=(new n("<div style='position:relative;margin:10px;'>批量上传图片：</div>")).appendTo(g);h=(new n("<button disabled='disabled'>浏览</button>")).appendTo(b);var f=h.offset();b.offset();b=(new n("<div style='"+("position:absolute;width:"+(h.width()+8)+"px;height:"+(h.height()+8)+"px;z-index:9999;")+"'>")).appendTo(b);var k=(new n("<div><table class='ke-upload-list'><thead><tr><th>图片</td><th>大小</td><th>上传进度</td><th>图片操作</td></tr></thead><tbody></tbody></table></div>")).appendTo(g).one("tbody");
g=(new n("<p style='margin:10px;text-align:right;'><button>确定上传</button></p>")).appendTo(g).one("button");var t=i.guid(name);u[t]=this;this.btn=h;this.up=g;this.on("swfReady",this._ready,this);b.offset(f);var B=r.Utils.flash.createSWFRuntime(A,{holder:b,attrs:{allowScriptAccess:"always",allowNetworking:"all",scale:"noScale",width:h.width(),height:h.height()},flashVars:{allowedDomain:location.hostname,shareData:true,YUISwfId:t,YUIBridgeCallback:"KISSY.Editor.BangPaiUpload.EventHandler",browser:name,
useCompression:true,menu:true}});this.flash=B;this._list=k;this._ds=d.serverUrl;this._dsp=d.serverParams||{};k.on("click",function(x){var e=new n(x.target);x.halt();if(e.hasClass("ke-upload-insert")){x=e.parent("tr");url=x.attr("url");a.insertElement(new n("<img src='"+url+"'/>",null,a.document))}else if(e.hasClass("ke-upload-delete")){x=e.parent("tr");t=x.attr("fid");try{B.cancel(t)}catch(c){}B.removeFile(t);s[t].destroy();delete s[t];x._4e_remove()}});this.on("fileSelect",this._onSelect,this);this.on("uploadStart",
this._onUploadStart,this);this.on("uploadProgress",this._onProgress,this);this.on("uploadComplete",this._onComplete,this);this.on("uploadCompleteData",this._onUploadCompleteData,this)},_onUploadStart:function(a){this.flash.removeFile(a.id)},_onComplete:function(){},_onUploadCompleteData:function(a){var d=i.trim(a.data).replace(/\\r||\\n/g,"");a=a.id;var h=this._list.all("tr");if(d){d=JSON.parse(d);if(d.error)alert(d.error);else for(var g=0;g<h.length;g++){var b=new n(h[g]);if(b.attr("fid")==a){b.one(".ke-upload-insert").show();
b.attr("url",d.imgUrl)}}}},_onProgress:function(a){var d=a.bytesLoaded*100/a.bytesTotal;(a=s[a.id])&&a.set("progress",d)},_onSelect:function(a){var d=this._list;if(a=a.fileList)for(var h in a)if(a.hasOwnProperty(h)){var g=a[h],b=(new n("<tr fid='"+g.id+"'><td>"+g.name+"</td><td>"+Math.floor(g.size/1E3)+"k</td><td class='ke-upload-progress'></td><td><a href='#' class='ke-upload-insert' style='display:none'>[插入]</a> &nbsp; <a href='#' class='ke-upload-delete'>[删除]</a> &nbsp; </td></tr>")).appendTo(d);
s[g.id]=new r.ProgressBar({container:b.one(".ke-upload-progress"),width:"100px",height:"18px"})}},_ready:function(){var a=this,d=a.flash,h=a.up;a.btn[0].disabled=false;d.setAllowMultipleFiles(true);d.setFileFilters([{extensions:"*.jpeg;*.jpg;*.png;*.gif",description:"图片文件( png,jpg,jpeg,gif )"}]);h.on("click",function(){d.uploadAll(a._ds,"POST",a._dsp,"Filedata")})},_eventHandler:function(a){var d=a.type;if(d==="log")i.log(a.message);else d&&this.fire(d,a)}});w.EventHandler=function(a,d){u[a]._eventHandler.call(u[a],
d)};r.BangPaiUpload=w})();v.addPlugin(function(){new r.BangPaiUpload(v)})}},{attach:false,requires:["flashutils","progressbar"]});
KISSY.Editor.add("bangpai-video",function(v){function i(a){for(var d=0;d<s.length;d++){var h=s[d];if(h.reg.test(a))return h}}var r=KISSY,w=r.Editor,q="ke_video",n=w.Flash,u=v.htmlDataProcessor,A=u&&u.dataFilter;A&&A.addRules({elements:{object:function(a){var d=a.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<a.children.length;d++)if(a.children[d].name=="embed"){if(!n.isFlashEmbed(a.children[d]))break;if(i(a.children[d].attributes.src))return u.createFakeParserElement(a,q,"bangpai-video",
true)}return null}for(d=0;d<a.children.length;d++){var h=a.children[d];if(h.name=="param"&&h.attributes.name=="movie")if(i(h.attributes.value))return u.createFakeParserElement(a,q,"bangpai-video",true)}},embed:function(a){if(!n.isFlashEmbed(a))return null;if(i(a.attributes.src))return u.createFakeParserElement(a,q,"bangpai-video",true)}}},4);var s=[{reg:/youku\.com/i,width:480,height:400,detect:function(a){var d=a.match(/id_([^.]+)\.html$/);if(d)return"http://player.youku.com/player.php/sid/"+d[1]+
"/v.swf";return a}},{reg:/tudou\.com/i,width:480,height:400,detect:function(a){var d=a.match(/\/view\/([^/]+)\/$/);if(d)return"http://www.tudou.com/v/"+d[1]+"/v.swf";return a}},{reg:/ku6\.com/i,width:480,height:400,detect:function(a){var d=a.match(/show[^\/]*\/([^.]+)\.html$/);if(d)return"http://player.ku6.com/refer/"+d[1]+"/v.swf";return a}}];w.BangPaiVideo||function(){function a(){a.superclass.constructor.apply(this,arguments)}function d(b){return b._4e_name()==="img"&&!!b.hasClass(q)&&b}var h=
["img."+q];r.extend(a,n,{_config:function(){var b=this.editor.cfg.pluginConfig;this._cls=q;this._type="bangpai-video";this._title="视频属性";this._bodyHtml="<table><tr><td colspan='2'>需要分享的视频链接：支持 土豆，优酷，ku6 视频分享</td></tr><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>视频链接： </span><input class='ke-video-url' style='width:230px' value='http://'/></label></td></tr><tr><td><label>宽度： </span> <input  data-verify='^自动|((?!0$)\\d+(.\\d+)?)$'  data-warning='宽度请输入正数' class='ke-video-width' style='width:60px' value='自动'/> 像素 </label></td><td><label> 高度： </span> <input  data-verify='^自动|((?!0$)\\d+(.\\d+)?)$'  data-warning='高度请输入正数' class='ke-video-height' style='width:60px' value='自动'/> 像素 </label></td></tr><tr><td><label>对齐： <select class='ke-video-align'><option value=''>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select></td><td><label>间距： </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='间距请输入非负数字' class='ke-video-margin' style='width:60px' value='5'/> 像素</label></td></tr></table>";
this._footHtml="<button class='ke-video-ok'>确定</button> <button class='ke-video-cancel'>取消</button>";this._contentCls="ke-toolbar-video";this._tip="插入视频";this._contextMenu=g;this._flashRules=h;this.urlCfg=b["bangpai-video"]&&b["bangpai-video"].urlCfg},_initD:function(){var b=this,f=b.d;b.dUrl=f.el.one(".ke-video-url");b.dAlign=f.el.one(".ke-video-align");b.dMargin=f.el.one(".ke-video-margin");b.dWidth=f.el.one(".ke-video-width");b.dHeight=f.el.one(".ke-video-height");var k=f.el.one(".ke-video-ok");
f=f.el.one(".ke-video-cancel");k.on("click",b._gen,b);f.on("click",function(){b.d.hide()})},_getDInfo:function(){var b=this.dUrl.val(),f=i(b);if(f)if(b=f.detect(b))return{url:b,attrs:{height:parseInt(this.dHeight.val())||f.height,width:parseInt(this.dWidth.val())||f.width,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}};else alert("http://");else alert("不支持该链接来源!")},_gen:function(){var b=this.dUrl.val(),f=this.urlCfg;if(f)for(var k=0;k<f.length;k++){var t=f[k];if(t.reg.test(b)){this.d.loading();
a.dynamicUrl.origin=b;a.dynamicUrl.instance=this;r.getScript(t.url.replace(/@url@/,encodeURIComponent(b)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")));return}}a.superclass._gen.call(this)},_dynamicUrlPrepare:function(b){this.dUrl.val(b);this.d.unloading();a.superclass._gen.call(this)},_updateD:function(){var b=this.editor,f=this.selectedFlash;if(f){b=b.restoreRealElement(f);this.dUrl.val(this._getFlashUrl(b));this.dAlign.val(b.attr("align"));this.dMargin.val(parseInt(b._4e_style("margin"))||
0);this.dWidth.val(b.attr("width"));this.dHeight.val(b.attr("height"))}else{this.dUrl.val("http://");this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("自动");this.dHeight.val("自动")}}});a.dynamicUrl=function(b,f){b===a.dynamicUrl.origin&&a.dynamicUrl.instance._dynamicUrlPrepare(f)};n.registerBubble("bangpai-video","视频链接： ",d);w.BangPaiVideo=a;var g={"视频属性":function(b){var f=b.getSelection();f=(f=f&&f.getStartElement())&&d(f);b=b._toolbars["bangpai-video"];f&&b.show(null,f)}}}();v.addPlugin(function(){new w.BangPaiVideo(v)})},
{attach:false,requires:["flashsupport"]});
