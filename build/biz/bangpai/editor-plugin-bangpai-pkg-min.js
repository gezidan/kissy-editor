KISSY.Editor.add("bangpai-music",function(r){function k(b){return/xiami\.com/i.test(b)}var n=KISSY,l=n.Editor,o=n.DOM,w=n.Node,p=l.Flash,j=r.htmlDataProcessor,s=j&&j.dataFilter,v="\u8f7d\u5165\u4e2d ";s&&s.addRules({elements:{object:function(b){var c=b.attributes;if(!(c.classid&&String(c.classid).toLowerCase())){for(c=0;c<b.children.length;c++)if(b.children[c].name=="embed"){if(!p.isFlashEmbed(b.children[c]))return null;if(k(b.children[c].attributes.src))return j.createFakeParserElement(b,"ke_xiami",
"bangpai-music",true)}return null}for(c=0;c<b.children.length;c++){var h=b.children[c];if(h.name=="param"&&h.attributes.name=="movie")if(k(h.attributes.value))return j.createFakeParserElement(b,"ke_xiami","bangpai-music",true)}},embed:function(b){if(!p.isFlashEmbed(b))return null;if(k(b.attributes.src))return j.createFakeParserElement(b,"ke_xiami","bangpai-music",true)}}},4);l.BangPaiMusic||function(){function b(a,d){if(a.length>d)a=a.substring(0,d)+"...";return a}function c(){c.superclass.constructor.apply(this,
arguments)}function h(a){return e.replace(/\${([^}]+)}/g,function(d,f){return a[f]})}function t(a,d,f){return"<a class='ke-xiami-page-item"+(a==d?" ke-xiami-curpage":"")+"' data-value='"+d+"' href='#'>"+(f||d)+"</a>"}o.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(a){var d=bangpai_xiami.instance;a.page=bangpai_xiami.page;d._listSearch(a)};var e="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";n.extend(c,p,{_config:function(){this._cls="ke_xiami";this._type="bangpai-music";this._title="\u641c\u7d22\u97f3\u4e50";this._bodyHtml="<div><p class='ks-clear'><input class='ke-xiami-url' style='width:250px' value='\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d'/> &nbsp;  <button style='vertical-align:middle;'>\u641c \u7d22 </button></p><div class='ke-xiami-list'></div></div>";
this._footHtml="";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u867e\u7c73\u97f3\u4e50";this._flashRules=this._contextMenu=null},_initD:function(){function a(q){var m={key:encodeURIComponent(i.val()),page:q,random:(new Date).valueOf()};m=h(m);bangpai_xiami.instance=d;bangpai_xiami.page=q;g.html(v);g[0].disabled=true;n.getScript(m)}var d=this,f=d.d,g=f.el.one("button"),i=f.el.one(".ke-xiami-url");d._xiami_input=i;d._xiamia_list=f.el.one(".ke-xiami-list");d._action=g;g.on("click",function(){a(1)},
d);d._xiamia_list.on("click",function(q){q.preventDefault();var m=new w(q.target);q=m._4e_ascendant(function(u){return d._xiamia_list._4e_contains(u)&&u.hasClass("ke-xiami-add")},true);m=m._4e_ascendant(function(u){return d._xiamia_list._4e_contains(u)&&u.hasClass("ke-xiami-page-item")},true);if(q){d._durl="http://www.xiami.com/widget/"+q.attr("data-value")+"/singlePlayer.swf";d._gen()}else m&&a(parseInt(m.attr("data-value")))})},_listSearch:function(a){var d=a.results,f;f=this._action;f.html("\u641c \u7d22 ");
f[0].disabled=false;if(d&&d.length){f="<ul>";for(var g=0;g<d.length;g++){var i=d[g];f+="<li title='"+decodeURIComponent(i.song_name)+"'><span class='ke-xiami-song'>"+b(decodeURIComponent(i.song_name),25)+"</span><a href='#' class='ke-xiami-add' data-value='"+(i.album_id+"_"+i.song_id)+"'>\u6dfb\u52a0</a></li>"}f+="</ul>";d=a.page;a=Math.floor(a.total/8);g=d-3;i=d+3;if(a>1){f+="<p class='ke-xiami-paging'>"+t(d,1,"1...");if(g<=2){i=Math.min(2-g+i,a-1);g=2}for(g=g;g<=i;g++)f+=t(d,g);if(i!=a)f+=t(d,a,
a+"...");f+="</p>"}}else f="<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u6ca1\u6709\u627e\u5230\u7ed3\u679c\uff01</p>";this._xiamia_list.html(f)},_updateD:function(){this._xiami_input.val("\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d");this._xiamia_list.html("")},_dbclick:function(){},_getDWidth:function(){return 257},_getDURl:function(){return this._durl},_getDHeight:function(){return 33}});l.BangPaiMusic=
c}();r.addPlugin(function(){new l.BangPaiMusic(r)})},{attach:false,requires:["flashsupport"]});
KISSY.Editor.add("bangpai-video",function(r){function k(b){for(var c=0;c<v.length;c++){var h=v[c];if(h.reg.test(b))return h}}var n=KISSY,l=n.Editor,o="ke_video",w=l.Utils.getFlashUrl,p=l.Flash,j=r.htmlDataProcessor,s=j&&j.dataFilter;s&&s.addRules({elements:{object:function(b){var c=b.attributes;if(!(c.classid&&String(c.classid).toLowerCase())){for(c=0;c<b.children.length;c++)if(b.children[c].name=="embed"){if(!p.isFlashEmbed(b.children[c]))return null;if(k(b.children[c].attributes.src))return j.createFakeParserElement(b,
o,"bangpai-video",true)}return null}for(c=0;c<b.children.length;c++){var h=b.children[c];if(h.name=="param"&&h.attributes.name=="movie")if(k(h.attributes.value))return j.createFakeParserElement(b,o,"bangpai-video",true)}},embed:function(b){if(!p.isFlashEmbed(b))return null;if(k(b.attributes.src))return j.createFakeParserElement(b,o,"bangpai-video",true)}}},4);var v=[{reg:/youku\.com/i,width:480,height:400,detect:function(b){if(/\.swf$/.test(b))return b}},{reg:/tudou\.com/i,width:480,height:400,detect:function(b){if(/\.swf$/.test(b))return b}},
{reg:/ku6\.com/i,width:480,height:400,detect:function(b){if(/\.swf$/.test(b))return b}}];l.BangPaiVideo||function(){function b(){b.superclass.constructor.apply(this,arguments)}function c(e){return e._4e_ascendant(function(a){return a._4e_name()==="img"&&!!a.hasClass(o)},true)}var h=["img."+o];n.extend(b,p,{_config:function(){this._cls=o;this._type="bangpai-video";this._title="\u89c6\u9891\u5c5e\u6027";this._bodyHtml="<div><p style='margin-bottom:5px'>\u9700\u8981\u5206\u4eab\u7684\u89c6\u9891\u94fe\u63a5\uff1a\u652f\u6301 \u571f\u8c46\uff0c\u4f18\u9177\uff0cku6 \u89c6\u9891\u5206\u4eab</p><p><label><span style='color:#0066CC;font-weight:bold;'>\u89c6\u9891\u94fe\u63a5\uff1a </span><input class='ke-video-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></p></div>";
this._footHtml="<button class='ke-video-ok'>\u786e\u5b9a</button> <button class='ke-video-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165\u89c6\u9891";this._contextMenu=t;this._flashRules=h},_initD:function(){var e=this,a=e.d;e.dUrl=a.el.one(".ke-video-url");var d=a.el.one(".ke-video-ok");a=a.el.one(".ke-video-cancel");d.on("click",e._gen,e);a.on("click",function(){e.d.hide()})},_getDWidth:function(){var e=this.dUrl.val();return(e=k(e))&&e.width},_getDURl:function(){var e=
this.dUrl.val(),a=k(e);if(a){(e=a.detect(e))||alert("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");return e}else alert("\u4e0d\u652f\u6301\u8be5\u94fe\u63a5\u6765\u6e90!")},_getDHeight:function(){var e=this.dUrl.val();return(e=k(e))&&e.height},_getFlashUrl:function(e){return w(e)},_updateD:function(){var e=this.editor,a=this.selectedFlash;a?this.dUrl.val(this._getFlashUrl(e.restoreRealElement(a))):this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf")}});p.registerBubble("bangpai-video",
"\u89c6\u9891\u94fe\u63a5\uff1a ",c);l.BangPaiVideo=b;var t={"\u89c6\u9891\u5c5e\u6027":function(e){var a=e.getSelection();a=(a=a&&a.getStartElement())&&c(a);e=e._toolbars["bangpai-video"];a&&e.show(null,a)}}}();r.addPlugin(function(){new l.BangPaiVideo(r)})},{attach:false,requires:["flashsupport"]});
