KISSY.Editor.add("bangpai-music",function(u){function r(f){return/xiami\.com/i.test(f)}var n=KISSY,l=n.Editor,s=n.DOM,y=n.Node,v=l.Config.base+"assets/loading.gif",m=l.Flash,o="ke_xiami",t=u.htmlDataProcessor,d=t&&t.dataFilter,g="\u8f7d\u5165\u4e2d ";d&&d.addRules({elements:{object:function(f){var j=f.attributes,e=f.attributes.title,b;if(!(j.classid&&String(j.classid).toLowerCase())){for(j=0;j<f.children.length;j++){b=f.children[j];if(b.name=="embed"){if(!m.isFlashEmbed(b))return null;if(r(b.attributes.src))return t.createFakeParserElement(f,
o,"bangpai-music",true,{title:e})}}return null}for(j=0;j<f.children.length;j++){b=f.children[j];if(b.name=="param"&&b.attributes.name=="movie")if(r(b.attributes.value))return t.createFakeParserElement(f,o,"bangpai-music",true,{title:e})}},embed:function(f){if(!m.isFlashEmbed(f))return null;if(r(f.attributes.src))return t.createFakeParserElement(f,o,"bangpai-music",true,{title:f.attributes.title})}}},4);l.BangPaiMusic||function(){function f(c,a){if(c.length>a)c=c.substring(0,a)+"...";return c}function j(){j.superclass.constructor.apply(this,
arguments)}function e(c){return z.replace(/\${([^}]+)}/g,function(a,h){return c[h]})}function b(c,a,h){return"<a class='ke-xiami-page-item"+(c==a?" ke-xiami-curpage":"")+"' data-value='"+a+"' href='#'>"+(h||a)+"</a>"}function x(c){return c._4e_ascendant(function(a){return a._4e_name()==="img"&&!!a.hasClass(o)},true)}s.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(c){var a=bangpai_xiami.instance;c.page=bangpai_xiami.page;a._listSearch(c)};var z="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";n.extend(j,m,{_config:function(){this._cls=o;this._type="bangpai-music";this._title="\u641c\u7d22\u97f3\u4e50";this._bodyHtml="<p><input class='ke-xiami-url' style='width:250px' value='\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d'/> &nbsp;  <button style='vertical-align:middle;'>\u641c \u7d22 </button></p><p style='margin:5px 0'><label>\u5bf9 \u9f50\uff1a <select class='ke-xiami-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select><p><div class='ke-xiami-list'></div>";
this._footHtml="";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u867e\u7c73\u97f3\u4e50";this._contextMenu=A;this._flashRules=["img."+o]},_updateTip:function(c,a){var h=this.editor.restoreRealElement(a);c.html(a.attr("title"));c.attr("href",this._getFlashUrl(h))},_initD:function(){function c(p){var q={key:encodeURIComponent(k.val()),page:p,random:(new Date).valueOf()};q=e(q);bangpai_xiami.instance=a;bangpai_xiami.page=p;i.html(g);i[0].disabled=true;a._xiamia_list.html("<img style='display:block;width:108px;margin:5px auto 0 auto;'src='"+
v+"'/>");n.getScript(q)}var a=this,h=a.d,i=h.el.one("button"),k=h.el.one(".ke-xiami-url");a.dAlign=h.el.one(".ke-xiami-align");a._xiami_input=k;a._xiamia_list=h.el.one(".ke-xiami-list");a._action=i;i.on("click",function(){c(1)},a);a._xiamia_list.on("click",function(p){p.preventDefault();var q=new y(p.target);p=q._4e_ascendant(function(w){return a._xiamia_list._4e_contains(w)&&w.hasClass("ke-xiami-add")},true);q=q._4e_ascendant(function(w){return a._xiamia_list._4e_contains(w)&&w.hasClass("ke-xiami-page-item")},
true);if(p){a._dinfo={url:"http://www.xiami.com/widget/"+p.attr("data-value")+"/singlePlayer.swf",attrs:{title:p.attr("title"),align:a.dAlign.val()}};a._gen()}else q&&c(parseInt(q.attr("data-value")))})},_listSearch:function(c){var a,h=c.results,i;i=this._action;i.html("\u641c \u7d22 ");i[0].disabled=false;if(h&&h.length){i="<ul>";for(a=0;a<h.length;a++){var k=h[a];i+="<li title='"+decodeURIComponent(k.song_name)+"'><span class='ke-xiami-song'>"+f(decodeURIComponent(k.song_name),25)+"</span><a href='#' title='"+
decodeURIComponent(k.song_name)+"' class='ke-xiami-add' data-value='"+(k.album_id+"_"+k.song_id)+"'>\u9009\u62e9</a></li>"}i+="</ul>";h=c.page;c=Math.floor(c.total/8);a=h-3;k=h+3;if(c>1){i+="<p class='ke-xiami-paging'>"+b(h,1,"1...");if(a<=2){k=Math.min(2-a+k,c-1);a=2}for(a=a;a<=k;a++)i+=b(h,a);if(k!=c)i+=b(h,c,c+"...");i+="</p>"}}else i="<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\u601d\uff0c\u6ca1\u6709\u627e\u5230\u7ed3\u679c\uff01</p>";this._xiamia_list.html(i)},_updateD:function(){var c=
this.selectedFlash;if(c){this._xiami_input.val(c.attr("title"));this.dAlign.val(c.attr("align"))}else{this._xiami_input.val("\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d");this.dAlign.val("")}this._xiamia_list.html("")},_getDInfo:function(){n.mix(this._dinfo.attrs,{width:165,height:37});return this._dinfo}});var A={"\u867e\u7c73\u5c5e\u6027":function(c){var a=c.getSelection();a=a&&a.getStartElement();a=x(a);c=c._toolbars["bangpai-music"];
a&&c.show(null,a)}};m.registerBubble("bangpai-music","\u867e\u7c73\u97f3\u4e50\uff1a ",x);l.BangPaiMusic=j}();u.addPlugin(function(){new l.BangPaiMusic(u)})},{attach:false,requires:["flashsupport"]});
KISSY.Editor.add("bangpai-video",function(u){function r(d){for(var g=0;g<t.length;g++){var f=t[g];if(f.reg.test(d))return f}}var n=KISSY,l=n.Editor,s="ke_video",y=l.Utils.getFlashUrl,v=l.Flash,m=u.htmlDataProcessor,o=m&&m.dataFilter;o&&o.addRules({elements:{object:function(d){var g=d.attributes;if(!(g.classid&&String(g.classid).toLowerCase())){for(g=0;g<d.children.length;g++)if(d.children[g].name=="embed"){if(!v.isFlashEmbed(d.children[g]))return null;if(r(d.children[g].attributes.src))return m.createFakeParserElement(d,
s,"bangpai-video",true)}return null}for(g=0;g<d.children.length;g++){var f=d.children[g];if(f.name=="param"&&f.attributes.name=="movie")if(r(f.attributes.value))return m.createFakeParserElement(d,s,"bangpai-video",true)}},embed:function(d){if(!v.isFlashEmbed(d))return null;if(r(d.attributes.src))return m.createFakeParserElement(d,s,"bangpai-video",true)}}},4);var t=[{reg:/youku\.com/i,width:480,height:400,detect:function(d){if(/\.swf$/.test(d))return d}},{reg:/tudou\.com/i,width:480,height:400,detect:function(d){if(/\.swf$/.test(d))return d}},
{reg:/ku6\.com/i,width:480,height:400,detect:function(d){if(/\.swf$/.test(d))return d}}];l.BangPaiVideo||function(){function d(){d.superclass.constructor.apply(this,arguments)}function g(e){return e._4e_ascendant(function(b){return b._4e_name()==="img"&&!!b.hasClass(s)},true)}var f=["img."+s];n.extend(d,v,{_config:function(){this._cls=s;this._type="bangpai-video";this._title="\u89c6\u9891\u5c5e\u6027";this._bodyHtml="<p style='margin-bottom:5px'>\u9700\u8981\u5206\u4eab\u7684\u89c6\u9891\u94fe\u63a5\uff1a\u652f\u6301 \u571f\u8c46\uff0c\u4f18\u9177\uff0cku6 \u89c6\u9891\u5206\u4eab</p><p><label><span style='color:#0066CC;font-weight:bold;'>\u89c6\u9891\u94fe\u63a5\uff1a </span><input class='ke-video-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></p><p style='margin:5px 0'><label>\u5bf9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u9f50\uff1a <select class='ke-video-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select><p>";
this._footHtml="<button class='ke-video-ok'>\u786e\u5b9a</button> <button class='ke-video-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165\u89c6\u9891";this._contextMenu=j;this._flashRules=f},_initD:function(){var e=this,b=e.d;e.dUrl=b.el.one(".ke-video-url");e.dAlign=b.el.one(".ke-video-align");var x=b.el.one(".ke-video-ok");b=b.el.one(".ke-video-cancel");x.on("click",e._gen,e);b.on("click",function(){e.d.hide()})},_getDInfo:function(){var e=this.dUrl.val(),
b=r(e);if(b){(e=b.detect(e))||alert("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");return{url:e,attrs:{height:b.height,width:b.width,align:this.dAlign.val()}}}else alert("\u4e0d\u652f\u6301\u8be5\u94fe\u63a5\u6765\u6e90!")},_getFlashUrl:function(e){return y(e)},_updateD:function(){var e=this.editor,b=this.selectedFlash;if(b){e=e.restoreRealElement(b);this.dUrl.val(this._getFlashUrl(e));this.dAlign.val(e.attr("align"))}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");
this.dAlign.val("")}}});v.registerBubble("bangpai-video","\u89c6\u9891\u94fe\u63a5\uff1a ",g);l.BangPaiVideo=d;var j={"\u89c6\u9891\u5c5e\u6027":function(e){var b=e.getSelection();b=(b=b&&b.getStartElement())&&g(b);e=e._toolbars["bangpai-video"];b&&e.show(null,b)}}}();u.addPlugin(function(){new l.BangPaiVideo(u)})},{attach:false,requires:["flashsupport"]});
