KISSY.Editor.add("bangpai-video",function(m){function k(a){for(var d=0;d<n.length;d++){var e=n[d];if(e.reg.test(a))return e}}var h=KISSY,f=h.Editor,g="ke_video",l=f.Flash,i=m.htmlDataProcessor,o=i&&i.dataFilter;o&&o.addRules({elements:{object:function(a){var d=a.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<a.children.length;d++)if(a.children[d].name=="embed"){if(!l.isFlashEmbed(a.children[d]))break;if(k(a.children[d].attributes.src))return i.createFakeParserElement(a,g,"bangpai-video",
true)}return null}for(d=0;d<a.children.length;d++){var e=a.children[d];if(e.name=="param"&&e.attributes.name=="movie")if(k(e.attributes.value))return i.createFakeParserElement(a,g,"bangpai-video",true)}},embed:function(a){if(!l.isFlashEmbed(a))return null;if(k(a.attributes.src))return i.createFakeParserElement(a,g,"bangpai-video",true)}}},4);var n=[{reg:/youku\.com/i,width:480,height:400,detect:function(a){var d=a.match(/id_([^.]+)\.html$/);if(d)return"http://player.youku.com/player.php/sid/"+d[1]+
"/v.swf";a.match(/v_playlist\/([^.]+)\.html$/);return a}},{reg:/tudou\.com/i,width:480,height:400,detect:function(a){return a}},{reg:/ku6\.com/i,width:480,height:400,detect:function(a){var d=a.match(/show[^\/]*\/([^.]+)\.html$/);if(d)return"http://player.ku6.com/refer/"+d[1]+"/v.swf";return a}}];f.BangPaiVideo||function(){function a(){a.superclass.constructor.apply(this,arguments)}function d(c){return c._4e_name()==="img"&&!!c.hasClass(g)&&c}var e=["img."+g];h.extend(a,l,{_config:function(){var c=
this.editor.cfg.pluginConfig;this._cls=g;this._type="bangpai-video";this._title="视频属性";this._bodyHtml="<div style='padding:20px 20px 0 20px'><p><label>链接： <input class='ke-video-url ke-input' style='width:410px;vertical-align:middle;'/></label></p><table style='margin:10px 0 5px  40px;width:400px;'><tr><td><label>宽度：  <input  data-verify='^(自动|((?!0$)\\d+))$'  data-warning='宽度请输入正整数' class='ke-video-width ke-input' style='width:60px;margin-left:2px;vertical-align:middle;' value='自动'/> 像素</label></td><td><label> 高度：  <input  data-verify='^(自动|((?!0$)\\d+))$'  data-warning='高度请输入正整数' class='ke-video-height ke-input' style='width:60px;vertical-align:middle;' value='自动'/> 像素</label></td></tr><tr><td><label>对齐： <select class='ke-video-align'><option value=''>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select></td><td><label>间距： <input  data-verify='^\\d+$'  data-warning='间距请输入非负整数' class='ke-video-margin ke-input' style='width:60px;vertical-align:middle;' value='5'/> 像素</label></td></tr></table></div>";
this._footHtml="<a class='ke-video-ok ke-button' style='margin-left:40px;margin-right:20px;'>确定</button> <a class='ke-video-cancel ke-button'>取消</a>";this._contentCls="ke-toolbar-video";this._tip="插入视频";this._contextMenu=q;this._flashRules=e;this.urlCfg=c["bangpai-video"]&&c["bangpai-video"].urlCfg;this._urlTip="支持 土豆，优酷，ku6 视频分享"},_initD:function(){var c=this.d,b=c.el;this.dUrl=b.one(".ke-video-url");this.dAlign=f.Select.decorate(b.one(".ke-video-align"));this.dMargin=b.one(".ke-video-margin");this.dWidth=
b.one(".ke-video-width");this.dHeight=b.one(".ke-video-height");var j=b.one(".ke-video-ok");b=b.one(".ke-video-cancel");j.on("click",this._gen,this);b.on("click",function(){c.hide()});f.Utils.placeholder(this.dUrl,this._urlTip)},_getDInfo:function(){var c=this.dUrl.val(),b=k(c);if(b){if(c=b.detect(c))return{url:c,attrs:{height:parseInt(this.dHeight.val())||b.height,width:parseInt(this.dWidth.val())||b.width,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}}else alert("不支持该链接来源!")},
_gen:function(){var c=this.dUrl.val(),b=this.urlCfg;if(b)for(var j=0;j<b.length;j++){var p=b[j];if(p.reg.test(c)){this.d.loading();a.dynamicUrl.origin=c;a.dynamicUrl.instance=this;setTimeout(function(){h.getScript(p.url.replace(/@url@/,encodeURIComponent(c)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")))},30);return}}a.superclass._gen.call(this)},_dynamicUrlPrepare:function(c){this.dUrl.val(c);this.d.unloading();a.superclass._gen.call(this)},_updateD:function(){var c=
this.editor,b=this.selectedFlash;if(b){c=c.restoreRealElement(b);this.dUrl.val(this._getFlashUrl(c));this.dAlign.val(c.attr("align"));this.dMargin.val(parseInt(c._4e_style("margin"))||0);b.css("width")&&this.dWidth.val(parseInt(b.css("width")));b.css("height")&&this.dHeight.val(parseInt(b.css("height")))}else{f.Utils.resetInput(this.dUrl);this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("自动");this.dHeight.val("自动")}}});a.dynamicUrl=function(c,b){h.trim(c)==h.trim(a.dynamicUrl.origin)&&a.dynamicUrl.instance._dynamicUrlPrepare(b)};
l.registerBubble("bangpai-video","视频链接： ",d);f.BangPaiVideo=a;var q={"视频属性":function(c){var b=c.getSelection();b=(b=b&&b.getStartElement())&&d(b);c=c._toolbars["bangpai-video"];b&&c.show(null,b)}}}();m.addPlugin(function(){new f.BangPaiVideo(m)})},{attach:false,requires:["flashsupport"]});
