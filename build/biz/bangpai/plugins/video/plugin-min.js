KISSY.Editor.add("bangpai-video",function(l){function j(a){for(var d=0;d<n.length;d++){var e=n[d];if(e.reg.test(a))return e}}var m=KISSY,f=m.Editor,g="ke_video",k=f.Flash,h=l.htmlDataProcessor,o=h&&h.dataFilter;o&&o.addRules({elements:{object:function(a){var d=a.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<a.children.length;d++)if(a.children[d].name=="embed"){if(!k.isFlashEmbed(a.children[d]))break;if(j(a.children[d].attributes.src))return h.createFakeParserElement(a,g,"bangpai-video",
true)}return null}for(d=0;d<a.children.length;d++){var e=a.children[d];if(e.name=="param"&&e.attributes.name=="movie")if(j(e.attributes.value))return h.createFakeParserElement(a,g,"bangpai-video",true)}},embed:function(a){if(!k.isFlashEmbed(a))return null;if(j(a.attributes.src))return h.createFakeParserElement(a,g,"bangpai-video",true)}}},4);var n=[{reg:/youku\.com/i,width:480,height:400,detect:function(a){var d=a.match(/id_([^.]+)\.html$/);if(d)return"http://player.youku.com/player.php/sid/"+d[1]+
"/v.swf";a.match(/v_playlist\/([^.]+)\.html$/);return a}},{reg:/tudou\.com/i,width:480,height:400,detect:function(a){return a}},{reg:/ku6\.com/i,width:480,height:400,detect:function(a){var d=a.match(/show[^\/]*\/([^.]+)\.html$/);if(d)return"http://player.ku6.com/refer/"+d[1]+"/v.swf";return a}}];f.BangPaiVideo||function(){function a(){a.superclass.constructor.apply(this,arguments)}function d(b){return b._4e_name()==="img"&&!!b.hasClass(g)&&b}var e=["img."+g];m.extend(a,k,{_config:function(){var b=
this.editor.cfg.pluginConfig;this._cls=g;this._type="bangpai-video";this._title="视频属性";this._bodyHtml="<div style='padding:20px 20px 0 20px'><p><label><span>链接： </span><input class='ke-video-url ke-input' style='width:310px'/></label></p><table style='margin:10px 0 5px  40px;width:100%;'><tr><td><label>宽度： </span> <input  data-verify='^自动|((?!0$)\\d+(.\\d+)?)$'  data-warning='宽度请输入正数' class='ke-video-width ke-input' style='width:60px' value='自动'/> 像素</label></td><td><label> 高度： </span> <input  data-verify='^自动|((?!0$)\\d+(.\\d+)?)$'  data-warning='高度请输入正数' class='ke-video-height ke-input' style='width:60px' value='自动'/> 像素</label></td></tr><tr><td><label>对齐： <select class='ke-video-align'><option value=''>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select></td><td><label>间距： </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='间距请输入非负数字' class='ke-video-margin ke-input' style='width:60px' value='5'/> 像素</label></td></tr></table></div>";
this._footHtml="<button class='ke-video-ok ke-button' style='margin-left:40px;margin-right:20px;'>确定</button> <a style='cursor:pointer' class='ke-video-cancel'>取消</a>";this._contentCls="ke-toolbar-video";this._tip="插入视频";this._contextMenu=q;this._flashRules=e;this.urlCfg=b["bangpai-video"]&&b["bangpai-video"].urlCfg;this._urlTip="支持 土豆，优酷，ku6 视频分享";this._config_dwidth="400px"},_initD:function(){var b=this.d,c=b.el;this.dUrl=c.one(".ke-video-url");this.dAlign=f.Select.decorate(c.one(".ke-video-align"));
this.dMargin=c.one(".ke-video-margin");this.dWidth=c.one(".ke-video-width");this.dHeight=c.one(".ke-video-height");var i=c.one(".ke-video-ok");c=c.one(".ke-video-cancel");i.on("click",this._gen,this);c.on("click",function(){b.hide()});f.Utils.placeholder(this.dUrl,this._urlTip)},_getDInfo:function(){var b=this.dUrl.val(),c=j(b);if(c){if(b=c.detect(b))return{url:b,attrs:{height:parseInt(this.dHeight.val())||c.height,width:parseInt(this.dWidth.val())||c.width,align:this.dAlign.val(),style:"margin:"+
(parseInt(this.dMargin.val())||0)+"px;"}}}else alert("不支持该链接来源!")},_gen:function(){var b=this.dUrl.val(),c=this.urlCfg;if(c)for(var i=0;i<c.length;i++){var p=c[i];if(p.reg.test(b)){this.d.loading();a.dynamicUrl.origin=b;a.dynamicUrl.instance=this;m.getScript(p.url.replace(/@url@/,encodeURIComponent(b)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")));return}}a.superclass._gen.call(this)},_dynamicUrlPrepare:function(b){this.dUrl.val(b);this.d.unloading();a.superclass._gen.call(this)},
_updateD:function(){var b=this.editor,c=this.selectedFlash;if(c){b=b.restoreRealElement(c);this.dUrl.val(this._getFlashUrl(b));this.dAlign.val(b.attr("align"));this.dMargin.val(parseInt(b._4e_style("margin"))||0);this.dWidth.val(b.attr("width"));this.dHeight.val(b.attr("height"))}else{f.Utils.resetInput(this.dUrl);this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("自动");this.dHeight.val("自动")}}});a.dynamicUrl=function(b,c){b===a.dynamicUrl.origin&&a.dynamicUrl.instance._dynamicUrlPrepare(c)};
k.registerBubble("bangpai-video","视频链接： ",d);f.BangPaiVideo=a;var q={"视频属性":function(b){var c=b.getSelection();c=(c=c&&c.getStartElement())&&d(c);b=b._toolbars["bangpai-video"];c&&b.show(null,c)}}}();l.addPlugin(function(){new f.BangPaiVideo(l)})},{attach:false,requires:["flashsupport"]});
