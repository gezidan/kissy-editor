KISSY.Editor.add("bangpai-video",function(m){function k(b){for(var d=0;d<n.length;d++){var e=n[d];if(e.reg.test(b))return e}}var h=KISSY,f=h.Editor,g="ke_video",l=f.Flash,i=m.htmlDataProcessor,o=i&&i.dataFilter;o&&o.addRules({elements:{object:function(b){var d=b.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<b.children.length;d++)if(b.children[d].name=="embed"){if(!l.isFlashEmbed(b.children[d]))break;if(k(b.children[d].attributes.src))return i.createFakeParserElement(b,g,"bangpai-video",
true)}return null}for(d=0;d<b.children.length;d++){var e=b.children[d];if(e.name=="param"&&e.attributes.name=="movie")if(k(e.attributes.value))return i.createFakeParserElement(b,g,"bangpai-video",true)}},embed:function(b){if(!l.isFlashEmbed(b))return null;if(k(b.attributes.src))return i.createFakeParserElement(b,g,"bangpai-video",true)}}},4);var n=[{reg:/youku\.com/i,width:480,height:400,detect:function(b){var d=b.match(/id_([^.]+)\.html$/);if(d)return"http://player.youku.com/player.php/sid/"+d[1]+
"/v.swf";b.match(/v_playlist\/([^.]+)\.html$/);return b}},{reg:/tudou\.com/i,width:480,height:400,detect:function(b){return b}},{reg:/ku6\.com/i,width:480,height:400,detect:function(b){var d=b.match(/show[^\/]*\/([^.]+)\.html$/);if(d)return"http://player.ku6.com/refer/"+d[1]+"/v.swf";return b}}];f.BangPaiVideo||function(){function b(){b.superclass.constructor.apply(this,arguments)}function d(c){return c._4e_name()==="img"&&!!c.hasClass(g)&&c}var e=["img."+g];h.extend(b,l,{_config:function(){var c=
this.editor.cfg.pluginConfig;this._cls=g;this._type="bangpai-video";this._title="视频";this._bodyHtml="<div style='padding:20px 20px 0 20px'><p><label>链接： <input class='ke-video-url ke-input' style='width:410px;vertical-align:middle;'/></label></p><table style='margin:10px 0 5px  40px;width:400px;'><tr><td><label>宽度：  <input  data-verify='^(自动|((?!0$)\\d+))$'  data-warning='宽度请输入正整数' class='ke-video-width ke-input' style='width:60px;margin-left:2px;vertical-align:middle;' value='自动'/> 像素</label></td><td><label> 高度：  <input  data-verify='^(自动|((?!0$)\\d+))$'  data-warning='高度请输入正整数' class='ke-video-height ke-input' style='width:60px;vertical-align:middle;' value='自动'/> 像素</label></td></tr><tr><td><label>对齐： <select class='ke-video-align'><option value='none'>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select></td><td><label>间距： <input  data-verify='^\\d+$'  data-warning='间距请输入非负整数' class='ke-video-margin ke-input' style='width:60px;vertical-align:middle;' value='5'/> 像素</label></td></tr></table></div>";
this._footHtml="<a class='ke-video-ok ke-button' style='margin-left:40px;margin-right:20px;'>确定</button> <a class='ke-video-cancel ke-button'>取消</a>";this._contentCls="ke-toolbar-video";this._tip="插入视频";this._contextMenu=q;this._flashRules=e;this.urlCfg=c["bangpai-video"]&&c["bangpai-video"].urlCfg;this._urlTip="请输入优酷网、土豆网、酷6网的视频播放页链接..."},_initD:function(){var c=this.d,a=c.el;this.dUrl=a.one(".ke-video-url");this.dAlign=f.Select.decorate(a.one(".ke-video-align"));this.dMargin=a.one(".ke-video-margin");
this.dWidth=a.one(".ke-video-width");this.dHeight=a.one(".ke-video-height");var j=a.one(".ke-video-ok");a=a.one(".ke-video-cancel");j.on("click",this._gen,this);a.on("click",function(){c.hide()});f.Utils.placeholder(this.dUrl,this._urlTip)},_getDInfo:function(){var c=this.dUrl.val(),a=k(c);if(a){if(c=a.detect(c))return{url:c,attrs:{height:parseInt(this.dHeight.val())||a.height,width:parseInt(this.dWidth.val())||a.width,style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;float:"+this.dAlign.val()+
";"}}}else alert("不支持该链接来源!")},_gen:function(){var c=this.dUrl.val(),a=this.urlCfg;if(a)for(var j=0;j<a.length;j++){var p=a[j];if(p.reg.test(c)){this.d.loading();b.dynamicUrl.origin=c;b.dynamicUrl.instance=this;setTimeout(function(){h.getScript(p.url.replace(/@url@/,encodeURIComponent(c)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")))},30);return}}b.superclass._gen.call(this)},_dynamicUrlPrepare:function(c){this.dUrl.val(c);this.d.unloading();b.superclass._gen.call(this)},
_updateD:function(){var c=this.editor,a=this.selectedFlash;if(a){c=c.restoreRealElement(a);this.dUrl.val(this._getFlashUrl(c));this.dAlign.val(a.css("float"));this.dMargin.val(parseInt(c._4e_style("margin"))||0);a.css("width")&&this.dWidth.val(parseInt(a.css("width")));a.css("height")&&this.dHeight.val(parseInt(a.css("height")))}else{f.Utils.resetInput(this.dUrl);this.dAlign.val("none");this.dMargin.val("5");this.dWidth.val("自动");this.dHeight.val("自动")}}});b.dynamicUrl=function(c,a){h.trim(c)==h.trim(b.dynamicUrl.origin)&&
b.dynamicUrl.instance._dynamicUrlPrepare(a)};l.registerBubble("bangpai-video","视频链接： ",d);f.BangPaiVideo=b;var q={"视频属性":function(c){var a=c.getSelection();a=(a=a&&a.getStartElement())&&d(a);c=c._toolbars["bangpai-video"];a&&c.show(null,a)}}}();m.addPlugin(function(){new f.BangPaiVideo(m)})},{attach:false,requires:["flashsupport"]});
