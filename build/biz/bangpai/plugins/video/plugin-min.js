KISSY.Editor.add("bangpai-video",function(l){function j(a){for(var d=0;d<n.length;d++){var e=n[d];if(e.reg.test(a))return e}}var m=KISSY,f=m.Editor,g="ke_video",k=f.Flash,h=l.htmlDataProcessor,o=h&&h.dataFilter;o&&o.addRules({elements:{object:function(a){var d=a.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<a.children.length;d++)if(a.children[d].name=="embed"){if(!k.isFlashEmbed(a.children[d]))break;if(j(a.children[d].attributes.src))return h.createFakeParserElement(a,g,"bangpai-video",
true)}return null}for(d=0;d<a.children.length;d++){var e=a.children[d];if(e.name=="param"&&e.attributes.name=="movie")if(j(e.attributes.value))return h.createFakeParserElement(a,g,"bangpai-video",true)}},embed:function(a){if(!k.isFlashEmbed(a))return null;if(j(a.attributes.src))return h.createFakeParserElement(a,g,"bangpai-video",true)}}},4);var n=[{reg:/youku\.com/i,width:480,height:400,detect:function(a){var d=a.match(/id_([^.]+)\.html$/);if(d)return"http://player.youku.com/player.php/sid/"+d[1]+
"/v.swf";a.match(/v_playlist\/([^.]+)\.html$/);return a}},{reg:/tudou\.com/i,width:480,height:400,detect:function(a){return a}},{reg:/ku6\.com/i,width:480,height:400,detect:function(a){var d=a.match(/show[^\/]*\/([^.]+)\.html$/);if(d)return"http://player.ku6.com/refer/"+d[1]+"/v.swf";return a}}];f.BangPaiVideo||function(){function a(){a.superclass.constructor.apply(this,arguments)}function d(c){return c._4e_name()==="img"&&!!c.hasClass(g)&&c}var e=["img."+g];m.extend(a,k,{_config:function(){var c=
this.editor.cfg.pluginConfig;this._cls=g;this._type="bangpai-video";this._title="视频属性";this._bodyHtml="<div style='padding:20px 20px 0 20px'><p><label><span>链接： </span><input class='ke-video-url ke-input' style='width:300px'/></label></p><table style='margin:10px 0 5px  40px;width:300px;'><tr><td><label>宽度： </span> <input  data-verify='^自动|((?!0$)\\d+(.\\d+)?)$'  data-warning='宽度请输入正数' class='ke-video-width ke-input' style='width:60px' value='自动'/> 像素</label></td><td><label> 高度： </span> <input  data-verify='^自动|((?!0$)\\d+(.\\d+)?)$'  data-warning='高度请输入正数' class='ke-video-height ke-input' style='width:60px' value='自动'/> 像素</label></td></tr><tr><td><label>对齐： <select class='ke-video-align'><option value=''>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select></td><td><label>间距： </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='间距请输入非负数字' class='ke-video-margin ke-input' style='width:60px' value='5'/> 像素</label></td></tr></table></div>";
this._footHtml="<button class='ke-video-ok ke-button' style='margin-left:40px;margin-right:20px;'>确定</button> <a style='cursor:pointer' class='ke-video-cancel'>取消</a>";this._contentCls="ke-toolbar-video";this._tip="插入视频";this._contextMenu=q;this._flashRules=e;this.urlCfg=c["bangpai-video"]&&c["bangpai-video"].urlCfg;this._urlTip="支持 土豆，优酷，ku6 视频分享";this._config_dwidth="400px"},_initD:function(){var c=this.d,b=c.el;this.dUrl=b.one(".ke-video-url");this.dAlign=f.Select.decorate(b.one(".ke-video-align"));
this.dMargin=b.one(".ke-video-margin");this.dWidth=b.one(".ke-video-width");this.dHeight=b.one(".ke-video-height");var i=b.one(".ke-video-ok");b=b.one(".ke-video-cancel");i.on("click",this._gen,this);b.on("click",function(){c.hide()});f.Utils.placeholder(this.dUrl,this._urlTip)},_getDInfo:function(){var c=this.dUrl.val(),b=j(c);if(b){if(c=b.detect(c))return{url:c,attrs:{height:parseInt(this.dHeight.val())||b.height,width:parseInt(this.dWidth.val())||b.width,align:this.dAlign.val(),style:"margin:"+
(parseInt(this.dMargin.val())||0)+"px;"}}}else alert("不支持该链接来源!")},_gen:function(){var c=this.dUrl.val(),b=this.urlCfg;if(b)for(var i=0;i<b.length;i++){var p=b[i];if(p.reg.test(c)){this.d.loading();a.dynamicUrl.origin=c;a.dynamicUrl.instance=this;m.getScript(p.url.replace(/@url@/,encodeURIComponent(c)).replace(/@callback@/,encodeURIComponent("KISSY.Editor.BangPaiVideo.dynamicUrl")));return}}a.superclass._gen.call(this)},_dynamicUrlPrepare:function(c){this.dUrl.val(c);this.d.unloading();a.superclass._gen.call(this)},
_updateD:function(){var c=this.editor,b=this.selectedFlash;if(b){c=c.restoreRealElement(b);this.dUrl.val(this._getFlashUrl(c));this.dAlign.val(c.attr("align"));this.dMargin.val(parseInt(c._4e_style("margin"))||0);b.css("width")&&this.dWidth.val(parseInt(b.css("width")));b.css("height")&&this.dHeight.val(parseInt(b.css("height")))}else{f.Utils.resetInput(this.dUrl);this.dAlign.val("");this.dMargin.val("5");this.dWidth.val("自动");this.dHeight.val("自动")}}});a.dynamicUrl=function(c,b){c===a.dynamicUrl.origin&&
a.dynamicUrl.instance._dynamicUrlPrepare(b)};k.registerBubble("bangpai-video","视频链接： ",d);f.BangPaiVideo=a;var q={"视频属性":function(c){var b=c.getSelection();b=(b=b&&b.getStartElement())&&d(b);c=c._toolbars["bangpai-video"];b&&c.show(null,b)}}}();l.addPlugin(function(){new f.BangPaiVideo(l)})},{attach:false,requires:["flashsupport"]});
