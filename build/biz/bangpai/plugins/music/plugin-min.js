KISSY.Editor.add("bangpai-music",function(o){function p(d){return/xiami\.com/i.test(d)}var j=KISSY,n=j.Editor,t=j.DOM,u=j.Node,q=n.Flash,k=o.htmlDataProcessor,s=k&&k.dataFilter,v="\u8f7d\u5165\ufffd?";s&&s.addRules({elements:{object:function(d){var f=d.attributes;if(!(f.classid&&String(f.classid).toLowerCase())){for(f=0;f<d.children.length;f++)if(d.children[f].name=="embed"){if(!q.isFlashEmbed(d.children[f]))return null;if(p(d.children[f].attributes.src))return k.createFakeParserElement(d,"ke_xiami",
"bangpai-music",true)}return null}for(f=0;f<d.children.length;f++){var l=d.children[f];if(l.name=="param"&&l.attributes.name=="movie")if(p(l.attributes.value))return k.createFakeParserElement(d,"ke_xiami","bangpai-music",true)}},embed:function(d){if(!q.isFlashEmbed(d))return null;if(p(d.attributes.src))return k.createFakeParserElement(d,"ke_xiami","bangpai-music",true)}}},4);n.BangPaiMusic||function(){function d(b,a){if(b.length>a)b=b.substring(0,a)+"...";return b}function f(){f.superclass.constructor.apply(this,
arguments)}function l(b){return w.replace(/\${([^}]+)}/g,function(a,c){return b[c]})}function r(b,a,c){return"<a class='ke-xiami-page-item"+(b==a?" ke-xiami-curpage":"")+"' data-value='"+a+"' href='#'>"+(c||a)+"</a>"}t.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(b){var a=bangpai_xiami.instance;b.page=bangpai_xiami.page;a._listSearch(b)};var w="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";j.extend(f,q,{_config:function(){this._cls="ke_xiami";this._type="bangpai-music";this._title="\u641c\u7d22\u97f3\u4e50";this._bodyHtml="<div><p class='ks-clear'><input class='ke-xiami-url' style='width:250px' value='\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d'/> &nbsp;  <button style='vertical-align:middle;'>\ufffd?\ufffd?</button></p><div class='ke-xiami-list'></div></div>";
this._footHtml="";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u867e\u7c73\u97f3\u4e50";this._flashRules=this._contextMenu=null},_initD:function(){function b(i){var h={key:encodeURIComponent(g.val()),page:i,random:(new Date).valueOf()};h=l(h);bangpai_xiami.instance=a;bangpai_xiami.page=i;e.html(v);e[0].disabled=true;j.getScript(h)}var a=this,c=a.d,e=c.el.one("button"),g=c.el.one(".ke-xiami-url");a._xiami_input=g;a._xiamia_list=c.el.one(".ke-xiami-list");a._action=e;e.on("click",function(){b(1)},
a);a._xiamia_list.on("click",function(i){i.preventDefault();var h=new u(i.target);i=h._4e_ascendant(function(m){return a._xiamia_list._4e_contains(m)&&m.hasClass("ke-xiami-add")},true);h=h._4e_ascendant(function(m){return a._xiamia_list._4e_contains(m)&&m.hasClass("ke-xiami-page-item")},true);if(i){a._durl="http://www.xiami.com/widget/"+i.attr("data-value")+"/singlePlayer.swf";a._gen()}else h&&b(parseInt(h.attr("data-value")))})},_listSearch:function(b){var a=b.results,c;c=this._action;c.html("\ufffd?\ufffd?");
c[0].disabled=false;if(a&&a.length){c="<ul>";for(var e=0;e<a.length;e++){var g=a[e];c+="<li title='"+decodeURIComponent(g.song_name)+"'><span class='ke-xiami-song'>"+d(decodeURIComponent(g.song_name),25)+"</span><a href='#' class='ke-xiami-add' data-value='"+(g.album_id+"_"+g.song_id)+"'>\u6dfb\u52a0</a></li>"}c+="</ul>";a=b.page;b=Math.floor(b.total/8);e=a-3;g=a+3;if(b>1){c+="<p class='ke-xiami-paging'>"+r(a,1,"1...");if(e<=2){g=Math.min(2-e+g,b-1);e=2}for(e=e;e<=g;e++)c+=r(a,e);if(g!=b)c+=r(a,b,
b+"...");c+="</p>"}}else c="<p style='text-align:center;margin:10px 0;'>\u4e0d\u597d\u610f\ufffd?\uff0c\u6ca1\u6709\u627e\u5230\u7ed3\u679c\uff01</p>";this._xiamia_list.html(c)},_updateD:function(){this._xiami_input.val("\u8f93\u5165\u60f3\u8981\u6dfb\u52a0\u7684\u6b4c\u66f2\u540d\u3001\u4e13\u8f91\u540d\u3001\u827a\u4eba\u540d");this._xiamia_list.html("")},_dbclick:function(){},_getDWidth:function(){return 257},_getDURl:function(){return this._durl},_getDHeight:function(){return 33}});n.BangPaiMusic=
f}();o.addPlugin(function(){new n.BangPaiMusic(o)})},{attach:false,requires:["flashsupport"]});
