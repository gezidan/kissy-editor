KISSY.Editor.add("bangpai-music",function(s){var k=KISSY,w=k.UA,x=k.Event,m=k.Editor,u=k.DOM,y=k.Node,z=m.Config.base+"theme/loading.gif",r=m.Flash,n="ke_xiami",q=s.htmlDataProcessor,v=q&&q.dataFilter;v&&v.addRules({elements:{object:function(f){var i=f.attributes,p=f.attributes.title,j;if(!(i.classid&&String(i.classid).toLowerCase())){for(i=0;i<f.children.length;i++){j=f.children[i];if(j.name=="embed"){if(!r.isFlashEmbed(j))break;if(/xiami\.com/i.test(j.attributes.src))return q.createFakeParserElement(f,
n,"bangpai-music",true,{title:p})}}return null}for(i=0;i<f.children.length;i++){j=f.children[i];if(j.name=="param"&&j.attributes.name=="movie")if(/xiami\.com/i.test(j.attributes.value))return q.createFakeParserElement(f,n,"bangpai-music",true,{title:p})}},embed:function(f){if(!r.isFlashEmbed(f))return null;if(/xiami\.com/i.test(f.attributes.src))return q.createFakeParserElement(f,n,"bangpai-music",true,{title:f.attributes.title})}}},4);m.BangPaiMusic||function(){function f(b){f.superclass.constructor.apply(this,
arguments);b.cfg.disableObjectResizing||x.on(b.document.body,w.ie?"resizestart":"resize",function(a){u.hasClass(a.target,n)&&a.preventDefault()})}function i(b){return A.replace(/\${([^}]+)}/g,function(a,d){return b[d]})}function p(b,a,d){return"<a class='ke-xiami-page-item"+(b==a?" ke-xiami-curpage":"")+"' data-value='"+a+"' href='#'>"+(d||a)+"</a>"}function j(b){return b._4e_name()==="img"&&!!b.hasClass(n)&&b}u.addStyleSheet(".ke-xiami-list {margin-top:10px;}.ke-xiami-list li{border:1px dotted gray;border-width:0 0 1px 0;overflow:hidden;zoom:1;padding:2px;}\n.ke-xiami-list .ke-xiami-add {float:right;}\n.ke-xiami-list .ke-xiami-song {float:left;}\n.ke-xiami-paging a{display: inline-block; zoom: 1;  *display: inline; border:1px solid gray;padding:0 5px;margin:0 2px;}\n.ke-xiami-paging a:hover,.ke-xiami-paging a.ke-xiami-curpage {background-color:orange;}\n.ke-xiami-paging {text-align:center;margin-top:10px;}\n",
"BangPaiMusic");window.bangpai_xiami=function(b){var a=bangpai_xiami.instance;b.page=bangpai_xiami.page;a._listSearch(b)};var A="http://www.xiami.com/app/nineteen/search/key/${key}/page/${page}?random=${random}&callback=bangpai_xiami";k.extend(f,r,{_config:function(){this._cls=n;this._type="bangpai-music";this._title="虾米属性";this._bodyHtml="<form action='#' class='ke-xiami-form'><p class='ke-xiami-title'></p><p class='ke-xiami-url-wrap'><input class='ke-xiami-url ke-input' style='width:300px'/> &nbsp;  <button class='ke-xiami-submit ke-button' type='submit' >搜 索 </button></p><p style='margin:10px 0'><label>对 齐： <select class='ke-xiami-align'><option value=''>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select><label style='margin-left:45px;'>间距： </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='间距请输入非负数字' class='ke-xiami-margin ke-input' style='width:60px' value='5'/> 像素</label></p></form><div class='ke-xiami-list'></div>";
this._footHtml="<button class='ke-xiami-ok ke-button'>确&nbsp;定</button><button class='ke-xiami-cancel ke-button' style='margin-left:20px;'>取&nbsp;消</button>";this._contentCls="ke-toolbar-music";this._tip="插入虾米音乐";this._contextMenu=B;this._flashRules=["img."+n];this._config_dwidth="430px"},_updateTip:function(b,a){var d=this.editor.restoreRealElement(a);if(d){b.html(a.attr("title"));b.attr("href",this._getFlashUrl(d))}},_initD:function(){function b(e){var h=l.val();if(h.replace(/[^\x00-\xff]/g,"@@").length>
30)alert("长度上限30个字符（1个汉字=2个字符）");else if(k.trim(h)){a._xiami_submit[0].disabled=true;h={key:encodeURIComponent(l.val()),page:e,random:(new Date).valueOf()};h=i(h);bangpai_xiami.instance=a;bangpai_xiami.page=e;a._xiamia_list.html("<img style='display:block;width:108px;margin:5px auto 0 auto;'src='"+z+"'/>");var o=k.getScript(h,{timeout:10,success:function(){},error:function(){o.src="";a._xiami_submit[0].disabled=false;a._xiamia_list.html("<p style='text-align:center;margin:10px 0;'>不好意思，超时了，请重试！</p>")}})}else alert("不能为空！")}
var a=this,d=a.editor,c=a.d,g=c.el.one(".ke-xiami-form"),l=c.el.one(".ke-xiami-url");a.dAlign=c.el.one(".ke-xiami-align");a._xiami_input=l;m.Utils.placeholder(l,"输入歌曲名、专辑名、艺人名");a._xiamia_list=c.el.one(".ke-xiami-list");a._xiami_submit=c.el.one(".ke-xiami-submit");a.dMargin=c.el.one(".ke-xiami-margin");a._xiami_url_wrap=c.el.one(".ke-xiami-url-wrap");a._xiamia_title=c.el.one(".ke-xiami-title");var t=c.foot.one(".ke-xiami-ok");c.foot.one(".ke-xiami-cancel").on("click",function(){c.hide()});t.on("click",
function(){var e=a.selectedFlash,h=d.restoreRealElement(e);a._dinfo={url:a._getFlashUrl(h),attrs:{title:e.attr("title"),align:a.dAlign.val(),style:"margin:"+(parseInt(a.dMargin.val())||0)+"px;"}};a._gen()},a);g.on("submit",function(e){b(1);e.halt()},a);a._xiamia_list.on("click",function(e){e.preventDefault();var h=new y(e.target);e=h._4e_ascendant(function(o){return a._xiamia_list._4e_contains(o)&&o.hasClass("ke-xiami-add")},true);h=h._4e_ascendant(function(o){return a._xiamia_list._4e_contains(o)&&
o.hasClass("ke-xiami-page-item")},true);if(e){a._dinfo={url:"http://www.xiami.com/widget/"+e.attr("data-value")+"/singlePlayer.swf",attrs:{title:e.attr("title"),align:a.dAlign.val(),style:"margin:"+(parseInt(a.dMargin.val())||0)+"px;"}};a._gen()}else h&&b(parseInt(h.attr("data-value")))})},_listSearch:function(b){var a,d=b.results,c="";if(b.key==k.trim(this._xiami_input.val())){this._xiami_submit[0].disabled=false;if(d&&d.length){c="<ul>";for(a=0;a<d.length;a++){var g=d[a],l=decodeURIComponent(g.song_name)+
" - "+decodeURIComponent(g.artist_name);c=c;var t="<li title='"+l+"'><span class='ke-xiami-song'>",e=l;if(e.length>35)e=e.substring(0,35)+"...";c=c+(t+e+"</span><a href='#' title='"+l+"' class='ke-xiami-add' data-value='"+(g.album_id+"_"+g.song_id)+"'>选择</a></li>")}c+="</ul>";d=b.page;b=Math.floor(b.total/8);a=d-3;g=d+3;if(b>1){if(a<=2){g=Math.min(2-a+g,b-1);a=2}g=Math.min(g,b-1);if(g==b-1)a=Math.max(2,g-6);c+="<p class='ke-xiami-paging'>"+p(d,1,"1"+(a!=2?"...":""));for(a=a;a<=g;a++)c+=p(d,a);if(g!=
b)c+=p(d,b,(g!=b-1?"...":"")+b);c+="</p>"}}else c="<p style='text-align:center;margin:10px 0;'>不好意思，没有找到结果！</p>";this._xiamia_list.html(c)}},_updateD:function(){var b=this.selectedFlash;if(b){this._xiami_input.val(b.attr("title"));this._xiamia_title.html(b.attr("title"));this.dAlign.val(b.attr("align"));this.dMargin.val(parseInt(b._4e_style("margin"))||0);this._xiami_url_wrap.hide();this.d.foot.show();this._xiamia_title.show()}else{m.Utils.resetInput(this._xiami_input);this.dAlign.val("");this.dMargin.val("5");
this._xiami_url_wrap.show();this.d.foot.hide();this._xiamia_title.hide()}this._xiami_submit[0].disabled=false;this._xiamia_list.html("")},_getDInfo:function(){k.mix(this._dinfo.attrs,{width:257,height:33});return this._dinfo}});var B={"虾米属性":function(b){var a=b.getSelection();a=a&&a.getStartElement();a=j(a);b=b._toolbars["bangpai-music"];a&&b.show(null,a)}};r.registerBubble("bangpai-music","虾米音乐： ",j);m.BangPaiMusic=f}();s.addPlugin(function(){new m.BangPaiMusic(s)})},{attach:false,requires:["flashsupport"]});
