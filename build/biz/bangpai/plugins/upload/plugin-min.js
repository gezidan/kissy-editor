KISSY.Editor.add("bangpai-upload",function(v){var n=KISSY,g=n.Editor;if(!g.BangPaiUpload){(function(){function w(a){this.editor=a;this._init()}var o=n.DOM,z=n.JSON,h=n.Node,A=g.SimpleOverlay,B=g.Config.base+g.Utils.debugUrl("plugins/uploader/uploader.swf"),r={};name="ke-bangpai-upload";o.addStyleSheet(".ke-upload-head {background-color: #f4f7fc;background: -webkit-gradient(linear, left top, left bottom, from(rgb(244, 247, 252)), to(rgb(235, 239, 244)));background: -moz-linear-gradient(top, rgb(244, 247, 252), rgb(235, 239, 244));filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#f4f7fc', endColorstr = '#ebeff4');height:40px;border-bottom:1px solid #CED5E0;padding-top:1px;}.ke-upload-head-text {height:30px;line-height:30px;width:120px;margin-top:8px;margin-left:30px;text-align:center;border:1px solid #CED5E0;border-bottom-color:#FDFDFD;background:#FDFDFD;padding-bottom:2px;margin-bottom:-2px;position:relative;}.ke-upload-btn-wrap {position:relative;padding:15px 20px 15px 10px;text-align:right;}.ke-upload-list {width:100%;}.ke-upload-list th {border-top:1px solid #c1c8d1;background-color:#EBEDF1;}.ke-upload-list td,.ke-upload-list th {padding:0.5em;text-align:center;border-bottom:1px solid #c1c8d1;}",
"ke-BangPaiUpload");n.augment(w,n.EventTarget,{_prepareShow:function(){var a=this,b=a.editor,c=b.cfg.pluginConfig["bangpai-upload"];a.dialog=new A({title:"批量上传",mask:false,focusMgr:false,width:"700px"});var e=a.dialog;e.foot.hide();var d=e.body,i=(new h("<div class='ke-upload-btn-wrap'><span style='margin:0 15px 0 0px;color:#969696;display:inline-block;vertical-align:middle;width:80%;'></span></div>")).appendTo(d),l=(new h("<div style='display:none'>")).appendTo(d),f=new g.TripleButton({text:"浏&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;览",
cls:"ke-button",container:i}),q=f.el.offset(),j=f.el.width()*2,k=f.el.height()*1.5;d=(new h("<div style='"+("position:absolute;width:"+j+"px;height:"+k+"px;z-index:"+b.baseZIndex(9999)+";")+"'>")).appendTo(i);var x=(new h("<div><table class='ke-upload-list'><thead><tr><th>序号</th><th>图片</th><th>大小</th><th style='width:30%'>上传进度</th><th>图片操作</th></tr></thead><tbody></tbody></table></div>")).appendTo(l),s=x.one("tbody"),t=(new h("<p style='margin:15px 20px 35px; 0;text-align:right;'><a class='ke-button ke-bangpiaupload-ok'>确定上传</a><a class='ke-button ke-bangpiaupload-insertall' style='margin-left:20px;'>全部插入</a></p>")).appendTo(l),
y=t.one(".ke-bangpiaupload-ok");t=t.one(".ke-bangpiaupload-insertall");n.guid(name);var C=(new h("<span></span>")).insertBefore(y);c.extraHtml&&x.append(c.extraHtml);a.statusText=C;a.btn=f;a.up=y;d.offset(q);f=new g.FlashBridge({movie:B,methods:["removeFile","cancel","removeFile","disable","enable","setAllowMultipleFiles","setFileFilters","uploadAll"],holder:d,attrs:{width:j,height:k},params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,menu:true}});a.flashPos=d;a.uploader=f;a._list=
s;a._listTable=s.parent("table");a._listWrap=l;a._ds=c.serverUrl;a._dsp=c.serverParams||{};a._fileInput=c.fileInput||"Filedata";a._sizeLimit=c.sizeLimit||1E3;a._numberLimit=c.numberLimit||15;i.one("span").html("允许用户同时上传"+a._numberLimit+"张图片，单张图片容量不超过"+a._sizeLimit/1E3+"M");t.on("click",function(){trs=s.all("tr");for(var m=0;m<trs.length;m++){var p=new h(trs[m]),u=p.attr("url");if(u){b.insertElement(new h("<p>&nbsp;<img src='"+u+"'/>&nbsp;</p>",null,b.document));a._removeTrFile(p)}}if(u){l.hide();
e.hide()}});s.on("click",function(m){var p=new h(m.target);m.halt();if(p.hasClass("ke-upload-insert")){m=p.parent("tr");url=m.attr("url");b.insertElement(new h("<img src='"+url+"'/>",null,b.document))}if(p.hasClass("ke-upload-delete")||p.hasClass("ke-upload-insert")){m=p.parent("tr");a._removeTrFile(m)}});f.on("fileSelect",a._onSelect,a);f.on("uploadStart",a._onUploadStart,a);f.on("uploadProgress",a._onProgress,a);f.on("uploadComplete",a._onComplete,a);f.on("uploadCompleteData",a._onUploadCompleteData,
a);f.on("swfReady",a._ready,a);f.on("uploadError",a._uploadError,a)},_removeTrFile:function(a){var b=a.attr("fid"),c=this.uploader;try{c.cancel(b)}catch(e){}c.removeFile(b);if(r[b]){r[b].destroy();delete r[b]}a._4e_remove();this.denable();this._seqPics()},_init:function(){var a=this.editor,b=new g.TripleButton({contentCls:"ke-toolbar-mul-image",title:"批量插图",container:a.toolBarDiv});b.on("offClick",this.show,this);this.el=b;g.Utils.lazyRun(this,"_prepareShow","_realShow");g.Utils.sourceDisable(a,this)},
disable:function(){this.el.disable()},enable:function(){this.el.boff()},_realShow:function(){this.dialog.show()},show:function(){this._prepareShow()},_uploadError:function(a){var b=a.id,c=this._getFileTr(b);b=r[b];if(c){b&&b.destroy();c.one(".ke-upload-progress").html("<div style='color:red;'>"+a.status+"</div>")}},_getFileTr:function(a){for(var b=this._list.all("tr"),c=0;c<b.length;c++){var e=new h(b[c]);if(e.attr("fid")==a)return e}},_onUploadStart:function(a){this.uploader.removeFile(a.id)},_onComplete:function(){},
_onUploadCompleteData:function(a){var b=n.trim(a.data).replace(/\\r||\\n/g,"");a=a.id;if(b){b=z.parse(b);if(b.error)this._uploadError({id:a,status:b.error});else{if(a=this._getFileTr(a)){a.one(".ke-upload-insert").show();a.attr("url",b.imgUrl)}this._seqPics()}}},_onProgress:function(a){var b=Math.floor(a.bytesLoaded*100/a.bytesTotal);(a=r[a.id])&&a.set("progress",b)},ddisable:function(){this.uploader.disable();this.btn.disable();this.flashPos.offset({left:-9999,top:-9999})},denable:function(){this.uploader.enable();
this.btn.enable();this.flashPos.offset(this.btn.el.offset())},_seqPics:function(){var a=this._list,b=1,c=a.all("tr");a.all(".ke-upload-seq").each(function(d){d.html(b++)});for(var e=a=0;e<c.length;e++)(new h(c[e])).attr("url")||a++;this.statusText.html("队列中剩余"+a+"张图片，点击确定上传，开始上传。 ")},_getFilesSize:function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b},_onSelect:function(a){var b=this.uploader,c=this._list,e=0;a=a.fileList;var d=this._numberLimit;if(a){var i=this._getFilesSize(a);i>d&&
alert("系统将只保留 n 张".replace(/n/,this._numberLimit));i>=d&&this.ddisable();d=c.children("tr");for(c=0;c<d.length;c++)(i=o.attr(d[c],"fid"))&&a[i]&&delete a[i];d=this._numberLimit-d.length;this._listWrap.show();i=this._list[0];for(c in a)if(a.hasOwnProperty(c)){e++;var l=a[c],f=Math.floor(l.size/1E3),q=l.id;if(e>d)b.removeFile(q);else{var j=i.insertRow(-1);o.attr(j,"fid",q);var k=j.insertCell(-1);o.attr(k,"class","ke-upload-seq");k=j.insertCell(-1);o.html(k,l.name);k=j.insertCell(-1);o.html(k,f+"k");
k=j.insertCell(-1);o.attr(k,"class","ke-upload-progress");k=j.insertCell(-1);o.html(k,"<a href='#' class='ke-upload-insert' style='display:none'>[插入]</a> &nbsp; <a href='#' class='ke-upload-delete'>[删除]</a> &nbsp;");j=new h(j);j.one(".ke-upload-progress");if(f>this._sizeLimit){this._uploadError({id:q,status:"图片不能超过 n M".replace(/n/,this._sizeLimit/1E3)});b.removeFile(q)}else r[q]=new g.ProgressBar({container:j.one(".ke-upload-progress"),width:"100px",height:"18px"})}}this._seqPics()}},_ready:function(){var a=
this,b=a.uploader,c=a.up,e=a.btn,d=a.flashPos,i=g.Utils.normParams;e.enable();d.offset(e.el.offset());b.setAllowMultipleFiles(true);b.setFileFilters([{extensions:"*.jpeg;*.jpg;*.png;*.gif",description:"图片文件( png,jpg,jpeg,gif )"}]);c.on("click",function(l){l.halt();b.uploadAll(a._ds,"POST",i(a._dsp),a._fileInput)})}});g.BangPaiUpload=w})();v.addPlugin(function(){new g.BangPaiUpload(v)})}},{attach:false,requires:["flashutils","progressbar","flashbridge","overlay"]});
