KISSY.Editor.add("bangpai-upload",function(v){var j=KISSY,g=j.Editor,w=j.UA;g.BangPaiUpload||function(){function x(a){this.editor=a;this._init()}var m=j.DOM,s=j.JSON,h=j.Node,A=g.SimpleOverlay;s=j.JSON;var y=window[g.STORE],B=g.Config.base+g.Utils.debugUrl("plugins/uploader/uploader.longzang.swf?t=201010231602"),p={};m.addStyleSheet(".ke-upload-btn-wrap {position:relative;padding:15px 20px 15px 10px;}.ke-upload-list {width:100%;}.ke-upload-list th {border-top:1px solid #c1c8d1;background-color: #E7E9ED;background: -webkit-gradient(linear, left top, left bottom, from(#E7E9ED), to(#F1F4F7));background: -moz-linear-gradient(top, #E7E9ED, #F1F4F7);}.ke-upload-list td,.ke-upload-list th {padding:0em;height:26px;line-height:26px;text-align:center;border-bottom:1px solid #c1c8d1;}",
"ke-BangPaiUpload");j.augment(x,j.EventTarget,{_prepareShow:function(){var a=this,b=a.editor,c=b.cfg.pluginConfig["bangpai-upload"];a.dialog=new A({title:"批量上传",mask:false,draggable:"all",focusMgr:false,width:"600px"});var d=a.dialog;d.foot.hide();var e=d.body,f=(new h("<div class='ke-upload-btn-wrap'><span style='margin:0 15px 0 0px;color:#969696;display:inline-block;vertical-align:middle;width:469px;'></span></div>")).appendTo(e),l=(new h("<div style='display:none'>")).appendTo(e),n=new g.TripleButton({text:"浏&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;览",
cls:"ke-button",container:f}),o=(new h("<div><table class='ke-upload-list'><thead><tr><th>序号</th><th>图片</th><th>大小</th><th style='width:35%'>上传进度</th><th>图片操作</th></tr></thead><tbody></tbody></table></div>")).appendTo(l),r=o.one("tbody"),q=(new h("<p style='margin:15px 15px 30px; 0;text-align:right;'><a class='ke-button ke-bangpiaupload-ok'>确定上传</a><a class='ke-button ke-bangpiaupload-insertall' style='margin-left:20px;'>全部插入</a><a class='ke-button ke-bangpiaupload-delall' style='margin-left:20px;'>清空列表</a></p>")).appendTo(l),
C=q.one(".ke-bangpiaupload-ok");e=q.one(".ke-bangpiaupload-insertall");var D=q.one(".ke-bangpiaupload-delall");j.guid("ke-bangpai-upload");q=(new h("<span>")).insertBefore(q[0].firstChild);a._sizeLimit=c.sizeLimit||1E4;a._numberLimit=c.numberLimit||15;var z="允许用户同时上传"+a._numberLimit+"张图片，单张图片容量不超过"+a._sizeLimit/1E3+"M";w.fpvGEQ("10.0.0")||(z="您的flash插件版本过低，该功能不可用，请<a href='http://get.adobe.com/cn/flashplayer/' target='_blank'>点此升级</a>");n.disable();f.one("span").html(z);if(w.fpvGEQ("10.0.0")){c.extraHtml&&
o.append(c.extraHtml);a._list=r;a._listTable=r.parent("table");a._listWrap=l;a._ds=c.serverUrl;a._dsp=c.serverParams||{};a._fileInput=c.fileInput||"Filedata";a.statusText=q;a.btn=n;a.up=C;c=n.el.offset();o=n.el.width()*2;n=n.el.height()*1.5;f=(new h("<div style='"+("position:absolute;width:"+o+"px;height:"+n+"px;z-index:"+b.baseZIndex(9999)+";")+"'>")).appendTo(f);f.offset(c);a.flashPos=f;f=new g.FlashBridge({movie:B,ajbridge:true,methods:["cancel","removeFile","lock","unlock","setAllowMultipleFiles",
"setFileFilters","uploadAll"],holder:f,attrs:{width:o,height:n},params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,btn:true,hand:true}});a.uploader=f;e.on("click",function(){for(var k=r.all("tr"),i=0;i<k.length;i++){var t=new h(k[i]),u=t.attr("url");if(u){b.insertElement(new h("<p>&nbsp;<img src='"+u+"'/>&nbsp;</p>",null,b.document));a._removeTrFile(t)}}if(u){l.hide();d.hide()}});r.on("click",function(k){var i=new h(k.target);k.halt();if(i.hasClass("ke-upload-insert")){k=i.parent("tr");
url=k.attr("url");b.insertElement(new h("<img src='"+url+"'/>",null,b.document))}if(i.hasClass("ke-upload-delete")||i.hasClass("ke-upload-insert")){k=i.parent("tr");a._removeTrFile(k)}});D.on("click",function(){for(var k=r.all("tr"),i=0;i<k.length;i++){var t=new h(k[i]);a._removeTrFile(t)}l.hide()});f.on("fileSelect",a._onSelect,a);f.on("uploadStart",a._onUploadStart,a);f.on("uploadProgress",a._onProgress,a);f.on("uploadCompleteData",a._onUploadCompleteData,a);f.on("contentReady",a._ready,a);f.on("uploadError",
a._uploadError,a);a._restore()}},_removeTrFile:function(a){var b=a.attr("fid"),c=this.uploader;if(b){try{c.cancel(b)}catch(d){}c.removeFile(b)}if(p[b]){p[b].destroy();delete p[b]}a._4e_remove();this.denable();this._syncStatus()},_init:function(){var a=this,b=a.editor,c=new g.TripleButton({contentCls:"ke-toolbar-mul-image",title:"批量插图",container:b.toolBarDiv});c.on("offClick",a.show,a);a.el=c;g.Utils.lazyRun(a,"_prepareShow","_realShow");g.Utils.sourceDisable(b,a);a.disable();g.storeReady(function(){a.enable()})},
disable:function(){this.el.disable()},enable:function(){this.el.boff()},_realShow:function(){this.dialog.show()},show:function(){this._prepareShow()},_uploadError:function(a){var b=a.id||a.file&&a.file.id;if(b){var c=this._getFileTr(b);b=p[b];var d=a.status;if(!a._custom){j.log(d);d="服务器出错或格式不正确"}if(c){b&&b.destroy();c.one(".ke-upload-progress").html("<div style='color:red;'>"+d+"</div>")}}else j.log(a)},_getFileTr:function(a){for(var b=this._list.all("tr"),c=0;c<b.length;c++){var d=new h(b[c]);if(d.attr("fid")==
a)return d}},_onUploadStart:function(a){this.uploader.removeFile(a.file.id)},_onUploadCompleteData:function(a){var b=j.trim(a.data).replace(/\r|\n/g,"");a=a.file.id;if(b){b=s.parse(b);if(b.error)this._uploadError({id:a,_custom:1,status:b.error});else{if(a=this._getFileTr(a)){a.one(".ke-upload-insert").show();a.attr("url",b.imgUrl)}this._syncStatus()}}},_onProgress:function(a){var b=Math.floor(a.bytesLoaded*100/a.bytesTotal);(a=p[a.file.id])&&a.set("progress",b)},ddisable:function(){this.uploader.lock();
this.btn.disable();this.flashPos.offset({left:-9999,top:-9999})},denable:function(){this.uploader.unlock();this.btn.enable();this.flashPos.offset(this.btn.el.offset())},_syncStatus:function(){var a=this._list,b=1,c=a.all("tr");if(c.length==0)this._listWrap.hide();else{a.all(".ke-upload-seq").each(function(e){e.html(b++)});for(var d=a=0;d<c.length;d++)(new h(c[d])).attr("url")||a++;this.statusText.html("队列中剩余"+a+"张图片，点击确定上传，开始上传。 ")}this._save()},_restore:function(){var a=y.getItem("Multi-Upload-Save"),
b=this._list[0],c,d;if(a){a=s.parse(decodeURIComponent(a));for(var e=0;e<a.length;e++){c=a[e];c.complete=1;c.fid="restore_"+e;d=this._createFileTr(b,c);d.attr("url",c.url)}if(c){this._listWrap.show();this._syncStatus()}}},_save:function(){for(var a=this._list.all("tr"),b=[],c,d,e,f=0;f<a.length;f++){c=new h(a[f]);if(d=c.attr("url")){e=c.one(".ke-upload-filesize").html();c=c.one(".ke-upload-filename").html();b.push({name:c,size:e,url:d})}}y.setItem("Multi-Upload-Save",encodeURIComponent(s.stringify(b)))},
_getFilesSize:function(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b},_createFileTr:function(a,b){var c=b.fid,d=a.insertRow(-1),e,f=this._sizeLimit;m.attr(d,"fid",c);e=d.insertCell(-1);m.attr(e,"class","ke-upload-seq");e=d.insertCell(-1);if(b.name.length>18)b.name=b.name.substring(0,18)+"...";m.html(e,b.name);m.attr(e,"class","ke-upload-filename");e=d.insertCell(-1);m.html(e,b.size);m.attr(e,"class","ke-upload-filesize");e=d.insertCell(-1);m.attr(e,"class","ke-upload-progress");e=d.insertCell(-1);
m.html(e,"<a href='#' class='ke-upload-insert' "+(b.complete?"":"style='display:none'")+">[插入]</a> &nbsp; <a href='#' class='ke-upload-delete'>[删除]</a> &nbsp;");d=new h(d);d.one(".ke-upload-progress");if(parseInt(b.size)>f){this._uploadError({id:c,_custom:1,status:"图片太大，请压缩至 n M以下".replace(/n/,f/1E3)});this.uploader.removeFile(c)}else{p[c]=new g.ProgressBar({container:d.one(".ke-upload-progress"),width:"100px",height:"15px"});b.complete&&p[c].set("progress",100)}return d},_onSelect:function(a){var b=
this.uploader,c=this._list,d=0;a=a.fileList;var e=this._numberLimit,f;if(a){e=c.children("tr");for(c=0;c<e.length;c++)(f=m.attr(e[c],"fid"))&&a[f]&&delete a[f];e=this._numberLimit-e.length;f=this._getFilesSize(a);f>e&&alert("系统将只保留 n 张".replace(/n/,this._numberLimit));f>=e&&this.ddisable();this._listWrap.show();f=this._list[0];for(c in a)if(a.hasOwnProperty(c)){d++;var l=a[c],n=Math.floor(l.size/1E3),o=l.id;d>e?b.removeFile(o):this._createFileTr(f,{size:n+"k",fid:o,name:l.name})}this._syncStatus()}},
_ready:function(){var a=this,b=a.uploader,c=a.up,d=a.btn,e=a.flashPos,f=g.Utils.normParams;d.enable();e.offset(d.el.offset());b.setAllowMultipleFiles(true);b.setFileFilters([{ext:"*.jpeg;*.jpg;*.png;*.gif",desc:"图片文件( png,jpg,jpeg,gif )"}]);c.detach();c.on("click",function(l){l.halt();b.uploadAll(a._ds,"POST",f(a._dsp),true,a._fileInput)})}});g.BangPaiUpload=x}();v.addPlugin(function(){new g.BangPaiUpload(v)})},{attach:false,requires:["flashutils","progressbar","flashbridge","overlay","localStorage"]});
