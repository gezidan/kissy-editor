KISSY.Editor.add("definition",function(h){var o=true,u=false,y=document,p=KISSY,g=p.UA,q=p.DOM,r=p.Node,t=p.Event,A=h.focusManager,C=h.Utils.tryThese,D=h.Utils.debugUrl("theme/editor-iframe.css"),E=1,i="document.open();"+(h.Utils.isCustomDomain()?'document.domain="'+y.domain+'";':"")+"document.close();",F="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(g.ie?"javascript:void(function(){"+encodeURIComponent(i)+"}())":"")+'"  tabIndex="'+(g.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";h.SOURCE_MODE=0;h.WYSIWYG_MODE=1;h.SOURCE_MODE=h.SOURCE_MODE;h.WYSIWYG_MODE=h.WYSIWYG_MODE;p.augment(h,{init:function(b){if(g.ie)q.addClass(y.body,"ie"+g.ie);else if(g.gecko)q.addClass(y.body,"gecko");else g.webkit&&q.addClass(y.body,"webkit");var a=this,c=new r(F.replace(/\$\(tabIndex\)/,
b.attr("tabIndex")));c.on("mousedown",function(k){if(g.webkit){var w=q._4e_name(k.target);if(w=="select"||w=="option")return o}k.halt()});b.on("mousedown",function(k){k.stopPropagation()});a.editorWrap=c;a._UUID=E++;A.register(a);a.wrap=c.one(".ke-textarea-wrap");a.wrap=a.wrap;a.iframe=a.wrap.one("iframe");a.iframe=a.iframe;a.toolBarDiv=c.one(".ke-editor-tools");a.toolBarDiv=a.toolBarDiv;a.textarea=b;a.textarea=a.textarea;a.statusDiv=c.one(".ke-editor-status");a.statusDiv=a.statusDiv;a.toolBarDiv._4e_unselectable();
a._commands={};a._dialogs={};var d=b._4e_style("width"),e=b._4e_style("height");if(d){c.css("width",d);b.css("width","100%")}a.textarea.css("display","none");c.insertAfter(b);a.wrap[0].appendChild(b[0]);if(e){a.wrap.css("height",e);b.css("height","100%")}c=a.iframe;a.on("dataReady",function(){a._ready=o;h.fire("instanceCreated",{editor:a})});g.gecko?c.on("load",a._setUpIFrame,a):a._setUpIFrame();a.cfg.attachForm&&b[0].form&&a._attachForm()},_attachForm:function(){(new r(this.textarea[0].form)).on("submit",
this.sync,this)},useDialog:function(b,a){var c=this,d=h.SimpleOverlay;d.loading();c.use(b,function(){var e=c.getDialog(b);a(e);d.unloading()})},addDialog:function(b,a){this._dialogs[b]=a},getDialog:function(b){return this._dialogs[b]},addPlugin:function(b){this.ready(b)},addCommand:function(b,a){this._commands[b]=a},hasCommand:function(b){return this._commands[b]},execCommand:function(b){var a=this._commands[b],c=p.makeArray(arguments);c.shift();c.unshift(this);return a.exec.apply(a,c)},getMode:function(){return this.textarea.css("display")==
"none"?h.WYSIWYG_MODE:h.SOURCE_MODE},getData:function(b){var a;a=this.getMode()==h.WYSIWYG_MODE?this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)a=b?this.htmlDataProcessor.toHtml(a,"p"):this.htmlDataProcessor.toServer(a,"p");a=p.trim(a);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(a))a="";return a},setData:function(b){var a=b;if(this.htmlDataProcessor)a=this.htmlDataProcessor.toDataFormat(b,"p");this.document.body.innerHTML=a;this.getMode()!=h.WYSIWYG_MODE&&this.textarea.val(b)},sync:function(){this.textarea.val(this.getData())},
baseZIndex:function(b){b=b||0;return b+(this.cfg.baseZIndex||0)},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(b){this.document.body.innerHTML=b},_prepareIFrameHtml:function(b){var a=this.cfg,c=a.customLink,d="";if(c)for(var e=0;e<c.length;e++)d+='<link href="'+c[e]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+h.Config.base+D+"' rel='stylesheet'/><style>"+(a.customStyle||"")+"</style>"+d+"</head><body class='ke-editor'>&nbsp;"+
(b?'<script id="ke_actscript" type="text/javascript">'+(h.Utils.isCustomDomain()?'document.domain="'+y.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':"")+"</body></html>"},getSelection:function(){return h.Selection.getSelection(this.document)},focus:function(){var b=this.document,a=q._4e_getWin(b);g.webkit&&a&&a.parent&&a.parent.focus();a&&a.focus();b&&b.body.focus();this.notifySelectionChange()},blur:function(){q._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},
addCustomStyle:function(b){var a=this.cfg,c=this.document;a.customStyle=a.customStyle||"";a.customStyle+="\n"+b;a=c.createElement("style");c.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(c.createTextNode(b))},addCustomLink:function(b){var a=this.cfg,c=this.document;a.customLink=a.customLink||[];a.customLink.push(b);a=c.createElement("link");a.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(a);a.href=b},removeCustomLink:function(b){for(var a=
this.cfg,c=p.makeArray(this.document.getElementsByTagName("link")),d=0;d<c.length;d++)c[d].href==b&&q._4e_remove(c[d]);a.customLink=a.customLink||[];a=a.customLink;b=p.indexOf(b,a);b!=-1&&a.splice(b,1)},_setUpIFrame:function(){function b(){k=e.document;a.document=k;c.detach();k.open("text/html","replace");k.write(d);k.close()}var a=this,c=a.iframe,d=a._prepareIFrameHtml(a._UUID),e=c[0].contentWindow,k;try{k=e.document}catch(w){c[0].src=c[0].src;if(g.ie<7){setTimeout(b,10);return}}b()},ready:function(b){this._ready?
b():this.on("dataReady",b)},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId);b._monitorId=setTimeout(function(){var a=b.getSelection();if(a&&!a.isInvalid){var c=a.getStartElement(),d=new h.ElementPath(c);if(!b.previousPath||!b.previousPath.compare(d)){b.previousPath=d;b.fire("selectionChange",{selection:a,path:d,element:c})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(b,a){var c=this;c.focus();var d=b._4e_name(),e=
h.XHTML_DTD,k=h.RANGE,w=h.NODE,m=e.$block[d],v=c.getSelection(),x=v&&v.getRanges(),n,f,j,s,l;if(!x||x.length==0){var B=arguments,G=B.callee;setTimeout(function(){G.apply(c,B)},30)}else{c.fire("save");for(var z=x.length-1;z>=0;z--){n=x[z];n.deleteContents();f=!z&&b||b._4e_clone(o);a&&a(f);if(m)for(;(s=n.getCommonAncestor(u,o))&&(l=e[s._4e_name()])&&!(l&&l[d]);)if(s._4e_name()in e.span)n.splitElement(s);else if(n.checkStartOfBlock()&&n.checkEndOfBlock()){n.setStartBefore(s);n.collapse(o);s._4e_remove()}else n.splitBlock();
n.insertNode(f);j||(j=f)}if(j){d=j._4e_nextSourceNode(o);e=c.document;l=h.XHTML_DTD;if(l.$inline[f._4e_name()]){d=new r(e.createTextNode(" "));d.insertAfter(j)}else if(d){if(d._4e_name()=="br"&&l[d.parent()._4e_name()].p){l=new r("<p>&nbsp;</p>",null,e);d[0].parentNode.replaceChild(l[0],d[0]);d=l}}else{l=new r("<p>&nbsp;</p>",null,e);l.insertAfter(j);d=l}n.moveToPosition(j,k.POSITION_AFTER_END);d&&d[0].nodeType==w.NODE_ELEMENT&&n.moveToElementEditablePosition(d);v.selectRanges([n]);c.focus();f&&f._4e_scrollIntoView();
setTimeout(function(){c.fire("save")},10);return f}}},insertHtml:function(b){var a=this;if(a.htmlDataProcessor)b=a.htmlDataProcessor.toDataFormat(b);if(g.webkit){var c=q.create(b,null,this.document);c=c.nodeType==11?p.makeArray(c.childNodes):[c];for(var d=0;d<c.length;d++)a.insertElement(new r(c[d]))}else{a.focus();d=(c=a.getSelection())&&c.getRanges();if(!d||d.length==0){var e=arguments,k=e.callee;setTimeout(function(){k.apply(a,e)},30)}else{a.fire("save");if(g.ie){c=c.getNative();c.type=="Control"&&
c.clear();c.createRange().pasteHTML(b)}else a.document.execCommand("inserthtml",u,b);a.focus();setTimeout(function(){a.fire("save")},10)}}}});h._initIFrame=function(b){function a(f){C(function(){e.designMode="on";setTimeout(function(){e.designMode="off";m.focus();if(!arguments.callee.retry)arguments.callee.retry=o},50)},function(){e.designMode="off";q.attr(m,"contentEditable",u);q.attr(m,"contentEditable",o);!f&&a(1)})}var c=A.getInstance(b);b=c.textarea[0];var d=c.iframe[0].contentWindow,e=c.document,
k=c.cfg,w=e.getElementById("ke_actscript");q._4e_remove(w);var m=e.body;if(g.ie){m.hideFocus=o;m.disabled=o;m.contentEditable=o;m.removeAttribute("disabled")}else setTimeout(function(){if(g.gecko||g.opera)m.contentEditable=o;else if(g.webkit)m.parentNode.contentEditable=o;else e.designMode="on"},0);if(g.webkit){t.on(e,"click",function(f){var j=new r(f.target);p.inArray(j._4e_name(),["input","select"])&&f.preventDefault()});t.on(e,"mouseup",function(f){var j=new r(f.target);p.inArray(j._4e_name(),
["input","textarea"])&&f.preventDefault()})}if(g.gecko||g.ie||g.opera){var v;v=new r(q.insertAfter((new r('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],b));v.on("focus",function(){c.focus()});c.activateGecko=function(){g.gecko&&c.iframeFocus&&v[0].focus()};c.on("destroy",function(){})}if(g.ie&&e.compatMode=="CSS1Compat"||g.gecko||g.opera){var x=new r(e.documentElement);x.on("mousedown",function(f){if(f.target==x[0]){g.gecko&&a(u);v[0].focus()}})}t.on(d,
"focus",function(){if(g.gecko)a(u);else g.opera&&m.focus();c.notifySelectionChange()});g.gecko&&t.on(c.document,"mousedown",function(){c.iframeFocus||a(u)});if(g.ie){t.on(e,"keydown",function(f){if(f.keyCode in{8:1,46:1}){var j=c.getSelection(),s=j.getSelectedElement();if(s){c.fire("save");var l=j.getRanges()[0].createBookmark();s._4e_remove();j.selectBookmarks([l]);c.fire("save");f.preventDefault()}}});if(e.compatMode=="CSS1Compat"){var n={33:1,34:1};t.on(e,"keydown",function(f){f.keyCode in n&&
setTimeout(function(){c.getSelection().scrollIntoView()},0)})}}setTimeout(function(){g.ie&&setTimeout(function(){if(e){m.runtimeStyle.marginBottom="0px";m.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.fire("dataReady");var f=k.disableObjectResizing,j=k.disableInlineTableEditing;if(f||j)try{e.execCommand("enableObjectResizing",u,!f);e.execCommand("enableInlineTableEditing",u,!j)}catch(s){t.on(m,g.ie?"resizestart":"resize",function(l){if(f||q._4e_name(l.target)==="table"&&j)l.preventDefault()})}},
10);g.webkit&&t.on(e,"mousedown",function(f){f=new r(f.target);p.inArray(f._4e_name(),["img","hr","input","textarea","select"])&&c.getSelection().selectElement(f)});g.gecko&&t.on(e,"dragstart",function(f){var j=new r(f.target);j._4e_name()==="img"&&/ke_/.test(j[0].className)&&f.preventDefault()});A.add(c)};i=h.prototype;h.Utils.extern(i,{setData:i.setData,getData:i.getData,insertElement:i.insertElement,insertHtml:i.insertHtml,ready:i.ready,addCustomStyle:i.addCustomStyle,addCommand:i.addCommand,hasCommand:i.hasCommand,
execCommand:i.execCommand,addPlugin:i.addPlugin,useDialog:i.useDialog,addDialog:i.addDialog,getDialog:i.getDialog,getMode:i.getMode,sync:i.sync,baseZIndex:i.baseZIndex,getSelection:i.getSelection,focus:i.focus,blur:i.blur,notifySelectionChange:i.notifySelectionChange})});
