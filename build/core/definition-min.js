KISSY.Editor.add("definition",function(g){function x(a){return y+"<html><head><title>kissy-editor</title><link href='"+g.Config.base+z+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(a?'<script id="ke_actscrpt" type="text/javascript">'+(g.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':"")}var o=KISSY,e=o.UA,q=o.DOM,m=o.Node,r=o.Event,w=g.focusManager,A=g.Utils.tryThese,y="<!doctype html>",z=
g.Utils.debugUrl("theme/editor-iframe.css"),B=1,C="document.open();"+(g.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",D="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(e.ie?"javascript:void(function(){"+encodeURIComponent(C)+"}())":"")+'"  tabIndex="'+
(e.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";g.SOURCE_MODE=0;g.WYSIWYG_MODE=1;o.augment(g,{init:function(a){var b=this,c=new m(D.replace(/\$\(tabIndex\)/,a.attr("tabIndex")));c.on("mousedown",function(l){if(e.webkit){var s=q._4e_name(l.target);if(s=="select"||s=="option")return true}l.halt()});b.editorWrap=c;b._UUID=B++;w.register(b);b.wrap=c.one(".ke-textarea-wrap");b.iframe=b.wrap.one("iframe");b.toolBarDiv=
c.one(".ke-editor-tools");b.textarea=a;b.statusDiv=c.one(".ke-editor-status");b.toolBarDiv._4e_unselectable();b._commands={};var p=a._4e_style("width"),f=a._4e_style("height");if(p){c.css("width",p);a.css("width","100%")}b.textarea.css("display","none");c.insertAfter(a);b.wrap[0].appendChild(a[0]);if(f){b.wrap.css("height",f);a.css("height","100%")}a=b.iframe;b.on("dataReady",function(){b.ready=true;g.fire("instanceCreated",{editor:b})});e.gecko?a.on("load",b._setUpIFrame,b):b._setUpIFrame()},addCommand:function(a,
b){this._commands[a]=b},execCommand:function(a){this.fire("save");this._commands[a].exec(this);this.fire("save")},getMode:function(){return this.textarea.css("display")=="none"?g.WYSIWYG_MODE:g.SOURCE_MODE},getData:function(){var a;a=this.getMode()==g.WYSIWYG_MODE?this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(a,"p");return a},setData:function(a){if(this.htmlDataProcessor)a=this.htmlDataProcessor.toDataFormat(a,"p");this.document.body.innerHTML=
a;if(this.getMode()==g.WYSIWYG_MODE)this.document.body.innerHTML=a;else this.textarea.val(a)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(a){this.document.body.innerHTML=a},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.fire("wysiwygmode")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");e.ie<8&&this.textarea.css("height",this.wrap.css("height"));
this.fire("sourcemode")},_prepareIFrameHtml:x,getSelection:function(){var a=new g.Selection(this.document);return!a||a.isInvalid?null:a},focus:function(){var a=q._4e_getWin(this.document);e.webkit&&a&&a.parent&&a.parent.focus();a&&a.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){q._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function a(){l=f.document;b.document=l;c.detach();l.open("text/html","replace");
l.write(p);l.close()}var b=this,c=b.iframe,p=x(b._UUID),f=c[0].contentWindow,l;try{l=f.document}catch(s){c[0].src=c[0].src;if(e.ie&&e.ie<7){setTimeout(a,10);return}}a()},addPlugin:function(a){this.ready?a():this.on("dataReady",a)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){b=b.getStartElement();var c=new g.ElementPath(b);if(!a.previousPath||!a.previousPath.compare(c)){a.previousPath=c;a.fire("selectionChange",
{selection:a,path:c,element:b})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(a,b){var c=this;c.focus();var p=a._4e_name(),f=g.XHTML_DTD,l=g.RANGE,s=g.NODE,j=f.$block[p],t=c.getSelection(),u=t.getRanges(),k,d,h,n,i;c.fire("save");for(var v=u.length-1;v>=0;v--){k=u[v];k.deleteContents();d=!v&&a||a._4e_clone(true);b&&b(d);if(j)for(;(n=k.getCommonAncestor(false,true))&&(i=f[n._4e_name()])&&!(i&&i[p]);)if(n._4e_name()in f.span)k.splitElement(n);
else if(k.checkStartOfBlock()&&k.checkEndOfBlock()){k.setStartBefore(n);k.collapse(true);n._4e_remove()}else k.splitBlock();k.insertNode(d);h||(h=d)}a=h._4e_nextSourceNode(true);b=c.document;i=g.XHTML_DTD;if(i.$inline[d._4e_name()]){a=new m(b.createTextNode(" "));a.insertAfter(h)}else if(a){if(a._4e_name()=="br"&&i[a.parent()._4e_name()].p){i=new m("<p>&nbsp;</p>",null,b);a[0].parentNode.replaceChild(i[0],a[0]);a=i}}else{i=new m("<p>&nbsp;</p>",null,b);i.insertAfter(h);a=i}k.moveToPosition(h,l.POSITION_AFTER_END);
a&&a[0].nodeType==s.NODE_ELEMENT&&k.moveToElementEditablePosition(a);t.selectRanges([k]);c.focus();d&&d._4e_scrollIntoView();setTimeout(function(){c.fire("save")},10);return d},insertHtml:function(a){var b=this;if(b.htmlDataProcessor)a=b.htmlDataProcessor.toDataFormat(a);if(e.webkit){a=q.create(a,null,this.document);a=a.nodeType==11?o.makeArray(a.childNodes):[a];for(var c=0;c<a.length;c++)b.insertElement(new m(a[c]))}else{b.focus();b.fire("save");c=b.getSelection();if(e.ie){c=c.getNative();c.type==
"Control"&&c.clear();c.createRange().pasteHTML(a)}else b.document.execCommand("inserthtml",false,a);b.focus();setTimeout(function(){b.fire("save")},10)}}});g._initIFrame=function(a){function b(d){A(function(){f.designMode="on";setTimeout(function(){f.designMode="off";j.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){f.designMode="off";q.attr(j,"contentEditable",false);q.attr(j,"contentEditable",true);!d&&b(1)})}var c=w.getInstance(a);a=c.textarea[0];var p=c.iframe[0].contentWindow,
f=c.document,l=c.cfg,s=f.getElementById("ke_actscrpt");s.parentNode.removeChild(s);var j=f.body;if(e.ie){j.hideFocus=true;j.disabled=true;j.contentEditable=true;j.removeAttribute("disabled")}else setTimeout(function(){if(e.gecko||e.opera)j.contentEditable=true;else if(e.webkit)j.parentNode.contentEditable=true;else f.designMode="on"},0);if(e.webkit){r.on(f,"click",function(d){var h=new m(d.target);o.inArray(h._4e_name(),["input","select"])&&d.preventDefault()});r.on(f,"mouseup",function(d){var h=
new m(d.target);o.inArray(h._4e_name(),["input","textarea"])&&d.preventDefault()})}if(e.gecko||e.ie||e.opera){var t;t=new m(q.insertAfter((new m('<span style="position:absolute; left:-10000"></span>'))[0],a));t.on("focus",function(){c.focus()});c.on("destroy",function(){})}if(e.ie&&f.compatMode=="CSS1Compat"||e.gecko||e.opera){var u=new m(f.documentElement);u.on("mousedown",function(d){if(d.target===u[0]){e.gecko&&b(false);t[0].focus()}})}r.on(p,"focus",function(){if(e.gecko)b(false);else e.opera&&
j.focus();c.notifySelectionChange()});e.gecko&&r.on(c.document,"mousedown",function(){c.iframeFocus||b(false)});if(e.ie){r.on(f,"keydown",function(d){if(d.keyCode in{8:1,46:1}){var h=c.getSelection(),n=h.getSelectedElement();if(n){c.fire("save");var i=h.getRanges()[0].createBookmark();n._4e_remove();h.selectBookmarks([i]);c.fire("save");d.preventDefault()}}});if(f.compatMode=="CSS1Compat"){var k={33:1,34:1};r.on(f,"keydown",function(d){d.keyCode in k&&setTimeout(function(){c.getSelection().scrollIntoView()},
0)})}}setTimeout(function(){e.ie&&setTimeout(function(){if(f){j.runtimeStyle.marginBottom="0px";j.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.fire("dataReady");var d=l.disableObjectResizing,h=l.disableInlineTableEditing;if(d||h)try{f.execCommand("enableObjectResizing",false,!d);f.execCommand("enableInlineTableEditing",false,!h)}catch(n){r.on(j,e.ie?"resizestart":"resize",function(i){if(d||q._4e_name(i.target)==="table"&&h)i.preventDefault()})}},10);e.webkit&&r.on(f,"mousedown",
function(d){d=new m(d.target);o.inArray(d._4e_name(),["img","hr","input","textarea","select"])&&c.getSelection().selectElement(d)});w.add(c)};e.gecko&&function(){var a=document.body;if(a){var b=a.getAttribute("onpageshow");a.setAttribute("onpageshow",(b?b+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
