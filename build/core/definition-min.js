KISSY.Editor.add("definition",function(i){function x(a){return y+"<html><head><title>kissy-editor</title><link href='"+i.Config.base+z+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(a?'<script id="ke_actscrpt" type="text/javascript">'+(i.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':"")}var n=KISSY,d=n.UA,r=n.DOM,l=n.Node,s=n.Event,u=i.focusManager,A=i.Utils.tryThese,y="<!doctype html>",z=
i.Utils.debugUrl("theme/editor-iframe.css"),B=1,C="document.open();"+(i.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",D="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(d.ie?"javascript:void(function(){"+encodeURIComponent(C)+"}())":"")+'"  tabIndex="'+
(d.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";n.augment(i,{init:function(a){var b=this,c=new l(D.replace(/\$\(tabIndex\)/,a.attr("tabIndex")));c.on("mousedown",function(j){if(d.webkit){var p=r._4e_name(j.target);if(p=="select"||p=="option")return true}j.halt()});b.editorWrap=c;b._UUID=B++;u.register(b);b.wrap=c.one(".ke-textarea-wrap");b.iframe=b.wrap.one("iframe");b.toolBarDiv=c.one(".ke-editor-tools");b.textarea=
a;b.statusDiv=c.one(".ke-editor-status");b.toolBarDiv._4e_unselectable();b._commands={};b._plugins={};var o=a._4e_style("width"),e=a._4e_style("height");if(o){c.css("width",o);a.css("width","100%")}b.textarea.css("display","none");c.insertAfter(a);b.wrap[0].appendChild(a[0]);if(e){b.wrap.css("height",e);a.css("height","100%")}a=b.iframe;b.on("dataReady",function(){b.ready=true;i.fire("instanceCreated",{editor:b})});d.gecko?a.on("load",b._setUpIFrame,b):b._setUpIFrame()},addCommand:function(a,b){this._commands[a]=
b},execCommand:function(a){this.fire("save");this._commands[a].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(a){if(this.htmlDataProcessor)a=this.htmlDataProcessor.toDataFormat(a,"p");this.document.body.innerHTML=a},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(a){this.document.body.innerHTML=
a},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");d.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:x,getSelection:function(){var a=new i.Selection(this.document);return!a||a.isInvalid?null:a},focus:function(){var a=r._4e_getWin(this.document);d.webkit&&a&&a.parent&&a.parent.focus();a&&a.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){r._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function a(){j=e.document;b.document=j;c.detach();j.open("text/html","replace");j.write(o);j.close()}
var b=this,c=b.iframe,o=x(b._UUID),e=c[0].contentWindow,j;try{j=e.document}catch(p){c[0].src=c[0].src;if(d.ie&&d.ie<7){setTimeout(a,10);return}}a()},addPlugin:function(a){this.ready?a():this.on("dataReady",a)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){b=b.getStartElement();var c=new i.ElementPath(b);if(!a.previousPath||!a.previousPath.compare(c)){a.previousPath=c;a.fire("selectionChange",{selection:a,
path:c,element:b})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(a,b){var c=this;c.focus();var o=a._4e_name(),e=i.XHTML_DTD,j=i.RANGE,p=i.NODE,k=e.$block[o],v=c.getSelection(),w=v.getRanges(),h,m,q,f,g;c.fire("save");for(var t=w.length-1;t>=0;t--){h=w[t];h.deleteContents();m=!t&&a||a._4e_clone(true);b&&b(m);if(k)for(;(f=h.getCommonAncestor(false,true))&&(g=e[f._4e_name()])&&!(g&&g[o]);)if(f._4e_name()in e.span)h.splitElement(f);else if(h.checkStartOfBlock()&&
h.checkEndOfBlock()){h.setStartBefore(f);h.collapse(true);f._4e_remove()}else h.splitBlock();h.insertNode(m);q||(q=m)}a=q._4e_nextSourceNode(true);b=c.document;g=i.XHTML_DTD;if(g.$inline[m._4e_name()]){a=new l(b.createTextNode(" "));a.insertAfter(q)}else if(a){if(a._4e_name()=="br"&&g[a.parent()._4e_name()].p){g=new l("<p>&nbsp;</p>",null,b);a[0].parentNode.replaceChild(g[0],a[0]);a=g}}else{g=new l("<p>&nbsp;</p>",null,b);g.insertAfter(q);a=g}h.moveToPosition(q,j.POSITION_AFTER_END);a&&a[0].nodeType==
p.NODE_ELEMENT&&h.moveToElementEditablePosition(a);v.selectRanges([h]);c.focus();m&&m._4e_scrollIntoView();setTimeout(function(){c.fire("save")},10);return m},insertHtml:function(a){var b=this;if(b.htmlDataProcessor)a=b.htmlDataProcessor.toDataFormat(a);if(d.webkit){a=r.create(a,null,this.document);a=a.nodeType==11?n.makeArray(a.childNodes):[a];for(var c=0;c<a.length;c++)b.insertElement(new l(a[c]))}else{b.focus();b.fire("save");c=b.getSelection();if(d.ie){c=c.getNative();c.type=="Control"&&c.clear();
c.createRange().pasteHTML(a)}else b.document.execCommand("inserthtml",false,a);b.focus();setTimeout(function(){b.fire("save")},10)}}});i._initIFrame=function(a){function b(f){A(function(){e.designMode="on";setTimeout(function(){e.designMode="off";k.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){e.designMode="off";r.attr(k,"contentEditable",false);r.attr(k,"contentEditable",true);!f&&b(1)})}var c=u.getInstance(a);a=c.textarea[0];var o=c.iframe[0].contentWindow,e=c.document,
j=c.cfg,p=e.getElementById("ke_actscrpt");p.parentNode.removeChild(p);var k=e.body;if(d.ie){k.hideFocus=true;k.disabled=true;k.contentEditable=true;k.removeAttribute("disabled")}else setTimeout(function(){if(d.gecko||d.opera)k.contentEditable=true;else if(d.webkit)k.parentNode.contentEditable=true;else e.designMode="on"},0);try{e.execCommand("enableObjectResizing",false,!j.disableObjectResizing)}catch(v){}try{e.execCommand("enableInlineTableEditing",false,!j.disableInlineTableEditing)}catch(w){}d.webkit&&
s.on(e,"mousedown",function(f){f=new l(f.target);n.inArray(f._4e_name(),["img","hr","input","textarea","select"])&&c.getSelection().selectElement(f)});if(d.webkit){s.on(e,"click",function(f){var g=new l(f.target);n.inArray(g._4e_name(),["input","select"])&&f.preventDefault()});s.on(e,"mouseup",function(f){var g=new l(f.target);n.inArray(g._4e_name(),["input","textarea"])&&f.preventDefault()})}if(d.gecko||d.ie||d.opera){var h;h=new l(r.insertAfter((new l('<span style="position:absolute; left:-10000"></span>'))[0],
a));h.on("focus",function(){c.focus()});c.on("destroy",function(){})}if(d.ie&&e.compatMode=="CSS1Compat"||d.gecko||d.opera){var m=new l(e.documentElement);m.on("mousedown",function(f){if(f.target===m[0]){d.gecko&&b(false);h[0].focus()}})}s.on(o,"focus",function(){if(d.gecko)b(false);else d.opera&&k.focus();c.notifySelectionChange()});d.gecko&&s.on(c.document,"mousedown",function(){c.iframeFocus||b(false)});if(d.ie){s.on(e,"keydown",function(f){if(f.keyCode in{8:1,46:1}){var g=c.getSelection(),t=g.getSelectedElement();
if(t){c.fire("save");var E=g.getRanges()[0].createBookmark();t._4e_remove();g.selectBookmarks([E]);c.fire("save");f.preventDefault()}}});if(e.compatMode=="CSS1Compat"){var q={33:1,34:1};s.on(e,"keydown",function(f){f.keyCode in q&&setTimeout(function(){c.getSelection().scrollIntoView()},0)})}}setTimeout(function(){d.ie&&setTimeout(function(){if(e){k.runtimeStyle.marginBottom="0px";k.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.fire("dataReady")},10);u.add(c)};d.gecko&&function(){var a=
document.body;if(a){var b=a.getAttribute("onpageshow");a.setAttribute("onpageshow",(b?b+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
