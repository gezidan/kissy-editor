KISSY.Editor.add("domiterator",function(l){function t(r){if(!(arguments.length<1)){this.range=r;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var m=KISSY,x=m.UA,n=l.Walker,q=l.Range,i=l.RANGE,o=l.NODE,s=l.ElementPath,p=m.Node,u=m.DOM,y=/^[\r\n\t ]*$/,v=n.bookmark();m.augment(t,{getNextParagraph:function(r){var c,a,f,g,k;if(!this._.lastNode){a=this.range.clone();a.enlarge(this.forceBrBreak||!this.enlargeBr?i.ENLARGE_LIST_ITEM_CONTENTS:i.ENLARGE_BLOCK_CONTENTS);
var d=new n(a),b=n.bookmark(true,true);d.evaluator=b;this._.nextNode=d.next();d=new n(a);d.evaluator=b;d=d.previous();this._.lastNode=d._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==o.NODE_TEXT&&!m.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){b=new q(a.document);b.moveToPosition(this._.lastNode,i.POSITION_AFTER_END);if(b.checkEndOfBlock()){b=new s(b.endContainer);this._.lastNode=(b.block||b.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new p(a.document.createTextNode(""));u.insertAfter(this._.lastNode[0],d[0])}a=null}b=this._.nextNode;d=this._.lastNode;for(this._.nextNode=null;b;){var h=false,e=b[0].nodeType!=o.NODE_ELEMENT,w=false;if(e){if(b[0].nodeType==o.NODE_TEXT)if(y.test(b[0].nodeValue))e=false}else{var j=b._4e_name();if(b._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(j=="br")e=true;else if(!a&&!b[0].childNodes.length&&j!="hr"){c=b;f=b._4e_equals(d);break}if(a){a.setEndAt(b,i.POSITION_BEFORE_START);
if(j!="br")this._.nextNode=b}h=true}else{if(b[0].firstChild){if(!a){a=new q(this.range.document);a.setStartAt(b,i.POSITION_BEFORE_START)}b=new p(b[0].firstChild);continue}e=true}}if(e&&!a){a=new q(this.range.document);a.setStartAt(b,i.POSITION_BEFORE_START)}f=(!h||e)&&b._4e_equals(d);if(a&&!h)for(;!b[0].nextSibling&&!f;){j=b.parent();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){h=true;f||j._4e_equals(d);break}b=j;e=true;f=b._4e_equals(d);w=true}e&&a.setEndAt(b,i.POSITION_AFTER_END);b=b._4e_nextSourceNode(w,
null,d);f=!b;if((h||f)&&a){e=a.getBoundaryNodes();h=new s(a.startContainer);if(e.startNode.parent()._4e_equals(h.blockLimit)&&v(e.startNode)&&v(e.endNode)){a=null;this._.nextNode=null}else break}if(f)break}if(!c){if(!a){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}h=new s(a.startContainer);b=h.blockLimit;e={div:1,th:1,td:1};c=h.block;if((!c||!c[0])&&!this.enforceRealBlocks&&e[b._4e_name()]&&a.checkStartOfBlock()&&a.checkEndOfBlock())c=b;else if(!c||this.enforceRealBlocks&&
c._4e_name()=="li"){c=new p(this.range.document.createElement(r||"p"));c[0].appendChild(a.extractContents());c._4e_trim();a.insertNode(c);g=k=true}else if(c._4e_name()!="li"){if(!a.checkStartOfBlock()||!a.checkEndOfBlock()){c=c._4e_clone(false);c[0].appendChild(a.extractContents());c._4e_trim();k=a.splitBlock();g=!k.wasStartOfBlock;k=!k.wasEndOfBlock;a.insertNode(c)}}else if(!f)this._.nextNode=c._4e_equals(d)?null:a.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,d)}if(g){a=new p(c[0].previousSibling);
if(a[0]&&a[0].nodeType==o.NODE_ELEMENT)if(a._4e_name()=="br")a._4e_remove();else a[0].lastChild&&a[0].lastChild.nodeName.toLowerCase()=="br"&&u._4e_remove(a[0].lastChild)}if(k){a=n.bookmark(false,true);g=new p(c[0].lastChild);if(g[0]&&g[0].nodeType==o.NODE_ELEMENT&&g._4e_name()=="br")if(x.ie||g._4e_previous(a)||g._4e_next(a))g._4e_remove()}if(!this._.nextNode)this._.nextNode=f||c._4e_equals(d)?null:c._4e_nextSourceNode(true,null,d);return c}});q.prototype.createIterator=function(){return new t(this)}});
