KISSY.Editor.add("domiterator",function(l){function t(r){if(!(arguments.length<1)){this.range=r;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var m=KISSY,w=m.UA,n=l.Walker,q=l.Range,f=l.RANGE,o=l.NODE,u=l.ElementPath,p=m.Node,s=m.DOM,x=/^[\r\n\t ]*$/;n.bookmark();m.augment(t,{getNextParagraph:function(r){var c,a,g,e,k;if(!this._.lastNode){a=this.range.clone();a.shrink(f.SHRINK_ELEMENT,true);a.enlarge(this.forceBrBreak||!this.enlargeBr?f.ENLARGE_LIST_ITEM_CONTENTS:
f.ENLARGE_BLOCK_CONTENTS);var d=new n(a),b=n.bookmark(true,true);d.evaluator=b;this._.nextNode=d.next();d=new n(a);d.evaluator=b;d=d.previous();this._.lastNode=d._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==o.NODE_TEXT&&!m.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){b=new q(a.document);b.moveToPosition(this._.lastNode,f.POSITION_AFTER_END);if(b.checkEndOfBlock()){b=new u(b.endContainer);this._.lastNode=(b.block||b.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new p(a.document.createTextNode(""));s.insertAfter(this._.lastNode[0],d[0])}a=null}b=this._.nextNode;d=this._.lastNode;for(this._.nextNode=null;b;){var i=false,h=b[0].nodeType!=o.NODE_ELEMENT,v=false;if(h){if(b[0].nodeType==o.NODE_TEXT)if(x.test(b[0].nodeValue))h=false}else{var j=b._4e_name();if(b._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(j=="br")h=true;else if(!a&&!b[0].childNodes.length&&j!="hr"){c=b;g=b._4e_equals(d);break}if(a){a.setEndAt(b,f.POSITION_BEFORE_START);
if(j!="br")this._.nextNode=b}i=true}else{if(b[0].firstChild){if(!a){a=new q(this.range.document);a.setStartAt(b,f.POSITION_BEFORE_START)}b=new p(b[0].firstChild);continue}h=true}}if(h&&!a){a=new q(this.range.document);a.setStartAt(b,f.POSITION_BEFORE_START)}g=(!i||h)&&b._4e_equals(d);if(a&&!i)for(;!b[0].nextSibling&&!g;){j=b.parent();if(j._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){i=true;g||j._4e_equals(d);break}b=j;h=true;g=b._4e_equals(d);v=true}h&&a.setEndAt(b,f.POSITION_AFTER_END);b=b._4e_nextSourceNode(v,
null,d);if((g=!b)||i&&a)break}if(!c){if(!a){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}c=new u(a.startContainer);b=c.blockLimit;i={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&i[b._4e_name()]&&a.checkStartOfBlock()&&a.checkEndOfBlock())c=b;else if(!c||this.enforceRealBlocks&&c._4e_name()=="li"){c=new p(this.range.document.createElement(r||"p"));c[0].appendChild(a.extractContents());c._4e_trim();a.insertNode(c);e=k=true}else if(c._4e_name()!=
"li"){if(!a.checkStartOfBlock()||!a.checkEndOfBlock()){c=c._4e_clone(false);c[0].appendChild(a.extractContents());c._4e_trim();k=a.splitBlock();e=!k.wasStartOfBlock;k=!k.wasEndOfBlock;a.insertNode(c)}}else if(!g)this._.nextNode=c._4e_equals(d)?null:a.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,d)}if(e){a=new p(c[0].previousSibling);if(a[0]&&a[0].nodeType==o.NODE_ELEMENT)if(a._4e_name()=="br")a._4e_remove();else a[0].lastChild&&s._4e_name(a[0].lastChild)=="br"&&s._4e_remove(a[0].lastChild)}if(k){a=
n.bookmark(false,true);e=new p(c[0].lastChild);if(e[0]&&e[0].nodeType==o.NODE_ELEMENT&&e._4e_name()=="br")if(w.ie||e._4e_previous(a)||e._4e_next(a))e._4e_remove()}if(!this._.nextNode)this._.nextNode=g||c._4e_equals(d)?null:c._4e_nextSourceNode(true,null,d);return c}});q.prototype.createIterator=function(){return new t(this)}});
