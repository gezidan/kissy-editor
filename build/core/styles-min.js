KISSY.Editor.add("styles",function(o){function O(a,e){for(var b in a)a[b]=a[b].replace(X,function(c,d){return e[d]})}function A(a,e){if(e){a=w.clone(a);O(a.attributes,e);O(a.styles,e)}var b=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type=b=="#"||Y[b]?q.STYLE_BLOCK:P[b]?q.STYLE_OBJECT:q.STYLE_INLINE;this._={definition:a}}function Q(a,e){var b=e?this.removeFromRange:this.applyToRange;a.body.focus();for(var c=new Z(a),d=c.getRanges(),g=0;g<d.length;g++)b.call(this,d[g]);
c.selectRanges(d)}function I(a,e){var b;b=a.element;if(b=="*")b="span";b=new B(e.createElement(b));return R(b,a)}function R(a,e){var b=e._.definition,c=b.attributes;b=A.getStyleText(b);if(c)for(var d in c)a.attr(d,c[d]);if(b)a[0].style.cssText=b;return a}function $(a){var e=a.createBookmark(k),b=a.createIterator();b.enforceRealBlocks=k;b.enlargeBr=k;for(var c,d=a.document;c=b.getNextParagraph();){var g=I(this,d);c=c;var f=g;g=f._4e_name=="pre";var h=c._4e_name=="pre",m=!g&&h;if(g&&!h){h=c;f=f;m=h.html();
m=C(m,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");m=m.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");m=m.replace(/([ \t\n\r]+|&nbsp;)/g," ");m=m.replace(/<br\b[^>]*>/gi,"\n");if(J.ie){h=h[0].ownerDocument.createElement("div");h.appendChild(f[0]);f[0].outerHTML="<pre>"+m+"</pre>";f=new B(h.firstChild);f._4e_remove()}else f.html(m);f=f}else if(m)f=aa(ba(c),f);else c._4e_moveChildren(f);c[0].parentNode.replaceChild(f[0],c[0]);if(g){c=f;g=void 0;if((g=c._4e_previousSourceNode(k,y.NODE_ELEMENT))&&g._4e_name()==
"pre"){f=C(g.html(),/\n$/,"")+"\n\n"+C(c.html(),/^\n/,"");if(J.ie)c[0].outerHTML="<pre>"+f+"</pre>";else c.html(f);g._4e_remove()}}}a.moveToBookmark(e)}function C(a,e,b){var c="",d="";a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(g,f,h){f&&(c=f);h&&(d=h);return""});return c+a.replace(e,b)+d}function ba(a){var e=[];C(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(b,c,d){return c+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(b,c){e.push(c)});return e}function aa(a,e){for(var b=e[0].ownerDocument.createDocumentFragment(),c=0;c<a.length;c++){var d=a[c];d=d.replace(/(\r\n|\r)/g,"\n");d=C(d,/^[ \t]*\n/,"");d=C(d,/\n$/,"");d=C(d,/^[ \t]+|[ \t]+$/g,function(f,h){return f.length==1?"&nbsp;":h?" "+Array(f.length).join("&nbsp;"):Array(f.length).join("&nbsp;")+" "});d=d.replace(/\n/g,"<br>");d=d.replace(/[ \t]{2,}/g,function(f){return Array(f.length).join("&nbsp;")+" "});var g=e._4e_clone();g.html(d);b.appendChild(g[0])}return b}
function ca(a){var e=a.document;if(a.collapsed){e=I(this,e);a.insertNode(e);a.moveToPosition(e,E.POSITION_BEFORE_END)}else{var b=this.element,c=this._.definition,d,g=o.XHTML_DTD[b]||(d=k,o.XHTML_DTD.span),f=a.createBookmark();a.enlarge(E.ENLARGE_ELEMENT);a.trim();var h=a.createBookmark(),m=h.startNode;h=h.endNode;for(var l=m,r;l&&l[0];){var i=x;if(D._4e_equals(l,h)){l=v;i=k}else{var j=l[0].nodeType,u=j==y.NODE_ELEMENT?l._4e_name():v;if(u&&l.attr("_ke_bookmark")){l=l._4e_nextSourceNode(k);continue}if(!u||
g[u]&&(l._4e_position(h)|n.POSITION_PRECEDING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_PRECEDING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(l))){var p=l.parent();if(p&&p[0]&&((o.XHTML_DTD[p._4e_name()]||o.XHTML_DTD.span)[b]||d)&&(!c.parentRule||c.parentRule(p))){if(!r&&(!u||!o.XHTML_DTD.$removeEmpty[u]||(l._4e_position(h)|n.POSITION_PRECEDING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_PRECEDING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED)){r=
new da(e);r.setStartBefore(l)}if(j==y.NODE_TEXT||j==y.NODE_ELEMENT&&!l[0].childNodes.length){j=l;for(var s;!j[0].nextSibling&&(s=j.parent(),g[s._4e_name()])&&(s._4e_position(m)|n.POSITION_FOLLOWING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_FOLLOWING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(s));)j=s;r.setEndAfter(j);j[0].nextSibling||(i=k)}}else i=k}else i=k;l=l._4e_nextSourceNode()}if(i&&r&&!r.collapsed){i=I(this,e);for(j=r.getCommonAncestor();i&&j&&
i[0]&&j[0];){if(j._4e_name()==b){for(var t in c.attributes)i.attr(t)==j.attr(t)&&i[0].removeAttribute(t);for(var K in c.styles)i._4e_style(K)==j._4e_style(K)&&i._4e_style(K,"");if(!i._4e_hasAttributes()){i=v;break}}j=j.parent()}if(i){i[0].appendChild(r.extractContents());j=i;u=G(this);p=j.all(this.element);for(var F=p.length;--F>=0;)L(this,new B(p[F]));var H=void 0;for(H in u)if(H!=this.element){p=j.all(H);for(F=p.length-1;F>=0;F--){var ea=new B(p[F]);M(ea,u[H])}}r.insertNode(i);i._4e_mergeSiblings();
J.ie||i[0].normalize()}r=v}}m._4e_remove();h._4e_remove();a.moveToBookmark(f);a.shrink(E.SHRINK_TEXT)}}function fa(a){a.enlarge(E.ENLARGE_ELEMENT);var e=a.createBookmark(),b=e.startNode;if(a.collapsed){for(var c=new N(b.parent()),d,g=0,f;g<c.elements.length&&(f=c.elements[g]);g++){if(f==c.block||f==c.blockLimit)break;if(this.checkElementRemovable(f)){var h=a.checkBoundaryOfElement(f,E.END),m=!h&&a.checkBoundaryOfElement(f,E.START);if(m||h){d=f;d.match=m?"start":"end"}else{f._4e_mergeSiblings();f._4e_name()==
this.element?L(this,f):M(f,G(this)[f._4e_name()])}}}if(d&&d[0]){f=b;for(g=0;;g++){h=c.elements[g];if(D._4e_equals(h,d))break;else if(h.match)continue;else h=h._4e_clone();h[0].appendChild(f[0]);f=h}D[d.match=="start"?"insertBefore":"insertAfter"](f[0],d[0])}}else{var l=e.endNode,r=this;c=function(){for(var i=new N(b.parent()),j=new N(l.parent()),u=v,p=v,s=0;s<i.elements.length;s++){var t=i.elements[s];if(t==i.block||t==i.blockLimit)break;if(r.checkElementRemovable(t))u=t}for(s=0;s<j.elements.length;s++){t=
j.elements[s];if(t==j.block||t==j.blockLimit)break;if(r.checkElementRemovable(t))p=t}p&&l._4e_breakParent(p);u&&b._4e_breakParent(u)};c();for(d=new B(b[0].nextSibling);d[0]!==l[0];){g=d._4e_nextSourceNode();if(d[0]&&d[0].nodeType==y.NODE_ELEMENT&&this.checkElementRemovable(d)){d._4e_name()==this.element?L(this,d):M(d,G(this)[d._4e_name()]);if(g[0].nodeType==y.NODE_ELEMENT&&g._4e_contains(b)){c();g=new B(b[0].nextSibling)}}d=g}}a.moveToBookmark(e)}function S(a){var e={};a.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,
function(b,c,d){e[c]=d});return e}function T(a,e){var b;if(e!==x){b=document.createElement("span");b.style.cssText=a;b=b.style.cssText||""}else b=a;return b.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function G(a){if(a._.overrides)return a._.overrides;var e=a._.overrides={},b=a._.definition.overrides;if(b){w.isArray(b)||(b=[b]);for(var c=0;c<b.length;c++){var d=b[c],g,f;if(typeof d=="string")g=d.toLowerCase();else{g=d.element?d.element.toLowerCase():
a.element;f=d.attributes}d=e[g]||(e[g]={});if(f){d=d.attributes=d.attributes||[];for(var h in f)d.push([h.toLowerCase(),f[h]])}}}return e}function L(a,e){var b=a._.definition,c=w.mix(w.mix({},b.attributes),G(a)[e._4e_name()]);b=b.styles;var d=w.isEmptyObject(c)&&w.isEmptyObject(b),g;for(g in c)if(!((g=="class"||a._.definition.fullMatch)&&e.attr(g)!=U(g,c[g]))){d=d||!!e._4e_hasAttribute(g);e.removeAttr(g)}for(var f in b)if(!(a._.definition.fullMatch&&e._4e_style(f)!=U(f,b[f],k))){d=d||!!e._4e_style(f);
e._4e_style(f,"")}d&&V(e)}function U(a,e,b){var c=new B("<span>");c[b?"_4e_style":"attr"](a,e);return c[b?"_4e_style":"attr"](a)}function M(a,e){var b=e&&e.attributes;if(b)for(var c=0;c<b.length;c++){var d=b[c][0],g;if(g=a.attr(d)){var f=b[c][1];if(f===v||f.test&&f.test(g)||typeof f=="string"&&g==f)a[0].removeAttribute(d)}}V(a)}function V(a){if(!a._4e_hasAttributes()){var e=a[0].firstChild,b=a[0].lastChild;a._4e_remove(k);if(e){e.nodeType==y.NODE_ELEMENT&&D._4e_mergeSiblings(e);b&&!e===b&&b.nodeType==
y.NODE_ELEMENT&&D._4e_mergeSiblings(b)}}}var k=true,x=false,v=null,w=KISSY,D=w.DOM,q={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},E=o.RANGE,Z=o.Selection,y=o.NODE,n=o.POSITION,da=o.Range,B=w.Node,J=w.UA,N=o.ElementPath,Y={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},W=/\s*(?:;\s*|$)/,X=/#\((.+?)\)/g;o.STYLE=q;A.prototype={apply:function(a){Q.call(this,a,x)},remove:function(a){Q.call(this,a,k)},
applyToRange:function(a){return(this.applyToRange=this.type==q.STYLE_INLINE?ca:this.type==q.STYLE_BLOCK?$:this.type==q.STYLE_OBJECT?v:v).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==q.STYLE_INLINE?fa:v).call(this,a)},applyToObject:function(a){R(a,this)},checkElementRemovable:function(a,e){if(!a)return x;var b=this._.definition;if(a._4e_name()==this.element){if(!e&&!a._4e_hasAttributes())return k;var c=b._AC;if(c)b=c;else{c={};var d=0,g=b.attributes;if(g)for(var f in g){d++;
c[f]=g[f]}if(g=A.getStyleText(b)){c.style||d++;c.style=g}c._length=d;b=b._AC=c}if(b._length){for(var h in b)if(h!="_length"){d=a.attr(h)||"";if(h=="style")a:{c=b[h];d=T(d,x);typeof c=="string"&&(c=S(c));typeof d=="string"&&(d=S(d));g=void 0;for(g in c)if(!(g in d&&(d[g]==c[g]||c[g]=="inherit"||d[g]=="inherit"))){c=x;break a}c=k}else c=b[h]==d;if(c){if(!e)return k}else if(e)return x}if(e)return k}else return k}if(h=G(this)[a._4e_name()]){if(!(b=h.attributes))return k;for(c=0;c<b.length;c++){h=b[c][0];
if(h=a.attr(h)){d=b[c][1];if(d===v||typeof d=="string"&&h==d||d.test&&d.test(h))return k}}}return x},checkActive:function(a){switch(this.type){case q.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,k);case q.STYLE_OBJECT:case q.STYLE_INLINE:for(var e=a.elements,b=0,c;b<e.length;b++){c=e[b];if(!(this.type==q.STYLE_INLINE&&(D._4e_equals(c,a.block)||D._4e_equals(c,a.blockLimit))))if(!(this.type==q.STYLE_OBJECT&&!(c._4e_name()in P)))if(this.checkElementRemovable(c,k))return k}}return x}};
A.getStyleText=function(a){var e=a._ST;if(e)return e;e=a.styles;var b=a.attributes&&a.attributes.style||"",c="";if(b.length)b=b.replace(W,";");for(var d in e){var g=e[d],f=(d+":"+g).replace(W,";");if(g=="inherit")c+=f;else b+=f}if(b.length)b=T(b);b+=c;return a._ST=b};o.Style=A;o.Style=A;var z=A.prototype;o.Utils.extern(z,{apply:z.apply,remove:z.remove,applyToRange:z.applyToRange,removeFromRange:z.removeFromRange,applyToObject:z.applyToObject,checkElementRemovable:z.checkElementRemovable,checkActive:z.checkActive})});
