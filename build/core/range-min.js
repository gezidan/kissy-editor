KISSY.Editor.add("range",function(t){function z(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=a}function I(a){var b=a[0].nodeType!=h.NODE_TEXT&&a._4e_name()in A.$removeEmpty,c=!r.trim(a[0].nodeValue);a=!!a.parent().attr("_ke_bookmark");return b||c||a}function E(a){return!J(a)&&!K(a)}function F(a){var b=false,c=u.bookmark(true);return function(e){if(c(e))return true;if(e[0].nodeType==h.NODE_TEXT){if(r.trim(e[0].nodeValue).length)return false}else if(e[0].nodeType==
h.NODE_ELEMENT)if(!L[e._4e_name()])if(!a&&!C.ie&&e._4e_name()=="br"&&!b)b=true;else return false;return true}}function M(a,b){function c(e){return e&&e.nodeName=="span"&&e.getAttribute("_ke_bookmark")}return function(e){var d,f;d=e&&!e.nodeName&&(f=e.parentNode)&&c(f);d=a?d:d||c(e);return b^d}}function N(a){return function(b){b=(b=b[0]||b)&&b.nodeType==h.NODE_TEXT&&!r.trim(b.nodeValue);return a^b}}t.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var r=KISSY,h=t.NODE,i=t.RANGE,O=t.POSITION,u=t.Walker,s=r.DOM,G=t.Utils.getByAddress,C=r.UA,A=t.XHTML_DTD,w=t.ElementPath,n=r.Node,H={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};z.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};r.augment(z,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&s._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,b=this.startOffset;if(a[0].nodeType!=h.NODE_ELEMENT)if(b)b>=a[0].nodeValue.length&&this.setStartAfter(a);else this.setStartBefore(a);a=this.endContainer;b=this.endOffset;if(a[0].nodeType!=h.NODE_ELEMENT)if(b)b>=a[0].nodeValue.length&&
this.setEndAfter(a);else this.setEndBefore(a)},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&a._4e_name()=="span"&&a.attr("_ke_bookmark")&&this.setStartAt(a,i.POSITION_BEFORE_START);b&&b._4e_name()=="span"&&
b.attr("_ke_bookmark")&&this.setEndAt(b,i.POSITION_AFTER_END)},setStart:function(a,b){if(a[0].nodeType==h.NODE_ELEMENT&&H[a._4e_name()]){a=a.parent();b=a._4e_index()}this.startContainer=a;this.startOffset=b;if(!this.endContainer){this.endContainer=a;this.endOffset=b}this.updateCollapsed()},setEnd:function(a,b){if(a[0].nodeType==h.NODE_ELEMENT&&H[a._4e_name()]){a=a.parent();b=a._4e_index()+1}this.endContainer=a;this.endOffset=b;if(!this.startContainer){this.startContainer=a;this.startOffset=b}this.updateCollapsed()},
setStartAt:function(a,b){switch(b){case i.POSITION_AFTER_START:this.setStart(a,0);break;case i.POSITION_BEFORE_END:a[0].nodeType==h.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setStartBefore(a);break;case i.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,b){switch(b){case i.POSITION_AFTER_START:this.setEnd(a,0);break;case i.POSITION_BEFORE_END:a[0].nodeType==h.NODE_TEXT?this.setEnd(a,
a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setEndBefore(a);break;case i.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},execContentsAction:function(a,b){var c=this.startContainer,e=this.endContainer,d=this.startOffset,f=this.endOffset,l,o;this.optimizeBookmark();if(e[0].nodeType==h.NODE_TEXT)e=e._4e_splitText(f);else if(e[0].childNodes.length>0)if(f>=e[0].childNodes.length){e=new n(e[0].appendChild(this.document.createTextNode("")));
o=true}else e=new n(e[0].childNodes[f]);if(c[0].nodeType==h.NODE_TEXT){c._4e_splitText(d);if(s._4e_equals(c,e))e=new n(c[0].nextSibling)}else if(d)if(d>=c[0].childNodes.length){l=new n(this.document.createTextNode(""));c[0].appendChild(l[0]);c=l;l=true}else c=new n(c[0].childNodes[d].previousSibling);else{l=new n(this.document.createTextNode(""));s.insertBefore(l[0],c[0].firstChild);c=l;l=true}d=c._4e_parents();f=e._4e_parents();var g,m,j;for(g=0;g<d.length;g++){m=d[g];j=f[g];if(m[0]!==j[0])break}for(var p=
b,k,q,v,x=g;x<d.length;x++){k=d[x];if(p&&k[0]!==c[0])q=p.appendChild(k._4e_clone()[0]);for(k=k[0].nextSibling;k;){if(f[x]&&k==f[x][0]||k==e[0])break;v=k.nextSibling;if(a==2)p.appendChild(k.cloneNode(true));else{k.parentNode.removeChild(k);a==1&&p.appendChild(k)}k=v}if(q)p=q}p=b;for(g=g;g<f.length;g++){k=f[g];if(a>0&&k[0]!==e[0])q=p.appendChild(k._4e_clone()[0]);if(!d[g]||k[0].parentNode!==d[g][0].parentNode)for(k=k[0].previousSibling;k;){if(d[g]&&k==d[g][0]||k===c[0])break;v=k.previousSibling;if(a==
2)p.insertBefore(k.cloneNode(true),p.firstChild);else{k.parentNode.removeChild(k);a==1&&p.insertBefore(k,p.firstChild)}k=v}if(q)p=q}if(a==2){j=this.startContainer[0];if(j.nodeType==h.NODE_TEXT&&j.nextSibling&&j.nextSibling.nodeType==h.NODE_TEXT){j.data+=j.nextSibling.data;j.parentNode.removeChild(j.nextSibling)}j=this.endContainer[0];if(j.nodeType==h.NODE_TEXT&&j.nextSibling&&j.nextSibling.nodeType==h.NODE_TEXT){j.data+=j.nextSibling.data;j.parentNode.removeChild(j.nextSibling)}}else{if(m&&j&&(c[0].parentNode!=
m[0].parentNode||e[0].parentNode!=j[0].parentNode)){m=j._4e_index();l&&j[0].parentNode==c[0].parentNode&&m--;this.setStart(j.parent(),m)}this.collapse(true)}l&&c._4e_remove();o&&e[0].parentNode&&e._4e_remove()},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var a=new z(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;
a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=h.NODE_ELEMENT||a.endContainer[0].nodeType!=h.NODE_ELEMENT)return null;var b=new t.Walker(a),c=M(true,undefined),e=N(true);a.evaluator=function(d){return e(d)&&c(d)};a=b.next();b.reset();b=b.previous();return a&&a._4e_equals(b)?a:null},shrink:function(a,b){if(!this.collapsed){a=a||i.SHRINK_TEXT;var c=this.clone(),
e=this.startContainer,d=this.endContainer,f=this.startOffset,l=this.endOffset,o=1,g=1;if(e&&e[0].nodeType==h.NODE_TEXT)if(f)if(f>=e[0].nodeValue.length)c.setStartAfter(e);else{c.setStartBefore(e);o=0}else c.setStartBefore(e);if(d&&d[0].nodeType==h.NODE_TEXT)if(l)if(l>=d[0].nodeValue.length)c.setEndAfter(d);else{c.setEndAfter(d);g=0}else c.setEndBefore(d);c=new u(c);c.evaluator=function(j){j=j[0]||j;return j.nodeType==(a==i.SHRINK_ELEMENT?h.NODE_ELEMENT:h.NODE_TEXT)};var m;c.guard=function(j,p){j=
j[0]||j;if(a==i.SHRINK_ELEMENT&&j.nodeType==h.NODE_TEXT)return false;if(p&&j==m)return false;if(!p&&j.nodeType==h.NODE_ELEMENT)m=j;return true};if(o)(e=c[a==i.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(e,b?i.POSITION_AFTER_START:i.POSITION_BEFORE_START);if(g){c.reset();(c=c[a==i.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(c,b?i.POSITION_BEFORE_END:i.POSITION_AFTER_END)}return!!(o||g)}},getTouchedStartNode:function(){var a=this.startContainer;if(this.collapsed||a[0].nodeType!=
h.NODE_ELEMENT)return a;return a.childNodes[this.startOffset]||a},createBookmark2:function(a){var b=this.startContainer,c=this.endContainer,e=this.startOffset,d=this.endOffset,f,l;if(!b||!c)return{start:0,end:0};if(a){if(b[0].nodeType==h.NODE_ELEMENT)if((f=new n(b[0].childNodes[e]))&&f[0]&&f[0].nodeType==h.NODE_TEXT&&e>0&&f[0].previousSibling.nodeType==h.NODE_TEXT){b=f;e=0}for(;b[0].nodeType==h.NODE_TEXT&&(l=b._4e_previous())&&l[0].nodeType==h.NODE_TEXT;){b=l;e+=l[0].nodeValue.length}if(!this.collapsed){if(c[0].nodeType==
h.NODE_ELEMENT)if((f=new n(c[0].childNodes[d]))&&f[0]&&f[0].nodeType==h.NODE_TEXT&&d>0&&f[0].previousSibling.nodeType==h.NODE_TEXT){c=f;d=0}for(;c[0].nodeType==h.NODE_TEXT&&(l=c._4e_previous())&&l[0].nodeType==h.NODE_TEXT;){c=l;d+=l[0].nodeValue.length}}}return{start:b._4e_address(a),end:this.collapsed?null:c._4e_address(a),startOffset:e,endOffset:d,normalized:a,is2:true}},createBookmark:function(a){var b,c,e,d;b=new n("<span></span>",null,this.document);b.attr("_ke_bookmark",1);b.css("display","none");
b.html("&nbsp;");if(a){e=r.guid("ke_bm_");b.attr("id",e+"S")}if(!this.collapsed){c=b._4e_clone();c.html("&nbsp;");a&&c.attr("id",e+"E");d=this.clone();d.collapse();d.insertNode(c)}d=this.clone();d.collapse(true);d.insertNode(b);if(c){this.setStartAfter(b);this.setEndBefore(c)}else this.moveToPosition(b,i.POSITION_AFTER_END);return{startNode:a?e+"S":b,endNode:a?e+"E":c,serializable:a}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(true)},trim:function(a,b){var c=this.startContainer,
e=this.startOffset,d=this.collapsed;if((!a||d)&&c[0]&&c[0].nodeType==h.NODE_TEXT){if(e)if(e>=c[0].nodeValue.length){e=c._4e_index()+1;c=c.parent()}else{var f=c._4e_splitText(e);e=c._4e_index()+1;c=c.parent();if(s._4e_equals(this.startContainer,this.endContainer))this.setEnd(f,this.endOffset-this.startOffset);else if(s._4e_equals(c,this.endContainer))this.endOffset+=1}else{e=c._4e_index();c=c.parent()}this.setStart(c,e);if(d){this.collapse(true);return}}c=this.endContainer;e=this.endOffset;if(!(b||
d)&&c[0]&&c[0].nodeType==h.NODE_TEXT){if(e){e>=c.nodeValue.length||c._4e_splitText(e);e=c._4e_index()+1}else e=c._4e_index();c=c.parent();this.setEnd(c,e)}},insertNode:function(a){this.optimizeBookmark();this.trim(false,true);var b=this.startContainer,c=b[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);c?s.insertBefore(a[0]||a,c):b[0].appendChild(a[0]||a);s._4e_equals(a.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){if(a.is2){var b=
G(this.document,a.start,a.normalized),c=a.startOffset,e=a.end&&G(this.document,a.end,a.normalized);a=a.endOffset;this.setStart(b,c);e?this.setEnd(e,a):this.collapse(true)}else{b=(c=a.serializable)?r.one("#"+a.startNode,this.document):a.startNode;a=c?r.one("#"+a.endNode,this.document):a.endNode;this.setStartBefore(b);b._4e_remove();if(a&&a[0]){this.setEndBefore(a);a._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(a,b){var c=this.startContainer,e=this.endContainer;c=s._4e_equals(c,
e)?a&&c[0].nodeType==h.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new n(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(e);return b&&c[0].nodeType==h.NODE_TEXT?c.parent():c},enlarge:function(a){switch(a){case i.ENLARGE_ELEMENT:if(this.collapsed)break;a=this.getCommonAncestor();var b=new n(this.document.body),c,e,d,f,l,o=false,g,m;g=this.startContainer;m=this.startOffset;if(g[0].nodeType==h.NODE_TEXT){if(m){g=!r.trim(g[0].nodeValue.substring(0,m)).length&&g;o=!!g}if(g)if(!(f=g[0].previousSibling))d=
g.parent()}else{if(m)f=g[0].childNodes[m-1]||g[0].lastChild;f||(d=g)}for(;d||f;){if(d&&!f){if(!l&&s._4e_equals(d,a))l=true;if(!b._4e_contains(d))break;if(!o||d.css("display")!="inline"){o=false;if(l)c=d;else this.setStartBefore(d)}f=d[0].previousSibling}for(;f;){g=false;if(f.nodeType==h.NODE_TEXT){m=f.nodeValue;if(/[^\s\ufeff]/.test(m))f=null;g=/[\s\ufeff]$/.test(m)}else if(f.offsetWidth>0&&!f.getAttribute("_ke_bookmark"))if(o&&A.$removeEmpty[f.nodeName.toLowerCase()]){m=s.text(f);if(/[^\s\ufeff]/.test(m))f=
null;else for(var j=f.all||f.getElementsByTagName("*"),p=0,k;k=j[p++];)if(!A.$removeEmpty[k.nodeName.toLowerCase()]){f=null;break}if(f)g=!!m.length}else f=null;if(g)if(o)if(l)c=d;else d&&this.setStartBefore(d);else o=true;if(f){g=f.previousSibling;if(!d&&!g){d=new n(f);f=null;break}f=g}else d=null}if(d)d=d.parent()}g=this.endContainer;m=this.endOffset;d=f=null;l=o=false;if(g[0].nodeType==h.NODE_TEXT){g=!r.trim(g[0].nodeValue.substring(m)).length&&g;o=!(g&&g[0].nodeValue.length);if(g)if(!(f=g[0].nextSibling))d=
g.parent()}else(f=g[0].childNodes[m])||(d=g);for(;d||f;){if(d&&!f){if(!l&&s._4e_equals(d,a))l=true;if(!b._4e_contains(d))break;if(!o||d.css("display")!="inline"){o=false;if(l)e=d;else d&&this.setEndAfter(d)}f=d[0].nextSibling}for(;f;){g=false;if(f.nodeType==h.NODE_TEXT){m=f.nodeValue;if(/[^\s\ufeff]/.test(m))f=null;g=/^[\s\ufeff]/.test(m)}else if(f.offsetWidth>0&&!f.getAttribute("_ke_bookmark"))if(o&&A.$removeEmpty[f.nodeName.toLowerCase()]){m=s.text(f);if(/[^\s\ufeff]/.test(m))f=null;else{j=f.all||
f.getElementsByTagName("*");for(p=0;k=j[p++];)if(!A.$removeEmpty[k.nodeName.toLowerCase()]){f=null;break}}if(f)g=!!m.length}else f=null;if(g)if(o)if(l)e=d;else this.setEndAfter(d);if(f){g=f.nextSibling;if(!d&&!g){d=new n(f);f=null;break}f=g}else d=null}if(d)d=d.parent()}if(c&&e){a=c._4e_contains(e)?e:c;this.setStartBefore(a);this.setEndAfter(a)}break;case i.ENLARGE_BLOCK_CONTENTS:case i.ENLARGE_LIST_ITEM_CONTENTS:d=new z(this.document);b=new n(this.document.body);d.setStartAt(b,i.POSITION_AFTER_START);
d.setEnd(this.startContainer,this.startOffset);d=new u(d);var q,v,x=u.blockBoundary(a==i.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),D=function(y){var B=x(y);B||(q=y);return B};c=function(y){var B=D(y);if(!B&&y[0]&&y._4e_name()=="br")v=y;return B};d.guard=D;d=d.lastBackward();q=q||b;this.setStartAt(q,q._4e_name()!="br"&&(!d&&this.checkStartOfBlock()||d&&q._4e_contains(d))?i.POSITION_AFTER_START:i.POSITION_AFTER_END);d=this.clone();d.collapse();d.setEndAt(b,i.POSITION_BEFORE_END);d=new u(d);d.guard=a==
i.ENLARGE_LIST_ITEM_CONTENTS?c:D;q=null;d=d.lastForward();q=q||b;this.setEndAt(q,!d&&this.checkEndOfBlock()||d&&q._4e_contains(d)?i.POSITION_BEFORE_END:i.POSITION_BEFORE_START);v&&this.setEndAfter(v)}},checkStartOfBlock:function(){var a=this.startContainer,b=this.startOffset;if(b&&a[0].nodeType==h.NODE_TEXT)if(r.trim(a[0].nodeValue.substring(0,b)).length)return false;this.trim();a=new w(this.startContainer);b=this.clone();b.collapse(true);b.setStartAt(a.block||a.blockLimit,i.POSITION_AFTER_START);
a=new u(b);a.evaluator=F(true);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,b=this.endOffset;if(a[0].nodeType==h.NODE_TEXT)if(r.trim(a[0].nodeValue.substring(b)).length)return false;this.trim();a=new w(this.endContainer);b=this.clone();b.collapse(false);b.setEndAt(a.block||a.blockLimit,i.POSITION_BEFORE_END);a=new u(b);a.evaluator=F(false);return a.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,b){var c=this.clone();c[b==i.START?"setStartAt":"setEndAt"](a,b==i.START?i.POSITION_AFTER_START:i.POSITION_BEFORE_END);c=new u(c);c.evaluator=I;return c[b==i.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,e=this.endOffset,d;if(a[0].nodeType==h.NODE_ELEMENT){d=a[0].childNodes.length;if(d>
c)a=new n(a[0].childNodes[c]);else if(d<1)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new n(a);a=a._4e_nextSourceNode()||a}}if(b[0].nodeType==h.NODE_ELEMENT){d=b[0].childNodes.length;if(d>e)b=(new n(b[0].childNodes[e]))._4e_previousSourceNode(true);else if(d<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new n(b)}}if(a._4e_position(b)&O.POSITION_FOLLOWING)a=b;return{startNode:a,endNode:b}},fixBlock:function(a,b){var c=this.createBookmark(),
e=new n(this.document.createElement(b));this.collapse(a);this.enlarge(i.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();C.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(c);return e},splitBlock:function(a){var b=new w(this.startContainer),c=new w(this.endContainer),e=b.block,d=c.block,f=null;if(!b.blockLimit._4e_equals(c.blockLimit))return null;if(a!="br"){if(!e){e=this.fixBlock(true,a);d=(new w(this.endContainer)).block}d||(d=this.fixBlock(false,a))}a=
e&&this.checkStartOfBlock();b=d&&this.checkEndOfBlock();this.deleteContents();if(e&&s._4e_equals(e,d))if(b){f=new w(this.startContainer);this.moveToPosition(d,i.POSITION_AFTER_END);d=null}else if(a){f=new w(this.startContainer);this.moveToPosition(e,i.POSITION_BEFORE_START);e=null}else{d=this.splitElement(e);!C.ie&&!r.inArray(e._4e_name(),["ul","ol"])&&e._4e_appendBogus()}return{previousBlock:e,nextBlock:d,wasStartOfBlock:a,wasEndOfBlock:b,elementPath:f}},splitElement:function(a){if(!this.collapsed)return null;
this.setEndAt(a,i.POSITION_BEFORE_END);var b=this.extractContents(),c=a._4e_clone(false);c[0].appendChild(b);c.insertAfter(a);this.moveToPosition(a,i.POSITION_AFTER_END);return c},moveToElementEditablePosition:function(a,b){var c,e=t.XHTML_DTD;if(e.$empty[a._4e_name()])return false;for(;a&&a[0].nodeType==h.NODE_ELEMENT;){if(c=a._4e_isEditable())this.moveToPosition(a,b?i.POSITION_BEFORE_END:i.POSITION_AFTER_START);else if(e.$inline[a._4e_name()]){this.moveToPosition(a,b?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);
return true}if((a=e.$empty[a._4e_name()]?a[b?"_4e_previous":"_4e_next"](E):a[b?"_4e_last":"_4e_first"](E))&&a[0].nodeType==h.NODE_TEXT){this.moveToPosition(a,b?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);return true}}return c},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==h.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var L={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},J=new u.whitespaces,K=new u.bookmark;t.Range=z});
