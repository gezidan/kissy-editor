KISSY.Editor.add("selection",function(r){function x(b){this.document=b;this._={cache:{}};if(l.ie){var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=b||a.parentElement&&a.parentElement().ownerDocument!=b)this.isInvalid=true}}function F(b){var a=b.document,c=new o(a.body),d=new o(a.documentElement);if(l.ie){if(l.ie<8||document.documentMode==7)d.on("click",function(h){n._4e_name(h.target)==="html"&&b.getSelection().getRanges()[0].select()});var f,e,g=1;d.on("mousedown",function(){g=
0});d.on("mouseup",function(){g=1});c.on("focusin",function(h){if(n._4e_name(h.target)=="body")if(f){try{g&&f.select()}catch(q){}f=null}});c.on("focus",function(){e=true;p()});c.on("beforedeactivate",function(h){if(!h.relatedTarget){e=false;g=1}});y.on(n._4e_getWin(a),"blur",function(){a&&a.selection.empty()});c.on("mousedown",function(){i()});c.on("mouseup",function(){e=true;setTimeout(function(){p(true)},0)});c.on("keydown",i);c.on("keyup",function(){e=true;p()});y.on(a,"selectionchange",p);var i=
function(){e=false},p=function(h){if(e){var q=b.document,j=b.getSelection(),B=j&&j.getType(),z=j&&j.getNative();if(h&&z&&B==k.SELECTION_NONE)if(!q.queryCommandEnabled("InsertImage")){setTimeout(function(){p(true)},50);return}var C;if(!(z&&B==k.SELECTION_TEXT&&(C=n._4e_name(z.createRange().parentElement()))&&C in{input:1,textarea:1})){f=z&&j.getRanges()[0];b._monitor()}}}}else{y.on(a,"mouseup",b._monitor,b);y.on(a,"keyup",b._monitor,b)}var s={table:1,pre:1},u=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
v=r.Walker.whitespaces(true);r.Walker.bookmark(false,true);b.on("selectionChange",function(h){var q=h.path;h=(h=h.selection)&&h.getRanges()[0];var j=q.blockLimit;if(h)if(h.collapse&&!q.block&&j._4e_name()=="body"){q=h.fixBlock(true,"p");if(q._4e_outerHtml().match(u))if((j=q._4e_next(v))&&j[0].nodeType==m.NODE_ELEMENT&&!s[j._4e_name()]){h.moveToElementEditablePosition(j);q._4e_remove()}else if((j=q._4e_previous(v))&&j[0].nodeType==m.NODE_ELEMENT&&!s[j._4e_name()]){h.moveToElementEditablePosition(j,
j._4e_outerHtml().match(u)?false:true);q._4e_remove()}h.select();l.ie||b.notifySelectionChange()}})}r.SELECTION={};var t=KISSY,l=t.UA,n=t.DOM,y=t.Event,o=t.Node,k=r.SELECTION,A=r.RANGE,m=r.NODE,G=r.Walker,w=r.Range;k.SELECTION_NONE=1;k.SELECTION_TEXT=2;k.SELECTION_ELEMENT=3;var D={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};t.augment(x,{getNative:l.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=
this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=n._4e_getWin(this.document).getSelection())},getType:l.ie?function(){var b=this._.cache;if(b.type)return b.type;var a=k.SELECTION_NONE;try{var c=this.getNative(),d=c.type;if(d=="Text")a=k.SELECTION_TEXT;if(d=="Control")a=k.SELECTION_ELEMENT;if(c.createRange().parentElement)a=k.SELECTION_TEXT}catch(f){}return b.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=k.SELECTION_TEXT,c=this.getNative();
if(c){if(c.rangeCount==1){c=c.getRangeAt(0);var d=c.startContainer;if(d==c.endContainer&&d.nodeType==m.NODE_ELEMENT&&c.endOffset-c.startOffset===1&&D[d.childNodes[c.startOffset].nodeName.toLowerCase()])a=k.SELECTION_ELEMENT}}else a=k.SELECTION_NONE;return b.type=a},getRanges:l.ie?function(){var b=function(a,c){a=a.duplicate();a.collapse(c);for(var d=a.parentElement(),f=d.childNodes,e,g=0;g<f.length;g++){var i=f[g];if(i.nodeType==m.NODE_ELEMENT){e=a.duplicate();e.moveToElementText(i);i=e.compareEndPoints("StartToStart",
a);var p=e.compareEndPoints("EndToStart",a);e.collapse();if(i>0)break;else if(!i||p==1&&i==-1)return{container:d,offset:g};else if(!p)return{container:d,offset:g+1};e=null}}if(!e){e=a.duplicate();e.moveToElementText(d);e.collapse(false)}e.setEndPoint("StartToStart",a);e=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;e>0;)e-=f[--g].nodeValue.length}catch(s){e=0}return e===0?{container:d,offset:g}:{container:f[g],offset:-e}};return function(){var a=this._.cache;if(a.ranges)return a.ranges;var c=
this.getNative(),d=c&&c.createRange(),f=this.getType();if(!c)return[];if(f==k.SELECTION_TEXT){c=new w(this.document);f=b(d,true);c.setStart(new o(f.container),f.offset);f=b(d);c.setEnd(new o(f.container),f.offset);return a.ranges=[c]}else if(f==k.SELECTION_ELEMENT){a=this._.cache.ranges=[];for(f=0;f<d.length;f++){var e=d.item(f),g=e.parentNode,i=0;for(c=new w(this.document);i<g.childNodes.length&&g.childNodes[i]!=e;i++);c.setStart(new o(g),i);c.setEnd(new o(g),i+1);a.push(c)}return a}return a.ranges=
[]}}():function(){var b=this._.cache;if(b.ranges)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var d=0;d<c.rangeCount;d++){var f=c.getRangeAt(d),e=new w(this.document);e.setStart(new o(f.startContainer),f.startOffset);e.setEnd(new o(f.endContainer),f.endOffset);a.push(e)}return b.ranges=a},getStartElement:function(){var b=this._.cache;if(b.startElement!==undefined)return b.startElement;var a,c=this.getNative();switch(this.getType()){case k.SELECTION_ELEMENT:return this.getSelectedElement();
case k.SELECTION_TEXT:var d=this.getRanges()[0];if(d)if(!d.collapsed){for(d.optimize();;){a=d.startContainer;if(d.startOffset==(a[0].nodeType===m.NODE_ELEMENT?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())d.setStartAfter(a);else break}a=d.startContainer;if(a[0].nodeType!=m.NODE_ELEMENT)return a.parent();a=new o(a[0].childNodes[d.startOffset]);if(!a[0]||a[0].nodeType!=m.NODE_ELEMENT)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType==m.NODE_ELEMENT;){a=new o(d);d=
d.firstChild}return a}if(l.ie){d=c.createRange();d.collapse(true);a=d.parentElement()}else if((a=c.anchorNode)&&a.nodeType!=m.NODE_ELEMENT)a=a.parentNode}return b.startElement=a?n._4e_wrap(a):null},getSelectedElement:function(){var b=this._.cache;if(b.selectedElement!==undefined)return b.selectedElement;var a=this,c;if(l.ie){c=a.getNative().createRange();c=c.item&&c.item(0)}c||(c=function(){for(var d=a.getRanges()[0],f,e,g=2;g&&!((f=d.getEnclosedNode())&&f[0].nodeType==m.NODE_ELEMENT&&D[f._4e_name()]&&
(e=f));g--)d.shrink(A.SHRINK_ELEMENT);return e&&e[0]}());return b.selectedElement=n._4e_wrap(c)},reset:function(){this._.cache={}},selectElement:function(b){var a;if(l.ie)try{a=this.document.body.createControlRange();a.addElement(b[0]);a.select()}catch(c){a=this.document.body.createTextRange();a.moveToElementText(b[0]);a.select()}finally{}else{a=this.document.createRange();a.selectNode(b[0]);b=this.getNative();b.removeAllRanges();b.addRange(a)}this.reset()},selectRanges:function(b){if(l.ie)b[0]&&
b[0].select();else{var a=this.getNative();if(!a)return;a.removeAllRanges();for(var c=0;c<b.length;c++){var d=b[c],f=this.document.createRange(),e=d.startContainer;d.collapsed&&l.gecko&&l.gecko<1.09&&e[0].nodeType==m.NODE_ELEMENT&&!e[0].childNodes.length&&e[0].appendChild(this.document.createTextNode(""));f.setStart(e[0],d.startOffset);f.setEnd(d.endContainer[0],d.endOffset);a.addRange(f)}}this.reset()},createBookmarks2:function(b){for(var a=[],c=this.getRanges(),d=0;d<c.length;d++)a.push(c[d].createBookmark2(b));
return a},createBookmarks:function(b){for(var a=[],c=this.getRanges(),d=c.length,f=this.document,e,g=0;g<d;g++){a.push(e=c[g].createBookmark(b,true));var i=(b=e.serializable)?t.one("#"+e.startNode,f):e.startNode;e=b?t.one("#"+e.endNode,f):e.endNode;for(var p=g+1;p<d;p++){var s=c[p],u=s.startContainer,v=s.endContainer;n._4e_equals(u,i.parent())&&s.startOffset++;n._4e_equals(u,e.parent())&&s.startOffset++;n._4e_equals(v,i.parent())&&s.endOffset++;n._4e_equals(v,e.parent())&&s.endOffset++}}return a},
selectBookmarks:function(b){for(var a=[],c=0;c<b.length;c++){var d=new w(this.document);d.moveToBookmark(b[c]);a.push(d)}this.selectRanges(a);return this},getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4e_commonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();b&&b._4e_scrollIntoView()},removeAllRanges:function(){var b=this.getNative();l.ie?b.clear():b.removeAllRanges()}});r.Selection=x;var E={table:1,tbody:1,tr:1},H=G.whitespaces(true),
I=/\ufeff|\u00a0/;w.prototype.select=l.ie?function(b){var a=this.collapsed,c,d;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var f=this.startContainer[0].childNodes[this.startOffset];if(f.nodeType==m.NODE_ELEMENT){(new x(this.document)).selectElement(new o(f));return}}if(this.startContainer[0].nodeType==m.NODE_ELEMENT&&this.startContainer._4e_name()in E||this.endContainer[0].nodeType==m.NODE_ELEMENT&&this.endContainer._4e_name()in E)this.shrink(A.SHRINK_ELEMENT,
true);var e=this.createBookmark();f=e.startNode;var g;if(!a)g=e.endNode;e=this.document.body.createTextRange();e.moveToElementText(f[0]);e.moveStart("character",1);if(g){b=this.document.body.createTextRange();b.moveToElementText(g[0]);e.setEndPoint("EndToEnd",b);e.moveEnd("character",-1)}else{for(c=f[0].nextSibling;c&&!H(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&c.nodeValue.match(I))&&(b||!f[0].previousSibling||f[0].previousSibling&&n._4e_name(f[0].previousSibling)=="br");d=this.document.createElement("span");
d.innerHTML="&#65279;";d=new o(d);n.insertBefore(d[0],f[0]);c&&n.insertBefore(this.document.createTextNode("\ufeff"),f[0])}this.setStartBefore(f);f._4e_remove();if(a){if(c){e.moveStart("character",-1);e.select();this.document.selection.clear()}else e.select();if(d){this.moveToPosition(d,A.POSITION_BEFORE_START);d._4e_remove()}}else{this.setEndBefore(g);g._4e_remove();e.select()}}:function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==m.NODE_ELEMENT&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));
var a=this.document.createRange();a.setStart(b[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);a.setEnd(this.endContainer[0],this.endOffset)}else throw c;}b=new x(this.document);b=(!b||b.isInvalid?null:b).getNative();b.removeAllRanges();b.addRange(a)};r.on("instanceCreated",function(b){F(b.editor)})});
