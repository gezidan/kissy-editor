KISSY.Editor.add("selection",function(s){function v(b){this.document=this.document=b;this._={cache:{}};if(m.ie){var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=b||a.parentElement&&a.parentElement().ownerDocument!=b)this.isInvalid=k}}function F(b){b=new v(b);return!b||b.isInvalid?A:b}function K(b){var a=b.document,c=new q(a.body),d=new q(a.documentElement);if(m.ie){if(m.ie<8||document.documentMode==7)d.on("click",function(h){o._4e_name(h.target)==="html"&&b.getSelection().getRanges()[0].select()});
var f,e,g=1;d.on("mousedown",function(){g=0});d.on("mouseup",function(){g=1});c.on("focusin",function(h){if(o._4e_name(h.target)=="body")if(f){try{g&&f.select()}catch(t){}f=A}});c.on("focus",function(){e=k;r()});c.on("beforedeactivate",function(h){if(!h.relatedTarget){e=B;g=1}});C.on(o._4e_getWin(a),"blur",function(){a&&a.selection.empty()});c.on("mousedown",function(){i()});c.on("mouseup",function(){e=k;setTimeout(function(){r(k)},0)});var i=function(){e=B},r=function(h){if(e){var t=b.document,l=
b.getSelection(),G=l&&l.getType(),D=l&&l.getNative();if(h&&D&&G==p.SELECTION_NONE)if(!t.queryCommandEnabled("InsertImage")){setTimeout(function(){r(k)},50);return}var H;if(!(D&&G==p.SELECTION_TEXT&&(H=o._4e_name(D.createRange().parentElement()))&&H in{input:1,textarea:1})){f=D&&l.getRanges()[0];b._monitor()}}};c.on("keydown",i);c.on("keyup",function(){e=k;r()});C.on(a,"selectionchange",r)}else{C.on(a,"mouseup",b._monitor,b);C.on(a,"keyup",b._monitor,b)}var u={table:1,pre:1},y=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
z=s.Walker.whitespaces(k);b.on("selectionChange",function(h){var t=h.path;h=(h=h.selection)&&h.getRanges()[0];var l=t.blockLimit;if(h)if(h.collapse&&!t.block&&l._4e_name()=="body"){t=h.fixBlock(k,"p");if(t._4e_outerHtml().match(y))if((l=t._4e_next(z))&&l[0].nodeType==n.NODE_ELEMENT&&!u[l._4e_name()]){h.moveToElementEditablePosition(l);t._4e_remove()}else if((l=t._4e_previous(z))&&l[0].nodeType==n.NODE_ELEMENT&&!u[l._4e_name()]){h.moveToElementEditablePosition(l,l._4e_outerHtml().match(y)?B:k);t._4e_remove()}h.select();
m.ie||b.notifySelectionChange()}})}s.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var k=true,B=false,A=null,w=KISSY,m=w.UA,o=w.DOM,C=w.Event,q=w.Node,p=s.SELECTION,E=s.RANGE,n=s.NODE,j=s.Walker,x=s.Range,I={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};w.augment(v,{getNative:m.ie?function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=this.document.selection)}:function(){var b=
this._.cache;return b.nativeSel||(b.nativeSel=o._4e_getWin(this.document).getSelection())},getType:m.ie?function(){var b=this._.cache;if(b.type)return b.type;var a=p.SELECTION_NONE;try{var c=this.getNative(),d=c.type;if(d=="Text")a=p.SELECTION_TEXT;if(d=="Control")a=p.SELECTION_ELEMENT;if(c.createRange().parentElement)a=p.SELECTION_TEXT}catch(f){}return b.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=p.SELECTION_TEXT,c=this.getNative();if(c){if(c.rangeCount==1){c=c.getRangeAt(0);
var d=c.startContainer;if(d==c.endContainer&&d.nodeType==n.NODE_ELEMENT&&c.endOffset-c.startOffset===1&&I[d.childNodes[c.startOffset].nodeName.toLowerCase()])a=p.SELECTION_ELEMENT}}else a=p.SELECTION_NONE;return b.type=a},getRanges:m.ie?function(){var b=function(a,c){a=a.duplicate();a.collapse(c);for(var d=a.parentElement(),f=d.childNodes,e,g=0;g<f.length;g++){var i=f[g];if(i.nodeType==n.NODE_ELEMENT){e=a.duplicate();e.moveToElementText(i);i=e.compareEndPoints("StartToStart",a);var r=e.compareEndPoints("EndToStart",
a);e.collapse();if(i>0)break;else if(!i||r==1&&i==-1)return{container:d,offset:g};else if(!r)return{container:d,offset:g+1};e=A}}if(!e){e=a.duplicate();e.moveToElementText(d);e.collapse(B)}e.setEndPoint("StartToStart",a);e=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;e>0;)e-=f[--g].nodeValue.length}catch(u){e=0}return e===0?{container:d,offset:g}:{container:f[g],offset:-e}};return function(){var a=this._.cache;if(a.ranges)return a.ranges;var c=this.getNative(),d=c&&c.createRange(),f=this.getType();
if(!c)return[];if(f==p.SELECTION_TEXT){c=new x(this.document);f=b(d,k);c.setStart(new q(f.container),f.offset);f=b(d);c.setEnd(new q(f.container),f.offset);return a.ranges=[c]}else if(f==p.SELECTION_ELEMENT){a=a.ranges=[];for(f=0;f<d.length;f++){var e=d.item(f),g=e.parentNode,i=0;for(c=new x(this.document);i<g.childNodes.length&&g.childNodes[i]!=e;i++);c.setStart(new q(g),i);c.setEnd(new q(g),i+1);a.push(c)}return a}return a.ranges=[]}}():function(){var b=this._.cache;if(b.ranges)return b.ranges;
var a=[],c=this.getNative();if(!c)return[];for(var d=0;d<c.rangeCount;d++){var f=c.getRangeAt(d),e=new x(this.document);e.setStart(new q(f.startContainer),f.startOffset);e.setEnd(new q(f.endContainer),f.endOffset);a.push(e)}return b.ranges=a},getStartElement:function(){var b=this._.cache;if(b.startElement!==undefined)return b.startElement;var a,c=this.getNative();switch(this.getType()){case p.SELECTION_ELEMENT:return this.getSelectedElement();case p.SELECTION_TEXT:var d=this.getRanges()[0];if(d)if(!d.collapsed){for(d.optimize();k;){a=
d.startContainer;if(d.startOffset==(a[0].nodeType===n.NODE_ELEMENT?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())d.setStartAfter(a);else break}a=d.startContainer;if(a[0].nodeType!=n.NODE_ELEMENT)return a.parent();a=new q(a[0].childNodes[d.startOffset]);if(!a[0]||a[0].nodeType!=n.NODE_ELEMENT)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType==n.NODE_ELEMENT;){a=new q(d);d=d.firstChild}return a}if(m.ie){d=c.createRange();d.collapse(k);a=d.parentElement()}else if((a=
c.anchorNode)&&a.nodeType!=n.NODE_ELEMENT)a=a.parentNode}return b.startElement=a?o._4e_wrap(a):A},getSelectedElement:function(){var b=this,a,c=b._.cache;if(c.selectedElement!==undefined)return c.selectedElement;if(m.ie){a=b.getNative().createRange();a=a.item&&a.item(0)}a||(a=function(){for(var d=b.getRanges()[0],f,e,g=2;g&&!((f=d.getEnclosedNode())&&f[0].nodeType==n.NODE_ELEMENT&&I[f._4e_name()]&&(e=f));g--)d.shrink(E.SHRINK_ELEMENT);return e&&e[0]}());return c.selectedElement=o._4e_wrap(a)},reset:function(){this._.cache=
{}},selectElement:function(b){var a;if(m.ie)try{a=this.document.body.createControlRange();a.addElement(b[0]);a.select()}catch(c){a=this.document.body.createTextRange();a.moveToElementText(b[0]);a.select()}finally{}else{a=this.document.createRange();a.selectNode(b[0]);b=this.getNative();b.removeAllRanges();b.addRange(a)}this.reset()},selectRanges:function(b){if(m.ie)b[0]&&b[0].select();else{var a=this.getNative();if(!a)return;a.removeAllRanges();for(var c=0;c<b.length;c++){var d=b[c],f=this.document.createRange(),
e=d.startContainer;d.collapsed&&m.gecko&&m.gecko<1.09&&e[0].nodeType==n.NODE_ELEMENT&&!e[0].childNodes.length&&e[0].appendChild(this.document.createTextNode(""));f.setStart(e[0],d.startOffset);f.setEnd(d.endContainer[0],d.endOffset);a.addRange(f)}}this.reset()},createBookmarks2:function(b){for(var a=[],c=this.getRanges(),d=0;d<c.length;d++)a.push(c[d].createBookmark2(b));return a},createBookmarks:function(b){for(var a=[],c=this.getRanges(),d=c.length,f=this.document,e,g=0;g<d;g++){a.push(e=c[g].createBookmark(b,
k));var i=(b=e.serializable)?w.one("#"+e.startNode,f):e.startNode;e=b?w.one("#"+e.endNode,f):e.endNode;for(var r=g+1;r<d;r++){var u=c[r],y=u.startContainer,z=u.endContainer;o._4e_equals(y,i.parent())&&u.startOffset++;o._4e_equals(y,e.parent())&&u.startOffset++;o._4e_equals(z,i.parent())&&u.endOffset++;o._4e_equals(z,e.parent())&&u.endOffset++}}return a},selectBookmarks:function(b){for(var a=[],c=0;c<b.length;c++){var d=new x(this.document);d.moveToBookmark(b[c]);a.push(d)}this.selectRanges(a);return this},
getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4e_commonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();b&&b._4e_scrollIntoView()},removeAllRanges:function(){var b=this.getNative();m.ie?b.clear():b.removeAllRanges()}});var J={table:1,tbody:1,tr:1},L=j.whitespaces(k),M=/\ufeff|\u00a0/;x.prototype.select=x.prototype.select=m.ie?function(b){var a=this.collapsed,c,d;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-
this.startOffset==1){var f=this.startContainer[0].childNodes[this.startOffset];if(f.nodeType==n.NODE_ELEMENT){(new v(this.document)).selectElement(new q(f));return}}if(this.startContainer[0].nodeType==n.NODE_ELEMENT&&this.startContainer._4e_name()in J||this.endContainer[0].nodeType==n.NODE_ELEMENT&&this.endContainer._4e_name()in J)this.shrink(E.SHRINK_ELEMENT,k);var e=this.createBookmark();f=e.startNode;var g;if(!a)g=e.endNode;e=this.document.body.createTextRange();e.moveToElementText(f[0]);e.moveStart("character",
1);if(g){b=this.document.body.createTextRange();b.moveToElementText(g[0]);e.setEndPoint("EndToEnd",b);e.moveEnd("character",-1)}else{for(c=f[0].nextSibling;c&&!L(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&c.nodeValue.match(M))&&(b||!f[0].previousSibling||f[0].previousSibling&&o._4e_name(f[0].previousSibling)=="br");d=this.document.createElement("span");d.innerHTML="&#65279;";d=new q(d);o.insertBefore(d[0],f[0]);c&&o.insertBefore(this.document.createTextNode("\ufeff"),f[0])}this.setStartBefore(f);f._4e_remove();
if(a){if(c){e.moveStart("character",-1);e.select();this.document.selection.clear()}else e.select();if(d){this.moveToPosition(d,E.POSITION_BEFORE_START);d._4e_remove()}}else{this.setEndBefore(g);g._4e_remove();e.select()}}:function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==n.NODE_ELEMENT&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));var a=this.document.createRange();a.setStart(b[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=
0){this.collapse(k);a.setEnd(this.endContainer[0],this.endOffset)}else throw c;}b=F(this.document).getNative();b.removeAllRanges();b.addRange(a)};v.getSelection=F;s.Selection=v;s.Selection=v;j=v.prototype;s.Utils.extern(j,{getNative:j.getNative,getType:j.getType,getRanges:j.getRanges,getStartElement:j.getStartElement,getSelectedElement:j.getSelectedElement,reset:j.reset,selectElement:j.selectElement,selectRanges:j.selectRanges,createBookmarks2:j.createBookmarks2,createBookmarks:j.createBookmarks,
selectBookmarks:j.selectBookmarks,getCommonAncestor:j.getCommonAncestor,scrollIntoView:j.scrollIntoView,selectBookmarks:j.selectBookmarks,removeAllRanges:j.removeAllRanges});s.on("instanceCreated",function(b){K(b.editor)})});
