KISSY.Editor.add("selection",function(p){function u(b){this.document=b;this._={cache:{}};if(l.ie){var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=b||a.parentElement&&a.parentElement().ownerDocument!=b)this.isInvalid=true}}function C(b){var a=b.document,c=new n(a.body),d=new n(a.documentElement);if(l.ie){if(l.ie<8||document.documentMode==7)d.on("click",function(j){k._4e_name(j.target)==="html"&&b.getSelection().getRanges()[0].select()});var f,e,g=1;d.on("mousedown",function(){g=
0});d.on("mouseup",function(){g=1});c.on("focusin",function(j){if(k._4e_name(j.target)=="body")if(f){try{g&&f.select()}catch(s){}f=null}});c.on("focus",function(){e=true;o()});c.on("beforedeactivate",function(j){if(!j.relatedTarget){e=false;g=1}});v.on(k._4e_getWin(a),"blur",function(){a&&a.selection.empty()});c.on("mousedown",function(){h()});c.on("mouseup",function(){e=true;setTimeout(function(){o(true)},0)});c.on("keydown",h);c.on("keyup",function(){e=true;o()});v.on(a,"selectionchange",o);var h=
function(){e=false},o=function(j){if(e){var s=b.document,q=b.getSelection(),y=q&&q.getType(),w=q&&q.getNative();if(j&&w&&y==i.SELECTION_NONE)if(!s.queryCommandEnabled("InsertImage")){setTimeout(function(){o(true)},50);return}var z;if(!(w&&y==i.SELECTION_TEXT&&(z=k._4e_name(w.createRange().parentElement()))&&z in{input:1,textarea:1})){f=w&&q.getRanges()[0];b._monitor()}}}}else{v.on(a,"mouseup",b._monitor,b);v.on(a,"keyup",b._monitor,b)}}p.SELECTION={};var r=KISSY,l=r.UA,k=r.DOM,v=r.Event,n=r.Node,
i=p.SELECTION,x=p.RANGE,m=p.NODE,D=p.Walker,t=p.Range;i.SELECTION_NONE=1;i.SELECTION_TEXT=2;i.SELECTION_ELEMENT=3;var A={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};r.augment(u,{getNative:l.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=k._4e_getWin(this.document).getSelection())},getType:l.ie?
function(){var b=this._.cache;if(b.type)return b.type;var a=i.SELECTION_NONE;try{var c=this.getNative(),d=c.type;if(d=="Text")a=i.SELECTION_TEXT;if(d=="Control")a=i.SELECTION_ELEMENT;if(c.createRange().parentElement)a=i.SELECTION_TEXT}catch(f){}return b.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=i.SELECTION_TEXT,c=this.getNative();if(c){if(c.rangeCount==1){c=c.getRangeAt(0);var d=c.startContainer;if(d==c.endContainer&&d.nodeType==m.NODE_ELEMENT&&c.endOffset-c.startOffset===
1&&A[d.childNodes[c.startOffset].nodeName.toLowerCase()])a=i.SELECTION_ELEMENT}}else a=i.SELECTION_NONE;return b.type=a},getRanges:l.ie?function(){var b=function(a,c){a=a.duplicate();a.collapse(c);for(var d=a.parentElement(),f=d.childNodes,e,g=0;g<f.length;g++){var h=f[g];if(h.nodeType==m.NODE_ELEMENT){e=a.duplicate();e.moveToElementText(h);h=e.compareEndPoints("StartToStart",a);var o=e.compareEndPoints("EndToStart",a);e.collapse();if(h>0)break;else if(!h||o==1&&h==-1)return{container:d,offset:g};
else if(!o)return{container:d,offset:g+1};e=null}}if(!e){e=a.duplicate();e.moveToElementText(d);e.collapse(false)}e.setEndPoint("StartToStart",a);e=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;e>0;)e-=f[--g].nodeValue.length}catch(j){e=0}return e===0?{container:d,offset:g}:{container:f[g],offset:-e}};return function(){var a=this._.cache;if(a.ranges)return a.ranges;var c=this.getNative(),d=c&&c.createRange(),f=this.getType();if(!c)return[];if(f==i.SELECTION_TEXT){c=new t(this.document);f=b(d,
true);c.setStart(new n(f.container),f.offset);f=b(d);c.setEnd(new n(f.container),f.offset);return a.ranges=[c]}else if(f==i.SELECTION_ELEMENT){a=this._.cache.ranges=[];for(f=0;f<d.length;f++){var e=d.item(f),g=e.parentNode,h=0;for(c=new t(this.document);h<g.childNodes.length&&g.childNodes[h]!=e;h++);c.setStart(new n(g),h);c.setEnd(new n(g),h+1);a.push(c)}return a}return a.ranges=[]}}():function(){var b=this._.cache;if(b.ranges)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var d=0;d<
c.rangeCount;d++){var f=c.getRangeAt(d),e=new t(this.document);e.setStart(new n(f.startContainer),f.startOffset);e.setEnd(new n(f.endContainer),f.endOffset);a.push(e)}return b.ranges=a},getStartElement:function(){var b=this._.cache;if(b.startElement!==undefined)return b.startElement;var a,c=this.getNative();switch(this.getType()){case i.SELECTION_ELEMENT:return this.getSelectedElement();case i.SELECTION_TEXT:var d=this.getRanges()[0];if(d)if(!d.collapsed){for(d.optimize();;){a=d.startContainer;if(d.startOffset==
(a[0].nodeType===m.NODE_ELEMENT?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())d.setStartAfter(a);else break}a=d.startContainer;if(a[0].nodeType!=m.NODE_ELEMENT)return a.parent();a=new n(a[0].childNodes[d.startOffset]);if(!a[0]||a[0].nodeType!=m.NODE_ELEMENT)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType==m.NODE_ELEMENT;){a=new n(d);d=d.firstChild}return a}if(l.ie){d=c.createRange();d.collapse(true);a=d.parentElement()}else if((a=c.anchorNode)&&a.nodeType!=m.NODE_ELEMENT)a=
a.parentNode}return b.startElement=a?k._4e_wrap(a):null},getSelectedElement:function(){var b=this._.cache;if(b.selectedElement!==undefined)return b.selectedElement;var a=this,c;if(l.ie){c=a.getNative().createRange();c=c.item&&c.item(0)}c||(c=function(){for(var d=a.getRanges()[0],f,e,g=2;g&&!((f=d.getEnclosedNode())&&f[0].nodeType==m.NODE_ELEMENT&&A[f._4e_name()]&&(e=f));g--)d.shrink(x.SHRINK_ELEMENT);return e&&e[0]}());return b.selectedElement=k._4e_wrap(c)},reset:function(){this._.cache={}},selectElement:function(b){var a;
if(l.ie)try{a=this.document.body.createControlRange();a.addElement(b[0]);a.select()}catch(c){a=this.document.body.createTextRange();a.moveToElementText(b[0]);a.select()}finally{}else{a=this.document.createRange();a.selectNode(b[0]);b=this.getNative();b.removeAllRanges();b.addRange(a)}this.reset()},selectRanges:function(b){if(l.ie)b[0]&&b[0].select();else{var a=this.getNative();if(!a)return;a.removeAllRanges();for(var c=0;c<b.length;c++){var d=b[c],f=this.document.createRange(),e=d.startContainer;
d.collapsed&&l.gecko&&l.gecko<1.09&&e[0].nodeType==m.NODE_ELEMENT&&!e[0].childNodes.length&&e[0].appendChild(this.document.createTextNode(""));f.setStart(e[0],d.startOffset);f.setEnd(d.endContainer[0],d.endOffset);a.addRange(f)}}this.reset()},createBookmarks2:function(b){for(var a=[],c=this.getRanges(),d=0;d<c.length;d++)a.push(c[d].createBookmark2(b));return a},createBookmarks:function(b){for(var a=[],c=this.getRanges(),d=c.length,f=this.document,e,g=0;g<d;g++){a.push(e=c[g].createBookmark(b,true));
var h=(b=e.serializable)?r.one("#"+e.startNode,f):e.startNode;e=b?r.one("#"+e.endNode,f):e.endNode;for(var o=g+1;o<d;o++){var j=c[o],s=j.startContainer,q=j.endContainer;k._4e_equals(s,h.parent())&&j.startOffset++;k._4e_equals(s,e.parent())&&j.startOffset++;k._4e_equals(q,h.parent())&&j.endOffset++;k._4e_equals(q,e.parent())&&j.endOffset++}}return a},selectBookmarks:function(b){for(var a=[],c=0;c<b.length;c++){var d=new t(this.document);d.moveToBookmark(b[c]);a.push(d)}this.selectRanges(a);return this},
getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4e_commonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});p.Selection=u;var B={table:1,tbody:1,tr:1},E=D.whitespaces(true),F=/\ufeff|\u00a0/;t.prototype.select=l.ie?function(b){var a=this.collapsed,c,d;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var f=this.startContainer[0].childNodes[this.startOffset];if(f.nodeType==
m.NODE_ELEMENT){(new u(this.document)).selectElement(new n(f));return}}if(this.startContainer[0].nodeType==m.NODE_ELEMENT&&this.startContainer._4e_name()in B||this.endContainer[0].nodeType==m.NODE_ELEMENT&&this.endContainer._4e_name()in B)this.shrink(x.SHRINK_ELEMENT,true);var e=this.createBookmark();f=e.startNode;var g;if(!a)g=e.endNode;e=this.document.body.createTextRange();e.moveToElementText(f[0]);e.moveStart("character",1);if(g){b=this.document.body.createTextRange();b.moveToElementText(g[0]);
e.setEndPoint("EndToEnd",b);e.moveEnd("character",-1)}else{for(c=f[0].nextSibling;c&&!E(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&c.nodeValue.match(F))&&(b||!f[0].previousSibling||f[0].previousSibling&&k._4e_name(f[0].previousSibling)=="br");d=this.document.createElement("span");d.innerHTML="&#65279;";d=new n(d);k.insertBefore(d[0],f[0]);c&&k.insertBefore(this.document.createTextNode("ï»¿"),f[0])}this.setStartBefore(f);f._4e_remove();if(a){if(c){e.moveStart("character",-1);e.select();this.document.selection.clear()}else e.select();
if(d){this.moveToPosition(d,x.POSITION_BEFORE_START);d._4e_remove()}}else{this.setEndBefore(g);g._4e_remove();e.select()}}:function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==m.NODE_ELEMENT&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));var a=this.document.createRange();a.setStart(b[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);a.setEnd(this.endContainer[0],
this.endOffset)}else throw c;}b=new u(this.document);b=(!b||b.isInvalid?null:b).getNative();b.removeAllRanges();b.addRange(a)};p.on("instanceCreated",function(b){C(b.editor)})});
