KISSY.Editor.add("selection",function(p){function u(c){this.document=c;this._={cache:{}};if(j.ie){var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=c||a.parentElement&&a.parentElement().ownerDocument!=c)this.isInvalid=true}}function B(c){c=new u(c);return!c||c.isInvalid?null:c}function C(c){var a=c.document,b=new m(a.body),d=new m(a.documentElement);if(j.ie){if(j.ie<8||document.documentMode==7)d.on("click",function(n){l._4e_name(n.target)==="html"&&c.getSelection().getRanges()[0].select()});
var e,f;b.on("focusin",function(n){if(n.target.nodeName.toUpperCase()=="BODY")if(e){try{e.select()}catch(o){}e=null}});b.on("focus",function(){f=true;h()});b.on("beforedeactivate",function(n){n.relatedTarget||(f=false)});j.ie<8&&v.on(l._4e_getWin(a),"blur",function(){a.selection.empty()});b.on("mousedown",g);b.on("mouseup",function(){f=true;setTimeout(function(){h(true)},0)});b.on("keydown",g);b.on("keyup",function(){f=true;h()});v.on(a,"selectionchange",h);var g=function(){f=false},h=function(n){if(f){var o=
c.document,q=c.getSelection(),s=q.getType(),w=q&&q.getNative();if(n&&w&&s==i.SELECTION_NONE)if(!o.queryCommandEnabled("InsertImage")){setTimeout(function(){h(true)},50);return}var x;if(!(w&&s==i.SELECTION_TEXT&&(x=l._4e_name(w.createRange().parentElement()))&&x in{input:1,textarea:1})){e=w&&q.getRanges()[0];c._monitor()}}}}else{v.on(a,"mouseup",c._monitor,c);v.on(a,"keyup",c._monitor,c)}}p.SELECTION={};var r=KISSY,j=r.UA,l=r.DOM,v=r.Event,m=r.Node,i=p.SELECTION,y=p.RANGE,k=p.NODE,D=p.Walker,t=p.Range;
i.SELECTION_NONE=1;i.SELECTION_TEXT=2;i.SELECTION_ELEMENT=3;var z={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};r.augment(u,{getNative:j.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=l._4e_getWin(this.document).getSelection())},getType:j.ie?function(){var c=this._.cache;if(c.type)return c.type;
var a=i.SELECTION_NONE;try{var b=this.getNative(),d=b.type;if(d=="Text")a=i.SELECTION_TEXT;if(d=="Control")a=i.SELECTION_ELEMENT;if(b.createRange().parentElement)a=i.SELECTION_TEXT}catch(e){}return c.type=a}:function(){var c=this._.cache;if(c.type)return c.type;var a=i.SELECTION_TEXT,b=this.getNative();if(b){if(b.rangeCount==1){b=b.getRangeAt(0);var d=b.startContainer;if(d==b.endContainer&&d.nodeType==k.NODE_ELEMENT&&b.endOffset-b.startOffset===1&&z[d.childNodes[b.startOffset].nodeName.toLowerCase()])a=
i.SELECTION_ELEMENT}}else a=i.SELECTION_NONE;return c.type=a},getRanges:j.ie?function(){var c=function(a,b){a=a.duplicate();a.collapse(b);b=a.parentElement();for(var d=b.childNodes,e,f=0;f<d.length;f++){var g=d[f];if(g.nodeType==k.NODE_ELEMENT){e=a.duplicate();e.moveToElementText(g);g=e.compareEndPoints("StartToStart",a);var h=e.compareEndPoints("EndToStart",a);e.collapse();if(g>0)break;else if(!g||h==1&&g==-1)return{container:b,offset:f};else if(!h)return{container:b,offset:f+1};e=null}}if(!e){e=
a.duplicate();e.moveToElementText(b);e.collapse(false)}e.setEndPoint("StartToStart",a);a=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;a>0;)a-=d[--f].nodeValue.length}catch(n){a=0}return a===0?{container:b,offset:f}:{container:d[f],offset:-a}};return function(){var a=this._.cache;if(a.ranges)return a.ranges;var b=this.getNative(),d=b&&b.createRange(),e=this.getType();if(!b)return[];if(e==i.SELECTION_TEXT){b=new t(this.document);e=c(d,true);b.setStart(new m(e.container),e.offset);e=c(d);b.setEnd(new m(e.container),
e.offset);return a.ranges=[b]}else if(e==i.SELECTION_ELEMENT){a=this._.cache.ranges=[];for(e=0;e<d.length;e++){var f=d.item(e),g=f.parentNode,h=0;for(b=new t(this.document);h<g.childNodes.length&&g.childNodes[h]!=f;h++);b.setStart(new m(g),h);b.setEnd(new m(g),h+1);a.push(b)}return a}return a.ranges=[]}}():function(){var c=this._.cache;if(c.ranges)return c.ranges;var a=[],b=this.getNative();if(!b)return[];for(var d=0;d<b.rangeCount;d++){var e=b.getRangeAt(d),f=new t(this.document);f.setStart(new m(e.startContainer),
e.startOffset);f.setEnd(new m(e.endContainer),e.endOffset);a.push(f)}return c.ranges=a},getStartElement:function(){var c=this._.cache;if(c.startElement!==undefined)return c.startElement;var a,b=this.getNative();switch(this.getType()){case i.SELECTION_ELEMENT:return this.getSelectedElement();case i.SELECTION_TEXT:var d=this.getRanges()[0];if(d)if(!d.collapsed){for(d.optimize();;){a=d.startContainer;if(d.startOffset==(a[0].nodeType===k.NODE_ELEMENT?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())d.setStartAfter(a);
else break}a=d.startContainer;if(a[0].nodeType!=k.NODE_ELEMENT)return a.parent();a=new m(a[0].childNodes[d.startOffset]);if(!a[0]||a[0].nodeType!=k.NODE_ELEMENT)return d.startContainer;for(d=a[0].firstChild;d&&d.nodeType==k.NODE_ELEMENT;){a=new m(d);d=d.firstChild}return a}if(j.ie){d=b.createRange();d.collapse(true);a=d.parentElement()}else if((a=b.anchorNode)&&a.nodeType!=k.NODE_ELEMENT)a=a.parentNode}return c.startElement=a?l._4e_wrap(a):null},getSelectedElement:function(){var c=this._.cache;if(c.selectedElement!==
undefined)return c.selectedElement;var a=this,b;if(j.ie){b=a.getNative().createRange();b=b.item&&b.item(0)}b||(b=function(){for(var d=a.getRanges()[0],e,f,g=2;g&&!((e=d.getEnclosedNode())&&e[0].nodeType==k.NODE_ELEMENT&&z[e._4e_name()]&&(f=e));g--)d.shrink(y.SHRINK_ELEMENT);return f&&f[0]}());return c.selectedElement=l._4e_wrap(b)},reset:function(){this._.cache={}},selectElement:function(c){var a;if(j.ie)try{a=this.document.body.createControlRange();a.addElement(c[0]);a.select()}catch(b){a=this.document.body.createTextRange();
a.moveToElementText(c[0]);a.select()}finally{}else{a=this.document.createRange();a.selectNode(c[0]);c=this.getNative();c.removeAllRanges();c.addRange(a)}this.reset()},selectRanges:function(c){if(j.ie)c[0]&&c[0].select();else{var a=this.getNative();if(!a)return;a.removeAllRanges();for(var b=0;b<c.length;b++){var d=c[b],e=this.document.createRange(),f=d.startContainer;d.collapsed&&j.gecko&&j.gecko<1.09&&f[0].nodeType==k.NODE_ELEMENT&&!f[0].childNodes.length&&f[0].appendChild(this.document.createTextNode(""));
e.setStart(f[0],d.startOffset);e.setEnd(d.endContainer[0],d.endOffset);a.addRange(e)}}this.reset()},createBookmarks2:function(c){for(var a=[],b=this.getRanges(),d=0;d<b.length;d++)a.push(b[d].createBookmark2(c));return a},createBookmarks:function(c){for(var a=[],b=this.getRanges(),d=b.length,e=this.document,f,g=0;g<d;g++){a.push(f=b[g].createBookmark(c,true));var h=(c=f.serializable)?r.one("#"+f.startNode,e):f.startNode;f=c?r.one("#"+f.endNode,e):f.endNode;for(var n=g+1;n<d;n++){var o=b[n],q=o.startContainer,
s=o.endContainer;l._4e_equals(q,h.parent())&&o.startOffset++;l._4e_equals(q,f.parent())&&o.startOffset++;l._4e_equals(s,h.parent())&&o.endOffset++;l._4e_equals(s,f.parent())&&o.endOffset++}}return a},selectBookmarks:function(c){for(var a=[],b=0;b<c.length;b++){var d=new t(this.document);d.moveToBookmark(c[b]);a.push(d)}this.selectRanges(a);return this},getCommonAncestor:function(){var c=this.getRanges();return c[0].startContainer._4e_commonAncestor(c[c.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
p.Selection=u;var A={table:1,tbody:1,tr:1},E=D.whitespaces(true),F=/\ufeff|\u00a0/;t.prototype.select=j.ie?function(c){var a=this.collapsed,b,d;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==k.NODE_ELEMENT){(new u(this.document)).selectElement(new m(e));return}}if(this.startContainer[0].nodeType==k.NODE_ELEMENT&&this.startContainer._4e_name()in A||this.endContainer[0].nodeType==k.NODE_ELEMENT&&
this.endContainer._4e_name()in A)this.shrink(k.NODE_ELEMENT,true);var f=this.createBookmark();e=f.startNode;var g;if(!a)g=f.endNode;f=this.document.body.createTextRange();f.moveToElementText(e[0]);f.moveStart("character",1);if(g){c=this.document.body.createTextRange();c.moveToElementText(g[0]);f.setEndPoint("EndToEnd",c);f.moveEnd("character",-1)}else{for(b=e[0].nextSibling;b&&!E(b);)b=b.nextSibling;b=!(b&&b.nodeValue&&b.nodeValue.match(F))&&(c||!e[0].previousSibling||e[0].previousSibling&&l._4e_name(e[0].previousSibling)==
"br");d=this.document.createElement("span");d.innerHTML="&#65279;";d=new m(d);l.insertBefore(d[0],e[0]);b&&l.insertBefore(this.document.createTextNode("\ufeff"),e[0])}this.setStartBefore(e);e._4e_remove();if(a){if(b){f.moveStart("character",-1);f.select();this.document.selection.clear()}else f.select();if(d){this.moveToPosition(d,y.POSITION_BEFORE_START);d._4e_remove()}}else{this.setEndBefore(g);g._4e_remove();f.select()}}:function(){var c=this.startContainer;this.collapsed&&c[0].nodeType==k.NODE_ELEMENT&&
!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));var a=this.document.createRange();a.setStart(c[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(b){if(b.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);a.setEnd(this.endContainer[0],this.endOffset)}else throw b;}c=B(this.document).getNative();c.removeAllRanges();c.addRange(a)};p.on("instanceCreated",function(c){C(c.editor)})});
