KISSY.add("editor",function(v,s){function y(g,l){var w=this;if(!(w instanceof y))return new y(g,l);if(v.isString(g))g=v.one(g);g[0]||(g=new Node(g));l=l||{};l.pluginConfig=l.pluginConfig||{};w.cfg=l;v.app(w,v.EventTarget);w.use=function(b){if(v.isString(b))b=b.split(",");var d=b;b=[];b=v.indexOf("separator",d);var h=b!=-1;b=d.splice(0,h?b+1:d.length);h&&b.pop();b.length!=0?v.use.call(w,b.join(","),function(){h&&w.addPlugin(function(){y.Utils.addSeparator(w.toolBarDiv)});w.use(d)},{order:true,global:y}):
w.on("dataReady",function(){w.setData(g.val());w.fire("save")});return w};w.init(g);return s}function t(g){if(!u)return g.replace(/\.(js|css)/i,"-min.$1");if(u==="dev")return"../src/"+g;return g}v.app(y,v.EventTarget);y.Config.base=v.Config.base+"editor/";var u=v.Config.debug,B={htmlparser:{attach:false,path:t("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},n=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],r=["flashutils",
"clipboard",{name:"color"},{name:"elementpaths"},"enterkey",{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["flashutils","contextmenu","fakeobjects","overlay","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview"]},"indent","justify",{name:"link",requires:["bubbleview"]},
"list","maximize",{name:"music",requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],i=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",
requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],c,j,m,q;c=0;for(j=r.length;c<j;c++){m=r[c];if(v.isString(m))m=r[c]={name:m};m.requires=m.requires||[];m.requires=m.requires.concat(["button"])}r=[{name:"localStorage",requires:["flashutils"]},{name:"button"},{name:"dd"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",
requires:["overlay"]}].concat(r);c=0;for(j=r.length;c<j;c++){m=r[c];q=m.name;B[q]={attach:false,requires:m.requires,csspath:m.useCss?t("plugins/"+q+"/plugin.css"):s,path:t("plugins/"+q+"/plugin.js")}}c=0;for(j=i.length;c<j;c++){m=i[c];r=s;if(!v.isString(m)){r=m.requires;m=m.name}B[m]={attach:false,requires:r,path:t("plugins/htmldataprocessor/htmlparser/"+m.substring(11)+".js")}}c=0;for(j=n.length;c<j;c++){m=n[c];B[m]={host:"editor",requires:c>0?n[c-1]:[]}}y.add(B);v.Editor=y});
KISSY.Editor.add("utils",function(v){var s=KISSY,y=s.Node,t=s.DOM,u=s.Config.debug,B=s.UA;v.Utils={debugUrl:function(n){if(!u)return n.replace(/\.(js|css)/i,"-min.$1");if(u==="dev")return"../src/"+n;return n},lazyRun:function(n,r,i){var c=n[r],j=n[i];n[r]=function(){c.apply(this,arguments);n[r]=n[i];return j.apply(this,arguments)}},getXY:function(n,r,i,c){i=i.defaultView||i.parentWindow;n-=t.scrollLeft(i);r-=t.scrollTop(i);if(c)if(i!=(c.defaultView||c.parentWindow)&&i.frameElement){c=t._4e_getOffset(i.frameElement,
c);n+=c.left;r+=c.top}return{left:n,top:r}},tryThese:function(){for(var n,r=0,i=arguments.length;r<i;r++){var c=arguments[r];try{n=c();break}catch(j){}}return n},arrayCompare:function(n,r){if(!n&&!r)return true;if(!n||!r||n.length!=r.length)return false;for(var i=0;i<n.length;i++)if(n[i]!==r[i])return false;return true},getByAddress:function(n,r,i){n=n.documentElement;for(var c=0;n&&c<r.length;c++){var j=r[c];if(i)for(var m=-1,q=0;q<n.childNodes.length;q++){var g=n.childNodes[q];if(!(i===true&&g.nodeType==
3&&g.previousSibling&&g.previousSibling.nodeType==3)){m++;if(m==j){n=g;break}}}else n=n.childNodes[j]}return n?new y(n):null},clearAllMarkers:function(n){for(var r in n)n[r]._4e_clearMarkers(n,true)},htmlEncodeAttr:function(n){return n.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(n){return n.replace(/^\s+/,"")},rtrim:function(n){return n.replace(/\s+$/,"")},trim:function(n){return this.ltrim(this.rtrim(n))},mix:function(){for(var n={},r=0;r<arguments.length;r++)n=
s.mix(n,arguments[r]);return n},isCustomDomain:function(){if(!B.ie)return false;var n=document.domain,r=window.location.hostname;return n!=r&&n!="["+r+"]"},addSeparator:function(n){(new s.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(n)},duplicateStr:function(n,r){return(new Array(r+1)).join(n)},throttle:function(n,r,i){i=i||150;if(i===-1)return function(){n.apply(r,arguments)};var c=(new Date).getTime();return function(){var j=(new Date).getTime();if(j-c>i){c=j;n.apply(r,arguments)}}},
buffer:function(n,r,i){i=i||0;var c=null;return function(){c&&clearTimeout(c);var j=arguments;c=setTimeout(function(){return n.apply(r,j)},i)}},isNumber:function(n){return/^\d+(.\d+)?$/.test(s.trim(n))}}});
KISSY.Editor.add("focusmanager",function(v){function s(){this.iframeFocus=true;r=this}function y(){this.iframeFocus=false;r=null}var t=KISSY,u=t.DOM,B=t.Event;t={};var n={},r;t={refreshAll:function(){for(var i in n){var c=n[i];c.document.designMode="off";c.document.designMode="on"}},currentInstance:function(){return r},getInstance:function(i){return n[i]},add:function(i){var c=u._4e_getWin(i.document);B.on(c,"focus",s,i);B.on(c,"blur",y,i)},register:function(i){n[i._UUID]=i},remove:function(i){delete n[i._UUID];
var c=u._4e_getWin(i.document);B.remove(c,"focus",s,i);B.remove(c,"blur",y,i)}};v.focusManager=t});
KISSY.Editor.add("definition",function(v){function s(l){return c+"<html><head><title>kissy-editor</title><link href='"+v.Config.base+j+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(l?'<script id="ke_actscrpt" type="text/javascript">'+(v.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+l+'");<\/script>':"")}var y=KISSY,t=y.UA,u=y.DOM,B=y.Node,n=y.Event,r=v.focusManager,i=v.Utils.tryThese,c="<!doctype html>",j=
v.Utils.debugUrl("theme/editor-iframe.css"),m=1,q="document.open();"+(v.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",g="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(t.ie?"javascript:void(function(){"+encodeURIComponent(q)+"}())":"")+'"  tabIndex="'+
(t.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";y.augment(v,{init:function(l){var w=this,b=new B(g.replace(/\$\(tabIndex\)/,l.attr("tabIndex")));b.on("mousedown",function(f){if(t.webkit){var o=u._4e_name(f.target);if(o=="select"||o=="option")return true}f.halt()});w.editorWrap=b;w._UUID=m++;r.register(w);w.wrap=b.one(".ke-textarea-wrap");w.iframe=w.wrap.one("iframe");w.toolBarDiv=b.one(".ke-editor-tools");w.textarea=
l;w.statusDiv=b.one(".ke-editor-status");w.toolBarDiv._4e_unselectable();w._commands={};w._plugins={};var d=l._4e_style("width"),h=l._4e_style("height");if(d){b.css("width",d);l.css("width","100%")}w.textarea.css("display","none");b.insertAfter(l);w.wrap[0].appendChild(l[0]);if(h){w.wrap.css("height",h);l.css("height","100%")}l=w.iframe;w.on("dataReady",function(){w.ready=true;v.fire("instanceCreated",{editor:w})});t.gecko?l.on("load",w._setUpIFrame,w):w._setUpIFrame()},addCommand:function(l,w){this._commands[l]=
w},execCommand:function(l){this.fire("save");this._commands[l].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(l){if(this.htmlDataProcessor)l=this.htmlDataProcessor.toDataFormat(l,"p");this.document.body.innerHTML=l},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(l){this.document.body.innerHTML=
l},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");t.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:s,getSelection:function(){var l=new v.Selection(this.document);return!l||l.isInvalid?null:l},focus:function(){var l=u._4e_getWin(this.document);t.webkit&&l&&l.parent&&l.parent.focus();l&&l.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){u._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function l(){f=h.document;w.document=f;b.detach();f.open("text/html","replace");f.write(d);f.close()}
var w=this,b=w.iframe,d=s(w._UUID),h=b[0].contentWindow,f;try{f=h.document}catch(o){b[0].src=b[0].src;if(t.ie&&t.ie<7){setTimeout(l,10);return}}l()},addPlugin:function(l){this.ready?l():this.on("dataReady",l)},_monitor:function(){var l=this;l._monitorId&&clearTimeout(l._monitorId);l._monitorId=setTimeout(function(){var w=l.getSelection();if(w&&!w.isInvalid){w=w.getStartElement();var b=new v.ElementPath(w);if(!l.previousPath||!l.previousPath.compare(b)){l.previousPath=b;l.fire("selectionChange",{selection:l,
path:b,element:w})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(l,w){var b=this;b.focus();var d=l._4e_name(),h=v.XHTML_DTD,f=v.RANGE,o=v.NODE,k=h.$block[d],a=b.getSelection(),e=a.getRanges(),p,x,z,C,H;b.fire("save");for(var N=e.length-1;N>=0;N--){p=e[N];p.deleteContents();x=!N&&l||l._4e_clone(true);w&&w(x);if(k)for(;(C=p.getCommonAncestor(false,true))&&(H=h[C._4e_name()])&&!(H&&H[d]);)if(C._4e_name()in h.span)p.splitElement(C);else if(p.checkStartOfBlock()&&
p.checkEndOfBlock()){p.setStartBefore(C);p.collapse(true);C._4e_remove()}else p.splitBlock();p.insertNode(x);z||(z=x)}l=z._4e_nextSourceNode(true);w=b.document;H=v.XHTML_DTD;if(H.$inline[x._4e_name()]){l=new B(w.createTextNode(" "));l.insertAfter(z)}else if(l){if(l._4e_name()=="br"&&H[l.parent()._4e_name()].p){H=new B("<p>&nbsp;</p>",null,w);l[0].parentNode.replaceChild(H[0],l[0]);l=H}}else{H=new B("<p>&nbsp;</p>",null,w);H.insertAfter(z);l=H}p.moveToPosition(z,f.POSITION_AFTER_END);l&&l[0].nodeType==
o.NODE_ELEMENT&&p.moveToElementEditablePosition(l);a.selectRanges([p]);b.focus();x&&x._4e_scrollIntoView();setTimeout(function(){b.fire("save")},10);return x},insertHtml:function(l){var w=this;if(w.htmlDataProcessor)l=w.htmlDataProcessor.toDataFormat(l);if(t.webkit){l=u.create(l,null,this.document);l=l.nodeType==11?y.makeArray(l.childNodes):[l];for(var b=0;b<l.length;b++)w.insertElement(new B(l[b]))}else{w.focus();w.fire("save");b=w.getSelection();if(t.ie){b=b.getNative();b.type=="Control"&&b.clear();
b.createRange().pasteHTML(l)}else w.document.execCommand("inserthtml",false,l);w.focus();setTimeout(function(){w.fire("save")},10)}}});v._initIFrame=function(l){function w(x){i(function(){h.designMode="on";setTimeout(function(){h.designMode="off";k.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){h.designMode="off";u.attr(k,"contentEditable",false);u.attr(k,"contentEditable",true);!x&&w(1)})}var b=r.getInstance(l);l=b.textarea[0];var d=b.iframe[0].contentWindow,h=b.document,
f=b.cfg,o=h.getElementById("ke_actscrpt");o.parentNode.removeChild(o);var k=h.body;if(t.ie){k.hideFocus=true;k.disabled=true;k.contentEditable=true;k.removeAttribute("disabled")}else setTimeout(function(){if(t.gecko||t.opera)k.contentEditable=true;else if(t.webkit)k.parentNode.contentEditable=true;else h.designMode="on"},0);if(t.webkit){n.on(h,"click",function(x){var z=new B(x.target);y.inArray(z._4e_name(),["input","select"])&&x.preventDefault()});n.on(h,"mouseup",function(x){var z=new B(x.target);
y.inArray(z._4e_name(),["input","textarea"])&&x.preventDefault()})}if(t.gecko||t.ie||t.opera){var a;a=new B(u.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],l));a.on("focus",function(){b.focus()});b.on("destroy",function(){})}if(t.ie&&h.compatMode=="CSS1Compat"||t.gecko||t.opera){var e=new B(h.documentElement);e.on("mousedown",function(x){if(x.target===e[0]){t.gecko&&w(false);a[0].focus()}})}n.on(d,"focus",function(){if(t.gecko)w(false);else t.opera&&k.focus();b.notifySelectionChange()});
t.gecko&&n.on(b.document,"mousedown",function(){b.iframeFocus||w(false)});if(t.ie){n.on(h,"keydown",function(x){if(x.keyCode in{8:1,46:1}){var z=b.getSelection(),C=z.getSelectedElement();if(C){b.fire("save");var H=z.getRanges()[0].createBookmark();C._4e_remove();z.selectBookmarks([H]);b.fire("save");x.preventDefault()}}});if(h.compatMode=="CSS1Compat"){var p={33:1,34:1};n.on(h,"keydown",function(x){x.keyCode in p&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}}setTimeout(function(){t.ie&&
setTimeout(function(){if(h){k.runtimeStyle.marginBottom="0px";k.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.fire("dataReady");var x=f.disableObjectResizing,z=f.disableInlineTableEditing;if(x||z)try{h.execCommand("enableObjectResizing",false,!x);h.execCommand("enableInlineTableEditing",false,!z)}catch(C){n.on(k,t.ie?"resizestart":"resize",function(H){if(x||u._4e_name(H.target)==="table"&&z)H.preventDefault()})}},10);t.webkit&&n.on(h,"mousedown",function(x){x=new B(x.target);y.inArray(x._4e_name(),
["img","hr","input","textarea","select"])&&b.getSelection().selectElement(x)});r.add(b)};t.gecko&&function(){var l=document.body;if(l){var w=l.getAttribute("onpageshow");l.setAttribute("onpageshow",(w?w+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(v){v.XHTML_DTD=function(){var s=function(k){for(var a=arguments.length-1;a>0;)KISSY.mix(k,arguments[a--]);return k},y={isindex:1,fieldset:1},t={input:1,button:1,select:1,textarea:1,label:1},u=s({a:1},t),B=s({iframe:1},u),n={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},r={ins:1,del:1,script:1,style:1},i=s({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},r),c=s({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},i),j=s({p:1},c);t=s({iframe:1},c,t);c={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var m=s({a:1},t),q={tr:1},g={"#":1},l=s({param:1},c),w=s({form:1},y,B,n,j),b={li:1},d={base:1,link:1,meta:1,title:1},h=s(d,{style:1,script:1}),f={head:1,body:1},o={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:s({html:1},f,d),$block:o,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:m,$body:s({script:1,style:1},o),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:f,head:h,style:g,body:w,base:{},link:{},meta:{},title:g,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:w,td:w,br:{},th:w,center:w,kbd:m,button:s(j,n),basefont:{},h5:m,h4:m,samp:m,h6:m,ol:b,h1:m,h3:m,option:g,h2:m,form:s(y,B,n,j),select:{optgroup:1,option:1},font:m,ins:m,menu:b,abbr:m,label:m,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:m,script:g,tfoot:q,cite:m,li:w,input:{},iframe:w,strong:m,textarea:g,noframes:w,big:m,small:m,span:m,hr:{},dt:m,sub:m,optgroup:{option:1},param:{},bdo:m,"var":m,div:w,object:l,sup:m,dd:w,strike:m,area:{},dir:b,map:s({area:1,form:1,p:1},y,r,n),applet:l,dl:{dt:1,dd:1},del:m,isindex:{},fieldset:s({legend:1},c),thead:q,ul:b,acronym:m,b:m,a:t,blockquote:w,caption:m,i:m,u:m,tbody:q,s:m,address:s(B,j),tt:m,legend:m,q:m,pre:s(i,u),p:m,em:m,dfn:m}}()});
KISSY.Editor.add("dom",function(v){function s(b){return b.replace(/-(\w)/g,function(d,h){return h.toUpperCase()})}var y=KISSY,t=y.DOM,u=y.UA,B=y.Node,n=v.Utils,r={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};v.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};v.POSITION={};var i=v.NODE,c=v.POSITION;c.POSITION_IDENTICAL=0;c.POSITION_DISCONNECTED=
1;c.POSITION_FOLLOWING=2;c.POSITION_PRECEDING=4;c.POSITION_IS_CONTAINED=8;c.POSITION_CONTAINS=16;var j={},m={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},q={hr:1},g=function(b){return b[0]||b},l=function(b){if(!b[0])return new B(b);return b},w={_4e_equals:function(b,d){if(!b&&!d)return true;if(!b||!d)return false;b=g(b);d=g(d);return b===d},_4e_isBlockBoundary:function(b,
d){b=l(b);d=y.mix(y.mix({},q),d||{});return m[b.css("display")]||d[b._4e_name()]},_4e_getWin:function(b){return b&&"scrollTo"in b&&b.document?b:b&&b.nodeType===9?b.defaultView||b.parentWindow:false},_4e_index:function(b){b=g(b);for(var d=b.parentNode.childNodes,h=0;h<d.length;h++)if(d[h]===b)return h;return-1},_4e_first:function(b,d){b=g(b);if((b=(b=b.firstChild)&&new B(b))&&d&&!d(b))b=b._4e_next(d);return b},_4e_move:function(b,d,h){b._4e_remove();b=g(b);d=g(d);h?d.insertBefore(b,d.firstChild):d.appendChild(b)},
_4e_name:function(b){b=g(b);var d=b.nodeName.toLowerCase();if(u.ie)if((b=b.scopeName)&&b!="HTML")d=b.toLowerCase()+":"+d;return d},_4e_isIdentical:function(b,d){if(b._4e_name()!=d._4e_name())return false;var h=b[0].attributes,f=d[0].attributes,o=h.length,k=f.length;if(!u.ie&&o!=k)return false;for(var a=0;a<o;a++){var e=h[a];if((!u.ie||e.specified&&e.nodeName!="_ke_expando")&&e.nodeValue!=d.attr(e.nodeName))return false}if(u.ie)for(a=0;a<k;a++){e=f[a];if(e.specified&&e.nodeName!="_ke_expando"&&e.nodeValue!=
b.attr(e.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(b){b=g(b).childNodes;for(var d=0,h=b.length;d<h;d++){var f=b[d],o=f.nodeType;if(!(o==i.NODE_ELEMENT&&f.getAttribute("_ke_bookmark")))if(o==i.NODE_ELEMENT&&!w._4e_isEmptyInlineRemoveable(f)||o==i.NODE_TEXT&&y.trim(f.nodeValue))return false}return true},_4e_moveChildren:function(b,d,h){b=g(b);d=d[0]||d;if(b!=d)if(h)for(;h=b.lastChild;)d.insertBefore(b.removeChild(h),d.firstChild);else for(;h=b.firstChild;)d.appendChild(b.removeChild(h))},
_4e_mergeSiblings:function(){function b(d,h,f){if(h[0]&&h[0].nodeType==i.NODE_ELEMENT){for(var o=[];h.attr("_ke_bookmark")||h._4e_isEmptyInlineRemoveable();){o.push(h);h=f?new B(h[0].nextSibling):new B(h[0].previousSibling);if(!h[0]||h[0].nodeType!=i.NODE_ELEMENT)return}if(d._4e_isIdentical(h)){for(var k=f?d[0].lastChild:d[0].firstChild;o.length;)o.shift()._4e_move(d,!f);h._4e_moveChildren(d,!f);h._4e_remove();k[0]&&k[0].nodeType==i.NODE_ELEMENT&&k._4e_mergeSiblings()}}}return function(d){if(d[0])if(r[d._4e_name()]||
d._4e_name()=="a"){b(d,new B(d[0].nextSibling),true);b(d,new B(d[0].previousSibling))}}}(),_4e_unselectable:u.gecko?function(b){b=g(b);b.style.MozUserSelect="none"}:u.webkit?function(b){b=g(b);b.style.KhtmlUserSelect="none"}:function(b){b=g(b);if(u.ie||u.opera){var d,h=0;for(b.unselectable="on";d=b.all[h++];)switch(d.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:d.unselectable="on"}}},_4e_getOffset:function(b,d){b=g(b);var h,f=0;h=0;var o=b.ownerDocument.defaultView||
b.ownerDocument.parentWindow,k=b.ownerDocument,a=k.documentElement;d=d||k;if(b.getBoundingClientRect){if(b!==k.body&&a!==b){h=b.getBoundingClientRect();f=h.left+(d===k?t.scrollLeft(o):0);h=h.top+(d===k?t.scrollTop(o):0)}if(d)if(o!=(d.defaultView||d.parentWindow)&&o.frameElement){d=w._4e_getOffset(o.frameElement,d);f+=d.left;h+=d.top}}return{left:f,top:h}},_4e_getFrameDocument:function(b){return(b=g(b))&&b.contentWindow.document},_4e_splitText:function(b,d){b=g(b);var h=b.ownerDocument;if(!(!b||b.nodeType!=
i.NODE_TEXT)){if(u.ie&&d==b.nodeValue.length){h=h.createTextNode("");t.insertAfter(h,b);return h}b=new B(b.splitText(d));if(u.ie==8){h=h.createTextNode("");t.insertAfter(h,b[0]);h.parentNode.removeChild(h)}return b}},_4e_parents:function(b,d){b=l(b);var h=[];do h[d?"push":"unshift"](b);while(b=b.parent());return h},_4e_clone:function(b,d,h){b=g(b);b=b.cloneNode(d);if(!h){var f=function(o){if(o.nodeType==i.NODE_ELEMENT){o.removeAttribute("id",false);o.removeAttribute("_ke_expando",false);o=o.childNodes;
for(var k=0;k<o.length;k++)f(o[k])}};f(b)}return new B(b)},_4e_nextSourceNode:function(b,d,h,f){b=g(b);if(f&&!f.call){var o=f[0]||f;f=function(a){a=a[0]||a;return a!==o}}d=!d&&b.firstChild;var k=new B(b);if(!d){if(b.nodeType==i.NODE_ELEMENT&&f&&f(this,true)===false)return null;d=b.nextSibling}for(;!d&&(k=k.parent());){if(f&&f(k,true)===false)return null;d=k[0].nextSibling}if(!d)return null;d=new B(d);if(f&&f(d)===false)return null;if(h&&h!=d[0].nodeType)return d._4e_nextSourceNode(false,h,f);return d},
_4e_previousSourceNode:function(b,d,h,f){b=g(b);if(f&&!f.call){var o=f[0]||f;f=function(a){a=a[0]||a;return a!==o}}d=!d&&b.lastChild;var k=new B(b);if(!d){if(b.nodeType==i.NODE_ELEMENT&&f&&f(b,true)===false)return null;d=b.previousSibling}for(;!d&&(k=k.parent());){if(f&&f(k,true)===false)return null;d=k[0].previousSibling}if(!d)return null;d=new B(d);if(f&&f(d)===false)return null;if(h&&d[0].nodeType!=h)return d._4e_previousSourceNode(false,h,f);return d},_4e_contains:u.ie||u.webkit?function(b,d){b=
g(b);d=g(d);return d.nodeType!=i.NODE_ELEMENT?b.contains(d.parentNode):b!=d&&b.contains(d)}:function(b,d){b=g(b);d=g(d);return!!(b.compareDocumentPosition(d)&16)},_4e_commonAncestor:function(b,d){if(b._4e_equals(d))return b;if(d[0].nodeType!=i.NODE_TEXT&&d._4e_contains(b))return d;b=b[0].nodeType==i.NODE_TEXT?b.parent():b;do if(b[0].nodeType!=i.NODE_TEXT&&b._4e_contains(d))return b;while(b=b.parent());return null},_4e_ascendant:function(b,d,h){b=g(b);if(!h)b=b.parentNode;if(d&&!y.isFunction(d)){var f=
d;d=function(o){return o._4e_name()==f}}for(;b&&b.nodeType!=9;){if(!d||d(new B(b))===true)return new B(b);b=b.parentNode}return null},_4e_hasAttribute:function(b,d){b=g(b);b=b.attributes.getNamedItem(d);return!!(b&&b.specified)},_4e_hasAttributes:u.ie?function(b){b=g(b);for(var d=b.attributes,h=0;h<d.length;h++){var f=d[h];switch(f.nodeName){case "class":if(b.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(f.specified)return true}}return false}:function(b){b=g(b);u.gecko&&
b.removeAttribute("_moz_dirty");b=b.attributes;return b.length>1||b.length==1&&b[0].nodeName!="_ke_expando"},_4e_position:function(b,d){var h=g(b),f=g(d);if(h.compareDocumentPosition)return h.compareDocumentPosition(f);if(h==f)return c.POSITION_IDENTICAL;if(h.nodeType==i.NODE_ELEMENT&&f.nodeType==i.NODE_ELEMENT){if(h.contains){if(h.contains(f))return c.POSITION_CONTAINS+c.POSITION_PRECEDING;if(f.contains(h))return c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING}if("sourceIndex"in h)return h.sourceIndex<
0||f.sourceIndex<0?c.POSITION_DISCONNECTED:h.sourceIndex<f.sourceIndex?c.POSITION_PRECEDING:c.POSITION_FOLLOWING}b=b._4e_address();d=d._4e_address();h=Math.min(b.length,d.length);for(f=0;f<=h-1;f++)if(b[f]!=d[f]){if(f<h)return b[f]<d[f]?c.POSITION_PRECEDING:c.POSITION_FOLLOWING;break}return b.length<d.length?c.POSITION_CONTAINS+c.POSITION_PRECEDING:c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING},_4e_address:function(b,d){b=g(b);var h=[],f=b.ownerDocument.documentElement;for(b=b;b&&b!=f;){var o=b.parentNode,
k=-1;if(o){for(var a=0;a<o.childNodes.length;a++){var e=o.childNodes[a];if(!(d&&e.nodeType==3&&e.previousSibling&&e.previousSibling.nodeType==3)){k++;if(e==b)break}}h.unshift(k)}b=o}return h},_4e_breakParent:function(b,d){var h=new v.Range(b[0].ownerDocument);h.setStartAfter(b);h.setEndAfter(d);d=h.extractContents();h.insertNode(b._4e_remove());b[0].parentNode.insertBefore(d,b[0].nextSibling)},_4e_style:function(b,d,h){if(h!==undefined)return b.css(d,h);b=b[0]||b;return b.style[s(d)]},_4e_remove:function(b,
d){var h=g(b),f=h.parentNode;if(f){if(d)for(;d=h.firstChild;)f.insertBefore(h.removeChild(d),h);f.removeChild(h)}return b},_4e_trim:function(b){t._4e_ltrim(b);t._4e_rtrim(b)},_4e_ltrim:function(b){b=g(b);for(var d;d=b.firstChild;){if(d.nodeType==i.NODE_TEXT){var h=n.ltrim(d.nodeValue),f=d.nodeValue.length;if(h){if(h.length<f){(new B(d))._4e_splitText(f-h.length);b.removeChild(b.firstChild)}}else{b.removeChild(d);continue}}break}},_4e_rtrim:function(b){b=g(b);for(var d;d=b.lastChild;){if(d.type==i.NODE_TEXT){var h=
n.rtrim(d.nodeValue),f=d.nodeValue.length;if(h){if(h.length<f){(new B(d))._4e_splitText(h.length);b.removeChild(b.lastChild)}}else{b.removeChild(d);continue}}break}if(!u.ie&&!u.opera)(d=b.lastChild)&&d.nodeType==1&&d.nodeName.toLowerCase()=="br"&&d.parentNode.removeChild(d)},_4e_appendBogus:function(b){b=g(b);for(var d=b.lastChild;d&&d.nodeType==i.NODE_TEXT&&!y.trim(d.nodeValue);)d=d.previousSibling;if(!d||d.nodeType==i.NODE_TEXT||t._4e_name(d)!=="br"){d=u.opera?b.ownerDocument.createTextNode(""):
b.ownerDocument.createElement("br");u.gecko&&d.setAttribute("type","_moz");b.appendChild(d)}},_4e_previous:function(b,d){b=g(b);var h;do h=(b=b.previousSibling)&&new B(b);while(h&&d&&!d(h));return h},_4e_last:function(b,d){if((b=(b=b[0].lastChild)&&new B(b))&&d&&!d(b))b=b._4e_previous(d);return b},_4e_next:function(b,d){b=g(b);var h;do h=(b=b.nextSibling)&&new B(b);while(h&&d&&!d(h));return h},_4e_outerHtml:function(b){b=g(b);if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var d=b.ownerDocument.createElement("div");
d.appendChild(b.cloneNode(true));return d.innerHTML},_4e_setMarker:function(b,d,h,f){b[0]||(b=new B(b));var o=b._4e_getData("list_marker_id")||b._4e_setData("list_marker_id",y.guid())._4e_getData("list_marker_id"),k=b._4e_getData("list_marker_names")||b._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");d[o]=b;k[h]=1;return b._4e_setData(h,f)},_4e_clearMarkers:function(b,d,h){b=l(b);var f=b._4e_getData("list_marker_names"),o=b._4e_getData("list_marker_id");for(var k in f)b._4e_removeData(k);
b._4e_removeData("list_marker_names");if(h){b._4e_removeData("list_marker_id");delete d[o]}},_4e_setData:function(b,d,h){var f=t._4e_getUniqueId(b);(j[f]||(j[f]={}))[d]=h;return b},_4e_getData:function(b,d){b=g(b);return(b=(b=b.getAttribute("_ke_expando"))&&j[b])&&b[d]},_4e_removeData:function(b,d){b=g(b);var h=b.getAttribute("_ke_expando");var f=(h=h&&j[h])&&h[d];typeof f!="undefined"&&h&&delete h[d];y.isEmptyObject(h)&&t._4e_clearData(b);return f||null},_4e_clearData:function(b){b=g(b);var d=b.getAttribute("_ke_expando");
d&&delete j[d];d&&b.removeAttribute("_ke_expando")},_4e_getUniqueId:function(b){b=g(b);var d=b.getAttribute("_ke_expando");if(d)return d;d=y.guid();b.setAttribute("_ke_expando",d);return d},_4e_copyAttributes:function(b,d,h){b=g(b);var f=b.attributes;h=h||{};for(var o=0;o<f.length;o++){var k=f[o],a=k.nodeName.toLowerCase(),e;if(!(a in h))if(a=="checked"&&(e=t.attr(b,a)))d.attr(a,e);else if(k.specified||u.ie&&k.nodeValue&&a=="value"){e=t.attr(b,a);if(e===null)e=k.nodeValue;d.attr(a,e)}}if(b.style.cssText!==
"")d[0].style.cssText=b.style.cssText},_4e_isEditable:function(b){b=t._4e_name(b);var d=v.XHTML_DTD;return(b=!d.$nonEditable[b]&&(d[b]||d.span))&&b["#"]},_4e_scrollIntoView:function(b){b=l(b);var d=b[0].ownerDocument,h=t.scrollLeft(d),f=t.scrollTop(d),o=b.offset(),k=o.left;o=o.top;if(t.viewportHeight(d)+f<o||o<f||t.viewportWidth(d)+h<k||k<h)b.scrollIntoView(d)},_4e_getElementsByTagName:function(b,d,h){b=g(b);if(!u.ie&&h)d=h+":"+d;h=[];b=b.getElementsByTagName(d);for(d=0;d<b.length;d++)h.push(new B(b[d]));
return h}};y.DOM._4e_inject=function(b){y.mix(t,b);for(var d in b)b.hasOwnProperty(d)&&function(h){B.prototype[h]=function(){var f=[].slice.call(arguments,0);f.unshift(this);return b[h].apply(null,f)}}(d)};y.DOM._4e_inject(w)});
KISSY.Editor.add("elementpath",function(v){function s(j){var m=null,q=null,g=[];for(j=j;j&&j[0];){if(j[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=j;var l=j._4e_name();if(n.ie&&j[0].scopeName!="HTML")l=j[0].scopeName.toLowerCase()+":"+l;if(!q){if(!m&&r[l])m=j;if(i[l])if(!m&&l=="div"&&!c(j))m=j;else q=j}g.push(j);if(l=="body")break}j=j.parent()}this.block=m;this.blockLimit=q;this.elements=g}var y=KISSY,t=y.DOM,u=v.XHTML_DTD,B=v.NODE,n=y.UA,r={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},c=function(j){j=j[0]||j;j=j.childNodes;for(var m=0,q=j.length;m<q;m++){var g=j[m];if(g.nodeType==B.NODE_ELEMENT&&u.$block[g.nodeName.toLowerCase()])return true}return false};s.prototype={compare:function(j){var m=this.elements;j=j&&j.elements;if(!j||m.length!=j.length)return false;for(var q=0;q<m.length;q++)if(!t._4e_equals(m[q],j[q]))return false;return true},contains:function(j){for(var m=
this.elements,q=0;q<m.length;q++)if(m[q]._4e_name()in j)return m[q];return null}};v.ElementPath=s});
KISSY.Editor.add("walker",function(v){function s(i,c){if(this._.end)return null;var j=this.range,m,q=this.guard,g=this.type,l=i?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;j.trim();if(j.collapsed){this.end();return null}}if(!i&&!this._.guardLTR){var w=j.endContainer,b=new r(w[0].childNodes[j.endOffset]);this._.guardLTR=function(o,k){return(!k||!n._4e_equals(w,o))&&(!b[0]||o[0]!==b[0])&&(o[0].nodeType!=B.NODE_ELEMENT||!k||o._4e_name()!="body")}}if(i&&!this._.guardRTL){var d=
j.startContainer,h=j.startOffset>0&&new r(d[0].childNodes[j.startOffset-1]);this._.guardRTL=function(o,k){return o&&o[0]&&(!k||d[0]!==o[0])&&(!h[0]||o[0]!==h[0])&&(o[0].nodeType!=B.NODE_ELEMENT||!k||o._4e_name()!="body")}}var f=i?this._.guardRTL:this._.guardLTR;m=q?function(o,k){if(f(o,k)===false)return false;return q(o,k)}:f;if(this.current)i=this.current[l](false,g,m);else if(i){i=j.endContainer;if(j.endOffset>0){i=new r(i[0].childNodes[j.endOffset-1]);if(m(i)===false)i=null}else i=m(i,true)===
false?null:i._4e_previousSourceNode(true,g,m)}else{i=j.startContainer;if((i=new r(i[0].childNodes[j.startOffset]))&&i[0]){if(m(i)===false)i=null}else i=m(j.startContainer,true)===false?null:j.startContainer._4e_nextSourceNode(true,g,m)}for(;i&&i[0]&&!this._.end;){this.current=i;if(!this.evaluator||this.evaluator(i)!==false){if(!c)return i}else if(c&&this.evaluator)return false;i=i[l](false,g,m)}this.end();return this.current=null}function y(i){for(var c,j=null;c=s.call(this,i);)j=c;return j}function t(i){this.range=
i;this._={}}var u=KISSY,B=v.NODE,n=u.DOM,r=u.Node;u.augment(t,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,true)},checkForward:function(){return s.call(this,false,true)!==false},checkBackward:function(){return s.call(this,true,true)!==false},lastForward:function(){return y.call(this)},lastBackward:function(){return y.call(this,true)},reset:function(){delete this.current;this._={}}});t.blockBoundary=function(i){return function(c){c[0]||(c=
new r(c));return!(c[0].nodeType==B.NODE_ELEMENT&&c._4e_isBlockBoundary(i))}};t.listItemBoundary=function(){return this.blockBoundary({br:1})};t.bookmark=function(i,c){function j(m){return m&&m[0]&&m._4e_name()=="span"&&m.attr("_ke_bookmark")}return function(m){var q,g;q=m&&m[0]&&m[0].nodeType==B.NODE_TEXT&&(g=m.parent())&&j(g);q=i?q:q||j(m);return c^q}};t.whitespaces=function(i){return function(c){c=(c=c[0]||c)&&c.nodeType==B.NODE_TEXT&&!u.trim(c.nodeValue);return i^c}};t.invisible=function(i){var c=
t.whitespaces();return function(j){j=c(j)||j[0].nodeType==B.NODE_ELEMENT&&!j[0].offsetHeight;return i^j}};v.Walker=t});
KISSY.Editor.add("range",function(v){function s(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=a}function y(a){var e=a[0].nodeType!=i.NODE_TEXT&&a._4e_name()in w.$removeEmpty,p=!r.trim(a[0].nodeValue);a=!!a.parent().attr("_ke_bookmark");return e||p||a}function t(a){return!o(a)&&!k(a)}function u(a){var e=false,p=m.bookmark(true);return function(x){if(p(x))return true;if(x[0].nodeType==i.NODE_TEXT){if(r.trim(x[0].nodeValue).length)return false}else if(x[0].nodeType==
i.NODE_ELEMENT)if(!f[x._4e_name()])if(!a&&!l.ie&&x._4e_name()=="br"&&!e)e=true;else return false;return true}}function B(a,e){function p(x){return x&&x.nodeName=="span"&&x.getAttribute("_ke_bookmark")}return function(x){var z,C;z=x&&!x.nodeName&&(C=x.parentNode)&&p(C);z=a?z:z||p(x);return e^z}}function n(a){return function(e){e=(e=e[0]||e)&&e.nodeType==i.NODE_TEXT&&!r.trim(e.nodeValue);return a^e}}v.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var r=KISSY,i=v.NODE,c=v.RANGE,j=v.POSITION,m=v.Walker,q=r.DOM,g=v.Utils.getByAddress,l=r.UA,w=v.XHTML_DTD,b=v.ElementPath,d=r.Node,h={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};s.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};r.augment(s,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&q._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,e=this.startOffset;if(a[0].nodeType!=i.NODE_ELEMENT)if(e)e>=a[0].nodeValue.length&&this.setStartAfter(a);else this.setStartBefore(a);a=this.endContainer;e=this.endOffset;if(a[0].nodeType!=i.NODE_ELEMENT)if(e)e>=a[0].nodeValue.length&&
this.setEndAfter(a);else this.setEndBefore(a)},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,e=this.endContainer;a&&a._4e_name()=="span"&&a.attr("_ke_bookmark")&&this.setStartAt(a,c.POSITION_BEFORE_START);e&&e._4e_name()=="span"&&
e.attr("_ke_bookmark")&&this.setEndAt(e,c.POSITION_AFTER_END)},setStart:function(a,e){if(a[0].nodeType==i.NODE_ELEMENT&&h[a._4e_name()]){a=a.parent();e=a._4e_index()}this.startContainer=a;this.startOffset=e;if(!this.endContainer){this.endContainer=a;this.endOffset=e}this.updateCollapsed()},setEnd:function(a,e){if(a[0].nodeType==i.NODE_ELEMENT&&h[a._4e_name()]){a=a.parent();e=a._4e_index()+1}this.endContainer=a;this.endOffset=e;if(!this.startContainer){this.startContainer=a;this.startOffset=e}this.updateCollapsed()},
setStartAt:function(a,e){switch(e){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==i.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,e){switch(e){case c.POSITION_AFTER_START:this.setEnd(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==i.NODE_TEXT?this.setEnd(a,
a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},execContentsAction:function(a,e){var p=this.startContainer,x=this.endContainer,z=this.startOffset,C=this.endOffset,H,N;this.optimizeBookmark();if(x[0].nodeType==i.NODE_TEXT)x=x._4e_splitText(C);else if(x[0].childNodes.length>0)if(C>=x[0].childNodes.length){x=new d(x[0].appendChild(this.document.createTextNode("")));
N=true}else x=new d(x[0].childNodes[C]);if(p[0].nodeType==i.NODE_TEXT){p._4e_splitText(z);if(q._4e_equals(p,x))x=new d(p[0].nextSibling)}else if(z)if(z>=p[0].childNodes.length){H=new d(this.document.createTextNode(""));p[0].appendChild(H[0]);p=H;H=true}else p=new d(p[0].childNodes[z].previousSibling);else{H=new d(this.document.createTextNode(""));q.insertBefore(H[0],p[0].firstChild);p=H;H=true}z=p._4e_parents();C=x._4e_parents();var A,D,I;for(A=0;A<z.length;A++){D=z[A];I=C[A];if(D[0]!==I[0])break}for(var L=
e,M,O,S,R=A;R<z.length;R++){M=z[R];if(L&&M[0]!==p[0])O=L.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(C[R]&&M==C[R][0]||M==x[0])break;S=M.nextSibling;if(a==2)L.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);a==1&&L.appendChild(M)}M=S}if(O)L=O}L=e;for(e=A;e<C.length;e++){M=C[e];if(a>0&&M[0]!==x[0])O=L.appendChild(M._4e_clone()[0]);if(!z[e]||M[0].parentNode!==z[e][0].parentNode)for(M=M[0].previousSibling;M;){if(z[e]&&M==z[e][0]||M===p[0])break;S=M.previousSibling;if(a==
2)L.insertBefore(M.cloneNode(true),L.firstChild);else{M.parentNode.removeChild(M);a==1&&L.insertBefore(M,L.firstChild)}M=S}if(O)L=O}if(a==2){I=this.startContainer[0];if(I.nodeType==i.NODE_TEXT&&I.nextSibling&&I.nextSibling.nodeType==i.NODE_TEXT){I.data+=I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}I=this.endContainer[0];if(I.nodeType==i.NODE_TEXT&&I.nextSibling&&I.nextSibling.nodeType==i.NODE_TEXT){I.data+=I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}}else{if(D&&I&&(p[0].parentNode!=
D[0].parentNode||x[0].parentNode!=I[0].parentNode)){a=I._4e_index();H&&I[0].parentNode==p[0].parentNode&&a--;this.setStart(I.parent(),a)}this.collapse(true)}H&&p._4e_remove();N&&x[0].parentNode&&x._4e_remove()},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var a=new s(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;
a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=i.NODE_ELEMENT||a.endContainer[0].nodeType!=i.NODE_ELEMENT)return null;a=a.startContainer[0].childNodes[a.startOffset];for(var e=B(true,undefined),p=n(true),x=function(z){return p(z)&&e(z)};a&&x(a);)a=(new d(a))._4e_nextSourceNode()[0];return new d(a)},shrink:function(a,e){if(!this.collapsed){a=a||c.SHRINK_TEXT;
var p=this.clone(),x=this.startContainer,z=this.endContainer,C=this.startOffset,H=this.endOffset,N=1,A=1;if(x&&x[0].nodeType==i.NODE_TEXT)if(C)if(C>=x[0].nodeValue.length)p.setStartAfter(x);else{p.setStartBefore(x);N=0}else p.setStartBefore(x);if(z&&z[0].nodeType==i.NODE_TEXT)if(H)if(H>=z[0].nodeValue.length)p.setEndAfter(z);else{p.setEndAfter(z);A=0}else p.setEndBefore(z);p=new m(p);p.evaluator=function(I){I=I[0]||I;return I.nodeType==(a==c.SHRINK_ELEMENT?i.NODE_ELEMENT:i.NODE_TEXT)};var D;p.guard=
function(I,L){I=I[0]||I;if(a==c.SHRINK_ELEMENT&&I.nodeType==i.NODE_TEXT)return false;if(L&&I==D)return false;if(!L&&I.nodeType==i.NODE_ELEMENT)D=I;return true};if(N)(x=p[a==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(x,e?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);if(A){p.reset();(p=p[a==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(p,e?c.POSITION_BEFORE_END:c.POSITION_AFTER_END)}return!!(N||A)}},getTouchedStartNode:function(){var a=this.startContainer;if(this.collapsed||
a[0].nodeType!=i.NODE_ELEMENT)return a;return a.childNodes[this.startOffset]||a},createBookmark2:function(a){var e=this.startContainer,p=this.endContainer,x=this.startOffset,z=this.endOffset,C,H;if(!e||!p)return{start:0,end:0};if(a){if(e[0].nodeType==i.NODE_ELEMENT)if((C=new d(e[0].childNodes[x]))&&C[0]&&C[0].nodeType==i.NODE_TEXT&&x>0&&C[0].previousSibling.nodeType==i.NODE_TEXT){e=C;x=0}for(;e[0].nodeType==i.NODE_TEXT&&(H=e._4e_previous())&&H[0].nodeType==i.NODE_TEXT;){e=H;x+=H[0].nodeValue.length}if(!this.collapsed){if(p[0].nodeType==
i.NODE_ELEMENT)if((C=new d(p[0].childNodes[z]))&&C[0]&&C[0].nodeType==i.NODE_TEXT&&z>0&&C[0].previousSibling.nodeType==i.NODE_TEXT){p=C;z=0}for(;p[0].nodeType==i.NODE_TEXT&&(H=p._4e_previous())&&H[0].nodeType==i.NODE_TEXT;){p=H;z+=H[0].nodeValue.length}}}return{start:e._4e_address(a),end:this.collapsed?null:p._4e_address(a),startOffset:x,endOffset:z,normalized:a,is2:true}},createBookmark:function(a){var e,p,x,z;e=new d("<span></span>",null,this.document);e.attr("_ke_bookmark",1);e.css("display","none");
e.html("&nbsp;");if(a){x=r.guid("ke_bm_");e.attr("id",x+"S")}if(!this.collapsed){p=e._4e_clone();p.html("&nbsp;");a&&p.attr("id",x+"E");z=this.clone();z.collapse();z.insertNode(p)}z=this.clone();z.collapse(true);z.insertNode(e);if(p){this.setStartAfter(e);this.setEndBefore(p)}else this.moveToPosition(e,c.POSITION_AFTER_END);return{startNode:a?x+"S":e,endNode:a?x+"E":p,serializable:a}},moveToPosition:function(a,e){this.setStartAt(a,e);this.collapse(true)},trim:function(a,e){var p=this.startContainer,
x=this.startOffset,z=this.collapsed;if((!a||z)&&p[0]&&p[0].nodeType==i.NODE_TEXT){if(x)if(x>=p[0].nodeValue.length){x=p._4e_index()+1;p=p.parent()}else{a=p._4e_splitText(x);x=p._4e_index()+1;p=p.parent();if(q._4e_equals(this.startContainer,this.endContainer))this.setEnd(a,this.endOffset-this.startOffset);else if(q._4e_equals(p,this.endContainer))this.endOffset+=1}else{x=p._4e_index();p=p.parent()}this.setStart(p,x);if(z){this.collapse(true);return}}p=this.endContainer;x=this.endOffset;if(!(e||z)&&
p[0]&&p[0].nodeType==i.NODE_TEXT){if(x){x>=p.nodeValue.length||p._4e_splitText(x);x=p._4e_index()+1}else x=p._4e_index();p=p.parent();this.setEnd(p,x)}},insertNode:function(a){this.optimizeBookmark();this.trim(false,true);var e=this.startContainer,p=e[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);p?q.insertBefore(a[0]||a,p):e[0].appendChild(a[0]||a);q._4e_equals(a.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){if(a.is2){var e=
g(this.document,a.start,a.normalized),p=a.startOffset,x=a.end&&g(this.document,a.end,a.normalized);a=a.endOffset;this.setStart(e,p);x?this.setEnd(x,a):this.collapse(true)}else{e=(p=a.serializable)?r.one("#"+a.startNode,this.document):a.startNode;a=p?r.one("#"+a.endNode,this.document):a.endNode;this.setStartBefore(e);e._4e_remove();if(a&&a[0]){this.setEndBefore(a);a._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(a,e){var p=this.startContainer,x=this.endContainer;a=q._4e_equals(p,
x)?a&&p[0].nodeType==i.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new d(p[0].childNodes[this.startOffset]):p:p._4e_commonAncestor(x);return e&&a[0].nodeType==i.NODE_TEXT?a.parent():a},enlarge:function(a){switch(a){case c.ENLARGE_ELEMENT:if(this.collapsed)return;a=this.getCommonAncestor();var e=new d(this.document.body),p,x,z,C,H,N=false,A,D;A=this.startContainer;D=this.startOffset;if(A[0].nodeType==i.NODE_TEXT){if(D){A=!r.trim(A[0].nodeValue.substring(0,D)).length&&A;N=!!A}if(A)if(!(C=A[0].previousSibling))z=
A.parent()}else{if(D)C=A[0].childNodes[D-1]||A[0].lastChild;C||(z=A)}for(;z||C;){if(z&&!C){if(!H&&q._4e_equals(z,a))H=true;if(!e._4e_contains(z))break;if(!N||z.css("display")!="inline"){N=false;if(H)p=z;else this.setStartBefore(z)}C=z[0].previousSibling}for(;C;){A=false;if(C.nodeType==i.NODE_TEXT){D=C.nodeValue;if(/[^\s\ufeff]/.test(D))C=null;A=/[\s\ufeff]$/.test(D)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(N&&w.$removeEmpty[C.nodeName.toLowerCase()]){D=q.text(C);if(/[^\s\ufeff]/.test(D))C=
null;else for(var I=C.all||C.getElementsByTagName("*"),L=0,M;M=I[L++];)if(!w.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}if(C)A=!!D.length}else C=null;if(A)if(N)if(H)p=z;else z&&this.setStartBefore(z);else N=true;if(C){A=C.previousSibling;if(!z&&!A){z=new d(C);C=null;break}C=A}else z=null}if(z)z=z.parent()}A=this.endContainer;D=this.endOffset;z=C=null;H=N=false;if(A[0].nodeType==i.NODE_TEXT){A=!r.trim(A[0].nodeValue.substring(D)).length&&A;N=!(A&&A[0].nodeValue.length);if(A)if(!(C=A[0].nextSibling))z=
A.parent()}else(C=A[0].childNodes[D])||(z=A);for(;z||C;){if(z&&!C){if(!H&&q._4e_equals(z,a))H=true;if(!e._4e_contains(z))break;if(!N||z.css("display")!="inline"){N=false;if(H)x=z;else z&&this.setEndAfter(z)}C=z[0].nextSibling}for(;C;){A=false;if(C.nodeType==i.NODE_TEXT){D=C.nodeValue;if(/[^\s\ufeff]/.test(D))C=null;A=/^[\s\ufeff]/.test(D)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(N&&w.$removeEmpty[C.nodeName.toLowerCase()]){D=q.text(C);if(/[^\s\ufeff]/.test(D))C=null;else{I=C.all||
C.getElementsByTagName("*");for(L=0;M=I[L++];)if(!w.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}}if(C)A=!!D.length}else C=null;if(A)if(N)if(H)x=z;else this.setEndAfter(z);if(C){A=C.nextSibling;if(!z&&!A){z=new d(C);C=null;break}C=A}else z=null}if(z)z=z.parent()}if(p&&x){a=p._4e_contains(x)?x:p;this.setStartBefore(a);this.setEndAfter(a)}break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:z=new s(this.document);e=new d(this.document.body);z.setStartAt(e,c.POSITION_AFTER_START);
z.setEnd(this.startContainer,this.startOffset);z=new m(z);var O,S,R=m.blockBoundary(a==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),Y=function(X){var E=R(X);E||(O=X);return E};p=function(X){var E=Y(X);if(!E&&X[0]&&X._4e_name()=="br")S=X;return E};z.guard=Y;z=z.lastBackward();O=O||e;this.setStartAt(O,O._4e_name()!="br"&&(!z&&this.checkStartOfBlock()||z&&O._4e_contains(z))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);z=this.clone();z.collapse();z.setEndAt(e,c.POSITION_BEFORE_END);z=new m(z);z.guard=a==
c.ENLARGE_LIST_ITEM_CONTENTS?p:Y;O=null;z=z.lastForward();O=O||e;this.setEndAt(O,!z&&this.checkEndOfBlock()||z&&O._4e_contains(z)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);S&&this.setEndAfter(S)}},checkStartOfBlock:function(){var a=this.startContainer,e=this.startOffset;if(e&&a[0].nodeType==i.NODE_TEXT)if(r.trim(a[0].nodeValue.substring(0,e)).length)return false;this.trim();a=new b(this.startContainer);e=this.clone();e.collapse(true);e.setStartAt(a.block||a.blockLimit,c.POSITION_AFTER_START);
a=new m(e);a.evaluator=u(true);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,e=this.endOffset;if(a[0].nodeType==i.NODE_TEXT)if(r.trim(a[0].nodeValue.substring(e)).length)return false;this.trim();a=new b(this.endContainer);e=this.clone();e.collapse(false);e.setEndAt(a.block||a.blockLimit,c.POSITION_BEFORE_END);a=new m(e);a.evaluator=u(false);return a.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,e){var p=this.clone();p[e==c.START?"setStartAt":"setEndAt"](a,e==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);a=new m(p);a.evaluator=y;return a[e==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,e=this.endContainer,p=this.startOffset,x=this.endOffset,z;if(a[0].nodeType==i.NODE_ELEMENT){z=a[0].childNodes.length;if(z>
p)a=new d(a[0].childNodes[p]);else if(z<1)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new d(a);a=a._4e_nextSourceNode()||a}}if(e[0].nodeType==i.NODE_ELEMENT){z=e[0].childNodes.length;if(z>x)e=(new d(e[0].childNodes[x]))._4e_previousSourceNode(true);else if(z<1)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=new d(e)}}if(a._4e_position(e)&j.POSITION_FOLLOWING)a=e;return{startNode:a,endNode:e}},fixBlock:function(a,e){var p=this.createBookmark();
e=new d(this.document.createElement(e));this.collapse(a);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();l.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(p);return e},splitBlock:function(a){var e=new b(this.startContainer),p=new b(this.endContainer),x=e.block,z=p.block,C=null;if(e.blockLimit[0]!==p.blockLimit[0])return null;if(a!="br"){if(!x){x=this.fixBlock(true,a);z=(new b(this.endContainer)).block}z||(z=this.fixBlock(false,a))}a=x&&this.checkStartOfBlock();
e=z&&this.checkEndOfBlock();this.deleteContents();if(x&&q._4e_equals(x,z))if(e){C=new b(this.startContainer);this.moveToPosition(z,c.POSITION_AFTER_END);z=null}else if(a){C=new b(this.startContainer);this.moveToPosition(x,c.POSITION_BEFORE_START);x=null}else{z=this.splitElement(x);!l.ie&&!r.inArray(x._4e_name(),["ul","ol"])&&x._4e_appendBogus()}return{previousBlock:x,nextBlock:z,wasStartOfBlock:a,wasEndOfBlock:e,elementPath:C}},splitElement:function(a){if(!this.collapsed)return null;this.setEndAt(a,
c.POSITION_BEFORE_END);var e=this.extractContents(),p=a._4e_clone(false);p[0].appendChild(e);p.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return p},moveToElementEditablePosition:function(a,e){var p,x=v.XHTML_DTD;if(x.$empty[a._4e_name()])return false;for(;a&&a[0].nodeType==i.NODE_ELEMENT;){if(p=a._4e_isEditable())this.moveToPosition(a,e?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);else if(x.$inline[a._4e_name()]){this.moveToPosition(a,e?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);
return true}if((a=x.$empty[a._4e_name()]?a[e?"_4e_previous":"_4e_next"](t):a[e?"_4e_last":"_4e_first"](t))&&a[0].nodeType==i.NODE_TEXT){this.moveToPosition(a,e?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);return true}}return p},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==i.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var f={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},o=new m.whitespaces,k=new m.bookmark;v.Range=s});
KISSY.Editor.add("domiterator",function(v){function s(g){if(!(arguments.length<1)){this.range=g;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var y=KISSY,t=y.UA,u=v.Walker,B=v.Range,n=v.RANGE,r=v.NODE,i=v.ElementPath,c=y.Node,j=y.DOM,m=/^[\r\n\t ]*$/,q=u.bookmark();y.augment(s,{getNextParagraph:function(g){var l,w,b,d,h;if(!this._.lastNode){w=this.range.clone();w.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var f=new u(w),o=u.bookmark(true,true);f.evaluator=o;this._.nextNode=f.next();f=new u(w);f.evaluator=o;f=f.previous();this._.lastNode=f._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==r.NODE_TEXT&&!y.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){o=new B(w.document);o.moveToPosition(this._.lastNode,n.POSITION_AFTER_END);if(o.checkEndOfBlock()){o=new i(o.endContainer);this._.lastNode=(o.block||o.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new c(w.document.createTextNode(""));j.insertAfter(this._.lastNode[0],f[0])}w=null}o=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;o;){var k=false,a=o[0].nodeType!=r.NODE_ELEMENT,e=false;if(a){if(o[0].nodeType==r.NODE_TEXT)if(m.test(o[0].nodeValue))a=false}else{var p=o._4e_name();if(o._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(p=="br")a=true;else if(!w&&!o[0].childNodes.length&&p!="hr"){l=o;b=o._4e_equals(f);break}if(w){w.setEndAt(o,n.POSITION_BEFORE_START);
if(p!="br")this._.nextNode=o}k=true}else{if(o[0].firstChild){if(!w){w=new B(this.range.document);w.setStartAt(o,n.POSITION_BEFORE_START)}o=new c(o[0].firstChild);continue}a=true}}if(a&&!w){w=new B(this.range.document);w.setStartAt(o,n.POSITION_BEFORE_START)}b=(!k||a)&&o._4e_equals(f);if(w&&!k)for(;!o[0].nextSibling&&!b;){p=o.parent();if(p._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){k=true;b||p._4e_equals(f);break}o=p;a=true;b=o._4e_equals(f);e=true}a&&w.setEndAt(o,n.POSITION_AFTER_END);o=o._4e_nextSourceNode(e,
null,f);b=!o;if((k||b)&&w){a=w.getBoundaryNodes();k=new i(w.startContainer);if(a.startNode.parent()._4e_equals(k.blockLimit)&&q(a.startNode)&&q(a.endNode)){w=null;this._.nextNode=null}else break}if(b)break}if(!l){if(!w){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}k=new i(w.startContainer);o=k.blockLimit;a={div:1,th:1,td:1};l=k.block;if((!l||!l[0])&&!this.enforceRealBlocks&&a[o._4e_name()]&&w.checkStartOfBlock()&&w.checkEndOfBlock())l=o;else if(!l||this.enforceRealBlocks&&
l._4e_name()=="li"){l=new c(this.range.document.createElement(g||"p"));l[0].appendChild(w.extractContents());l._4e_trim();w.insertNode(l);d=h=true}else if(l._4e_name()!="li"){if(!w.checkStartOfBlock()||!w.checkEndOfBlock()){l=l._4e_clone(false);l[0].appendChild(w.extractContents());l._4e_trim();h=w.splitBlock();d=!h.wasStartOfBlock;h=!h.wasEndOfBlock;w.insertNode(l)}}else if(!b)this._.nextNode=l._4e_equals(f)?null:w.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,f)}if(d){w=new c(l[0].previousSibling);
if(w[0]&&w[0].nodeType==r.NODE_ELEMENT)if(w._4e_name()=="br")w._4e_remove();else w[0].lastChild&&w[0].lastChild.nodeName.toLowerCase()=="br"&&j._4e_remove(w[0].lastChild)}if(h){w=u.bookmark(false,true);d=new c(l[0].lastChild);if(d[0]&&d[0].nodeType==r.NODE_ELEMENT&&d._4e_name()=="br")if(t.ie||d._4e_previous(w)||d._4e_next(w))d._4e_remove()}if(!this._.nextNode)this._.nextNode=b||l._4e_equals(f)?null:l._4e_nextSourceNode(true,null,f);return l}});B.prototype.createIterator=function(){return new s(this)}});
KISSY.Editor.add("selection",function(v){function s(f){this.document=f;this._={cache:{}};if(B.ie){var o=this.getNative().createRange();if(!o||o.item&&o.item(0).ownerDocument!=f||o.parentElement&&o.parentElement().ownerDocument!=f)this.isInvalid=true}}function y(f){f=new s(f);return!f||f.isInvalid?null:f}function t(f){var o=f.document,k=new c(o.body),a=new c(o.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)a.on("click",function(C){n._4e_name(C.target)==="html"&&f.getSelection().getRanges()[0].select()});
var e,p;k.on("focusin",function(C){if(C.target.nodeName.toUpperCase()=="BODY")if(e){try{e.select()}catch(H){}e=null}});k.on("focus",function(){p=true;z()});k.on("beforedeactivate",function(C){C.relatedTarget||(p=false)});B.ie<8&&r.on(n._4e_getWin(o),"blur",function(){o.selection.empty()});k.on("mousedown",x);k.on("mouseup",function(){p=true;setTimeout(function(){z(true)},0)});k.on("keydown",x);k.on("keyup",function(){p=true;z()});r.on(o,"selectionchange",z);var x=function(){p=false},z=function(C){if(p){var H=
f.document,N=f.getSelection(),A=N.getType(),D=N&&N.getNative();if(C&&D&&A==j.SELECTION_NONE)if(!H.queryCommandEnabled("InsertImage")){setTimeout(function(){z(true)},50);return}var I;if(!(D&&A==j.SELECTION_TEXT&&(I=n._4e_name(D.createRange().parentElement()))&&I in{input:1,textarea:1})){e=D&&N.getRanges()[0];f._monitor()}}}}else{r.on(o,"mouseup",f._monitor,f);r.on(o,"keyup",f._monitor,f)}}v.SELECTION={};var u=KISSY,B=u.UA,n=u.DOM,r=u.Event,i=v.Utils.tryThese,c=u.Node,j=v.SELECTION,m=v.RANGE,q=v.NODE,
g=v.Walker,l=v.Range;j.SELECTION_NONE=1;j.SELECTION_TEXT=2;j.SELECTION_ELEMENT=3;var w={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};u.augment(s,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=n._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var f=this._.cache;
if(f.type)return f.type;var o=j.SELECTION_NONE;try{var k=this.getNative(),a=k.type;if(a=="Text")o=j.SELECTION_TEXT;if(a=="Control")o=j.SELECTION_ELEMENT;if(k.createRange().parentElement)o=j.SELECTION_TEXT}catch(e){}return f.type=o}:function(){var f=this._.cache;if(f.type)return f.type;var o=j.SELECTION_TEXT,k=this.getNative();if(k){if(k.rangeCount==1){k=k.getRangeAt(0);var a=k.startContainer;if(a==k.endContainer&&a.nodeType==q.NODE_ELEMENT&&k.endOffset-k.startOffset===1&&w[a.childNodes[k.startOffset].nodeName.toLowerCase()])o=
j.SELECTION_ELEMENT}}else o=j.SELECTION_NONE;return f.type=o},getRanges:B.ie?function(){var f=function(o,k){o=o.duplicate();o.collapse(k);k=o.parentElement();for(var a=k.childNodes,e,p=0;p<a.length;p++){var x=a[p];if(x.nodeType==q.NODE_ELEMENT){e=o.duplicate();e.moveToElementText(x);x=e.compareEndPoints("StartToStart",o);var z=e.compareEndPoints("EndToStart",o);e.collapse();if(x>0)break;else if(!x||z==1&&x==-1)return{container:k,offset:p};else if(!z)return{container:k,offset:p+1};e=null}}if(!e){e=
o.duplicate();e.moveToElementText(k);e.collapse(false)}e.setEndPoint("StartToStart",o);o=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;o>0;)o-=a[--p].nodeValue.length}catch(C){o=0}return o===0?{container:k,offset:p}:{container:a[p],offset:-o}};return function(){var o=this._.cache;if(o.ranges)return o.ranges;var k=this.getNative(),a=k&&k.createRange(),e=this.getType();if(!k)return[];if(e==j.SELECTION_TEXT){k=new l(this.document);e=f(a,true);k.setStart(new c(e.container),e.offset);e=f(a);k.setEnd(new c(e.container),
e.offset);return o.ranges=[k]}else if(e==j.SELECTION_ELEMENT){o=this._.cache.ranges=[];for(e=0;e<a.length;e++){var p=a.item(e),x=p.parentNode,z=0;for(k=new l(this.document);z<x.childNodes.length&&x.childNodes[z]!=p;z++);k.setStart(new c(x),z);k.setEnd(new c(x),z+1);o.push(k)}return o}return o.ranges=[]}}():function(){var f=this._.cache;if(f.ranges)return f.ranges;var o=[],k=this.getNative();if(!k)return[];for(var a=0;a<k.rangeCount;a++){var e=k.getRangeAt(a),p=new l(this.document);p.setStart(new c(e.startContainer),
e.startOffset);p.setEnd(new c(e.endContainer),e.endOffset);o.push(p)}return f.ranges=o},getStartElement:function(){var f=this._.cache;if(f.startElement!==undefined)return f.startElement;var o,k=this.getNative();switch(this.getType()){case j.SELECTION_ELEMENT:return this.getSelectedElement();case j.SELECTION_TEXT:var a=this.getRanges()[0];if(a)if(!a.collapsed){for(a.optimize();;){o=a.startContainer;if(a.startOffset==(o[0].nodeType===q.NODE_ELEMENT?o[0].childNodes.length:o[0].nodeValue.length)&&!o._4e_isBlockBoundary())a.setStartAfter(o);
else break}o=a.startContainer;if(o[0].nodeType!=q.NODE_ELEMENT)return o.parent();o=new c(o[0].childNodes[a.startOffset]);if(!o[0]||o[0].nodeType!=q.NODE_ELEMENT)return a.startContainer;for(a=o[0].firstChild;a&&a.nodeType==q.NODE_ELEMENT;){o=new c(a);a=a.firstChild}return o}if(B.ie){a=k.createRange();a.collapse(true);o=a.parentElement()}else if((o=k.anchorNode)&&o.nodeType!=q.NODE_ELEMENT)o=o.parentNode}return f.startElement=o?new c(o):null},getSelectedElement:function(){var f=this._.cache;if(f.selectedElement!==
undefined)return f.selectedElement;var o=this,k=i(function(){return o.getNative().createRange().item(0)},function(){for(var a=o.getRanges()[0],e,p,x=2;x&&!((e=a.getEnclosedNode())&&e[0].nodeType==q.NODE_ELEMENT&&w[e._4e_name()]&&(p=e));x--)a.shrink(m.SHRINK_ELEMENT);return p[0]});return f.selectedElement=k?new c(k):null},reset:function(){this._.cache={}},selectElement:function(f){var o;if(B.ie)try{o=this.document.body.createControlRange();o.addElement(f[0]);o.select()}catch(k){o=this.document.body.createTextRange();
o.moveToElementText(f[0]);o.select()}finally{}else{o=this.document.createRange();o.selectNode(f[0]);f=this.getNative();f.removeAllRanges();f.addRange(o)}this.reset()},selectRanges:function(f){if(B.ie)f[0]&&f[0].select();else{var o=this.getNative();if(!o)return;o.removeAllRanges();for(var k=0;k<f.length;k++){var a=f[k],e=this.document.createRange(),p=a.startContainer;a.collapsed&&B.gecko&&B.gecko<1.09&&p[0].nodeType==q.NODE_ELEMENT&&!p[0].childNodes.length&&p[0].appendChild(this.document.createTextNode(""));
e.setStart(p[0],a.startOffset);e.setEnd(a.endContainer[0],a.endOffset);o.addRange(e)}}this.reset()},createBookmarks2:function(f){for(var o=[],k=this.getRanges(),a=0;a<k.length;a++)o.push(k[a].createBookmark2(f));return o},createBookmarks:function(f){for(var o=[],k=this.getRanges(),a=k.length,e=this.document,p,x=0;x<a;x++){o.push(p=k[x].createBookmark(f,true));var z=(f=p.serializable)?u.one("#"+p.startNode,e):p.startNode;p=f?u.one("#"+p.endNode,e):p.endNode;for(var C=x+1;C<a;C++){var H=k[C],N=H.startContainer,
A=H.endContainer;n._4e_equals(N,z.parent())&&H.startOffset++;n._4e_equals(N,p.parent())&&H.startOffset++;n._4e_equals(A,z.parent())&&H.endOffset++;n._4e_equals(A,p.parent())&&H.endOffset++}}return o},selectBookmarks:function(f){for(var o=[],k=0;k<f.length;k++){var a=new l(this.document);a.moveToBookmark(f[k]);o.push(a)}this.selectRanges(o);return this},getCommonAncestor:function(){var f=this.getRanges();return f[0].startContainer._4e_commonAncestor(f[f.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
v.Selection=s;var b={table:1,tbody:1,tr:1},d=g.whitespaces(true),h=/\ufeff|\u00a0/;l.prototype.select=B.ie?function(f){var o=this.collapsed,k,a;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==q.NODE_ELEMENT){(new s(this.document)).selectElement(new c(e));return}}if(this.startContainer[0].nodeType==q.NODE_ELEMENT&&this.startContainer._4e_name()in b||this.endContainer[0].nodeType==q.NODE_ELEMENT&&
this.endContainer._4e_name()in b)this.shrink(q.NODE_ELEMENT,true);var p=this.createBookmark();e=p.startNode;var x;if(!o)x=p.endNode;p=this.document.body.createTextRange();p.moveToElementText(e[0]);p.moveStart("character",1);if(x){f=this.document.body.createTextRange();f.moveToElementText(x[0]);p.setEndPoint("EndToEnd",f);p.moveEnd("character",-1)}else{for(k=e[0].nextSibling;k&&!d(k);)k=k.nextSibling;k=!(k&&k.nodeValue&&k.nodeValue.match(h))&&(f||!e[0].previousSibling||e[0].previousSibling&&n._4e_name(e[0].previousSibling)==
"br");a=this.document.createElement("span");a.innerHTML="&#65279;";a=new c(a);n.insertBefore(a[0],e[0]);k&&n.insertBefore(this.document.createTextNode("\ufeff"),e[0])}this.setStartBefore(e);e._4e_remove();if(o){if(k){p.moveStart("character",-1);p.select();this.document.selection.clear()}else p.select();if(a){this.moveToPosition(a,m.POSITION_BEFORE_START);a._4e_remove()}}else{this.setEndBefore(x);x._4e_remove();p.select()}}:function(){var f=this.startContainer;this.collapsed&&f[0].nodeType==q.NODE_ELEMENT&&
!f[0].childNodes.length&&f[0].appendChild(this.document.createTextNode(""));var o=this.document.createRange();o.setStart(f[0],this.startOffset);try{o.setEnd(this.endContainer[0],this.endOffset)}catch(k){if(k.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);o.setEnd(this.endContainer[0],this.endOffset)}else throw k;}f=y(this.document).getNative();f.removeAllRanges();f.addRange(o)};v.on("instanceCreated",function(f){t(f.editor)})});
KISSY.Editor.add("styles",function(v){function s(E,F){for(var G in E)E[G]=E[G].replace(X,function(K,J){return F[J]})}function y(E,F){if(F){E=x.clone(E);s(E.attributes,F);s(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||S[F]?C.STYLE_BLOCK:R[F]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:E}}function t(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new N(E);for(var G=E.getRanges(),K=0;K<G.length;K++)F.call(this,G[K]);E.selectRanges(G)}function u(E,
F){var G=E.element;if(G=="*")G="span";F=new L(F.createElement(G));return B(F,E)}function B(E,F){var G=F._.definition;F=G.attributes;G=y.getStyleText(G);if(F)for(var K in F)E.attr(K,F[K]);if(G)E[0].style.cssText=G;return E}function n(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var K,J=E.document;K=G.getNextParagraph();){var P=u(this,J);j(K,P)}E.moveToBookmark(F)}function r(E,F,G){var K="",J="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(P,Q,T){Q&&(K=Q);T&&(J=T);return""});return K+E.replace(F,G)+J}function i(E,F){var G=E.html();G=r(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new L(E.firstChild);F._4e_remove()}else F.html(G);return F}function c(E){var F=[];r(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,K,J){return K+"</pre>"+J+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,K){F.push(K)});return F}function j(E,F){var G=F._4e_name=="pre",K=E._4e_name=="pre",J=!G&&K;if(G&&!K)F=i(E,F);else if(J)F=q(c(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&m(F)}function m(E){var F;if((F=E._4e_previousSourceNode(true,A.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=r(F.html(),/\n$/,"")+"\n\n"+r(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function q(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),K=0;K<E.length;K++){var J=E[K];J=J.replace(/(\r\n|\r)/g,"\n");J=r(J,/^[ \t]*\n/,"");J=r(J,/\n$/,"");J=r(J,/^[ \t]+|[ \t]+$/g,function(Q,T){return Q.length==1?"&nbsp;":T?" "+(new Array(Q.length)).join("&nbsp;"):(new Array(Q.length)).join("&nbsp;")+" "});J=J.replace(/\n/g,"<br>");J=J.replace(/[ \t]{2,}/g,function(Q){return(new Array(Q.length)).join("&nbsp;")+" "});var P=F._4e_clone();P.html(J);G.appendChild(P[0])}return G}
function g(E){var F=E.document;if(E.collapsed){F=u(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,K=this._.definition,J,P=v.XHTML_DTD[G]||(J=true,v.XHTML_DTD.span),Q=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var T=E.createBookmark(),da=T.startNode;T=T.endNode;for(var V=da,Z;V&&V[0];){var U=false;if(z._4e_equals(V,T)){V=null;U=true}else{var W=V[0].nodeType,ba=W==A.NODE_ELEMENT?V._4e_name():null;if(ba&&V.attr("_ke_bookmark")){V=V._4e_nextSourceNode(true);
continue}if(!ba||P[ba]&&(V._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(V))){var ca=V.parent();if(ca&&ca[0]&&((v.XHTML_DTD[ca._4e_name()]||v.XHTML_DTD.span)[G]||J)&&(!K.parentRule||K.parentRule(ca))){if(!Z&&(!ba||!v.XHTML_DTD.$removeEmpty[ba]||(V._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+
D.POSITION_IS_CONTAINED)){Z=new I(F);Z.setStartBefore(V)}if(W==A.NODE_TEXT||W==A.NODE_ELEMENT&&!V[0].childNodes.length){W=V;for(var $;!W[0].nextSibling&&($=W.parent(),P[$._4e_name()])&&($._4e_position(da)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule($));)W=$;Z.setEndAfter(W);W[0].nextSibling||(U=true)}}else U=true}else U=true;V=V._4e_nextSourceNode()}if(U&&Z&&!Z.collapsed){U=u(this,
F);for(W=Z.getCommonAncestor();U&&W&&U[0]&&W[0];){if(W._4e_name()==G){for(var aa in K.attributes)U.attr(aa)==W.attr(aa)&&U[0].removeAttribute(aa);for(var ea in K.styles)U._4e_style(ea)==W._4e_style(ea)&&U._4e_style(ea,"");if(!U._4e_hasAttributes()){U=null;break}}W=W.parent()}if(U){U[0].appendChild(Z.extractContents());a(this,U);Z.insertNode(U);U._4e_mergeSiblings();M.ie||U[0].normalize()}Z=null}}da._4e_remove();T._4e_remove();E.moveToBookmark(Q);E.shrink(H.SHRINK_TEXT)}}function l(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var K=new O(G.parent()),J,P=0,Q;P<K.elements.length&&(Q=K.elements[P]);P++){if(Q==K.block||Q==K.blockLimit)break;if(this.checkElementRemovable(Q)){var T=E.checkBoundaryOfElement(Q,H.END),da=!T&&E.checkBoundaryOfElement(Q,H.START);if(da||T){J=Q;J.match=da?"start":"end"}else{Q._4e_mergeSiblings();Q._4e_name()==this.element?o(this,Q):e(Q,f(this)[Q._4e_name()])}}}if(J&&J[0]){Q=G;for(P=0;;P++){T=K.elements[P];if(z._4e_equals(T,J))break;else if(T.match)continue;
else T=T._4e_clone();T[0].appendChild(Q[0]);Q=T}z[J.match=="start"?"insertBefore":"insertAfter"](Q[0],J[0])}}else{var V=F.endNode,Z=this;K=function(){for(var U=new O(G.parent()),W=new O(V.parent()),ba=null,ca=null,$=0;$<U.elements.length;$++){var aa=U.elements[$];if(aa==U.block||aa==U.blockLimit)break;if(Z.checkElementRemovable(aa))ba=aa}for($=0;$<W.elements.length;$++){aa=W.elements[$];if(aa==W.block||aa==W.blockLimit)break;if(Z.checkElementRemovable(aa))ca=aa}ca&&V._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
K();for(J=new L(G[0].nextSibling);J[0]!==V[0];){P=J._4e_nextSourceNode();if(J[0]&&J[0].nodeType==A.NODE_ELEMENT&&this.checkElementRemovable(J)){J._4e_name()==this.element?o(this,J):e(J,f(this)[J._4e_name()]);if(P[0].nodeType==A.NODE_ELEMENT&&P._4e_contains(G)){K();P=new L(G[0].nextSibling)}}J=P}}E.moveToBookmark(F)}function w(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,K,J){F[K]=J});return F}function b(E,F){typeof E=="string"&&(E=w(E));typeof F==
"string"&&(F=w(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function d(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function h(E){var F=E._AC;if(F)return F;F={};var G=0,K=E.attributes;if(K)for(var J in K){G++;F[J]=K[J]}if(K=y.getStyleText(E)){F.style||G++;F.style=K}F._length=G;return E._AC=
F}function f(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){x.isArray(G)||(G=[G]);for(var K=0;K<G.length;K++){var J=G[K],P,Q;if(typeof J=="string")P=J.toLowerCase();else{P=J.element?J.element.toLowerCase():E.element;Q=J.attributes}J=F[P]||(F[P]={});if(Q){J=J.attributes=J.attributes||[];for(var T in Q)J.push([T.toLowerCase(),Q[T]])}}}return F}function o(E,F){var G=E._.definition,K=x.mix(x.mix({},G.attributes),f(E)[F._4e_name()]);G=G.styles;var J=x.isEmptyObject(K)&&
x.isEmptyObject(G);for(var P in K)if(!((P=="class"||E._.definition.fullMatch)&&F.attr(P)!=k(P,K[P]))){J=J||!!F._4e_hasAttribute(P);F.removeAttr(P)}for(var Q in G)if(!(E._.definition.fullMatch&&F._4e_style(Q)!=k(Q,G[Q],true))){J=J||!!F._4e_style(Q);F._4e_style(Q,"")}J&&p(F)}function k(E,F,G){var K=new L("<span></span>");K[G?"_4e_style":"attr"](E,F);return K[G?"_4e_style":"attr"](E)}function a(E,F){for(var G=f(E),K=F.all(E.element),J=K.length;--J>=0;)o(E,new L(K[J]));for(var P in G)if(P!=E.element){K=
F.all(P);for(J=K.length-1;J>=0;J--){var Q=new L(K[J]);e(Q,G[P])}}}function e(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var K=F[G][0],J;if(J=E.attr(K)){var P=F[G][1];if(P===null||P.test&&P.test(J)||typeof P=="string"&&J==P)E[0].removeAttribute(K)}}p(E)}function p(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==A.NODE_ELEMENT&&z._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==A.NODE_ELEMENT&&z._4e_mergeSiblings(G)}}}var x=KISSY,z=x.DOM,
C=v.STYLE={},H=v.RANGE,N=v.Selection,A=v.NODE,D=v.POSITION,I=v.Range,L=x.Node,M=x.UA,O=v.ElementPath,S={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},R={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Y=/\s*(?:;\s*|$)/,X=/#\((.+?)\)/g;C.STYLE_BLOCK=1;C.STYLE_INLINE=2;C.STYLE_OBJECT=3;y.prototype={apply:function(E){t.call(this,E,false)},remove:function(E){t.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==C.STYLE_INLINE?
g:this.type==C.STYLE_BLOCK?n:this.type==C.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==C.STYLE_INLINE?l:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=h(G);if(G._length){for(var K in G)if(K!="_length"){var J=E.attr(K)||"";if(K=="style"?b(G[K],d(J,false)):G[K]==J){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
f(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){K=G[F][0];if(K=E.attr(K)){J=G[F][1];if(J===null||typeof J=="string"&&K==J||J.test&&J.test(K))return true}}}return false},checkActive:function(E){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var F=E.elements,G=0,K;G<F.length;G++){K=F[G];if(!(this.type==C.STYLE_INLINE&&(z._4e_equals(K,E.block)||z._4e_equals(K,E.blockLimit))))if(!(this.type==
C.STYLE_OBJECT&&!(K._4e_name()in R)))if(this.checkElementRemovable(K,true))return true}}return false}};y.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",K="";if(G.length)G=G.replace(Y,";");for(var J in F){var P=F[J],Q=(J+":"+P).replace(Y,";");if(P=="inherit")K+=Q;else G+=Q}if(G.length)G=d(G);G+=K;return E._ST=G};v.Style=y});
KISSY.Editor.add("bubbleview",function(){function v(i){v.superclass.constructor.apply(this,arguments);i.init&&i.init.call(this)}function s(i){i=r[i];if(!i.bubble)i.bubble=new v(i.cfg);return i.bubble}var y=KISSY.Editor,t=KISSY,u=t.Event,B=t.DOM,n=t.Node;if(!y.BubbleView){var r={};v.attach=function(i){var c=i.pluginInstance,j=i.pluginName;i=c.editor;var m=r[j];if(m){var q=m.cfg.func,g=r[j].bubble;i.on("selectionChange",function(l){l=l.path;var w=l.elements;if(l&&w)if(l=l.lastElement)if(l=q(l)){g=s(j);
g._selectedEl=l;g._plugin=c;g.show()}else if(g){g._selectedEl=g._plugin=null;g.hide()}});u.on(B._4e_getWin(i.document),"scroll blur",function(){g&&g.hide()});u.on(document,"click",function(){g&&g.hide()})}};v.register=function(i){r[i.pluginName]={cfg:i}};v.ATTRS={focusMgr:{value:false},draggable:{value:false}};t.extend(v,y.SimpleOverlay,{_createEl:function(){var i=(new n('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>')).appendTo(document.body);this.el=i;this.set("el",i)},show:function(){var i=
this._selectedEl,c=i._4e_getOffset(document);c.top+=i.height()+5;v.superclass.show.call(this,c)}});y.BubbleView=v}});
KISSY.Editor.add("button",function(){function v(u){v.superclass.constructor.call(this,u);this._init()}var s=KISSY.Editor,y=KISSY,t=y.Node;if(!s.TripleButton){v.ON="on";v.OFF="off";v.DISABLED="disabled";v.ON_CLASS="ke-triplebutton-on";v.OFF_CLASS="ke-triplebutton-off";v.DISABLED_CLASS="ke-triplebutton-disabled";v.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};y.extend(v,y.Base,{_init:function(){var u=this.get("container")[0]||this.get("container");this.el=new t("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));u.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var u=this.get("cls");u&&this.el.addClass(u)},_stateChange:function(u){this["_"+
u.newVal]();this._attachCls()},_action:function(u){this.fire(this.get("state")+"Click",u);this.fire("click",u);u.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});s.TripleButton=v}});
KISSY.Editor.add("clipboard",function(v){var s=KISSY.Editor,y=KISSY,t=y.Node,u=y.UA,B=s.Range,n=s.RANGE,r=y.Event;s.Paste||function(){function i(c){this.editor=c;this._init()}y.augment(i,{_init:function(){var c=this.editor;u.ie?r.on(c.document,"keydown",this._paste,this):r.on(c.document,"paste",this._paste,this)},_paste:function(c){if(!(c.type==="keydown"&&!(c.keyCode===86&&(c.ctrlKey||c.metaKey)))){var j=this,m=j.editor,q=m.document;if(j._running)c.halt();else{var g=m.getSelection();c=new B(q);var l=
new t(u.webkit?"<body></body>":"<div></div>",null,q);u.webkit&&l[0].appendChild(q.createTextNode("\u00a0"));q.body.appendChild(l[0]);l.css({position:"absolute",top:g.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});l.css("left","-1000px");var w=g.createBookmarks();c.setStartAt(l,n.POSITION_AFTER_START);c.setEndAt(l,n.POSITION_BEFORE_END);c.select(true);j._running=true;setTimeout(function(){l._4e_remove();var b;l=u.webkit&&(b=l._4e_first())&&b.hasClass("Apple-style-span")?
b:l;g.selectBookmarks(w);m.insertHtml(l.html());j._running=false},0)}}}});s.Paste=i}();v.addPlugin(function(){new s.Paste(v)})});
KISSY.Editor.add("color",function(v){function s(o){return("0"+o).slice(o.length-1,o.length+1)}function y(o){o=u.trim(o);if(o.charAt(0)=="#")o=o.substring(1);o=o.replace(/\s+/g,"");var k="";if(/^[0-9a-f]{3,3}$/i.test(o))k=o.replace(/[0-9a-f]/ig,function(e){return e+e});else{var a=o.match(j);if(a&&a[0])for(o=1;o<4;o++)k+=s(parseInt(a[o]).toString(16));else k=o}return"#"+k.toLowerCase()}for(var t=KISSY.Editor,u=KISSY,B=u.Node,n=u.Event,r=t.SimpleOverlay,i=t.Style,c=u.DOM,j=/^rgb\((\d+),(\d+),(\d+)\)$/i,
m="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),q={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},g={element:"span",styles:{"background-color":"#(color)"}},l="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
w={},b={},d=0;d<5;d++){l+="<tr>";for(var h=0;h<8;h++){var f=y(m[8*d+h]);l+="<td>";l+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+f+"'></span></a>";l+="</td>";w[f]=new i(g,{color:f});b[f]=new i(q,{color:f})}l+="</tr>"}w.inherit=new i(g,{color:"inherit"});b.inherit=new i(q,{color:"inherit"});l+="</table></div>";t.ColorSupport||function(){function o(a){o.superclass.constructor.call(this,a);this._init()}var k=t.TripleButton;o.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};u.extend(o,u.Base,{_init:function(){var a=this.get("editor").toolBarDiv;a=new k({container:a,title:this.get("title"),contentCls:this.get("contentCls")});a.on("offClick",this._showColors,this);this.el=a;t.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(a){var e=this;c._4e_ascendant(a.target,function(p){return p[0]===e.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(a){a.halt();var e=this.get("editor");a=a.target;if(c._4e_name(a)=="span"||c._4e_name(a)=="a"){a=new B(a);
if(a._4e_name()=="a")a=a.one("span");var p=this.get("styles");e.fire("save");a._4e_style("background-color")?p[y(a._4e_style("background-color"))].apply(e.document):p.inherit.remove(e.document);e.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(l);this.colorWin=new r({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);n.on(document,"click",this._hidePanel,this);n.on(v.document,
"click",this._hidePanel,this)},_real:function(){var a=this.el.el.offset();a.top+=this.el.el.height()+5;if(a.left+this.colorPanel.width()>c.viewportWidth()-60)a.left=c.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(a)},_showColors:function(a){this._prepare(a)}});t.ColorSupport=o}();v.addPlugin(function(){new t.ColorSupport({editor:v,styles:w,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new t.ColorSupport({editor:v,styles:b,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("contextmenu",function(){function v(c){this.cfg=t.clone(c);y.Utils.lazyRun(this,"_prepareShow","_realShow")}function s(c,j){for(var m=0;m<j.length;m++){var q=j[m];if(t.isFunction(q)){if(q(new u(c)))return true}else if(B.test(c,q))return true}return false}var y=KISSY.Editor,t=KISSY,u=t.Node,B=t.DOM,n=t.Event;if(!y.ContextMenu){var r=[];v.register=function(c,j){var m=new v(j);r.push({doc:c,rules:j.rules||[],instance:m});if(!c.ke_contextmenu){c.ke_contextmenu=1;n.on(c,"mousedown",v.hide);
n.on(c,"contextmenu",function(q){v.hide.call(this);for(var g=new u(q.target);g;){var l=false;if(g._4e_name()=="body")break;for(var w=0;w<r.length;w++){var b=r[w].instance,d=r[w].rules;if(c===r[w].doc&&s(g[0],d)){q.preventDefault();l=true;setTimeout(function(){b.show(y.Utils.getXY(q.pageX,q.pageY,c,document))},30);break}}if(l)break;g=g.parent()}})}return m};v.hide=function(){for(var c=0;c<r.length;c++){var j=r[c].instance;this===r[c].doc&&j.hide()}};var i=y.SimpleOverlay;t.augment(v,{_init:function(){var c=
this,j=c.cfg,m=j.funcs;c.elDom=new u("<div class='ke-menu' onmousedown='return false;'></div>");var q=c.elDom;q.css("width",j.width);document.body.appendChild(q[0]);c.el=new i({el:q});for(var g in m){j=new u("<a href='#'>"+g+"</a>");q[0].appendChild(j[0]);(function(l,w){l._4e_unselectable();l.on("click",function(b){c.hide();b.halt();setTimeout(w,30)})})(j,m[g])}},hide:function(){this.el&&this.el.hide()},_realShow:function(c){this.el.show(c)},_prepareShow:function(){this._init()},show:function(c){this._prepareShow(c)}});
y.ContextMenu=v}});
KISSY.Editor.add("dd",function(){function v(){v.superclass.constructor.apply(this,arguments);this._init()}function s(){s.superclass.constructor.apply(this,arguments);this._init()}function y(){y.superclass.constructor.apply(this,arguments)}var t=KISSY,u=t.Editor,B=t.Event,n=t.DOM,r=t.Node;if(!u.DD){u.DD={};v.ATTRS={timeThred:{},activeDrag:{},drags:{value:{}}};t.extend(v,t.Base,{_init:function(){u.Utils.lazyRun(this,"_prepare","_real")},reg:function(c){var j=this.get("drags");if(!c[0].id)c[0].id=t.guid("drag-");
j[c[0].id]=c;this._prepare()},_move:function(c){var j=this.get("activeDrag");j&&j._move(c)},_start:function(c){this.set("activeDrag",c);this._pg.css({display:"",height:n.docHeight()})},_end:function(c){var j=this.get("activeDrag");if(j){j._end(c);this.set("activeDrag",null);this._pg.css({display:"none"})}},_prepare:function(){this._pg=(new r("<div style='background-color:red;position:absolute;left:0;width:100%;top:0;z-index:9999;'></div>")).appendTo(document.body);this._pg.css("opacity",0);B.on(document,
"mousemove",u.Utils.throttle(this._move,this,10));B.on(document,"mouseup",this._end,this)},_real:function(){}});u.DD.DDM=new v;var i=u.DD.DDM;s.ATTRS={node:{},handlers:{value:{}}};t.extend(s,t.Base,{_init:function(){var c=this.get("node"),j=this.get("handlers");i.reg(c);if(t.isEmptyObject(j))j[c[0].id]=c;for(var m in j)if(j.hasOwnProperty(m)){var q=j[m],g=q.css("cursor");if(!g||g==="auto")q.css("cursor","move");q._4e_unselectable()}c.on("mousedown",this._handleMouseDown,this);c.on("mouseup",function(){i._end()})},
_check:function(c){var j=this.get("handlers");for(var m in j)if(j.hasOwnProperty(m))if(j[m]._4e_equals(c))return true;return false},_handleMouseDown:function(c){if(this._check(new r(c.target))){c.halt();i._start(this);var j=this.get("node"),m=c.pageX;c=c.pageY;j=j.offset();this.startMousePos={left:m,top:c};this.startNodePos=j;this._diff={left:m-j.left,top:c-j.top};this.fire("start")}},_move:function(c){this.fire("move",c)},_end:function(){}});t.extend(y,s,{_init:function(){y.superclass._init.apply(this,
arguments);var c=this.get("node"),j=this;j.on("move",function(m){c.offset({left:m.pageX-j._diff.left,top:m.pageY-j._diff.top})})}});u.Draggable=s;u.Drag=y}});
KISSY.Editor.add("draft",function(v){var s=KISSY,y=s.Editor;y.Draft||function(){function t(c,j,m){for(c+="";c.length<j;)c=m+c;return c}function u(c){if(s.isNumber(c))c=new Date(c);return c instanceof Date?[c.getFullYear(),"-",t(c.getMonth()-1,2,"0"),"-",t(c.getDay(),2,"0")," ",t(c.getHours(),2,"0"),":",t(c.getMinutes(),2,"0"),":",t(c.getSeconds(),2,"0")].join(""):c}function B(c){this.editor=c;this._init()}var n=s.Node,r=s.JSON,i=window[y.STORE];s.augment(B,{_init:function(){var c=this,j=c.editor,
m=j.statusDiv;m=(new n("<div style='position:absolute;right:30px;bottom:0;width:600px'><span style=' vertical-align:middle;'>\u5185\u5bb9\u6b63\u6587\u6bcf5\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(m);c.timeTip=(new n("<span style=' vertical-align:middle;margin:0 10px;'>")).appendTo(m);j=new y.Select({container:m,doc:j.document,width:"100px",popUpWidth:"220px",title:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"});m=new y.TripleButton({text:"\u7acb\u5373\u4fdd\u5b58",
title:"\u7acb\u5373\u4fdd\u5b58",container:m});var q=i.getItem("ke-draft-save"),g=[];c.versions=j;if(q)g=s.isString(q)?r.parse(decodeURIComponent(q)):q;c.drafts=g;c.sync();m.on("click",function(){c.save(false)});setInterval(function(){c.save(true)},3E5);j.on("click",c.recover,c)},sync:function(){var c=this.timeTip,j=this.versions,m=this.drafts;m.length>5&&m.splice(0,m.length-5);for(var q=[],g,l=0;l<m.length;l++){g=m[l];g=(g.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e\uff1a"+u(g.date);
q.push({name:g,value:l})}j.set("items",q.reverse());c.html(g);i.setItem("ke-draft-save",encodeURIComponent(r.stringify(m)))},save:function(c){var j=this.drafts,m=v._getRawData();if(j[j.length-1]&&m==j[j.length-1].content)j.length-=1;this.drafts=j.concat({content:m,date:(new Date).getTime(),auto:c});this.sync()},recover:function(c){var j=this.editor,m=this.drafts;c=c.newVal;this.versions.reset("value");confirm("\u786e\u8ba4\u6062\u590d "+u(m[c].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")&&j._setRawData(m[c].content)}});
y.Draft=B}();v.addPlugin(function(){y.storeReady(function(){new y.Draft(v)})})});
KISSY.Editor.add("elementpaths",function(v){var s=KISSY.Editor,y=KISSY,t=y.Node,u=y.DOM;s.ElementPaths||function(){function B(n){this.cfg=n;this._cache=[];this._init()}y.augment(B,{_init:function(){var n=this.cfg.editor;this.holder=new t("<span>");this.holder.appendTo(n.statusDiv);n.on("selectionChange",this._selectionChange,this)},_selectionChange:function(n){var r=this.cfg.editor,i=this.holder;i=i[0]||i;n=n.path.elements;var c,j;c=this._cache;for(j=0;j<c.length;j++){c[j].detach("click");c[j]._4e_remove()}this._cache=
[];for(j=0;j<n.length;j++){c=n[j];var m=new t("<a href='#' class='elementpath'>"+(c.attr("_ke_real_element_type")||c._4e_name())+"</a>");this._cache.push(m);(function(q){m.on("click",function(g){g.halt();r.focus();setTimeout(function(){r.getSelection().selectElement(q)},50)})})(c);i.firstChild?u.insertBefore(m[0],i.firstChild):i.appendChild(m[0])}}});s.ElementPaths=B}();v.addPlugin(function(){new s.ElementPaths({editor:v})})});
KISSY.Editor.add("enterkey",function(v){var s=KISSY.Editor,y=KISSY,t=y.UA,u=/^h[1-6]$/,B=s.XHTML_DTD,n=y.Node,r=y.Event,i=s.Walker,c=s.ElementPath;s.enterBlock||function(){function j(g){g=g.getSelection().getRanges();for(var l=g.length-1;l>0;l--)g[l].deleteContents();return g[0]}function m(g){var l=j(g),w=l.document;if(l.checkStartOfBlock()&&l.checkEndOfBlock()){var b=(new c(l.startContainer)).block;if(b&&(b._4e_name()=="li"||b.parent()._4e_name()=="li")){g.execCommand("outdent");return}}var d=l.splitBlock("p");
if(d){g=d.previousBlock;b=d.nextBlock;var h=d.wasStartOfBlock,f=d.wasEndOfBlock,o;if(b){o=b.parent();if(o._4e_name()=="li"){b._4e_breakParent(o);b._4e_move(b._4e_next(),true)}}else if(g&&(o=g.parent())&&o._4e_name()=="li"){g._4e_breakParent(o);l.moveToElementEditablePosition(g._4e_next());g._4e_move(g._4e_previous())}if(!h&&!f){if(b._4e_name()=="li"&&(o=b._4e_first(i.invisible(true)))&&y.inArray(o._4e_name(),["ul","ol"]))(t.ie?new n(w.createTextNode("\u00a0")):new n(w.createElement("br"))).insertBefore(o);
b&&l.moveToElementEditablePosition(b)}else{var k;if(g){if(g._4e_name()=="li"||!u.test(g._4e_name()))k=g._4e_clone()}else if(b)k=b._4e_clone();k||(k=new n("p",null,w));if(o=d.elementPath){d=0;for(var a=o.elements.length;d<a;d++){var e=o.elements[d];if(e._4e_equals(o.block)||e._4e_equals(o.blockLimit))break;if(B.$removeEmpty[e._4e_name()]){e=e._4e_clone();k._4e_moveChildren(e);k.append(e)}}}t.ie||k._4e_appendBogus();l.insertNode(k);if(t.ie&&h&&(!f||!g[0].childNodes.length)){l.moveToElementEditablePosition(f?
g:k);l.select()}l.moveToElementEditablePosition(h&&!f?b:k)}if(!t.ie)if(b){w=new n(w.createElement("span"));w.html("&nbsp;");l.insertNode(w);w._4e_scrollIntoView();l.deleteContents()}else k._4e_scrollIntoView();l.select()}}function q(g){r.on(g.document,"keydown",function(l){if(l.keyCode===13)if(!l.shiftKey){g.execCommand("enterBlock");l.preventDefault()}})}q.enterBlock=m;s.EnterKey=q}();v.addPlugin(function(){v.addCommand("enterBlock",{exec:s.EnterKey.enterBlock});s.EnterKey(v)})});
KISSY.Editor.add("fakeobjects",function(v){var s=KISSY.Editor,y=KISSY,t=y.Node,u=s.NODE,B=s.Config.base+"theme/spacer.gif",n=s.HtmlParser;s=y.Editor;var r=(v=v.htmlDataProcessor)&&v.htmlFilter,i={elements:{$:function(c){var j=c.attributes;if((j=(j=(j=j&&j._ke_realelement)&&new n.Fragment.FromHtml(decodeURIComponent(j)))&&j.children[0])&&c.attributes._ke_resizable){var m=c.attributes.style;if(m){var q=/(?:^|\s)width\s*:\s*(\d+)/i.exec(m);c=q&&q[1];m=(q=/(?:^|\s)height\s*:\s*(\d+)/i.exec(m))&&q[1];
if(c)j.attributes.width=c;if(m)j.attributes.height=m}}return j}}};r&&r.addRules(i);v&&y.mix(v,{createFakeParserElement:function(c,j,m,q,g){var l;l=new n.BasicWriter;c.writeHtml(l);l=l.getHtml();var w=c.attributes.style;if(c.attributes.width)w="width:"+c.attributes.width+"px;"+w;if(c.attributes.height)w="height:"+c.attributes.height+"px;"+w;c={"class":j,src:B,_ke_realelement:encodeURIComponent(l),_ke_real_node_type:c.type,style:w,align:c.attributes.align||""};g&&delete g.width;g&&delete g.height;g&&
y.mix(c,g,false);if(m)c._ke_real_element_type=m;if(q)c._ke_resizable=q;return new n.Element("img",c)}});y.augment(s,{createFakeElement:function(c,j,m,q,g,l){var w=c.attr("style")||"";if(c.attr("width"))w="width:"+c.attr("width")+"px;"+w;if(c.attr("height"))w="height:"+c.attr("height")+"px;"+w;c={"class":j,src:B,_ke_realelement:encodeURIComponent(g||c._4e_outerHtml()),_ke_real_node_type:c[0].nodeType,align:c.attr("align")||"",style:w};l&&delete l.width;l&&delete l.height;l&&y.mix(c,l,false);if(m)c._ke_real_element_type=
m;if(q)c._ke_resizable=q;return new t("<img/>",c,this.document)},restoreRealElement:function(c){if(c.attr("_ke_real_node_type")!=u.NODE_ELEMENT)return null;c=decodeURIComponent(c.attr("_ke_realelement"));var j=new t("<div>",null,this.document);j.html(c);return j._4e_first(function(m){return m[0].nodeType==u.NODE_ELEMENT})._4e_remove()}})});KISSY.Editor.add("flash",function(v){v.addPlugin(function(){new KISSY.Editor.Flash(v)})});
KISSY.Editor.add("flashsupport",function(v){var s=KISSY.Editor,y=KISSY,t=y.UA,u=y.Event,B=s.ContextMenu,n=y.Node,r=s.BubbleView,i=s.TripleButton,c=s.SimpleOverlay,j=v.htmlDataProcessor,m="ke_flash",q=s.Utils.flash;v=j&&j.dataFilter;s.Flash||function(){function g(h){this.editor=h;this._init()}function l(h){return h._4e_name()==="img"&&!!h.hasClass(m)&&h}var w=/\.swf(?:$|\?)/i,b="<p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p><p style='margin:5px 0'><label>\u5bf9\u9f50\uff1a <select class='ke-flash-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
s.Utils.duplicateStr("&nbsp;",13)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-flash-margin' style='width:90px' value='5'/> px</label><p>";g.isFlashEmbed=function(h){h=h.attributes;return h.type=="application/x-shockwave-flash"||w.test(h.src||"")};y.augment(g,{_config:function(){this._cls=m;this._type="flash";this._title="Flash\u5c5e\u6027";this._bodyHtml=b;this._footHtml="<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button>";this._contentCls=
"ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=d;this._flashRules=["img."+m]},_init:function(){this._config();var h=this.editor,f={},o=this._contextMenu;h._toolbars=h._toolbars||{};h._toolbars[this._type]=this;this.el=new i({container:h.toolBarDiv,contentCls:this._contentCls,title:this._tip});this.el.on("click",this.show,this);if(o)for(var k in o)(function(a){f[a]=function(){o[a](h)}})(k);B.register(h.document,{rules:this._flashRules,width:"120px",funcs:f});r.attach({pluginName:this._type,
pluginInstance:this});u.on(h.document,"dblclick",this._dbclick,this);s.Utils.lazyRun(this,"_prepareShow","_realShow")},_getFlashUrl:function(h){return q.getUrl(h)},_updateTip:function(h,f){f=this.editor.restoreRealElement(f);h.html(this._getFlashUrl(f));h.attr("href",this._getFlashUrl(f))},_dbclick:function(h){var f=new n(h.target);if(f._4e_name()==="img"&&f.hasClass(this._cls)){this.show(null,f);h.halt()}},_prepareShow:function(){var h=new c({title:this._title,width:this._config_dwidth||"350px",
mask:true});h.body.html(this._bodyHtml);h.foot.html(this._footHtml);this.d=h;this._initD()},_realShow:function(){this._updateD();this.d.show()},_updateD:function(){var h=this.editor,f=this.selectedFlash;if(f){h=h.restoreRealElement(f);h.attr("width")&&this.dWidth.val(parseInt(h.attr("width")));h.attr("height")&&this.dHeight.val(parseInt(h.attr("height")));this.dAlign.val(h.attr("align"));this.dUrl.val(this._getFlashUrl(h));this.dMargin.val(parseInt(h._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");
this.dWidth.val("");this.dHeight.val("");this.dAlign.val("");this.dMargin.val("5")}},show:function(h,f){this.selectedFlash=f;this._prepareShow()},_initD:function(){var h=this,f=h.d;h.dHeight=f.el.one(".ke-flash-height");h.dWidth=f.el.one(".ke-flash-width");h.dUrl=f.el.one(".ke-flash-url");h.dAlign=f.el.one(".ke-flash-align");h.dMargin=f.el.one(".ke-flash-margin");var o=f.el.one(".ke-flash-ok");f=f.el.one(".ke-flash-cancel");o.on("click",h._gen,h);f.on("click",function(){h.d.hide()})},_getDInfo:function(){return{url:this.dUrl.val(),
attrs:{width:this.dWidth.val(),height:this.dHeight.val(),align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px"}}},_gen:function(){var h=this.editor,f=this._getDInfo(),o=f&&y.trim(f.url);f=f&&f.attrs;if(o){o=q.createSWF(o,{attrs:f},h.document);var k=o.el;f=h.createFakeElement?h.createFakeElement(k,this._cls,this._type,true,o.html,f):k;f=h.insertElement(f);this.selectedFlash&&h.getSelection().selectElement(f);this.d.hide()}}});s.Flash=g;g.registerBubble=function(h,f,o){r.register({pluginName:h,
func:o,init:function(){var k=this,a=k.el;a.html(f+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');var e=a.one(".ke-bubbleview-url"),p=a.one(".ke-bubbleview-change");a=a.one(".ke-bubbleview-remove");p._4e_unselectable();e._4e_unselectable();a._4e_unselectable();p.on("click",function(x){k._plugin.show(null,k._selectedEl);x.halt()});
a.on("click",function(x){var z=k._plugin;if(t.webkit){var C=z.editor.getSelection().getRanges();C&&C[0]&&(C[0].collapse(true)||1)&&C[0].select()}k._selectedEl._4e_remove();k.hide();z.editor.notifySelectionChange();x.halt()});k.on("beforeVisibleChange",function(x){var z=k._selectedEl;x.newVal&&z&&k._plugin._updateTip(e,z)})}})};g.registerBubble("flash","Flash \u7f51\u5740\uff1a ",l);g.checkFlash=l;var d={"Flash\u5c5e\u6027":function(h){var f=h.getSelection();f=f&&f.getStartElement();f=l(f);h=h._toolbars.flash;
f&&h.show(null,f)}};g.CLS_FLASH=m;g.TYPE_FLASH="flash"}();v&&v.addRules({elements:{object:function(g){var l=g.attributes;if(!(l.classid&&String(l.classid).toLowerCase())){for(l=0;l<g.children.length;l++)if(g.children[l].name=="embed"){if(!s.Flash.isFlashEmbed(g.children[l]))return null;return j.createFakeParserElement(g,m,"flash",true)}return null}return j.createFakeParserElement(g,m,"flash",true)},embed:function(g){if(!s.Flash.isFlashEmbed(g))return null;return j.createFakeParserElement(g,m,"flash",
true)}}},5)});
KISSY.Editor.add("flashutils",function(){var v=KISSY,s=v.Editor,y=s.Utils.flash;if(!y){var t=v.DOM,u=v.Node,B=v.UA;y={getUrl:function(n){var r="",i=s.NODE;if(n._4e_name()=="object"){n=n[0].childNodes;for(var c=0;c<n.length;c++)if(n[c].nodeType==i.NODE_ELEMENT)if((t.attr(n[c],"name")||"").toLowerCase()=="movie")r=t.attr(n[c],"value");else if(t._4e_name(n[c])=="embed")r=t.attr(n[c],"src");else if(t._4e_name(n[c])=="object")r=t.attr(n[c],"data")}else if(n._4e_name()=="embed")r=n.attr("src");return r},
createSWF:function(n,r,i){var c=r.attrs;r=r.flashVars;var j="",m="";i=i||document;if(c)for(var q in c)j+=q+"='"+c[q]+"' ";if(r){for(var g in r)m+="&"+g+"="+encodeURIComponent(r[g]);m=m.substring(1)}n="<object "+j+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" <param name="quality" value="high" /><param name="movie" value="'+n+'" />'+(m?'<param name="flashVars" value="'+m+'"/>':"")+"<object type='application/x-shockwave-flash' data='"+n+"' "+j+">"+(m?'<param name="flashVars" value="'+m+'"/>':
"")+ +"</object>"+"</object>";return{el:new u(n,null,i),html:n}},createSWFRuntime2:function(n,r,i){i=i||document;var c=(new u("<div style='width:0;height:0;overflow:hidden;'>",null,i)).appendTo(i.body);c=y.createSWF.apply(this,arguments).el.appendTo(c);B.ie||(c=c.one("object"));return c[0]},createSWFRuntime:function(n,r,i){var c=r.attrs;r=r.flashVars;var j="",m="";i=i||document;c=c||{};c.id=v.guid("ke-localstorage-");for(var q in c)j+=q+"='"+c[q]+"' ";if(r){for(var g in r)m+="&"+g+"="+encodeURIComponent(r[g]);
m=m.substring(1)}n=B.ie?"<object "+j+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" <param name="quality" value="high" /><param name="movie" value="'+n+'" />'+(m?'<param name="flashVars" value="'+m+'"/>':"")+"</object>":"<object type='application/x-shockwave-flash' data='"+n+"' "+j+">"+(m?'<param name="flashVars" value="'+m+'"/>':"")+ +"</object>";(new u("<div style='width:0;height:0;overflow:hidden;'>",null,i)).appendTo(i.body).html(n);return i.getElementById(c.id)}};s.Utils.flash=y}});
KISSY.Editor.add("font",function(v){var s=KISSY.Editor,y=KISSY,t=s.Style,u=s.TripleButton,B=v.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],n={},r=[],i={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},c=v.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],j={},m=[],q={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},g;v.cfg.pluginConfig["font-size"]=B;v.cfg.pluginConfig["font-family"]=c;for(g=0;g<B.length;g++){var l=B[g];n[l]=new t(i,{size:l});r.push({name:l,value:l})}for(g=0;g<c.length;g++){B=c[g];j[B]=new t(q,{family:B});m.push({name:B,value:B,attrs:{style:"font-family:"+B}})}s.Font||function(){function w(d){w.superclass.constructor.call(this,d);this._init()}function b(d){b.superclass.constructor.call(this,
d);this._init()}w.ATTRS={title:{},html:{},styles:{},editor:{}};y.extend(w,y.Base,{_init:function(){var d=this.get("editor"),h=d.toolBarDiv;this.get("html");this.el=new s.Select({container:h,doc:d.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);d.on("selectionChange",this._selectionChange,this)},_vChange:function(d){var h=this.get("editor"),f=d.newVal;d=d.preVal;var o=this.get("styles");h.focus();
h.fire("save");if(f==d){o[f].remove(h.document);this.el.set("value","")}else o[f].apply(h.document);h.fire("save")},_selectionChange:function(d){this.get("editor");d=d.path.elements;for(var h=this.get("styles"),f=0,o;f<d.length;f++){o=d[f];for(var k in h)if(h[k].checkElementRemovable(o,true)){this.el.set("value",k);return}}this.el.reset("value")}});b.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};y.extend(b,y.Base,{_init:function(){var d=this.get("editor"),h=this.get("text");this.get("style");
var f=this.get("title");this.el=new u({text:h,title:f,contentCls:this.get("contentCls"),container:d.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);d.on("selectionChange",this._selectionChange,this)},_on:function(){var d=this.get("editor");this.get("text");var h=this.get("style");this.get("title");d.fire("save");h.apply(d.document);d.fire("save");d.notifySelectionChange();d.focus()},_off:function(){var d=this.get("editor");this.get("text");var h=this.get("style");
this.get("title");d.fire("save");h.remove(d.document);d.fire("save");d.notifySelectionChange();d.focus()},_selectionChange:function(d){this.get("editor");this.get("text");var h=this.get("style");this.get("title");h.checkActive(d.path)?this.el.set("state",u.ON):this.el.set("state",u.OFF)}});w.SingleFont=b;s.Font=w}();v.addPlugin(function(){new s.Font({editor:v,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:n,html:r});new s.Font({editor:v,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:j,html:m});new s.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:v,style:new t({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:v,style:new t({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:v,style:new t({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:v,style:new t({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(v){var s=KISSY.Editor,y=KISSY,t=[],u={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},B={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},n={},r=s.Style;for(var i in u)if(u[i]){n[u[i]]=new r({element:u[i]});t.push({name:i,value:u[i],attrs:{style:"font-size:"+B[u[i]]}})}s.Format||function(){function c(j){c.superclass.constructor.call(this,
j);this._init()}c.ATTRS={editor:{}};y.extend(c,y.Base,{_init:function(){var j=this.get("editor");this.el=new s.Select({container:j.toolBarDiv,value:"",doc:j.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);j.on("selectionChange",this._selectionChange,this)},_vChange:function(j){var m=this.get("editor"),q=j.newVal;j=j.preVal;m.fire("save");if(q!=j)n[q].apply(m.document);else{n.p.apply(m.document);
this.el.set("value","p")}m.fire("save")},_selectionChange:function(j){this.get("editor");j=j.path;for(var m in n)if(n[m].checkActive(j)){this.el.set("value",m);return}this.el.reset("value")}});s.Format=c}();v.addPlugin(function(){new s.Format({editor:v,html:t,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function v(){this._={output:[]}}var s=KISSY.Editor,y=s.Utils;if(!s.HtmlParser.BasicWriter){KISSY.augment(v,{openTag:function(t){this._.output.push("<",t)},openTagClose:function(t,u){u?this._.output.push(" />"):this._.output.push(">")},attribute:function(t,u){if(typeof u=="string")u=y.htmlEncodeAttr(u);this._.output.push(" ",t,'="',u,'"')},closeTag:function(t){this._.output.push("</",t,">")},text:function(t){this._.output.push(t)},comment:function(t){this._.output.push("<!--",
t,"--\>")},write:function(t){this._.output.push(t)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(t){var u=this._.output.join("");t&&this.reset();return u}});s.HtmlParser.BasicWriter=v}});
KISSY.Editor.add("htmlparser-comment",function(){function v(t){this.value=t;this._={isBlockLike:false}}var s=KISSY.Editor,y=s.NODE;if(!s.HtmlParser.Comment){s.HtmlParser.Comment=v;v.prototype={constructor:v,type:y.NODE_COMMENT,writeHtml:function(t,u){var B=this.value;if(u){if(!(B=u.onComment(B,this)))return;if(typeof B!="string"){B.parent=this.parent;B.writeHtml(t,u);return}}t.comment(B)}}}});
KISSY.Editor.add("htmlparser-element",function(){function v(u,B){this.name=u;this.attributes=B||(B={});this.children=[];var n=B._ke_real_element_type||u;B=s.XHTML_DTD;n=!!(B.$nonBodyContent[n]||B.$block[n]||B.$listItem[n]||B.$tableContent[n]||B.$nonEditable[n]||n=="br");var r=!!B.$empty[u];this.isEmpty=r;this.isUnknown=!B[u];this._={isBlockLike:n,hasInlineStarted:r||!n}}var s=KISSY.Editor;if(!s.HtmlParser.Element){var y=s.NODE,t=function(u,B){u=u[0];B=B[0];return u<B?-1:u>B?1:0};KISSY.augment(v,{type:y.NODE_ELEMENT,
add:s.HtmlParser.Fragment.prototype.add,clone:function(){return new v(this.name,this.attributes)},writeHtml:function(u,B){var n=this.attributes,r=this,i=r.name,c,j,m,q;r.filterChildren=function(){if(!q){var w=new s.HtmlParser.BasicWriter;s.HtmlParser.Fragment.prototype.writeChildrenHtml.call(r,w,B);r.children=(new s.HtmlParser.Fragment.FromHtml(w.getHtml())).children;q=1}};if(B){for(;;){if(!(i=B.onElementName(i)))return;r.name=i;if(!(r=B.onElement(r)))return;r.parent=this.parent;if(r.name==i)break;
if(r.type!=y.NODE_ELEMENT){r.writeHtml(u,B);return}i=r.name;if(!i){this.writeChildrenHtml.call(r,u,q?null:B);return}}n=r.attributes}u.openTag(i,n);for(var g=[],l=0;l<2;l++)for(c in n){j=c;m=n[c];if(l==1)g.push([c,m]);else if(B){for(;;)if(j=B.onAttributeName(c))if(j!=c){delete n[c];c=j}else break;else{delete n[c];break}if(j)if((m=B.onAttribute(r,j,m))===false)delete n[j];else n[j]=m}}u.sortAttributes&&g.sort(t);n=g.length;for(l=0;l<n;l++){c=g[l];u.attribute(c[0],c[1])}u.openTagClose(i,r.isEmpty);if(!r.isEmpty){this.writeChildrenHtml.call(r,
u,q?null:B);u.closeTag(i)}},writeChildrenHtml:function(){s.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});s.HtmlParser.Element=v}});
KISSY.Editor.add("htmlparser-filter",function(){function v(i){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};i&&this.addRules(i,10)}function s(i,c){for(var j=0;i&&j<c.length;j++){var m=c[j];i=i.replace(m[0],m[1])}return i}function y(i,c,j){if(typeof c=="function")c=[c];var m,q;q=i.length;var g=c&&c.length;if(g){for(m=0;m<q&&i[m].pri<j;m++);for(q=g-1;q>=0;q--)if(g=c[q]){g.pri=j;i.splice(m,0,g)}}}function t(i,c,j){if(c)for(var m in c){var q=i[m];i[m]=u(q,c[m],
j);q||i.$length++}}function u(i,c,j){if(c){c.pri=j;if(i){if(i.splice)y(i,c,j);else{i=i.pri>j?[c,i]:[i,c];i.filter=B}return i}else return c.filter=c}}function B(i){for(var c=i.type||i instanceof n.HtmlParser.Fragment,j=0;j<this.length;j++){if(c)var m=i.type,q=i.name;var g=this[j].apply(window,arguments);if(g===false)return g;if(c){if(g&&(g.name!=q||g.type!=m))return g}else if(typeof g!="string")return g;g!=undefined&&(i=g)}return i}var n=KISSY.Editor,r=n.NODE;if(!n.HtmlParser.Filter){KISSY.augment(v,
{addRules:function(i,c){if(typeof c!="number")c=10;y(this._.elementNames,i.elementNames,c);y(this._.attributeNames,i.attributeNames,c);t(this._.elements,i.elements,c);t(this._.attributes,i.attributes,c);this._.text=u(this._.text,i.text,c)||this._.text;this._.comment=u(this._.comment,i.comment,c)||this._.comment;this._.root=u(this._.root,i.root,c)||this._.root},onElementName:function(i){return s(i,this._.elementNames)},onAttributeName:function(i){return s(i,this._.attributeNames)},onText:function(i){var c=
this._.text;return c?c.filter(i):i},onComment:function(i,c){var j=this._.comment;return j?j.filter(i,c):i},onFragment:function(i){var c=this._.root;return c?c.filter(i):i},onElement:function(i){for(var c=[this._.elements["^"],this._.elements[i.name],this._.elements.$],j,m=0;m<3;m++)if(j=c[m]){j=j.filter(i,this);if(j===false)return null;if(j&&j!=i)return this.onNode(j);if(i.parent&&!i.name)break}return i},onNode:function(i){var c=i.type;return c==r.NODE_ELEMENT?this.onElement(i):c==r.NODE_TEXT?new n.HtmlParser.Text(this.onText(i.value)):
null},onAttribute:function(i,c,j){if(c=this._.attributes[c]){i=c.filter(j,i,this);if(i===false)return false;if(typeof i!="undefined")return i}return j}});n.HtmlParser.Filter=v}});
KISSY.Editor.add("htmlparser-fragment",function(){function v(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var s=KISSY.Editor;if(!s.HtmlParser.Fragment){var y={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},t=KISSY,u=s.Utils,B=s.NODE,n=s.XHTML_DTD,r=u.mix({table:1,ul:1,ol:1,dl:1},n.table,n.ul,n.ol,n.dl),i=n.$list,c=n.$listItem;v.FromHtml=function(j,m){function q(e){var p;if(d.length>0)for(var x=0;x<d.length;x++){var z=d[x],C=z.name,H=
n[C],N=f.name&&n[f.name];if((!N||N[C])&&(!e||!H||H[e]||!n[e])){if(!p){g();p=1}z=z.clone();z.parent=f;f=z;d.splice(x,1);x--}}}function g(){for(;h.length;)f.add(h.shift())}function l(e,p,x){p=p||f||b;if(m&&!p.type){var z,C;if((z=e.attributes&&(C=e.attributes._ke_real_element_type)?C:e.name)&&!(z in n.$body)&&!(z in n.$nonBodyContent)){z=f;f=p;w.onTagOpen(m,{});p=f;if(x)f=z}}if(e._.isBlockLike&&e.name!="pre"){x=e.children.length;if((z=e.children[x-1])&&z.type==B.NODE_TEXT)if(C=u.rtrim(z.value))z.value=
C;else e.children.length=x-1}p.add(e);if(e.returnPoint){f=e.returnPoint;delete e.returnPoint}}var w=new s.HtmlParser,b=new v,d=[],h=[],f=b,o=false,k;w.onTagOpen=function(e,p,x){var z=new s.HtmlParser.Element(e,p);if(z.isUnknown&&x)z.isEmpty=true;if(n.$removeEmpty[e])d.push(z);else{if(e=="pre")o=true;else if(e=="br"&&o){f.add(new s.HtmlParser.Text("\n"));return}if(e=="br")h.push(z);else{var C=f.name,H=C&&(n[C]||(f._.isBlockLike?n.div:n.span));if(H&&!z.isUnknown&&!f.isUnknown&&!H[e]){H=false;var N;
if(e in i&&C in i){C=f.children;(C=C[C.length-1])&&C.name in c||l(C=new s.HtmlParser.Element("li"),f);k=f;N=C}else if(e==C)l(f,f.parent);else{if(r[C])k||(k=f);else{l(f,f.parent,true);y[C]||d.unshift(f)}H=true}f=N?N:f.returnPoint||f.parent;if(H){w.onTagOpen.apply(this,arguments);return}}q(e);g();z.parent=f;z.returnPoint=k;k=0;if(z.isEmpty)l(z);else f=z}}};w.onTagClose=function(e){for(var p=d.length-1;p>=0;p--)if(e==d[p].name){d.splice(p,1);return}for(var x=[],z=[],C=f;C.type&&C.name!=e;){C._.isBlockLike||
z.unshift(C);x.push(C);C=C.parent}if(C.type){for(p=0;p<x.length;p++){var H=x[p];l(H,H.parent)}f=C;if(f.name=="pre")o=false;C._.isBlockLike&&g();l(C,C.parent);if(C==f)f=f.parent;d=d.concat(z)}if(e=="body")m=false};w.onText=function(e){if(!f._.hasInlineStarted&&!o){e=u.ltrim(e);if(e.length===0)return}g();q();if(m&&(!f.type||f.name=="body")&&u.trim(e))this.onTagOpen(m,{});o||(e=e.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));f.add(new s.HtmlParser.Text(e))};w.onCDATA=function(){};w.onComment=function(e){f.add(new s.HtmlParser.Comment(e))};
w.parse(j);for(g();f.type;){j=f.parent;var a=f;if(m&&(!j.type||j.name=="body")&&!n.$body[a.name]){f=j;w.onTagOpen(m,{});j=f}j.add(a);f=j}return b};t.augment(v,{add:function(j){var m=this.children.length;if(m=m>0&&this.children[m-1]||null){if(j._.isBlockLike&&m.type==B.NODE_TEXT){m.value=u.rtrim(m.value);if(m.value.length===0){this.children.pop();this.add(j);return}}m.next=j}j.previous=m;j.parent=this;this.children.push(j);this._.hasInlineStarted=j.type==B.NODE_TEXT||j.type==B.NODE_ELEMENT&&!j._.isBlockLike},
writeHtml:function(j,m){var q;this.filterChildren=function(){var g=new s.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,g,m,true);g=g.getHtml();this.children=(new v.FromHtml(g)).children;q=1};!this.name&&m&&m.onFragment(this);this.writeChildrenHtml(j,q?null:m)},writeChildrenHtml:function(j,m){for(var q=0;q<this.children.length;q++)this.children[q].writeHtml(j,m)}});s.HtmlParser.Fragment=v}});
KISSY.Editor.add("htmlparser",function(){function v(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var s=KISSY.Editor;if(!s.HtmlParser){var y=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,t={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},u=s.XHTML_DTD;KISSY.augment(v,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var n,r,i=0,c;n=this._.htmlPartsRegex.exec(B);){r=n.index;if(r>i){i=B.substring(i,r);c?c.push(i):this.onText(i)}i=this._.htmlPartsRegex.lastIndex;if(r=n[1]){r=r.toLowerCase();if(c&&u.$cdata[r]){this.onCDATA(c.join(""));c=null}if(!c){this.onTagClose(r);continue}}if(c)c.push(n[0]);else if(r=n[3]){r=r.toLowerCase();var j={},m;n=n[4];var q=!!(n&&n.charAt(n.length-1)=="/");if(n)for(;m=y.exec(n);){var g=
m[1].toLowerCase();m=m[2]||m[3]||m[4]||"";j[g]=!m&&t[g]?g:m}this.onTagOpen(r,j,q);if(!c&&u.$cdata[r])c=[]}else if(r=n[2])this.onComment(r)}B.length>i&&this.onText(B.substring(i,B.length))}});s.HtmlParser=v}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function v(){v.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var t=s.XHTML_DTD;for(var u in y.mix({},t.$nonBodyContent,t.$block,t.$listItem,t.$tableContent))this.setRules(u,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!t[u]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var s=KISSY.Editor,y=s.Utils;if(!s.HtmlParser.HtmlWriter){KISSY.extend(v,s.HtmlParser.BasicWriter,{openTag:function(t){var u=this._.rules[t];if(this._.indent)this.indentation();else if(u&&u.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",t)},openTagClose:function(t,u){t=this._.rules[t];
if(u)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(t&&t.indent)this._.indentation+=this.indentationChars}t&&t.breakAfterOpen&&this.lineBreak()},attribute:function(t,u){if(typeof u=="string"){this.forceSimpleAmpersand&&(u=u.replace(/&amp;/g,"&"));u=y.htmlEncodeAttr(u)}this._.output.push(" ",t,'="',u,'"')},closeTag:function(t){var u=this._.rules[t];if(u&&u.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(u&&u.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",t,">");u&&u.breakAfterClose&&this.lineBreak()},text:function(t){if(this._.indent){this.indentation();t=y.ltrim(t)}this._.output.push(t)},comment:function(t){this._.indent&&this.indentation();this._.output.push("<!--",t,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(t,u){var B=this._.rules[t];if(B)y.mix(B,u);else this._.rules[t]=u}});s.HtmlParser.HtmlWriter=v}});KISSY.Editor.add("htmlparser-text",function(){function v(y){this.value=y;this._={isBlockLike:false}}var s=KISSY.Editor;if(!s.HtmlParser.Text){KISSY.augment(v,{type:s.NODE.NODE_TEXT,writeHtml:function(y,t){var u=this.value;t&&!(u=t.onText(u,this))||y.text(u)}});s.HtmlParser.Text=v}});
KISSY.Editor.add("htmldataprocessor",function(v){function s(k){if(/mso-list\s*:\s*Ignore/i.test(k.attributes&&k.attributes.style))return true;return n}function y(k,a){var e=new r.HtmlParser.Element("ke:listbullet"),p;if(k)if(k[2]){k=isNaN(k[1])?/^[a-z]+$/.test(k[1])?"lower-alpha":/^[A-Z]+$/.test(k[1])?"upper-alpha":"decimal":"decimal";p="ol"}else{k=/[l\u00B7\u2002]/.test(k[1])?"disc":/[\u006F\u00D8]/.test(k[1])?"circle":/[\u006E\u25C6]/.test(k[1])?"square":"disc";p="ul"}else{k="decimal";p="ol"}e.attributes=
{"ke:listtype":p,style:"list-style-type:"+k+";"};e.add(new r.HtmlParser.Text(a));return e}function t(k){var a=k.attributes,e;if((e=k.removeAnyChildWithName("ke:listbullet"))&&e.length&&(e=e[0])){k.name="ke:li";if(a.style)a.style=u([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(p){p=p.split(" ");p=p[3]||p[1]||p[0];p=parseInt(p,10);if(!b&&d&&p>d)b=p-d;a["ke:margin"]=d=p}]],n)(a.style,k)||"";e=e.attributes;k.addStyle(e.style);i.mix(a,e);return true}return false}function u(k,a){return function(e,
p){var x=[];e.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(z,C,H){C=C.toLowerCase();C=="font-family"&&(H=H.replace(/["']/g,""));for(var N,A,D,I=0;I<k.length;I++)if(k[I]){z=k[I][0];N=k[I][1];A=k[I][2];D=k[I][3];if(C.match(z)&&(!N||H.match(N))){C=D||C;a&&(A=A||H);if(typeof A=="function")A=A(H,p,C);if(A&&A.push){C=A[0];A=A[1]}typeof A=="string"&&x.push([C,A]);return}}!a&&x.push([C,H])});for(e=0;e<x.length;e++)x[e]=x[e].join(":");return x.length?x.join(";")+";":false}}
function B(k){k=k.children;for(var a,e,p,x,z,C,H,N=0;N<k.length;N++){a=k[N];if("ke:li"==a.name){a.name="li";e=a.attributes;p=a.attributes["ke:listtype"];x=parseInt(e["ke:indent"],10)||b&&Math.ceil(e["ke:margin"]/b)||1;e.style&&(e.style=u([["list-style-type",p=="ol"?"decimal":"disc"]],n)(e.style)||"");if(C){if(x>H){C=new r.HtmlParser.Element(p);C.add(a);z.add(C)}else{if(x<H){z=H-x;for(var A;z--&&(A=C.parent);)C=A.parent}C.add(a)}k.splice(N--,1)}else{C=new r.HtmlParser.Element(p);C.add(a);k[N]=C}z=
a;H=x}else C=null}b=0}var n=n,r=KISSY.Editor,i=KISSY,c=i.UA,j=r.NODE,m=r.HtmlParser,q=new m.Filter,g=new m.Filter,l=r.XHTML_DTD;if(!v.htmlDataProcessor){(function(){var k=r.HtmlParser.Fragment.prototype,a=r.HtmlParser.Element.prototype;k.onlyChild=a.onlyChild=function(){var e=this.children;return e.length==1&&e[0]||null};a.removeAnyChildWithName=function(e){for(var p=this.children,x=[],z,C=0;C<p.length;C++){z=p[C];if(z.name){if(z.name==e){x.push(z);p.splice(C--,1)}x=x.concat(z.removeAnyChildWithName(e))}}return x};
a.getAncestor=function(e){for(var p=this.parent;p&&!(p.name&&p.name.match(e));)p=p.parent;return p};k.firstChild=a.firstChild=function(e){for(var p,x=0;x<this.children.length;x++){p=this.children[x];if(e(p))return p;else if(p.name)if(p=p.firstChild(e))return p}return null};a.addStyle=function(e,p,x){var z="";if(typeof p=="string")z+=e+":"+p+";";else{if(typeof e=="object")for(var C in e){if(e.hasOwnProperty(C))z+=C+":"+e[C]+";"}else z+=e;x=p}if(!this.attributes)this.attributes={};e=this.attributes.style||
"";e=(x?[z,e]:[e,z]).join(";");this.attributes.style=e.replace(/^;|;(?=;)/,"")};l.parentOf=function(e){var p={};for(var x in this)if(x.indexOf("$")==-1&&this[x][e])p[x]=1;return p}})();var w=u([[/mso/i],[/font-size/i,"",function(k){for(var a=v.cfg.pluginConfig["font-size"],e=0;e<a.length;e++)if(k.toLowerCase()==a[e])return k;return false},"font-size"],[/font-family/i,"",function(k){for(var a=v.cfg.pluginConfig["font-family"],e=0;e<a.length;e++)if(k.toLowerCase()==a[e].toLowerCase())return k;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],n),b,d=0,h=l.parentOf("ol"),f={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(k){k.filterChildren();B(k)},elements:{font:function(k){delete k.name},p:function(k){k.filterChildren();if(t(k))return n},$:function(k){var a=k.name||"";a.indexOf(":")!=-1&&a.indexOf("ke")==-1&&delete k.name;var e=k.attributes.style;if(a=="span"&&(!e||!w(e)))delete k.name;
if(a in h){k.filterChildren();B(k)}},table:function(k){var a=k.attributes.border;if(!a||a=="0")k.attributes["class"]="ke_show_border"},td:function(k){if(c.ie){k=k.children;var a=new r.HtmlParser.Text("&nbsp;");if(k.length)k[k.length-1].type!=j.NODE_TEXT&&k.push(a);else k.push(a)}},span:function(k){if(!c.gecko&&s(k.parent))return false;if(!c.gecko&&s(k)){k=(k=k.firstChild(function(e){return e.value||e.name=="img"}))&&(k.value||"l.");var a=k.match(/^([^\s]+?)([.)]?)$/);return y(a,k)}}},comment:!c.ie?
function(k,a){var e=k.match(/<img.*?>/);if(k=k.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){e=(a=k[1]||e&&"l.")&&a.match(/>([^\s]+?)([.)]?)</);return y(e,a)}if(c.gecko&&e){e=r.HtmlParser.Fragment.FromHtml(e[0]).children[0];(a=(a=(a=a.previous)&&a.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&a[1])&&(e.attributes.src=a);return e}return false}:function(){return false},attributes:{"class":function(k){if(/^ke_/.test(k))return k;return false},style:function(k){k=w(k);if(!k)return false;
return k}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},o={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(k){var a=k.parent;if(a&&a.name=="object"){var e=a.attributes.width;a=a.attributes.height;e&&(k.attributes.width=e);a&&(k.attributes.height=a)}},param:function(k){k.children=[];k.isEmpty=true;return k},a:function(k){if(!(k.children.length||k.attributes.name))return false},td:function(k){for(var a=k.children,e=0;e<a.length;e++)if(a[e].name=="br"){a.splice(e,1);--e}if(!k.children.length){a=
new r.HtmlParser.Text("&nbsp;");k.children.push(a)}},span:function(k){if(!k.children.length)return false}},attributes:{style:function(k){if(!i.trim(k))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(c.ie)o.attributes.style=function(k){return k.toLowerCase()};q.addRules(o);g.addRules(f);v.htmlDataProcessor={htmlFilter:q,dataFilter:g,toHtml:function(k,a){var e=new m.HtmlWriter;m.Fragment.FromHtml(k,a).writeHtml(e,q);return e.getHtml(true)},toDataFormat:function(k,a){if(c.gecko)k=
k.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var e=new m.BasicWriter;k=m.Fragment.FromHtml(k,a);e.reset();k.writeHtml(e,g);return e.getHtml(true)}}}});
KISSY.Editor.add("image",function(v){var s=KISSY.Editor,y=KISSY,t=y.UA,u=y.Node,B=y.Event,n=s.BubbleView,r=s.SimpleOverlay;s.ImageInserter||function(){function i(g){i.superclass.constructor.call(this,g);this._init()}var c=function(g){return g._4e_name()==="img"&&!/(^|\s+)ke_/.test(g[0].className)&&g},j=s.TripleButton,m="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></p><p style='margin:5px 0'><label><span style='color:#0066CC;font-weight:bold;'>\u9ad8\u5ea6\uff1a </span><input class='ke-img-height' style='width:90px' value='\u81ea\u52a8'/> px </label> &nbsp;<label><span style='color:#0066CC;font-weight:bold;'>\u5bbd\u5ea6\uff1a </span><input class='ke-img-width' style='width:90px' value='\u81ea\u52a8'/> px </label></p><p><label><span style='color:#0066CC;font-weight:bold;'>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
s.Utils.duplicateStr("&nbsp;",13)+"<label><span style='color:#0066CC;font-weight:bold;'>\u95f4\u8ddd\uff1a </span> <input class='ke-img-margin' style='width:80px' value='5'/> px</label></p></div>";i.ATTRS={editor:{}};var q={"\u56fe\u7247\u5c5e\u6027":function(g){var l=g.getSelection();l=l&&l.getStartElement();l=c(l);g=g._toolbars.image;l&&g.show(null,l)}};y.extend(i,y.Base,{_init:function(){var g=this.get("editor"),l=g.toolBarDiv,w={};this.editor=g;this.el=new j({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",
container:l});this.el.on("offClick",this.show,this);B.on(g.document,"dblclick",this._dblclick,this);s.Utils.lazyRun(this,"_prepare","_real");g._toolbars=g._toolbars||{};g._toolbars.image=this;if(q)for(var b in q)(function(d){w[d]=function(){q[d](g)}})(b);s.ContextMenu.register(g.document,{rules:[c],width:"120px",funcs:w});n.attach({pluginName:"image",pluginInstance:this})},_dblclick:function(g){var l=new u(g.target);if(c(l)){this.show(null,l);g.halt()}},_prepare:function(){var g=this;g.get("editor");
g.d=new r({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var l=g.d;l.body.html(m);l.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");g.content=l.el;l=g.content;var w=l.one(".ke-img-cancel"),b=l.one(".ke-img-insert");g.imgUrl=l.one(".ke-img-url");g.imgHeight=l.one(".ke-img-height");g.imgWidth=l.one(".ke-img-width");g.imgAlign=l.one(".ke-img-align");g.imgMargin=l.one(".ke-img-margin");w.on("click",function(d){g.d.hide();
d.halt()});b.on("click",function(){g._insert()})},_updateTip:function(g,l){g.html(l.attr("src"));g.attr("href",l.attr("src"))},_real:function(){this.d.show()},_insert:function(){var g=this.imgUrl.val();if(g){var l=parseInt(this.imgHeight.val()),w=this.get("editor"),b=parseInt(this.imgWidth.val()),d=this.imgAlign.val(),h=parseInt(this.imgMargin.val()),f="";if(l)f+="height:"+l+"px;";if(b)f+="width:"+b+"px;";if(d)f+="float:"+d+";";isNaN(h)||(f+="margin:"+h+"px;");if(f)f=" style='"+f+"' ";g=new u("<img "+
f+"src='"+g+"' alt='' />",null,w.document);g=w.insertElement(g,l||b?null:function(o){o.on("load",function(){o.detach();o.css({width:o.width()+"px",height:o.height()+"px"})})});this._selectedEl&&w.getSelection().selectElement(g);this.d.hide();w.notifySelectionChange()}},_updateD:function(g){if(this._selectedEl=g){this.imgUrl.val(g.attr("src"));this.imgHeight.val(g.height());this.imgWidth.val(g.width());this.imgAlign.val(g._4e_style("float"));this.imgMargin.val(parseInt(g._4e_style("margin"))||0)}else{this.imgUrl.val("http://");
this.imgHeight.val("\u81ea\u52a8");this.imgWidth.val("\u81ea\u52a8");this.imgAlign.val();this.imgMargin.val("5")}},show:function(g,l){this._prepare();this._updateD(l)}});s.ImageInserter=i;(function(g,l,w){n.register({pluginName:g,func:w,init:function(){var b=this,d=b.el;d.html(l+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var h=d.one(".ke-bubbleview-url"),f=d.one(".ke-bubbleview-change");d=d.one(".ke-bubbleview-remove");f._4e_unselectable();h._4e_unselectable();d._4e_unselectable();f.on("click",function(o){b._plugin.show(null,b._selectedEl);o.halt()});d.on("click",function(o){var k=b._plugin;if(t.webkit){var a=k.editor.getSelection().getRanges();a&&a[0]&&(a[0].collapse(true)||1)&&a[0].select()}b._selectedEl._4e_remove();b.hide();k.editor.notifySelectionChange();o.halt()});b.on("afterVisibleChange",function(o){var k=
b._selectedEl;o.newVal&&k&&b._plugin._updateTip(h,k)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",c)}();v.addPlugin(function(){new s.ImageInserter({editor:v})})});
KISSY.Editor.add("indent",function(v){var s=KISSY.Editor,y={ol:1,ul:1},t=KISSY,u=s.Walker,B=t.DOM,n=t.Node,r=t.UA,i=s.NODE;s.Indent||function(){function c(h){this.type=h;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function j(h){return h.type=CKEDITOR.NODE_ELEMENT&&h.is("li")}function m(h,f,o){var k=f.startContainer;for(h=f.endContainer;k&&k.parent()[0]!==o[0];)k=k.parent();for(;h&&h.parent()[0]!==o[0];)h=h.parent();if(k&&h){var a=k;k=[];for(var e=false;!e;){if(a[0]===
h[0])e=true;k.push(a);a=a.next()}if(!(k.length<1)){a=o._4e_parents(true);for(h=0;h<a.length;h++)if(y[a[h]._4e_name()]){o=a[h];break}a=this.type=="indent"?1:-1;h=k[0];e=k[k.length-1];k={};var p=s.ListUtils.listToArray(o,k),x=p[e._4e_getData("listarray_index")].indent;for(h=h._4e_getData("listarray_index");h<=e._4e_getData("listarray_index");h++){p[h].indent+=a;var z=p[h].parent;p[h].parent=new n(z[0].ownerDocument.createElement(z._4e_name()))}for(h=e._4e_getData("listarray_index")+1;h<p.length&&p[h].indent>
x;h++)p[h].indent+=a;e=s.ListUtils.arrayToList(p,k,null,"p",0);a=[];if(this.type=="outdent"){var C;if((C=o.parent())&&C._4e_name()=="li"){p=e.listNode.childNodes;var H;for(h=p.length-1;h>=0;h--)if((H=new n(p[h]))&&H._4e_name()=="li")a.push(H)}}if(e){B.insertBefore(e.listNode,o[0]);o._4e_remove()}if(a&&a.length)for(h=0;h<a.length;h++){for(H=o=a[h];(H=H.next())&&H._4e_name()in y;){r.ie&&!o._4e_first(function(N){return w(N)&&b(N)})&&o[0].appendChild(f.document.createTextNode("\u00a0"));o[0].appendChild(H[0])}B.insertAfter(o[0],
C[0])}for(h in k)k[h]._4e_clearMarkers(k,true)}}}function q(h,f){f=f.createIterator();f.enforceRealBlocks=true;f.enlargeBr=true;for(var o;o=f.getNextParagraph();)g.call(this,h,o)}function g(h,f){h=parseInt(f._4e_style(this.indentCssProperty),10);if(isNaN(h))h=0;h+=(this.type=="indent"?1:-1)*this.indentOffset;if(h<0)return false;h=Math.max(h,0);h=Math.ceil(h/this.indentOffset)*this.indentOffset;f.css(this.indentCssProperty,h?h+this.indentUnit:"");f[0].style.cssText===""&&f[0].removeAttribute("style");
return true}function l(h){l.superclass.constructor.call(this,h);h=this.get("editor").toolBarDiv;this.el=new d({container:h,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new c(this.get("type"));this._init()}var w=u.whitespaces(true),b=u.bookmark(false,true);t.augment(c,{exec:function(h){for(var f=h.getSelection(),o=f&&f.getRanges()[0],k=o.startContainer,a=o.endContainer,e=o.getCommonAncestor();e&&!(e[0].nodeType==i.NODE_ELEMENT&&y[e._4e_name()]);)e=e.parent();if(e&&
k[0].nodeType==i.NODE_ELEMENT&&k._4e_name()in y){k=new u(o);k.evaluator=j;o.startContainer=k.next()}if(e&&a[0].nodeType==i.NODE_ELEMENT&&a._4e_name()in y){k=new u(o);k.evaluator=j;o.endContainer=k.previous()}a=f.createBookmarks(true);if(e){for(k=e._4e_first();k&&k[0]&&k._4e_name()!="li";)k=k.next();var p=o.startContainer;(k[0]==p[0]||k._4e_contains(p))&&g.call(this,h,e)||m.call(this,h,o,e)}else q.call(this,h,o);f.selectBookmarks(a)}});var d=s.TripleButton;l.ATTRS={type:{},contentCls:{},editor:{}};
t.extend(l,t.Base,{_init:function(){var h=this.get("editor"),f=this.el;f.on("offClick",this.exec,this);this.get("type")=="outdent"?h.on("selectionChange",this._selectionChange,this):f.set("state",d.OFF)},exec:function(){var h=this.get("editor"),f=this;h.fire("save");setTimeout(function(){f.indentCommand.exec(h);h.fire("save");h.notifySelectionChange()},10)},_selectionChange:function(h){this.get("editor");this.get("type");var f=h.path,o=f.blockLimit;h=this.el;if(f.contains(y))h.set("state",d.OFF);
else(f=f.block||o)&&f._4e_style(this.indentCommand.indentCssProperty)?h.set("state",d.OFF):h.set("state",d.DISABLED)}});s.Indent=l}();v.addPlugin(function(){v.addCommand("outdent",new s.Indent({editor:v,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));v.addCommand("indent",new s.Indent({editor:v,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(v){var s=KISSY.Editor,y=KISSY,t=s.TripleButton;s.Justify||function(){function u(n,r,i,c){this.editor=n;this.v=r;this.contentCls=c;this.title=i;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;y.augment(u,{_init:function(){var n=this.editor;this.el=new t({contentCls:this.contentCls,title:this.title,container:n.toolBarDiv});n.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var n=this.editor,r=n.getSelection(),
i=this.el.get("state");if(r){var c=r.createBookmarks(),j=r.getRanges(),m,q;n.fire("save");for(var g=j.length-1;g>=0;g--){m=j[g].createIterator();for(m.enlargeBr=true;q=m.getNextParagraph();){q.removeAttr("align");i==t.OFF?q.css("text-align",this.v):q.css("text-align","")}}n.notifySelectionChange();r.selectBookmarks(c);n.fire("save")}},_selectionChange:function(n){var r=this.el;n=n.path;if(n=n.block||n.blockLimit){n=n.css("text-align").replace(B,"");n==this.v||!n&&this.v=="left"?r.set("state",t.ON):
r.set("state",t.OFF)}}});s.Justify=u}();v.addPlugin(function(){new s.Justify(v,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new s.Justify(v,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new s.Justify(v,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(v){var s=KISSY.Editor;s.Link||function(){function y(q){this.editor=q;this._init()}function t(q){return q._4e_ascendant(function(g){return g._4e_name()==="a"&&!!g.attr("href")},true)}var u=KISSY,B=s.TripleButton,n=s.Style,r=u.Node,i=s.Range,c=s.SimpleOverlay,j=s.BubbleView,m={element:"a",attributes:{href:"#(href)",target:"#(target)"}};y.init=function(){var q=new c({title:"\u94fe\u63a5\u5c5e\u6027",mask:true,width:"300px"});this.dialog=q;q.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input class='ke-link-url' style='width:220px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
q.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");q.urlEl=q.body.one(".ke-link-url");q.targetEl=q.body.one(".ke-link-blank");var g=q.foot.one(".ke-link-cancel");q.foot.one(".ke-link-ok").on("click",function(l){q.link._link();l.halt()},this);g.on("click",function(l){q.hide();l.halt()},this);y.init=null};j.register({pluginName:"link",func:t,init:function(){var q=this,g=q.el;g.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var l=g.one(".ke-bubbleview-url"),w=g.one(".ke-bubbleview-change");g=g.one(".ke-bubbleview-remove");w._4e_unselectable();l._4e_unselectable();g._4e_unselectable();w.on("click",function(b){q._plugin.show();b.halt()});g.on("click",function(b){var d=q._plugin;d._removeLink(q._selectedEl);d.editor.notifySelectionChange();b.halt()});q.on("afterVisibleChange",function(){var b=q._selectedEl;if(b){l.html(b.attr("href"));l.attr("href",b.attr("href"))}})}});u.augment(y,{_init:function(){this.el=new B({container:this.editor.toolBarDiv,
contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5 "});this.el.on("click",this.show,this);j.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(q){var g=this.editor,l={href:q.attr("href")};if(q._4e_hasAttribute("target"))l.target=q.attr("target");q=new n(m,l);g.fire("save");q.remove(g.document);g.fire("save")},_getSelectedLink:function(){var q=this.editor.getSelection();if(q=q&&q.getStartElement())q=t(q);return q},_link:function(){var q,g=this.editor,l=y.dialog,w=l.urlEl.val(),
b;if(u.trim(w)){l.hide();if(b=this._getSelectedLink()){q=new i(g.document);q.selectNodeContents(b);g.getSelection().selectRanges([q]);this._removeLink(b)}b={href:w};b.target=l.targetEl[0].checked?"_blank":"_self";q=g.getSelection().getRanges()[0];if(q.collapsed){q=new r("<a href='"+w+"' target='"+b.target+"'>"+w+"</a>",null,g.document);g.insertElement(q)}else{g.fire("save");q=new n(m,b);q.apply(g.document);g.fire("save")}g.notifySelectionChange()}},_prepare:function(){y.init&&y.init()},_real:function(){var q=
y.dialog,g=this._getSelectedLink();q.link=this;if(g){q.urlEl.val(g.attr("href"));q.targetEl[0].checked=g.attr("target")=="_blank"}q.show()},show:function(){this._prepare()}});s.Utils.lazyRun(y.prototype,"_prepare","_real");s.Link=y}();v.addPlugin(function(){new s.Link(v)})});
KISSY.Editor.add("list",function(v){var s=KISSY.Editor,y={ol:1,ul:1},t=["ol","ul"],u=KISSY,B=s.RANGE,n=s.ElementPath,r=s.Walker,i=s.NODE,c=u.UA,j=u.Node,m=u.DOM;s.List||function(){function q(d){this.type=d}function g(d){g.superclass.constructor.call(this,d);d=this.get("editor").toolBarDiv;this.el=new b({contentCls:this.get("contentCls"),title:this.get("title"),container:d});this.listCommand=new q(this.get("type"));this.listCommand.state=this.get("status");this._init()}var l={listToArray:function(d,
h,f,o,k){if(!y[d._4e_name()])return[];o||(o=0);f||(f=[]);for(var a=0,e=d[0].childNodes.length;a<e;a++){var p=new j(d[0].childNodes[a]);if(p._4e_name()=="li"){var x={parent:d,indent:o,element:p,contents:[]};if(k)x.grandparent=k;else{x.grandparent=d.parent();if(x.grandparent&&x.grandparent._4e_name()=="li")x.grandparent=x.grandparent.parent()}h&&p._4e_setMarker(h,"listarray_index",f.length);f.push(x);for(var z=0,C=p[0].childNodes.length,H;z<C;z++){H=new j(p[0].childNodes[z]);H[0].nodeType==i.NODE_ELEMENT&&
y[H._4e_name()]?l.listToArray(H,h,f,o+1,x.grandparent):x.contents.push(H)}}}return f},arrayToList:function(d,h,f,o){f||(f=0);if(!d||d.length<f+1)return null;for(var k=d[f].parent[0].ownerDocument,a=k.createDocumentFragment(),e=null,p=f,x=Math.max(d[f].indent,0),z=null;;){var C=d[p];if(C.indent==x){if(!e||d[p].parent._4e_name()!=e._4e_name()){e=d[p].parent._4e_clone(false,true);a.appendChild(e[0])}z=e[0].appendChild(C.element._4e_clone(false,true)[0]);for(var H=0;H<C.contents.length;H++)z.appendChild(C.contents[H]._4e_clone(true,
true)[0]);p++}else if(C.indent==Math.max(x,0)+1){p=l.arrayToList(d,null,p,o);z.appendChild(p.listNode);p=p.nextIndex}else if(C.indent==-1&&!f&&C.grandparent){z=y[C.grandparent._4e_name()]?C.element._4e_clone(false,true)[0]:C.grandparent._4e_name()!="td"?k.createElement(o):k.createDocumentFragment();for(H=0;H<C.contents.length;H++)z.appendChild(C.contents[H]._4e_clone(true,true)[0]);if(z.nodeType==i.NODE_DOCUMENT_FRAGMENT&&p!=d.length-1){z.lastChild&&z.lastChild.nodeType==i.NODE_ELEMENT&&z.lastChild.getAttribute("type")==
"_moz"&&m._4e_remove(z.lastChild);m._4e_appendBogus(z)}if(z.nodeType==i.NODE_ELEMENT&&m._4e_name(z)==o&&z.firstChild){m._4e_trim(z);e=z.firstChild;if(e.nodeType==i.NODE_ELEMENT&&m._4e_isBlockBoundary(e)){e=k.createDocumentFragment();m._4e_moveChildren(z,e);z=e}}e=m._4e_name(z);if(!c.ie&&(e=="div"||e=="p"))m._4e_appendBogus(z);a.appendChild(z);e=null;p++}else return null;if(d.length<=p||Math.max(d[p].indent,0)<x)break}if(h)for(d=new j(a.firstChild);d&&d[0];){d[0].nodeType==i.NODE_ELEMENT&&d._4e_clearMarkers(h,
true);d=d._4e_nextSourceNode()}return{listNode:a,nextIndex:p}}},w=/^h[1-6]$/;q.prototype={changeListType:function(d,h,f,o){var k=l.listToArray(h.root,f),a=[];for(d=0;d<h.contents.length;d++){var e=h.contents[d];e=e._4e_ascendant("li",true);if(!(!e||!e[0]||e._4e_getData("list_item_processed"))){a.push(e);e._4e_setMarker(f,"list_item_processed",true)}}e=new j(h.root[0].ownerDocument.createElement(this.type));for(d=0;d<a.length;d++){var p=a[d]._4e_getData("listarray_index");k[p].parent=e}f=l.arrayToList(k,
f,null,"p");var x;k=f.listNode.childNodes.length;for(d=0;d<k&&(x=new j(f.listNode.childNodes[d]));d++)x._4e_name()==this.type&&o.push(x);m.insertBefore(f.listNode,h.root[0]);h.root._4e_remove()},createList:function(d,h,f){var o=h.contents;d=h.root[0].ownerDocument;var k=[];if(o.length==1&&o[0][0]===h.root[0]){var a=new j(d.createElement("div"));o[0][0].nodeType!=i.NODE_TEXT&&o[0]._4e_moveChildren(a);o[0][0].appendChild(a[0]);o[0]=a}h=h.contents[0].parent();for(a=0;a<o.length;a++)h=h._4e_commonAncestor(o[a].parent());
for(a=0;a<o.length;a++)for(var e=o[a],p;p=e.parent();){if(p[0]===h[0]){k.push(e);break}e=p}if(!(k.length<1)){o=new j(k[k.length-1][0].nextSibling);a=new j(d.createElement(this.type));for(f.push(a);k.length;){f=k.shift();e=new j(d.createElement("li"));if(w.test(f._4e_name()))e[0].appendChild(f[0]);else{f._4e_copyAttributes(e);f._4e_moveChildren(e);f._4e_remove()}a[0].appendChild(e[0]);c.ie||e._4e_appendBogus()}o[0]?m.insertBefore(a[0],o[0]):h[0].appendChild(a[0])}},removeList:function(d,h,f){function o(H){if((z=
new j(x[H?"firstChild":"lastChild"]))&&!(z[0].nodeType==i.NODE_ELEMENT&&z._4e_isBlockBoundary())&&(C=h.root[H?"_4e_previous":"_4e_next"](r.whitespaces(true)))&&!(z[0].nodeType==i.NODE_ELEMENT&&C._4e_isBlockBoundary({br:1})))m[H?"insertBefore":"insertAfter"](d.document.createElement("br"),z[0])}for(var k=l.listToArray(h.root,f),a=[],e=0;e<h.contents.length;e++){var p=h.contents[e];p=p._4e_ascendant("li",true);if(!(!p||p._4e_getData("list_item_processed"))){a.push(p);p._4e_setMarker(f,"list_item_processed",
true)}}p=null;for(e=0;e<a.length;e++){p=a[e]._4e_getData("listarray_index");k[p].indent=-1;p=p}for(e=p+1;e<k.length;e++)if(k[e].indent>Math.max(k[e-1].indent,0)){a=k[e-1].indent+1-k[e].indent;for(p=k[e].indent;k[e]&&k[e].indent>=p;){k[e].indent+=a;e++}e--}var x=l.arrayToList(k,f,null,"p").listNode,z,C;o(true);o();m.insertBefore(x,h.root);h.root._4e_remove()},exec:function(d){var h=d.getSelection(),f=h&&h.getRanges();if(!(!f||f.length<1)){for(var o=h.createBookmarks(true),k=[],a={};f.length>0;){var e=
f.shift(),p=e.getBoundaryNodes(),x=p.startNode,z=p.endNode;x[0].nodeType==i.NODE_ELEMENT&&x._4e_name()=="td"&&e.setStartAt(p.startNode,B.POSITION_AFTER_START);z[0].nodeType==i.NODE_ELEMENT&&z._4e_name()=="td"&&e.setEndAt(p.endNode,B.POSITION_BEFORE_END);e=e.createIterator();for(e.forceBrBreak=false;p=e.getNextParagraph();){x=new n(p);z=x.elements;var C=null,H=false,N=x.blockLimit,A;for(x=z.length-1;x>=0&&(A=z[x]);x--)if(y[A._4e_name()]&&N.contains(A)){N._4e_removeData("list_group_object");if(x=A._4e_getData("list_group_object"))x.contents.push(p);
else{x={root:A,contents:[p]};k.push(x);A._4e_setMarker(a,"list_group_object",x)}H=true;break}if(!H)if(N._4e_getData("list_group_object"))N._4e_getData("list_group_object").contents.push(p);else{x={root:N,contents:[p]};N._4e_setMarker(a,"list_group_object",x);k.push(x)}}}for(f=[];k.length>0;){x=k.shift();if(this.state=="off")y[x.root._4e_name()]?this.changeListType(d,x,a,f):this.createList(d,x,f);else this.state=="on"&&y[x.root._4e_name()]&&this.removeList(d,x,a)}for(x=0;x<f.length;x++){C=f[x];var D=
this;(d=function(I){var L=C[I?"_4e_previous":"_4e_next"](r.whitespaces(true));if(L&&L[0]&&L._4e_name()==D.type){L._4e_remove();L._4e_moveChildren(C,I?true:false)}})();d(true)}s.Utils.clearAllMarkers(a);h.selectBookmarks(o)}}};var b=s.TripleButton;g.ATTRS={editor:{},type:{},contentCls:{}};u.extend(g,u.Base,{_init:function(){var d=this,h=d.get("editor"),f=d.el;d=d;f.on("click",d._change,d);h.on("selectionChange",d._selectionChange,d)},_change:function(){var d=this.get("editor");this.get("type");var h=
this.el;d.fire("save");this.listCommand.state=h.get("state");this.listCommand.exec(d);d.fire("save");d.notifySelectionChange()},_selectionChange:function(d){this.get("editor");var h=this.get("type"),f=d.path,o;d=this.el;var k=f.blockLimit;if(f=f.elements)for(var a=0;a<f.length&&(o=f[a])&&o[0]!==k[0];a++){var e=u.indexOf(f[a]._4e_name(),t);if(e!==-1)if(t[e]===h){d.set("state",b.ON);return}else break}d.set("state",b.OFF)}});s.ListUtils=l;s.List=g}();v.addPlugin(function(){new s.List({editor:v,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new s.List({editor:v,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("localStorage",function(){function v(){t.fire("storeReady")}function s(){n=t.Utils.flash.createSWFRuntime(B,{attrs:{allowScriptAccess:"always",allowNetworking:"all",scale:"noScale"},flashVars:{allowedDomain:location.hostname,shareData:true,YUISwfId:y.guid(r),YUIBridgeCallback:u+".ready",browser:r,useCompression:true}})}var y=KISSY,t=y.Editor,u;u=t.STORE="localStorage";if(!t.storeReady){t.storeReady=function(i){t.on("storeReady",i)};t.on("storeReady",function(){t.storeReady=function(i){i()};
t.detach("storeReady")})}if(window[u])window[u]._ke||v();else{var B=t.Config.base+t.Utils.debugUrl("plugins/localStorage/swfstore.swf"),n,r="ke-localstorage-";window[u]={_ke:1,getItem:function(i){return n.getValueOf(i)},setItem:function(i,c){return n.setItem(i,c)},removeItem:function(i){return n.removeItem(i)},ready:function(i,c){if(c.type=="contentReady"){v();this.ready=function(){}}}};s()}});
KISSY.Editor.add("maximize",function(v){var s=KISSY.Editor,y=KISSY,t=y.UA,u=y.Node,B=y.Event,n=s.TripleButton,r=y.DOM,i;s.Maximize||function(){function c(j){this.editor=j;this._init()}c.init=function(){i=new u("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(i[0]);c.init=null};y.augment(c,{_init:function(){this.el=new n({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);s.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var j=this,m=j.editor;B.remove(window,"resize",j._maximize,j);this._saveEditorStatus();m.wrap.css({height:j.iframeHeight});(new u(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";m.editorWrap.css({position:"static",width:j.editorWrapWidth});i.css({left:"-99999px",top:"-99999px"});window.scrollTo(j.scrollLeft,
j.scrollTop);j.el.set("state",n.OFF);setTimeout(function(){j._restoreEditorStatus()},30);m.notifySelectionChange()},_saveSate:function(){var j=this.editor;this.iframeHeight=j.wrap._4e_style("height");this.editorWrapWidth=j.editorWrap._4e_style("width");this.scrollLeft=r.scrollLeft();this.scrollTop=r.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var j=this.editor;if(t.gecko&&j.iframeFocus)this.savedRanges=(j=j.getSelection())&&j.getRanges()},_restoreEditorStatus:function(){var j=this.editor,
m=j.getSelection();if(t.gecko&&j.iframeFocus){this.el.el[0].focus();j.focus();this.savedRanges&&m&&m.selectRanges(this.savedRanges)}if(j.iframeFocus&&m)(j=m.getStartElement())&&j[0]&&j._4e_scrollIntoView()},_maximize:function(){var j=this.editor,m=r.viewportHeight(),q=r.viewportWidth(),g=j.statusDiv?j.statusDiv.height():0,l=j.toolBarDiv.height();if(t.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new u(document.body)).css({width:0,height:0,overflow:"hidden"});
j.editorWrap.css({position:"absolute",zIndex:990,width:q+"px"});i.css({zIndex:985,height:m+"px",width:q+"px"});j.editorWrap.offset({left:0,top:0});i.css({left:0,top:0});j.wrap.css({height:m-g-l-14+"px"});j.notifySelectionChange()},_real:function(){var j=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",j._maximize,j);this.el.set("state",n.ON);setTimeout(function(){j._restoreEditorStatus()},30)},_prepare:function(){c.init&&c.init()},maximize:function(){this._prepare()}});
s.Maximize=c}();v.addPlugin(function(){new s.Maximize(v)})});
KISSY.Editor.add("music",function(v){function s(c){return c.indexOf(n)!=-1}var y=KISSY.Editor,t=KISSY,u=y.Flash,B="ke_music",n="niftyplayer.swf",r=v.htmlDataProcessor,i=r&&r.dataFilter;i&&i.addRules({elements:{object:function(c){var j=c.attributes;if(!(j.classid&&String(j.classid).toLowerCase())){for(j=0;j<c.children.length;j++)if(c.children[j].name=="embed"){if(!u.isFlashEmbed(c.children[j]))return null;if(s(c.children[j].attributes.src))return r.createFakeParserElement(c,B,"music",true)}return null}for(j=
0;j<c.children.length;j++){var m=c.children[j];if(m.name=="param"&&m.attributes.name=="movie")if(s(m.attributes.value))return r.createFakeParserElement(c,B,"music",true)}},embed:function(c){if(!u.isFlashEmbed(c))return null;if(s(c.attributes.src))return r.createFakeParserElement(c,B,"music",true)}}},4);y.MusicInserter||function(){function c(){c.superclass.constructor.apply(this,arguments)}function j(d){return d._4e_name()==="img"&&!!d.hasClass(B)&&d}function m(d){return d.replace(/^.+niftyplayer\.swf\?file=/,
"")}var q=y.Config.base+"plugins/music/niftyplayer.swf?file=#(music)",g="<p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3'/></label></p><p style='margin:5px 0'><label>\u5bf9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u9f50\uff1a <select class='ke-music-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
y.Utils.duplicateStr("&nbsp;",1)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-music-margin' style='width:90px' value='5'/> px</label><p>",l=/#\(music\)/g,w=["img."+B];t.extend(c,u,{_config:function(){this._cls=B;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml=g;this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=
b;this._flashRules=w},_initD:function(){var d=this,h=d.d;d.dUrl=h.el.one(".ke-music-url");d.dAlign=h.el.one(".ke-music-align");d.dMargin=h.el.one(".ke-music-margin");var f=h.el.one(".ke-music-ok");h=h.el.one(".ke-music-cancel");f.on("click",d._gen,d);h.on("click",function(){d.d.hide()})},_getDInfo:function(){return{url:q.replace(l,this.dUrl.val()),attrs:{width:165,height:37,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}},_getFlashUrl:function(d){return m(c.superclass._getFlashUrl.call(this,
d))},_updateD:function(){var d=this.editor,h=this.selectedFlash;if(h){d=d.restoreRealElement(h);this.dUrl.val(this._getFlashUrl(d));this.dAlign.val(h.attr("align"));this.dMargin.val(parseInt(d._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3");this.dAlign.val("");this.dMargin.val("5")}}});u.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",j);y.MusicInserter=c;var b={"\u97f3\u4e50\u5c5e\u6027":function(d){var h=d.getSelection();h=(h=h&&h.getStartElement())&&
j(h);d=d._toolbars.music;h&&d.show(null,h)}}}();v.addPlugin(function(){new y.MusicInserter(v)})});
KISSY.Editor.add("overlay",function(){function v(){v.superclass.constructor.apply(this,arguments);this._init()}var s=KISSY.Editor,y=KISSY,t=y.UA,u=s.focusManager,B=y.Node,n=y.Event,r=y.DOM,i,c,j,m={left:"-9999px",top:"-9999px"};if(!s.SimpleOverlay){v.init=function(){var q=document.body,g={width:"100%",height:r.docHeight()+"px",opacity:0.4};y.mix(g,m);i=(new B('<div class="ke-mask">&nbsp;</div>')).appendTo(q);i.css(g);if(t.ie&&t.ie==6){j=(new B("<iframe class='ke-dialog-iframe'></iframe>")).appendTo(q);
c=(new B("<iframe class='ke-mask'></iframe>")).appendTo(q);y.all([c[0],j[0]]).css(g)}v.init=null};v.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false},draggable:{value:true}};y.extend(v,y.Base,{_init:function(){var q=this;q._createEl();var g=q.el;q.on("afterVisibleChange",function(l){if(l=l.newVal){typeof l=="boolean"?q.center():g.offset(l);q.fire("show")}else{g.css(m);q.fire("hide")}});if(q.get("focusMgr")){q._initFocusNotice();q.on("afterVisibleChange",
q._editorFocusMg,q)}q.on("afterVisibleChange",function(l){l.newVal?q._register():q._unregister()});if(t.ie===6){q.on("show",function(){var l=g.width(),w=g.height();j.css({width:l+"px",height:w+"px"});j.css(g.offset())});q.on("hide",function(){j.css(m)})}if(q.get("mask")){q.on("show",function(){y.all([i[0],c&&c[0]]).css({left:"0px",top:"0px"})});q.on("hide",function(){y.all([i[0],c&&c[0]]).css(m)})}},_register:function(){n.on(document,"keydown",this._keydown,this);i&&i.on("click",this.hide,this)},
_keydown:function(q){if(q.keyCode==27){this.hide();q.halt()}},_unregister:function(){n.remove(document,"keydown",this._keydown,this);i&&i.detach("click",this.hide,this)},_createEl:function(){var q=this,g=q.get("el");if(!g){g=(new B("<div class='ke-dialog' style='width:@width@'><div class='ke-hd'><span class='ke-hd-title'>@title@</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>".replace(/@width@/,q.get("width")).replace(/@title@/,
q.get("title")))).appendTo(document.body);var l=g.one(".ke-hd"),w=y.guid("ke-overlay-head-");q.body=g.one(".ke-bd");q.foot=g.one(".ke-ft");q._close=g.one(".ke-close");q._title=l.one("h1");q._close.on("click",function(b){b.preventDefault();q.hide()});if(q.get("draggable")){l[0].id=w;l=new s.Drag({node:g,handlers:{id:l}});t.ie===6&&l.on("move",function(){j.offset(g.offset())})}}q.set("el",g);q.el=g;g.css(m)},center:function(){var q=this.el,g=q.width(),l=q.height(),w=r.viewportWidth(),b=r.viewportHeight();
g=(w-g)/2+r.scrollLeft();l=(b-l)/2+r.scrollTop();if(l-r.scrollTop()>200)l-=150;q.css({left:g+"px",top:l+"px"})},_prepareShow:function(){v.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;return this._focusEl=(new B("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.el)},_initFocusNotice:function(){var q=this,g=q._getFocusEl();g.on("focus",function(){q.fire("focus")});g.on("blur",function(){q.fire("blur")})},
_editorFocusMg:function(q){var g=this._focusEditor;if(q.newVal){g=this._focusEditor=u.currentInstance();t.webkit||this._getFocusEl()[0].focus();var l=this.el.one("input");if(l)setTimeout(function(){try{l[0].focus();l[0].select()}catch(w){}},0);else if(t.ie&&g)if(q=g.document.selection.createRange())if(q.item&&q.item(0).ownerDocument==g.document){g=document.body.createTextRange();g.moveToElementText(this.el._4e_first()[0]);g.collapse(true);g.select()}}else g&&g.focus()},_realShow:function(q){this.set("visible",
q||true)},show:function(q){this._prepareShow(q)},hide:function(){this.set("visible",false)}});s.Utils.lazyRun(v.prototype,"_prepareShow","_realShow");s.SimpleOverlay=v}});
KISSY.Editor.add("preview",function(v){var s=KISSY.Editor,y=KISSY,t=s.TripleButton;s.Preview||function(){function u(B){this.editor=B;this._init()}y.augment(u,{_init:function(){this.el=new t({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,n=640,r=420,i=80;try{var c=window.screen;n=Math.round(c.width*0.8);r=Math.round(c.height*0.7);i=Math.round(c.width*0.1)}catch(j){}B=
B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+B.getData()+"\n</body>");n=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+n+",height="+r+",left="+i);n.document.open();n.document.write(B);n.document.close();n.focus()}});s.Preview=u}();v.addPlugin(function(){new s.Preview(v)})});
KISSY.Editor.add("removeformat",function(v){function s(m){this.editor=m;this._init()}function y(m,q){for(var g=0;g<q.length;g++)m.removeAttr(q[g])}var t=KISSY.Editor,u=KISSY,B=t.RANGE,n=t.ElementPath,r=t.NODE,i=t.TripleButton,c="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",j="class,style,lang,width,height,align,hspace,valign".split(",");c=new RegExp("^(?:"+c.replace(/,/g,"|")+")$","i");u.augment(s,{_init:function(){this.el=new i({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var m=this.editor,q=c;q.lastIndex=0;var g=m.getSelection().getRanges();m.fire("save");for(var l=0,w;w=g[l];l++)if(!w.collapsed){w.enlarge(B.ENLARGE_ELEMENT);var b=w.createBookmark(),d=b.startNode,h=b.endNode,f=function(o){for(var k=new n(o),a=k.elements,e=1,p;p=a[e];e++){if(p._4e_equals(k.block)||p._4e_equals(k.blockLimit))break;q.test(p._4e_name())&&o._4e_breakParent(p)}};
f(d);f(h);for(d=d._4e_nextSourceNode(true,r.NODE_ELEMENT);d;){if(d._4e_equals(h))break;f=d._4e_nextSourceNode(false,r.NODE_ELEMENT);d._4e_name()=="img"&&d.attr("_cke_realelement")||(q.test(d._4e_name())?d._4e_remove(true):y(d,j));d=f}w.moveToBookmark(b)}m.getSelection().selectRanges(g);m.fire("save")}});v.addPlugin(function(){new s(v)})});
KISSY.Editor.add("resize",function(v){var s=KISSY,y=s.Editor,t=s.Node;y.Resizer||function(){function u(n){this.editor=n;this._init()}var B=y.Draggable;s.augment(u,{_init:function(){var n=this.editor,r=n.statusDiv,i=new t("<div class='ke-resizer'></div>");i.appendTo(r);r=new B({node:i});var c=0,j=0,m=n.wrap,q=n.editorWrap;r.on("start",function(){c=m.height();j=q.width()});r.on("move",function(g){var l=g.pageX-this.startMousePos.left;m.height(c+(g.pageY-this.startMousePos.top));q.width(j+l)})}});y.Resizer=
u}();v.addPlugin(function(){new y.Resizer(v)})});
KISSY.Editor.add("select",function(){function v(n){v.superclass.constructor.call(this,n);this._init()}var s=KISSY,y=s.Node,t=s.Event,u=s.DOM,B=s.Editor;if(!B.Select){v.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};s.extend(v,s.Base,{_init:function(){var n=this.get("container"),r=new y("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a></span>"),i=this.get("title"),c=r.one(".ke-select-text");
r.one(".ke-select-drop");c.html(i);c.css("width",this.get("width"));r._4e_unselectable();r.attr("title",i);r.appendTo(n);r.on("click",this._click,this);this.el=r;this.title=c;this._focusA=r.one("a.ke-select");B.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(n){n=n.newVal;for(var r=this.get("title"),i=this.get("items"),c=0;c<i.length;c++){var j=i[c];if(j.value==n){r=j.name;break}}this.title.html(r)},_itemsChange:function(n){n=n.newVal;
var r=this._selectList;r.html("");if(n)for(var i=0;i<n.length;i++){var c=n[i];(new y("<a class='ke-select-menu-item' href='#' data-value='"+c.value+"'>"+c.name+"</a>",c.attrs)).appendTo(r)._4e_unselectable()}this.as=r.all("a")},_prepare:function(){var n=this,r=n.el,i=n._focusA,c=new y("<div class='ke-menu' onmousedown='return false;'></div>"),j=new B.SimpleOverlay({el:c,focusMgr:false}),m=n.get("items");n.menu=j;n.get("title")&&(new y("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+
n.get("title")+"</div>")).appendTo(c);n._selectList=(new y("<div>")).appendTo(c);n._itemsChange({newVal:m});n.get("popUpWidth")&&c.css("width",n.get("popUpWidth"));c.appendTo(document.body);j.on("show",function(){i.addClass("ke-select-active")});j.on("hide",function(){i.removeClass("ke-select-active")});t.on([document,n.get("doc")],"click",function(q){r._4e_contains(q.target)||j.hide()});c.on("click",n._select,n);n.as=n._selectList.all("a");t.on(c[0],"mouseenter",function(){n.as.removeClass("ke-menu-selected")});
n.on("afterItemsChange",n._itemsChange,n)},_select:function(n){n.halt();var r=this.menu,i=r.el;if(n=(new y(n.target))._4e_ascendant(function(m){return i._4e_contains(m)&&m._4e_name()=="a"},true)){var c=this.get("value"),j=n.attr("data-value");this.set("value",j);this.fire("click",{newVal:j,preVal:c,name:n.html()});r.hide()}},_real:function(){var n=this.el.offset();n.top+=this.el.height();n.left+=1;if(n.left+this.menu.el.width()>u.viewportWidth()-60)n.left=u.viewportWidth()-this.menu.el.width()-60;
this.menu.show(n)},_click:function(n){n.preventDefault();var r=this.get("value");if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();r&&this.menu&&this.as.each(function(i){i.attr("data-value")==r?i.addClass("ke-menu-selected"):i.removeClass("ke-menu-selected")})}}});B.Select=v}});
KISSY.Editor.add("smiley",function(v){var s=KISSY.Editor,y=KISSY,t=y.DOM,u=y.Event,B=y.Node,n=s.SimpleOverlay,r=s.TripleButton;s.Smiley||function(){function i(m){this.editor=m;this._init()}for(var c="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",j=0;j<=98;j++)c+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+j+".gif'></a>";c+="</div></div>";y.augment(i,{_init:function(){this.el=new r({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(m){var q=this;t._4e_ascendant(m.target,function(g){return g[0]===q.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(m){m.halt();var q=this.editor;m=m.target;var g;if(t._4e_name(m)=="a"&&(g=t.attr(m,"data-icon"))){g=new B("<img alt='' src='"+g+"'/>",null,q.document);q.insertElement(g);this.smileyWin.hide()}},_prepare:function(){var m=this.editor;this.smileyPanel=new B(c);this.smileyWin=new n({el:this.smileyPanel,
focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);u.on(document,"click",this._hidePanel,this);u.on(m.document,"click",this._hidePanel,this)},_real:function(){var m=this.el.el.offset();m.top+=this.el.el.height()+5;if(m.left+this.smileyPanel.width()>t.viewportWidth()-60)m.left=t.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(m)},_show:function(m){this._prepare(m)}});s.Smiley=i}();v.addPlugin(function(){new s.Smiley(v)})});
KISSY.Editor.add("sourcearea",function(v){var s=KISSY.Editor,y=KISSY,t=y.UA,u=s.TripleButton;s.SourceArea||function(){function B(n){this.editor=n;this._init()}y.augment(B,{_init:function(){var n=this.editor;this.el=new u({container:n.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);n.textarea.on("mousedown",function(r){r.stopPropagation()})},_show:function(){var n=this.editor,r=
this.el;n.textarea.val(n.getData());n._showSource();r.set("state",u.ON)},_hide:function(){var n=this.editor,r=n.textarea,i=this.el;n._hideSource();n.setData(r.val());if(t.gecko&&n.iframeFocus){i.el[0].focus();n.focus()}i.set("state",u.OFF)}});s.SourceArea=B}();v.addPlugin(function(){new s.SourceArea(v)})});
KISSY.Editor.add("table",function(v,s){var y=KISSY.Editor,t=KISSY,u=t.Node,B=t.DOM,n=y.Walker,r=t.UA,i=y.NODE,c=y.TripleButton,j=y.SimpleOverlay,m=y.Utils.isNumber,q=y.ContextMenu,g=["tr","th","td","tbody","table"],l=t.trim,w;w=(r.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var b=v.htmlDataProcessor,d=b&&b.dataFilter;b=b&&b.htmlFilter;d&&d.addRules({elements:{table:function(h){h=h.attributes;var f=h["class"],o=parseInt(h.border,10);if(!o||o<=0)h["class"]=(f||"")+" ke_show_border"}}});b&&b.addRules({elements:{table:function(h){h=h.attributes;var f=h["class"];if(f)h["class"]=t.trim(f.replace("ke_show_border","").replace(/\s{2}/," "))}}});y.TableUI||function(){function h(A){this.editor=A;this.selectedTable=
null;A._toolbars=A._toolbars||{};A._toolbars.table=this;this._init()}function f(A){return l(A).length!=0}function o(A){function D(X){if(!(M.length>0))if(X[0].nodeType==i.NODE_ELEMENT&&H.test(X._4e_name())&&!X._4e_getData("selected_cell")){X._4e_setMarker(O,"selected_cell",true);M.push(X)}}for(var I=A.createBookmarks(),L=A.getRanges(),M=[],O={},S=0;S<L.length;S++){var R=L[S];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&M.push(R)}else{R=new n(R);
var Y;for(R.guard=D;Y=R.next();)if((Y=Y.parent())&&H.test(Y._4e_name())&&!Y._4e_getData("selected_cell")){Y._4e_setMarker(O,"selected_cell",true);M.push(Y)}}}y.Utils.clearAllMarkers(O);A.selectBookmarks(I);return M}function k(A){A=A.cells;for(var D=0;D<A.length;D++){A[D].innerHTML="";r.ie||(new u(A[D]))._4e_appendBogus()}}function a(A,D){if(A=A.getStartElement()._4e_ascendant("tr")){var I=A._4e_clone(true);I.insertBefore(A);k(D?I[0]:A[0])}}function e(A){if(A instanceof y.Selection){var D=o(A),I=D.length;
A=[];for(var L,M,O=0;O<I;O++){var S=D[O].parent(),R=S[0].rowIndex;!O&&(L=R-1);A[R]=S;O==I-1&&(M=R+1)}O=S._4e_ascendant("table");L=new u(M<O[0].rows.length&&O[0].rows[M]||L>0&&O[0].rows[L]||O[0].parentNode);for(O=A.length;O>=0;O--)A[O]&&e(A[O]);return L}else if(A instanceof u){O=A._4e_ascendant("table");O[0].rows.length==1?O._4e_remove():A._4e_remove()}return 0}function p(A,D){A=A.getStartElement();if(A=A._4e_ascendant("td",true)||A._4e_ascendant("th",true))for(var I=A._4e_ascendant("table"),L=A[0].cellIndex,
M=0;M<I[0].rows.length;M++){var O=I[0].rows[M];if(!(O.cells.length<L+1)){A=new u(O.cells[L].cloneNode(false));r.ie||A._4e_appendBogus();O=new u(O.cells[L]);D?A.insertBefore(O):A.insertAfter(O)}}}function x(A){var D=[],I=A[0]&&A[0]._4e_ascendant("table"),L,M,O,S;L=0;for(M=A.length;L<M;L++)D.push(A[L][0].cellIndex);D.sort();L=1;for(M=D.length;L<M;L++)if(D[L]-D[L-1]>1){O=D[L-1]+1;break}O||(O=D[0]>0?D[0]-1:D[D.length-1]+1);A=I[0].rows;L=0;for(M=A.length;L<M;L++)if(S=A[L].cells[O])break;return S?new u(S):
I._4e_previous()}function z(A){if(A instanceof y.Selection){var D=o(A),I=x(D);for(A=D.length-1;A>=0;A--)D[A]&&z(D[A]);return I}else if(A instanceof u){D=A._4e_ascendant("table");if(!D)return null;I=A[0].cellIndex;for(A=D[0].rows.length-1;A>=0;A--){var L=new u(D[0].rows[A]);if(!I&&L[0].cells.length==1)e(L);else L[0].cells[I]&&L[0].removeChild(L[0].cells[I])}}return null}function C(A,D){var I=new y.Range(A[0].ownerDocument);if(!I.moveToElementEditablePosition(A,D?true:s)){I.selectNodeContents(A);I.collapse(D?
false:true)}I.select(true)}t.augment(h,{_init:function(){var A=this.editor,D={};this.el=new c({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:A.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in N)(function(L){D[L]=function(){A.fire("save");N[L](A);A.fire("save")}})(I);q.register(A.document,{rules:g,width:"120px",funcs:D});y.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var A=this,D=new j({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});
D.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='6'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='6'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='6'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='6'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td></tr><tr><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='6'/></label> &nbsp;\u50cf\u7d20</select></td><td></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
D.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");var I=D.body;D.twidth=I.one(".ke-table-width");D.theight=I.one(".ke-table-height");D.tborder=I.one(".ke-table-border");D.tcaption=I.one(".ke-table-caption");D.talign=I.one(".ke-table-align");D.trows=I.one(".ke-table-rows");D.tcols=I.one(".ke-table-cols");D.thead=I.one(".ke-table-head");var L=D.foot.one(".ke-table-ok"),M=D.foot.one(".ke-table-cancel");D.twidthunit=I.one(".ke-table-width-unit");
A.tableDialog=D;L.on("click",A._tableOk,A);D.on("hide",function(){A.selectedTable=null});M.on("click",function(){D.hide()})},_tableOk:function(){for(var A=this.tableDialog,D=A.el.all("input"),I=0;I<D.length;I++){var L=new u(D[I]);if(L[0]!=A.tcaption[0])if(t.trim(L.val())&&!m(L.val())){A=L.parent("label").text().replace(/[:\uff1a]/g,"");alert(A+"\u8bf7\u8f93\u5165\u6570\u5b57");return}}this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var A=this.tableDialog,D=this.selectedTable,
I=D.one("caption");f(A.talign.val())?D.attr("align",l(A.talign.val())):D.removeAttr("align");f(A.tborder.val())?D.attr("border",l(A.tborder.val())):D.removeAttr("border");!f(A.tborder.val())||A.tborder.val()=="0"?D.addClass("ke_show_border"):D.removeClass("ke_show_border");f(A.twidth.val())?D.css("width",l(A.twidth.val())+A.twidthunit.val()):D.css("width","");f(A.theight.val())?D.css("height",l(A.theight.val())):D.css("height","");if(f(A.tcaption.val()))I&&I[0]?I.html(l(A.tcaption.val())):(new u("<caption><span>"+
l(A.tcaption.val())+"</span></caption>")).insertBefore(D[0].firstChild);else I&&I._4e_remove();A.hide()},_genTable:function(){var A=this.tableDialog,D="<table ",I,L=parseInt(A.tcols.val())||1,M=parseInt(A.trows.val())||1,O=r.ie?"":"<br/>",S=this.editor;if(f(A.talign.val()))D+="align='"+t.trim(A.talign.val())+"' ";if(f(A.tborder.val()))D+="border='"+t.trim(A.tborder.val())+"' ";if(f(A.twidth.val())||f(A.theight.val())){D+="style='";if(f(A.twidth.val()))D+="width:"+t.trim(A.twidth.val())+A.twidthunit.val()+
";";if(f(A.theight.val()))D+="height:"+t.trim(A.theight.val())+"px;";D+="' "}if(!f(A.tborder.val())||t.trim(A.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(f(A.tcaption.val()))D+="<caption><span>"+t.trim(A.tcaption.val())+"</span></caption>";if(A.thead.val()){D+="<thead>";D+="<tr>";for(I=0;I<L;I++)D+="<th>"+O+"</th>";D+="</tr>";D+="</thead>";M-=1}D+="<tbody>";for(var R=0;R<M;R++){D+="<tr>";for(I=0;I<L;I++)D+="<td>"+O+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new u(D,null,S.document);
S.insertElement(D);A.hide()},_fillTableDialog:function(){var A=this.tableDialog,D=this.selectedTable,I=D.one("caption");A.talign.val(D.attr("align")||"");A.tborder.val(D.attr("border")||"");var L=D._4e_style("width")||"";A.twidth.val(L.replace(/px|%/i,""));L.indexOf("%")!=-1?A.twidthunit.val("%"):A.twidthunit.val("px");A.theight.val((D._4e_style("height")||"").replace(/px|%/i,""));L="";if(I)L=I.text();A.tcaption.val(L);A.trows.val(D.one("tbody").children().length);A.tcols.val(D.one("tr").children().length);
A.thead.val(D._4e_first(function(M){return M._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var H=/^(?:td|th)$/,N={"\u8868\u683c\u5c5e\u6027":function(A){var D=A.getSelection();
if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",true)){A=A._toolbars.table;A.selectedTable=D;A._tableShow()}},"\u5220\u9664\u8868\u683c":function(A){var D=(A=A.getSelection())&&A.getStartElement();if(D=D&&D._4e_ascendant("table",true)){A.selectElement(D);var I=A.getRanges()[0];I.collapse();A.selectRanges([I]);A=D.parent();A[0].childNodes.length==1&&A._4e_name()!="body"&&A._4e_name()!="td"?A._4e_remove():D._4e_remove()}},"\u5220\u9664\u884c ":function(A){A=A.getSelection();C(e(A),s)},"\u5220\u9664\u5217 ":function(A){A=
A.getSelection();(A=z(A))&&C(A,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(A){A=A.getSelection();a(A,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(A){A=A.getSelection();a(A,s)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(A){A=A.getSelection();p(A,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(A){A=A.getSelection();p(A,s)}};y.TableUI=h}();v.addPlugin(function(){var h=v.document;new y.TableUI(v);var f=B.create("<style>",null,h);h.getElementsByTagName("head")[0].appendChild(f);
if(f.styleSheet)f.styleSheet.cssText=w;else f.appendChild(h.createTextNode(w))})});
KISSY.Editor.add("templates",function(v){var s=KISSY.Editor,y=KISSY,t=y.Node,u=s.TripleButton,B=s.SimpleOverlay;s.TplUI||function(){function n(r){this.editor=r;this._init()}y.augment(n,{_init:function(){(new u({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var r=this.editor,i=r.cfg.pluginConfig.templates||[],c="<div class='ke-tpl'>",j=0;j<i.length;j++)c+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
i[j].demo+"</a>";c+="</div>";this._initDialogOk=true;var m=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});m.body.html(c);m.body.all(".ke-tpl-list").on("click",function(q){q.halt();q=(new t(q.target))._4e_index();q!=-1&&r.insertHtml(i[q].html);m.hide()});this.ui=m},_real:function(){this.ui.show()},_show:function(){this._prepare()}});s.TplUI=n}();v.addPlugin(function(){new s.TplUI(v)})});
KISSY.Editor.add("undo",function(v){var s=KISSY,y=s.Editor,t=y.Utils.arrayCompare,u=s.UA,B=s.Event;y.UndoManager||function(){function n(g){var l=g._getRawData();g=l&&g.getSelection();this.contents=l;this.bookmarks=g&&g.createBookmarks2(true)}function r(g){this.history=[];this.index=-1;this.editor=g;this.bufferRunner=y.Utils.buffer(this.save,this,500);this._init()}function i(g,l,w,b){this.editor=g;this.title=w;this.text=l;this.contentCls=b;this._init()}s.augment(n,{equals:function(g){if(this.contents!=
g.contents)return false;var l=this.bookmarks;g=g.bookmarks;if(l||g){if(!l||!g||l.length!=g.length)return false;for(var w=0;w<l.length;w++){var b=l[w],d=g[w];if(b.startOffset!=d.startOffset||b.endOffset!=d.endOffset||!t(b.start,d.start)||!t(b.end,d.end))return false}}return true}});var c={16:1,17:1,18:1},j={37:1,38:1,39:1,40:1,33:1,34:1};s.augment(r,{_keyMonitor:function(){var g=this.editor;B.on(g.document,"keydown",function(l){var w=l.keyCode;if(!(w in j||w in c))if(w===90&&(l.ctrlKey||l.metaKey)){g.fire("restore",
{d:-1});l.halt()}else if(w===89&&(l.ctrlKey||l.metaKey)){g.fire("restore",{d:1});l.halt()}else g.fire("save",{buffer:1})})},_init:function(){var g=this,l=g.editor;l.on("save",function(w){w.buffer?g.bufferRunner():g.save()});l.on("restore",g.restore,g);g._keyMonitor()},save:function(){var g=this.history,l=this.index;g.length>l+1&&g.splice(l+1,g.length-l-1);var w=this.editor;l=g[g.length-1];var b=new n(w);if(!l||!l.equals(b)){g.length===30&&g.shift();g.push(b);this.index=l=g.length-1;w.fire("afterSave",
{history:g,index:l})}},restore:function(g){g=g.d;var l=this.history,w=this.editor,b=l[this.index+g];if(b){w._setRawData(b.contents);if(b.bookmarks)w.getSelection().selectBookmarks(b.bookmarks);else if(u.ie){b=w.document.body.createTextRange();b.collapse(true);b.select()}this.index+=g;w.fire("afterRestore",{history:l,index:this.index});w.notifySelectionChange()}}});var m=y.TripleButton,q={redo:1,undo:-1};s.augment(i,{_init:function(){var g=this,l=g.editor;g.el=new m({contentCls:g.contentCls,title:g.title,
container:l.toolBarDiv});var w=g.el;w.set("state",m.DISABLED);l.on("afterSave afterRestore",g._respond,g);w.on("offClick",function(){l.fire("restore",{d:q[g.text]})})},_respond:function(g){this.updateUI(g.history,g.index)},updateUI:function(g,l){var w=this.el,b=this.text;if(b=="undo")l>0?w.set("state",m.OFF):w.set("state",m.DISABLED);else if(b=="redo")l<g.length-1?w.set("state",m.OFF):w.set("state",m.DISABLED)}});y.UndoManager=r;y.RestoreUI=i}();v.addPlugin(function(){new y.UndoManager(v);new y.RestoreUI(v,
"undo","\u64a4\u9500","ke-toolbar-undo");new y.RestoreUI(v,"redo","\u91cd\u505a","ke-toolbar-redo")})});
