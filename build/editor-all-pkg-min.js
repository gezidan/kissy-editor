KISSY.add("editor",function(v,s){function A(w,c){var a=this;if(!(a instanceof A))return new A(w,c);if(v.isString(w))w=v.one(w);w[0]||(w=new Node(w));a.cfg=c||{pluginConfig:{}};v.app(a,v.EventTarget);a.use=function(f){if(v.isString(f))f=f.split(",");var i=f;f=[];f=v.indexOf("separator",i);var d=f!=-1;f=i.splice(0,d?f+1:i.length);d&&f.pop();f.length!=0?v.use.call(a,f.join(","),function(){d&&a.addPlugin(function(){A.Utils.addSeparator(a.toolBarDiv)});a.use(i)},{order:true,global:A}):a.on("dataReady",
function(){a.setData(w.val())});return a};a.init(w);return s}function t(w){if(!x)return"build/"+w.replace(/\.(js|css)/i,"-min.$1");if(x==="dev")return w;return"build/"+w}v.app(A,v.EventTarget);A.Config.base=v.Config.base+"editor/";var x=v.Config.debug,B={htmlparser:{attach:false,path:t("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},o=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],r=["clipboard",{name:"color"},{name:"elementpaths"},
"enterkey","fakeobjects",{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["contextmenu","fakeobjects","overlay"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize","music","preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo"],
j=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],g=[{name:"button"},{name:"overlay"},{name:"contextmenu",requires:["overlay"]},
{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}],h,k,q,p,n;h=0;for(k=g.length;h<k;h++){p=q=g[h];n=s;if(!v.isString(q)){n=q.requires;p=q.name}B[p]={attach:false,requires:n,path:t("ui/"+p+".js"),csspath:q.useCss?t("ui/"+p+".css"):""}}h=0;for(k=r.length;h<k;h++){p=q=r[h];n=["button"];if(!v.isString(q)){q.requires&&(n=n.concat(q.requires));p=q.name}B[p]={attach:false,requires:n,csspath:q.useCss?t("plugins/"+p+"/plugin.css"):s,path:t("plugins/"+p+"/plugin.js")}}h=0;for(k=
j.length;h<k;h++){q=j[h];n=s;if(!v.isString(q)){n=q.requires;q=q.name}B[q]={attach:false,requires:n,path:t("plugins/htmldataprocessor/htmlparser/"+q.substring(11)+".js")}}A.add(B);B={};h=0;for(k=o.length;h<k;h++){q=o[h];B[q]={host:"editor",requires:h>0?o[h-1]:[]}}A.add(B);v.Editor=A});
KISSY.Editor.add("utils",function(v){var s=KISSY,A=s.Node,t=s.DOM,x=s.Config.debug,B=s.UA;v.Utils={getFlashUrl:function(o){var r="",j=v.NODE;if(o._4e_name()=="object"){o=o[0].childNodes;for(var g=0;g<o.length;g++)if(o[g].nodeType==j.NODE_ELEMENT)if((t.attr(o[g],"name")||"").toLowerCase()=="movie")r=t.attr(o[g],"value");else if(t._4e_name(o[g])=="embed")r=t.attr(o[g],"src");else t._4e_name(o[g])=="object"&&t.attr(o[g],"data")}else if(o._4e_name()=="embed")r=o.attr("src");return r},debugUrl:function(o){if(!x)return"build/"+
o.replace(/\.(js|css)/i,"-min.$1");if(x==="dev")return o;return"build/"+o},lazyRun:function(o,r,j){var g=o[r],h=o[j];o[r]=function(){g.apply(this,arguments);o[r]=o[j];return h.apply(this,arguments)}},getXY:function(o,r,j,g){j=j.defaultView||j.parentWindow;o-=t.scrollLeft(j);r-=t.scrollTop(j);if(g)if(j!=(g.defaultView||g.parentWindow)&&j.frameElement){g=t._4e_getOffset(j.frameElement,g);o+=g.left;r+=g.top}return{left:o,top:r}},tryThese:function(){for(var o,r=0,j=arguments.length;r<j;r++){var g=arguments[r];
try{o=g();break}catch(h){}}return o},arrayCompare:function(o,r){if(!o&&!r)return true;if(!o||!r||o.length!=r.length)return false;for(var j=0;j<o.length;j++)if(o[j]!==r[j])return false;return true},getByAddress:function(o,r,j){o=o.documentElement;for(var g=0;o&&g<r.length;g++){var h=r[g];if(j)for(var k=-1,q=0;q<o.childNodes.length;q++){var p=o.childNodes[q];if(!(j===true&&p.nodeType==3&&p.previousSibling&&p.previousSibling.nodeType==3)){k++;if(k==h){o=p;break}}}else o=o.childNodes[h]}return o?new A(o):
null},clearAllMarkers:function(o){for(var r in o)o[r]._4e_clearMarkers(o,true)},htmlEncodeAttr:function(o){return o.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(o){return o.replace(/^\s+/,"")},rtrim:function(o){return o.replace(/\s+$/,"")},trim:function(o){return this.ltrim(this.rtrim(o))},mix:function(){for(var o={},r=0;r<arguments.length;r++)o=s.mix(o,arguments[r]);return o},isCustomDomain:function(){if(!B.ie)return false;var o=document.domain,r=window.location.hostname;
return o!=r&&o!="["+r+"]"},addSeparator:function(o){(new s.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(o)}}});
KISSY.Editor.add("focusmanager",function(v){function s(){this.iframeFocus=true;r=this}function A(){this.iframeFocus=false;r=null}var t=KISSY,x=t.DOM,B=t.Event;t={};var o={},r;t={refreshAll:function(){for(var j in o){var g=o[j];g.document.designMode="off";g.document.designMode="on"}},currentInstance:function(){return r},getInstance:function(j){return o[j]},add:function(j){var g=x._4e_getWin(j.document);B.on(g,"focus",s,j);B.on(g,"blur",A,j)},register:function(j){o[j._UUID]=j},remove:function(j){delete o[j._UUID];
var g=x._4e_getWin(j.document);B.remove(g,"focus",s,j);B.remove(g,"blur",A,j)}};v.focusManager=t});
KISSY.Editor.add("definition",function(v){function s(n){return g+"<html><head><title>kissy-editor</title><link href='"+v.Config.base+h+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(n?'<script id="ke_actscrpt" type="text/javascript">'+(v.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+n+'");<\/script>':"")}var A=KISSY,t=A.UA,x=A.DOM,B=A.Node,o=A.Event,r=v.focusManager,j=v.Utils.tryThese,g="<!doctype html>",h=
v.Utils.debugUrl("assets/editor-iframe.css"),k=1,q="document.open();"+(v.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",p="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(t.ie?"javascript:void(function(){"+encodeURIComponent(q)+"}())":"")+'"  tabIndex="'+
(t.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";A.augment(v,{init:function(n){var w=this,c=new B(p.replace(/\$\(tabIndex\)/,n.attr("tabIndex")));c.on("mousedown",function(i){if(t.webkit){var d=x._4e_name(i.target);if(d=="select"||d=="option")return true}i.halt()});w.editorWrap=c;w._UUID=k++;r.register(w);w.wrap=c.one(".ke-textarea-wrap");w.iframe=w.wrap.one("iframe");w.toolBarDiv=c.one(".ke-editor-tools");w.textarea=
n;w.statusDiv=c.one(".ke-editor-status");w.toolBarDiv._4e_unselectable();w._commands={};w._plugins={};var a=n._4e_style("width"),f=n._4e_style("height");if(a){c.css("width",a);n.css("width","100%")}w.textarea.css("display","none");c.insertAfter(n);w.wrap[0].appendChild(n[0]);if(f){w.wrap.css("height",f);n.css("height","100%")}n=w.iframe;w.on("dataReady",function(){w.ready=true;v.fire("instanceCreated",{editor:w})});t.gecko?n.on("load",w._setUpIFrame,w):w._setUpIFrame()},addCommand:function(n,w){this._commands[n]=
w},execCommand:function(n){this.fire("save");this._commands[n].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(n){if(this.htmlDataProcessor)n=this.htmlDataProcessor.toDataFormat(n,"p");this.document.body.innerHTML=n},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(n){this.document.body.innerHTML=
n},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");t.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:s,getSelection:function(){var n=new v.Selection(this.document);return!n||n.isInvalid?null:n},focus:function(){var n=x._4e_getWin(this.document);t.webkit&&n&&n.parent&&n.parent.focus();n&&n.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){x._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function n(){i=f.document;w.document=i;c.detach();i.open("text/html","replace");i.write(a);i.close()}
var w=this,c=w.iframe,a=s(w._UUID),f=c[0].contentWindow,i;try{i=f.document}catch(d){c[0].src=c[0].src;if(t.ie&&t.ie<7){setTimeout(n,10);return}}n()},addPlugin:function(n){this.ready?n():this.on("dataReady",n)},_monitor:function(){var n=this;n._monitorId&&clearTimeout(n._monitorId);n._monitorId=setTimeout(function(){var w=n.getSelection();if(w&&!w.isInvalid){w=w.getStartElement();var c=new v.ElementPath(w);if(!n.previousPath||!n.previousPath.compare(c)){n.previousPath=c;n.fire("selectionChange",{selection:n,
path:c,element:w})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(n,w){var c=this;c.focus();var a=n._4e_name(),f=v.XHTML_DTD,i=v.RANGE,d=v.NODE,m=f.$block[a],b=c.getSelection(),e=b.getRanges(),l,z,u,D,H;c.fire("save");for(var y=e.length-1;y>=0;y--){l=e[y];l.deleteContents();z=!y&&n||n._4e_clone(true);w&&w(z);if(m)for(;(D=l.getCommonAncestor(false,true))&&(H=f[D._4e_name()])&&!(H&&H[a]);)if(D._4e_name()in f.span)l.splitElement(D);else if(l.checkStartOfBlock()&&
l.checkEndOfBlock()){l.setStartBefore(D);l.collapse(true);D._4e_remove()}else l.splitBlock();l.insertNode(z);u||(u=z)}n=u._4e_nextSourceNode(true);H=v.XHTML_DTD;if(!H.$inline[z._4e_name()])if(n){if(n._4e_name()=="br"&&H[n.parent()._4e_name()].p){H=new B("<p>&nbsp;</p>",null,c.document);n[0].parentNode.replaceChild(H[0],n[0]);n=H}}else{H=new B("<p>&nbsp;</p>",null,c.document);H.insertAfter(u);n=H}l.moveToPosition(u,i.POSITION_AFTER_END);n&&n[0].nodeType==d.NODE_ELEMENT&&l.moveToElementEditablePosition(n);
b.selectRanges([l]);c.focus();z&&z._4e_scrollIntoView();setTimeout(function(){c.fire("save")},10)},insertHtml:function(n){var w=this;if(w.htmlDataProcessor)n=w.htmlDataProcessor.toDataFormat(n);if(t.webkit){n=x.create(n,null,this.document);n=n.nodeType==11?A.makeArray(n.childNodes):[n];for(var c=0;c<n.length;c++)w.insertElement(new B(n[c]))}else{w.focus();w.fire("save");c=w.getSelection();if(t.ie){c=c.getNative();c.type=="Control"&&c.clear();c.createRange().pasteHTML(n)}else w.document.execCommand("inserthtml",
false,n);w.focus();setTimeout(function(){w.fire("save")},10)}}});v._initIFrame=function(n){function w(u){j(function(){f.designMode="on";setTimeout(function(){f.designMode="off";d.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){f.designMode="off";x.attr(d,"contentEditable",false);x.attr(d,"contentEditable",true);!u&&w(1)})}var c=r.getInstance(n);n=c.textarea[0];var a=c.iframe[0].contentWindow,f=c.document,i=f.getElementById("ke_actscrpt");i.parentNode.removeChild(i);
var d=f.body;if(t.ie){d.hideFocus=true;d.disabled=true;d.contentEditable=true;d.removeAttribute("disabled")}else setTimeout(function(){if(t.gecko||t.opera)d.contentEditable=true;else if(t.webkit)d.parentNode.contentEditable=true;else f.designMode="on"},0);try{f.execCommand("enableObjectResizing",false,true)}catch(m){}try{f.execCommand("enableInlineTableEditing",false,true)}catch(b){}t.webkit&&o.on(f,"mousedown",function(u){u=new B(u.target);A.inArray(u._4e_name(),["img","hr","input","textarea","select"])&&
c.getSelection().selectElement(u)});if(t.webkit){o.on(f,"click",function(u){var D=new B(u.target);A.inArray(D._4e_name(),["input","select"])&&u.preventDefault()});o.on(f,"mouseup",function(u){var D=new B(u.target);A.inArray(D._4e_name(),["input","textarea"])&&u.preventDefault()})}if(t.gecko||t.ie||t.opera){var e;e=new B(x.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],n));e.on("focus",function(){c.focus()});c.on("destroy",function(){})}if(t.ie&&f.compatMode=="CSS1Compat"||
t.gecko||t.opera){var l=new B(f.documentElement);l.on("mousedown",function(u){if(u.target===l[0]){t.gecko&&w(false);e[0].focus()}})}o.on(a,"focus",function(){if(t.gecko)w(false);else t.opera&&d.focus();c.notifySelectionChange()});t.gecko&&o.on(c.document,"mousedown",function(){c.iframeFocus||w(false)});if(t.ie){o.on(f,"keydown",function(u){if(u.keyCode in{8:1,46:1}){var D=c.getSelection(),H=D.getSelectedElement();if(H){c.fire("save");var y=D.getRanges()[0].createBookmark();H._4e_remove();D.selectBookmarks([y]);
c.fire("save");u.preventDefault()}}});if(f.compatMode=="CSS1Compat"){var z={33:1,34:1};o.on(f,"keydown",function(u){u.keyCode in z&&setTimeout(function(){c.getSelection().scrollIntoView()},0)})}}setTimeout(function(){t.ie&&setTimeout(function(){if(f){d.runtimeStyle.marginBottom="0px";d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.fire("dataReady")},10);r.add(c)};t.gecko&&function(){var n=document.body;if(n){var w=n.getAttribute("onpageshow");n.setAttribute("onpageshow",(w?w+";":
"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(v){v.XHTML_DTD=function(){var s=function(m){for(var b=arguments.length-1;b>0;)KISSY.mix(m,arguments[b--]);return m},A={isindex:1,fieldset:1},t={input:1,button:1,select:1,textarea:1,label:1},x=s({a:1},t),B=s({iframe:1},x),o={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},r={ins:1,del:1,script:1,style:1},j=s({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},r),g=s({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},j),h=s({p:1},g);t=s({iframe:1},g,t);g={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var k=s({a:1},t),q={tr:1},p={"#":1},n=s({param:1},g),w=s({form:1},A,B,o,h),c={li:1},a={base:1,link:1,meta:1,title:1},f=s(a,{style:1,script:1}),i={head:1,body:1},d={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:s({html:1},i,a),$block:d,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:k,$body:s({script:1,style:1},d),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:i,head:f,style:p,body:w,base:{},link:{},meta:{},title:p,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:w,td:w,br:{},th:w,center:w,kbd:k,button:s(h,o),basefont:{},h5:k,h4:k,samp:k,h6:k,ol:c,h1:k,h3:k,option:p,h2:k,form:s(A,B,o,h),select:{optgroup:1,option:1},font:k,ins:k,menu:c,abbr:k,label:k,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:k,script:p,tfoot:q,cite:k,li:w,input:{},iframe:w,strong:k,textarea:p,noframes:w,big:k,small:k,span:k,hr:{},dt:k,sub:k,optgroup:{option:1},param:{},bdo:k,"var":k,div:w,object:n,sup:k,dd:w,strike:k,area:{},dir:c,map:s({area:1,form:1,p:1},A,r,o),applet:n,dl:{dt:1,dd:1},del:k,isindex:{},fieldset:s({legend:1},g),thead:q,ul:c,acronym:k,b:k,a:t,blockquote:w,caption:k,i:k,u:k,tbody:q,s:k,address:s(B,h),tt:k,legend:k,q:k,pre:s(j,x),p:k,em:k,dfn:k}}()});
KISSY.Editor.add("dom",function(v){function s(c){return c.replace(/-(\w)/g,function(a,f){return f.toUpperCase()})}var A=KISSY,t=A.DOM,x=A.UA,B=A.Node,o=v.Utils,r={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};v.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};v.POSITION={};var j=v.NODE,g=v.POSITION;g.POSITION_IDENTICAL=0;g.POSITION_DISCONNECTED=
1;g.POSITION_FOLLOWING=2;g.POSITION_PRECEDING=4;g.POSITION_IS_CONTAINED=8;g.POSITION_CONTAINS=16;var h={},k={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},q={hr:1},p=function(c){return c[0]||c},n=function(c){if(!c[0])return new B(c);return c},w={_4e_equals:function(c,a){if(!c&&!a)return true;if(!c||!a)return false;c=p(c);a=p(a);return c===a},_4e_isBlockBoundary:function(c,
a){c=n(c);a=A.mix(A.mix({},q),a||{});return k[c.css("display")]||a[c._4e_name()]},_4e_getWin:function(c){return c&&"scrollTo"in c&&c.document?c:c&&c.nodeType===9?c.defaultView||c.parentWindow:false},_4e_index:function(c){c=p(c);for(var a=c.parentNode.childNodes,f=0;f<a.length;f++)if(a[f]===c)return f;return-1},_4e_first:function(c,a){c=p(c);if((c=(c=c.firstChild)&&new B(c))&&a&&!a(c))c=c._4e_next(a);return c},_4e_move:function(c,a,f){c._4e_remove();c=p(c);a=p(a);f?a.insertBefore(c,a.firstChild):a.appendChild(c)},
_4e_name:function(c){c=p(c);var a=c.nodeName.toLowerCase();if(x.ie)if((c=c.scopeName)&&c!="HTML")a=c.toLowerCase()+":"+a;return a},_4e_isIdentical:function(c,a){if(c._4e_name()!=a._4e_name())return false;var f=c[0].attributes,i=a[0].attributes,d=f.length,m=i.length;if(!x.ie&&d!=m)return false;for(var b=0;b<d;b++){var e=f[b];if((!x.ie||e.specified&&e.nodeName!="_ke_expando")&&e.nodeValue!=a.attr(e.nodeName))return false}if(x.ie)for(b=0;b<m;b++){e=i[b];if(e.specified&&e.nodeName!="_ke_expando"&&e.nodeValue!=
c.attr(e.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(c){c=p(c).childNodes;for(var a=0,f=c.length;a<f;a++){var i=c[a],d=i.nodeType;if(!(d==j.NODE_ELEMENT&&i.getAttribute("_ke_bookmark")))if(d==j.NODE_ELEMENT&&!w._4e_isEmptyInlineRemoveable(i)||d==j.NODE_TEXT&&A.trim(i.nodeValue))return false}return true},_4e_moveChildren:function(c,a,f){c=p(c);a=a[0]||a;if(c!=a)if(f)for(;f=c.lastChild;)a.insertBefore(c.removeChild(f),a.firstChild);else for(;f=c.firstChild;)a.appendChild(c.removeChild(f))},
_4e_mergeSiblings:function(){function c(a,f,i){if(f[0]&&f[0].nodeType==j.NODE_ELEMENT){for(var d=[];f.attr("_ke_bookmark")||f._4e_isEmptyInlineRemoveable();){d.push(f);f=i?new B(f[0].nextSibling):new B(f[0].previousSibling);if(!f[0]||f[0].nodeType!=j.NODE_ELEMENT)return}if(a._4e_isIdentical(f)){for(var m=i?a[0].lastChild:a[0].firstChild;d.length;)d.shift()._4e_move(a,!i);f._4e_moveChildren(a,!i);f._4e_remove();m[0]&&m[0].nodeType==j.NODE_ELEMENT&&m._4e_mergeSiblings()}}}return function(a){if(a[0])if(r[a._4e_name()]||
a._4e_name()=="a"){c(a,new B(a[0].nextSibling),true);c(a,new B(a[0].previousSibling))}}}(),_4e_unselectable:x.gecko?function(c){c=p(c);c.style.MozUserSelect="none"}:x.webkit?function(c){c=p(c);c.style.KhtmlUserSelect="none"}:function(c){c=p(c);if(x.ie||x.opera){var a,f=0;for(c.unselectable="on";a=c.all[f++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.unselectable="on"}}},_4e_getOffset:function(c,a){c=p(c);var f,i=0;f=0;var d=c.ownerDocument.defaultView||
c.ownerDocument.parentWindow,m=c.ownerDocument,b=m.documentElement;a=a||m;if(c.getBoundingClientRect){if(c!==m.body&&b!==c){f=c.getBoundingClientRect();i=f.left+(a===m?t.scrollLeft(d):0);f=f.top+(a===m?t.scrollTop(d):0)}if(a)if(d!=(a.defaultView||a.parentWindow)&&d.frameElement){a=w._4e_getOffset(d.frameElement,a);i+=a.left;f+=a.top}}return{left:i,top:f}},_4e_getFrameDocument:function(c){return(c=p(c))&&c.contentWindow.document},_4e_splitText:function(c,a){c=p(c);var f=c.ownerDocument;if(!(!c||c.nodeType!=
j.NODE_TEXT)){if(x.ie&&a==c.nodeValue.length){f=f.createTextNode("");t.insertAfter(f,c);return f}c=new B(c.splitText(a));if(x.ie==8){f=f.createTextNode("");t.insertAfter(f,c[0]);f.parentNode.removeChild(f)}return c}},_4e_parents:function(c,a){c=n(c);var f=[];do f[a?"push":"unshift"](c);while(c=c.parent());return f},_4e_clone:function(c,a,f){c=p(c);c=c.cloneNode(a);if(!f){var i=function(d){if(d.nodeType==j.NODE_ELEMENT){d.removeAttribute("id",false);d.removeAttribute("_ke_expando",false);d=d.childNodes;
for(var m=0;m<d.length;m++)i(d[m])}};i(c)}return new B(c)},_4e_nextSourceNode:function(c,a,f,i){c=p(c);if(i&&!i.call){var d=i[0]||i;i=function(b){b=b[0]||b;return b!==d}}a=!a&&c.firstChild;var m=new B(c);if(!a){if(c.nodeType==j.NODE_ELEMENT&&i&&i(this,true)===false)return null;a=c.nextSibling}for(;!a&&(m=m.parent());){if(i&&i(m,true)===false)return null;a=m[0].nextSibling}if(!a)return null;a=new B(a);if(i&&i(a)===false)return null;if(f&&f!=a[0].nodeType)return a._4e_nextSourceNode(false,f,i);return a},
_4e_previousSourceNode:function(c,a,f,i){c=p(c);if(i&&!i.call){var d=i[0]||i;i=function(b){b=b[0]||b;return b!==d}}a=!a&&c.lastChild;var m=new B(c);if(!a){if(c.nodeType==j.NODE_ELEMENT&&i&&i(c,true)===false)return null;a=c.previousSibling}for(;!a&&(m=m.parent());){if(i&&i(m,true)===false)return null;a=m[0].previousSibling}if(!a)return null;a=new B(a);if(i&&i(a)===false)return null;if(f&&a[0].nodeType!=f)return a._4e_previousSourceNode(false,f,i);return a},_4e_contains:x.ie||x.webkit?function(c,a){c=
p(c);a=p(a);return a.nodeType!=j.NODE_ELEMENT?c.contains(a.parentNode):c!=a&&c.contains(a)}:function(c,a){c=p(c);a=p(a);return!!(c.compareDocumentPosition(a)&16)},_4e_commonAncestor:function(c,a){if(c._4e_equals(a))return c;if(a[0].nodeType!=j.NODE_TEXT&&a._4e_contains(c))return a;c=c[0].nodeType==j.NODE_TEXT?c.parent():c;do if(c[0].nodeType!=j.NODE_TEXT&&c._4e_contains(a))return c;while(c=c.parent());return null},_4e_ascendant:function(c,a,f){c=p(c);if(!f)c=c.parentNode;if(a&&!A.isFunction(a)){var i=
a;a=function(d){return d._4e_name()==i}}for(;c&&c.nodeType!=9;){if(!a||a(new B(c))===true)return new B(c);c=c.parentNode}return null},_4e_hasAttribute:function(c,a){c=p(c);c=c.attributes.getNamedItem(a);return!!(c&&c.specified)},_4e_hasAttributes:x.ie?function(c){c=p(c);for(var a=c.attributes,f=0;f<a.length;f++){var i=a[f];switch(i.nodeName){case "class":if(c.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(i.specified)return true}}return false}:function(c){c=p(c);x.gecko&&
c.removeAttribute("_moz_dirty");c=c.attributes;return c.length>1||c.length==1&&c[0].nodeName!="_ke_expando"},_4e_position:function(c,a){var f=p(c),i=p(a);if(f.compareDocumentPosition)return f.compareDocumentPosition(i);if(f==i)return g.POSITION_IDENTICAL;if(f.nodeType==j.NODE_ELEMENT&&i.nodeType==j.NODE_ELEMENT){if(f.contains){if(f.contains(i))return g.POSITION_CONTAINS+g.POSITION_PRECEDING;if(i.contains(f))return g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING}if("sourceIndex"in f)return f.sourceIndex<
0||i.sourceIndex<0?g.POSITION_DISCONNECTED:f.sourceIndex<i.sourceIndex?g.POSITION_PRECEDING:g.POSITION_FOLLOWING}c=c._4e_address();a=a._4e_address();f=Math.min(c.length,a.length);for(i=0;i<=f-1;i++)if(c[i]!=a[i]){if(i<f)return c[i]<a[i]?g.POSITION_PRECEDING:g.POSITION_FOLLOWING;break}return c.length<a.length?g.POSITION_CONTAINS+g.POSITION_PRECEDING:g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING},_4e_address:function(c,a){c=p(c);var f=[],i=c.ownerDocument.documentElement;for(c=c;c&&c!=i;){var d=c.parentNode,
m=-1;if(d){for(var b=0;b<d.childNodes.length;b++){var e=d.childNodes[b];if(!(a&&e.nodeType==3&&e.previousSibling&&e.previousSibling.nodeType==3)){m++;if(e==c)break}}f.unshift(m)}c=d}return f},_4e_breakParent:function(c,a){var f=new v.Range(c[0].ownerDocument);f.setStartAfter(c);f.setEndAfter(a);a=f.extractContents();f.insertNode(c._4e_remove());c[0].parentNode.insertBefore(a,c[0].nextSibling)},_4e_style:function(c,a,f){if(f!==undefined)return c.css(a,f);c=c[0]||c;return c.style[s(a)]},_4e_remove:function(c,
a){var f=p(c),i=f.parentNode;if(i){if(a)for(;a=f.firstChild;)i.insertBefore(f.removeChild(a),f);i.removeChild(f)}return c},_4e_trim:function(c){t._4e_ltrim(c);t._4e_rtrim(c)},_4e_ltrim:function(c){c=p(c);for(var a;a=c.firstChild;){if(a.nodeType==j.NODE_TEXT){var f=o.ltrim(a.nodeValue),i=a.nodeValue.length;if(f){if(f.length<i){(new B(a))._4e_splitText(i-f.length);c.removeChild(c.firstChild)}}else{c.removeChild(a);continue}}break}},_4e_rtrim:function(c){c=p(c);for(var a;a=c.lastChild;){if(a.type==j.NODE_TEXT){var f=
o.rtrim(a.nodeValue),i=a.nodeValue.length;if(f){if(f.length<i){(new B(a))._4e_splitText(f.length);c.removeChild(c.lastChild)}}else{c.removeChild(a);continue}}break}if(!x.ie&&!x.opera)(a=c.lastChild)&&a.nodeType==1&&a.nodeName.toLowerCase()=="br"&&a.parentNode.removeChild(a)},_4e_appendBogus:function(c){c=p(c);for(var a=c.lastChild;a&&a.nodeType==j.NODE_TEXT&&!A.trim(a.nodeValue);)a=a.previousSibling;if(!a||a.nodeType==j.NODE_TEXT||t._4e_name(a)!=="br"){a=x.opera?c.ownerDocument.createTextNode(""):
c.ownerDocument.createElement("br");x.gecko&&a.setAttribute("type","_moz");c.appendChild(a)}},_4e_previous:function(c,a){c=p(c);var f;do f=(c=c.previousSibling)&&new B(c);while(f&&a&&!a(f));return f},_4e_last:function(c,a){if((c=(c=c[0].lastChild)&&new B(c))&&a&&!a(c))c=c._4e_previous(a);return c},_4e_next:function(c,a){c=p(c);var f;do f=(c=c.nextSibling)&&new B(c);while(f&&a&&!a(f));return f},_4e_outerHtml:function(c){c=p(c);if(c.outerHTML)return c.outerHTML.replace(/<\?[^>]*>/,"");var a=c.ownerDocument.createElement("div");
a.appendChild(c.cloneNode(true));return a.innerHTML},_4e_setMarker:function(c,a,f,i){c[0]||(c=new B(c));var d=c._4e_getData("list_marker_id")||c._4e_setData("list_marker_id",A.guid())._4e_getData("list_marker_id"),m=c._4e_getData("list_marker_names")||c._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");a[d]=c;m[f]=1;return c._4e_setData(f,i)},_4e_clearMarkers:function(c,a,f){c=n(c);var i=c._4e_getData("list_marker_names"),d=c._4e_getData("list_marker_id");for(var m in i)c._4e_removeData(m);
c._4e_removeData("list_marker_names");if(f){c._4e_removeData("list_marker_id");delete a[d]}},_4e_setData:function(c,a,f){var i=t._4e_getUniqueId(c);(h[i]||(h[i]={}))[a]=f;return c},_4e_getData:function(c,a){c=p(c);return(c=(c=c.getAttribute("_ke_expando"))&&h[c])&&c[a]},_4e_removeData:function(c,a){c=p(c);var f=c.getAttribute("_ke_expando");var i=(f=f&&h[f])&&f[a];typeof i!="undefined"&&f&&delete f[a];A.isEmptyObject(f)&&t._4e_clearData(c);return i||null},_4e_clearData:function(c){c=p(c);var a=c.getAttribute("_ke_expando");
a&&delete h[a];a&&c.removeAttribute("_ke_expando")},_4e_getUniqueId:function(c){c=p(c);var a=c.getAttribute("_ke_expando");if(a)return a;a=A.guid();c.setAttribute("_ke_expando",a);return a},_4e_copyAttributes:function(c,a,f){c=p(c);var i=c.attributes;f=f||{};for(var d=0;d<i.length;d++){var m=i[d],b=m.nodeName.toLowerCase(),e;if(!(b in f))if(b=="checked"&&(e=t.attr(c,b)))a.attr(b,e);else if(m.specified||x.ie&&m.nodeValue&&b=="value"){e=t.attr(c,b);if(e===null)e=m.nodeValue;a.attr(b,e)}}if(c.style.cssText!==
"")a[0].style.cssText=c.style.cssText},_4e_isEditable:function(c){c=t._4e_name(c);var a=v.XHTML_DTD;return(c=!a.$nonEditable[c]&&(a[c]||a.span))&&c["#"]},_4e_scrollIntoView:function(c){c=n(c);var a=c[0].ownerDocument,f=t.scrollLeft(a),i=t.scrollTop(a),d=c.offset(),m=d.left;d=d.top;if(t.viewportHeight(a)+i<d||d<i||t.viewportWidth(a)+f<m||m<f)c.scrollIntoView(a)},_4e_getElementsByTagName:function(c,a,f){c=p(c);if(!x.ie&&f)a=f+":"+a;f=[];c=c.getElementsByTagName(a);for(a=0;a<c.length;a++)f.push(new B(c[a]));
return f}};A.DOM._4e_inject=function(c){A.mix(t,c);for(var a in c)c.hasOwnProperty(a)&&function(f){B.prototype[f]=function(){var i=[].slice.call(arguments,0);i.unshift(this);return c[f].apply(null,i)}}(a)};A.DOM._4e_inject(w)});
KISSY.Editor.add("elementpath",function(v){function s(h){var k=null,q=null,p=[];for(h=h;h&&h[0];){if(h[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=h;var n=h._4e_name();if(o.ie&&h[0].scopeName!="HTML")n=h[0].scopeName.toLowerCase()+":"+n;if(!q){if(!k&&r[n])k=h;if(j[n])if(!k&&n=="div"&&!g(h))k=h;else q=h}p.push(h);if(n=="body")break}h=h.parent()}this.block=k;this.blockLimit=q;this.elements=p}var A=KISSY,t=A.DOM,x=v.XHTML_DTD,B=v.NODE,o=A.UA,r={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},g=function(h){h=h[0]||h;h=h.childNodes;for(var k=0,q=h.length;k<q;k++){var p=h[k];if(p.nodeType==B.NODE_ELEMENT&&x.$block[p.nodeName.toLowerCase()])return true}return false};s.prototype={compare:function(h){var k=this.elements;h=h&&h.elements;if(!h||k.length!=h.length)return false;for(var q=0;q<k.length;q++)if(!t._4e_equals(k[q],h[q]))return false;return true},contains:function(h){for(var k=
this.elements,q=0;q<k.length;q++)if(k[q]._4e_name()in h)return k[q];return null}};v.ElementPath=s});
KISSY.Editor.add("walker",function(v){function s(j,g){if(this._.end)return null;var h=this.range,k,q=this.guard,p=this.type,n=j?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;h.trim();if(h.collapsed){this.end();return null}}if(!j&&!this._.guardLTR){var w=h.endContainer,c=new r(w[0].childNodes[h.endOffset]);this._.guardLTR=function(d,m){return(!m||!o._4e_equals(w,d))&&(!c[0]||d[0]!==c[0])&&(d[0].nodeType!=B.NODE_ELEMENT||!m||d._4e_name()!="body")}}if(j&&!this._.guardRTL){var a=
h.startContainer,f=h.startOffset>0&&new r(a[0].childNodes[h.startOffset-1]);this._.guardRTL=function(d,m){return d&&d[0]&&(!m||a[0]!==d[0])&&(!f[0]||d[0]!==f[0])&&(d[0].nodeType!=B.NODE_ELEMENT||!m||d._4e_name()!="body")}}var i=j?this._.guardRTL:this._.guardLTR;k=q?function(d,m){if(i(d,m)===false)return false;return q(d,m)}:i;if(this.current)j=this.current[n](false,p,k);else if(j){j=h.endContainer;if(h.endOffset>0){j=new r(j[0].childNodes[h.endOffset-1]);if(k(j)===false)j=null}else j=k(j,true)===
false?null:j._4e_previousSourceNode(true,p,k)}else{j=h.startContainer;if((j=new r(j[0].childNodes[h.startOffset]))&&j[0]){if(k(j)===false)j=null}else j=k(h.startContainer,true)===false?null:h.startContainer._4e_nextSourceNode(true,p,k)}for(;j&&j[0]&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j)!==false){if(!g)return j}else if(g&&this.evaluator)return false;j=j[n](false,p,k)}this.end();return this.current=null}function A(j){for(var g,h=null;g=s.call(this,j);)h=g;return h}function t(j){this.range=
j;this._={}}var x=KISSY,B=v.NODE,o=x.DOM,r=x.Node;x.augment(t,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,true)},checkForward:function(){return s.call(this,false,true)!==false},checkBackward:function(){return s.call(this,true,true)!==false},lastForward:function(){return A.call(this)},lastBackward:function(){return A.call(this,true)},reset:function(){delete this.current;this._={}}});t.blockBoundary=function(j){return function(g){g[0]||(g=
new r(g));return!(g[0].nodeType==B.NODE_ELEMENT&&g._4e_isBlockBoundary(j))}};t.listItemBoundary=function(){return this.blockBoundary({br:1})};t.bookmark=function(j,g){function h(k){return k&&k[0]&&k._4e_name()=="span"&&k.attr("_ke_bookmark")}return function(k){var q,p;q=k&&k[0]&&k[0].nodeType==B.NODE_TEXT&&(p=k.parent())&&h(p);q=j?q:q||h(k);return g^q}};t.whitespaces=function(j){return function(g){g=(g=g[0]||g)&&g.nodeType==B.NODE_TEXT&&!x.trim(g.nodeValue);return j^g}};t.invisible=function(j){var g=
t.whitespaces();return function(h){h=g(h)||h[0].nodeType==B.NODE_ELEMENT&&!h[0].offsetHeight;return j^h}};v.Walker=t});
KISSY.Editor.add("range",function(v){function s(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function A(b){var e=b[0].nodeType!=j.NODE_TEXT&&b._4e_name()in w.$removeEmpty,l=!r.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return e||l||b}function t(b){return!d(b)&&!m(b)}function x(b){var e=false,l=k.bookmark(true);return function(z){if(l(z))return true;if(z[0].nodeType==j.NODE_TEXT){if(r.trim(z[0].nodeValue).length)return false}else if(z[0].nodeType==
j.NODE_ELEMENT)if(!i[z._4e_name()])if(!b&&!n.ie&&z._4e_name()=="br"&&!e)e=true;else return false;return true}}function B(b,e){function l(z){return z&&z.nodeName=="span"&&z.getAttribute("_ke_bookmark")}return function(z){var u,D;u=z&&!z.nodeName&&(D=z.parentNode)&&l(D);u=b?u:u||l(z);return e^u}}function o(b){return function(e){e=(e=e[0]||e)&&e.nodeType==j.NODE_TEXT&&!r.trim(e.nodeValue);return b^e}}v.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var r=KISSY,j=v.NODE,g=v.RANGE,h=v.POSITION,k=v.Walker,q=r.DOM,p=v.Utils.getByAddress,n=r.UA,w=v.XHTML_DTD,c=v.ElementPath,a=r.Node,f={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};s.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};r.augment(s,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&q._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,e=this.startOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(e)e>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;e=this.endOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(e)e>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,e=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,g.POSITION_BEFORE_START);e&&e._4e_name()=="span"&&
e.attr("_ke_bookmark")&&this.setEndAt(e,g.POSITION_AFTER_END)},setStart:function(b,e){if(b[0].nodeType==j.NODE_ELEMENT&&f[b._4e_name()]){b=b.parent();e=b._4e_index()}this.startContainer=b;this.startOffset=e;if(!this.endContainer){this.endContainer=b;this.endOffset=e}this.updateCollapsed()},setEnd:function(b,e){if(b[0].nodeType==j.NODE_ELEMENT&&f[b._4e_name()]){b=b.parent();e=b._4e_index()+1}this.endContainer=b;this.endOffset=e;if(!this.startContainer){this.startContainer=b;this.startOffset=e}this.updateCollapsed()},
setStartAt:function(b,e){switch(e){case g.POSITION_AFTER_START:this.setStart(b,0);break;case g.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setStartBefore(b);break;case g.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,e){switch(e){case g.POSITION_AFTER_START:this.setEnd(b,0);break;case g.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setEndBefore(b);break;case g.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,e){var l=this.startContainer,z=this.endContainer,u=this.startOffset,D=this.endOffset,H,y;this.optimizeBookmark();if(z[0].nodeType==j.NODE_TEXT)z=z._4e_splitText(D);else if(z[0].childNodes.length>0)if(D>=z[0].childNodes.length){z=new a(z[0].appendChild(this.document.createTextNode("")));
y=true}else z=new a(z[0].childNodes[D]);if(l[0].nodeType==j.NODE_TEXT){l._4e_splitText(u);if(q._4e_equals(l,z))z=new a(l[0].nextSibling)}else if(u)if(u>=l[0].childNodes.length){H=new a(this.document.createTextNode(""));l[0].appendChild(H[0]);l=H;H=true}else l=new a(l[0].childNodes[u].previousSibling);else{H=new a(this.document.createTextNode(""));q.insertBefore(H[0],l[0].firstChild);l=H;H=true}u=l._4e_parents();D=z._4e_parents();var C,I,J;for(C=0;C<u.length;C++){I=u[C];J=D[C];if(I[0]!==J[0])break}for(var N=
e,M,Q,R,W=C;W<u.length;W++){M=u[W];if(N&&M[0]!==l[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(D[W]&&M==D[W][0]||M==z[0])break;R=M.nextSibling;if(b==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);b==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=e;for(e=C;e<D.length;e++){M=D[e];if(b>0&&M[0]!==z[0])Q=N.appendChild(M._4e_clone()[0]);if(!u[e]||M[0].parentNode!==u[e][0].parentNode)for(M=M[0].previousSibling;M;){if(u[e]&&M==u[e][0]||M===l[0])break;R=M.previousSibling;if(b==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);b==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(b==2){J=this.startContainer[0];if(J.nodeType==j.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==j.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==j.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==j.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(I&&J&&(l[0].parentNode!=
I[0].parentNode||z[0].parentNode!=J[0].parentNode)){b=J._4e_index();H&&J[0].parentNode==l[0].parentNode&&b--;this.setStart(J.parent(),b)}this.collapse(true)}H&&l._4e_remove();y&&z[0].parentNode&&z._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new s(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=j.NODE_ELEMENT||b.endContainer[0].nodeType!=j.NODE_ELEMENT)return null;b=b.startContainer[0].childNodes[b.startOffset];for(var e=B(true,undefined),l=o(true),z=function(u){return l(u)&&e(u)};b&&z(b);)b=(new a(b))._4e_nextSourceNode()[0];return new a(b)},shrink:function(b,e){if(!this.collapsed){b=b||g.SHRINK_TEXT;
var l=this.clone(),z=this.startContainer,u=this.endContainer,D=this.startOffset,H=this.endOffset,y=1,C=1;if(z&&z[0].nodeType==j.NODE_TEXT)if(D)if(D>=z[0].nodeValue.length)l.setStartAfter(z);else{l.setStartBefore(z);y=0}else l.setStartBefore(z);if(u&&u[0].nodeType==j.NODE_TEXT)if(H)if(H>=u[0].nodeValue.length)l.setEndAfter(u);else{l.setEndAfter(u);C=0}else l.setEndBefore(u);l=new k(l);l.evaluator=function(J){J=J[0]||J;return J.nodeType==(b==g.SHRINK_ELEMENT?j.NODE_ELEMENT:j.NODE_TEXT)};var I;l.guard=
function(J,N){J=J[0]||J;if(b==g.SHRINK_ELEMENT&&J.nodeType==j.NODE_TEXT)return false;if(N&&J==I)return false;if(!N&&J.nodeType==j.NODE_ELEMENT)I=J;return true};if(y)(z=l[b==g.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(z,e?g.POSITION_AFTER_START:g.POSITION_BEFORE_START);if(C){l.reset();(l=l[b==g.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(l,e?g.POSITION_BEFORE_END:g.POSITION_AFTER_END)}return!!(y||C)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||
b[0].nodeType!=j.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var e=this.startContainer,l=this.endContainer,z=this.startOffset,u=this.endOffset,D,H;if(!e||!l)return{start:0,end:0};if(b){if(e[0].nodeType==j.NODE_ELEMENT)if((D=new a(e[0].childNodes[z]))&&D[0]&&D[0].nodeType==j.NODE_TEXT&&z>0&&D[0].previousSibling.nodeType==j.NODE_TEXT){e=D;z=0}for(;e[0].nodeType==j.NODE_TEXT&&(H=e._4e_previous())&&H[0].nodeType==j.NODE_TEXT;){e=H;z+=H[0].nodeValue.length}if(!this.collapsed){if(l[0].nodeType==
j.NODE_ELEMENT)if((D=new a(l[0].childNodes[u]))&&D[0]&&D[0].nodeType==j.NODE_TEXT&&u>0&&D[0].previousSibling.nodeType==j.NODE_TEXT){l=D;u=0}for(;l[0].nodeType==j.NODE_TEXT&&(H=l._4e_previous())&&H[0].nodeType==j.NODE_TEXT;){l=H;u+=H[0].nodeValue.length}}}return{start:e._4e_address(b),end:this.collapsed?null:l._4e_address(b),startOffset:z,endOffset:u,normalized:b,is2:true}},createBookmark:function(b){var e,l,z,u;e=new a("<span></span>",null,this.document);e.attr("_ke_bookmark",1);e.css("display","none");
e.html("&nbsp;");if(b){z=r.guid("ke_bm_");e.attr("id",z+"S")}if(!this.collapsed){l=e._4e_clone();l.html("&nbsp;");b&&l.attr("id",z+"E");u=this.clone();u.collapse();u.insertNode(l)}u=this.clone();u.collapse(true);u.insertNode(e);if(l){this.setStartAfter(e);this.setEndBefore(l)}else this.moveToPosition(e,g.POSITION_AFTER_END);return{startNode:b?z+"S":e,endNode:b?z+"E":l,serializable:b}},moveToPosition:function(b,e){this.setStartAt(b,e);this.collapse(true)},trim:function(b,e){var l=this.startContainer,
z=this.startOffset,u=this.collapsed;if((!b||u)&&l[0]&&l[0].nodeType==j.NODE_TEXT){if(z)if(z>=l[0].nodeValue.length){z=l._4e_index()+1;l=l.parent()}else{b=l._4e_splitText(z);z=l._4e_index()+1;l=l.parent();if(q._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(q._4e_equals(l,this.endContainer))this.endOffset+=1}else{z=l._4e_index();l=l.parent()}this.setStart(l,z);if(u){this.collapse(true);return}}l=this.endContainer;z=this.endOffset;if(!(e||u)&&
l[0]&&l[0].nodeType==j.NODE_TEXT){if(z){z>=l.nodeValue.length||l._4e_splitText(z);z=l._4e_index()+1}else z=l._4e_index();l=l.parent();this.setEnd(l,z)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var e=this.startContainer,l=e[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);l?q.insertBefore(b[0]||b,l):e[0].appendChild(b[0]||b);q._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var e=
p(this.document,b.start,b.normalized),l=b.startOffset,z=b.end&&p(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(e,l);z?this.setEnd(z,b):this.collapse(true)}else{e=(l=b.serializable)?r.one("#"+b.startNode,this.document):b.startNode;b=l?r.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(e);e._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,e){var l=this.startContainer,z=this.endContainer;b=q._4e_equals(l,
z)?b&&l[0].nodeType==j.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new a(l[0].childNodes[this.startOffset]):l:l._4e_commonAncestor(z);return e&&b[0].nodeType==j.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case g.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var e=new a(this.document.body),l,z,u,D,H,y=false,C,I;C=this.startContainer;I=this.startOffset;if(C[0].nodeType==j.NODE_TEXT){if(I){C=!r.trim(C[0].nodeValue.substring(0,I)).length&&C;y=!!C}if(C)if(!(D=C[0].previousSibling))u=
C.parent()}else{if(I)D=C[0].childNodes[I-1]||C[0].lastChild;D||(u=C)}for(;u||D;){if(u&&!D){if(!H&&q._4e_equals(u,b))H=true;if(!e._4e_contains(u))break;if(!y||u.css("display")!="inline"){y=false;if(H)l=u;else this.setStartBefore(u)}D=u[0].previousSibling}for(;D;){C=false;if(D.nodeType==j.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/[\s\ufeff]$/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(y&&w.$removeEmpty[D.nodeName.toLowerCase()]){I=q.text(D);if(/[^\s\ufeff]/.test(I))D=
null;else for(var J=D.all||D.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!w.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}if(D)C=!!I.length}else D=null;if(C)if(y)if(H)l=u;else u&&this.setStartBefore(u);else y=true;if(D){C=D.previousSibling;if(!u&&!C){u=new a(D);D=null;break}D=C}else u=null}if(u)u=u.parent()}C=this.endContainer;I=this.endOffset;u=D=null;H=y=false;if(C[0].nodeType==j.NODE_TEXT){C=!r.trim(C[0].nodeValue.substring(I)).length&&C;y=!(C&&C[0].nodeValue.length);if(C)if(!(D=C[0].nextSibling))u=
C.parent()}else(D=C[0].childNodes[I])||(u=C);for(;u||D;){if(u&&!D){if(!H&&q._4e_equals(u,b))H=true;if(!e._4e_contains(u))break;if(!y||u.css("display")!="inline"){y=false;if(H)z=u;else u&&this.setEndAfter(u)}D=u[0].nextSibling}for(;D;){C=false;if(D.nodeType==j.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/^[\s\ufeff]/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(y&&w.$removeEmpty[D.nodeName.toLowerCase()]){I=q.text(D);if(/[^\s\ufeff]/.test(I))D=null;else{J=D.all||
D.getElementsByTagName("*");for(N=0;M=J[N++];)if(!w.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}}if(D)C=!!I.length}else D=null;if(C)if(y)if(H)z=u;else this.setEndAfter(u);if(D){C=D.nextSibling;if(!u&&!C){u=new a(D);D=null;break}D=C}else u=null}if(u)u=u.parent()}if(l&&z){b=l._4e_contains(z)?z:l;this.setStartBefore(b);this.setEndAfter(b)}break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:u=new s(this.document);e=new a(this.document.body);u.setStartAt(e,g.POSITION_AFTER_START);
u.setEnd(this.startContainer,this.startOffset);u=new k(u);var Q,R,W=k.blockBoundary(b==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};l=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};u.guard=$;u=u.lastBackward();Q=Q||e;this.setStartAt(Q,Q._4e_name()!="br"&&(!u&&this.checkStartOfBlock()||u&&Q._4e_contains(u))?g.POSITION_AFTER_START:g.POSITION_AFTER_END);u=this.clone();u.collapse();u.setEndAt(e,g.POSITION_BEFORE_END);u=new k(u);u.guard=
b==g.ENLARGE_LIST_ITEM_CONTENTS?l:$;Q=null;u=u.lastForward();Q=Q||e;this.setEndAt(Q,!u&&this.checkEndOfBlock()||u&&Q._4e_contains(u)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var b=this.startContainer,e=this.startOffset;if(e&&b[0].nodeType==j.NODE_TEXT)if(r.trim(b[0].nodeValue.substring(0,e)).length)return false;this.trim();b=new c(this.startContainer);e=this.clone();e.collapse(true);e.setStartAt(b.block||b.blockLimit,g.POSITION_AFTER_START);
b=new k(e);b.evaluator=x(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,e=this.endOffset;if(b[0].nodeType==j.NODE_TEXT)if(r.trim(b[0].nodeValue.substring(e)).length)return false;this.trim();b=new c(this.endContainer);e=this.clone();e.collapse(false);e.setEndAt(b.block||b.blockLimit,g.POSITION_BEFORE_END);b=new k(e);b.evaluator=x(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,e){var l=this.clone();l[e==g.START?"setStartAt":"setEndAt"](b,e==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);b=new k(l);b.evaluator=A;return b[e==g.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,e=this.endContainer,l=this.startOffset,z=this.endOffset,u;if(b[0].nodeType==j.NODE_ELEMENT){u=b[0].childNodes.length;if(u>
l)b=new a(b[0].childNodes[l]);else if(u<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new a(b);b=b._4e_nextSourceNode()||b}}if(e[0].nodeType==j.NODE_ELEMENT){u=e[0].childNodes.length;if(u>z)e=(new a(e[0].childNodes[z]))._4e_previousSourceNode(true);else if(u<1)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=new a(e)}}if(b._4e_position(e)&h.POSITION_FOLLOWING)b=e;return{startNode:b,endNode:e}},fixBlock:function(b,e){var l=this.createBookmark();
e=new a(this.document.createElement(e));this.collapse(b);this.enlarge(g.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();n.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(l);return e},splitBlock:function(b){var e=new c(this.startContainer),l=new c(this.endContainer),z=e.block,u=l.block,D=null;if(e.blockLimit[0]!==l.blockLimit[0])return null;if(b!="br"){if(!z){z=this.fixBlock(true,b);u=(new c(this.endContainer)).block}u||(u=this.fixBlock(false,b))}b=z&&this.checkStartOfBlock();
e=u&&this.checkEndOfBlock();this.deleteContents();if(z&&q._4e_equals(z,u))if(e){D=new c(this.startContainer);this.moveToPosition(u,g.POSITION_AFTER_END);u=null}else if(b){D=new c(this.startContainer);this.moveToPosition(z,g.POSITION_BEFORE_START);z=null}else{u=this.splitElement(z);!n.ie&&!r.inArray(z._4e_name(),["ul","ol"])&&z._4e_appendBogus()}return{previousBlock:z,nextBlock:u,wasStartOfBlock:b,wasEndOfBlock:e,elementPath:D}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
g.POSITION_BEFORE_END);var e=this.extractContents(),l=b._4e_clone(false);l[0].appendChild(e);l.insertAfter(b);this.moveToPosition(b,g.POSITION_AFTER_END);return l},moveToElementEditablePosition:function(b,e){var l,z=v.XHTML_DTD;if(z.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==j.NODE_ELEMENT;){if(l=b._4e_isEditable())this.moveToPosition(b,e?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(z.$inline[b._4e_name()]){this.moveToPosition(b,e?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);
return true}if((b=z.$empty[b._4e_name()]?b[e?"_4e_previous":"_4e_next"](t):b[e?"_4e_last":"_4e_first"](t))&&b[0].nodeType==j.NODE_TEXT){this.moveToPosition(b,e?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return true}}return l},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==j.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var i={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},d=new k.whitespaces,m=new k.bookmark;v.Range=s});
KISSY.Editor.add("domiterator",function(v){function s(p){if(!(arguments.length<1)){this.range=p;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var A=KISSY,t=A.UA,x=v.Walker,B=v.Range,o=v.RANGE,r=v.NODE,j=v.ElementPath,g=A.Node,h=A.DOM,k=/^[\r\n\t ]*$/,q=x.bookmark();A.augment(s,{getNextParagraph:function(p){var n,w,c,a,f;if(!this._.lastNode){w=this.range.clone();w.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:o.ENLARGE_BLOCK_CONTENTS);
var i=new x(w),d=x.bookmark(true,true);i.evaluator=d;this._.nextNode=i.next();i=new x(w);i.evaluator=d;i=i.previous();this._.lastNode=i._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==r.NODE_TEXT&&!A.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){d=new B(w.document);d.moveToPosition(this._.lastNode,o.POSITION_AFTER_END);if(d.checkEndOfBlock()){d=new j(d.endContainer);this._.lastNode=(d.block||d.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new g(w.document.createTextNode(""));h.insertAfter(this._.lastNode[0],i[0])}w=null}d=this._.nextNode;i=this._.lastNode;for(this._.nextNode=null;d;){var m=false,b=d[0].nodeType!=r.NODE_ELEMENT,e=false;if(b){if(d[0].nodeType==r.NODE_TEXT)if(k.test(d[0].nodeValue))b=false}else{var l=d._4e_name();if(d._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(l=="br")b=true;else if(!w&&!d[0].childNodes.length&&l!="hr"){n=d;c=d._4e_equals(i);break}if(w){w.setEndAt(d,o.POSITION_BEFORE_START);
if(l!="br")this._.nextNode=d}m=true}else{if(d[0].firstChild){if(!w){w=new B(this.range.document);w.setStartAt(d,o.POSITION_BEFORE_START)}d=new g(d[0].firstChild);continue}b=true}}if(b&&!w){w=new B(this.range.document);w.setStartAt(d,o.POSITION_BEFORE_START)}c=(!m||b)&&d._4e_equals(i);if(w&&!m)for(;!d[0].nextSibling&&!c;){l=d.parent();if(l._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){m=true;c||l._4e_equals(i);break}d=l;b=true;c=d._4e_equals(i);e=true}b&&w.setEndAt(d,o.POSITION_AFTER_END);d=d._4e_nextSourceNode(e,
null,i);c=!d;if((m||c)&&w){b=w.getBoundaryNodes();m=new j(w.startContainer);if(b.startNode.parent()._4e_equals(m.blockLimit)&&q(b.startNode)&&q(b.endNode)){w=null;this._.nextNode=null}else break}if(c)break}if(!n){if(!w){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}m=new j(w.startContainer);d=m.blockLimit;b={div:1,th:1,td:1};n=m.block;if((!n||!n[0])&&!this.enforceRealBlocks&&b[d._4e_name()]&&w.checkStartOfBlock()&&w.checkEndOfBlock())n=d;else if(!n||this.enforceRealBlocks&&
n._4e_name()=="li"){n=new g(this.range.document.createElement(p||"p"));n[0].appendChild(w.extractContents());n._4e_trim();w.insertNode(n);a=f=true}else if(n._4e_name()!="li"){if(!w.checkStartOfBlock()||!w.checkEndOfBlock()){n=n._4e_clone(false);n[0].appendChild(w.extractContents());n._4e_trim();f=w.splitBlock();a=!f.wasStartOfBlock;f=!f.wasEndOfBlock;w.insertNode(n)}}else if(!c)this._.nextNode=n._4e_equals(i)?null:w.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,i)}if(a){w=new g(n[0].previousSibling);
if(w[0]&&w[0].nodeType==r.NODE_ELEMENT)if(w._4e_name()=="br")w._4e_remove();else w[0].lastChild&&w[0].lastChild.nodeName.toLowerCase()=="br"&&h._4e_remove(w[0].lastChild)}if(f){w=x.bookmark(false,true);a=new g(n[0].lastChild);if(a[0]&&a[0].nodeType==r.NODE_ELEMENT&&a._4e_name()=="br")if(t.ie||a._4e_previous(w)||a._4e_next(w))a._4e_remove()}if(!this._.nextNode)this._.nextNode=c||n._4e_equals(i)?null:n._4e_nextSourceNode(true,null,i);return n}});B.prototype.createIterator=function(){return new s(this)}});
KISSY.Editor.add("selection",function(v){function s(i){this.document=i;this._={cache:{}};if(B.ie){var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!=i||d.parentElement&&d.parentElement().ownerDocument!=i)this.isInvalid=true}}function A(i){i=new s(i);return!i||i.isInvalid?null:i}function t(i){var d=i.document,m=new g(d.body),b=new g(d.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)b.on("click",function(D){o._4e_name(D.target)==="html"&&i.getSelection().getRanges()[0].select()});
var e,l;m.on("focusin",function(D){if(D.target.nodeName.toUpperCase()=="BODY")if(e){try{e.select()}catch(H){}e=null}});m.on("focus",function(){l=true;u()});m.on("beforedeactivate",function(D){D.relatedTarget||(l=false)});B.ie<8&&r.on(o._4e_getWin(d),"blur",function(){d.selection.empty()});m.on("mousedown",z);m.on("mouseup",function(){l=true;setTimeout(function(){u(true)},0)});m.on("keydown",z);m.on("keyup",function(){l=true;u()});r.on(d,"selectionchange",u);var z=function(){l=false},u=function(D){if(l){var H=
i.document,y=i.getSelection(),C=y&&y.getNative();if(D&&C&&C.type=="None")if(!H.queryCommandEnabled("InsertImage")){setTimeout(function(){u(true)},50);return}var I;if(!(C&&C.type=="Text"&&(I=C.createRange().parentElement().nodeName.toLowerCase())&&I in{input:1,textarea:1})){e=C&&y.getRanges()[0];i._monitor()}}}}else{r.on(d,"mouseup",i._monitor,i);r.on(d,"keyup",i._monitor,i)}}v.SELECTION={};var x=KISSY,B=x.UA,o=x.DOM,r=x.Event,j=v.Utils.tryThese,g=x.Node,h=v.SELECTION,k=v.RANGE,q=v.NODE,p=v.Walker,
n=v.Range;h.SELECTION_NONE=1;h.SELECTION_TEXT=2;h.SELECTION_ELEMENT=3;var w={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};x.augment(s,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=o._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var i=this._.cache;if(i.type)return i.type;
var d=h.SELECTION_NONE;try{var m=this.getNative(),b=m.type;if(b=="Text")d=h.SELECTION_TEXT;if(b=="Control")d=h.SELECTION_ELEMENT;if(m.createRange().parentElement)d=h.SELECTION_TEXT}catch(e){}return i.type=d}:function(){var i=this._.cache;if(i.type)return i.type;var d=h.SELECTION_TEXT,m=this.getNative();if(m){if(m.rangeCount==1){m=m.getRangeAt(0);var b=m.startContainer;if(b==m.endContainer&&b.nodeType==q.NODE_ELEMENT&&m.endOffset-m.startOffset===1&&w[b.childNodes[m.startOffset].nodeName.toLowerCase()])d=
h.SELECTION_ELEMENT}}else d=h.SELECTION_NONE;return i.type=d},getRanges:B.ie?function(){var i=function(d,m){d=d.duplicate();d.collapse(m);m=d.parentElement();for(var b=m.childNodes,e,l=0;l<b.length;l++){var z=b[l];if(z.nodeType==q.NODE_ELEMENT){e=d.duplicate();e.moveToElementText(z);z=e.compareEndPoints("StartToStart",d);var u=e.compareEndPoints("EndToStart",d);e.collapse();if(z>0)break;else if(!z||u==1&&z==-1)return{container:m,offset:l};else if(!u)return{container:m,offset:l+1};e=null}}if(!e){e=
d.duplicate();e.moveToElementText(m);e.collapse(false)}e.setEndPoint("StartToStart",d);d=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;d>0;)d-=b[--l].nodeValue.length}catch(D){d=0}return d===0?{container:m,offset:l}:{container:b[l],offset:-d}};return function(){var d=this._.cache;if(d.ranges)return d.ranges;var m=this.getNative(),b=m&&m.createRange(),e=this.getType();if(!m)return[];if(e==h.SELECTION_TEXT){m=new n(this.document);e=i(b,true);m.setStart(new g(e.container),e.offset);e=i(b);m.setEnd(new g(e.container),
e.offset);return d.ranges=[m]}else if(e==h.SELECTION_ELEMENT){d=this._.cache.ranges=[];for(e=0;e<b.length;e++){var l=b.item(e),z=l.parentNode,u=0;for(m=new n(this.document);u<z.childNodes.length&&z.childNodes[u]!=l;u++);m.setStart(new g(z),u);m.setEnd(new g(z),u+1);d.push(m)}return d}return d.ranges=[]}}():function(){var i=this._.cache;if(i.ranges)return i.ranges;var d=[],m=this.getNative();if(!m)return[];for(var b=0;b<m.rangeCount;b++){var e=m.getRangeAt(b),l=new n(this.document);l.setStart(new g(e.startContainer),
e.startOffset);l.setEnd(new g(e.endContainer),e.endOffset);d.push(l)}return i.ranges=d},getStartElement:function(){var i=this._.cache;if(i.startElement!==undefined)return i.startElement;var d,m=this.getNative();switch(this.getType()){case h.SELECTION_ELEMENT:return this.getSelectedElement();case h.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();;){d=b.startContainer;if(b.startOffset==(d[0].nodeType===q.NODE_ELEMENT?d[0].childNodes.length:d[0].nodeValue.length)&&!d._4e_isBlockBoundary())b.setStartAfter(d);
else break}d=b.startContainer;if(d[0].nodeType!=q.NODE_ELEMENT)return d.parent();d=new g(d[0].childNodes[b.startOffset]);if(!d[0]||d[0].nodeType!=q.NODE_ELEMENT)return b.startContainer;for(b=d[0].firstChild;b&&b.nodeType==q.NODE_ELEMENT;){d=new g(b);b=b.firstChild}return d}if(B.ie){b=m.createRange();b.collapse(true);d=b.parentElement()}else if((d=m.anchorNode)&&d.nodeType!=q.NODE_ELEMENT)d=d.parentNode}return i.startElement=d?new g(d):null},getSelectedElement:function(){var i=this._.cache;if(i.selectedElement!==
undefined)return i.selectedElement;var d=this,m=j(function(){return d.getNative().createRange().item(0)},function(){for(var b=d.getRanges()[0],e,l,z=2;z&&!((e=b.getEnclosedNode())&&e[0].nodeType==q.NODE_ELEMENT&&w[e._4e_name()]&&(l=e));z--)b.shrink(k.SHRINK_ELEMENT);return l[0]});return i.selectedElement=m?new g(m):null},reset:function(){this._.cache={}},selectElement:function(i){var d;if(B.ie)try{d=this.document.body.createControlRange();d.addElement(i[0]);d.select()}catch(m){d=this.document.body.createTextRange();
d.moveToElementText(i[0]);d.select()}finally{}else{d=this.document.createRange();d.selectNode(i[0]);i=this.getNative();i.removeAllRanges();i.addRange(d)}this.reset()},selectRanges:function(i){if(B.ie)i[0]&&i[0].select();else{var d=this.getNative();if(!d)return;d.removeAllRanges();for(var m=0;m<i.length;m++){var b=i[m],e=this.document.createRange(),l=b.startContainer;b.collapsed&&B.gecko&&B.gecko<1.09&&l[0].nodeType==q.NODE_ELEMENT&&!l[0].childNodes.length&&l[0].appendChild(this.document.createTextNode(""));
e.setStart(l[0],b.startOffset);e.setEnd(b.endContainer[0],b.endOffset);d.addRange(e)}}this.reset()},createBookmarks2:function(i){for(var d=[],m=this.getRanges(),b=0;b<m.length;b++)d.push(m[b].createBookmark2(i));return d},createBookmarks:function(i){for(var d=[],m=this.getRanges(),b=m.length,e=this.document,l,z=0;z<b;z++){d.push(l=m[z].createBookmark(i,true));var u=(i=l.serializable)?x.one("#"+l.startNode,e):l.startNode;l=i?x.one("#"+l.endNode,e):l.endNode;for(var D=z+1;D<b;D++){var H=m[D],y=H.startContainer,
C=H.endContainer;o._4e_equals(y,u.parent())&&H.startOffset++;o._4e_equals(y,l.parent())&&H.startOffset++;o._4e_equals(C,u.parent())&&H.endOffset++;o._4e_equals(C,l.parent())&&H.endOffset++}}return d},selectBookmarks:function(i){for(var d=[],m=0;m<i.length;m++){var b=new n(this.document);b.moveToBookmark(i[m]);d.push(b)}this.selectRanges(d);return this},getCommonAncestor:function(){var i=this.getRanges();return i[0].startContainer._4e_commonAncestor(i[i.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
v.Selection=s;var c={table:1,tbody:1,tr:1},a=p.whitespaces(true),f=/\ufeff|\u00a0/;n.prototype.select=B.ie?function(i){var d=this.collapsed,m,b;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==q.NODE_ELEMENT){(new s(this.document)).selectElement(new g(e));return}}if(this.startContainer[0].nodeType==q.NODE_ELEMENT&&this.startContainer._4e_name()in c||this.endContainer[0].nodeType==q.NODE_ELEMENT&&
this.endContainer._4e_name()in c)this.shrink(q.NODE_ELEMENT,true);var l=this.createBookmark();e=l.startNode;var z;if(!d)z=l.endNode;l=this.document.body.createTextRange();l.moveToElementText(e[0]);l.moveStart("character",1);if(z){i=this.document.body.createTextRange();i.moveToElementText(z[0]);l.setEndPoint("EndToEnd",i);l.moveEnd("character",-1)}else{for(m=e[0].nextSibling;m&&!a(m);)m=m.nextSibling;m=!(m&&m.nodeValue&&m.nodeValue.match(f))&&(i||!e[0].previousSibling||e[0].previousSibling&&o._4e_name(e[0].previousSibling)==
"br");b=this.document.createElement("span");b.innerHTML="&#65279;";b=new g(b);o.insertBefore(b[0],e[0]);m&&o.insertBefore(this.document.createTextNode("\ufeff"),e[0])}this.setStartBefore(e);e._4e_remove();if(d){if(m){l.moveStart("character",-1);l.select();this.document.selection.clear()}else l.select();if(b){this.moveToPosition(b,k.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(z);z._4e_remove();l.select()}}:function(){var i=this.startContainer;this.collapsed&&i[0].nodeType==q.NODE_ELEMENT&&
!i[0].childNodes.length&&i[0].appendChild(this.document.createTextNode(""));var d=this.document.createRange();d.setStart(i[0],this.startOffset);try{d.setEnd(this.endContainer[0],this.endOffset)}catch(m){if(m.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);d.setEnd(this.endContainer[0],this.endOffset)}else throw m;}i=A(this.document).getNative();i.removeAllRanges();i.addRange(d)};v.on("instanceCreated",function(i){t(i.editor)})});
KISSY.Editor.add("styles",function(v){function s(E,F){for(var G in E)E[G]=E[G].replace(aa,function(L,K){return F[K]})}function A(E,F){if(F){E=z.clone(E);s(E.attributes,F);s(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?D.STYLE_BLOCK:W[F]?D.STYLE_OBJECT:D.STYLE_INLINE;this._={definition:E}}function t(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new y(E);for(var G=E.getRanges(),L=0;L<G.length;L++)F.call(this,G[L]);E.selectRanges(G)}function x(E,
F){var G=E.element;if(G=="*")G="span";F=new N(F.createElement(G));return B(F,E)}function B(E,F){var G=F._.definition;F=G.attributes;G=A.getStyleText(G);if(F)for(var L in F)E.attr(L,F[L]);if(G)E[0].style.cssText=G;return E}function o(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var L,K=E.document;L=G.getNextParagraph();){var O=x(this,K);h(L,O)}E.moveToBookmark(F)}function r(E,F,G){var L="",K="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(L=P);S&&(K=S);return""});return L+E.replace(F,G)+K}function j(E,F){var G=E.html();G=r(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(G);return F}function g(E){var F=[];r(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,L,K){return L+"</pre>"+K+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,L){F.push(L)});return F}function h(E,F){var G=F._4e_name=="pre",L=E._4e_name=="pre",K=!G&&L;if(G&&!L)F=j(E,F);else if(K)F=q(g(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&k(F)}function k(E){var F;if((F=E._4e_previousSourceNode(true,C.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=r(F.html(),/\n$/,"")+"\n\n"+r(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function q(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),L=0;L<E.length;L++){var K=E[L];K=K.replace(/(\r\n|\r)/g,"\n");K=r(K,/^[ \t]*\n/,"");K=r(K,/\n$/,"");K=r(K,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});K=K.replace(/\n/g,"<br>");K=K.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(K);G.appendChild(O[0])}return G}
function p(E){var F=E.document;if(E.collapsed){F=x(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,L=this._.definition,K,O=v.XHTML_DTD[G]||(K=true,v.XHTML_DTD.span),P=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(u._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==C.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((v.XHTML_DTD[ca._4e_name()]||v.XHTML_DTD.span)[G]||K)&&(!L.parentRule||L.parentRule(ca))){if(!X&&(!ba||!v.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+
I.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==C.NODE_TEXT||V==C.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|I.POSITION_FOLLOWING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_FOLLOWING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=x(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==G){for(var Z in L.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in L.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());b(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(H.SHRINK_TEXT)}}function n(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var L=new Q(G.parent()),K,O=0,P;O<L.elements.length&&(P=L.elements[O]);O++){if(P==L.block||P==L.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,H.END),da=!S&&E.checkBoundaryOfElement(P,H.START);if(da||S){K=P;K.match=da?"start":"end"}else{P._4e_mergeSiblings();P._4e_name()==this.element?d(this,P):e(P,i(this)[P._4e_name()])}}}if(K&&K[0]){P=G;for(O=0;;O++){S=L.elements[O];if(u._4e_equals(S,K))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(P[0]);P=S}u[K.match=="start"?"insertBefore":"insertAfter"](P[0],K[0])}}else{var U=F.endNode,X=this;L=function(){for(var T=new Q(G.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
L();for(K=new N(G[0].nextSibling);K[0]!==U[0];){O=K._4e_nextSourceNode();if(K[0]&&K[0].nodeType==C.NODE_ELEMENT&&this.checkElementRemovable(K)){K._4e_name()==this.element?d(this,K):e(K,i(this)[K._4e_name()]);if(O[0].nodeType==C.NODE_ELEMENT&&O._4e_contains(G)){L();O=new N(G[0].nextSibling)}}K=O}}E.moveToBookmark(F)}function w(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,L,K){F[L]=K});return F}function c(E,F){typeof E=="string"&&(E=w(E));typeof F==
"string"&&(F=w(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function a(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function f(E){var F=E._AC;if(F)return F;F={};var G=0,L=E.attributes;if(L)for(var K in L){G++;F[K]=L[K]}if(L=A.getStyleText(E)){F.style||G++;F.style=L}F._length=G;return E._AC=
F}function i(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){z.isArray(G)||(G=[G]);for(var L=0;L<G.length;L++){var K=G[L],O,P;if(typeof K=="string")O=K.toLowerCase();else{O=K.element?K.element.toLowerCase():E.element;P=K.attributes}K=F[O]||(F[O]={});if(P){K=K.attributes=K.attributes||[];for(var S in P)K.push([S.toLowerCase(),P[S]])}}}return F}function d(E,F){var G=E._.definition,L=z.mix(z.mix({},G.attributes),i(E)[F._4e_name()]);G=G.styles;var K=z.isEmptyObject(L)&&
z.isEmptyObject(G);for(var O in L)if(!((O=="class"||E._.definition.fullMatch)&&F.attr(O)!=m(O,L[O]))){K=K||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in G)if(!(E._.definition.fullMatch&&F._4e_style(P)!=m(P,G[P],true))){K=K||!!F._4e_style(P);F._4e_style(P,"")}K&&l(F)}function m(E,F,G){var L=new N("<span></span>");L[G?"_4e_style":"attr"](E,F);return L[G?"_4e_style":"attr"](E)}function b(E,F){for(var G=i(E),L=F.all(E.element),K=L.length;--K>=0;)d(E,new N(L[K]));for(var O in G)if(O!=E.element){L=
F.all(O);for(K=L.length-1;K>=0;K--){var P=new N(L[K]);e(P,G[O])}}}function e(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var L=F[G][0],K;if(K=E.attr(L)){var O=F[G][1];if(O===null||O.test&&O.test(K)||typeof O=="string"&&K==O)E[0].removeAttribute(L)}}l(E)}function l(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==C.NODE_ELEMENT&&u._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==C.NODE_ELEMENT&&u._4e_mergeSiblings(G)}}}var z=KISSY,u=z.DOM,
D=v.STYLE={},H=v.RANGE,y=v.Selection,C=v.NODE,I=v.POSITION,J=v.Range,N=z.Node,M=z.UA,Q=v.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;D.STYLE_BLOCK=1;D.STYLE_INLINE=2;D.STYLE_OBJECT=3;A.prototype={apply:function(E){t.call(this,E,false)},remove:function(E){t.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==D.STYLE_INLINE?
p:this.type==D.STYLE_BLOCK?o:this.type==D.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==D.STYLE_INLINE?n:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=f(G);if(G._length){for(var L in G)if(L!="_length"){var K=E.attr(L)||"";if(L=="style"?c(G[L],a(K,false)):G[L]==K){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
i(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){L=G[F][0];if(L=E.attr(L)){K=G[F][1];if(K===null||typeof K=="string"&&L==K||K.test&&K.test(L))return true}}}return false},checkActive:function(E){switch(this.type){case D.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case D.STYLE_OBJECT:case D.STYLE_INLINE:for(var F=E.elements,G=0,L;G<F.length;G++){L=F[G];if(!(this.type==D.STYLE_INLINE&&(u._4e_equals(L,E.block)||u._4e_equals(L,E.blockLimit))))if(!(this.type==
D.STYLE_OBJECT&&!(L._4e_name()in W)))if(this.checkElementRemovable(L,true))return true}}return false}};A.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",L="";if(G.length)G=G.replace($,";");for(var K in F){var O=F[K],P=(K+":"+O).replace($,";");if(O=="inherit")L+=P;else G+=P}if(G.length)G=a(G);G+=L;return E._ST=G};v.Style=A});
KISSY.Editor.add("bubbleview",function(){function v(r){v.superclass.constructor.apply(this,arguments);r.init&&r.init.call(this)}function s(r){r=o[r];if(!r.bubble)r.bubble=new v(r.cfg);return r.bubble}var A=KISSY.Editor,t=KISSY,x=t.Event,B=t.Node;if(!A.BubbleView){var o={};v.attach=function(r){var j=r.pluginInstance,g=r.pluginName;r=j.editor;var h=o[g].cfg.func,k=o[g].bubble;r.on("selectionChange",function(q){q=q.path;var p=q.elements;if(q&&p)if(q=q.lastElement)if(q=h(q)){k=s(g);k._selectedEl=q;k._plugin=
j;k.show()}else if(k){k._selectedEl=k._plugin=null;k.hide()}});x.on(r.document,"scroll",function(){k&&k.hide()});x.on(document,"click",function(){k&&k.hide()})};v.register=function(r){o[r.pluginName]={cfg:r}};v.ATTRS={focusMgr:{value:false}};t.extend(v,A.SimpleOverlay,{_initEl:function(){var r=new B('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>');r.appendTo(document.body);this.el=r;this.set("el",r)},show:function(){var r=this._selectedEl,j=r._4e_getOffset(document);j.top+=
r.height()+5;v.superclass.show.call(this,j)}});A.BubbleView=v}});
KISSY.Editor.add("button",function(){function v(x){v.superclass.constructor.call(this,x);this._init()}var s=KISSY.Editor,A=KISSY,t=A.Node;if(!s.TripleButton){v.ON="on";v.OFF="off";v.DISABLED="disabled";v.ON_CLASS="ke-triplebutton-on";v.OFF_CLASS="ke-triplebutton-off";v.DISABLED_CLASS="ke-triplebutton-disabled";v.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};A.extend(v,A.Base,{_init:function(){var x=this.get("container")[0]||this.get("container");this.el=new t("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));x.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var x=this.get("cls");x&&this.el.addClass(x)},_stateChange:function(x){this["_"+
x.newVal]();this._attachCls()},_action:function(x){this.fire(this.get("state")+"Click",x);this.fire("click",x);x.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});s.TripleButton=v}});
KISSY.Editor.add("contextmenu",function(){function v(g){this.cfg=t.clone(g);A.Utils.lazyRun(this,"_prepareShow","_realShow")}function s(g,h){for(var k=0;k<h.length;k++)if(B.test(g,h[k]))return true;return false}var A=KISSY.Editor,t=KISSY,x=t.Node,B=t.DOM,o=t.Event;if(!A.ContextMenu){var r=[];v.register=function(g,h){var k=new v(h);r.push({doc:g,rules:h.rules,instance:k});if(!g.ke_contextmenu){g.ke_contextmenu=1;o.on(g,"mousedown",v.hide);o.on(g,"contextmenu",function(q){v.hide.call(this);for(var p=
new x(q.target);p;){var n=false;if(p._4e_name()=="body")break;for(var w=0;w<r.length;w++){var c=r[w].instance,a=r[w].rules;if(g===r[w].doc&&s(p[0],a)){q.preventDefault();n=true;setTimeout(function(){c.show(A.Utils.getXY(q.pageX,q.pageY,g,document))},30);break}}if(n)break;p=p.parent()}})}return k};v.hide=function(){for(var g=0;g<r.length;g++){var h=r[g].instance;this===r[g].doc&&h.hide()}};var j=A.SimpleOverlay;t.augment(v,{_init:function(){var g=this,h=g.cfg,k=h.funcs;g.elDom=new x("<div class='ke-menu' onmousedown='return false;'></div>");
var q=g.elDom;q.css("width",h.width);document.body.appendChild(q[0]);g.el=new j({el:q});for(var p in k){h=new x("<a href='#'>"+p+"</a>");q[0].appendChild(h[0]);(function(n,w){n._4e_unselectable();n.on("click",function(c){g.hide();c.halt();setTimeout(w,30)})})(h,k[p])}},hide:function(){this.el&&this.el.hide()},_realShow:function(g){this.el.show(g)},_prepareShow:function(){this._init()},show:function(g){this._prepareShow(g)}});A.ContextMenu=v}});
KISSY.Editor.add("overlay",function(){function v(){var h=this;v.superclass.constructor.apply(h,arguments);h._init();if(A.UA.ie===6){h.on("show",function(){var k=h.get("el"),q=parseInt(k.css("width"));k=k[0].offsetHeight;g&&g.css({width:q+"px",height:k+"px"});g&&g.offset(h.get("el").offset())});h.on("hide",function(){g&&g.offset({left:-999,top:-999})})}if(h.get("mask")){h.on("show",function(){r&&r.css({left:"0px",top:"0px"});j&&j.css({left:"0px",top:"0px"})});h.on("hide",function(){r&&r.css({left:"-9999px",
top:"-9999px"});j&&j.css({left:"-9999px",top:"-9999px"})})}h.hide()}var s=KISSY.Editor,A=KISSY,t=A.UA,x=s.focusManager,B=A.Node,o=A.DOM,r,j,g;if(!s.SimpleOverlay){v.init=function(){var h=document.body;r=new B('<div class="ke-mask">&nbsp;</div>');r.css({left:"-9999px",top:"-9999px"});r.css({width:"100%",height:o.docHeight()+"px",opacity:0.4});r.appendTo(h);if(t.ie&&t.ie==6){g=new B("<iframe class='ke-dialog-iframe'></iframe>");g.appendTo(h);j=new B("<iframe class='ke-mask'></iframe>");j.css({left:"-9999px",
top:"-9999px"});j.css({width:"100%",height:o.docHeight()+"px",opacity:0.4});j.appendTo(h)}v.init=null};v.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false}};A.extend(v,A.Base,{_init:function(){var h=this;h._initEl();var k=h.get("el");h.on("afterVisibleChange",function(q){if(q=q.newVal){typeof q=="boolean"?h.center():k.offset(q);h.fire("show")}else{k.css({left:"-9999px",top:"-9999px"});h.fire("hide")}});if(h.get("focusMgr")){h._initFocusNotice();
h.on("beforeVisibleChange",h._editorFocusMg,h)}k.css({left:"-9999px",top:"-9999px"})},_initEl:function(){var h=this,k=h.get("el");if(k)h.el=k;else{k=new B("<div class='ke-dialog' style='width:"+h.get("width")+"'><div class='ke-hd'><span class='ke-hd-title'>"+h.get("title")+"</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>");document.body.appendChild(k[0]);h.set("el",k);h.el=k;h.body=k.one(".ke-bd");h.foot=k.one(".ke-ft");
h._close=k.one(".ke-close");h._title=k.one(".ke-hd-title").one("h1");h._close.on("click",function(q){q.preventDefault();h.hide()})}},center:function(){var h=this.get("el"),k=parseInt(h.css("width")),q=h[0].offsetHeight,p=o.viewportWidth(),n=o.viewportHeight();k=(p-k)/2+o.scrollLeft();q=(n-q)/2+o.scrollTop();if(q-o.scrollTop()>200)q-=150;h.css({left:k+"px",top:q+"px"})},_prepareShow:function(){v.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;this._focusEl=new B("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>");
this._focusEl.appendTo(this.el);return this._focusEl},_initFocusNotice:function(){var h=this,k=h._getFocusEl();k.on("focus",function(){h.fire("focus")});k.on("blur",function(){h.fire("blur")})},_editorFocusMg:function(h){var k=this._focusEditor;if(h.newVal){k=this._focusEditor=x.currentInstance();this._getFocusEl()[0].focus();var q=this.el.one("input");if(q)setTimeout(function(){try{q[0].focus();q[0].select()}catch(p){}},0);else if(t.ie&&k)if(h=k.document.selection.createRange())if(h.item&&h.item(0).ownerDocument==
k.document){k=document.body.createTextRange();k.moveToElementText(this.el._4e_first()[0]);k.collapse(true);k.select()}}else k&&k.focus()},_realShow:function(h){this.get("el");this.set("visible",h||true)},show:function(h){this._prepareShow(h)},hide:function(){this.get("el");this.set("visible",false)}});s.Utils.lazyRun(v.prototype,"_prepareShow","_realShow");s.SimpleOverlay=v}});
KISSY.Editor.add("select",function(){function v(o){v.superclass.constructor.call(this,o);this._init()}var s=KISSY,A=s.Node,t=s.Event,x=s.DOM,B=s.Editor;if(!B.Select){v.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};s.extend(v,s.Base,{_init:function(){var o=this.get("container"),r=new A("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a></span>"),j=this.get("title"),g=r.one(".ke-select-text");
r.one(".ke-select-drop");g.html(j);g.css("width",this.get("width"));r._4e_unselectable();r.attr("title",j);r.appendTo(o);r.on("click",this._click,this);this.el=r;this.title=g;this._focusA=r.one("a.ke-select");B.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(o){o=o.newVal;for(var r=this.get("title"),j=this.get("items"),g=0;g<j.length;g++){var h=j[g];if(h.value==o){r=h.name;break}}this.title.html(r)},_prepare:function(){var o=this.el,
r=this._focusA,j=new A("<div class='ke-menu' onmousedown='return false;'></div>"),g=new B.SimpleOverlay({el:j,focusMgr:false}),h=this.get("items");this.get("title")&&(new A("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+this.get("title")+"</div>")).appendTo(j);for(var k=0;k<h.length;k++){var q=h[k];q=new A("<a class='ke-select-menu-item' href='#' data-value='"+q.value+"'>"+q.name+"</a>",q.attrs);q._4e_unselectable();q.appendTo(j)}this.get("popUpWidth")&&j.css("width",
this.get("popUpWidth"));j.appendTo(document.body);this.menu=g;g.on("show",function(){r.addClass("ke-select-active")});g.on("hide",function(){r.removeClass("ke-select-active")});t.on([document,this.get("doc")],"click",function(n){o._4e_contains(n.target)||g.hide()});j.on("click",this._select,this);var p=this.as=j.all("a");t.on(j[0],"mouseenter",function(){p.removeClass("ke-menu-selected")})},_select:function(o){o.halt();var r=this.menu,j=r.el;if(o=(new A(o.target))._4e_ascendant(function(k){return j._4e_contains(k)&&
k._4e_name()=="a"},true)){var g=this.get("value"),h=o.attr("data-value");this.set("value",h);this.fire("click",{newVal:h,preVal:g,name:o.html()});r.hide()}},_real:function(){var o=this.el.offset();o.top+=this.el.height();o.left+=1;if(o.left+this.menu.el.width()>x.viewportWidth()-60)o.left=x.viewportWidth()-this.menu.el.width()-60;this.menu.show(o)},_click:function(o){o.preventDefault();var r=this.get("value");if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();r&&this.menu&&
this.as.each(function(j){j.attr("data-value")==r?j.addClass("ke-menu-selected"):j.removeClass("ke-menu-selected")})}}});B.Select=v}});
KISSY.Editor.add("clipboard",function(v){var s=KISSY.Editor,A=KISSY,t=A.Node,x=A.UA,B=s.Range,o=s.RANGE,r=A.Event;s.Paste||function(){function j(g){this.editor=g;this._init()}A.augment(j,{_init:function(){var g=this.editor;x.ie?r.on(g.document,"keydown",this._paste,this):r.on(g.document,"paste",this._paste,this)},_paste:function(g){if(!(g.type==="keydown"&&!(g.keyCode===86&&(g.ctrlKey||g.metaKey)))){var h=this.editor;g=h.document;var k=h.getSelection(),q=new B(g),p=new t(x.webkit?"<body></body>":
"<div></div>",null,g);x.webkit&&p[0].appendChild(g.createTextNode("\u00a0"));g.body.appendChild(p[0]);p.css({position:"absolute",top:k.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});p.css("left","-1000px");var n=k.createBookmarks();q.setStartAt(p,o.POSITION_AFTER_START);q.setEndAt(p,o.POSITION_BEFORE_END);q.select(true);setTimeout(function(){p._4e_remove();var w;p=x.webkit&&(w=p._4e_first())&&w[0]&&w.hasClass("Apple-style-span")?w:p;k.selectBookmarks(n);h.insertHtml(p.html())},
0)}}});s.Paste=j}();v.addPlugin(function(){new s.Paste(v)})});
KISSY.Editor.add("color",function(v){function s(d){return("0"+d).slice(d.length-1,d.length+1)}function A(d){d=x.trim(d);if(d.charAt(0)=="#")d=d.substring(1);d=d.replace(/\s+/g,"");var m="";if(/^[0-9a-f]{3,3}$/i.test(d))m=d.replace(/[0-9a-f]/ig,function(e){return e+e});else{var b=d.match(h);if(b&&b[0])for(d=1;d<4;d++)m+=s(parseInt(b[d]).toString(16));else m=d}return"#"+m.toLowerCase()}for(var t=KISSY.Editor,x=KISSY,B=x.Node,o=x.Event,r=t.SimpleOverlay,j=t.Style,g=x.DOM,h=/^rgb\((\d+),(\d+),(\d+)\)$/i,
k="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),q={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},p={element:"span",styles:{"background-color":"#(color)"}},n="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
w={},c={},a=0;a<5;a++){n+="<tr>";for(var f=0;f<8;f++){var i=A(k[8*a+f]);n+="<td>";n+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+i+"'></span></a>";n+="</td>";w[i]=new j(p,{color:i});c[i]=new j(q,{color:i})}n+="</tr>"}w.inherit=new j(p,{color:"inherit"});c.inherit=new j(q,{color:"inherit"});n+="</table></div>";t.ColorSupport||function(){function d(b){d.superclass.constructor.call(this,b);this._init()}var m=t.TripleButton;d.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};x.extend(d,x.Base,{_init:function(){var b=this.get("editor").toolBarDiv;b=new m({container:b,title:this.get("title"),contentCls:this.get("contentCls")});b.on("offClick",this._showColors,this);this.el=b;t.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(b){var e=this;g._4e_ascendant(b.target,function(l){return l[0]===e.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(b){b.halt();var e=this.get("editor");b=b.target;if(g._4e_name(b)=="span"||g._4e_name(b)=="a"){b=new B(b);
if(b._4e_name()=="a")b=b.one("span");var l=this.get("styles");e.fire("save");b._4e_style("background-color")?l[A(b._4e_style("background-color"))].apply(e.document):l.inherit.remove(e.document);e.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(n);this.colorWin=new r({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);o.on(document,"click",this._hidePanel,this);o.on(v.document,
"click",this._hidePanel,this)},_real:function(){var b=this.el.el.offset();b.top+=this.el.el.height()+5;if(b.left+this.colorPanel.width()>g.viewportWidth()-60)b.left=g.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(b)},_showColors:function(b){this._prepare(b)}});t.ColorSupport=d}();v.addPlugin(function(){new t.ColorSupport({editor:v,styles:w,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new t.ColorSupport({editor:v,styles:c,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(v){var s=KISSY.Editor,A=KISSY,t=A.Node,x=A.DOM;s.ElementPaths||function(){function B(o){this.cfg=o;this._cache=[];this._init()}A.augment(B,{_init:function(){var o=this.cfg.editor;this.holder=new t("<div>");this.holder.appendTo(o.statusDiv);o.on("selectionChange",this._selectionChange,this)},_selectionChange:function(o){var r=this.cfg.editor,j=this.holder;j=j[0]||j;o=o.path.elements;var g,h;g=this._cache;for(h=0;h<g.length;h++){g[h].detach("click");g[h]._4e_remove()}this._cache=
[];for(h=0;h<o.length;h++){g=o[h];var k=new t("<a href='#' class='elementpath'>"+(g.attr("_ke_real_element_type")||g._4e_name())+"</a>");this._cache.push(k);(function(q){k.on("click",function(p){p.halt();r.focus();setTimeout(function(){r.getSelection().selectElement(q)},50)})})(g);j.firstChild?x.insertBefore(k[0],j.firstChild):j.appendChild(k[0])}}});s.ElementPaths=B}();v.addPlugin(function(){new s.ElementPaths({editor:v})})});
KISSY.Editor.add("enterkey",function(v){var s=KISSY.Editor,A=KISSY,t=A.UA,x=/^h[1-6]$/,B=s.XHTML_DTD,o=A.Node,r=A.Event,j=s.Walker,g=s.ElementPath;s.enterBlock||function(){function h(p){p=p.getSelection().getRanges();for(var n=p.length-1;n>0;n--)p[n].deleteContents();return p[0]}function k(p){var n=h(p),w=n.document;if(n.checkStartOfBlock()&&n.checkEndOfBlock()){var c=(new g(n.startContainer)).block;if(c&&(c._4e_name()=="li"||c.parent()._4e_name()=="li")){p.execCommand("outdent");return}}var a=n.splitBlock("p");
if(a){p=a.previousBlock;c=a.nextBlock;var f=a.wasStartOfBlock,i=a.wasEndOfBlock,d;if(c){d=c.parent();if(d._4e_name()=="li"){c._4e_breakParent(d);c._4e_move(c._4e_next(),true)}}else if(p&&(d=p.parent())&&d._4e_name()=="li"){p._4e_breakParent(d);n.moveToElementEditablePosition(p._4e_next());p._4e_move(p._4e_previous())}if(!f&&!i){if(c._4e_name()=="li"&&(d=c._4e_first(j.invisible(true)))&&A.inArray(d._4e_name(),["ul","ol"]))(t.ie?new o(w.createTextNode("\u00a0")):new o(w.createElement("br"))).insertBefore(d);
c&&n.moveToElementEditablePosition(c)}else{var m;if(p){if(p._4e_name()=="li"||!x.test(p._4e_name()))m=p._4e_clone()}else if(c)m=c._4e_clone();m||(m=new o("p",null,w));if(d=a.elementPath){a=0;for(var b=d.elements.length;a<b;a++){var e=d.elements[a];if(e._4e_equals(d.block)||e._4e_equals(d.blockLimit))break;if(B.$removeEmpty[e._4e_name()]){e=e._4e_clone();m._4e_moveChildren(e);m.append(e)}}}t.ie||m._4e_appendBogus();n.insertNode(m);if(t.ie&&f&&(!i||!p[0].childNodes.length)){n.moveToElementEditablePosition(i?
p:m);n.select()}n.moveToElementEditablePosition(f&&!i?c:m)}if(!t.ie)if(c){w=new o(w.createElement("span"));w.html("&nbsp;");n.insertNode(w);w._4e_scrollIntoView();n.deleteContents()}else m._4e_scrollIntoView();n.select()}}function q(p){r.on(p.document,"keydown",function(n){if(n.keyCode===13)if(!n.shiftKey){p.execCommand("enterBlock");n.preventDefault()}})}q.enterBlock=k;s.EnterKey=q}();v.addPlugin(function(){v.addCommand("enterBlock",{exec:s.EnterKey.enterBlock});s.EnterKey(v)})});
KISSY.Editor.add("fakeobjects",function(v){var s=KISSY.Editor,A=KISSY,t=A.Node,x=s.NODE,B=s.HtmlParser,o=A.Editor,r=(v=v.htmlDataProcessor)&&v.htmlFilter,j={elements:{$:function(g){var h=g.attributes;if((h=(h=(h=h&&h._ke_realelement)&&new B.Fragment.FromHtml(decodeURIComponent(h)))&&h.children[0])&&g.attributes._ke_resizable){var k=g.attributes.style;if(k){var q=/(?:^|\s)width\s*:\s*(\d+)/i.exec(k);g=q&&q[1];k=(q=/(?:^|\s)height\s*:\s*(\d+)/i.exec(k))&&q[1];if(g)h.attributes.width=g;if(k)h.attributes.height=
k}}return h}}};r&&r.addRules(j);v&&A.mix(v,{createFakeParserElement:function(g,h,k,q){var p;p=new B.BasicWriter;g.writeHtml(p);p=p.getHtml();var n=g.attributes.style;if(g.attributes.width)n="width:"+g.attributes.width+"px;"+n;if(g.attributes.height)n="height:"+g.attributes.height+"px;"+n;g={"class":h,src:s.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(p),_ke_real_node_type:g.type,style:n,align:g.attributes.align||""};if(k)g._ke_real_element_type=k;if(q)g._ke_resizable=q;return new B.Element("img",
g)}});A.augment(o,{createFakeElement:function(g,h,k,q,p){var n=g.attr("style")||"";if(g.attr("width"))n="width:"+g.attr("width")+"px;"+n;if(g.attr("height"))n="height:"+g.attr("height")+"px;"+n;g={"class":h,src:s.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(p||g._4e_outerHtml()),_ke_real_node_type:g[0].nodeType,align:g.attr("align")||"",style:n};if(k)g._ke_real_element_type=k;if(q)g._ke_resizable=q;return new t("<img/>",g,this.document)},restoreRealElement:function(g){if(g.attr("_ke_real_node_type")!=
x.NODE_ELEMENT)return null;g=decodeURIComponent(g.attr("_ke_realelement"));var h=new t("<div>",null,this.document);h.html(g);return h._4e_first(function(k){return k[0].nodeType==x.NODE_ELEMENT})._4e_remove()}})});KISSY.Editor.add("flash",function(v){v.addPlugin(function(){new KISSY.Editor.Flash(v)})});
KISSY.Editor.add("flashsupport",function(v){var s=KISSY.Editor,A=KISSY,t=A.Event,x=s.ContextMenu,B=A.Node,o=s.BubbleView,r=s.TripleButton,j=s.SimpleOverlay,g=v.htmlDataProcessor,h="ke_flash",k=s.Utils.getFlashUrl;v=g&&g.dataFilter;var q=["img."+h];s.Flash||function(){function p(a){this.editor=a;this._init()}function n(a){return a._4e_ascendant(function(f){return f._4e_name()==="img"&&!!f.hasClass(h)},true)}var w=/\.swf(?:$|\?)/i;p.isFlashEmbed=function(a){a=a.attributes;return a.type=="application/x-shockwave-flash"||
w.test(a.src||"")};A.augment(p,{_config:function(){var a=this.editor;a._toolbars=a._toolbars||{};a._toolbars.flash=this;this._cls=h;this._type="flash";this._title="Flash\u5c5e\u6027";this._bodyHtml="<div><p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p>";
this._footHtml="<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=c;this._flashRules=q},_init:function(){var a=this.editor,f={},i=this._contextMenu;this._config();this.el=new r({container:a.toolBarDiv,contentCls:this._contentCls,title:this._tip});this.el.on("click",this.show,this);for(var d in i)(function(m){f[m]=function(){a.fire("save");i[m](a);a.fire("save")}})(d);
x.register(a.document,{rules:this._flashRules,width:"120px",funcs:f});o.attach({pluginName:this._type,pluginInstance:this});t.on(a.document,"dblclick",this._dbclick,this);s.Utils.lazyRun(this,"_prepareShow","_realShow")},_getFlashUrl:function(a){return k(a)},_updateTip:function(a,f){f=this.editor.restoreRealElement(f);a.html(this._getFlashUrl(f));a.attr("href",this._getFlashUrl(f))},_dbclick:function(a){var f=new B(a.target);if(f._4e_name()==="img"&&f.hasClass(this._cls)){this.selectedFlash=f;this.show();
a.halt()}},_prepareShow:function(){var a=this;a.d=new j({title:a._title,width:"350px",mask:true});a.d.on("hide",function(){a.selectedFlash=null});a.d.body.html(a._bodyHtml);a.d.foot.html(a._footHtml);a._initD()},_realShow:function(){this.d.show()},_updateD:function(){var a=this.editor,f=this.selectedFlash;if(f){a=a.restoreRealElement(f);a.attr("width")&&this.dWidth.val(parseInt(a.attr("width")));a.attr("height")&&this.dHeight.val(parseInt(a.attr("height")));this.dUrl.val(k(a))}else{this.dUrl.val("");
this.dWidth.val("");this.dHeight.val("")}},show:function(){this._prepareShow();this._updateD()},_initD:function(){var a=this,f=a.d;a.dHeight=f.el.one(".ke-flash-height");a.dWidth=f.el.one(".ke-flash-width");a.dUrl=f.el.one(".ke-flash-url");var i=f.el.one(".ke-flash-ok");f=f.el.one(".ke-flash-cancel");i.on("click",a._gen,a);f.on("click",function(){a.d.hide()})},_getDURl:function(){return this.dUrl.val()},_getDWidth:function(){return this.dWidth.val()},_getDHeight:function(){return this.dHeight.val()},
_gen:function(){var a=this.editor,f=this._getDURl(),i=this._getDWidth(),d=this._getDHeight();if(A.trim(f)){f="<object "+(i?" width='"+i+"' ":" ")+(d?" height='"+d+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+f+'" /><embed '+(i?" width='"+i+"' ":" ")+(d?" height='"+d+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+
f+'"  type="application/x-shockwave-flash"/></object>';i=new B(f,null,a.document);f=a.createFakeElement?a.createFakeElement(i,this._cls,this._type,true,f):i;a.insertElement(f);this.selectedFlash&&a.getSelection().selectElement(f);this.d.hide()}}});s.Flash=p;p.registerBubble=function(a,f,i){o.register({pluginName:a,func:i,init:function(){var d=this,m=d.el;m.html(f+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var b=m.one(".ke-bubbleview-url"),e=m.one(".ke-bubbleview-change");m=m.one(".ke-bubbleview-remove");e._4e_unselectable();b._4e_unselectable();m._4e_unselectable();e.on("click",function(l){d._plugin.selectedFlash=d._selectedEl;d._plugin.show();l.halt()});m.on("click",function(l){var z=d._plugin;d._selectedEl._4e_remove();z.editor.notifySelectionChange();l.halt()});d.on("afterVisibleChange",function(l){var z=d._selectedEl;l.newVal&&z&&d._plugin._updateTip(b,z)})}})};p.registerBubble("flash","Flash \u7f51\u5740\uff1a ",
n);p.checkFlash=n;var c={"\u7f16\u8f91Flash":function(a){var f=a.getSelection();f=f&&f.getStartElement();f=n(f);a=a._toolbars.flash;if(f){a.selectedFlash=f;a.show()}}};p.CLS_FLASH=h;p.TYPE_FLASH="flash"}();v&&v.addRules({elements:{object:function(p){var n=p.attributes;if(!(n.classid&&String(n.classid).toLowerCase())){for(n=0;n<p.children.length;n++)if(p.children[n].name=="embed"){if(!s.Flash.isFlashEmbed(p.children[n]))return null;return g.createFakeParserElement(p,h,"flash",true)}return null}return g.createFakeParserElement(p,
h,"flash",true)},embed:function(p){if(!s.Flash.isFlashEmbed(p))return null;return g.createFakeParserElement(p,h,"flash",true)}}},5)});
KISSY.Editor.add("font",function(v){var s=KISSY.Editor,A=KISSY,t=s.Style,x=s.TripleButton,B=v.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],o={},r=[],j={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},g=v.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],h={},k=[],q={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},p;v.cfg.pluginConfig["font-size"]=B;v.cfg.pluginConfig["font-family"]=g;for(p=0;p<B.length;p++){var n=B[p];o[n]=new t(j,{size:n});r.push({name:n,value:n})}for(p=0;p<g.length;p++){B=g[p];h[B]=new t(q,{family:B});k.push({name:B,value:B,attrs:{style:"font-family:"+B}})}s.Font||function(){function w(a){w.superclass.constructor.call(this,a);this._init()}function c(a){c.superclass.constructor.call(this,
a);this._init()}w.ATTRS={title:{},html:{},styles:{},editor:{}};A.extend(w,A.Base,{_init:function(){var a=this.get("editor"),f=a.toolBarDiv;this.get("html");this.el=new s.Select({container:f,doc:a.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);a.on("selectionChange",this._selectionChange,this)},_vChange:function(a){var f=this.get("editor"),i=a.newVal;a=a.preVal;var d=this.get("styles");f.focus();
f.fire("save");if(i==a){d[i].remove(f.document);this.el.set("value","")}else d[i].apply(f.document);f.fire("save")},_selectionChange:function(a){this.get("editor");a=a.path.elements;for(var f=this.get("styles"),i=0,d;i<a.length;i++){d=a[i];for(var m in f)if(f[m].checkElementRemovable(d,true)){this.el.set("value",m);return}}this.el.reset("value")}});c.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};A.extend(c,A.Base,{_init:function(){var a=this.get("editor"),f=this.get("text");this.get("style");
var i=this.get("title");this.el=new x({text:f,title:i,contentCls:this.get("contentCls"),container:a.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);a.on("selectionChange",this._selectionChange,this)},_on:function(){var a=this.get("editor");this.get("text");var f=this.get("style");this.get("title");a.fire("save");f.apply(a.document);a.fire("save");a.notifySelectionChange();a.focus()},_off:function(){var a=this.get("editor");this.get("text");var f=this.get("style");
this.get("title");a.fire("save");f.remove(a.document);a.fire("save");a.notifySelectionChange();a.focus()},_selectionChange:function(a){this.get("editor");this.get("text");var f=this.get("style");this.get("title");f.checkActive(a.path)?this.el.set("state",x.ON):this.el.set("state",x.OFF)}});w.SingleFont=c;s.Font=w}();v.addPlugin(function(){new s.Font({editor:v,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:o,html:r});new s.Font({editor:v,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:h,html:k});new s.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:v,style:new t({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:v,style:new t({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:v,style:new t({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:v,style:new t({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(v){var s=KISSY.Editor,A=KISSY,t=[],x={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},B={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},o={},r=s.Style;for(var j in x)if(x[j]){o[x[j]]=new r({element:x[j]});t.push({name:j,value:x[j],attrs:{style:"font-size:"+B[x[j]]}})}s.Format||function(){function g(h){g.superclass.constructor.call(this,
h);this._init()}g.ATTRS={editor:{}};A.extend(g,A.Base,{_init:function(){var h=this.get("editor");this.el=new s.Select({container:h.toolBarDiv,value:"",doc:h.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);h.on("selectionChange",this._selectionChange,this)},_vChange:function(h){var k=this.get("editor"),q=h.newVal;h=h.preVal;k.fire("save");if(q!=h)o[q].apply(k.document);else{o.p.apply(k.document);
this.el.set("value","p")}k.fire("save")},_selectionChange:function(h){this.get("editor");h=h.path;for(var k in o)if(o[k].checkActive(h)){this.el.set("value",k);return}this.el.reset("value")}});s.Format=g}();v.addPlugin(function(){new s.Format({editor:v,html:t,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function v(){this._={output:[]}}var s=KISSY.Editor,A=s.Utils;if(!s.HtmlParser.BasicWriter){KISSY.augment(v,{openTag:function(t){this._.output.push("<",t)},openTagClose:function(t,x){x?this._.output.push(" />"):this._.output.push(">")},attribute:function(t,x){if(typeof x=="string")x=A.htmlEncodeAttr(x);this._.output.push(" ",t,'="',x,'"')},closeTag:function(t){this._.output.push("</",t,">")},text:function(t){this._.output.push(t)},comment:function(t){this._.output.push("<!--",
t,"--\>")},write:function(t){this._.output.push(t)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(t){var x=this._.output.join("");t&&this.reset();return x}});s.HtmlParser.BasicWriter=v}});
KISSY.Editor.add("htmlparser-comment",function(){function v(t){this.value=t;this._={isBlockLike:false}}var s=KISSY.Editor,A=s.NODE;if(!s.HtmlParser.Comment){s.HtmlParser.Comment=v;v.prototype={constructor:v,type:A.NODE_COMMENT,writeHtml:function(t,x){var B=this.value;if(x){if(!(B=x.onComment(B,this)))return;if(typeof B!="string"){B.parent=this.parent;B.writeHtml(t,x);return}}t.comment(B)}}}});
KISSY.Editor.add("htmlparser-element",function(){function v(x,B){this.name=x;this.attributes=B||(B={});this.children=[];var o=B._ke_real_element_type||x;B=s.XHTML_DTD;o=!!(B.$nonBodyContent[o]||B.$block[o]||B.$listItem[o]||B.$tableContent[o]||B.$nonEditable[o]||o=="br");var r=!!B.$empty[x];this.isEmpty=r;this.isUnknown=!B[x];this._={isBlockLike:o,hasInlineStarted:r||!o}}var s=KISSY.Editor;if(!s.HtmlParser.Element){var A=s.NODE,t=function(x,B){x=x[0];B=B[0];return x<B?-1:x>B?1:0};KISSY.augment(v,{type:A.NODE_ELEMENT,
add:s.HtmlParser.Fragment.prototype.add,clone:function(){return new v(this.name,this.attributes)},writeHtml:function(x,B){var o=this.attributes,r=this,j=r.name,g,h,k,q;r.filterChildren=function(){if(!q){var w=new s.HtmlParser.BasicWriter;s.HtmlParser.Fragment.prototype.writeChildrenHtml.call(r,w,B);r.children=(new s.HtmlParser.Fragment.FromHtml(w.getHtml())).children;q=1}};if(B){for(;;){if(!(j=B.onElementName(j)))return;r.name=j;if(!(r=B.onElement(r)))return;r.parent=this.parent;if(r.name==j)break;
if(r.type!=A.NODE_ELEMENT){r.writeHtml(x,B);return}j=r.name;if(!j){this.writeChildrenHtml.call(r,x,q?null:B);return}}o=r.attributes}x.openTag(j,o);for(var p=[],n=0;n<2;n++)for(g in o){h=g;k=o[g];if(n==1)p.push([g,k]);else if(B){for(;;)if(h=B.onAttributeName(g))if(h!=g){delete o[g];g=h}else break;else{delete o[g];break}if(h)if((k=B.onAttribute(r,h,k))===false)delete o[h];else o[h]=k}}x.sortAttributes&&p.sort(t);o=p.length;for(n=0;n<o;n++){g=p[n];x.attribute(g[0],g[1])}x.openTagClose(j,r.isEmpty);if(!r.isEmpty){this.writeChildrenHtml.call(r,
x,q?null:B);x.closeTag(j)}},writeChildrenHtml:function(){s.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});s.HtmlParser.Element=v}});
KISSY.Editor.add("htmlparser-filter",function(){function v(j){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};j&&this.addRules(j,10)}function s(j,g){for(var h=0;j&&h<g.length;h++){var k=g[h];j=j.replace(k[0],k[1])}return j}function A(j,g,h){if(typeof g=="function")g=[g];var k,q;q=j.length;var p=g&&g.length;if(p){for(k=0;k<q&&j[k].pri<h;k++);for(q=p-1;q>=0;q--)if(p=g[q]){p.pri=h;j.splice(k,0,p)}}}function t(j,g,h){if(g)for(var k in g){var q=j[k];j[k]=x(q,g[k],
h);q||j.$length++}}function x(j,g,h){if(g){g.pri=h;if(j){if(j.splice)A(j,g,h);else{j=j.pri>h?[g,j]:[j,g];j.filter=B}return j}else return g.filter=g}}function B(j){for(var g=j.type||j instanceof o.HtmlParser.Fragment,h=0;h<this.length;h++){if(g)var k=j.type,q=j.name;var p=this[h].apply(window,arguments);if(p===false)return p;if(g){if(p&&(p.name!=q||p.type!=k))return p}else if(typeof p!="string")return p;p!=undefined&&(j=p)}return j}var o=KISSY.Editor,r=o.NODE;if(!o.HtmlParser.Filter){KISSY.augment(v,
{addRules:function(j,g){if(typeof g!="number")g=10;A(this._.elementNames,j.elementNames,g);A(this._.attributeNames,j.attributeNames,g);t(this._.elements,j.elements,g);t(this._.attributes,j.attributes,g);this._.text=x(this._.text,j.text,g)||this._.text;this._.comment=x(this._.comment,j.comment,g)||this._.comment;this._.root=x(this._.root,j.root,g)||this._.root},onElementName:function(j){return s(j,this._.elementNames)},onAttributeName:function(j){return s(j,this._.attributeNames)},onText:function(j){var g=
this._.text;return g?g.filter(j):j},onComment:function(j,g){var h=this._.comment;return h?h.filter(j,g):j},onFragment:function(j){var g=this._.root;return g?g.filter(j):j},onElement:function(j){for(var g=[this._.elements["^"],this._.elements[j.name],this._.elements.$],h,k=0;k<3;k++)if(h=g[k]){h=h.filter(j,this);if(h===false)return null;if(h&&h!=j)return this.onNode(h);if(j.parent&&!j.name)break}return j},onNode:function(j){var g=j.type;return g==r.NODE_ELEMENT?this.onElement(j):g==r.NODE_TEXT?new o.HtmlParser.Text(this.onText(j.value)):
null},onAttribute:function(j,g,h){if(g=this._.attributes[g]){j=g.filter(h,j,this);if(j===false)return false;if(typeof j!="undefined")return j}return h}});o.HtmlParser.Filter=v}});
KISSY.Editor.add("htmlparser-fragment",function(){function v(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var s=KISSY.Editor;if(!s.HtmlParser.Fragment){var A={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},t=KISSY,x=s.Utils,B=s.NODE,o=s.XHTML_DTD,r=x.mix({table:1,ul:1,ol:1,dl:1},o.table,o.ul,o.ol,o.dl),j=o.$list,g=o.$listItem;v.FromHtml=function(h,k){function q(e){var l;if(a.length>0)for(var z=0;z<a.length;z++){var u=a[z],D=u.name,H=
o[D],y=i.name&&o[i.name];if((!y||y[D])&&(!e||!H||H[e]||!o[e])){if(!l){p();l=1}u=u.clone();u.parent=i;i=u;a.splice(z,1);z--}}}function p(){for(;f.length;)i.add(f.shift())}function n(e,l,z){l=l||i||c;if(k&&!l.type){var u,D;if((u=e.attributes&&(D=e.attributes._ke_real_element_type)?D:e.name)&&!(u in o.$body)&&!(u in o.$nonBodyContent)){u=i;i=l;w.onTagOpen(k,{});l=i;if(z)i=u}}if(e._.isBlockLike&&e.name!="pre"){z=e.children.length;if((u=e.children[z-1])&&u.type==B.NODE_TEXT)if(D=x.rtrim(u.value))u.value=
D;else e.children.length=z-1}l.add(e);if(e.returnPoint){i=e.returnPoint;delete e.returnPoint}}var w=new s.HtmlParser,c=new v,a=[],f=[],i=c,d=false,m;w.onTagOpen=function(e,l,z){var u=new s.HtmlParser.Element(e,l);if(u.isUnknown&&z)u.isEmpty=true;if(o.$removeEmpty[e])a.push(u);else{if(e=="pre")d=true;else if(e=="br"&&d){i.add(new s.HtmlParser.Text("\n"));return}if(e=="br")f.push(u);else{var D=i.name,H=D&&(o[D]||(i._.isBlockLike?o.div:o.span));if(H&&!u.isUnknown&&!i.isUnknown&&!H[e]){H=false;var y;
if(e in j&&D in j){D=i.children;(D=D[D.length-1])&&D.name in g||n(D=new s.HtmlParser.Element("li"),i);m=i;y=D}else if(e==D)n(i,i.parent);else{if(r[D])m||(m=i);else{n(i,i.parent,true);A[D]||a.unshift(i)}H=true}i=y?y:i.returnPoint||i.parent;if(H){w.onTagOpen.apply(this,arguments);return}}q(e);p();u.parent=i;u.returnPoint=m;m=0;if(u.isEmpty)n(u);else i=u}}};w.onTagClose=function(e){for(var l=a.length-1;l>=0;l--)if(e==a[l].name){a.splice(l,1);return}for(var z=[],u=[],D=i;D.type&&D.name!=e;){D._.isBlockLike||
u.unshift(D);z.push(D);D=D.parent}if(D.type){for(l=0;l<z.length;l++){var H=z[l];n(H,H.parent)}i=D;if(i.name=="pre")d=false;D._.isBlockLike&&p();n(D,D.parent);if(D==i)i=i.parent;a=a.concat(u)}if(e=="body")k=false};w.onText=function(e){if(!i._.hasInlineStarted&&!d){e=x.ltrim(e);if(e.length===0)return}p();q();if(k&&(!i.type||i.name=="body")&&x.trim(e))this.onTagOpen(k,{});d||(e=e.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));i.add(new s.HtmlParser.Text(e))};w.onCDATA=function(){};w.onComment=function(e){i.add(new s.HtmlParser.Comment(e))};
w.parse(h);for(p();i.type;){h=i.parent;var b=i;if(k&&(!h.type||h.name=="body")&&!o.$body[b.name]){i=h;w.onTagOpen(k,{});h=i}h.add(b);i=h}return c};t.augment(v,{add:function(h){var k=this.children.length;if(k=k>0&&this.children[k-1]||null){if(h._.isBlockLike&&k.type==B.NODE_TEXT){k.value=x.rtrim(k.value);if(k.value.length===0){this.children.pop();this.add(h);return}}k.next=h}h.previous=k;h.parent=this;this.children.push(h);this._.hasInlineStarted=h.type==B.NODE_TEXT||h.type==B.NODE_ELEMENT&&!h._.isBlockLike},
writeHtml:function(h,k){var q;this.filterChildren=function(){var p=new s.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,p,k,true);p=p.getHtml();this.children=(new v.FromHtml(p)).children;q=1};!this.name&&k&&k.onFragment(this);this.writeChildrenHtml(h,q?null:k)},writeChildrenHtml:function(h,k){for(var q=0;q<this.children.length;q++)this.children[q].writeHtml(h,k)}});s.HtmlParser.Fragment=v}});
KISSY.Editor.add("htmlparser",function(){function v(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var s=KISSY.Editor;if(!s.HtmlParser){var A=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,t={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},x=s.XHTML_DTD;KISSY.augment(v,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var o,r,j=0,g;o=this._.htmlPartsRegex.exec(B);){r=o.index;if(r>j){j=B.substring(j,r);g?g.push(j):this.onText(j)}j=this._.htmlPartsRegex.lastIndex;if(r=o[1]){r=r.toLowerCase();if(g&&x.$cdata[r]){this.onCDATA(g.join(""));g=null}if(!g){this.onTagClose(r);continue}}if(g)g.push(o[0]);else if(r=o[3]){r=r.toLowerCase();var h={},k;o=o[4];var q=!!(o&&o.charAt(o.length-1)=="/");if(o)for(;k=A.exec(o);){var p=
k[1].toLowerCase();k=k[2]||k[3]||k[4]||"";h[p]=!k&&t[p]?p:k}this.onTagOpen(r,h,q);if(!g&&x.$cdata[r])g=[]}else if(r=o[2])this.onComment(r)}B.length>j&&this.onText(B.substring(j,B.length))}});s.HtmlParser=v}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function v(){v.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var t=s.XHTML_DTD;for(var x in A.mix({},t.$nonBodyContent,t.$block,t.$listItem,t.$tableContent))this.setRules(x,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!t[x]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var s=KISSY.Editor,A=s.Utils;if(!s.HtmlParser.HtmlWriter){KISSY.extend(v,s.HtmlParser.BasicWriter,{openTag:function(t){var x=this._.rules[t];if(this._.indent)this.indentation();else if(x&&x.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",t)},openTagClose:function(t,x){t=this._.rules[t];
if(x)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(t&&t.indent)this._.indentation+=this.indentationChars}t&&t.breakAfterOpen&&this.lineBreak()},attribute:function(t,x){if(typeof x=="string"){this.forceSimpleAmpersand&&(x=x.replace(/&amp;/g,"&"));x=A.htmlEncodeAttr(x)}this._.output.push(" ",t,'="',x,'"')},closeTag:function(t){var x=this._.rules[t];if(x&&x.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(x&&x.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",t,">");x&&x.breakAfterClose&&this.lineBreak()},text:function(t){if(this._.indent){this.indentation();t=A.ltrim(t)}this._.output.push(t)},comment:function(t){this._.indent&&this.indentation();this._.output.push("<!--",t,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(t,x){var B=this._.rules[t];if(B)A.mix(B,x);else this._.rules[t]=x}});s.HtmlParser.HtmlWriter=v}});KISSY.Editor.add("htmlparser-text",function(){function v(A){this.value=A;this._={isBlockLike:false}}var s=KISSY.Editor;if(!s.HtmlParser.Text){KISSY.augment(v,{type:s.NODE.NODE_TEXT,writeHtml:function(A,t){var x=this.value;t&&!(x=t.onText(x,this))||A.text(x)}});s.HtmlParser.Text=v}});
KISSY.Editor.add("htmldataprocessor",function(v){function s(d){if(/mso-list\s*:\s*Ignore/i.test(d.attributes&&d.attributes.style))return true;return o}function A(d,m){var b=new r.HtmlParser.Element("ke:listbullet"),e;if(d)if(d[2]){d=isNaN(d[1])?/^[a-z]+$/.test(d[1])?"lower-alpha":/^[A-Z]+$/.test(d[1])?"upper-alpha":"decimal":"decimal";e="ol"}else{d=/[l\u00B7\u2002]/.test(d[1])?"disc":/[\u006F\u00D8]/.test(d[1])?"circle":/[\u006E\u25C6]/.test(d[1])?"square":"disc";e="ul"}else{d="decimal";e="ol"}b.attributes=
{"ke:listtype":e,style:"list-style-type:"+d+";"};b.add(new r.HtmlParser.Text(m));return b}function t(d){var m=d.attributes,b;if((b=d.removeAnyChildWithName("ke:listbullet"))&&b.length&&(b=b[0])){d.name="ke:li";if(m.style)m.style=x([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(e){e=e.split(" ");e=e[3]||e[1]||e[0];e=parseInt(e,10);if(!w&&c&&e>c)w=e-c;m["ke:margin"]=c=e}]],o)(m.style,d)||"";b=b.attributes;d.addStyle(b.style);j.mix(m,b);return true}return false}function x(d,m){return function(b,
e){var l=[];b.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(z,u,D){u=u.toLowerCase();u=="font-family"&&(D=D.replace(/["']/g,""));for(var H,y,C,I=0;I<d.length;I++)if(d[I]){z=d[I][0];H=d[I][1];y=d[I][2];C=d[I][3];if(u.match(z)&&(!H||D.match(H))){u=C||u;m&&(y=y||D);if(typeof y=="function")y=y(D,e,u);if(y&&y.push){u=y[0];y=y[1]}typeof y=="string"&&l.push([u,y]);return}}!m&&l.push([u,D])});for(b=0;b<l.length;b++)l[b]=l[b].join(":");return l.length?l.join(";")+";":false}}
function B(d){d=d.children;for(var m,b,e,l,z,u,D,H=0;H<d.length;H++){m=d[H];if("ke:li"==m.name){m.name="li";b=m.attributes;e=m.attributes["ke:listtype"];l=parseInt(b["ke:indent"],10)||w&&Math.ceil(b["ke:margin"]/w)||1;b.style&&(b.style=x([["list-style-type",e=="ol"?"decimal":"disc"]],o)(b.style)||"");if(u){if(l>D){u=new r.HtmlParser.Element(e);u.add(m);z.add(u)}else{if(l<D){z=D-l;for(var y;z--&&(y=u.parent);)u=y.parent}u.add(m)}d.splice(H--,1)}else{u=new r.HtmlParser.Element(e);u.add(m);d[H]=u}z=
m;D=l}else u=null}w=0}var o=o,r=KISSY.Editor,j=KISSY,g=j.UA,h=r.HtmlParser,k=new h.Filter,q=new h.Filter,p=r.XHTML_DTD;if(!v.htmlDataProcessor){(function(){var d=r.HtmlParser.Fragment.prototype,m=r.HtmlParser.Element.prototype;d.onlyChild=m.onlyChild=function(){var b=this.children;return b.length==1&&b[0]||null};m.removeAnyChildWithName=function(b){for(var e=this.children,l=[],z,u=0;u<e.length;u++){z=e[u];if(z.name){if(z.name==b){l.push(z);e.splice(u--,1)}l=l.concat(z.removeAnyChildWithName(b))}}return l};
m.getAncestor=function(b){for(var e=this.parent;e&&!(e.name&&e.name.match(b));)e=e.parent;return e};d.firstChild=m.firstChild=function(b){for(var e,l=0;l<this.children.length;l++){e=this.children[l];if(b(e))return e;else if(e.name)if(e=e.firstChild(b))return e}return null};m.addStyle=function(b,e,l){var z="";if(typeof e=="string")z+=b+":"+e+";";else{if(typeof b=="object")for(var u in b){if(b.hasOwnProperty(u))z+=u+":"+b[u]+";"}else z+=b;l=e}if(!this.attributes)this.attributes={};b=this.attributes.style||
"";b=(l?[z,b]:[b,z]).join(";");this.attributes.style=b.replace(/^;|;(?=;)/,"")};p.parentOf=function(b){var e={};for(var l in this)if(l.indexOf("$")==-1&&this[l][b])e[l]=1;return e}})();var n=x([[/mso/i],[/font-size/i,"",function(d){for(var m=v.cfg.pluginConfig["font-size"],b=0;b<m.length;b++)if(d.toLowerCase()==m[b])return d;return false},"font-size"],[/font-family/i,"",function(d){for(var m=v.cfg.pluginConfig["font-family"],b=0;b<m.length;b++)if(d.toLowerCase()==m[b].toLowerCase())return d;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],o),w,c=0,a=p.parentOf("ol"),f={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(d){d.filterChildren();B(d)},elements:{font:function(d){delete d.name},p:function(d){d.filterChildren();if(t(d))return o},$:function(d){var m=d.name||"";m.indexOf(":")!=-1&&m.indexOf("ke")==-1&&delete d.name;var b=d.attributes.style;if(m=="span"&&(!b||!n(b)))delete d.name;
if(m in a){d.filterChildren();B(d)}},table:function(d){var m=d.attributes.border;if(!m||m=="0")d.attributes["class"]="ke_show_border"},span:function(d){if(!g.gecko&&s(d.parent))return false;if(!g.gecko&&s(d)){d=(d=d.firstChild(function(b){return b.value||b.name=="img"}))&&(d.value||"l.");var m=d.match(/^([^\s]+?)([.)]?)$/);return A(m,d)}}},comment:!g.ie?function(d,m){var b=d.match(/<img.*?>/);if(d=d.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){b=(m=d[1]||b&&"l.")&&m.match(/>([^\s]+?)([.)]?)</);
return A(b,m)}if(g.gecko&&b){b=r.HtmlParser.Fragment.FromHtml(b[0]).children[0];(m=(m=(m=m.previous)&&m.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&m[1])&&(b.attributes.src=m);return b}return false}:function(){return false},attributes:{"class":function(d){if(/^ke_/.test(d))return d;return false},style:function(d){d=n(d);if(!d)return false;return d}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},i={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(d){var m=d.parent;
if(m&&m.name=="object"){var b=m.attributes.width;m=m.attributes.height;b&&(d.attributes.width=b);m&&(d.attributes.height=m)}},param:function(d){d.children=[];d.isEmpty=true;return d},a:function(d){if(!(d.children.length||d.attributes.name))return false},span:function(d){if(!d.children.length)return false}},attributes:{style:function(d){if(!j.trim(d))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(g.ie)i.attributes.style=function(d){return d.toLowerCase()};k.addRules(i);q.addRules(f);
v.htmlDataProcessor={htmlFilter:k,dataFilter:q,toHtml:function(d,m){var b=new h.HtmlWriter;h.Fragment.FromHtml(d,m).writeHtml(b,k);return b.getHtml(true)},toDataFormat:function(d,m){if(g.gecko)d=d.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var b=new h.BasicWriter;d=h.Fragment.FromHtml(d,m);b.reset();d.writeHtml(b,q);return b.getHtml(true)}}}});
KISSY.Editor.add("image",function(v){var s=KISSY.Editor,A=KISSY,t=A.Node,x=A.DOM,B=A.Event,o=s.SimpleOverlay;s.ImageInserter||function(){function r(g){r.superclass.constructor.call(this,g);this._init()}var j=s.TripleButton;r.ATTRS={editor:{}};A.extend(r,A.Base,{_init:function(){var g=this.get("editor").toolBarDiv;this.el=new j({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",container:g});this.el.on("offClick",this.show,this);s.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var g=
this,h=g.get("editor");g.d=new o({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var k=g.d;k.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></p></div>");k.foot.html("<button class='ke-img-insert'>\u63d2\u5165</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");g.content=k.el;k=g.content;var q=k.one(".ke-img-cancel"),p=k.one(".ke-img-insert");
g.imgUrl=k.one(".ke-img-url");q.on("click",function(n){g.d.hide();n.halt()});B.on(document,"click",g.hide,g);B.on(h.document,"click",g.hide,g);p.on("click",function(){g._insert()})},hide:function(g){var h=this;x._4e_ascendant(g.target,function(k){return k[0]===h.content[0]||k[0]===h.el.el[0]},true)||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var g=this.get("editor"),h=this.imgUrl.val();if(h){h=new t("<img src='"+h+"' alt='' />",null,g.document);g.insertElement(h,function(k){k.on("load",
function(){k.detach();k.css({width:k.width()+"px",height:k.height()+"px"})})});this.d.hide()}},show:function(){this._prepare()}});s.ImageInserter=r}();v.addPlugin(function(){new s.ImageInserter({editor:v})})});
KISSY.Editor.add("indent",function(v){var s=KISSY.Editor,A={ol:1,ul:1},t=KISSY,x=s.Walker,B=t.DOM,o=t.Node,r=t.UA,j=s.NODE;s.Indent||function(){function g(f){this.type=f;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function h(f){return f.type=CKEDITOR.NODE_ELEMENT&&f.is("li")}function k(f,i,d){var m=i.startContainer;for(f=i.endContainer;m&&m.parent()[0]!==d[0];)m=m.parent();for(;f&&f.parent()[0]!==d[0];)f=f.parent();if(m&&f){var b=m;m=[];for(var e=false;!e;){if(b[0]===
f[0])e=true;m.push(b);b=b.next()}if(!(m.length<1)){b=d._4e_parents(true);for(f=0;f<b.length;f++)if(A[b[f]._4e_name()]){d=b[f];break}b=this.type=="indent"?1:-1;f=m[0];e=m[m.length-1];m={};var l=s.ListUtils.listToArray(d,m),z=l[e._4e_getData("listarray_index")].indent;for(f=f._4e_getData("listarray_index");f<=e._4e_getData("listarray_index");f++){l[f].indent+=b;var u=l[f].parent;l[f].parent=new o(u[0].ownerDocument.createElement(u._4e_name()))}for(f=e._4e_getData("listarray_index")+1;f<l.length&&l[f].indent>
z;f++)l[f].indent+=b;e=s.ListUtils.arrayToList(l,m,null,"p",0);b=[];if(this.type=="outdent"){var D;if((D=d.parent())&&D._4e_name()=="li"){l=e.listNode.childNodes;var H;for(f=l.length-1;f>=0;f--)if((H=new o(l[f]))&&H._4e_name()=="li")b.push(H)}}if(e){B.insertBefore(e.listNode,d[0]);d._4e_remove()}if(b&&b.length)for(f=0;f<b.length;f++){for(H=d=b[f];(H=H.next())&&H._4e_name()in A;){r.ie&&!d._4e_first(function(y){return w(y)&&c(y)})&&d[0].appendChild(i.document.createTextNode("\u00a0"));d[0].appendChild(H[0])}B.insertAfter(d[0],
D[0])}for(f in m)m[f]._4e_clearMarkers(m,true)}}}function q(f,i){i=i.createIterator();i.enforceRealBlocks=true;i.enlargeBr=true;for(var d;d=i.getNextParagraph();)p.call(this,f,d)}function p(f,i){f=parseInt(i._4e_style(this.indentCssProperty),10);if(isNaN(f))f=0;f+=(this.type=="indent"?1:-1)*this.indentOffset;if(f<0)return false;f=Math.max(f,0);f=Math.ceil(f/this.indentOffset)*this.indentOffset;i.css(this.indentCssProperty,f?f+this.indentUnit:"");i[0].style.cssText===""&&i[0].removeAttribute("style");
return true}function n(f){n.superclass.constructor.call(this,f);f=this.get("editor").toolBarDiv;this.el=new a({container:f,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new g(this.get("type"));this._init()}var w=x.whitespaces(true),c=x.bookmark(false,true);t.augment(g,{exec:function(f){for(var i=f.getSelection(),d=i&&i.getRanges()[0],m=d.startContainer,b=d.endContainer,e=d.getCommonAncestor();e&&!(e[0].nodeType==j.NODE_ELEMENT&&A[e._4e_name()]);)e=e.parent();if(e&&
m[0].nodeType==j.NODE_ELEMENT&&m._4e_name()in A){m=new x(d);m.evaluator=h;d.startContainer=m.next()}if(e&&b[0].nodeType==j.NODE_ELEMENT&&b._4e_name()in A){m=new x(d);m.evaluator=h;d.endContainer=m.previous()}b=i.createBookmarks(true);if(e){for(m=e._4e_first();m&&m[0]&&m._4e_name()!="li";)m=m.next();var l=d.startContainer;(m[0]==l[0]||m._4e_contains(l))&&p.call(this,f,e)||k.call(this,f,d,e)}else q.call(this,f,d);i.selectBookmarks(b)}});var a=s.TripleButton;n.ATTRS={type:{},contentCls:{},editor:{}};
t.extend(n,t.Base,{_init:function(){var f=this.get("editor"),i=this.el;i.on("offClick",this.exec,this);this.get("type")=="outdent"?f.on("selectionChange",this._selectionChange,this):i.set("state",a.OFF)},exec:function(){var f=this.get("editor"),i=this;f.fire("save");setTimeout(function(){i.indentCommand.exec(f);f.fire("save");f.notifySelectionChange()},10)},_selectionChange:function(f){this.get("editor");this.get("type");var i=f.path,d=i.blockLimit;f=this.el;if(i.contains(A))f.set("state",a.OFF);
else(i=i.block||d)&&i._4e_style(this.indentCommand.indentCssProperty)?f.set("state",a.OFF):f.set("state",a.DISABLED)}});s.Indent=n}();v.addPlugin(function(){v.addCommand("outdent",new s.Indent({editor:v,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));v.addCommand("indent",new s.Indent({editor:v,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(v){var s=KISSY.Editor,A=KISSY,t=s.TripleButton;s.Justify||function(){function x(o,r,j,g){this.editor=o;this.v=r;this.contentCls=g;this.title=j;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;A.augment(x,{_init:function(){var o=this.editor;this.el=new t({contentCls:this.contentCls,title:this.title,container:o.toolBarDiv});o.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var o=this.editor,r=o.getSelection(),
j=this.el.get("state");if(r){var g=r.createBookmarks(),h=r.getRanges(),k,q;o.fire("save");for(var p=h.length-1;p>=0;p--){k=h[p].createIterator();for(k.enlargeBr=true;q=k.getNextParagraph();){q.removeAttr("align");j==t.OFF?q.css("text-align",this.v):q.css("text-align","")}}o.notifySelectionChange();r.selectBookmarks(g);o.fire("save")}},_selectionChange:function(o){var r=this.el;o=o.path;if(o=o.block||o.blockLimit){o=o.css("text-align").replace(B,"");o==this.v||!o&&this.v=="left"?r.set("state",t.ON):
r.set("state",t.OFF)}}});s.Justify=x}();v.addPlugin(function(){new s.Justify(v,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new s.Justify(v,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new s.Justify(v,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(v){var s=KISSY.Editor;s.Link||function(){function A(q){this.editor=q;this._init()}function t(q){return q._4e_ascendant(function(p){return p._4e_name()==="a"&&!!p.attr("href")},true)}var x=KISSY,B=s.TripleButton,o=s.Style,r=x.Node,j=s.Range,g=s.SimpleOverlay,h=s.BubbleView,k={element:"a",attributes:{href:"#(href)",target:"#(target)"}};A.init=function(){var q=new g({title:"\u4fee\u6539\u94fe\u63a5",mask:true,width:"300px"});this.dialog=q;q.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
q.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");q.urlEl=q.body.one(".ke-link-url");q.targetEl=q.body.one(".ke-link-blank");var p=q.foot.one(".ke-link-cancel");q.foot.one(".ke-link-ok").on("click",function(n){q.link._link();n.halt()},this);p.on("click",function(n){q.hide();n.halt()},this);A.init=null};h.register({pluginName:"link",func:t,init:function(){var q=this,p=q.el;p.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var n=p.one(".ke-bubbleview-url"),w=p.one(".ke-bubbleview-change");p=p.one(".ke-bubbleview-remove");w._4e_unselectable();n._4e_unselectable();p._4e_unselectable();w.on("click",function(c){q._plugin.show();c.halt()});p.on("click",function(c){q._plugin._removeLink(q._selectedEl);c.halt()});q.on("afterVisibleChange",function(){var c=q._selectedEl;if(c){n.html(c.attr("href"));n.attr("href",c.attr("href"))}})}});x.augment(A,{_init:function(){this.el=new B({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-link",
title:"\u7f16\u8f91\u8d85\u94fe\u63a5 "});this.el.on("click",this.show,this);h.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(q){var p=this.editor,n={href:q.attr("href")};if(q._4e_hasAttribute("target"))n.target=q.attr("target");q=new o(k,n);p.fire("save");q.remove(p.document);p.fire("save");p.notifySelectionChange()},_getSelectedLink:function(){var q=this.editor.getSelection();if(q=q&&q.getStartElement())q=t(q);return q},_link:function(){var q,p=this.editor,n=A.dialog,w=n.urlEl.val(),
c;if(x.trim(w)){n.hide();if(c=this._getSelectedLink()){q=new j(p.document);q.selectNodeContents(c);p.getSelection().selectRanges([q]);this._removeLink(c)}c={href:w};c.target=n.targetEl[0].checked?"_blank":"_self";q=p.getSelection().getRanges()[0];if(q.collapsed){q=new r("<a href='"+w+"' target='"+c.target+"'>"+w+"</a>",null,p.document);p.insertElement(q)}else{p.fire("save");q=new o(k,c);q.apply(p.document);p.fire("save")}p.notifySelectionChange()}},_prepare:function(){A.init&&A.init()},_real:function(){var q=
A.dialog,p=this._getSelectedLink();q.link=this;if(p){q.urlEl.val(p.attr("href"));q.targetEl[0].checked=p.attr("target")=="_blank"}q.show()},show:function(){this._prepare()}});s.Utils.lazyRun(A.prototype,"_prepare","_real");s.Link=A}();v.addPlugin(function(){new s.Link(v)})});
KISSY.Editor.add("list",function(v){var s=KISSY.Editor,A={ol:1,ul:1},t=["ol","ul"],x=KISSY,B=s.RANGE,o=s.ElementPath,r=s.Walker,j=s.NODE,g=x.UA,h=x.Node,k=x.DOM;s.List||function(){function q(a){this.type=a}function p(a){p.superclass.constructor.call(this,a);a=this.get("editor").toolBarDiv;this.el=new c({contentCls:this.get("contentCls"),title:this.get("title"),container:a});this.listCommand=new q(this.get("type"));this.listCommand.state=this.get("status");this._init()}var n={listToArray:function(a,
f,i,d,m){if(!A[a._4e_name()])return[];d||(d=0);i||(i=[]);for(var b=0,e=a[0].childNodes.length;b<e;b++){var l=new h(a[0].childNodes[b]);if(l._4e_name()=="li"){var z={parent:a,indent:d,element:l,contents:[]};if(m)z.grandparent=m;else{z.grandparent=a.parent();if(z.grandparent&&z.grandparent._4e_name()=="li")z.grandparent=z.grandparent.parent()}f&&l._4e_setMarker(f,"listarray_index",i.length);i.push(z);for(var u=0,D=l[0].childNodes.length,H;u<D;u++){H=new h(l[0].childNodes[u]);H[0].nodeType==j.NODE_ELEMENT&&
A[H._4e_name()]?n.listToArray(H,f,i,d+1,z.grandparent):z.contents.push(H)}}}return i},arrayToList:function(a,f,i,d){i||(i=0);if(!a||a.length<i+1)return null;for(var m=a[i].parent[0].ownerDocument,b=m.createDocumentFragment(),e=null,l=i,z=Math.max(a[i].indent,0),u=null;;){var D=a[l];if(D.indent==z){if(!e||a[l].parent._4e_name()!=e._4e_name()){e=a[l].parent._4e_clone(false,true);b.appendChild(e[0])}u=e[0].appendChild(D.element._4e_clone(false,true)[0]);for(var H=0;H<D.contents.length;H++)u.appendChild(D.contents[H]._4e_clone(true,
true)[0]);l++}else if(D.indent==Math.max(z,0)+1){l=n.arrayToList(a,null,l,d);u.appendChild(l.listNode);l=l.nextIndex}else if(D.indent==-1&&!i&&D.grandparent){u=A[D.grandparent._4e_name()]?D.element._4e_clone(false,true)[0]:D.grandparent._4e_name()!="td"?m.createElement(d):m.createDocumentFragment();for(H=0;H<D.contents.length;H++)u.appendChild(D.contents[H]._4e_clone(true,true)[0]);if(u.nodeType==j.NODE_DOCUMENT_FRAGMENT&&l!=a.length-1){u.lastChild&&u.lastChild.nodeType==j.NODE_ELEMENT&&u.lastChild.getAttribute("type")==
"_moz"&&k._4e_remove(u.lastChild);k._4e_appendBogus(u)}if(u.nodeType==j.NODE_ELEMENT&&k._4e_name(u)==d&&u.firstChild){k._4e_trim(u);e=u.firstChild;if(e.nodeType==j.NODE_ELEMENT&&k._4e_isBlockBoundary(e)){e=m.createDocumentFragment();k._4e_moveChildren(u,e);u=e}}e=k._4e_name(u);if(!g.ie&&(e=="div"||e=="p"))k._4e_appendBogus(u);b.appendChild(u);e=null;l++}else return null;if(a.length<=l||Math.max(a[l].indent,0)<z)break}if(f)for(a=new h(b.firstChild);a&&a[0];){a[0].nodeType==j.NODE_ELEMENT&&a._4e_clearMarkers(f,
true);a=a._4e_nextSourceNode()}return{listNode:b,nextIndex:l}}},w=/^h[1-6]$/;q.prototype={changeListType:function(a,f,i,d){var m=n.listToArray(f.root,i),b=[];for(a=0;a<f.contents.length;a++){var e=f.contents[a];e=e._4e_ascendant("li",true);if(!(!e||!e[0]||e._4e_getData("list_item_processed"))){b.push(e);e._4e_setMarker(i,"list_item_processed",true)}}e=new h(f.root[0].ownerDocument.createElement(this.type));for(a=0;a<b.length;a++){var l=b[a]._4e_getData("listarray_index");m[l].parent=e}i=n.arrayToList(m,
i,null,"p");var z;m=i.listNode.childNodes.length;for(a=0;a<m&&(z=new h(i.listNode.childNodes[a]));a++)z._4e_name()==this.type&&d.push(z);k.insertBefore(i.listNode,f.root[0]);f.root._4e_remove()},createList:function(a,f,i){var d=f.contents;a=f.root[0].ownerDocument;var m=[];if(d.length==1&&d[0][0]===f.root[0]){var b=new h(a.createElement("div"));d[0][0].nodeType!=j.NODE_TEXT&&d[0]._4e_moveChildren(b);d[0][0].appendChild(b[0]);d[0]=b}f=f.contents[0].parent();for(b=0;b<d.length;b++)f=f._4e_commonAncestor(d[b].parent());
for(b=0;b<d.length;b++)for(var e=d[b],l;l=e.parent();){if(l[0]===f[0]){m.push(e);break}e=l}if(!(m.length<1)){d=new h(m[m.length-1][0].nextSibling);b=new h(a.createElement(this.type));for(i.push(b);m.length;){i=m.shift();e=new h(a.createElement("li"));if(w.test(i._4e_name()))e[0].appendChild(i[0]);else{i._4e_copyAttributes(e);i._4e_moveChildren(e);i._4e_remove()}b[0].appendChild(e[0]);g.ie||e._4e_appendBogus()}d[0]?k.insertBefore(b[0],d[0]):f[0].appendChild(b[0])}},removeList:function(a,f,i){function d(H){if((u=
new h(z[H?"firstChild":"lastChild"]))&&!(u[0].nodeType==j.NODE_ELEMENT&&u._4e_isBlockBoundary())&&(D=f.root[H?"_4e_previous":"_4e_next"](r.whitespaces(true)))&&!(u[0].nodeType==j.NODE_ELEMENT&&D._4e_isBlockBoundary({br:1})))k[H?"insertBefore":"insertAfter"](a.document.createElement("br"),u[0])}for(var m=n.listToArray(f.root,i),b=[],e=0;e<f.contents.length;e++){var l=f.contents[e];l=l._4e_ascendant("li",true);if(!(!l||l._4e_getData("list_item_processed"))){b.push(l);l._4e_setMarker(i,"list_item_processed",
true)}}l=null;for(e=0;e<b.length;e++){l=b[e]._4e_getData("listarray_index");m[l].indent=-1;l=l}for(e=l+1;e<m.length;e++)if(m[e].indent>Math.max(m[e-1].indent,0)){b=m[e-1].indent+1-m[e].indent;for(l=m[e].indent;m[e]&&m[e].indent>=l;){m[e].indent+=b;e++}e--}var z=n.arrayToList(m,i,null,"p").listNode,u,D;d(true);d();k.insertBefore(z,f.root);f.root._4e_remove()},exec:function(a){var f=a.getSelection(),i=f&&f.getRanges();if(!(!i||i.length<1)){for(var d=f.createBookmarks(true),m=[],b={};i.length>0;){var e=
i.shift(),l=e.getBoundaryNodes(),z=l.startNode,u=l.endNode;z[0].nodeType==j.NODE_ELEMENT&&z._4e_name()=="td"&&e.setStartAt(l.startNode,B.POSITION_AFTER_START);u[0].nodeType==j.NODE_ELEMENT&&u._4e_name()=="td"&&e.setEndAt(l.endNode,B.POSITION_BEFORE_END);e=e.createIterator();for(e.forceBrBreak=false;l=e.getNextParagraph();){z=new o(l);u=z.elements;var D=null,H=false,y=z.blockLimit,C;for(z=u.length-1;z>=0&&(C=u[z]);z--)if(A[C._4e_name()]&&y.contains(C)){y._4e_removeData("list_group_object");if(z=C._4e_getData("list_group_object"))z.contents.push(l);
else{z={root:C,contents:[l]};m.push(z);C._4e_setMarker(b,"list_group_object",z)}H=true;break}if(!H)if(y._4e_getData("list_group_object"))y._4e_getData("list_group_object").contents.push(l);else{z={root:y,contents:[l]};y._4e_setMarker(b,"list_group_object",z);m.push(z)}}}for(i=[];m.length>0;){z=m.shift();if(this.state=="off")A[z.root._4e_name()]?this.changeListType(a,z,b,i):this.createList(a,z,i);else this.state=="on"&&A[z.root._4e_name()]&&this.removeList(a,z,b)}for(z=0;z<i.length;z++){D=i[z];var I=
this;(a=function(J){var N=D[J?"_4e_previous":"_4e_next"](r.whitespaces(true));if(N&&N[0]&&N._4e_name()==I.type){N._4e_remove();N._4e_moveChildren(D,J?true:false)}})();a(true)}s.Utils.clearAllMarkers(b);f.selectBookmarks(d)}}};var c=s.TripleButton;p.ATTRS={editor:{},type:{},contentCls:{}};x.extend(p,x.Base,{_init:function(){var a=this,f=a.get("editor"),i=a.el;a=a;i.on("click",a._change,a);f.on("selectionChange",a._selectionChange,a)},_change:function(){var a=this.get("editor");this.get("type");var f=
this.el;a.fire("save");this.listCommand.state=f.get("state");this.listCommand.exec(a);a.fire("save");a.notifySelectionChange()},_selectionChange:function(a){this.get("editor");var f=this.get("type"),i=a.path,d;a=this.el;var m=i.blockLimit;if(i=i.elements)for(var b=0;b<i.length&&(d=i[b])&&d[0]!==m[0];b++){var e=x.indexOf(i[b]._4e_name(),t);if(e!==-1)if(t[e]===f){a.set("state",c.ON);return}else break}a.set("state",c.OFF)}});s.ListUtils=n;s.List=p}();v.addPlugin(function(){new s.List({editor:v,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new s.List({editor:v,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(v){var s=KISSY.Editor,A=KISSY,t=A.UA,x=A.Node,B=A.Event,o=s.TripleButton,r=A.DOM,j;s.Maximize||function(){function g(h){this.editor=h;this._init()}g.init=function(){j=new x("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(j[0]);g.init=null};A.augment(g,{_init:function(){this.el=new o({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);s.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var h=this,k=h.editor;B.remove(window,"resize",h._maximize,h);this._saveEditorStatus();k.wrap.css({height:h.iframeHeight});(new x(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";k.editorWrap.css({position:"static",width:h.editorWrapWidth});j.css({left:"-99999px",top:"-99999px"});window.scrollTo(h.scrollLeft,
h.scrollTop);h.el.set("state",o.OFF);setTimeout(function(){h._restoreEditorStatus()},30);k.notifySelectionChange()},_saveSate:function(){var h=this.editor;this.iframeHeight=h.wrap._4e_style("height");this.editorWrapWidth=h.editorWrap._4e_style("width");this.scrollLeft=r.scrollLeft();this.scrollTop=r.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var h=this.editor;if(t.gecko&&h.iframeFocus)this.savedRanges=(h=h.getSelection())&&h.getRanges()},_restoreEditorStatus:function(){var h=this.editor,
k=h.getSelection();if(t.gecko&&h.iframeFocus){this.el.el[0].focus();h.focus();this.savedRanges&&k&&k.selectRanges(this.savedRanges)}if(h.iframeFocus&&k)(h=k.getStartElement())&&h[0]&&h._4e_scrollIntoView()},_maximize:function(){var h=this.editor,k=r.viewportHeight(),q=r.viewportWidth(),p=h.statusDiv?h.statusDiv.height():0,n=h.toolBarDiv.height();if(t.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new x(document.body)).css({width:0,height:0,overflow:"hidden"});
h.editorWrap.css({position:"absolute",zIndex:990,width:q+"px"});j.css({zIndex:985,height:k+"px",width:q+"px"});h.editorWrap.offset({left:0,top:0});j.css({left:0,top:0});h.wrap.css({height:k-p-n-14+"px"});h.notifySelectionChange()},_real:function(){var h=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",h._maximize,h);this.el.set("state",o.ON);setTimeout(function(){h._restoreEditorStatus()},30)},_prepare:function(){g.init&&g.init()},maximize:function(){this._prepare()}});
s.Maximize=g}();v.addPlugin(function(){new s.Maximize(v)})});
KISSY.Editor.add("music",function(v){function s(h){return h.indexOf(o)!=-1}var A=KISSY.Editor,t=KISSY,x=A.Flash,B="ke_music",o="niftyplayer.swf",r=A.Utils.getFlashUrl,j=v.htmlDataProcessor,g=j&&j.dataFilter;g&&g.addRules({elements:{object:function(h){var k=h.attributes;if(!(k.classid&&String(k.classid).toLowerCase())){for(k=0;k<h.children.length;k++)if(h.children[k].name=="embed"){if(!x.isFlashEmbed(h.children[k]))return null;if(s(h.children[k].attributes.src))return j.createFakeParserElement(h,B,
"music",true)}return null}for(k=0;k<h.children.length;k++){var q=h.children[k];if(q.name=="param"&&q.attributes.name=="movie")if(s(q.attributes.value))return j.createFakeParserElement(h,B,"music",true)}},embed:function(h){if(!x.isFlashEmbed(h))return null;if(s(h.attributes.src))return j.createFakeParserElement(h,B,"music",true)}}},4);A.MusicInserter||function(){function h(){h.superclass.constructor.apply(this,arguments)}function k(a){return a._4e_ascendant(function(f){return f._4e_name()==="img"&&
!!f.hasClass(B)},true)}function q(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var p=A.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"',n=/#\(music\)/g,w=["img."+B];t.extend(h,x,{_config:function(){var a=this.editor;a._toolbars=a._toolbars||{};a._toolbars.music=this;this._cls=B;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='http://'/></label></p></div>";
this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=c;this._flashRules=w},_initD:function(){var a=this,f=a.d;a.dUrl=f.el.one(".ke-music-url");var i=f.el.one(".ke-music-ok");f=f.el.one(".ke-music-cancel");i.on("click",a._gen,a);f.on("click",function(){a.d.hide()})},_getDWidth:function(){return"165"},_getDURl:function(){return p.replace(n,this.dUrl.val())},
_getDHeight:function(){return"37"},_getFlashUrl:function(a){return q(r(a))},_updateD:function(){var a=this.editor,f=this.selectedFlash;f?this.dUrl.val(this._getFlashUrl(a.restoreRealElement(f))):this.dUrl.val("")}});x.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",k);A.MusicInserter=h;var c={"\u7f16\u8f91\u97f3\u4e50":function(a){var f=a.getSelection();f=(f=f&&f.getStartElement())&&k(f);a=a._toolbars.music;if(f){a.selectedFlash=f;a.show()}}}}();v.addPlugin(function(){new A.MusicInserter(v)})});
KISSY.Editor.add("preview",function(v){var s=KISSY.Editor,A=KISSY,t=s.TripleButton;s.Preview||function(){function x(B){this.editor=B;this._init()}A.augment(x,{_init:function(){this.el=new t({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,o=640,r=420,j=80;try{var g=window.screen;o=Math.round(g.width*0.8);r=Math.round(g.height*0.7);j=Math.round(g.width*0.1)}catch(h){}B=
B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+B.getData()+"\n</body>");o=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+o+",height="+r+",left="+j);o.document.open();o.document.write(B);o.document.close()}});s.Preview=x}();v.addPlugin(function(){new s.Preview(v)})});
KISSY.Editor.add("removeformat",function(v){function s(k){this.editor=k;this._init()}function A(k,q){for(var p=0;p<q.length;p++)k.removeAttr(q[p])}var t=KISSY.Editor,x=KISSY,B=t.RANGE,o=t.ElementPath,r=t.NODE,j=t.TripleButton,g="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",h="class,style,lang,width,height,align,hspace,valign".split(",");g=new RegExp("^(?:"+g.replace(/,/g,"|")+")$","i");x.augment(s,{_init:function(){this.el=new j({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var k=this.editor,q=g;q.lastIndex=0;var p=k.getSelection().getRanges();k.fire("save");for(var n=0,w;w=p[n];n++)if(!w.collapsed){w.enlarge(B.ENLARGE_ELEMENT);var c=w.createBookmark(),a=c.startNode,f=c.endNode,i=function(d){for(var m=new o(d),b=m.elements,e=1,l;l=b[e];e++){if(l._4e_equals(m.block)||l._4e_equals(m.blockLimit))break;q.test(l._4e_name())&&d._4e_breakParent(l)}};
i(a);i(f);for(a=a._4e_nextSourceNode(true,r.NODE_ELEMENT);a;){if(a._4e_equals(f))break;i=a._4e_nextSourceNode(false,r.NODE_ELEMENT);a._4e_name()=="img"&&a.attr("_cke_realelement")||(q.test(a._4e_name())?a._4e_remove(true):A(a,h));a=i}w.moveToBookmark(c)}k.getSelection().selectRanges(p);k.fire("save")}});v.addPlugin(function(){new s(v)})});
KISSY.Editor.add("smiley",function(v){var s=KISSY.Editor,A=KISSY,t=A.DOM,x=A.Event,B=A.Node,o=s.SimpleOverlay,r=s.TripleButton;s.Smiley||function(){function j(k){this.editor=k;this._init()}for(var g="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",h=0;h<=98;h++)g+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+h+".gif'></a>";g+="</div></div>";A.augment(j,{_init:function(){this.el=new r({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(k){var q=this;t._4e_ascendant(k.target,function(p){return p[0]===q.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(k){k.halt();var q=this.editor;k=k.target;var p;if(t._4e_name(k)=="a"&&(p=t.attr(k,"data-icon"))){p=new B("<img src='"+p+"'/>",null,q.document);q.insertElement(p);this.smileyWin.hide()}},_prepare:function(){var k=this.editor;this.smileyPanel=new B(g);this.smileyWin=new o({el:this.smileyPanel,
focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);x.on(document,"click",this._hidePanel,this);x.on(k.document,"click",this._hidePanel,this)},_real:function(){var k=this.el.el.offset();k.top+=this.el.el.height()+5;if(k.left+this.smileyPanel.width()>t.viewportWidth()-60)k.left=t.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(k)},_show:function(k){this._prepare(k)}});s.Smiley=j}();v.addPlugin(function(){new s.Smiley(v)})});
KISSY.Editor.add("sourcearea",function(v){var s=KISSY.Editor,A=KISSY,t=A.UA,x=s.TripleButton;s.SourceArea||function(){function B(o){this.editor=o;this._init()}A.augment(B,{_init:function(){var o=this.editor;this.el=new x({container:o.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);o.textarea.on("mousedown",function(r){r.stopPropagation()})},_show:function(){var o=this.editor,r=
this.el;o.textarea.val(o.getData());o._showSource();r.set("state",x.ON)},_hide:function(){var o=this.editor,r=o.textarea,j=this.el;o._hideSource();o.setData(r.val());if(t.gecko&&o.iframeFocus){j.el[0].focus();o.focus()}j.set("state",x.OFF)}});s.SourceArea=B}();v.addPlugin(function(){new s.SourceArea(v)})});
KISSY.Editor.add("table",function(v,s){var A=KISSY.Editor,t=KISSY,x=t.Node,B=t.DOM,o=A.Walker,r=t.UA,j=A.NODE,g=A.TripleButton,h=A.SimpleOverlay,k=A.ContextMenu,q=["tr","th","td","tbody","table"],p=t.trim,n;n=(r.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var w=v.htmlDataProcessor,c=w&&w.dataFilter;w=w&&w.htmlFilter;c&&c.addRules({elements:{table:function(a){a=a.attributes;var f=a["class"],i=parseInt(a.border,10);if(!i||i<=0)a["class"]=(f||"")+" ke_show_border"}}});w&&w.addRules({elements:{table:function(a){a=a.attributes;var f=a["class"];if(f)a["class"]=t.trim(f.replace("ke_show_border","").replace(/\s{2}/," "))}}});A.TableUI||function(){function a(y){this.editor=y;this.selectedTable=
null;y._toolbars=y._toolbars||{};y._toolbars.table=this;this._init()}function f(y){return p(y).length!=0}function i(y){function C($){if(!(N.length>0))if($[0].nodeType==j.NODE_ELEMENT&&D.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var I=y.createBookmarks(),J=y.getRanges(),N=[],M={},Q=0;Q<J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new o(R);
var W;for(R.guard=C;W=R.next();)if((W=W.parent())&&D.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}A.Utils.clearAllMarkers(M);y.selectBookmarks(I);return N}function d(y){y=y.cells;for(var C=0;C<y.length;C++){y[C].innerHTML="";r.ie||(new x(y[C]))._4e_appendBogus()}}function m(y,C){if(y=y.getStartElement()._4e_ascendant("tr")){var I=y._4e_clone(true);I.insertBefore(y);d(C?I[0]:y[0])}}function b(y){if(y instanceof A.Selection){var C=i(y),I=C.length;
y=[];for(var J,N,M=0;M<I;M++){var Q=C[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);y[R]=Q;M==I-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new x(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=y.length;M>=0;M--)y[M]&&b(y[M]);return J}else if(y instanceof x){M=y._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():y._4e_remove()}return 0}function e(y,C){y=y.getStartElement();if(y=y._4e_ascendant("td",true)||y._4e_ascendant("th",true))for(var I=y._4e_ascendant("table"),J=y[0].cellIndex,
N=0;N<I[0].rows.length;N++){var M=I[0].rows[N];if(!(M.cells.length<J+1)){y=new x(M.cells[J].cloneNode(false));r.ie||y._4e_appendBogus();M=new x(M.cells[J]);C?y.insertBefore(M):y.insertAfter(M)}}}function l(y){var C=[],I=y[0]&&y[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=y.length;J<N;J++)C.push(y[J][0].cellIndex);C.sort();J=1;for(N=C.length;J<N;J++)if(C[J]-C[J-1]>1){M=C[J-1]+1;break}M||(M=C[0]>0?C[0]-1:C[C.length-1]+1);y=I[0].rows;J=0;for(N=y.length;J<N;J++)if(Q=y[J].cells[M])break;return Q?new x(Q):
I._4e_previous()}function z(y){if(y instanceof A.Selection){var C=i(y),I=l(C);for(y=C.length-1;y>=0;y--)C[y]&&z(C[y]);return I}else if(y instanceof x){C=y._4e_ascendant("table");if(!C)return null;I=y[0].cellIndex;for(y=C[0].rows.length-1;y>=0;y--){var J=new x(C[0].rows[y]);if(!I&&J[0].cells.length==1)b(J);else J[0].cells[I]&&J[0].removeChild(J[0].cells[I])}}return null}function u(y,C){var I=new A.Range(y[0].ownerDocument);if(!I.moveToElementEditablePosition(y,C?true:s)){I.selectNodeContents(y);I.collapse(C?
false:true)}I.select(true)}t.augment(a,{_init:function(){var y=this.editor,C={};this.el=new g({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:y.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in H)(function(J){C[J]=function(){y.fire("save");H[J](y);y.fire("save")}})(I);k.register(y.document,{rules:q,width:"120px",funcs:C});A.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var y=this,C=new h({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});
C.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
C.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");C.twidth=C.body.one(".ke-table-width");C.theight=C.body.one(".ke-table-height");C.tcellspacing=C.body.one(".ke-table-cellspacing");C.tcellpadding=C.body.one(".ke-table-cellpadding");C.tborder=C.body.one(".ke-table-border");C.tcaption=C.body.one(".ke-table-caption");C.talign=C.body.one(".ke-table-align");C.trows=C.body.one(".ke-table-rows");C.tcols=C.body.one(".ke-table-cols");C.thead=
C.body.one(".ke-table-head");var I=C.foot.one(".ke-table-ok"),J=C.foot.one(".ke-table-cancel");C.twidthunit=C.body.one(".ke-table-width-unit");y.tableDialog=C;I.on("click",y._tableOk,y);C.on("hide",function(){y.selectedTable=null});J.on("click",function(){C.hide()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var y=this.tableDialog,C=this.selectedTable,I=C.one("caption");f(y.talign.val())&&C.attr("align",p(y.talign.val()));f(y.tcellspacing.val())&&
C.attr("cellspacing",p(y.tcellspacing.val()));f(y.tcellpadding.val())&&C.attr("cellpadding",p(y.tcellpadding.val()));f(y.tborder.val())&&C.attr("border",p(y.tborder.val()));!f(y.tborder.val())||y.tborder.val()=="0"?C.addClass("ke_show_border"):C.removeClass("ke_show_border");f(y.twidth.val())&&C.css("width",p(y.twidth.val())+y.twidthunit.val());f(y.theight.val())&&C.css("height",p(y.theight.val()));if(f(y.tcaption.val()))I&&I[0]?I.html(p(y.tcaption.val())):(new x("<caption><span>"+p(y.tcaption.val())+
"</span></caption>")).insertBefore(C[0].firstChild);else I&&I._4e_remove();y.hide()},_genTable:function(){var y=this.tableDialog,C="<table ",I,J=parseInt(y.tcols.val())||1,N=parseInt(y.trows.val())||1,M=r.ie?"&nbsp;":"<br/>",Q=this.editor;if(t.trim(y.talign.val()).length!=0)C+="align='"+t.trim(y.talign.val())+"' ";if(t.trim(y.tcellspacing.val()).length!=0)C+="cellspacing='"+t.trim(y.tcellspacing.val())+"' ";if(t.trim(y.tcellpadding.val()).length!=0)C+="cellpadding='"+t.trim(y.tcellpadding.val())+
"' ";if(t.trim(y.tborder.val()).length!=0)C+="border='"+t.trim(y.tborder.val())+"' ";if(t.trim(y.twidth.val()).length!=0||t.trim(y.theight.val()).length!=0){C+="style='";if(t.trim(y.twidth.val()).length!=0)C+="width:"+t.trim(y.twidth.val())+y.twidthunit.val()+";";if(t.trim(y.theight.val()).length!=0)C+="height:"+t.trim(y.theight.val())+"px;";C+="' "}if(t.trim(y.tborder.val()).length==0||t.trim(y.tborder.val())=="0")C+="class='ke_show_border' ";C+=">";if(t.trim(y.tcaption.val()))C+="<caption><span>"+
t.trim(y.tcaption.val())+"</span></caption>";if(y.thead.val()){C+="<thead>";C+="<tr>";for(I=0;I<J;I++)C+="<th>"+M+"</th>";C+="</tr>";C+="</thead>";N-=1}C+="<tbody>";for(var R=0;R<N;R++){C+="<tr>";for(I=0;I<J;I++)C+="<td>"+M+"</td>";C+="</tr>"}C+="</tbody>";C+="</table>";C=new x(C,null,Q.document);Q.insertElement(C);y.hide()},_fillTableDialog:function(){var y=this.tableDialog,C=this.selectedTable,I=C.one("caption");y.talign.val(C.attr("align")||"");y.tcellspacing.val(C.attr("cellspacing")||"");y.tcellpadding.val(C.attr("cellpadding")||
"");y.tborder.val(C.attr("border")|"");var J=C._4e_style("width")||"";y.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?y.twidthunit.val("%"):y.twidthunit.val("px");y.theight.val((C._4e_style("height")||"").replace(/px|%/i,""));J="";if(I)J=I.text();y.tcaption.val(J);y.trows.val(C.one("tbody").children().length);y.tcols.val(C.one("tr").children().length);y.thead.val(C._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();
this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var D=/^(?:td|th)$/,H={"\u8868\u683c\u5c5e\u6027":function(y){var C=y.getSelection();if(C=(C=C&&C.getStartElement())&&C._4e_ascendant("table",true)){y=y._toolbars.table;y.selectedTable=C;y._tableShow()}},"\u5220\u9664\u8868\u683c":function(y){var C=
(y=y.getSelection())&&y.getStartElement();if(C=C&&C._4e_ascendant("table",true)){y.selectElement(C);var I=y.getRanges()[0];I.collapse();y.selectRanges([I]);y=C.parent();y[0].childNodes.length==1&&y._4e_name()!="body"?y._4e_remove():C._4e_remove()}},"\u5220\u9664\u884c ":function(y){y=y.getSelection();u(b(y),s)},"\u5220\u9664\u5217 ":function(y){y=y.getSelection();(y=z(y))&&u(y,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(y){y=y.getSelection();m(y,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(y){y=
y.getSelection();m(y,s)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(y){y=y.getSelection();e(y,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(y){y=y.getSelection();e(y,s)}};A.TableUI=a}();v.addPlugin(function(){var a=v.document;new A.TableUI(v);var f=B.create("<style>",null,a);a.getElementsByTagName("head")[0].appendChild(f);if(f.styleSheet)f.styleSheet.cssText=n;else f.appendChild(a.createTextNode(n))})});
KISSY.Editor.add("templates",function(v){var s=KISSY.Editor,A=KISSY,t=A.Node,x=s.TripleButton,B=s.SimpleOverlay;s.TplUI||function(){function o(r){this.editor=r;this._init()}A.augment(o,{_init:function(){(new x({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var r=this.editor,j=r.cfg.pluginConfig.templates,g="<div class='ke-tpl'>",h=0;h<j.length;h++)g+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
j[h].demo+"</a>";g+="</div>";this._initDialogOk=true;var k=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});k.body.html(g);k.body.all(".ke-tpl-list").on("click",function(q){q.halt();q=(new t(q.target))._4e_index();q!=-1&&r.insertHtml(j[q].html);k.hide()});this.ui=k},_real:function(){this.ui.show()},_show:function(){this._prepare()}});s.TplUI=o}();v.addPlugin(function(){new s.TplUI(v)})});
KISSY.Editor.add("undo",function(v){var s=KISSY.Editor,A=KISSY,t=s.Utils.arrayCompare,x=A.UA,B=A.Event;s.UndoManager||function(){function o(n){var w=n._getRawData();n=w&&n.getSelection();this.contents=w;this.bookmarks=n&&n.createBookmarks2(true)}function r(n,w,c){this.s=n;this.fn=w;this.scope=c||window;this.bufferTimer=null}function j(n){this.history=[];this.index=0;this.editor=n;this.bufferTimer=new r(500,this.save,this);this._init()}function g(n,w,c,a){this.editor=n;this.title=c;this.text=w;this.contentCls=
a;this._init()}A.augment(o,{equals:function(n){if(this.contents!=n.contents)return false;var w=this.bookmarks;n=n.bookmarks;if(w||n){if(!w||!n||w.length!=n.length)return false;for(var c=0;c<w.length;c++){var a=w[c],f=n[c];if(a.startOffset!=f.startOffset||a.endOffset!=f.endOffset||!t(a.start,f.start)||!t(a.end,f.end))return false}}return true}});A.augment(r,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var n=this;this.bufferTimer=setTimeout(function(){n.fn.call(n.scope)},
this.s)}});var h={16:1,17:1,18:1},k={37:1,38:1,39:1,40:1};A.augment(j,{_keyMonitor:function(){var n=this.editor;B.on(n.document,"keydown",function(w){var c=w.keyCode;if(!(c in k||c in h))if(c===90&&(w.ctrlKey||w.metaKey)){n.fire("restore",{d:-1});w.halt()}else if(c===89&&(w.ctrlKey||w.metaKey)){n.fire("restore",{d:1});w.halt()}else n.fire("save",{buffer:1})})},_init:function(){var n=this,w=n.editor;w.on("save",function(c){c.buffer?n.bufferTimer.run():n.save()});w.on("restore",this.restore,this);n._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var n=this.editor,w=this.history.length>0?this.history[this.history.length-1]:null,c=new o(this.editor);if(!w||!w.equals(c)){this.history.length===30&&this.history.shift();this.history.push(c);this.index=this.history.length-1;n.fire("afterSave",{history:this.history,index:this.index})}},restore:function(n){n=n.d;var w=this.editor,c=this.history.length>0?this.history[this.index+n]:null;
if(c){w._setRawData(c.contents);if(c.bookmarks)this.editor.getSelection().selectBookmarks(c.bookmarks);else if(x.ie){c=this.editor.document.body.createTextRange();c.collapse(true);c.select()}this.index+=n;w.fire("afterRestore",{history:this.history,index:this.index});w.notifySelectionChange()}}});var q=s.TripleButton,p={redo:1,undo:-1};A.augment(g,{_init:function(){var n=this,w=n.editor;n.el=new q({contentCls:n.contentCls,title:n.title,container:w.toolBarDiv});this.el.set("state",q.DISABLED);w.on("afterSave",
this._respond,this);w.on("afterRestore",this._respond,this);n.el.on("offClick",function(){w.fire("restore",{d:p[n.text]})})},_respond:function(n){this.updateUI(n.history,n.index)},updateUI:function(n,w){if(this.text=="undo")w>0&&n.length>0?this.el.set("state",q.OFF):this.el.set("state",q.DISABLED);else if(this.text=="redo")w<n.length-1?this.el.set("state",q.OFF):this.el.set("state",q.DISABLED)}});s.UndoManager=j;s.RestoreUI=g}();v.addPlugin(function(){new s.UndoManager(v);new s.RestoreUI(v,"undo",
"\u64a4\u9500","ke-toolbar-undo");new s.RestoreUI(v,"redo","\u91cd\u505a","ke-toolbar-redo")})});
