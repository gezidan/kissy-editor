KISSY.add("editor",function(w,t){function A(r,a){var b=this;if(!(b instanceof A))return new A(r,a);if(w.isString(r))r=w.one(r);r[0]||(r=new Node(r));b.cfg=a||{pluginConfig:{}};w.app(b,w.EventTarget);b.use=function(g){if(w.isString(g))g=g.split(",");var h=g;g=[];g=w.indexOf("separator",h);var k=g!=-1;g=h.splice(0,k?g+1:h.length);k&&g.pop();g.length!=0?w.use.call(b,g.join(","),function(){k&&b.addPlugin(function(){A.Utils.addSeparator(b.toolBarDiv)});b.use(h)},{order:true,global:A}):b.on("dataReady",
function(){b.setData(r.val())});return b};b.init(r);return t}function u(r){if(!x)return"build/"+r.replace(/\.(js|css)/i,"-min.$1");if(x==="dev")return r;return"build/"+r}w.app(A,w.EventTarget);A.Config.base=w.Config.base+"editor/";var x=w.Config.debug,B={htmlparser:{attach:false,path:u("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},q=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],s=["clipboard",{name:"color"},{name:"elementpaths"},
"enterkey","fakeobjects",{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["contextmenu","fakeobjects","overlay"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize","music","preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo"],
i=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],e=[{name:"button"},{name:"overlay"},{name:"contextmenu",requires:["overlay"]},
{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}],l,f,m,p,o;l=0;for(f=e.length;l<f;l++){p=m=e[l];o=t;if(!w.isString(m)){o=m.requires;p=m.name}B[p]={attach:false,requires:o,path:u("ui/"+p+".js"),csspath:m.useCss?u("ui/"+p+".css"):""}}l=0;for(f=s.length;l<f;l++){p=m=s[l];o=["button"];if(!w.isString(m)){m.requires&&(o=o.concat(m.requires));p=m.name}B[p]={attach:false,requires:o,csspath:m.useCss?u("plugins/"+p+"/plugin.css"):t,path:u("plugins/"+p+"/plugin.js")}}l=0;for(f=
i.length;l<f;l++){m=i[l];o=t;if(!w.isString(m)){o=m.requires;m=m.name}B[m]={attach:false,requires:o,path:u("plugins/htmldataprocessor/htmlparser/"+m.substring(11)+".js")}}A.add(B);B={};l=0;for(f=q.length;l<f;l++){m=q[l];B[m]={host:"editor",requires:l>0?q[l-1]:[]}}A.add(B);w.Editor=A});
KISSY.Editor.add("utils",function(w){var t=KISSY,A=t.Node,u=t.DOM,x=t.Config.debug,B=t.UA;w.Utils={getFlashUrl:function(q){var s="",i=w.NODE;if(q._4e_name()=="object"){q=q[0].childNodes;for(var e=0;e<q.length;e++)if(q[e].nodeType==i.NODE_ELEMENT)if((u.attr(q[e],"name")||"").toLowerCase()=="movie")s=u.attr(q[e],"value");else if(u._4e_name(q[e])=="embed")s=u.attr(q[e],"src");else u._4e_name(q[e])=="object"&&u.attr(q[e],"data")}else if(q._4e_name()=="embed")s=q.attr("src");return s},debugUrl:function(q){if(!x)return"build/"+
q.replace(/\.(js|css)/i,"-min.$1");if(x==="dev")return q;return"build/"+q},lazyRun:function(q,s,i){var e=q[s],l=q[i];q[s]=function(){e.apply(this,arguments);q[s]=q[i];return l.apply(this,arguments)}},getXY:function(q,s,i,e){i=i.defaultView||i.parentWindow;q-=u.scrollLeft(i);s-=u.scrollTop(i);if(e)if(i!=(e.defaultView||e.parentWindow)&&i.frameElement){e=u._4e_getOffset(i.frameElement,e);q+=e.left;s+=e.top}return{left:q,top:s}},tryThese:function(){for(var q,s=0,i=arguments.length;s<i;s++){var e=arguments[s];
try{q=e();break}catch(l){}}return q},arrayCompare:function(q,s){if(!q&&!s)return true;if(!q||!s||q.length!=s.length)return false;for(var i=0;i<q.length;i++)if(q[i]!==s[i])return false;return true},getByAddress:function(q,s,i){q=q.documentElement;for(var e=0;q&&e<s.length;e++){var l=s[e];if(i)for(var f=-1,m=0;m<q.childNodes.length;m++){var p=q.childNodes[m];if(!(i===true&&p.nodeType==3&&p.previousSibling&&p.previousSibling.nodeType==3)){f++;if(f==l){q=p;break}}}else q=q.childNodes[l]}return q?new A(q):
null},clearAllMarkers:function(q){for(var s in q)q[s]._4e_clearMarkers(q,true)},htmlEncodeAttr:function(q){return q.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(q){return q.replace(/^\s+/,"")},rtrim:function(q){return q.replace(/\s+$/,"")},trim:function(q){return this.ltrim(this.rtrim(q))},mix:function(){for(var q={},s=0;s<arguments.length;s++)q=t.mix(q,arguments[s]);return q},isCustomDomain:function(){if(!B.ie)return false;var q=document.domain,s=window.location.hostname;
return q!=s&&q!="["+s+"]"},addSeparator:function(q){(new t.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(q)}}});
KISSY.Editor.add("focusmanager",function(w){function t(){this.iframeFocus=true;s=this}function A(){this.iframeFocus=false;s=null}var u=KISSY,x=u.DOM,B=u.Event;u={};var q={},s;u={refreshAll:function(){for(var i in q){var e=q[i];e.document.designMode="off";e.document.designMode="on"}},currentInstance:function(){return s},getInstance:function(i){return q[i]},add:function(i){var e=x._4e_getWin(i.document);B.on(e,"focus",t,i);B.on(e,"blur",A,i)},register:function(i){q[i._UUID]=i},remove:function(i){delete q[i._UUID];
var e=x._4e_getWin(i.document);B.remove(e,"focus",t,i);B.remove(e,"blur",A,i)}};w.focusManager=u});
KISSY.Editor.add("definition",function(w){function t(o){return e+"<html><head><title>kissy-editor</title><link href='"+w.Config.base+l+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(o?'<script id="ke_actscrpt" type="text/javascript">'+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+o+'");<\/script>':"")}var A=KISSY,u=A.UA,x=A.DOM,B=A.Node,q=A.Event,s=w.focusManager,i=w.Utils.tryThese,e="<!doctype html>",l=
w.Utils.debugUrl("assets/editor-iframe.css"),f=1,m="document.open();"+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",p="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(u.ie?"javascript:void(function(){"+encodeURIComponent(m)+"}())":"")+'"  tabIndex="'+
(u.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";A.augment(w,{init:function(o){var r=this,a=new B(p.replace(/\$\(tabIndex\)/,o.attr("tabIndex")));a.on("mousedown",function(h){if(u.webkit){var k=x._4e_name(h.target);if(k=="select"||k=="option")return true}h.halt()});r.editorWrap=a;r._UUID=f++;s.register(r);r.wrap=a.one(".ke-textarea-wrap");r.iframe=r.wrap.one("iframe");r.toolBarDiv=a.one(".ke-editor-tools");r.textarea=
o;r.statusDiv=a.one(".ke-editor-status");r.toolBarDiv._4e_unselectable();r._commands={};r._plugins={};var b=o._4e_style("width"),g=o._4e_style("height");if(b){a.css("width",b);o.css("width","100%")}r.textarea.css("display","none");a.insertAfter(o);r.wrap[0].appendChild(o[0]);if(g){r.wrap.css("height",g);o.css("height","100%")}o=r.iframe;r.on("dataReady",function(){r.ready=true;w.fire("instanceCreated",{editor:r})});u.gecko?o.on("load",r._setUpIFrame,r):r._setUpIFrame()},addCommand:function(o,r){this._commands[o]=
r},execCommand:function(o){this.fire("save");this._commands[o].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(o){if(this.htmlDataProcessor)o=this.htmlDataProcessor.toDataFormat(o,"p");this.document.body.innerHTML=o},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(o){this.document.body.innerHTML=
o},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");u.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:t,getSelection:function(){var o=new w.Selection(this.document);return!o||o.isInvalid?null:o},focus:function(){var o=x._4e_getWin(this.document);u.webkit&&o&&o.parent&&o.parent.focus();o&&o.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){x._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function o(){h=g.document;r.document=h;a.detach();h.open("text/html","replace");h.write(b);h.close()}
var r=this,a=r.iframe,b=t(r._UUID),g=a[0].contentWindow,h;try{h=g.document}catch(k){a[0].src=a[0].src;if(u.ie&&u.ie<7){setTimeout(o,10);return}}o()},addPlugin:function(o){this.ready?o():this.on("dataReady",o)},_monitor:function(){var o=this;o._monitorId&&clearTimeout(o._monitorId);o._monitorId=setTimeout(function(){var r=o.getSelection();if(r&&!r.isInvalid){r=r.getStartElement();var a=new w.ElementPath(r);if(!o.previousPath||!o.previousPath.compare(a)){o.previousPath=a;o.fire("selectionChange",{selection:o,
path:a,element:r})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(o,r){var a=this;a.focus();var b=o._4e_name(),g=w.XHTML_DTD,h=w.RANGE,k=w.NODE,j=g.$block[b],c=a.getSelection(),d=c.getRanges(),n,y,v,D,H;a.fire("save");for(var z=d.length-1;z>=0;z--){n=d[z];n.deleteContents();y=!z&&o||o._4e_clone(true);r&&r(y);if(j)for(;(D=n.getCommonAncestor(false,true))&&(H=g[D._4e_name()])&&!(H&&H[b]);)if(D._4e_name()in g.span)n.splitElement(D);else if(n.checkStartOfBlock()&&
n.checkEndOfBlock()){n.setStartBefore(D);n.collapse(true);D._4e_remove()}else n.splitBlock();n.insertNode(y);v||(v=y)}o=v._4e_nextSourceNode(true);r=a.document;H=w.XHTML_DTD;if(H.$inline[y._4e_name()]){o=new B(r.createTextNode(" "));o.insertAfter(v)}else if(o){if(o._4e_name()=="br"&&H[o.parent()._4e_name()].p){H=new B("<p>&nbsp;</p>",null,r);o[0].parentNode.replaceChild(H[0],o[0]);o=H}}else{H=new B("<p>&nbsp;</p>",null,r);H.insertAfter(v);o=H}n.moveToPosition(v,h.POSITION_AFTER_END);o&&o[0].nodeType==
k.NODE_ELEMENT&&n.moveToElementEditablePosition(o);c.selectRanges([n]);a.focus();y&&y._4e_scrollIntoView();setTimeout(function(){a.fire("save")},10);return y},insertHtml:function(o){var r=this;if(r.htmlDataProcessor)o=r.htmlDataProcessor.toDataFormat(o);if(u.webkit){o=x.create(o,null,this.document);o=o.nodeType==11?A.makeArray(o.childNodes):[o];for(var a=0;a<o.length;a++)r.insertElement(new B(o[a]))}else{r.focus();r.fire("save");a=r.getSelection();if(u.ie){a=a.getNative();a.type=="Control"&&a.clear();
a.createRange().pasteHTML(o)}else r.document.execCommand("inserthtml",false,o);r.focus();setTimeout(function(){r.fire("save")},10)}}});w._initIFrame=function(o){function r(v){i(function(){g.designMode="on";setTimeout(function(){g.designMode="off";k.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){g.designMode="off";x.attr(k,"contentEditable",false);x.attr(k,"contentEditable",true);!v&&r(1)})}var a=s.getInstance(o);o=a.textarea[0];var b=a.iframe[0].contentWindow,g=a.document,
h=g.getElementById("ke_actscrpt");h.parentNode.removeChild(h);var k=g.body;if(u.ie){k.hideFocus=true;k.disabled=true;k.contentEditable=true;k.removeAttribute("disabled")}else setTimeout(function(){if(u.gecko||u.opera)k.contentEditable=true;else if(u.webkit)k.parentNode.contentEditable=true;else g.designMode="on"},0);try{g.execCommand("enableObjectResizing",false,true)}catch(j){}try{g.execCommand("enableInlineTableEditing",false,true)}catch(c){}u.webkit&&q.on(g,"mousedown",function(v){v=new B(v.target);
A.inArray(v._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(v)});if(u.webkit){q.on(g,"click",function(v){var D=new B(v.target);A.inArray(D._4e_name(),["input","select"])&&v.preventDefault()});q.on(g,"mouseup",function(v){var D=new B(v.target);A.inArray(D._4e_name(),["input","textarea"])&&v.preventDefault()})}if(u.gecko||u.ie||u.opera){var d;d=new B(x.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],o));d.on("focus",function(){a.focus()});
a.on("destroy",function(){})}if(u.ie&&g.compatMode=="CSS1Compat"||u.gecko||u.opera){var n=new B(g.documentElement);n.on("mousedown",function(v){if(v.target===n[0]){u.gecko&&r(false);d[0].focus()}})}q.on(b,"focus",function(){if(u.gecko)r(false);else u.opera&&k.focus();a.notifySelectionChange()});u.gecko&&q.on(a.document,"mousedown",function(){a.iframeFocus||r(false)});if(u.ie){q.on(g,"keydown",function(v){if(v.keyCode in{8:1,46:1}){var D=a.getSelection(),H=D.getSelectedElement();if(H){a.fire("save");
var z=D.getRanges()[0].createBookmark();H._4e_remove();D.selectBookmarks([z]);a.fire("save");v.preventDefault()}}});if(g.compatMode=="CSS1Compat"){var y={33:1,34:1};q.on(g,"keydown",function(v){v.keyCode in y&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){u.ie&&setTimeout(function(){if(g){k.runtimeStyle.marginBottom="0px";k.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady")},10);s.add(a)};u.gecko&&function(){var o=document.body;
if(o){var r=o.getAttribute("onpageshow");o.setAttribute("onpageshow",(r?r+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(w){w.XHTML_DTD=function(){var t=function(j){for(var c=arguments.length-1;c>0;)KISSY.mix(j,arguments[c--]);return j},A={isindex:1,fieldset:1},u={input:1,button:1,select:1,textarea:1,label:1},x=t({a:1},u),B=t({iframe:1},x),q={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},s={ins:1,del:1,script:1,style:1},i=t({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},s),e=t({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},i),l=t({p:1},e);u=t({iframe:1},e,u);e={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var f=t({a:1},u),m={tr:1},p={"#":1},o=t({param:1},e),r=t({form:1},A,B,q,l),a={li:1},b={base:1,link:1,meta:1,title:1},g=t(b,{style:1,script:1}),h={head:1,body:1},k={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:t({html:1},h,b),$block:k,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:f,$body:t({script:1,style:1},k),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:h,head:g,style:p,body:r,base:{},link:{},meta:{},title:p,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:r,td:r,br:{},th:r,center:r,kbd:f,button:t(l,q),basefont:{},h5:f,h4:f,samp:f,h6:f,ol:a,h1:f,h3:f,option:p,h2:f,form:t(A,B,q,l),select:{optgroup:1,option:1},font:f,ins:f,menu:a,abbr:f,label:f,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:f,script:p,tfoot:m,cite:f,li:r,input:{},iframe:r,strong:f,textarea:p,noframes:r,big:f,small:f,span:f,hr:{},dt:f,sub:f,optgroup:{option:1},param:{},bdo:f,"var":f,div:r,object:o,sup:f,dd:r,strike:f,area:{},dir:a,map:t({area:1,form:1,p:1},A,s,q),applet:o,dl:{dt:1,dd:1},del:f,isindex:{},fieldset:t({legend:1},e),thead:m,ul:a,acronym:f,b:f,a:u,blockquote:r,caption:f,i:f,u:f,tbody:m,s:f,address:t(B,l),tt:f,legend:f,q:f,pre:t(i,x),p:f,em:f,dfn:f}}()});
KISSY.Editor.add("dom",function(w){function t(a){return a.replace(/-(\w)/g,function(b,g){return g.toUpperCase()})}var A=KISSY,u=A.DOM,x=A.UA,B=A.Node,q=w.Utils,s={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};w.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};w.POSITION={};var i=w.NODE,e=w.POSITION;e.POSITION_IDENTICAL=0;e.POSITION_DISCONNECTED=
1;e.POSITION_FOLLOWING=2;e.POSITION_PRECEDING=4;e.POSITION_IS_CONTAINED=8;e.POSITION_CONTAINS=16;var l={},f={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},m={hr:1},p=function(a){return a[0]||a},o=function(a){if(!a[0])return new B(a);return a},r={_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=p(a);b=p(b);return a===b},_4e_isBlockBoundary:function(a,
b){a=o(a);b=A.mix(A.mix({},m),b||{});return f[a.css("display")]||b[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=p(a);for(var b=a.parentNode.childNodes,g=0;g<b.length;g++)if(b[g]===a)return g;return-1},_4e_first:function(a,b){a=p(a);if((a=(a=a.firstChild)&&new B(a))&&b&&!b(a))a=a._4e_next(b);return a},_4e_move:function(a,b,g){a._4e_remove();a=p(a);b=p(b);g?b.insertBefore(a,b.firstChild):b.appendChild(a)},
_4e_name:function(a){a=p(a);var b=a.nodeName.toLowerCase();if(x.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var g=a[0].attributes,h=b[0].attributes,k=g.length,j=h.length;if(!x.ie&&k!=j)return false;for(var c=0;c<k;c++){var d=g[c];if((!x.ie||d.specified&&d.nodeName!="_ke_expando")&&d.nodeValue!=b.attr(d.nodeName))return false}if(x.ie)for(c=0;c<j;c++){d=h[c];if(d.specified&&d.nodeName!="_ke_expando"&&d.nodeValue!=
a.attr(d.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=p(a).childNodes;for(var b=0,g=a.length;b<g;b++){var h=a[b],k=h.nodeType;if(!(k==i.NODE_ELEMENT&&h.getAttribute("_ke_bookmark")))if(k==i.NODE_ELEMENT&&!r._4e_isEmptyInlineRemoveable(h)||k==i.NODE_TEXT&&A.trim(h.nodeValue))return false}return true},_4e_moveChildren:function(a,b,g){a=p(a);b=b[0]||b;if(a!=b)if(g)for(;g=a.lastChild;)b.insertBefore(a.removeChild(g),b.firstChild);else for(;g=a.firstChild;)b.appendChild(a.removeChild(g))},
_4e_mergeSiblings:function(){function a(b,g,h){if(g[0]&&g[0].nodeType==i.NODE_ELEMENT){for(var k=[];g.attr("_ke_bookmark")||g._4e_isEmptyInlineRemoveable();){k.push(g);g=h?new B(g[0].nextSibling):new B(g[0].previousSibling);if(!g[0]||g[0].nodeType!=i.NODE_ELEMENT)return}if(b._4e_isIdentical(g)){for(var j=h?b[0].lastChild:b[0].firstChild;k.length;)k.shift()._4e_move(b,!h);g._4e_moveChildren(b,!h);g._4e_remove();j[0]&&j[0].nodeType==i.NODE_ELEMENT&&j._4e_mergeSiblings()}}}return function(b){if(b[0])if(s[b._4e_name()]||
b._4e_name()=="a"){a(b,new B(b[0].nextSibling),true);a(b,new B(b[0].previousSibling))}}}(),_4e_unselectable:x.gecko?function(a){a=p(a);a.style.MozUserSelect="none"}:x.webkit?function(a){a=p(a);a.style.KhtmlUserSelect="none"}:function(a){a=p(a);if(x.ie||x.opera){var b,g=0;for(a.unselectable="on";b=a.all[g++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable="on"}}},_4e_getOffset:function(a,b){a=p(a);var g,h=0;g=0;var k=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,j=a.ownerDocument,c=j.documentElement;b=b||j;if(a.getBoundingClientRect){if(a!==j.body&&c!==a){g=a.getBoundingClientRect();h=g.left+(b===j?u.scrollLeft(k):0);g=g.top+(b===j?u.scrollTop(k):0)}if(b)if(k!=(b.defaultView||b.parentWindow)&&k.frameElement){b=r._4e_getOffset(k.frameElement,b);h+=b.left;g+=b.top}}return{left:h,top:g}},_4e_getFrameDocument:function(a){return(a=p(a))&&a.contentWindow.document},_4e_splitText:function(a,b){a=p(a);var g=a.ownerDocument;if(!(!a||a.nodeType!=
i.NODE_TEXT)){if(x.ie&&b==a.nodeValue.length){g=g.createTextNode("");u.insertAfter(g,a);return g}a=new B(a.splitText(b));if(x.ie==8){g=g.createTextNode("");u.insertAfter(g,a[0]);g.parentNode.removeChild(g)}return a}},_4e_parents:function(a,b){a=o(a);var g=[];do g[b?"push":"unshift"](a);while(a=a.parent());return g},_4e_clone:function(a,b,g){a=p(a);a=a.cloneNode(b);if(!g){var h=function(k){if(k.nodeType==i.NODE_ELEMENT){k.removeAttribute("id",false);k.removeAttribute("_ke_expando",false);k=k.childNodes;
for(var j=0;j<k.length;j++)h(k[j])}};h(a)}return new B(a)},_4e_nextSourceNode:function(a,b,g,h){a=p(a);if(h&&!h.call){var k=h[0]||h;h=function(c){c=c[0]||c;return c!==k}}b=!b&&a.firstChild;var j=new B(a);if(!b){if(a.nodeType==i.NODE_ELEMENT&&h&&h(this,true)===false)return null;b=a.nextSibling}for(;!b&&(j=j.parent());){if(h&&h(j,true)===false)return null;b=j[0].nextSibling}if(!b)return null;b=new B(b);if(h&&h(b)===false)return null;if(g&&g!=b[0].nodeType)return b._4e_nextSourceNode(false,g,h);return b},
_4e_previousSourceNode:function(a,b,g,h){a=p(a);if(h&&!h.call){var k=h[0]||h;h=function(c){c=c[0]||c;return c!==k}}b=!b&&a.lastChild;var j=new B(a);if(!b){if(a.nodeType==i.NODE_ELEMENT&&h&&h(a,true)===false)return null;b=a.previousSibling}for(;!b&&(j=j.parent());){if(h&&h(j,true)===false)return null;b=j[0].previousSibling}if(!b)return null;b=new B(b);if(h&&h(b)===false)return null;if(g&&b[0].nodeType!=g)return b._4e_previousSourceNode(false,g,h);return b},_4e_contains:x.ie||x.webkit?function(a,b){a=
p(a);b=p(b);return b.nodeType!=i.NODE_ELEMENT?a.contains(b.parentNode):a!=b&&a.contains(b)}:function(a,b){a=p(a);b=p(b);return!!(a.compareDocumentPosition(b)&16)},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=i.NODE_TEXT&&b._4e_contains(a))return b;a=a[0].nodeType==i.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=i.NODE_TEXT&&a._4e_contains(b))return a;while(a=a.parent());return null},_4e_ascendant:function(a,b,g){a=p(a);if(!g)a=a.parentNode;if(b&&!A.isFunction(b)){var h=
b;b=function(k){return k._4e_name()==h}}for(;a&&a.nodeType!=9;){if(!b||b(new B(a))===true)return new B(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,b){a=p(a);a=a.attributes.getNamedItem(b);return!!(a&&a.specified)},_4e_hasAttributes:x.ie?function(a){a=p(a);for(var b=a.attributes,g=0;g<b.length;g++){var h=b[g];switch(h.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(h.specified)return true}}return false}:function(a){a=p(a);x.gecko&&
a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,b){var g=p(a),h=p(b);if(g.compareDocumentPosition)return g.compareDocumentPosition(h);if(g==h)return e.POSITION_IDENTICAL;if(g.nodeType==i.NODE_ELEMENT&&h.nodeType==i.NODE_ELEMENT){if(g.contains){if(g.contains(h))return e.POSITION_CONTAINS+e.POSITION_PRECEDING;if(h.contains(g))return e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING}if("sourceIndex"in g)return g.sourceIndex<
0||h.sourceIndex<0?e.POSITION_DISCONNECTED:g.sourceIndex<h.sourceIndex?e.POSITION_PRECEDING:e.POSITION_FOLLOWING}a=a._4e_address();b=b._4e_address();g=Math.min(a.length,b.length);for(h=0;h<=g-1;h++)if(a[h]!=b[h]){if(h<g)return a[h]<b[h]?e.POSITION_PRECEDING:e.POSITION_FOLLOWING;break}return a.length<b.length?e.POSITION_CONTAINS+e.POSITION_PRECEDING:e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING},_4e_address:function(a,b){a=p(a);var g=[],h=a.ownerDocument.documentElement;for(a=a;a&&a!=h;){var k=a.parentNode,
j=-1;if(k){for(var c=0;c<k.childNodes.length;c++){var d=k.childNodes[c];if(!(b&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){j++;if(d==a)break}}g.unshift(j)}a=k}return g},_4e_breakParent:function(a,b){var g=new w.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(b);b=g.extractContents();g.insertNode(a._4e_remove());a[0].parentNode.insertBefore(b,a[0].nextSibling)},_4e_style:function(a,b,g){if(g!==undefined)return a.css(b,g);a=a[0]||a;return a.style[t(b)]},_4e_remove:function(a,
b){var g=p(a),h=g.parentNode;if(h){if(b)for(;b=g.firstChild;)h.insertBefore(g.removeChild(b),g);h.removeChild(g)}return a},_4e_trim:function(a){u._4e_ltrim(a);u._4e_rtrim(a)},_4e_ltrim:function(a){a=p(a);for(var b;b=a.firstChild;){if(b.nodeType==i.NODE_TEXT){var g=q.ltrim(b.nodeValue),h=b.nodeValue.length;if(g){if(g.length<h){(new B(b))._4e_splitText(h-g.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=p(a);for(var b;b=a.lastChild;){if(b.type==i.NODE_TEXT){var g=
q.rtrim(b.nodeValue),h=b.nodeValue.length;if(g){if(g.length<h){(new B(b))._4e_splitText(g.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!x.ie&&!x.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=p(a);for(var b=a.lastChild;b&&b.nodeType==i.NODE_TEXT&&!A.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==i.NODE_TEXT||u._4e_name(b)!=="br"){b=x.opera?a.ownerDocument.createTextNode(""):
a.ownerDocument.createElement("br");x.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){a=p(a);var g;do g=(a=a.previousSibling)&&new B(a);while(g&&b&&!b(g));return g},_4e_last:function(a,b){if((a=(a=a[0].lastChild)&&new B(a))&&b&&!b(a))a=a._4e_previous(b);return a},_4e_next:function(a,b){a=p(a);var g;do g=(a=a.nextSibling)&&new B(a);while(g&&b&&!b(g));return g},_4e_outerHtml:function(a){a=p(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");
b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,g,h){a[0]||(a=new B(a));var k=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",A.guid())._4e_getData("list_marker_id"),j=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");b[k]=a;j[g]=1;return a._4e_setData(g,h)},_4e_clearMarkers:function(a,b,g){a=o(a);var h=a._4e_getData("list_marker_names"),k=a._4e_getData("list_marker_id");for(var j in h)a._4e_removeData(j);
a._4e_removeData("list_marker_names");if(g){a._4e_removeData("list_marker_id");delete b[k]}},_4e_setData:function(a,b,g){var h=u._4e_getUniqueId(a);(l[h]||(l[h]={}))[b]=g;return a},_4e_getData:function(a,b){a=p(a);return(a=(a=a.getAttribute("_ke_expando"))&&l[a])&&a[b]},_4e_removeData:function(a,b){a=p(a);var g=a.getAttribute("_ke_expando");var h=(g=g&&l[g])&&g[b];typeof h!="undefined"&&g&&delete g[b];A.isEmptyObject(g)&&u._4e_clearData(a);return h||null},_4e_clearData:function(a){a=p(a);var b=a.getAttribute("_ke_expando");
b&&delete l[b];b&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=p(a);var b=a.getAttribute("_ke_expando");if(b)return b;b=A.guid();a.setAttribute("_ke_expando",b);return b},_4e_copyAttributes:function(a,b,g){a=p(a);var h=a.attributes;g=g||{};for(var k=0;k<h.length;k++){var j=h[k],c=j.nodeName.toLowerCase(),d;if(!(c in g))if(c=="checked"&&(d=u.attr(a,c)))b.attr(c,d);else if(j.specified||x.ie&&j.nodeValue&&c=="value"){d=u.attr(a,c);if(d===null)d=j.nodeValue;b.attr(c,d)}}if(a.style.cssText!==
"")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=u._4e_name(a);var b=w.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=o(a);var b=a[0].ownerDocument,g=u.scrollLeft(b),h=u.scrollTop(b),k=a.offset(),j=k.left;k=k.top;if(u.viewportHeight(b)+h<k||k<h||u.viewportWidth(b)+g<j||j<g)a.scrollIntoView(b)},_4e_getElementsByTagName:function(a,b,g){a=p(a);if(!x.ie&&g)b=g+":"+b;g=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)g.push(new B(a[b]));
return g}};A.DOM._4e_inject=function(a){A.mix(u,a);for(var b in a)a.hasOwnProperty(b)&&function(g){B.prototype[g]=function(){var h=[].slice.call(arguments,0);h.unshift(this);return a[g].apply(null,h)}}(b)};A.DOM._4e_inject(r)});
KISSY.Editor.add("elementpath",function(w){function t(l){var f=null,m=null,p=[];for(l=l;l&&l[0];){if(l[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=l;var o=l._4e_name();if(q.ie&&l[0].scopeName!="HTML")o=l[0].scopeName.toLowerCase()+":"+o;if(!m){if(!f&&s[o])f=l;if(i[o])if(!f&&o=="div"&&!e(l))f=l;else m=l}p.push(l);if(o=="body")break}l=l.parent()}this.block=f;this.blockLimit=m;this.elements=p}var A=KISSY,u=A.DOM,x=w.XHTML_DTD,B=w.NODE,q=A.UA,s={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},e=function(l){l=l[0]||l;l=l.childNodes;for(var f=0,m=l.length;f<m;f++){var p=l[f];if(p.nodeType==B.NODE_ELEMENT&&x.$block[p.nodeName.toLowerCase()])return true}return false};t.prototype={compare:function(l){var f=this.elements;l=l&&l.elements;if(!l||f.length!=l.length)return false;for(var m=0;m<f.length;m++)if(!u._4e_equals(f[m],l[m]))return false;return true},contains:function(l){for(var f=
this.elements,m=0;m<f.length;m++)if(f[m]._4e_name()in l)return f[m];return null}};w.ElementPath=t});
KISSY.Editor.add("walker",function(w){function t(i,e){if(this._.end)return null;var l=this.range,f,m=this.guard,p=this.type,o=i?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;l.trim();if(l.collapsed){this.end();return null}}if(!i&&!this._.guardLTR){var r=l.endContainer,a=new s(r[0].childNodes[l.endOffset]);this._.guardLTR=function(k,j){return(!j||!q._4e_equals(r,k))&&(!a[0]||k[0]!==a[0])&&(k[0].nodeType!=B.NODE_ELEMENT||!j||k._4e_name()!="body")}}if(i&&!this._.guardRTL){var b=
l.startContainer,g=l.startOffset>0&&new s(b[0].childNodes[l.startOffset-1]);this._.guardRTL=function(k,j){return k&&k[0]&&(!j||b[0]!==k[0])&&(!g[0]||k[0]!==g[0])&&(k[0].nodeType!=B.NODE_ELEMENT||!j||k._4e_name()!="body")}}var h=i?this._.guardRTL:this._.guardLTR;f=m?function(k,j){if(h(k,j)===false)return false;return m(k,j)}:h;if(this.current)i=this.current[o](false,p,f);else if(i){i=l.endContainer;if(l.endOffset>0){i=new s(i[0].childNodes[l.endOffset-1]);if(f(i)===false)i=null}else i=f(i,true)===
false?null:i._4e_previousSourceNode(true,p,f)}else{i=l.startContainer;if((i=new s(i[0].childNodes[l.startOffset]))&&i[0]){if(f(i)===false)i=null}else i=f(l.startContainer,true)===false?null:l.startContainer._4e_nextSourceNode(true,p,f)}for(;i&&i[0]&&!this._.end;){this.current=i;if(!this.evaluator||this.evaluator(i)!==false){if(!e)return i}else if(e&&this.evaluator)return false;i=i[o](false,p,f)}this.end();return this.current=null}function A(i){for(var e,l=null;e=t.call(this,i);)l=e;return l}function u(i){this.range=
i;this._={}}var x=KISSY,B=w.NODE,q=x.DOM,s=x.Node;x.augment(u,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,true)},checkForward:function(){return t.call(this,false,true)!==false},checkBackward:function(){return t.call(this,true,true)!==false},lastForward:function(){return A.call(this)},lastBackward:function(){return A.call(this,true)},reset:function(){delete this.current;this._={}}});u.blockBoundary=function(i){return function(e){e[0]||(e=
new s(e));return!(e[0].nodeType==B.NODE_ELEMENT&&e._4e_isBlockBoundary(i))}};u.listItemBoundary=function(){return this.blockBoundary({br:1})};u.bookmark=function(i,e){function l(f){return f&&f[0]&&f._4e_name()=="span"&&f.attr("_ke_bookmark")}return function(f){var m,p;m=f&&f[0]&&f[0].nodeType==B.NODE_TEXT&&(p=f.parent())&&l(p);m=i?m:m||l(f);return e^m}};u.whitespaces=function(i){return function(e){e=(e=e[0]||e)&&e.nodeType==B.NODE_TEXT&&!x.trim(e.nodeValue);return i^e}};u.invisible=function(i){var e=
u.whitespaces();return function(l){l=e(l)||l[0].nodeType==B.NODE_ELEMENT&&!l[0].offsetHeight;return i^l}};w.Walker=u});
KISSY.Editor.add("range",function(w){function t(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=c}function A(c){var d=c[0].nodeType!=i.NODE_TEXT&&c._4e_name()in r.$removeEmpty,n=!s.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return d||n||c}function u(c){return!k(c)&&!j(c)}function x(c){var d=false,n=f.bookmark(true);return function(y){if(n(y))return true;if(y[0].nodeType==i.NODE_TEXT){if(s.trim(y[0].nodeValue).length)return false}else if(y[0].nodeType==
i.NODE_ELEMENT)if(!h[y._4e_name()])if(!c&&!o.ie&&y._4e_name()=="br"&&!d)d=true;else return false;return true}}function B(c,d){function n(y){return y&&y.nodeName=="span"&&y.getAttribute("_ke_bookmark")}return function(y){var v,D;v=y&&!y.nodeName&&(D=y.parentNode)&&n(D);v=c?v:v||n(y);return d^v}}function q(c){return function(d){d=(d=d[0]||d)&&d.nodeType==i.NODE_TEXT&&!s.trim(d.nodeValue);return c^d}}w.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var s=KISSY,i=w.NODE,e=w.RANGE,l=w.POSITION,f=w.Walker,m=s.DOM,p=w.Utils.getByAddress,o=s.UA,r=w.XHTML_DTD,a=w.ElementPath,b=s.Node,g={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};t.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return c.join("<br/>")};s.augment(t,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&m._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,d=this.startOffset;if(c[0].nodeType!=i.NODE_ELEMENT)if(d)d>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;d=this.endOffset;if(c[0].nodeType!=i.NODE_ELEMENT)if(d)d>=c[0].nodeValue.length&&
this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,d=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,e.POSITION_BEFORE_START);d&&d._4e_name()=="span"&&
d.attr("_ke_bookmark")&&this.setEndAt(d,e.POSITION_AFTER_END)},setStart:function(c,d){if(c[0].nodeType==i.NODE_ELEMENT&&g[c._4e_name()]){c=c.parent();d=c._4e_index()}this.startContainer=c;this.startOffset=d;if(!this.endContainer){this.endContainer=c;this.endOffset=d}this.updateCollapsed()},setEnd:function(c,d){if(c[0].nodeType==i.NODE_ELEMENT&&g[c._4e_name()]){c=c.parent();d=c._4e_index()+1}this.endContainer=c;this.endOffset=d;if(!this.startContainer){this.startContainer=c;this.startOffset=d}this.updateCollapsed()},
setStartAt:function(c,d){switch(d){case e.POSITION_AFTER_START:this.setStart(c,0);break;case e.POSITION_BEFORE_END:c[0].nodeType==i.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setStartBefore(c);break;case e.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,d){switch(d){case e.POSITION_AFTER_START:this.setEnd(c,0);break;case e.POSITION_BEFORE_END:c[0].nodeType==i.NODE_TEXT?this.setEnd(c,
c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case e.POSITION_BEFORE_START:this.setEndBefore(c);break;case e.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,d){var n=this.startContainer,y=this.endContainer,v=this.startOffset,D=this.endOffset,H,z;this.optimizeBookmark();if(y[0].nodeType==i.NODE_TEXT)y=y._4e_splitText(D);else if(y[0].childNodes.length>0)if(D>=y[0].childNodes.length){y=new b(y[0].appendChild(this.document.createTextNode("")));
z=true}else y=new b(y[0].childNodes[D]);if(n[0].nodeType==i.NODE_TEXT){n._4e_splitText(v);if(m._4e_equals(n,y))y=new b(n[0].nextSibling)}else if(v)if(v>=n[0].childNodes.length){H=new b(this.document.createTextNode(""));n[0].appendChild(H[0]);n=H;H=true}else n=new b(n[0].childNodes[v].previousSibling);else{H=new b(this.document.createTextNode(""));m.insertBefore(H[0],n[0].firstChild);n=H;H=true}v=n._4e_parents();D=y._4e_parents();var C,I,J;for(C=0;C<v.length;C++){I=v[C];J=D[C];if(I[0]!==J[0])break}for(var N=
d,M,Q,R,W=C;W<v.length;W++){M=v[W];if(N&&M[0]!==n[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(D[W]&&M==D[W][0]||M==y[0])break;R=M.nextSibling;if(c==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);c==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=d;for(d=C;d<D.length;d++){M=D[d];if(c>0&&M[0]!==y[0])Q=N.appendChild(M._4e_clone()[0]);if(!v[d]||M[0].parentNode!==v[d][0].parentNode)for(M=M[0].previousSibling;M;){if(v[d]&&M==v[d][0]||M===n[0])break;R=M.previousSibling;if(c==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);c==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(c==2){J=this.startContainer[0];if(J.nodeType==i.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==i.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==i.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==i.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(I&&J&&(n[0].parentNode!=
I[0].parentNode||y[0].parentNode!=J[0].parentNode)){c=J._4e_index();H&&J[0].parentNode==n[0].parentNode&&c--;this.setStart(J.parent(),c)}this.collapse(true)}H&&n._4e_remove();z&&y[0].parentNode&&y._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var c=new t(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;
c.endContainer=this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=i.NODE_ELEMENT||c.endContainer[0].nodeType!=i.NODE_ELEMENT)return null;c=c.startContainer[0].childNodes[c.startOffset];for(var d=B(true,undefined),n=q(true),y=function(v){return n(v)&&d(v)};c&&y(c);)c=(new b(c))._4e_nextSourceNode()[0];return new b(c)},shrink:function(c,d){if(!this.collapsed){c=c||e.SHRINK_TEXT;
var n=this.clone(),y=this.startContainer,v=this.endContainer,D=this.startOffset,H=this.endOffset,z=1,C=1;if(y&&y[0].nodeType==i.NODE_TEXT)if(D)if(D>=y[0].nodeValue.length)n.setStartAfter(y);else{n.setStartBefore(y);z=0}else n.setStartBefore(y);if(v&&v[0].nodeType==i.NODE_TEXT)if(H)if(H>=v[0].nodeValue.length)n.setEndAfter(v);else{n.setEndAfter(v);C=0}else n.setEndBefore(v);n=new f(n);n.evaluator=function(J){J=J[0]||J;return J.nodeType==(c==e.SHRINK_ELEMENT?i.NODE_ELEMENT:i.NODE_TEXT)};var I;n.guard=
function(J,N){J=J[0]||J;if(c==e.SHRINK_ELEMENT&&J.nodeType==i.NODE_TEXT)return false;if(N&&J==I)return false;if(!N&&J.nodeType==i.NODE_ELEMENT)I=J;return true};if(z)(y=n[c==e.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(y,d?e.POSITION_AFTER_START:e.POSITION_BEFORE_START);if(C){n.reset();(n=n[c==e.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,d?e.POSITION_BEFORE_END:e.POSITION_AFTER_END)}return!!(z||C)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||
c[0].nodeType!=i.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var d=this.startContainer,n=this.endContainer,y=this.startOffset,v=this.endOffset,D,H;if(!d||!n)return{start:0,end:0};if(c){if(d[0].nodeType==i.NODE_ELEMENT)if((D=new b(d[0].childNodes[y]))&&D[0]&&D[0].nodeType==i.NODE_TEXT&&y>0&&D[0].previousSibling.nodeType==i.NODE_TEXT){d=D;y=0}for(;d[0].nodeType==i.NODE_TEXT&&(H=d._4e_previous())&&H[0].nodeType==i.NODE_TEXT;){d=H;y+=H[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==
i.NODE_ELEMENT)if((D=new b(n[0].childNodes[v]))&&D[0]&&D[0].nodeType==i.NODE_TEXT&&v>0&&D[0].previousSibling.nodeType==i.NODE_TEXT){n=D;v=0}for(;n[0].nodeType==i.NODE_TEXT&&(H=n._4e_previous())&&H[0].nodeType==i.NODE_TEXT;){n=H;v+=H[0].nodeValue.length}}}return{start:d._4e_address(c),end:this.collapsed?null:n._4e_address(c),startOffset:y,endOffset:v,normalized:c,is2:true}},createBookmark:function(c){var d,n,y,v;d=new b("<span></span>",null,this.document);d.attr("_ke_bookmark",1);d.css("display","none");
d.html("&nbsp;");if(c){y=s.guid("ke_bm_");d.attr("id",y+"S")}if(!this.collapsed){n=d._4e_clone();n.html("&nbsp;");c&&n.attr("id",y+"E");v=this.clone();v.collapse();v.insertNode(n)}v=this.clone();v.collapse(true);v.insertNode(d);if(n){this.setStartAfter(d);this.setEndBefore(n)}else this.moveToPosition(d,e.POSITION_AFTER_END);return{startNode:c?y+"S":d,endNode:c?y+"E":n,serializable:c}},moveToPosition:function(c,d){this.setStartAt(c,d);this.collapse(true)},trim:function(c,d){var n=this.startContainer,
y=this.startOffset,v=this.collapsed;if((!c||v)&&n[0]&&n[0].nodeType==i.NODE_TEXT){if(y)if(y>=n[0].nodeValue.length){y=n._4e_index()+1;n=n.parent()}else{c=n._4e_splitText(y);y=n._4e_index()+1;n=n.parent();if(m._4e_equals(this.startContainer,this.endContainer))this.setEnd(c,this.endOffset-this.startOffset);else if(m._4e_equals(n,this.endContainer))this.endOffset+=1}else{y=n._4e_index();n=n.parent()}this.setStart(n,y);if(v){this.collapse(true);return}}n=this.endContainer;y=this.endOffset;if(!(d||v)&&
n[0]&&n[0].nodeType==i.NODE_TEXT){if(y){y>=n.nodeValue.length||n._4e_splitText(y);y=n._4e_index()+1}else y=n._4e_index();n=n.parent();this.setEnd(n,y)}},insertNode:function(c){this.optimizeBookmark();this.trim(false,true);var d=this.startContainer,n=d[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);n?m.insertBefore(c[0]||c,n):d[0].appendChild(c[0]||c);m._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var d=
p(this.document,c.start,c.normalized),n=c.startOffset,y=c.end&&p(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(d,n);y?this.setEnd(y,c):this.collapse(true)}else{d=(n=c.serializable)?s.one("#"+c.startNode,this.document):c.startNode;c=n?s.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(d);d._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(c,d){var n=this.startContainer,y=this.endContainer;c=m._4e_equals(n,
y)?c&&n[0].nodeType==i.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new b(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(y);return d&&c[0].nodeType==i.NODE_TEXT?c.parent():c},enlarge:function(c){switch(c){case e.ENLARGE_ELEMENT:if(this.collapsed)return;c=this.getCommonAncestor();var d=new b(this.document.body),n,y,v,D,H,z=false,C,I;C=this.startContainer;I=this.startOffset;if(C[0].nodeType==i.NODE_TEXT){if(I){C=!s.trim(C[0].nodeValue.substring(0,I)).length&&C;z=!!C}if(C)if(!(D=C[0].previousSibling))v=
C.parent()}else{if(I)D=C[0].childNodes[I-1]||C[0].lastChild;D||(v=C)}for(;v||D;){if(v&&!D){if(!H&&m._4e_equals(v,c))H=true;if(!d._4e_contains(v))break;if(!z||v.css("display")!="inline"){z=false;if(H)n=v;else this.setStartBefore(v)}D=v[0].previousSibling}for(;D;){C=false;if(D.nodeType==i.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/[\s\ufeff]$/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(z&&r.$removeEmpty[D.nodeName.toLowerCase()]){I=m.text(D);if(/[^\s\ufeff]/.test(I))D=
null;else for(var J=D.all||D.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!r.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}if(D)C=!!I.length}else D=null;if(C)if(z)if(H)n=v;else v&&this.setStartBefore(v);else z=true;if(D){C=D.previousSibling;if(!v&&!C){v=new b(D);D=null;break}D=C}else v=null}if(v)v=v.parent()}C=this.endContainer;I=this.endOffset;v=D=null;H=z=false;if(C[0].nodeType==i.NODE_TEXT){C=!s.trim(C[0].nodeValue.substring(I)).length&&C;z=!(C&&C[0].nodeValue.length);if(C)if(!(D=C[0].nextSibling))v=
C.parent()}else(D=C[0].childNodes[I])||(v=C);for(;v||D;){if(v&&!D){if(!H&&m._4e_equals(v,c))H=true;if(!d._4e_contains(v))break;if(!z||v.css("display")!="inline"){z=false;if(H)y=v;else v&&this.setEndAfter(v)}D=v[0].nextSibling}for(;D;){C=false;if(D.nodeType==i.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/^[\s\ufeff]/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(z&&r.$removeEmpty[D.nodeName.toLowerCase()]){I=m.text(D);if(/[^\s\ufeff]/.test(I))D=null;else{J=D.all||
D.getElementsByTagName("*");for(N=0;M=J[N++];)if(!r.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}}if(D)C=!!I.length}else D=null;if(C)if(z)if(H)y=v;else this.setEndAfter(v);if(D){C=D.nextSibling;if(!v&&!C){v=new b(D);D=null;break}D=C}else v=null}if(v)v=v.parent()}if(n&&y){c=n._4e_contains(y)?y:n;this.setStartBefore(c);this.setEndAfter(c)}break;case e.ENLARGE_BLOCK_CONTENTS:case e.ENLARGE_LIST_ITEM_CONTENTS:v=new t(this.document);d=new b(this.document.body);v.setStartAt(d,e.POSITION_AFTER_START);
v.setEnd(this.startContainer,this.startOffset);v=new f(v);var Q,R,W=f.blockBoundary(c==e.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};n=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};v.guard=$;v=v.lastBackward();Q=Q||d;this.setStartAt(Q,Q._4e_name()!="br"&&(!v&&this.checkStartOfBlock()||v&&Q._4e_contains(v))?e.POSITION_AFTER_START:e.POSITION_AFTER_END);v=this.clone();v.collapse();v.setEndAt(d,e.POSITION_BEFORE_END);v=new f(v);v.guard=
c==e.ENLARGE_LIST_ITEM_CONTENTS?n:$;Q=null;v=v.lastForward();Q=Q||d;this.setEndAt(Q,!v&&this.checkEndOfBlock()||v&&Q._4e_contains(v)?e.POSITION_BEFORE_END:e.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var c=this.startContainer,d=this.startOffset;if(d&&c[0].nodeType==i.NODE_TEXT)if(s.trim(c[0].nodeValue.substring(0,d)).length)return false;this.trim();c=new a(this.startContainer);d=this.clone();d.collapse(true);d.setStartAt(c.block||c.blockLimit,e.POSITION_AFTER_START);
c=new f(d);c.evaluator=x(true);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,d=this.endOffset;if(c[0].nodeType==i.NODE_TEXT)if(s.trim(c[0].nodeValue.substring(d)).length)return false;this.trim();c=new a(this.endContainer);d=this.clone();d.collapse(false);d.setEndAt(c.block||c.blockLimit,e.POSITION_BEFORE_END);c=new f(d);c.evaluator=x(false);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,d){var n=this.clone();n[d==e.START?"setStartAt":"setEndAt"](c,d==e.START?e.POSITION_AFTER_START:e.POSITION_BEFORE_END);c=new f(n);c.evaluator=A;return c[d==e.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,d=this.endContainer,n=this.startOffset,y=this.endOffset,v;if(c[0].nodeType==i.NODE_ELEMENT){v=c[0].childNodes.length;if(v>
n)c=new b(c[0].childNodes[n]);else if(v<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new b(c);c=c._4e_nextSourceNode()||c}}if(d[0].nodeType==i.NODE_ELEMENT){v=d[0].childNodes.length;if(v>y)d=(new b(d[0].childNodes[y]))._4e_previousSourceNode(true);else if(v<1)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=new b(d)}}if(c._4e_position(d)&l.POSITION_FOLLOWING)c=d;return{startNode:c,endNode:d}},fixBlock:function(c,d){var n=this.createBookmark();
d=new b(this.document.createElement(d));this.collapse(c);this.enlarge(e.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();o.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(n);return d},splitBlock:function(c){var d=new a(this.startContainer),n=new a(this.endContainer),y=d.block,v=n.block,D=null;if(d.blockLimit[0]!==n.blockLimit[0])return null;if(c!="br"){if(!y){y=this.fixBlock(true,c);v=(new a(this.endContainer)).block}v||(v=this.fixBlock(false,c))}c=y&&this.checkStartOfBlock();
d=v&&this.checkEndOfBlock();this.deleteContents();if(y&&m._4e_equals(y,v))if(d){D=new a(this.startContainer);this.moveToPosition(v,e.POSITION_AFTER_END);v=null}else if(c){D=new a(this.startContainer);this.moveToPosition(y,e.POSITION_BEFORE_START);y=null}else{v=this.splitElement(y);!o.ie&&!s.inArray(y._4e_name(),["ul","ol"])&&y._4e_appendBogus()}return{previousBlock:y,nextBlock:v,wasStartOfBlock:c,wasEndOfBlock:d,elementPath:D}},splitElement:function(c){if(!this.collapsed)return null;this.setEndAt(c,
e.POSITION_BEFORE_END);var d=this.extractContents(),n=c._4e_clone(false);n[0].appendChild(d);n.insertAfter(c);this.moveToPosition(c,e.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(c,d){var n,y=w.XHTML_DTD;if(y.$empty[c._4e_name()])return false;for(;c&&c[0].nodeType==i.NODE_ELEMENT;){if(n=c._4e_isEditable())this.moveToPosition(c,d?e.POSITION_BEFORE_END:e.POSITION_AFTER_START);else if(y.$inline[c._4e_name()]){this.moveToPosition(c,d?e.POSITION_AFTER_END:e.POSITION_BEFORE_START);
return true}if((c=y.$empty[c._4e_name()]?c[d?"_4e_previous":"_4e_next"](u):c[d?"_4e_last":"_4e_first"](u))&&c[0].nodeType==i.NODE_TEXT){this.moveToPosition(c,d?e.POSITION_AFTER_END:e.POSITION_BEFORE_START);return true}}return n},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==i.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var h={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},k=new f.whitespaces,j=new f.bookmark;w.Range=t});
KISSY.Editor.add("domiterator",function(w){function t(p){if(!(arguments.length<1)){this.range=p;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var A=KISSY,u=A.UA,x=w.Walker,B=w.Range,q=w.RANGE,s=w.NODE,i=w.ElementPath,e=A.Node,l=A.DOM,f=/^[\r\n\t ]*$/,m=x.bookmark();A.augment(t,{getNextParagraph:function(p){var o,r,a,b,g;if(!this._.lastNode){r=this.range.clone();r.enlarge(this.forceBrBreak||!this.enlargeBr?q.ENLARGE_LIST_ITEM_CONTENTS:q.ENLARGE_BLOCK_CONTENTS);
var h=new x(r),k=x.bookmark(true,true);h.evaluator=k;this._.nextNode=h.next();h=new x(r);h.evaluator=k;h=h.previous();this._.lastNode=h._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==s.NODE_TEXT&&!A.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){k=new B(r.document);k.moveToPosition(this._.lastNode,q.POSITION_AFTER_END);if(k.checkEndOfBlock()){k=new i(k.endContainer);this._.lastNode=(k.block||k.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new e(r.document.createTextNode(""));l.insertAfter(this._.lastNode[0],h[0])}r=null}k=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;k;){var j=false,c=k[0].nodeType!=s.NODE_ELEMENT,d=false;if(c){if(k[0].nodeType==s.NODE_TEXT)if(f.test(k[0].nodeValue))c=false}else{var n=k._4e_name();if(k._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(n=="br")c=true;else if(!r&&!k[0].childNodes.length&&n!="hr"){o=k;a=k._4e_equals(h);break}if(r){r.setEndAt(k,q.POSITION_BEFORE_START);
if(n!="br")this._.nextNode=k}j=true}else{if(k[0].firstChild){if(!r){r=new B(this.range.document);r.setStartAt(k,q.POSITION_BEFORE_START)}k=new e(k[0].firstChild);continue}c=true}}if(c&&!r){r=new B(this.range.document);r.setStartAt(k,q.POSITION_BEFORE_START)}a=(!j||c)&&k._4e_equals(h);if(r&&!j)for(;!k[0].nextSibling&&!a;){n=k.parent();if(n._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){j=true;a||n._4e_equals(h);break}k=n;c=true;a=k._4e_equals(h);d=true}c&&r.setEndAt(k,q.POSITION_AFTER_END);k=k._4e_nextSourceNode(d,
null,h);a=!k;if((j||a)&&r){c=r.getBoundaryNodes();j=new i(r.startContainer);if(c.startNode.parent()._4e_equals(j.blockLimit)&&m(c.startNode)&&m(c.endNode)){r=null;this._.nextNode=null}else break}if(a)break}if(!o){if(!r){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}j=new i(r.startContainer);k=j.blockLimit;c={div:1,th:1,td:1};o=j.block;if((!o||!o[0])&&!this.enforceRealBlocks&&c[k._4e_name()]&&r.checkStartOfBlock()&&r.checkEndOfBlock())o=k;else if(!o||this.enforceRealBlocks&&
o._4e_name()=="li"){o=new e(this.range.document.createElement(p||"p"));o[0].appendChild(r.extractContents());o._4e_trim();r.insertNode(o);b=g=true}else if(o._4e_name()!="li"){if(!r.checkStartOfBlock()||!r.checkEndOfBlock()){o=o._4e_clone(false);o[0].appendChild(r.extractContents());o._4e_trim();g=r.splitBlock();b=!g.wasStartOfBlock;g=!g.wasEndOfBlock;r.insertNode(o)}}else if(!a)this._.nextNode=o._4e_equals(h)?null:r.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,h)}if(b){r=new e(o[0].previousSibling);
if(r[0]&&r[0].nodeType==s.NODE_ELEMENT)if(r._4e_name()=="br")r._4e_remove();else r[0].lastChild&&r[0].lastChild.nodeName.toLowerCase()=="br"&&l._4e_remove(r[0].lastChild)}if(g){r=x.bookmark(false,true);b=new e(o[0].lastChild);if(b[0]&&b[0].nodeType==s.NODE_ELEMENT&&b._4e_name()=="br")if(u.ie||b._4e_previous(r)||b._4e_next(r))b._4e_remove()}if(!this._.nextNode)this._.nextNode=a||o._4e_equals(h)?null:o._4e_nextSourceNode(true,null,h);return o}});B.prototype.createIterator=function(){return new t(this)}});
KISSY.Editor.add("selection",function(w){function t(h){this.document=h;this._={cache:{}};if(B.ie){var k=this.getNative().createRange();if(!k||k.item&&k.item(0).ownerDocument!=h||k.parentElement&&k.parentElement().ownerDocument!=h)this.isInvalid=true}}function A(h){h=new t(h);return!h||h.isInvalid?null:h}function u(h){var k=h.document,j=new e(k.body),c=new e(k.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)c.on("click",function(D){q._4e_name(D.target)==="html"&&h.getSelection().getRanges()[0].select()});
var d,n;j.on("focusin",function(D){if(D.target.nodeName.toUpperCase()=="BODY")if(d){try{d.select()}catch(H){}d=null}});j.on("focus",function(){n=true;v()});j.on("beforedeactivate",function(D){D.relatedTarget||(n=false)});B.ie<8&&s.on(q._4e_getWin(k),"blur",function(){k.selection.empty()});j.on("mousedown",y);j.on("mouseup",function(){n=true;setTimeout(function(){v(true)},0)});j.on("keydown",y);j.on("keyup",function(){n=true;v()});s.on(k,"selectionchange",v);var y=function(){n=false},v=function(D){if(n){var H=
h.document,z=h.getSelection(),C=z&&z.getNative();if(D&&C&&C.type=="None")if(!H.queryCommandEnabled("InsertImage")){setTimeout(function(){v(true)},50);return}var I;if(!(C&&C.type=="Text"&&(I=C.createRange().parentElement().nodeName.toLowerCase())&&I in{input:1,textarea:1})){d=C&&z.getRanges()[0];h._monitor()}}}}else{s.on(k,"mouseup",h._monitor,h);s.on(k,"keyup",h._monitor,h)}}w.SELECTION={};var x=KISSY,B=x.UA,q=x.DOM,s=x.Event,i=w.Utils.tryThese,e=x.Node,l=w.SELECTION,f=w.RANGE,m=w.NODE,p=w.Walker,
o=w.Range;l.SELECTION_NONE=1;l.SELECTION_TEXT=2;l.SELECTION_ELEMENT=3;var r={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};x.augment(t,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=q._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var h=this._.cache;if(h.type)return h.type;
var k=l.SELECTION_NONE;try{var j=this.getNative(),c=j.type;if(c=="Text")k=l.SELECTION_TEXT;if(c=="Control")k=l.SELECTION_ELEMENT;if(j.createRange().parentElement)k=l.SELECTION_TEXT}catch(d){}return h.type=k}:function(){var h=this._.cache;if(h.type)return h.type;var k=l.SELECTION_TEXT,j=this.getNative();if(j){if(j.rangeCount==1){j=j.getRangeAt(0);var c=j.startContainer;if(c==j.endContainer&&c.nodeType==m.NODE_ELEMENT&&j.endOffset-j.startOffset===1&&r[c.childNodes[j.startOffset].nodeName.toLowerCase()])k=
l.SELECTION_ELEMENT}}else k=l.SELECTION_NONE;return h.type=k},getRanges:B.ie?function(){var h=function(k,j){k=k.duplicate();k.collapse(j);j=k.parentElement();for(var c=j.childNodes,d,n=0;n<c.length;n++){var y=c[n];if(y.nodeType==m.NODE_ELEMENT){d=k.duplicate();d.moveToElementText(y);y=d.compareEndPoints("StartToStart",k);var v=d.compareEndPoints("EndToStart",k);d.collapse();if(y>0)break;else if(!y||v==1&&y==-1)return{container:j,offset:n};else if(!v)return{container:j,offset:n+1};d=null}}if(!d){d=
k.duplicate();d.moveToElementText(j);d.collapse(false)}d.setEndPoint("StartToStart",k);k=d.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;k>0;)k-=c[--n].nodeValue.length}catch(D){k=0}return k===0?{container:j,offset:n}:{container:c[n],offset:-k}};return function(){var k=this._.cache;if(k.ranges)return k.ranges;var j=this.getNative(),c=j&&j.createRange(),d=this.getType();if(!j)return[];if(d==l.SELECTION_TEXT){j=new o(this.document);d=h(c,true);j.setStart(new e(d.container),d.offset);d=h(c);j.setEnd(new e(d.container),
d.offset);return k.ranges=[j]}else if(d==l.SELECTION_ELEMENT){k=this._.cache.ranges=[];for(d=0;d<c.length;d++){var n=c.item(d),y=n.parentNode,v=0;for(j=new o(this.document);v<y.childNodes.length&&y.childNodes[v]!=n;v++);j.setStart(new e(y),v);j.setEnd(new e(y),v+1);k.push(j)}return k}return k.ranges=[]}}():function(){var h=this._.cache;if(h.ranges)return h.ranges;var k=[],j=this.getNative();if(!j)return[];for(var c=0;c<j.rangeCount;c++){var d=j.getRangeAt(c),n=new o(this.document);n.setStart(new e(d.startContainer),
d.startOffset);n.setEnd(new e(d.endContainer),d.endOffset);k.push(n)}return h.ranges=k},getStartElement:function(){var h=this._.cache;if(h.startElement!==undefined)return h.startElement;var k,j=this.getNative();switch(this.getType()){case l.SELECTION_ELEMENT:return this.getSelectedElement();case l.SELECTION_TEXT:var c=this.getRanges()[0];if(c)if(!c.collapsed){for(c.optimize();;){k=c.startContainer;if(c.startOffset==(k[0].nodeType===m.NODE_ELEMENT?k[0].childNodes.length:k[0].nodeValue.length)&&!k._4e_isBlockBoundary())c.setStartAfter(k);
else break}k=c.startContainer;if(k[0].nodeType!=m.NODE_ELEMENT)return k.parent();k=new e(k[0].childNodes[c.startOffset]);if(!k[0]||k[0].nodeType!=m.NODE_ELEMENT)return c.startContainer;for(c=k[0].firstChild;c&&c.nodeType==m.NODE_ELEMENT;){k=new e(c);c=c.firstChild}return k}if(B.ie){c=j.createRange();c.collapse(true);k=c.parentElement()}else if((k=j.anchorNode)&&k.nodeType!=m.NODE_ELEMENT)k=k.parentNode}return h.startElement=k?new e(k):null},getSelectedElement:function(){var h=this._.cache;if(h.selectedElement!==
undefined)return h.selectedElement;var k=this,j=i(function(){return k.getNative().createRange().item(0)},function(){for(var c=k.getRanges()[0],d,n,y=2;y&&!((d=c.getEnclosedNode())&&d[0].nodeType==m.NODE_ELEMENT&&r[d._4e_name()]&&(n=d));y--)c.shrink(f.SHRINK_ELEMENT);return n[0]});return h.selectedElement=j?new e(j):null},reset:function(){this._.cache={}},selectElement:function(h){var k;if(B.ie)try{k=this.document.body.createControlRange();k.addElement(h[0]);k.select()}catch(j){k=this.document.body.createTextRange();
k.moveToElementText(h[0]);k.select()}finally{}else{k=this.document.createRange();k.selectNode(h[0]);h=this.getNative();h.removeAllRanges();h.addRange(k)}this.reset()},selectRanges:function(h){if(B.ie)h[0]&&h[0].select();else{var k=this.getNative();if(!k)return;k.removeAllRanges();for(var j=0;j<h.length;j++){var c=h[j],d=this.document.createRange(),n=c.startContainer;c.collapsed&&B.gecko&&B.gecko<1.09&&n[0].nodeType==m.NODE_ELEMENT&&!n[0].childNodes.length&&n[0].appendChild(this.document.createTextNode(""));
d.setStart(n[0],c.startOffset);d.setEnd(c.endContainer[0],c.endOffset);k.addRange(d)}}this.reset()},createBookmarks2:function(h){for(var k=[],j=this.getRanges(),c=0;c<j.length;c++)k.push(j[c].createBookmark2(h));return k},createBookmarks:function(h){for(var k=[],j=this.getRanges(),c=j.length,d=this.document,n,y=0;y<c;y++){k.push(n=j[y].createBookmark(h,true));var v=(h=n.serializable)?x.one("#"+n.startNode,d):n.startNode;n=h?x.one("#"+n.endNode,d):n.endNode;for(var D=y+1;D<c;D++){var H=j[D],z=H.startContainer,
C=H.endContainer;q._4e_equals(z,v.parent())&&H.startOffset++;q._4e_equals(z,n.parent())&&H.startOffset++;q._4e_equals(C,v.parent())&&H.endOffset++;q._4e_equals(C,n.parent())&&H.endOffset++}}return k},selectBookmarks:function(h){for(var k=[],j=0;j<h.length;j++){var c=new o(this.document);c.moveToBookmark(h[j]);k.push(c)}this.selectRanges(k);return this},getCommonAncestor:function(){var h=this.getRanges();return h[0].startContainer._4e_commonAncestor(h[h.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
w.Selection=t;var a={table:1,tbody:1,tr:1},b=p.whitespaces(true),g=/\ufeff|\u00a0/;o.prototype.select=B.ie?function(h){var k=this.collapsed,j,c;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var d=this.startContainer[0].childNodes[this.startOffset];if(d.nodeType==m.NODE_ELEMENT){(new t(this.document)).selectElement(new e(d));return}}if(this.startContainer[0].nodeType==m.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==m.NODE_ELEMENT&&
this.endContainer._4e_name()in a)this.shrink(m.NODE_ELEMENT,true);var n=this.createBookmark();d=n.startNode;var y;if(!k)y=n.endNode;n=this.document.body.createTextRange();n.moveToElementText(d[0]);n.moveStart("character",1);if(y){h=this.document.body.createTextRange();h.moveToElementText(y[0]);n.setEndPoint("EndToEnd",h);n.moveEnd("character",-1)}else{for(j=d[0].nextSibling;j&&!b(j);)j=j.nextSibling;j=!(j&&j.nodeValue&&j.nodeValue.match(g))&&(h||!d[0].previousSibling||d[0].previousSibling&&q._4e_name(d[0].previousSibling)==
"br");c=this.document.createElement("span");c.innerHTML="&#65279;";c=new e(c);q.insertBefore(c[0],d[0]);j&&q.insertBefore(this.document.createTextNode("\ufeff"),d[0])}this.setStartBefore(d);d._4e_remove();if(k){if(j){n.moveStart("character",-1);n.select();this.document.selection.clear()}else n.select();if(c){this.moveToPosition(c,f.POSITION_BEFORE_START);c._4e_remove()}}else{this.setEndBefore(y);y._4e_remove();n.select()}}:function(){var h=this.startContainer;this.collapsed&&h[0].nodeType==m.NODE_ELEMENT&&
!h[0].childNodes.length&&h[0].appendChild(this.document.createTextNode(""));var k=this.document.createRange();k.setStart(h[0],this.startOffset);try{k.setEnd(this.endContainer[0],this.endOffset)}catch(j){if(j.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);k.setEnd(this.endContainer[0],this.endOffset)}else throw j;}h=A(this.document).getNative();h.removeAllRanges();h.addRange(k)};w.on("instanceCreated",function(h){u(h.editor)})});
KISSY.Editor.add("styles",function(w){function t(E,F){for(var G in E)E[G]=E[G].replace(aa,function(L,K){return F[K]})}function A(E,F){if(F){E=y.clone(E);t(E.attributes,F);t(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?D.STYLE_BLOCK:W[F]?D.STYLE_OBJECT:D.STYLE_INLINE;this._={definition:E}}function u(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new z(E);for(var G=E.getRanges(),L=0;L<G.length;L++)F.call(this,G[L]);E.selectRanges(G)}function x(E,
F){var G=E.element;if(G=="*")G="span";F=new N(F.createElement(G));return B(F,E)}function B(E,F){var G=F._.definition;F=G.attributes;G=A.getStyleText(G);if(F)for(var L in F)E.attr(L,F[L]);if(G)E[0].style.cssText=G;return E}function q(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var L,K=E.document;L=G.getNextParagraph();){var O=x(this,K);l(L,O)}E.moveToBookmark(F)}function s(E,F,G){var L="",K="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(L=P);S&&(K=S);return""});return L+E.replace(F,G)+K}function i(E,F){var G=E.html();G=s(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(G);return F}function e(E){var F=[];s(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,L,K){return L+"</pre>"+K+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,L){F.push(L)});return F}function l(E,F){var G=F._4e_name=="pre",L=E._4e_name=="pre",K=!G&&L;if(G&&!L)F=i(E,F);else if(K)F=m(e(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&f(F)}function f(E){var F;if((F=E._4e_previousSourceNode(true,C.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=s(F.html(),/\n$/,"")+"\n\n"+s(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function m(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),L=0;L<E.length;L++){var K=E[L];K=K.replace(/(\r\n|\r)/g,"\n");K=s(K,/^[ \t]*\n/,"");K=s(K,/\n$/,"");K=s(K,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});K=K.replace(/\n/g,"<br>");K=K.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(K);G.appendChild(O[0])}return G}
function p(E){var F=E.document;if(E.collapsed){F=x(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,L=this._.definition,K,O=w.XHTML_DTD[G]||(K=true,w.XHTML_DTD.span),P=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(v._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==C.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((w.XHTML_DTD[ca._4e_name()]||w.XHTML_DTD.span)[G]||K)&&(!L.parentRule||L.parentRule(ca))){if(!X&&(!ba||!w.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+
I.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==C.NODE_TEXT||V==C.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|I.POSITION_FOLLOWING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_FOLLOWING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=x(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==G){for(var Z in L.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in L.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());c(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(H.SHRINK_TEXT)}}function o(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var L=new Q(G.parent()),K,O=0,P;O<L.elements.length&&(P=L.elements[O]);O++){if(P==L.block||P==L.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,H.END),da=!S&&E.checkBoundaryOfElement(P,H.START);if(da||S){K=P;K.match=da?"start":"end"}else{P._4e_mergeSiblings();P._4e_name()==this.element?k(this,P):d(P,h(this)[P._4e_name()])}}}if(K&&K[0]){P=G;for(O=0;;O++){S=L.elements[O];if(v._4e_equals(S,K))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(P[0]);P=S}v[K.match=="start"?"insertBefore":"insertAfter"](P[0],K[0])}}else{var U=F.endNode,X=this;L=function(){for(var T=new Q(G.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
L();for(K=new N(G[0].nextSibling);K[0]!==U[0];){O=K._4e_nextSourceNode();if(K[0]&&K[0].nodeType==C.NODE_ELEMENT&&this.checkElementRemovable(K)){K._4e_name()==this.element?k(this,K):d(K,h(this)[K._4e_name()]);if(O[0].nodeType==C.NODE_ELEMENT&&O._4e_contains(G)){L();O=new N(G[0].nextSibling)}}K=O}}E.moveToBookmark(F)}function r(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,L,K){F[L]=K});return F}function a(E,F){typeof E=="string"&&(E=r(E));typeof F==
"string"&&(F=r(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function b(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function g(E){var F=E._AC;if(F)return F;F={};var G=0,L=E.attributes;if(L)for(var K in L){G++;F[K]=L[K]}if(L=A.getStyleText(E)){F.style||G++;F.style=L}F._length=G;return E._AC=
F}function h(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){y.isArray(G)||(G=[G]);for(var L=0;L<G.length;L++){var K=G[L],O,P;if(typeof K=="string")O=K.toLowerCase();else{O=K.element?K.element.toLowerCase():E.element;P=K.attributes}K=F[O]||(F[O]={});if(P){K=K.attributes=K.attributes||[];for(var S in P)K.push([S.toLowerCase(),P[S]])}}}return F}function k(E,F){var G=E._.definition,L=y.mix(y.mix({},G.attributes),h(E)[F._4e_name()]);G=G.styles;var K=y.isEmptyObject(L)&&
y.isEmptyObject(G);for(var O in L)if(!((O=="class"||E._.definition.fullMatch)&&F.attr(O)!=j(O,L[O]))){K=K||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in G)if(!(E._.definition.fullMatch&&F._4e_style(P)!=j(P,G[P],true))){K=K||!!F._4e_style(P);F._4e_style(P,"")}K&&n(F)}function j(E,F,G){var L=new N("<span></span>");L[G?"_4e_style":"attr"](E,F);return L[G?"_4e_style":"attr"](E)}function c(E,F){for(var G=h(E),L=F.all(E.element),K=L.length;--K>=0;)k(E,new N(L[K]));for(var O in G)if(O!=E.element){L=
F.all(O);for(K=L.length-1;K>=0;K--){var P=new N(L[K]);d(P,G[O])}}}function d(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var L=F[G][0],K;if(K=E.attr(L)){var O=F[G][1];if(O===null||O.test&&O.test(K)||typeof O=="string"&&K==O)E[0].removeAttribute(L)}}n(E)}function n(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==C.NODE_ELEMENT&&v._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==C.NODE_ELEMENT&&v._4e_mergeSiblings(G)}}}var y=KISSY,v=y.DOM,
D=w.STYLE={},H=w.RANGE,z=w.Selection,C=w.NODE,I=w.POSITION,J=w.Range,N=y.Node,M=y.UA,Q=w.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;D.STYLE_BLOCK=1;D.STYLE_INLINE=2;D.STYLE_OBJECT=3;A.prototype={apply:function(E){u.call(this,E,false)},remove:function(E){u.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==D.STYLE_INLINE?
p:this.type==D.STYLE_BLOCK?q:this.type==D.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==D.STYLE_INLINE?o:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=g(G);if(G._length){for(var L in G)if(L!="_length"){var K=E.attr(L)||"";if(L=="style"?a(G[L],b(K,false)):G[L]==K){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
h(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){L=G[F][0];if(L=E.attr(L)){K=G[F][1];if(K===null||typeof K=="string"&&L==K||K.test&&K.test(L))return true}}}return false},checkActive:function(E){switch(this.type){case D.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case D.STYLE_OBJECT:case D.STYLE_INLINE:for(var F=E.elements,G=0,L;G<F.length;G++){L=F[G];if(!(this.type==D.STYLE_INLINE&&(v._4e_equals(L,E.block)||v._4e_equals(L,E.blockLimit))))if(!(this.type==
D.STYLE_OBJECT&&!(L._4e_name()in W)))if(this.checkElementRemovable(L,true))return true}}return false}};A.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",L="";if(G.length)G=G.replace($,";");for(var K in F){var O=F[K],P=(K+":"+O).replace($,";");if(O=="inherit")L+=P;else G+=P}if(G.length)G=b(G);G+=L;return E._ST=G};w.Style=A});
KISSY.Editor.add("bubbleview",function(){function w(s){w.superclass.constructor.apply(this,arguments);s.init&&s.init.call(this)}function t(s){s=q[s];if(!s.bubble)s.bubble=new w(s.cfg);return s.bubble}var A=KISSY.Editor,u=KISSY,x=u.Event,B=u.Node;if(!A.BubbleView){var q={};w.attach=function(s){var i=s.pluginInstance,e=s.pluginName;s=i.editor;var l=q[e];if(l){var f=l.cfg.func,m=q[e].bubble;s.on("selectionChange",function(p){p=p.path;var o=p.elements;if(p&&o)if(p=p.lastElement)if(p=f(p)){m=t(e);m._selectedEl=
p;m._plugin=i;m.show()}else if(m){m._selectedEl=m._plugin=null;m.hide()}});x.on(s.document,"scroll",function(){m&&m.hide()});x.on(document,"click",function(){m&&m.hide()})}};w.register=function(s){q[s.pluginName]={cfg:s}};w.ATTRS={focusMgr:{value:false}};u.extend(w,A.SimpleOverlay,{_initEl:function(){var s=new B('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>');s.appendTo(document.body);this.el=s;this.set("el",s)},show:function(){var s=this._selectedEl,i=s._4e_getOffset(document);
i.top+=s.height()+5;w.superclass.show.call(this,i)}});A.BubbleView=w}});
KISSY.Editor.add("button",function(){function w(x){w.superclass.constructor.call(this,x);this._init()}var t=KISSY.Editor,A=KISSY,u=A.Node;if(!t.TripleButton){w.ON="on";w.OFF="off";w.DISABLED="disabled";w.ON_CLASS="ke-triplebutton-on";w.OFF_CLASS="ke-triplebutton-off";w.DISABLED_CLASS="ke-triplebutton-disabled";w.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};A.extend(w,A.Base,{_init:function(){var x=this.get("container")[0]||this.get("container");this.el=new u("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));x.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var x=this.get("cls");x&&this.el.addClass(x)},_stateChange:function(x){this["_"+
x.newVal]();this._attachCls()},_action:function(x){this.fire(this.get("state")+"Click",x);this.fire("click",x);x.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});t.TripleButton=w}});
KISSY.Editor.add("contextmenu",function(){function w(e){this.cfg=u.clone(e);A.Utils.lazyRun(this,"_prepareShow","_realShow")}function t(e,l){for(var f=0;f<l.length;f++){var m=l[f];if(u.isFunction(m)){if(m(new x(e)))return true}else if(B.test(e,m))return true}return false}var A=KISSY.Editor,u=KISSY,x=u.Node,B=u.DOM,q=u.Event;if(!A.ContextMenu){var s=[];w.register=function(e,l){var f=new w(l);s.push({doc:e,rules:l.rules||[],instance:f});if(!e.ke_contextmenu){e.ke_contextmenu=1;q.on(e,"mousedown",w.hide);
q.on(e,"contextmenu",function(m){w.hide.call(this);for(var p=new x(m.target);p;){var o=false;if(p._4e_name()=="body")break;for(var r=0;r<s.length;r++){var a=s[r].instance,b=s[r].rules;if(e===s[r].doc&&t(p[0],b)){m.preventDefault();o=true;setTimeout(function(){a.show(A.Utils.getXY(m.pageX,m.pageY,e,document))},30);break}}if(o)break;p=p.parent()}})}return f};w.hide=function(){for(var e=0;e<s.length;e++){var l=s[e].instance;this===s[e].doc&&l.hide()}};var i=A.SimpleOverlay;u.augment(w,{_init:function(){var e=
this,l=e.cfg,f=l.funcs;e.elDom=new x("<div class='ke-menu' onmousedown='return false;'></div>");var m=e.elDom;m.css("width",l.width);document.body.appendChild(m[0]);e.el=new i({el:m});for(var p in f){l=new x("<a href='#'>"+p+"</a>");m[0].appendChild(l[0]);(function(o,r){o._4e_unselectable();o.on("click",function(a){e.hide();a.halt();setTimeout(r,30)})})(l,f[p])}},hide:function(){this.el&&this.el.hide()},_realShow:function(e){this.el.show(e)},_prepareShow:function(){this._init()},show:function(e){this._prepareShow(e)}});
A.ContextMenu=w}});
KISSY.Editor.add("overlay",function(){function w(){var f=this;w.superclass.constructor.apply(f,arguments);f._init();if(A.UA.ie===6){f.on("show",function(){var m=f.get("el"),p=m.width(),o=m.height();l.css({width:p+"px",height:o+"px"});l.offset(m.offset())});f.on("hide",function(){l.offset({left:-999,top:-999})})}if(f.get("mask")){f.on("show",function(){i&&i.css({left:"0px",top:"0px"});e&&e.css({left:"0px",top:"0px"})});f.on("hide",function(){i&&i.css({left:"-9999px",top:"-9999px"});e&&e.css({left:"-9999px",
top:"-9999px"})})}}var t=KISSY.Editor,A=KISSY,u=A.UA,x=t.focusManager,B=A.Node,q=A.Event,s=A.DOM,i,e,l;if(!t.SimpleOverlay){w.init=function(){var f=document.body;i=new B('<div class="ke-mask">&nbsp;</div>');i.css({left:"-9999px",top:"-9999px"});i.css({width:"100%",height:s.docHeight()+"px",opacity:0.4});i.appendTo(f);if(u.ie&&u.ie==6){l=new B("<iframe class='ke-dialog-iframe'></iframe>");l.appendTo(f);e=new B("<iframe class='ke-mask'></iframe>");e.css({left:"-9999px",top:"-9999px"});e.css({width:"100%",
height:s.docHeight()+"px",opacity:0.4});e.appendTo(f)}w.init=null};w.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false}};A.extend(w,A.Base,{_init:function(){var f=this;f._initEl();var m=f.get("el");f.on("afterVisibleChange",function(p){if(p=p.newVal){typeof p=="boolean"?f.center():m.offset(p);f.fire("show")}else{m.css({left:"-9999px",top:"-9999px"});f.fire("hide")}});if(f.get("focusMgr")){f._initFocusNotice();f.on("beforeVisibleChange",f._editorFocusMg,
f)}m.css({left:"-9999px",top:"-9999px"});f.on("afterVisibleChange",function(p){p.newVal?f._register():f._unregister()})},_register:function(){q.on(document,"keydown",this._keydown,this);i.on("click",this.hide,this)},_keydown:function(f){if(f.keyCode==27){this.hide();f.halt()}},_unregister:function(){q.remove(document,"keydown",this._keydown,this);i.detach("click",this.hide,this)},_initEl:function(){var f=this,m=f.get("el");if(m)f.el=m;else{m=new B("<div class='ke-dialog' style='width:"+f.get("width")+
"'><div class='ke-hd'><span class='ke-hd-title'>"+f.get("title")+"</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>");document.body.appendChild(m[0]);f.set("el",m);f.el=m;f.body=m.one(".ke-bd");f.foot=m.one(".ke-ft");f._close=m.one(".ke-close");f._title=m.one(".ke-hd-title").one("h1");f._close.on("click",function(p){p.preventDefault();f.hide()})}},center:function(){var f=this.get("el"),m=parseInt(f.css("width")),p=
f[0].offsetHeight,o=s.viewportWidth(),r=s.viewportHeight();m=(o-m)/2+s.scrollLeft();p=(r-p)/2+s.scrollTop();if(p-s.scrollTop()>200)p-=150;f.css({left:m+"px",top:p+"px"})},_prepareShow:function(){w.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;this._focusEl=new B("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>");this._focusEl.appendTo(this.el);return this._focusEl},_initFocusNotice:function(){var f=this,
m=f._getFocusEl();m.on("focus",function(){f.fire("focus")});m.on("blur",function(){f.fire("blur")})},_editorFocusMg:function(f){var m=this._focusEditor;if(f.newVal){m=this._focusEditor=x.currentInstance();this._getFocusEl()[0].focus();var p=this.el.one("input");if(p)setTimeout(function(){try{p[0].focus();p[0].select()}catch(o){}},0);else if(u.ie&&m)if(f=m.document.selection.createRange())if(f.item&&f.item(0).ownerDocument==m.document){m=document.body.createTextRange();m.moveToElementText(this.el._4e_first()[0]);
m.collapse(true);m.select()}}else m&&m.focus()},_realShow:function(f){this.get("el");this.set("visible",f||true)},show:function(f){this._prepareShow(f)},hide:function(){this.get("el");this.set("visible",false)}});t.Utils.lazyRun(w.prototype,"_prepareShow","_realShow");t.SimpleOverlay=w}});
KISSY.Editor.add("select",function(){function w(q){w.superclass.constructor.call(this,q);this._init()}var t=KISSY,A=t.Node,u=t.Event,x=t.DOM,B=t.Editor;if(!B.Select){w.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};t.extend(w,t.Base,{_init:function(){var q=this.get("container"),s=new A("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a></span>"),i=this.get("title"),e=s.one(".ke-select-text");
s.one(".ke-select-drop");e.html(i);e.css("width",this.get("width"));s._4e_unselectable();s.attr("title",i);s.appendTo(q);s.on("click",this._click,this);this.el=s;this.title=e;this._focusA=s.one("a.ke-select");B.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(q){q=q.newVal;for(var s=this.get("title"),i=this.get("items"),e=0;e<i.length;e++){var l=i[e];if(l.value==q){s=l.name;break}}this.title.html(s)},_prepare:function(){var q=this.el,
s=this._focusA,i=new A("<div class='ke-menu' onmousedown='return false;'></div>"),e=new B.SimpleOverlay({el:i,focusMgr:false}),l=this.get("items");this.get("title")&&(new A("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+this.get("title")+"</div>")).appendTo(i);for(var f=0;f<l.length;f++){var m=l[f];m=new A("<a class='ke-select-menu-item' href='#' data-value='"+m.value+"'>"+m.name+"</a>",m.attrs);m._4e_unselectable();m.appendTo(i)}this.get("popUpWidth")&&i.css("width",
this.get("popUpWidth"));i.appendTo(document.body);this.menu=e;e.on("show",function(){s.addClass("ke-select-active")});e.on("hide",function(){s.removeClass("ke-select-active")});u.on([document,this.get("doc")],"click",function(o){q._4e_contains(o.target)||e.hide()});i.on("click",this._select,this);var p=this.as=i.all("a");u.on(i[0],"mouseenter",function(){p.removeClass("ke-menu-selected")})},_select:function(q){q.halt();var s=this.menu,i=s.el;if(q=(new A(q.target))._4e_ascendant(function(f){return i._4e_contains(f)&&
f._4e_name()=="a"},true)){var e=this.get("value"),l=q.attr("data-value");this.set("value",l);this.fire("click",{newVal:l,preVal:e,name:q.html()});s.hide()}},_real:function(){var q=this.el.offset();q.top+=this.el.height();q.left+=1;if(q.left+this.menu.el.width()>x.viewportWidth()-60)q.left=x.viewportWidth()-this.menu.el.width()-60;this.menu.show(q)},_click:function(q){q.preventDefault();var s=this.get("value");if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();s&&this.menu&&
this.as.each(function(i){i.attr("data-value")==s?i.addClass("ke-menu-selected"):i.removeClass("ke-menu-selected")})}}});B.Select=w}});
KISSY.Editor.add("clipboard",function(w){var t=KISSY.Editor,A=KISSY,u=A.Node,x=A.UA,B=t.Range,q=t.RANGE,s=A.Event;t.Paste||function(){function i(e){this.editor=e;this._init()}A.augment(i,{_init:function(){var e=this.editor;x.ie?s.on(e.document,"keydown",this._paste,this):s.on(e.document,"paste",this._paste,this)},_paste:function(e){if(!(e.type==="keydown"&&!(e.keyCode===86&&(e.ctrlKey||e.metaKey)))){var l=this.editor;e=l.document;var f=l.getSelection(),m=new B(e),p=new u(x.webkit?"<body></body>":
"<div></div>",null,e);x.webkit&&p[0].appendChild(e.createTextNode("\u00a0"));e.body.appendChild(p[0]);p.css({position:"absolute",top:f.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});p.css("left","-1000px");var o=f.createBookmarks();m.setStartAt(p,q.POSITION_AFTER_START);m.setEndAt(p,q.POSITION_BEFORE_END);m.select(true);setTimeout(function(){p._4e_remove();var r;p=x.webkit&&(r=p._4e_first())&&r[0]&&r.hasClass("Apple-style-span")?r:p;f.selectBookmarks(o);l.insertHtml(p.html())},
0)}}});t.Paste=i}();w.addPlugin(function(){new t.Paste(w)})});
KISSY.Editor.add("color",function(w){function t(k){return("0"+k).slice(k.length-1,k.length+1)}function A(k){k=x.trim(k);if(k.charAt(0)=="#")k=k.substring(1);k=k.replace(/\s+/g,"");var j="";if(/^[0-9a-f]{3,3}$/i.test(k))j=k.replace(/[0-9a-f]/ig,function(d){return d+d});else{var c=k.match(l);if(c&&c[0])for(k=1;k<4;k++)j+=t(parseInt(c[k]).toString(16));else j=k}return"#"+j.toLowerCase()}for(var u=KISSY.Editor,x=KISSY,B=x.Node,q=x.Event,s=u.SimpleOverlay,i=u.Style,e=x.DOM,l=/^rgb\((\d+),(\d+),(\d+)\)$/i,
f="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),m={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},p={element:"span",styles:{"background-color":"#(color)"}},o="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
r={},a={},b=0;b<5;b++){o+="<tr>";for(var g=0;g<8;g++){var h=A(f[8*b+g]);o+="<td>";o+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+h+"'></span></a>";o+="</td>";r[h]=new i(p,{color:h});a[h]=new i(m,{color:h})}o+="</tr>"}r.inherit=new i(p,{color:"inherit"});a.inherit=new i(m,{color:"inherit"});o+="</table></div>";u.ColorSupport||function(){function k(c){k.superclass.constructor.call(this,c);this._init()}var j=u.TripleButton;k.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};x.extend(k,x.Base,{_init:function(){var c=this.get("editor").toolBarDiv;c=new j({container:c,title:this.get("title"),contentCls:this.get("contentCls")});c.on("offClick",this._showColors,this);this.el=c;u.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(c){var d=this;e._4e_ascendant(c.target,function(n){return n[0]===d.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(c){c.halt();var d=this.get("editor");c=c.target;if(e._4e_name(c)=="span"||e._4e_name(c)=="a"){c=new B(c);
if(c._4e_name()=="a")c=c.one("span");var n=this.get("styles");d.fire("save");c._4e_style("background-color")?n[A(c._4e_style("background-color"))].apply(d.document):n.inherit.remove(d.document);d.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(o);this.colorWin=new s({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);q.on(document,"click",this._hidePanel,this);q.on(w.document,
"click",this._hidePanel,this)},_real:function(){var c=this.el.el.offset();c.top+=this.el.el.height()+5;if(c.left+this.colorPanel.width()>e.viewportWidth()-60)c.left=e.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(c)},_showColors:function(c){this._prepare(c)}});u.ColorSupport=k}();w.addPlugin(function(){new u.ColorSupport({editor:w,styles:r,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new u.ColorSupport({editor:w,styles:a,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(w){var t=KISSY.Editor,A=KISSY,u=A.Node,x=A.DOM;t.ElementPaths||function(){function B(q){this.cfg=q;this._cache=[];this._init()}A.augment(B,{_init:function(){var q=this.cfg.editor;this.holder=new u("<div>");this.holder.appendTo(q.statusDiv);q.on("selectionChange",this._selectionChange,this)},_selectionChange:function(q){var s=this.cfg.editor,i=this.holder;i=i[0]||i;q=q.path.elements;var e,l;e=this._cache;for(l=0;l<e.length;l++){e[l].detach("click");e[l]._4e_remove()}this._cache=
[];for(l=0;l<q.length;l++){e=q[l];var f=new u("<a href='#' class='elementpath'>"+(e.attr("_ke_real_element_type")||e._4e_name())+"</a>");this._cache.push(f);(function(m){f.on("click",function(p){p.halt();s.focus();setTimeout(function(){s.getSelection().selectElement(m)},50)})})(e);i.firstChild?x.insertBefore(f[0],i.firstChild):i.appendChild(f[0])}}});t.ElementPaths=B}();w.addPlugin(function(){new t.ElementPaths({editor:w})})});
KISSY.Editor.add("enterkey",function(w){var t=KISSY.Editor,A=KISSY,u=A.UA,x=/^h[1-6]$/,B=t.XHTML_DTD,q=A.Node,s=A.Event,i=t.Walker,e=t.ElementPath;t.enterBlock||function(){function l(p){p=p.getSelection().getRanges();for(var o=p.length-1;o>0;o--)p[o].deleteContents();return p[0]}function f(p){var o=l(p),r=o.document;if(o.checkStartOfBlock()&&o.checkEndOfBlock()){var a=(new e(o.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){p.execCommand("outdent");return}}var b=o.splitBlock("p");
if(b){p=b.previousBlock;a=b.nextBlock;var g=b.wasStartOfBlock,h=b.wasEndOfBlock,k;if(a){k=a.parent();if(k._4e_name()=="li"){a._4e_breakParent(k);a._4e_move(a._4e_next(),true)}}else if(p&&(k=p.parent())&&k._4e_name()=="li"){p._4e_breakParent(k);o.moveToElementEditablePosition(p._4e_next());p._4e_move(p._4e_previous())}if(!g&&!h){if(a._4e_name()=="li"&&(k=a._4e_first(i.invisible(true)))&&A.inArray(k._4e_name(),["ul","ol"]))(u.ie?new q(r.createTextNode("\u00a0")):new q(r.createElement("br"))).insertBefore(k);
a&&o.moveToElementEditablePosition(a)}else{var j;if(p){if(p._4e_name()=="li"||!x.test(p._4e_name()))j=p._4e_clone()}else if(a)j=a._4e_clone();j||(j=new q("p",null,r));if(k=b.elementPath){b=0;for(var c=k.elements.length;b<c;b++){var d=k.elements[b];if(d._4e_equals(k.block)||d._4e_equals(k.blockLimit))break;if(B.$removeEmpty[d._4e_name()]){d=d._4e_clone();j._4e_moveChildren(d);j.append(d)}}}u.ie||j._4e_appendBogus();o.insertNode(j);if(u.ie&&g&&(!h||!p[0].childNodes.length)){o.moveToElementEditablePosition(h?
p:j);o.select()}o.moveToElementEditablePosition(g&&!h?a:j)}if(!u.ie)if(a){r=new q(r.createElement("span"));r.html("&nbsp;");o.insertNode(r);r._4e_scrollIntoView();o.deleteContents()}else j._4e_scrollIntoView();o.select()}}function m(p){s.on(p.document,"keydown",function(o){if(o.keyCode===13)if(!o.shiftKey){p.execCommand("enterBlock");o.preventDefault()}})}m.enterBlock=f;t.EnterKey=m}();w.addPlugin(function(){w.addCommand("enterBlock",{exec:t.EnterKey.enterBlock});t.EnterKey(w)})});
KISSY.Editor.add("fakeobjects",function(w){var t=KISSY.Editor,A=KISSY,u=A.Node,x=t.NODE,B=t.HtmlParser,q=A.Editor,s=(w=w.htmlDataProcessor)&&w.htmlFilter,i={elements:{$:function(e){var l=e.attributes;if((l=(l=(l=l&&l._ke_realelement)&&new B.Fragment.FromHtml(decodeURIComponent(l)))&&l.children[0])&&e.attributes._ke_resizable){var f=e.attributes.style;if(f){var m=/(?:^|\s)width\s*:\s*(\d+)/i.exec(f);e=m&&m[1];f=(m=/(?:^|\s)height\s*:\s*(\d+)/i.exec(f))&&m[1];if(e)l.attributes.width=e;if(f)l.attributes.height=
f}}return l}}};s&&s.addRules(i);w&&A.mix(w,{createFakeParserElement:function(e,l,f,m,p){var o;o=new B.BasicWriter;e.writeHtml(o);o=o.getHtml();var r=e.attributes.style;if(e.attributes.width)r="width:"+e.attributes.width+"px;"+r;if(e.attributes.height)r="height:"+e.attributes.height+"px;"+r;e={"class":l,src:t.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(o),_ke_real_node_type:e.type,style:r,align:e.attributes.align||""};p&&delete p.width;p&&delete p.height;p&&A.mix(e,p,false);
if(f)e._ke_real_element_type=f;if(m)e._ke_resizable=m;return new B.Element("img",e)}});A.augment(q,{createFakeElement:function(e,l,f,m,p,o){var r=e.attr("style")||"";if(e.attr("width"))r="width:"+e.attr("width")+"px;"+r;if(e.attr("height"))r="height:"+e.attr("height")+"px;"+r;e={"class":l,src:t.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(p||e._4e_outerHtml()),_ke_real_node_type:e[0].nodeType,align:e.attr("align")||"",style:r};o&&delete o.width;o&&delete o.height;o&&A.mix(e,
o,false);if(f)e._ke_real_element_type=f;if(m)e._ke_resizable=m;return new u("<img/>",e,this.document)},restoreRealElement:function(e){if(e.attr("_ke_real_node_type")!=x.NODE_ELEMENT)return null;e=decodeURIComponent(e.attr("_ke_realelement"));var l=new u("<div>",null,this.document);l.html(e);return l._4e_first(function(f){return f[0].nodeType==x.NODE_ELEMENT})._4e_remove()}})});KISSY.Editor.add("flash",function(w){w.addPlugin(function(){new KISSY.Editor.Flash(w)})});
KISSY.Editor.add("flashsupport",function(w){var t=KISSY.Editor,A=KISSY,u=A.Event,x=t.ContextMenu,B=A.Node,q=t.BubbleView,s=t.TripleButton,i=t.SimpleOverlay,e=w.htmlDataProcessor,l="ke_flash",f=t.Utils.getFlashUrl;w=e&&e.dataFilter;t.Flash||function(){function m(a){this.editor=a;this._init()}function p(a){return a._4e_name()==="img"&&!!a.hasClass(l)&&a}var o=/\.swf(?:$|\?)/i;m.isFlashEmbed=function(a){a=a.attributes;return a.type=="application/x-shockwave-flash"||o.test(a.src||"")};A.augment(m,{_config:function(){this._cls=
l;this._type="flash";this._title="Flash\u5c5e\u6027";this._bodyHtml="<p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p><p style='margin:5px 0'><label>\u5bf9\u9f50\uff1a <select class='ke-flash-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select><p>";
this._footHtml="<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=r;this._flashRules=["img."+l]},_init:function(){this._config();var a=this.editor,b={},g=this._contextMenu;a._toolbars=a._toolbars||{};a._toolbars[this._type]=this;this.el=new s({container:a.toolBarDiv,contentCls:this._contentCls,title:this._tip});this.el.on("click",this.show,this);if(g)for(var h in g)(function(k){b[k]=
function(){g[k](a)}})(h);x.register(a.document,{rules:this._flashRules,width:"120px",funcs:b});q.attach({pluginName:this._type,pluginInstance:this});u.on(a.document,"dblclick",this._dbclick,this);t.Utils.lazyRun(this,"_prepareShow","_realShow")},_getFlashUrl:function(a){return f(a)},_updateTip:function(a,b){b=this.editor.restoreRealElement(b);a.html(this._getFlashUrl(b));a.attr("href",this._getFlashUrl(b))},_dbclick:function(a){var b=new B(a.target);if(b._4e_name()==="img"&&b.hasClass(this._cls)){this.show(null,
b);a.halt()}},_prepareShow:function(){var a=new i({title:this._title,width:this._config_dwidth||"350px",mask:true});a.body.html(this._bodyHtml);a.foot.html(this._footHtml);this.d=a;this._initD()},_realShow:function(){this._updateD();this.d.show()},_updateD:function(){var a=this.editor,b=this.selectedFlash;if(b){a=a.restoreRealElement(b);a.attr("width")&&this.dWidth.val(parseInt(a.attr("width")));a.attr("height")&&this.dHeight.val(parseInt(a.attr("height")));this.dAlign.val(a.attr("align"));this.dUrl.val(f(a))}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");
this.dWidth.val("");this.dHeight.val("");this.dAlign.val("")}},show:function(a,b){this.selectedFlash=b;this._prepareShow()},_initD:function(){var a=this,b=a.d;a.dHeight=b.el.one(".ke-flash-height");a.dWidth=b.el.one(".ke-flash-width");a.dUrl=b.el.one(".ke-flash-url");a.dAlign=b.el.one(".ke-flash-align");var g=b.el.one(".ke-flash-ok");b=b.el.one(".ke-flash-cancel");g.on("click",a._gen,a);b.on("click",function(){a.d.hide()})},_getDInfo:function(){return{url:this.dUrl.val(),attrs:{width:this.dWidth.val(),
height:this.dHeight.val(),align:this.dAlign.val()}}},_gen:function(){var a=this.editor,b=this._getDInfo(),g=b&&b.url;b=b&&b.attrs;var h=" ";if(A.trim(g)){if(b)for(var k in b)h+=k+"='"+b[k]+"' ";g="<object "+h+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+g+'" /><embed '+h+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+
g+'"  type="application/x-shockwave-flash"/></object>';k=new B(g,null,a.document);b=a.createFakeElement?a.createFakeElement(k,this._cls,this._type,true,g,b):k;b=a.insertElement(b);this.selectedFlash&&a.getSelection().selectElement(b);this.d.hide()}}});t.Flash=m;m.registerBubble=function(a,b,g){q.register({pluginName:a,func:g,init:function(){var h=this,k=h.el;k.html(b+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var j=k.one(".ke-bubbleview-url"),c=k.one(".ke-bubbleview-change");k=k.one(".ke-bubbleview-remove");c._4e_unselectable();j._4e_unselectable();k._4e_unselectable();c.on("click",function(d){h._plugin.show(null,h._selectedEl);d.halt()});k.on("click",function(d){var n=h._plugin;h._selectedEl._4e_remove();n.editor.notifySelectionChange();d.halt()});h.on("beforeVisibleChange",function(d){var n=h._selectedEl;d.newVal&&n&&h._plugin._updateTip(j,n)})}})};m.registerBubble("flash","Flash \u7f51\u5740\uff1a ",
p);m.checkFlash=p;var r={"Flash\u5c5e\u6027":function(a){var b=a.getSelection();b=b&&b.getStartElement();b=p(b);a=a._toolbars.flash;b&&a.show(null,b)}};m.CLS_FLASH=l;m.TYPE_FLASH="flash"}();w&&w.addRules({elements:{object:function(m){var p=m.attributes;if(!(p.classid&&String(p.classid).toLowerCase())){for(p=0;p<m.children.length;p++)if(m.children[p].name=="embed"){if(!t.Flash.isFlashEmbed(m.children[p]))return null;return e.createFakeParserElement(m,l,"flash",true)}return null}return e.createFakeParserElement(m,
l,"flash",true)},embed:function(m){if(!t.Flash.isFlashEmbed(m))return null;return e.createFakeParserElement(m,l,"flash",true)}}},5)});
KISSY.Editor.add("font",function(w){var t=KISSY.Editor,A=KISSY,u=t.Style,x=t.TripleButton,B=w.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],q={},s=[],i={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},e=w.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],l={},f=[],m={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},p;w.cfg.pluginConfig["font-size"]=B;w.cfg.pluginConfig["font-family"]=e;for(p=0;p<B.length;p++){var o=B[p];q[o]=new u(i,{size:o});s.push({name:o,value:o})}for(p=0;p<e.length;p++){B=e[p];l[B]=new u(m,{family:B});f.push({name:B,value:B,attrs:{style:"font-family:"+B}})}t.Font||function(){function r(b){r.superclass.constructor.call(this,b);this._init()}function a(b){a.superclass.constructor.call(this,
b);this._init()}r.ATTRS={title:{},html:{},styles:{},editor:{}};A.extend(r,A.Base,{_init:function(){var b=this.get("editor"),g=b.toolBarDiv;this.get("html");this.el=new t.Select({container:g,doc:b.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);b.on("selectionChange",this._selectionChange,this)},_vChange:function(b){var g=this.get("editor"),h=b.newVal;b=b.preVal;var k=this.get("styles");g.focus();
g.fire("save");if(h==b){k[h].remove(g.document);this.el.set("value","")}else k[h].apply(g.document);g.fire("save")},_selectionChange:function(b){this.get("editor");b=b.path.elements;for(var g=this.get("styles"),h=0,k;h<b.length;h++){k=b[h];for(var j in g)if(g[j].checkElementRemovable(k,true)){this.el.set("value",j);return}}this.el.reset("value")}});a.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};A.extend(a,A.Base,{_init:function(){var b=this.get("editor"),g=this.get("text");this.get("style");
var h=this.get("title");this.el=new x({text:g,title:h,contentCls:this.get("contentCls"),container:b.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);b.on("selectionChange",this._selectionChange,this)},_on:function(){var b=this.get("editor");this.get("text");var g=this.get("style");this.get("title");b.fire("save");g.apply(b.document);b.fire("save");b.notifySelectionChange();b.focus()},_off:function(){var b=this.get("editor");this.get("text");var g=this.get("style");
this.get("title");b.fire("save");g.remove(b.document);b.fire("save");b.notifySelectionChange();b.focus()},_selectionChange:function(b){this.get("editor");this.get("text");var g=this.get("style");this.get("title");g.checkActive(b.path)?this.el.set("state",x.ON):this.el.set("state",x.OFF)}});r.SingleFont=a;t.Font=r}();w.addPlugin(function(){new t.Font({editor:w,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:q,html:s});new t.Font({editor:w,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:l,html:f});new t.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:w,style:new u({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new t.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:w,style:new u({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new t.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:w,style:new u({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new t.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:w,style:new u({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(w){var t=KISSY.Editor,A=KISSY,u=[],x={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},B={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},q={},s=t.Style;for(var i in x)if(x[i]){q[x[i]]=new s({element:x[i]});u.push({name:i,value:x[i],attrs:{style:"font-size:"+B[x[i]]}})}t.Format||function(){function e(l){e.superclass.constructor.call(this,
l);this._init()}e.ATTRS={editor:{}};A.extend(e,A.Base,{_init:function(){var l=this.get("editor");this.el=new t.Select({container:l.toolBarDiv,value:"",doc:l.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);l.on("selectionChange",this._selectionChange,this)},_vChange:function(l){var f=this.get("editor"),m=l.newVal;l=l.preVal;f.fire("save");if(m!=l)q[m].apply(f.document);else{q.p.apply(f.document);
this.el.set("value","p")}f.fire("save")},_selectionChange:function(l){this.get("editor");l=l.path;for(var f in q)if(q[f].checkActive(l)){this.el.set("value",f);return}this.el.reset("value")}});t.Format=e}();w.addPlugin(function(){new t.Format({editor:w,html:u,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function w(){this._={output:[]}}var t=KISSY.Editor,A=t.Utils;if(!t.HtmlParser.BasicWriter){KISSY.augment(w,{openTag:function(u){this._.output.push("<",u)},openTagClose:function(u,x){x?this._.output.push(" />"):this._.output.push(">")},attribute:function(u,x){if(typeof x=="string")x=A.htmlEncodeAttr(x);this._.output.push(" ",u,'="',x,'"')},closeTag:function(u){this._.output.push("</",u,">")},text:function(u){this._.output.push(u)},comment:function(u){this._.output.push("<!--",
u,"--\>")},write:function(u){this._.output.push(u)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(u){var x=this._.output.join("");u&&this.reset();return x}});t.HtmlParser.BasicWriter=w}});
KISSY.Editor.add("htmlparser-comment",function(){function w(u){this.value=u;this._={isBlockLike:false}}var t=KISSY.Editor,A=t.NODE;if(!t.HtmlParser.Comment){t.HtmlParser.Comment=w;w.prototype={constructor:w,type:A.NODE_COMMENT,writeHtml:function(u,x){var B=this.value;if(x){if(!(B=x.onComment(B,this)))return;if(typeof B!="string"){B.parent=this.parent;B.writeHtml(u,x);return}}u.comment(B)}}}});
KISSY.Editor.add("htmlparser-element",function(){function w(x,B){this.name=x;this.attributes=B||(B={});this.children=[];var q=B._ke_real_element_type||x;B=t.XHTML_DTD;q=!!(B.$nonBodyContent[q]||B.$block[q]||B.$listItem[q]||B.$tableContent[q]||B.$nonEditable[q]||q=="br");var s=!!B.$empty[x];this.isEmpty=s;this.isUnknown=!B[x];this._={isBlockLike:q,hasInlineStarted:s||!q}}var t=KISSY.Editor;if(!t.HtmlParser.Element){var A=t.NODE,u=function(x,B){x=x[0];B=B[0];return x<B?-1:x>B?1:0};KISSY.augment(w,{type:A.NODE_ELEMENT,
add:t.HtmlParser.Fragment.prototype.add,clone:function(){return new w(this.name,this.attributes)},writeHtml:function(x,B){var q=this.attributes,s=this,i=s.name,e,l,f,m;s.filterChildren=function(){if(!m){var r=new t.HtmlParser.BasicWriter;t.HtmlParser.Fragment.prototype.writeChildrenHtml.call(s,r,B);s.children=(new t.HtmlParser.Fragment.FromHtml(r.getHtml())).children;m=1}};if(B){for(;;){if(!(i=B.onElementName(i)))return;s.name=i;if(!(s=B.onElement(s)))return;s.parent=this.parent;if(s.name==i)break;
if(s.type!=A.NODE_ELEMENT){s.writeHtml(x,B);return}i=s.name;if(!i){this.writeChildrenHtml.call(s,x,m?null:B);return}}q=s.attributes}x.openTag(i,q);for(var p=[],o=0;o<2;o++)for(e in q){l=e;f=q[e];if(o==1)p.push([e,f]);else if(B){for(;;)if(l=B.onAttributeName(e))if(l!=e){delete q[e];e=l}else break;else{delete q[e];break}if(l)if((f=B.onAttribute(s,l,f))===false)delete q[l];else q[l]=f}}x.sortAttributes&&p.sort(u);q=p.length;for(o=0;o<q;o++){e=p[o];x.attribute(e[0],e[1])}x.openTagClose(i,s.isEmpty);if(!s.isEmpty){this.writeChildrenHtml.call(s,
x,m?null:B);x.closeTag(i)}},writeChildrenHtml:function(){t.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});t.HtmlParser.Element=w}});
KISSY.Editor.add("htmlparser-filter",function(){function w(i){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};i&&this.addRules(i,10)}function t(i,e){for(var l=0;i&&l<e.length;l++){var f=e[l];i=i.replace(f[0],f[1])}return i}function A(i,e,l){if(typeof e=="function")e=[e];var f,m;m=i.length;var p=e&&e.length;if(p){for(f=0;f<m&&i[f].pri<l;f++);for(m=p-1;m>=0;m--)if(p=e[m]){p.pri=l;i.splice(f,0,p)}}}function u(i,e,l){if(e)for(var f in e){var m=i[f];i[f]=x(m,e[f],
l);m||i.$length++}}function x(i,e,l){if(e){e.pri=l;if(i){if(i.splice)A(i,e,l);else{i=i.pri>l?[e,i]:[i,e];i.filter=B}return i}else return e.filter=e}}function B(i){for(var e=i.type||i instanceof q.HtmlParser.Fragment,l=0;l<this.length;l++){if(e)var f=i.type,m=i.name;var p=this[l].apply(window,arguments);if(p===false)return p;if(e){if(p&&(p.name!=m||p.type!=f))return p}else if(typeof p!="string")return p;p!=undefined&&(i=p)}return i}var q=KISSY.Editor,s=q.NODE;if(!q.HtmlParser.Filter){KISSY.augment(w,
{addRules:function(i,e){if(typeof e!="number")e=10;A(this._.elementNames,i.elementNames,e);A(this._.attributeNames,i.attributeNames,e);u(this._.elements,i.elements,e);u(this._.attributes,i.attributes,e);this._.text=x(this._.text,i.text,e)||this._.text;this._.comment=x(this._.comment,i.comment,e)||this._.comment;this._.root=x(this._.root,i.root,e)||this._.root},onElementName:function(i){return t(i,this._.elementNames)},onAttributeName:function(i){return t(i,this._.attributeNames)},onText:function(i){var e=
this._.text;return e?e.filter(i):i},onComment:function(i,e){var l=this._.comment;return l?l.filter(i,e):i},onFragment:function(i){var e=this._.root;return e?e.filter(i):i},onElement:function(i){for(var e=[this._.elements["^"],this._.elements[i.name],this._.elements.$],l,f=0;f<3;f++)if(l=e[f]){l=l.filter(i,this);if(l===false)return null;if(l&&l!=i)return this.onNode(l);if(i.parent&&!i.name)break}return i},onNode:function(i){var e=i.type;return e==s.NODE_ELEMENT?this.onElement(i):e==s.NODE_TEXT?new q.HtmlParser.Text(this.onText(i.value)):
null},onAttribute:function(i,e,l){if(e=this._.attributes[e]){i=e.filter(l,i,this);if(i===false)return false;if(typeof i!="undefined")return i}return l}});q.HtmlParser.Filter=w}});
KISSY.Editor.add("htmlparser-fragment",function(){function w(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var t=KISSY.Editor;if(!t.HtmlParser.Fragment){var A={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},u=KISSY,x=t.Utils,B=t.NODE,q=t.XHTML_DTD,s=x.mix({table:1,ul:1,ol:1,dl:1},q.table,q.ul,q.ol,q.dl),i=q.$list,e=q.$listItem;w.FromHtml=function(l,f){function m(d){var n;if(b.length>0)for(var y=0;y<b.length;y++){var v=b[y],D=v.name,H=
q[D],z=h.name&&q[h.name];if((!z||z[D])&&(!d||!H||H[d]||!q[d])){if(!n){p();n=1}v=v.clone();v.parent=h;h=v;b.splice(y,1);y--}}}function p(){for(;g.length;)h.add(g.shift())}function o(d,n,y){n=n||h||a;if(f&&!n.type){var v,D;if((v=d.attributes&&(D=d.attributes._ke_real_element_type)?D:d.name)&&!(v in q.$body)&&!(v in q.$nonBodyContent)){v=h;h=n;r.onTagOpen(f,{});n=h;if(y)h=v}}if(d._.isBlockLike&&d.name!="pre"){y=d.children.length;if((v=d.children[y-1])&&v.type==B.NODE_TEXT)if(D=x.rtrim(v.value))v.value=
D;else d.children.length=y-1}n.add(d);if(d.returnPoint){h=d.returnPoint;delete d.returnPoint}}var r=new t.HtmlParser,a=new w,b=[],g=[],h=a,k=false,j;r.onTagOpen=function(d,n,y){var v=new t.HtmlParser.Element(d,n);if(v.isUnknown&&y)v.isEmpty=true;if(q.$removeEmpty[d])b.push(v);else{if(d=="pre")k=true;else if(d=="br"&&k){h.add(new t.HtmlParser.Text("\n"));return}if(d=="br")g.push(v);else{var D=h.name,H=D&&(q[D]||(h._.isBlockLike?q.div:q.span));if(H&&!v.isUnknown&&!h.isUnknown&&!H[d]){H=false;var z;
if(d in i&&D in i){D=h.children;(D=D[D.length-1])&&D.name in e||o(D=new t.HtmlParser.Element("li"),h);j=h;z=D}else if(d==D)o(h,h.parent);else{if(s[D])j||(j=h);else{o(h,h.parent,true);A[D]||b.unshift(h)}H=true}h=z?z:h.returnPoint||h.parent;if(H){r.onTagOpen.apply(this,arguments);return}}m(d);p();v.parent=h;v.returnPoint=j;j=0;if(v.isEmpty)o(v);else h=v}}};r.onTagClose=function(d){for(var n=b.length-1;n>=0;n--)if(d==b[n].name){b.splice(n,1);return}for(var y=[],v=[],D=h;D.type&&D.name!=d;){D._.isBlockLike||
v.unshift(D);y.push(D);D=D.parent}if(D.type){for(n=0;n<y.length;n++){var H=y[n];o(H,H.parent)}h=D;if(h.name=="pre")k=false;D._.isBlockLike&&p();o(D,D.parent);if(D==h)h=h.parent;b=b.concat(v)}if(d=="body")f=false};r.onText=function(d){if(!h._.hasInlineStarted&&!k){d=x.ltrim(d);if(d.length===0)return}p();m();if(f&&(!h.type||h.name=="body")&&x.trim(d))this.onTagOpen(f,{});k||(d=d.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));h.add(new t.HtmlParser.Text(d))};r.onCDATA=function(){};r.onComment=function(d){h.add(new t.HtmlParser.Comment(d))};
r.parse(l);for(p();h.type;){l=h.parent;var c=h;if(f&&(!l.type||l.name=="body")&&!q.$body[c.name]){h=l;r.onTagOpen(f,{});l=h}l.add(c);h=l}return a};u.augment(w,{add:function(l){var f=this.children.length;if(f=f>0&&this.children[f-1]||null){if(l._.isBlockLike&&f.type==B.NODE_TEXT){f.value=x.rtrim(f.value);if(f.value.length===0){this.children.pop();this.add(l);return}}f.next=l}l.previous=f;l.parent=this;this.children.push(l);this._.hasInlineStarted=l.type==B.NODE_TEXT||l.type==B.NODE_ELEMENT&&!l._.isBlockLike},
writeHtml:function(l,f){var m;this.filterChildren=function(){var p=new t.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,p,f,true);p=p.getHtml();this.children=(new w.FromHtml(p)).children;m=1};!this.name&&f&&f.onFragment(this);this.writeChildrenHtml(l,m?null:f)},writeChildrenHtml:function(l,f){for(var m=0;m<this.children.length;m++)this.children[m].writeHtml(l,f)}});t.HtmlParser.Fragment=w}});
KISSY.Editor.add("htmlparser",function(){function w(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var t=KISSY.Editor;if(!t.HtmlParser){var A=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,u={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},x=t.XHTML_DTD;KISSY.augment(w,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var q,s,i=0,e;q=this._.htmlPartsRegex.exec(B);){s=q.index;if(s>i){i=B.substring(i,s);e?e.push(i):this.onText(i)}i=this._.htmlPartsRegex.lastIndex;if(s=q[1]){s=s.toLowerCase();if(e&&x.$cdata[s]){this.onCDATA(e.join(""));e=null}if(!e){this.onTagClose(s);continue}}if(e)e.push(q[0]);else if(s=q[3]){s=s.toLowerCase();var l={},f;q=q[4];var m=!!(q&&q.charAt(q.length-1)=="/");if(q)for(;f=A.exec(q);){var p=
f[1].toLowerCase();f=f[2]||f[3]||f[4]||"";l[p]=!f&&u[p]?p:f}this.onTagOpen(s,l,m);if(!e&&x.$cdata[s])e=[]}else if(s=q[2])this.onComment(s)}B.length>i&&this.onText(B.substring(i,B.length))}});t.HtmlParser=w}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function w(){w.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var u=t.XHTML_DTD;for(var x in A.mix({},u.$nonBodyContent,u.$block,u.$listItem,u.$tableContent))this.setRules(x,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!u[x]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var t=KISSY.Editor,A=t.Utils;if(!t.HtmlParser.HtmlWriter){KISSY.extend(w,t.HtmlParser.BasicWriter,{openTag:function(u){var x=this._.rules[u];if(this._.indent)this.indentation();else if(x&&x.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",u)},openTagClose:function(u,x){u=this._.rules[u];
if(x)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(u&&u.indent)this._.indentation+=this.indentationChars}u&&u.breakAfterOpen&&this.lineBreak()},attribute:function(u,x){if(typeof x=="string"){this.forceSimpleAmpersand&&(x=x.replace(/&amp;/g,"&"));x=A.htmlEncodeAttr(x)}this._.output.push(" ",u,'="',x,'"')},closeTag:function(u){var x=this._.rules[u];if(x&&x.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(x&&x.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",u,">");x&&x.breakAfterClose&&this.lineBreak()},text:function(u){if(this._.indent){this.indentation();u=A.ltrim(u)}this._.output.push(u)},comment:function(u){this._.indent&&this.indentation();this._.output.push("<!--",u,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(u,x){var B=this._.rules[u];if(B)A.mix(B,x);else this._.rules[u]=x}});t.HtmlParser.HtmlWriter=w}});KISSY.Editor.add("htmlparser-text",function(){function w(A){this.value=A;this._={isBlockLike:false}}var t=KISSY.Editor;if(!t.HtmlParser.Text){KISSY.augment(w,{type:t.NODE.NODE_TEXT,writeHtml:function(A,u){var x=this.value;u&&!(x=u.onText(x,this))||A.text(x)}});t.HtmlParser.Text=w}});
KISSY.Editor.add("htmldataprocessor",function(w){function t(j){if(/mso-list\s*:\s*Ignore/i.test(j.attributes&&j.attributes.style))return true;return q}function A(j,c){var d=new s.HtmlParser.Element("ke:listbullet"),n;if(j)if(j[2]){j=isNaN(j[1])?/^[a-z]+$/.test(j[1])?"lower-alpha":/^[A-Z]+$/.test(j[1])?"upper-alpha":"decimal":"decimal";n="ol"}else{j=/[l\u00B7\u2002]/.test(j[1])?"disc":/[\u006F\u00D8]/.test(j[1])?"circle":/[\u006E\u25C6]/.test(j[1])?"square":"disc";n="ul"}else{j="decimal";n="ol"}d.attributes=
{"ke:listtype":n,style:"list-style-type:"+j+";"};d.add(new s.HtmlParser.Text(c));return d}function u(j){var c=j.attributes,d;if((d=j.removeAnyChildWithName("ke:listbullet"))&&d.length&&(d=d[0])){j.name="ke:li";if(c.style)c.style=x([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(n){n=n.split(" ");n=n[3]||n[1]||n[0];n=parseInt(n,10);if(!a&&b&&n>b)a=n-b;c["ke:margin"]=b=n}]],q)(c.style,j)||"";d=d.attributes;j.addStyle(d.style);i.mix(c,d);return true}return false}function x(j,c){return function(d,
n){var y=[];d.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(v,D,H){D=D.toLowerCase();D=="font-family"&&(H=H.replace(/["']/g,""));for(var z,C,I,J=0;J<j.length;J++)if(j[J]){v=j[J][0];z=j[J][1];C=j[J][2];I=j[J][3];if(D.match(v)&&(!z||H.match(z))){D=I||D;c&&(C=C||H);if(typeof C=="function")C=C(H,n,D);if(C&&C.push){D=C[0];C=C[1]}typeof C=="string"&&y.push([D,C]);return}}!c&&y.push([D,H])});for(d=0;d<y.length;d++)y[d]=y[d].join(":");return y.length?y.join(";")+";":false}}
function B(j){j=j.children;for(var c,d,n,y,v,D,H,z=0;z<j.length;z++){c=j[z];if("ke:li"==c.name){c.name="li";d=c.attributes;n=c.attributes["ke:listtype"];y=parseInt(d["ke:indent"],10)||a&&Math.ceil(d["ke:margin"]/a)||1;d.style&&(d.style=x([["list-style-type",n=="ol"?"decimal":"disc"]],q)(d.style)||"");if(D){if(y>H){D=new s.HtmlParser.Element(n);D.add(c);v.add(D)}else{if(y<H){v=H-y;for(var C;v--&&(C=D.parent);)D=C.parent}D.add(c)}j.splice(z--,1)}else{D=new s.HtmlParser.Element(n);D.add(c);j[z]=D}v=
c;H=y}else D=null}a=0}var q=q,s=KISSY.Editor,i=KISSY,e=i.UA,l=s.NODE,f=s.HtmlParser,m=new f.Filter,p=new f.Filter,o=s.XHTML_DTD;if(!w.htmlDataProcessor){(function(){var j=s.HtmlParser.Fragment.prototype,c=s.HtmlParser.Element.prototype;j.onlyChild=c.onlyChild=function(){var d=this.children;return d.length==1&&d[0]||null};c.removeAnyChildWithName=function(d){for(var n=this.children,y=[],v,D=0;D<n.length;D++){v=n[D];if(v.name){if(v.name==d){y.push(v);n.splice(D--,1)}y=y.concat(v.removeAnyChildWithName(d))}}return y};
c.getAncestor=function(d){for(var n=this.parent;n&&!(n.name&&n.name.match(d));)n=n.parent;return n};j.firstChild=c.firstChild=function(d){for(var n,y=0;y<this.children.length;y++){n=this.children[y];if(d(n))return n;else if(n.name)if(n=n.firstChild(d))return n}return null};c.addStyle=function(d,n,y){var v="";if(typeof n=="string")v+=d+":"+n+";";else{if(typeof d=="object")for(var D in d){if(d.hasOwnProperty(D))v+=D+":"+d[D]+";"}else v+=d;y=n}if(!this.attributes)this.attributes={};d=this.attributes.style||
"";d=(y?[v,d]:[d,v]).join(";");this.attributes.style=d.replace(/^;|;(?=;)/,"")};o.parentOf=function(d){var n={};for(var y in this)if(y.indexOf("$")==-1&&this[y][d])n[y]=1;return n}})();var r=x([[/mso/i],[/font-size/i,"",function(j){for(var c=w.cfg.pluginConfig["font-size"],d=0;d<c.length;d++)if(j.toLowerCase()==c[d])return j;return false},"font-size"],[/font-family/i,"",function(j){for(var c=w.cfg.pluginConfig["font-family"],d=0;d<c.length;d++)if(j.toLowerCase()==c[d].toLowerCase())return j;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],q),a,b=0,g=o.parentOf("ol"),h={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(j){j.filterChildren();B(j)},elements:{font:function(j){delete j.name},p:function(j){j.filterChildren();if(u(j))return q},$:function(j){var c=j.name||"";c.indexOf(":")!=-1&&c.indexOf("ke")==-1&&delete j.name;var d=j.attributes.style;if(c=="span"&&(!d||!r(d)))delete j.name;
if(c in g){j.filterChildren();B(j)}},table:function(j){var c=j.attributes.border;if(!c||c=="0")j.attributes["class"]="ke_show_border"},td:function(j){if(e.ie){j=j.children;var c=new s.HtmlParser.Text("&nbsp;");if(j.length)j[j.length-1].type!=l.NODE_TEXT&&j.push(c);else j.push(c)}},span:function(j){if(!e.gecko&&t(j.parent))return false;if(!e.gecko&&t(j)){j=(j=j.firstChild(function(d){return d.value||d.name=="img"}))&&(j.value||"l.");var c=j.match(/^([^\s]+?)([.)]?)$/);return A(c,j)}}},comment:!e.ie?
function(j,c){var d=j.match(/<img.*?>/);if(j=j.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){d=(c=j[1]||d&&"l.")&&c.match(/>([^\s]+?)([.)]?)</);return A(d,c)}if(e.gecko&&d){d=s.HtmlParser.Fragment.FromHtml(d[0]).children[0];(c=(c=(c=c.previous)&&c.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&c[1])&&(d.attributes.src=c);return d}return false}:function(){return false},attributes:{"class":function(j){if(/^ke_/.test(j))return j;return false},style:function(j){j=r(j);if(!j)return false;
return j}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},k={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(j){var c=j.parent;if(c&&c.name=="object"){var d=c.attributes.width;c=c.attributes.height;d&&(j.attributes.width=d);c&&(j.attributes.height=c)}},param:function(j){j.children=[];j.isEmpty=true;return j},a:function(j){if(!(j.children.length||j.attributes.name))return false},td:function(j){for(var c=j.children,d=0;d<c.length;d++)if(c[d].name=="br"){c.splice(d,1);--d}if(!j.children.length){c=
new s.HtmlParser.Text("&nbsp;");j.children.push(c)}},span:function(j){if(!j.children.length)return false}},attributes:{style:function(j){if(!i.trim(j))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(e.ie)k.attributes.style=function(j){return j.toLowerCase()};m.addRules(k);p.addRules(h);w.htmlDataProcessor={htmlFilter:m,dataFilter:p,toHtml:function(j,c){var d=new f.HtmlWriter;f.Fragment.FromHtml(j,c).writeHtml(d,m);return d.getHtml(true)},toDataFormat:function(j,c){if(e.gecko)j=
j.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var d=new f.BasicWriter;j=f.Fragment.FromHtml(j,c);d.reset();j.writeHtml(d,p);return d.getHtml(true)}}}});
KISSY.Editor.add("image",function(w){var t=KISSY.Editor,A=KISSY,u=A.Node,x=A.Event,B=t.BubbleView,q=t.SimpleOverlay;t.ImageInserter||function(){function s(f){s.superclass.constructor.call(this,f);this._init()}var i=function(f){return f._4e_name()==="img"&&!/(^|\s+)ke_/.test(f[0].className)&&f},e=t.TripleButton;s.ATTRS={editor:{}};var l={"\u56fe\u7247\u5c5e\u6027":function(f){var m=f.getSelection();m=m&&m.getStartElement();m=i(m);f=f._toolbars.image;m&&f.show(null,m)}};A.extend(s,A.Base,{_init:function(){var f=
this.get("editor"),m=f.toolBarDiv,p={};this.editor=f;this.el=new e({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",container:m});this.el.on("offClick",this.show,this);x.on(f.document,"dblclick",this._dblclick,this);t.Utils.lazyRun(this,"_prepare","_real");f._toolbars=f._toolbars||{};f._toolbars.image=this;if(l)for(var o in l)(function(r){p[r]=function(){l[r](f)}})(o);t.ContextMenu.register(f.document,{rules:[i],width:"120px",funcs:p});B.attach({pluginName:"image",pluginInstance:this})},
_dblclick:function(f){var m=new u(f.target);if(i(m)){this.show(null,m);f.halt()}},_prepare:function(){var f=this;f.get("editor");f.d=new q({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var m=f.d;m.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></p><p style='margin:5px 0'><label><span style='color:#0066CC;font-weight:bold;'>\u9ad8\u5ea6\uff1a </span><input class='ke-img-height' style='width:90px' value='\u81ea\u52a8'/> px </label> &nbsp;<label><span style='color:#0066CC;font-weight:bold;'>\u5bbd\u5ea6\uff1a </span><input class='ke-img-width' style='width:90px' value='\u81ea\u52a8'/> px </label></p><p><label><span style='color:#0066CC;font-weight:bold;'>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></label></p></div>");
m.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");f.content=m.el;m=f.content;var p=m.one(".ke-img-cancel"),o=m.one(".ke-img-insert");f.imgUrl=m.one(".ke-img-url");f.imgHeight=m.one(".ke-img-height");f.imgWidth=m.one(".ke-img-width");f.imgAlign=m.one(".ke-img-align");p.on("click",function(r){f.d.hide();r.halt()});o.on("click",function(){f._insert()})},_updateTip:function(f,m){f.html(m.attr("src"));f.attr("href",m.attr("src"))},_real:function(){this.d.show()},
_insert:function(){var f=this.get("editor"),m=this.imgUrl.val();if(m){var p=parseInt(this.imgHeight.val()),o=parseInt(this.imgWidth.val()),r=this.imgAlign.val(),a="";if(p)a+="height:"+p+"px;";if(o)a+="width:"+o+"px;";if(r)a+="float:"+r+";margin:0 5px;";if(a)a=" style='"+a+"' ";m=new u("<img "+a+"src='"+m+"' alt='' />",null,f.document);m=f.insertElement(m,p||o?null:function(b){b.on("load",function(){b.detach();b.css({width:b.width()+"px",height:b.height()+"px"})})});this._selectedEl&&f.getSelection().selectElement(m);
this.d.hide();f.notifySelectionChange()}},_updateD:function(f){if(this._selectedEl=f){this.imgUrl.val(f.attr("src"));this.imgHeight.val(f.height());this.imgWidth.val(f.width());this.imgAlign.val(f._4e_style("float"))}else{this.imgUrl.val("http://");this.imgHeight.val("\u81ea\u52a8");this.imgWidth.val("\u81ea\u52a8");this.imgAlign.val()}},show:function(f,m){this._prepare();this._updateD(m)}});t.ImageInserter=s;(function(f,m,p){B.register({pluginName:f,func:p,init:function(){var o=this,r=o.el;r.html(m+
'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');var a=r.one(".ke-bubbleview-url"),b=r.one(".ke-bubbleview-change");r=r.one(".ke-bubbleview-remove");b._4e_unselectable();a._4e_unselectable();r._4e_unselectable();b.on("click",function(g){o._plugin.show(null,o._selectedEl);g.halt()});r.on("click",function(g){var h=o._plugin;o._selectedEl._4e_remove();
h.editor.notifySelectionChange();g.halt()});o.on("afterVisibleChange",function(g){var h=o._selectedEl;g.newVal&&h&&o._plugin._updateTip(a,h)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",i)}();w.addPlugin(function(){new t.ImageInserter({editor:w})})});
KISSY.Editor.add("indent",function(w){var t=KISSY.Editor,A={ol:1,ul:1},u=KISSY,x=t.Walker,B=u.DOM,q=u.Node,s=u.UA,i=t.NODE;t.Indent||function(){function e(g){this.type=g;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function l(g){return g.type=CKEDITOR.NODE_ELEMENT&&g.is("li")}function f(g,h,k){var j=h.startContainer;for(g=h.endContainer;j&&j.parent()[0]!==k[0];)j=j.parent();for(;g&&g.parent()[0]!==k[0];)g=g.parent();if(j&&g){var c=j;j=[];for(var d=false;!d;){if(c[0]===
g[0])d=true;j.push(c);c=c.next()}if(!(j.length<1)){c=k._4e_parents(true);for(g=0;g<c.length;g++)if(A[c[g]._4e_name()]){k=c[g];break}c=this.type=="indent"?1:-1;g=j[0];d=j[j.length-1];j={};var n=t.ListUtils.listToArray(k,j),y=n[d._4e_getData("listarray_index")].indent;for(g=g._4e_getData("listarray_index");g<=d._4e_getData("listarray_index");g++){n[g].indent+=c;var v=n[g].parent;n[g].parent=new q(v[0].ownerDocument.createElement(v._4e_name()))}for(g=d._4e_getData("listarray_index")+1;g<n.length&&n[g].indent>
y;g++)n[g].indent+=c;d=t.ListUtils.arrayToList(n,j,null,"p",0);c=[];if(this.type=="outdent"){var D;if((D=k.parent())&&D._4e_name()=="li"){n=d.listNode.childNodes;var H;for(g=n.length-1;g>=0;g--)if((H=new q(n[g]))&&H._4e_name()=="li")c.push(H)}}if(d){B.insertBefore(d.listNode,k[0]);k._4e_remove()}if(c&&c.length)for(g=0;g<c.length;g++){for(H=k=c[g];(H=H.next())&&H._4e_name()in A;){s.ie&&!k._4e_first(function(z){return r(z)&&a(z)})&&k[0].appendChild(h.document.createTextNode("\u00a0"));k[0].appendChild(H[0])}B.insertAfter(k[0],
D[0])}for(g in j)j[g]._4e_clearMarkers(j,true)}}}function m(g,h){h=h.createIterator();h.enforceRealBlocks=true;h.enlargeBr=true;for(var k;k=h.getNextParagraph();)p.call(this,g,k)}function p(g,h){g=parseInt(h._4e_style(this.indentCssProperty),10);if(isNaN(g))g=0;g+=(this.type=="indent"?1:-1)*this.indentOffset;if(g<0)return false;g=Math.max(g,0);g=Math.ceil(g/this.indentOffset)*this.indentOffset;h.css(this.indentCssProperty,g?g+this.indentUnit:"");h[0].style.cssText===""&&h[0].removeAttribute("style");
return true}function o(g){o.superclass.constructor.call(this,g);g=this.get("editor").toolBarDiv;this.el=new b({container:g,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new e(this.get("type"));this._init()}var r=x.whitespaces(true),a=x.bookmark(false,true);u.augment(e,{exec:function(g){for(var h=g.getSelection(),k=h&&h.getRanges()[0],j=k.startContainer,c=k.endContainer,d=k.getCommonAncestor();d&&!(d[0].nodeType==i.NODE_ELEMENT&&A[d._4e_name()]);)d=d.parent();if(d&&
j[0].nodeType==i.NODE_ELEMENT&&j._4e_name()in A){j=new x(k);j.evaluator=l;k.startContainer=j.next()}if(d&&c[0].nodeType==i.NODE_ELEMENT&&c._4e_name()in A){j=new x(k);j.evaluator=l;k.endContainer=j.previous()}c=h.createBookmarks(true);if(d){for(j=d._4e_first();j&&j[0]&&j._4e_name()!="li";)j=j.next();var n=k.startContainer;(j[0]==n[0]||j._4e_contains(n))&&p.call(this,g,d)||f.call(this,g,k,d)}else m.call(this,g,k);h.selectBookmarks(c)}});var b=t.TripleButton;o.ATTRS={type:{},contentCls:{},editor:{}};
u.extend(o,u.Base,{_init:function(){var g=this.get("editor"),h=this.el;h.on("offClick",this.exec,this);this.get("type")=="outdent"?g.on("selectionChange",this._selectionChange,this):h.set("state",b.OFF)},exec:function(){var g=this.get("editor"),h=this;g.fire("save");setTimeout(function(){h.indentCommand.exec(g);g.fire("save");g.notifySelectionChange()},10)},_selectionChange:function(g){this.get("editor");this.get("type");var h=g.path,k=h.blockLimit;g=this.el;if(h.contains(A))g.set("state",b.OFF);
else(h=h.block||k)&&h._4e_style(this.indentCommand.indentCssProperty)?g.set("state",b.OFF):g.set("state",b.DISABLED)}});t.Indent=o}();w.addPlugin(function(){w.addCommand("outdent",new t.Indent({editor:w,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));w.addCommand("indent",new t.Indent({editor:w,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(w){var t=KISSY.Editor,A=KISSY,u=t.TripleButton;t.Justify||function(){function x(q,s,i,e){this.editor=q;this.v=s;this.contentCls=e;this.title=i;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;A.augment(x,{_init:function(){var q=this.editor;this.el=new u({contentCls:this.contentCls,title:this.title,container:q.toolBarDiv});q.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var q=this.editor,s=q.getSelection(),
i=this.el.get("state");if(s){var e=s.createBookmarks(),l=s.getRanges(),f,m;q.fire("save");for(var p=l.length-1;p>=0;p--){f=l[p].createIterator();for(f.enlargeBr=true;m=f.getNextParagraph();){m.removeAttr("align");i==u.OFF?m.css("text-align",this.v):m.css("text-align","")}}q.notifySelectionChange();s.selectBookmarks(e);q.fire("save")}},_selectionChange:function(q){var s=this.el;q=q.path;if(q=q.block||q.blockLimit){q=q.css("text-align").replace(B,"");q==this.v||!q&&this.v=="left"?s.set("state",u.ON):
s.set("state",u.OFF)}}});t.Justify=x}();w.addPlugin(function(){new t.Justify(w,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new t.Justify(w,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new t.Justify(w,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(w){var t=KISSY.Editor;t.Link||function(){function A(m){this.editor=m;this._init()}function u(m){return m._4e_ascendant(function(p){return p._4e_name()==="a"&&!!p.attr("href")},true)}var x=KISSY,B=t.TripleButton,q=t.Style,s=x.Node,i=t.Range,e=t.SimpleOverlay,l=t.BubbleView,f={element:"a",attributes:{href:"#(href)",target:"#(target)"}};A.init=function(){var m=new e({title:"\u94fe\u63a5\u5c5e\u6027",mask:true,width:"300px"});this.dialog=m;m.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input class='ke-link-url' style='width:220px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
m.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");m.urlEl=m.body.one(".ke-link-url");m.targetEl=m.body.one(".ke-link-blank");var p=m.foot.one(".ke-link-cancel");m.foot.one(".ke-link-ok").on("click",function(o){m.link._link();o.halt()},this);p.on("click",function(o){m.hide();o.halt()},this);A.init=null};l.register({pluginName:"link",func:u,init:function(){var m=this,p=m.el;p.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var o=p.one(".ke-bubbleview-url"),r=p.one(".ke-bubbleview-change");p=p.one(".ke-bubbleview-remove");r._4e_unselectable();o._4e_unselectable();p._4e_unselectable();r.on("click",function(a){m._plugin.show();a.halt()});p.on("click",function(a){m._plugin._removeLink(m._selectedEl);a.halt()});m.on("afterVisibleChange",function(){var a=m._selectedEl;if(a){o.html(a.attr("href"));o.attr("href",a.attr("href"))}})}});x.augment(A,{_init:function(){this.el=new B({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-link",
title:"\u63d2\u5165\u94fe\u63a5 "});this.el.on("click",this.show,this);l.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(m){var p=this.editor,o={href:m.attr("href")};if(m._4e_hasAttribute("target"))o.target=m.attr("target");m=new q(f,o);p.fire("save");m.remove(p.document);p.fire("save");p.notifySelectionChange()},_getSelectedLink:function(){var m=this.editor.getSelection();if(m=m&&m.getStartElement())m=u(m);return m},_link:function(){var m,p=this.editor,o=A.dialog,r=o.urlEl.val(),
a;if(x.trim(r)){o.hide();if(a=this._getSelectedLink()){m=new i(p.document);m.selectNodeContents(a);p.getSelection().selectRanges([m]);this._removeLink(a)}a={href:r};a.target=o.targetEl[0].checked?"_blank":"_self";m=p.getSelection().getRanges()[0];if(m.collapsed){m=new s("<a href='"+r+"' target='"+a.target+"'>"+r+"</a>",null,p.document);p.insertElement(m)}else{p.fire("save");m=new q(f,a);m.apply(p.document);p.fire("save")}p.notifySelectionChange()}},_prepare:function(){A.init&&A.init()},_real:function(){var m=
A.dialog,p=this._getSelectedLink();m.link=this;if(p){m.urlEl.val(p.attr("href"));m.targetEl[0].checked=p.attr("target")=="_blank"}m.show()},show:function(){this._prepare()}});t.Utils.lazyRun(A.prototype,"_prepare","_real");t.Link=A}();w.addPlugin(function(){new t.Link(w)})});
KISSY.Editor.add("list",function(w){var t=KISSY.Editor,A={ol:1,ul:1},u=["ol","ul"],x=KISSY,B=t.RANGE,q=t.ElementPath,s=t.Walker,i=t.NODE,e=x.UA,l=x.Node,f=x.DOM;t.List||function(){function m(b){this.type=b}function p(b){p.superclass.constructor.call(this,b);b=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:b});this.listCommand=new m(this.get("type"));this.listCommand.state=this.get("status");this._init()}var o={listToArray:function(b,
g,h,k,j){if(!A[b._4e_name()])return[];k||(k=0);h||(h=[]);for(var c=0,d=b[0].childNodes.length;c<d;c++){var n=new l(b[0].childNodes[c]);if(n._4e_name()=="li"){var y={parent:b,indent:k,element:n,contents:[]};if(j)y.grandparent=j;else{y.grandparent=b.parent();if(y.grandparent&&y.grandparent._4e_name()=="li")y.grandparent=y.grandparent.parent()}g&&n._4e_setMarker(g,"listarray_index",h.length);h.push(y);for(var v=0,D=n[0].childNodes.length,H;v<D;v++){H=new l(n[0].childNodes[v]);H[0].nodeType==i.NODE_ELEMENT&&
A[H._4e_name()]?o.listToArray(H,g,h,k+1,y.grandparent):y.contents.push(H)}}}return h},arrayToList:function(b,g,h,k){h||(h=0);if(!b||b.length<h+1)return null;for(var j=b[h].parent[0].ownerDocument,c=j.createDocumentFragment(),d=null,n=h,y=Math.max(b[h].indent,0),v=null;;){var D=b[n];if(D.indent==y){if(!d||b[n].parent._4e_name()!=d._4e_name()){d=b[n].parent._4e_clone(false,true);c.appendChild(d[0])}v=d[0].appendChild(D.element._4e_clone(false,true)[0]);for(var H=0;H<D.contents.length;H++)v.appendChild(D.contents[H]._4e_clone(true,
true)[0]);n++}else if(D.indent==Math.max(y,0)+1){n=o.arrayToList(b,null,n,k);v.appendChild(n.listNode);n=n.nextIndex}else if(D.indent==-1&&!h&&D.grandparent){v=A[D.grandparent._4e_name()]?D.element._4e_clone(false,true)[0]:D.grandparent._4e_name()!="td"?j.createElement(k):j.createDocumentFragment();for(H=0;H<D.contents.length;H++)v.appendChild(D.contents[H]._4e_clone(true,true)[0]);if(v.nodeType==i.NODE_DOCUMENT_FRAGMENT&&n!=b.length-1){v.lastChild&&v.lastChild.nodeType==i.NODE_ELEMENT&&v.lastChild.getAttribute("type")==
"_moz"&&f._4e_remove(v.lastChild);f._4e_appendBogus(v)}if(v.nodeType==i.NODE_ELEMENT&&f._4e_name(v)==k&&v.firstChild){f._4e_trim(v);d=v.firstChild;if(d.nodeType==i.NODE_ELEMENT&&f._4e_isBlockBoundary(d)){d=j.createDocumentFragment();f._4e_moveChildren(v,d);v=d}}d=f._4e_name(v);if(!e.ie&&(d=="div"||d=="p"))f._4e_appendBogus(v);c.appendChild(v);d=null;n++}else return null;if(b.length<=n||Math.max(b[n].indent,0)<y)break}if(g)for(b=new l(c.firstChild);b&&b[0];){b[0].nodeType==i.NODE_ELEMENT&&b._4e_clearMarkers(g,
true);b=b._4e_nextSourceNode()}return{listNode:c,nextIndex:n}}},r=/^h[1-6]$/;m.prototype={changeListType:function(b,g,h,k){var j=o.listToArray(g.root,h),c=[];for(b=0;b<g.contents.length;b++){var d=g.contents[b];d=d._4e_ascendant("li",true);if(!(!d||!d[0]||d._4e_getData("list_item_processed"))){c.push(d);d._4e_setMarker(h,"list_item_processed",true)}}d=new l(g.root[0].ownerDocument.createElement(this.type));for(b=0;b<c.length;b++){var n=c[b]._4e_getData("listarray_index");j[n].parent=d}h=o.arrayToList(j,
h,null,"p");var y;j=h.listNode.childNodes.length;for(b=0;b<j&&(y=new l(h.listNode.childNodes[b]));b++)y._4e_name()==this.type&&k.push(y);f.insertBefore(h.listNode,g.root[0]);g.root._4e_remove()},createList:function(b,g,h){var k=g.contents;b=g.root[0].ownerDocument;var j=[];if(k.length==1&&k[0][0]===g.root[0]){var c=new l(b.createElement("div"));k[0][0].nodeType!=i.NODE_TEXT&&k[0]._4e_moveChildren(c);k[0][0].appendChild(c[0]);k[0]=c}g=g.contents[0].parent();for(c=0;c<k.length;c++)g=g._4e_commonAncestor(k[c].parent());
for(c=0;c<k.length;c++)for(var d=k[c],n;n=d.parent();){if(n[0]===g[0]){j.push(d);break}d=n}if(!(j.length<1)){k=new l(j[j.length-1][0].nextSibling);c=new l(b.createElement(this.type));for(h.push(c);j.length;){h=j.shift();d=new l(b.createElement("li"));if(r.test(h._4e_name()))d[0].appendChild(h[0]);else{h._4e_copyAttributes(d);h._4e_moveChildren(d);h._4e_remove()}c[0].appendChild(d[0]);e.ie||d._4e_appendBogus()}k[0]?f.insertBefore(c[0],k[0]):g[0].appendChild(c[0])}},removeList:function(b,g,h){function k(H){if((v=
new l(y[H?"firstChild":"lastChild"]))&&!(v[0].nodeType==i.NODE_ELEMENT&&v._4e_isBlockBoundary())&&(D=g.root[H?"_4e_previous":"_4e_next"](s.whitespaces(true)))&&!(v[0].nodeType==i.NODE_ELEMENT&&D._4e_isBlockBoundary({br:1})))f[H?"insertBefore":"insertAfter"](b.document.createElement("br"),v[0])}for(var j=o.listToArray(g.root,h),c=[],d=0;d<g.contents.length;d++){var n=g.contents[d];n=n._4e_ascendant("li",true);if(!(!n||n._4e_getData("list_item_processed"))){c.push(n);n._4e_setMarker(h,"list_item_processed",
true)}}n=null;for(d=0;d<c.length;d++){n=c[d]._4e_getData("listarray_index");j[n].indent=-1;n=n}for(d=n+1;d<j.length;d++)if(j[d].indent>Math.max(j[d-1].indent,0)){c=j[d-1].indent+1-j[d].indent;for(n=j[d].indent;j[d]&&j[d].indent>=n;){j[d].indent+=c;d++}d--}var y=o.arrayToList(j,h,null,"p").listNode,v,D;k(true);k();f.insertBefore(y,g.root);g.root._4e_remove()},exec:function(b){var g=b.getSelection(),h=g&&g.getRanges();if(!(!h||h.length<1)){for(var k=g.createBookmarks(true),j=[],c={};h.length>0;){var d=
h.shift(),n=d.getBoundaryNodes(),y=n.startNode,v=n.endNode;y[0].nodeType==i.NODE_ELEMENT&&y._4e_name()=="td"&&d.setStartAt(n.startNode,B.POSITION_AFTER_START);v[0].nodeType==i.NODE_ELEMENT&&v._4e_name()=="td"&&d.setEndAt(n.endNode,B.POSITION_BEFORE_END);d=d.createIterator();for(d.forceBrBreak=false;n=d.getNextParagraph();){y=new q(n);v=y.elements;var D=null,H=false,z=y.blockLimit,C;for(y=v.length-1;y>=0&&(C=v[y]);y--)if(A[C._4e_name()]&&z.contains(C)){z._4e_removeData("list_group_object");if(y=C._4e_getData("list_group_object"))y.contents.push(n);
else{y={root:C,contents:[n]};j.push(y);C._4e_setMarker(c,"list_group_object",y)}H=true;break}if(!H)if(z._4e_getData("list_group_object"))z._4e_getData("list_group_object").contents.push(n);else{y={root:z,contents:[n]};z._4e_setMarker(c,"list_group_object",y);j.push(y)}}}for(h=[];j.length>0;){y=j.shift();if(this.state=="off")A[y.root._4e_name()]?this.changeListType(b,y,c,h):this.createList(b,y,h);else this.state=="on"&&A[y.root._4e_name()]&&this.removeList(b,y,c)}for(y=0;y<h.length;y++){D=h[y];var I=
this;(b=function(J){var N=D[J?"_4e_previous":"_4e_next"](s.whitespaces(true));if(N&&N[0]&&N._4e_name()==I.type){N._4e_remove();N._4e_moveChildren(D,J?true:false)}})();b(true)}t.Utils.clearAllMarkers(c);g.selectBookmarks(k)}}};var a=t.TripleButton;p.ATTRS={editor:{},type:{},contentCls:{}};x.extend(p,x.Base,{_init:function(){var b=this,g=b.get("editor"),h=b.el;b=b;h.on("click",b._change,b);g.on("selectionChange",b._selectionChange,b)},_change:function(){var b=this.get("editor");this.get("type");var g=
this.el;b.fire("save");this.listCommand.state=g.get("state");this.listCommand.exec(b);b.fire("save");b.notifySelectionChange()},_selectionChange:function(b){this.get("editor");var g=this.get("type"),h=b.path,k;b=this.el;var j=h.blockLimit;if(h=h.elements)for(var c=0;c<h.length&&(k=h[c])&&k[0]!==j[0];c++){var d=x.indexOf(h[c]._4e_name(),u);if(d!==-1)if(u[d]===g){b.set("state",a.ON);return}else break}b.set("state",a.OFF)}});t.ListUtils=o;t.List=p}();w.addPlugin(function(){new t.List({editor:w,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new t.List({editor:w,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(w){var t=KISSY.Editor,A=KISSY,u=A.UA,x=A.Node,B=A.Event,q=t.TripleButton,s=A.DOM,i;t.Maximize||function(){function e(l){this.editor=l;this._init()}e.init=function(){i=new x("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(i[0]);e.init=null};A.augment(e,{_init:function(){this.el=new q({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);t.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var l=this,f=l.editor;B.remove(window,"resize",l._maximize,l);this._saveEditorStatus();f.wrap.css({height:l.iframeHeight});(new x(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";f.editorWrap.css({position:"static",width:l.editorWrapWidth});i.css({left:"-99999px",top:"-99999px"});window.scrollTo(l.scrollLeft,
l.scrollTop);l.el.set("state",q.OFF);setTimeout(function(){l._restoreEditorStatus()},30);f.notifySelectionChange()},_saveSate:function(){var l=this.editor;this.iframeHeight=l.wrap._4e_style("height");this.editorWrapWidth=l.editorWrap._4e_style("width");this.scrollLeft=s.scrollLeft();this.scrollTop=s.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var l=this.editor;if(u.gecko&&l.iframeFocus)this.savedRanges=(l=l.getSelection())&&l.getRanges()},_restoreEditorStatus:function(){var l=this.editor,
f=l.getSelection();if(u.gecko&&l.iframeFocus){this.el.el[0].focus();l.focus();this.savedRanges&&f&&f.selectRanges(this.savedRanges)}if(l.iframeFocus&&f)(l=f.getStartElement())&&l[0]&&l._4e_scrollIntoView()},_maximize:function(){var l=this.editor,f=s.viewportHeight(),m=s.viewportWidth(),p=l.statusDiv?l.statusDiv.height():0,o=l.toolBarDiv.height();if(u.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new x(document.body)).css({width:0,height:0,overflow:"hidden"});
l.editorWrap.css({position:"absolute",zIndex:990,width:m+"px"});i.css({zIndex:985,height:f+"px",width:m+"px"});l.editorWrap.offset({left:0,top:0});i.css({left:0,top:0});l.wrap.css({height:f-p-o-14+"px"});l.notifySelectionChange()},_real:function(){var l=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",l._maximize,l);this.el.set("state",q.ON);setTimeout(function(){l._restoreEditorStatus()},30)},_prepare:function(){e.init&&e.init()},maximize:function(){this._prepare()}});
t.Maximize=e}();w.addPlugin(function(){new t.Maximize(w)})});
KISSY.Editor.add("music",function(w){function t(l){return l.indexOf(q)!=-1}var A=KISSY.Editor,u=KISSY,x=A.Flash,B="ke_music",q="niftyplayer.swf",s=A.Utils.getFlashUrl,i=w.htmlDataProcessor,e=i&&i.dataFilter;e&&e.addRules({elements:{object:function(l){var f=l.attributes;if(!(f.classid&&String(f.classid).toLowerCase())){for(f=0;f<l.children.length;f++)if(l.children[f].name=="embed"){if(!x.isFlashEmbed(l.children[f]))return null;if(t(l.children[f].attributes.src))return i.createFakeParserElement(l,B,
"music",true)}return null}for(f=0;f<l.children.length;f++){var m=l.children[f];if(m.name=="param"&&m.attributes.name=="movie")if(t(m.attributes.value))return i.createFakeParserElement(l,B,"music",true)}},embed:function(l){if(!x.isFlashEmbed(l))return null;if(t(l.attributes.src))return i.createFakeParserElement(l,B,"music",true)}}},4);A.MusicInserter||function(){function l(){l.superclass.constructor.apply(this,arguments)}function f(b){return b._4e_name()==="img"&&!!b.hasClass(B)&&b}function m(b){return b.replace(/^.+niftyplayer\.swf\?file=/,
"")}var p=A.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"',o=/#\(music\)/g,r=["img."+B];u.extend(l,x,{_config:function(){this._cls=B;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml="<p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3'/></label></p><p style='margin:5px 0'><label>\u5bf9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u9f50\uff1a <select class='ke-music-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select><p>";
this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=a;this._flashRules=r},_initD:function(){var b=this,g=b.d;b.dUrl=g.el.one(".ke-music-url");b.dAlign=g.el.one(".ke-music-align");var h=g.el.one(".ke-music-ok");g=g.el.one(".ke-music-cancel");h.on("click",b._gen,b);g.on("click",function(){b.d.hide()})},_getDInfo:function(){return{url:p.replace(o,
this.dUrl.val()),attrs:{width:165,height:37,align:this.dAlign.val()}}},_getFlashUrl:function(b){return m(s(b))},_updateD:function(){var b=this.editor,g=this.selectedFlash;if(g){this.dUrl.val(this._getFlashUrl(b.restoreRealElement(g)));this.dAlign.val(g.attr("align"))}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3");this.dAlign.val("")}}});x.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",f);A.MusicInserter=l;var a={"\u97f3\u4e50\u5c5e\u6027":function(b){var g=b.getSelection();
g=(g=g&&g.getStartElement())&&f(g);b=b._toolbars.music;g&&b.show(null,g)}}}();w.addPlugin(function(){new A.MusicInserter(w)})});
KISSY.Editor.add("preview",function(w){var t=KISSY.Editor,A=KISSY,u=t.TripleButton;t.Preview||function(){function x(B){this.editor=B;this._init()}A.augment(x,{_init:function(){this.el=new u({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,q=640,s=420,i=80;try{var e=window.screen;q=Math.round(e.width*0.8);s=Math.round(e.height*0.7);i=Math.round(e.width*0.1)}catch(l){}B=
B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+B.getData()+"\n</body>");q=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+q+",height="+s+",left="+i);q.document.open();q.document.write(B);q.document.close()}});t.Preview=x}();w.addPlugin(function(){new t.Preview(w)})});
KISSY.Editor.add("removeformat",function(w){function t(f){this.editor=f;this._init()}function A(f,m){for(var p=0;p<m.length;p++)f.removeAttr(m[p])}var u=KISSY.Editor,x=KISSY,B=u.RANGE,q=u.ElementPath,s=u.NODE,i=u.TripleButton,e="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",l="class,style,lang,width,height,align,hspace,valign".split(",");e=new RegExp("^(?:"+e.replace(/,/g,"|")+")$","i");x.augment(t,{_init:function(){this.el=new i({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var f=this.editor,m=e;m.lastIndex=0;var p=f.getSelection().getRanges();f.fire("save");for(var o=0,r;r=p[o];o++)if(!r.collapsed){r.enlarge(B.ENLARGE_ELEMENT);var a=r.createBookmark(),b=a.startNode,g=a.endNode,h=function(k){for(var j=new q(k),c=j.elements,d=1,n;n=c[d];d++){if(n._4e_equals(j.block)||n._4e_equals(j.blockLimit))break;m.test(n._4e_name())&&k._4e_breakParent(n)}};
h(b);h(g);for(b=b._4e_nextSourceNode(true,s.NODE_ELEMENT);b;){if(b._4e_equals(g))break;h=b._4e_nextSourceNode(false,s.NODE_ELEMENT);b._4e_name()=="img"&&b.attr("_cke_realelement")||(m.test(b._4e_name())?b._4e_remove(true):A(b,l));b=h}r.moveToBookmark(a)}f.getSelection().selectRanges(p);f.fire("save")}});w.addPlugin(function(){new t(w)})});
KISSY.Editor.add("smiley",function(w){var t=KISSY.Editor,A=KISSY,u=A.DOM,x=A.Event,B=A.Node,q=t.SimpleOverlay,s=t.TripleButton;t.Smiley||function(){function i(f){this.editor=f;this._init()}for(var e="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",l=0;l<=98;l++)e+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+l+".gif'></a>";e+="</div></div>";A.augment(i,{_init:function(){this.el=new s({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);t.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(f){var m=this;u._4e_ascendant(f.target,function(p){return p[0]===m.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(f){f.halt();var m=this.editor;f=f.target;var p;if(u._4e_name(f)=="a"&&(p=u.attr(f,"data-icon"))){p=new B("<img alt='' style='width:52px;height:48px;' src='"+p+"'/>",null,m.document);m.insertElement(p);this.smileyWin.hide()}},_prepare:function(){var f=this.editor;this.smileyPanel=
new B(e);this.smileyWin=new q({el:this.smileyPanel,focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);x.on(document,"click",this._hidePanel,this);x.on(f.document,"click",this._hidePanel,this)},_real:function(){var f=this.el.el.offset();f.top+=this.el.el.height()+5;if(f.left+this.smileyPanel.width()>u.viewportWidth()-60)f.left=u.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(f)},_show:function(f){this._prepare(f)}});
t.Smiley=i}();w.addPlugin(function(){new t.Smiley(w)})});
KISSY.Editor.add("sourcearea",function(w){var t=KISSY.Editor,A=KISSY,u=A.UA,x=t.TripleButton;t.SourceArea||function(){function B(q){this.editor=q;this._init()}A.augment(B,{_init:function(){var q=this.editor;this.el=new x({container:q.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);q.textarea.on("mousedown",function(s){s.stopPropagation()})},_show:function(){var q=this.editor,s=
this.el;q.textarea.val(q.getData());q._showSource();s.set("state",x.ON)},_hide:function(){var q=this.editor,s=q.textarea,i=this.el;q._hideSource();q.setData(s.val());if(u.gecko&&q.iframeFocus){i.el[0].focus();q.focus()}i.set("state",x.OFF)}});t.SourceArea=B}();w.addPlugin(function(){new t.SourceArea(w)})});
KISSY.Editor.add("table",function(w,t){var A=KISSY.Editor,u=KISSY,x=u.Node,B=u.DOM,q=A.Walker,s=u.UA,i=A.NODE,e=A.TripleButton,l=A.SimpleOverlay,f=A.ContextMenu,m=["tr","th","td","tbody","table"],p=u.trim,o;o=(s.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var r=w.htmlDataProcessor,a=r&&r.dataFilter;r=r&&r.htmlFilter;a&&a.addRules({elements:{table:function(b){b=b.attributes;var g=b["class"],h=parseInt(b.border,10);if(!h||h<=0)b["class"]=(g||"")+" ke_show_border"}}});r&&r.addRules({elements:{table:function(b){b=b.attributes;var g=b["class"];if(g)b["class"]=u.trim(g.replace("ke_show_border","").replace(/\s{2}/," "))}}});A.TableUI||function(){function b(z){this.editor=z;this.selectedTable=
null;z._toolbars=z._toolbars||{};z._toolbars.table=this;this._init()}function g(z){return p(z).length!=0}function h(z){function C($){if(!(N.length>0))if($[0].nodeType==i.NODE_ELEMENT&&D.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var I=z.createBookmarks(),J=z.getRanges(),N=[],M={},Q=0;Q<J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new q(R);
var W;for(R.guard=C;W=R.next();)if((W=W.parent())&&D.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}A.Utils.clearAllMarkers(M);z.selectBookmarks(I);return N}function k(z){z=z.cells;for(var C=0;C<z.length;C++){z[C].innerHTML="";s.ie||(new x(z[C]))._4e_appendBogus()}}function j(z,C){if(z=z.getStartElement()._4e_ascendant("tr")){var I=z._4e_clone(true);I.insertBefore(z);k(C?I[0]:z[0])}}function c(z){if(z instanceof A.Selection){var C=h(z),I=C.length;
z=[];for(var J,N,M=0;M<I;M++){var Q=C[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);z[R]=Q;M==I-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new x(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=z.length;M>=0;M--)z[M]&&c(z[M]);return J}else if(z instanceof x){M=z._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():z._4e_remove()}return 0}function d(z,C){z=z.getStartElement();if(z=z._4e_ascendant("td",true)||z._4e_ascendant("th",true))for(var I=z._4e_ascendant("table"),J=z[0].cellIndex,
N=0;N<I[0].rows.length;N++){var M=I[0].rows[N];if(!(M.cells.length<J+1)){z=new x(M.cells[J].cloneNode(false));s.ie||z._4e_appendBogus();M=new x(M.cells[J]);C?z.insertBefore(M):z.insertAfter(M)}}}function n(z){var C=[],I=z[0]&&z[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=z.length;J<N;J++)C.push(z[J][0].cellIndex);C.sort();J=1;for(N=C.length;J<N;J++)if(C[J]-C[J-1]>1){M=C[J-1]+1;break}M||(M=C[0]>0?C[0]-1:C[C.length-1]+1);z=I[0].rows;J=0;for(N=z.length;J<N;J++)if(Q=z[J].cells[M])break;return Q?new x(Q):
I._4e_previous()}function y(z){if(z instanceof A.Selection){var C=h(z),I=n(C);for(z=C.length-1;z>=0;z--)C[z]&&y(C[z]);return I}else if(z instanceof x){C=z._4e_ascendant("table");if(!C)return null;I=z[0].cellIndex;for(z=C[0].rows.length-1;z>=0;z--){var J=new x(C[0].rows[z]);if(!I&&J[0].cells.length==1)c(J);else J[0].cells[I]&&J[0].removeChild(J[0].cells[I])}}return null}function v(z,C){var I=new A.Range(z[0].ownerDocument);if(!I.moveToElementEditablePosition(z,C?true:t)){I.selectNodeContents(z);I.collapse(C?
false:true)}I.select(true)}u.augment(b,{_init:function(){var z=this.editor,C={};this.el=new e({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:z.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in H)(function(J){C[J]=function(){z.fire("save");H[J](z);z.fire("save")}})(I);f.register(z.document,{rules:m,width:"120px",funcs:C});A.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var z=this,C=new l({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});
C.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
C.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");C.twidth=C.body.one(".ke-table-width");C.theight=C.body.one(".ke-table-height");C.tcellspacing=C.body.one(".ke-table-cellspacing");C.tcellpadding=C.body.one(".ke-table-cellpadding");C.tborder=C.body.one(".ke-table-border");C.tcaption=C.body.one(".ke-table-caption");C.talign=C.body.one(".ke-table-align");C.trows=C.body.one(".ke-table-rows");C.tcols=C.body.one(".ke-table-cols");C.thead=
C.body.one(".ke-table-head");var I=C.foot.one(".ke-table-ok"),J=C.foot.one(".ke-table-cancel");C.twidthunit=C.body.one(".ke-table-width-unit");z.tableDialog=C;I.on("click",z._tableOk,z);C.on("hide",function(){z.selectedTable=null});J.on("click",function(){C.hide()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var z=this.tableDialog,C=this.selectedTable,I=C.one("caption");g(z.talign.val())&&C.attr("align",p(z.talign.val()));g(z.tcellspacing.val())&&
C.attr("cellspacing",p(z.tcellspacing.val()));g(z.tcellpadding.val())&&C.attr("cellpadding",p(z.tcellpadding.val()));g(z.tborder.val())&&C.attr("border",p(z.tborder.val()));!g(z.tborder.val())||z.tborder.val()=="0"?C.addClass("ke_show_border"):C.removeClass("ke_show_border");g(z.twidth.val())&&C.css("width",p(z.twidth.val())+z.twidthunit.val());g(z.theight.val())&&C.css("height",p(z.theight.val()));if(g(z.tcaption.val()))I&&I[0]?I.html(p(z.tcaption.val())):(new x("<caption><span>"+p(z.tcaption.val())+
"</span></caption>")).insertBefore(C[0].firstChild);else I&&I._4e_remove();z.hide()},_genTable:function(){var z=this.tableDialog,C="<table ",I,J=parseInt(z.tcols.val())||1,N=parseInt(z.trows.val())||1,M=s.ie?"":"<br/>",Q=this.editor;if(u.trim(z.talign.val()).length!=0)C+="align='"+u.trim(z.talign.val())+"' ";if(u.trim(z.tcellspacing.val()).length!=0)C+="cellspacing='"+u.trim(z.tcellspacing.val())+"' ";if(u.trim(z.tcellpadding.val()).length!=0)C+="cellpadding='"+u.trim(z.tcellpadding.val())+"' ";if(u.trim(z.tborder.val()).length!=
0)C+="border='"+u.trim(z.tborder.val())+"' ";if(u.trim(z.twidth.val()).length!=0||u.trim(z.theight.val()).length!=0){C+="style='";if(u.trim(z.twidth.val()).length!=0)C+="width:"+u.trim(z.twidth.val())+z.twidthunit.val()+";";if(u.trim(z.theight.val()).length!=0)C+="height:"+u.trim(z.theight.val())+"px;";C+="' "}if(u.trim(z.tborder.val()).length==0||u.trim(z.tborder.val())=="0")C+="class='ke_show_border' ";C+=">";if(u.trim(z.tcaption.val()))C+="<caption><span>"+u.trim(z.tcaption.val())+"</span></caption>";
if(z.thead.val()){C+="<thead>";C+="<tr>";for(I=0;I<J;I++)C+="<th>"+M+"</th>";C+="</tr>";C+="</thead>";N-=1}C+="<tbody>";for(var R=0;R<N;R++){C+="<tr>";for(I=0;I<J;I++)C+="<td>"+M+"</td>";C+="</tr>"}C+="</tbody>";C+="</table>";C=new x(C,null,Q.document);Q.insertElement(C);z.hide()},_fillTableDialog:function(){var z=this.tableDialog,C=this.selectedTable,I=C.one("caption");z.talign.val(C.attr("align")||"");z.tcellspacing.val(C.attr("cellspacing")||"");z.tcellpadding.val(C.attr("cellpadding")||"");z.tborder.val(C.attr("border")|
"");var J=C._4e_style("width")||"";z.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?z.twidthunit.val("%"):z.twidthunit.val("px");z.theight.val((C._4e_style("height")||"").replace(/px|%/i,""));J="";if(I)J=I.text();z.tcaption.val(J);z.trows.val(C.one("tbody").children().length);z.tcols.val(C.one("tr").children().length);z.thead.val(C._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled",
"disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var D=/^(?:td|th)$/,H={"\u8868\u683c\u5c5e\u6027":function(z){var C=z.getSelection();if(C=(C=C&&C.getStartElement())&&C._4e_ascendant("table",true)){z=z._toolbars.table;z.selectedTable=C;z._tableShow()}},"\u5220\u9664\u8868\u683c":function(z){var C=(z=z.getSelection())&&z.getStartElement();
if(C=C&&C._4e_ascendant("table",true)){z.selectElement(C);var I=z.getRanges()[0];I.collapse();z.selectRanges([I]);z=C.parent();z[0].childNodes.length==1&&z._4e_name()!="body"?z._4e_remove():C._4e_remove()}},"\u5220\u9664\u884c ":function(z){z=z.getSelection();v(c(z),t)},"\u5220\u9664\u5217 ":function(z){z=z.getSelection();(z=y(z))&&v(z,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(z){z=z.getSelection();j(z,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(z){z=z.getSelection();j(z,t)},
"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(z){z=z.getSelection();d(z,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(z){z=z.getSelection();d(z,t)}};A.TableUI=b}();w.addPlugin(function(){var b=w.document;new A.TableUI(w);var g=B.create("<style>",null,b);b.getElementsByTagName("head")[0].appendChild(g);if(g.styleSheet)g.styleSheet.cssText=o;else g.appendChild(b.createTextNode(o))})});
KISSY.Editor.add("templates",function(w){var t=KISSY.Editor,A=KISSY,u=A.Node,x=t.TripleButton,B=t.SimpleOverlay;t.TplUI||function(){function q(s){this.editor=s;this._init()}A.augment(q,{_init:function(){(new x({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);t.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var s=this.editor,i=s.cfg.pluginConfig.templates,e="<div class='ke-tpl'>",l=0;l<i.length;l++)e+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
i[l].demo+"</a>";e+="</div>";this._initDialogOk=true;var f=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});f.body.html(e);f.body.all(".ke-tpl-list").on("click",function(m){m.halt();m=(new u(m.target))._4e_index();m!=-1&&s.insertHtml(i[m].html);f.hide()});this.ui=f},_real:function(){this.ui.show()},_show:function(){this._prepare()}});t.TplUI=q}();w.addPlugin(function(){new t.TplUI(w)})});
KISSY.Editor.add("undo",function(w){var t=KISSY.Editor,A=KISSY,u=t.Utils.arrayCompare,x=A.UA,B=A.Event;t.UndoManager||function(){function q(o){var r=o._getRawData();o=r&&o.getSelection();this.contents=r;this.bookmarks=o&&o.createBookmarks2(true)}function s(o,r,a){this.s=o;this.fn=r;this.scope=a||window;this.bufferTimer=null}function i(o){this.history=[];this.index=0;this.editor=o;this.bufferTimer=new s(500,this.save,this);this._init()}function e(o,r,a,b){this.editor=o;this.title=a;this.text=r;this.contentCls=
b;this._init()}A.augment(q,{equals:function(o){if(this.contents!=o.contents)return false;var r=this.bookmarks;o=o.bookmarks;if(r||o){if(!r||!o||r.length!=o.length)return false;for(var a=0;a<r.length;a++){var b=r[a],g=o[a];if(b.startOffset!=g.startOffset||b.endOffset!=g.endOffset||!u(b.start,g.start)||!u(b.end,g.end))return false}}return true}});A.augment(s,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var o=this;this.bufferTimer=setTimeout(function(){o.fn.call(o.scope)},
this.s)}});var l={16:1,17:1,18:1},f={37:1,38:1,39:1,40:1};A.augment(i,{_keyMonitor:function(){var o=this.editor;B.on(o.document,"keydown",function(r){var a=r.keyCode;if(!(a in f||a in l))if(a===90&&(r.ctrlKey||r.metaKey)){o.fire("restore",{d:-1});r.halt()}else if(a===89&&(r.ctrlKey||r.metaKey)){o.fire("restore",{d:1});r.halt()}else o.fire("save",{buffer:1})})},_init:function(){var o=this,r=o.editor;r.on("save",function(a){a.buffer?o.bufferTimer.run():o.save()});r.on("restore",this.restore,this);o._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var o=this.editor,r=this.history.length>0?this.history[this.history.length-1]:null,a=new q(this.editor);if(!r||!r.equals(a)){this.history.length===30&&this.history.shift();this.history.push(a);this.index=this.history.length-1;o.fire("afterSave",{history:this.history,index:this.index})}},restore:function(o){o=o.d;var r=this.editor,a=this.history.length>0?this.history[this.index+o]:null;
if(a){r._setRawData(a.contents);if(a.bookmarks)this.editor.getSelection().selectBookmarks(a.bookmarks);else if(x.ie){a=this.editor.document.body.createTextRange();a.collapse(true);a.select()}this.index+=o;r.fire("afterRestore",{history:this.history,index:this.index});r.notifySelectionChange()}}});var m=t.TripleButton,p={redo:1,undo:-1};A.augment(e,{_init:function(){var o=this,r=o.editor;o.el=new m({contentCls:o.contentCls,title:o.title,container:r.toolBarDiv});this.el.set("state",m.DISABLED);r.on("afterSave",
this._respond,this);r.on("afterRestore",this._respond,this);o.el.on("offClick",function(){r.fire("restore",{d:p[o.text]})})},_respond:function(o){this.updateUI(o.history,o.index)},updateUI:function(o,r){if(this.text=="undo")r>0&&o.length>0?this.el.set("state",m.OFF):this.el.set("state",m.DISABLED);else if(this.text=="redo")r<o.length-1?this.el.set("state",m.OFF):this.el.set("state",m.DISABLED)}});t.UndoManager=i;t.RestoreUI=e}();w.addPlugin(function(){new t.UndoManager(w);new t.RestoreUI(w,"undo",
"\u64a4\u9500","ke-toolbar-undo");new t.RestoreUI(w,"redo","\u91cd\u505a","ke-toolbar-redo")})});
