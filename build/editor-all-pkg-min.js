KISSY.add("editor",function(x,r){function A(h,k){var u=this;if(!(u instanceof A))return new A(h,k);if(x.isString(h))h=x.one(h);h[0]||(h=new Node(h));k=k||{};k.pluginConfig=k.pluginConfig||{};u.cfg=k;x.app(u,x.EventTarget);u.use=function(b){if(x.isString(b))b=b.split(",");var c=b;b=[];b=x.indexOf("separator",c);var g=b!=-1;b=c.splice(0,g?b+1:c.length);g&&b.pop();b.length!=0?x.use.call(u,b.join(","),function(){g&&u.addPlugin(function(){A.Utils.addSeparator(u.toolBarDiv)});u.use(c)},{order:true,global:A}):
u.on("dataReady",function(){u.setData(h.val());u.fire("save")});return u};u.init(h);return r}function s(h){if(!w)return h.replace(/\.(js|css)/i,"-min.$1");if(w==="dev")return"../src/"+h;return h}x.app(A,x.EventTarget);A.Config.base=x.Config.base+"editor/";var w=x.Config.debug,B={htmlparser:{attach:false,path:s("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},p=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],t=["flashutils",
"clipboard",{name:"color"},{name:"elementpaths"},"enterkey",{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["flashutils","contextmenu","fakeobjects","overlay","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview"]},"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize",{name:"music",
requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],i=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},
{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],d,l,n,q;d=0;for(l=t.length;d<l;d++){n=t[d];if(x.isString(n))n=t[d]={name:n};n.requires=n.requires||[];n.requires=n.requires.concat(["button"])}t=[{name:"button"},{name:"dd"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(t);d=0;for(l=t.length;d<l;d++){n=t[d];q=n.name;B[q]=
{attach:false,requires:n.requires,csspath:n.useCss?s("plugins/"+q+"/plugin.css"):r,path:s("plugins/"+q+"/plugin.js")}}d=0;for(l=i.length;d<l;d++){n=i[d];t=r;if(!x.isString(n)){t=n.requires;n=n.name}B[n]={attach:false,requires:t,path:s("plugins/htmldataprocessor/htmlparser/"+n.substring(11)+".js")}}d=0;for(l=p.length;d<l;d++){n=p[d];B[n]={host:"editor",requires:d>0?p[d-1]:[]}}A.add(B);x.Editor=A});
KISSY.Editor.add("utils",function(x){var r=KISSY,A=r.Node,s=r.DOM,w=r.Config.debug,B=r.UA;x.Utils={debugUrl:function(p){if(!w)return p.replace(/\.(js|css)/i,"-min.$1");if(w==="dev")return"../src/"+p;return p},lazyRun:function(p,t,i){var d=p[t],l=p[i];p[t]=function(){d.apply(this,arguments);p[t]=p[i];return l.apply(this,arguments)}},getXY:function(p,t,i,d){i=i.defaultView||i.parentWindow;p-=s.scrollLeft(i);t-=s.scrollTop(i);if(d)if(i!=(d.defaultView||d.parentWindow)&&i.frameElement){d=s._4e_getOffset(i.frameElement,
d);p+=d.left;t+=d.top}return{left:p,top:t}},tryThese:function(){for(var p,t=0,i=arguments.length;t<i;t++){var d=arguments[t];try{p=d();break}catch(l){}}return p},arrayCompare:function(p,t){if(!p&&!t)return true;if(!p||!t||p.length!=t.length)return false;for(var i=0;i<p.length;i++)if(p[i]!==t[i])return false;return true},getByAddress:function(p,t,i){p=p.documentElement;for(var d=0;p&&d<t.length;d++){var l=t[d];if(i)for(var n=-1,q=0;q<p.childNodes.length;q++){var h=p.childNodes[q];if(!(i===true&&h.nodeType==
3&&h.previousSibling&&h.previousSibling.nodeType==3)){n++;if(n==l){p=h;break}}}else p=p.childNodes[l]}return p?new A(p):null},clearAllMarkers:function(p){for(var t in p)p[t]._4e_clearMarkers(p,true)},htmlEncodeAttr:function(p){return p.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(p){return p.replace(/^\s+/,"")},rtrim:function(p){return p.replace(/\s+$/,"")},trim:function(p){return this.ltrim(this.rtrim(p))},mix:function(){for(var p={},t=0;t<arguments.length;t++)p=
r.mix(p,arguments[t]);return p},isCustomDomain:function(){if(!B.ie)return false;var p=document.domain,t=window.location.hostname;return p!=t&&p!="["+t+"]"},addSeparator:function(p){(new r.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(p)},duplicateStr:function(p,t){return(new Array(t+1)).join(p)},throttle:function(p,t,i){i=i||150;if(i===-1)return function(){p.apply(t,arguments)};var d=(new Date).getTime();return function(){var l=(new Date).getTime();if(l-d>i){d=l;p.apply(t,arguments)}}},
buffer:function(p,t,i){i=i||0;var d=null;return function(){d&&clearTimeout(d);var l=arguments;d=setTimeout(function(){return p.apply(t,l)},i)}},isNumber:function(p){return/^\d+(.\d+)?$/.test(r.trim(p))}}});
KISSY.Editor.add("focusmanager",function(x){function r(){this.iframeFocus=true;t=this}function A(){this.iframeFocus=false;t=null}var s=KISSY,w=s.DOM,B=s.Event;s={};var p={},t;s={refreshAll:function(){for(var i in p){var d=p[i];d.document.designMode="off";d.document.designMode="on"}},currentInstance:function(){return t},getInstance:function(i){return p[i]},add:function(i){var d=w._4e_getWin(i.document);B.on(d,"focus",r,i);B.on(d,"blur",A,i)},register:function(i){p[i._UUID]=i},remove:function(i){delete p[i._UUID];
var d=w._4e_getWin(i.document);B.remove(d,"focus",r,i);B.remove(d,"blur",A,i)}};x.focusManager=s});
KISSY.Editor.add("definition",function(x){function r(k){return d+"<html><head><title>kissy-editor</title><link href='"+x.Config.base+l+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(k?'<script id="ke_actscrpt" type="text/javascript">'+(x.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+k+'");<\/script>':"")}var A=KISSY,s=A.UA,w=A.DOM,B=A.Node,p=A.Event,t=x.focusManager,i=x.Utils.tryThese,d="<!doctype html>",l=
x.Utils.debugUrl("theme/editor-iframe.css"),n=1,q="document.open();"+(x.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",h="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(s.ie?"javascript:void(function(){"+encodeURIComponent(q)+"}())":"")+'"  tabIndex="'+
(s.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";A.augment(x,{init:function(k){var u=this,b=new B(h.replace(/\$\(tabIndex\)/,k.attr("tabIndex")));b.on("mousedown",function(f){if(s.webkit){var m=w._4e_name(f.target);if(m=="select"||m=="option")return true}f.halt()});u.editorWrap=b;u._UUID=n++;t.register(u);u.wrap=b.one(".ke-textarea-wrap");u.iframe=u.wrap.one("iframe");u.toolBarDiv=b.one(".ke-editor-tools");u.textarea=
k;u.statusDiv=b.one(".ke-editor-status");u.toolBarDiv._4e_unselectable();u._commands={};u._plugins={};var c=k._4e_style("width"),g=k._4e_style("height");if(c){b.css("width",c);k.css("width","100%")}u.textarea.css("display","none");b.insertAfter(k);u.wrap[0].appendChild(k[0]);if(g){u.wrap.css("height",g);k.css("height","100%")}k=u.iframe;u.on("dataReady",function(){u.ready=true;x.fire("instanceCreated",{editor:u})});s.gecko?k.on("load",u._setUpIFrame,u):u._setUpIFrame()},addCommand:function(k,u){this._commands[k]=
u},execCommand:function(k){this.fire("save");this._commands[k].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(k){if(this.htmlDataProcessor)k=this.htmlDataProcessor.toDataFormat(k,"p");this.document.body.innerHTML=k},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(k){this.document.body.innerHTML=
k},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");s.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:r,getSelection:function(){var k=new x.Selection(this.document);return!k||k.isInvalid?null:k},focus:function(){var k=w._4e_getWin(this.document);s.webkit&&k&&k.parent&&k.parent.focus();k&&k.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){w._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function k(){f=g.document;u.document=f;b.detach();f.open("text/html","replace");f.write(c);f.close()}
var u=this,b=u.iframe,c=r(u._UUID),g=b[0].contentWindow,f;try{f=g.document}catch(m){b[0].src=b[0].src;if(s.ie&&s.ie<7){setTimeout(k,10);return}}k()},addPlugin:function(k){this.ready?k():this.on("dataReady",k)},_monitor:function(){var k=this;k._monitorId&&clearTimeout(k._monitorId);k._monitorId=setTimeout(function(){var u=k.getSelection();if(u&&!u.isInvalid){u=u.getStartElement();var b=new x.ElementPath(u);if(!k.previousPath||!k.previousPath.compare(b)){k.previousPath=b;k.fire("selectionChange",{selection:k,
path:b,element:u})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(k,u){var b=this;b.focus();var c=k._4e_name(),g=x.XHTML_DTD,f=x.RANGE,m=x.NODE,j=g.$block[c],a=b.getSelection(),e=a.getRanges(),o,v,y,C,H;b.fire("save");for(var N=e.length-1;N>=0;N--){o=e[N];o.deleteContents();v=!N&&k||k._4e_clone(true);u&&u(v);if(j)for(;(C=o.getCommonAncestor(false,true))&&(H=g[C._4e_name()])&&!(H&&H[c]);)if(C._4e_name()in g.span)o.splitElement(C);else if(o.checkStartOfBlock()&&
o.checkEndOfBlock()){o.setStartBefore(C);o.collapse(true);C._4e_remove()}else o.splitBlock();o.insertNode(v);y||(y=v)}k=y._4e_nextSourceNode(true);u=b.document;H=x.XHTML_DTD;if(H.$inline[v._4e_name()]){k=new B(u.createTextNode(" "));k.insertAfter(y)}else if(k){if(k._4e_name()=="br"&&H[k.parent()._4e_name()].p){H=new B("<p>&nbsp;</p>",null,u);k[0].parentNode.replaceChild(H[0],k[0]);k=H}}else{H=new B("<p>&nbsp;</p>",null,u);H.insertAfter(y);k=H}o.moveToPosition(y,f.POSITION_AFTER_END);k&&k[0].nodeType==
m.NODE_ELEMENT&&o.moveToElementEditablePosition(k);a.selectRanges([o]);b.focus();v&&v._4e_scrollIntoView();setTimeout(function(){b.fire("save")},10);return v},insertHtml:function(k){var u=this;if(u.htmlDataProcessor)k=u.htmlDataProcessor.toDataFormat(k);if(s.webkit){k=w.create(k,null,this.document);k=k.nodeType==11?A.makeArray(k.childNodes):[k];for(var b=0;b<k.length;b++)u.insertElement(new B(k[b]))}else{u.focus();u.fire("save");b=u.getSelection();if(s.ie){b=b.getNative();b.type=="Control"&&b.clear();
b.createRange().pasteHTML(k)}else u.document.execCommand("inserthtml",false,k);u.focus();setTimeout(function(){u.fire("save")},10)}}});x._initIFrame=function(k){function u(v){i(function(){g.designMode="on";setTimeout(function(){g.designMode="off";j.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){g.designMode="off";w.attr(j,"contentEditable",false);w.attr(j,"contentEditable",true);!v&&u(1)})}var b=t.getInstance(k);k=b.textarea[0];var c=b.iframe[0].contentWindow,g=b.document,
f=b.cfg,m=g.getElementById("ke_actscrpt");m.parentNode.removeChild(m);var j=g.body;if(s.ie){j.hideFocus=true;j.disabled=true;j.contentEditable=true;j.removeAttribute("disabled")}else setTimeout(function(){if(s.gecko||s.opera)j.contentEditable=true;else if(s.webkit)j.parentNode.contentEditable=true;else g.designMode="on"},0);if(s.webkit){p.on(g,"click",function(v){var y=new B(v.target);A.inArray(y._4e_name(),["input","select"])&&v.preventDefault()});p.on(g,"mouseup",function(v){var y=new B(v.target);
A.inArray(y._4e_name(),["input","textarea"])&&v.preventDefault()})}if(s.gecko||s.ie||s.opera){var a;a=new B(w.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],k));a.on("focus",function(){b.focus()});b.on("destroy",function(){})}if(s.ie&&g.compatMode=="CSS1Compat"||s.gecko||s.opera){var e=new B(g.documentElement);e.on("mousedown",function(v){if(v.target===e[0]){s.gecko&&u(false);a[0].focus()}})}p.on(c,"focus",function(){if(s.gecko)u(false);else s.opera&&j.focus();b.notifySelectionChange()});
s.gecko&&p.on(b.document,"mousedown",function(){b.iframeFocus||u(false)});if(s.ie){p.on(g,"keydown",function(v){if(v.keyCode in{8:1,46:1}){var y=b.getSelection(),C=y.getSelectedElement();if(C){b.fire("save");var H=y.getRanges()[0].createBookmark();C._4e_remove();y.selectBookmarks([H]);b.fire("save");v.preventDefault()}}});if(g.compatMode=="CSS1Compat"){var o={33:1,34:1};p.on(g,"keydown",function(v){v.keyCode in o&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}}setTimeout(function(){s.ie&&
setTimeout(function(){if(g){j.runtimeStyle.marginBottom="0px";j.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.fire("dataReady");var v=f.disableObjectResizing,y=f.disableInlineTableEditing;if(v||y)try{g.execCommand("enableObjectResizing",false,!v);g.execCommand("enableInlineTableEditing",false,!y)}catch(C){p.on(j,s.ie?"resizestart":"resize",function(H){if(v||w._4e_name(H.target)==="table"&&y)H.preventDefault()})}},10);s.webkit&&p.on(g,"mousedown",function(v){v=new B(v.target);A.inArray(v._4e_name(),
["img","hr","input","textarea","select"])&&b.getSelection().selectElement(v)});t.add(b)};s.gecko&&function(){var k=document.body;if(k){var u=k.getAttribute("onpageshow");k.setAttribute("onpageshow",(u?u+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(x){x.XHTML_DTD=function(){var r=function(j){for(var a=arguments.length-1;a>0;)KISSY.mix(j,arguments[a--]);return j},A={isindex:1,fieldset:1},s={input:1,button:1,select:1,textarea:1,label:1},w=r({a:1},s),B=r({iframe:1},w),p={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},t={ins:1,del:1,script:1,style:1},i=r({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},t),d=r({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},i),l=r({p:1},d);s=r({iframe:1},d,s);d={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var n=r({a:1},s),q={tr:1},h={"#":1},k=r({param:1},d),u=r({form:1},A,B,p,l),b={li:1},c={base:1,link:1,meta:1,title:1},g=r(c,{style:1,script:1}),f={head:1,body:1},m={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:r({html:1},f,c),$block:m,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:n,$body:r({script:1,style:1},m),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:f,head:g,style:h,body:u,base:{},link:{},meta:{},title:h,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:u,td:u,br:{},th:u,center:u,kbd:n,button:r(l,p),basefont:{},h5:n,h4:n,samp:n,h6:n,ol:b,h1:n,h3:n,option:h,h2:n,form:r(A,B,p,l),select:{optgroup:1,option:1},font:n,ins:n,menu:b,abbr:n,label:n,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:n,script:h,tfoot:q,cite:n,li:u,input:{},iframe:u,strong:n,textarea:h,noframes:u,big:n,small:n,span:n,hr:{},dt:n,sub:n,optgroup:{option:1},param:{},bdo:n,"var":n,div:u,object:k,sup:n,dd:u,strike:n,area:{},dir:b,map:r({area:1,form:1,p:1},A,t,p),applet:k,dl:{dt:1,dd:1},del:n,isindex:{},fieldset:r({legend:1},d),thead:q,ul:b,acronym:n,b:n,a:s,blockquote:u,caption:n,i:n,u:n,tbody:q,s:n,address:r(B,l),tt:n,legend:n,q:n,pre:r(i,w),p:n,em:n,dfn:n}}()});
KISSY.Editor.add("dom",function(x){function r(b){return b.replace(/-(\w)/g,function(c,g){return g.toUpperCase()})}var A=KISSY,s=A.DOM,w=A.UA,B=A.Node,p=x.Utils,t={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};x.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};x.POSITION={};var i=x.NODE,d=x.POSITION;d.POSITION_IDENTICAL=0;d.POSITION_DISCONNECTED=
1;d.POSITION_FOLLOWING=2;d.POSITION_PRECEDING=4;d.POSITION_IS_CONTAINED=8;d.POSITION_CONTAINS=16;var l={},n={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},q={hr:1},h=function(b){return b[0]||b},k=function(b){if(!b[0])return new B(b);return b},u={_4e_equals:function(b,c){if(!b&&!c)return true;if(!b||!c)return false;b=h(b);c=h(c);return b===c},_4e_isBlockBoundary:function(b,
c){b=k(b);c=A.mix(A.mix({},q),c||{});return n[b.css("display")]||c[b._4e_name()]},_4e_getWin:function(b){return b&&"scrollTo"in b&&b.document?b:b&&b.nodeType===9?b.defaultView||b.parentWindow:false},_4e_index:function(b){b=h(b);for(var c=b.parentNode.childNodes,g=0;g<c.length;g++)if(c[g]===b)return g;return-1},_4e_first:function(b,c){b=h(b);if((b=(b=b.firstChild)&&new B(b))&&c&&!c(b))b=b._4e_next(c);return b},_4e_move:function(b,c,g){b._4e_remove();b=h(b);c=h(c);g?c.insertBefore(b,c.firstChild):c.appendChild(b)},
_4e_name:function(b){b=h(b);var c=b.nodeName.toLowerCase();if(w.ie)if((b=b.scopeName)&&b!="HTML")c=b.toLowerCase()+":"+c;return c},_4e_isIdentical:function(b,c){if(b._4e_name()!=c._4e_name())return false;var g=b[0].attributes,f=c[0].attributes,m=g.length,j=f.length;if(!w.ie&&m!=j)return false;for(var a=0;a<m;a++){var e=g[a];if((!w.ie||e.specified&&e.nodeName!="_ke_expando")&&e.nodeValue!=c.attr(e.nodeName))return false}if(w.ie)for(a=0;a<j;a++){e=f[a];if(e.specified&&e.nodeName!="_ke_expando"&&e.nodeValue!=
b.attr(e.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(b){b=h(b).childNodes;for(var c=0,g=b.length;c<g;c++){var f=b[c],m=f.nodeType;if(!(m==i.NODE_ELEMENT&&f.getAttribute("_ke_bookmark")))if(m==i.NODE_ELEMENT&&!u._4e_isEmptyInlineRemoveable(f)||m==i.NODE_TEXT&&A.trim(f.nodeValue))return false}return true},_4e_moveChildren:function(b,c,g){b=h(b);c=c[0]||c;if(b!=c)if(g)for(;g=b.lastChild;)c.insertBefore(b.removeChild(g),c.firstChild);else for(;g=b.firstChild;)c.appendChild(b.removeChild(g))},
_4e_mergeSiblings:function(){function b(c,g,f){if(g[0]&&g[0].nodeType==i.NODE_ELEMENT){for(var m=[];g.attr("_ke_bookmark")||g._4e_isEmptyInlineRemoveable();){m.push(g);g=f?new B(g[0].nextSibling):new B(g[0].previousSibling);if(!g[0]||g[0].nodeType!=i.NODE_ELEMENT)return}if(c._4e_isIdentical(g)){for(var j=f?c[0].lastChild:c[0].firstChild;m.length;)m.shift()._4e_move(c,!f);g._4e_moveChildren(c,!f);g._4e_remove();j[0]&&j[0].nodeType==i.NODE_ELEMENT&&j._4e_mergeSiblings()}}}return function(c){if(c[0])if(t[c._4e_name()]||
c._4e_name()=="a"){b(c,new B(c[0].nextSibling),true);b(c,new B(c[0].previousSibling))}}}(),_4e_unselectable:w.gecko?function(b){b=h(b);b.style.MozUserSelect="none"}:w.webkit?function(b){b=h(b);b.style.KhtmlUserSelect="none"}:function(b){b=h(b);if(w.ie||w.opera){var c,g=0;for(b.unselectable="on";c=b.all[g++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(b,c){b=h(b);var g,f=0;g=0;var m=b.ownerDocument.defaultView||
b.ownerDocument.parentWindow,j=b.ownerDocument,a=j.documentElement;c=c||j;if(b.getBoundingClientRect){if(b!==j.body&&a!==b){g=b.getBoundingClientRect();f=g.left+(c===j?s.scrollLeft(m):0);g=g.top+(c===j?s.scrollTop(m):0)}if(c)if(m!=(c.defaultView||c.parentWindow)&&m.frameElement){c=u._4e_getOffset(m.frameElement,c);f+=c.left;g+=c.top}}return{left:f,top:g}},_4e_getFrameDocument:function(b){return(b=h(b))&&b.contentWindow.document},_4e_splitText:function(b,c){b=h(b);var g=b.ownerDocument;if(!(!b||b.nodeType!=
i.NODE_TEXT)){if(w.ie&&c==b.nodeValue.length){g=g.createTextNode("");s.insertAfter(g,b);return g}b=new B(b.splitText(c));if(w.ie==8){g=g.createTextNode("");s.insertAfter(g,b[0]);g.parentNode.removeChild(g)}return b}},_4e_parents:function(b,c){b=k(b);var g=[];do g[c?"push":"unshift"](b);while(b=b.parent());return g},_4e_clone:function(b,c,g){b=h(b);b=b.cloneNode(c);if(!g){var f=function(m){if(m.nodeType==i.NODE_ELEMENT){m.removeAttribute("id",false);m.removeAttribute("_ke_expando",false);m=m.childNodes;
for(var j=0;j<m.length;j++)f(m[j])}};f(b)}return new B(b)},_4e_nextSourceNode:function(b,c,g,f){b=h(b);if(f&&!f.call){var m=f[0]||f;f=function(a){a=a[0]||a;return a!==m}}c=!c&&b.firstChild;var j=new B(b);if(!c){if(b.nodeType==i.NODE_ELEMENT&&f&&f(this,true)===false)return null;c=b.nextSibling}for(;!c&&(j=j.parent());){if(f&&f(j,true)===false)return null;c=j[0].nextSibling}if(!c)return null;c=new B(c);if(f&&f(c)===false)return null;if(g&&g!=c[0].nodeType)return c._4e_nextSourceNode(false,g,f);return c},
_4e_previousSourceNode:function(b,c,g,f){b=h(b);if(f&&!f.call){var m=f[0]||f;f=function(a){a=a[0]||a;return a!==m}}c=!c&&b.lastChild;var j=new B(b);if(!c){if(b.nodeType==i.NODE_ELEMENT&&f&&f(b,true)===false)return null;c=b.previousSibling}for(;!c&&(j=j.parent());){if(f&&f(j,true)===false)return null;c=j[0].previousSibling}if(!c)return null;c=new B(c);if(f&&f(c)===false)return null;if(g&&c[0].nodeType!=g)return c._4e_previousSourceNode(false,g,f);return c},_4e_contains:w.ie||w.webkit?function(b,c){b=
h(b);c=h(c);return c.nodeType!=i.NODE_ELEMENT?b.contains(c.parentNode):b!=c&&b.contains(c)}:function(b,c){b=h(b);c=h(c);return!!(b.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(b,c){if(b._4e_equals(c))return b;if(c[0].nodeType!=i.NODE_TEXT&&c._4e_contains(b))return c;b=b[0].nodeType==i.NODE_TEXT?b.parent():b;do if(b[0].nodeType!=i.NODE_TEXT&&b._4e_contains(c))return b;while(b=b.parent());return null},_4e_ascendant:function(b,c,g){b=h(b);if(!g)b=b.parentNode;if(c&&!A.isFunction(c)){var f=
c;c=function(m){return m._4e_name()==f}}for(;b&&b.nodeType!=9;){if(!c||c(new B(b))===true)return new B(b);b=b.parentNode}return null},_4e_hasAttribute:function(b,c){b=h(b);b=b.attributes.getNamedItem(c);return!!(b&&b.specified)},_4e_hasAttributes:w.ie?function(b){b=h(b);for(var c=b.attributes,g=0;g<c.length;g++){var f=c[g];switch(f.nodeName){case "class":if(b.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(f.specified)return true}}return false}:function(b){b=h(b);w.gecko&&
b.removeAttribute("_moz_dirty");b=b.attributes;return b.length>1||b.length==1&&b[0].nodeName!="_ke_expando"},_4e_position:function(b,c){var g=h(b),f=h(c);if(g.compareDocumentPosition)return g.compareDocumentPosition(f);if(g==f)return d.POSITION_IDENTICAL;if(g.nodeType==i.NODE_ELEMENT&&f.nodeType==i.NODE_ELEMENT){if(g.contains){if(g.contains(f))return d.POSITION_CONTAINS+d.POSITION_PRECEDING;if(f.contains(g))return d.POSITION_IS_CONTAINED+d.POSITION_FOLLOWING}if("sourceIndex"in g)return g.sourceIndex<
0||f.sourceIndex<0?d.POSITION_DISCONNECTED:g.sourceIndex<f.sourceIndex?d.POSITION_PRECEDING:d.POSITION_FOLLOWING}b=b._4e_address();c=c._4e_address();g=Math.min(b.length,c.length);for(f=0;f<=g-1;f++)if(b[f]!=c[f]){if(f<g)return b[f]<c[f]?d.POSITION_PRECEDING:d.POSITION_FOLLOWING;break}return b.length<c.length?d.POSITION_CONTAINS+d.POSITION_PRECEDING:d.POSITION_IS_CONTAINED+d.POSITION_FOLLOWING},_4e_address:function(b,c){b=h(b);var g=[],f=b.ownerDocument.documentElement;for(b=b;b&&b!=f;){var m=b.parentNode,
j=-1;if(m){for(var a=0;a<m.childNodes.length;a++){var e=m.childNodes[a];if(!(c&&e.nodeType==3&&e.previousSibling&&e.previousSibling.nodeType==3)){j++;if(e==b)break}}g.unshift(j)}b=m}return g},_4e_breakParent:function(b,c){var g=new x.Range(b[0].ownerDocument);g.setStartAfter(b);g.setEndAfter(c);c=g.extractContents();g.insertNode(b._4e_remove());b[0].parentNode.insertBefore(c,b[0].nextSibling)},_4e_style:function(b,c,g){if(g!==undefined)return b.css(c,g);b=b[0]||b;return b.style[r(c)]},_4e_remove:function(b,
c){var g=h(b),f=g.parentNode;if(f){if(c)for(;c=g.firstChild;)f.insertBefore(g.removeChild(c),g);f.removeChild(g)}return b},_4e_trim:function(b){s._4e_ltrim(b);s._4e_rtrim(b)},_4e_ltrim:function(b){b=h(b);for(var c;c=b.firstChild;){if(c.nodeType==i.NODE_TEXT){var g=p.ltrim(c.nodeValue),f=c.nodeValue.length;if(g){if(g.length<f){(new B(c))._4e_splitText(f-g.length);b.removeChild(b.firstChild)}}else{b.removeChild(c);continue}}break}},_4e_rtrim:function(b){b=h(b);for(var c;c=b.lastChild;){if(c.type==i.NODE_TEXT){var g=
p.rtrim(c.nodeValue),f=c.nodeValue.length;if(g){if(g.length<f){(new B(c))._4e_splitText(g.length);b.removeChild(b.lastChild)}}else{b.removeChild(c);continue}}break}if(!w.ie&&!w.opera)(c=b.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(b){b=h(b);for(var c=b.lastChild;c&&c.nodeType==i.NODE_TEXT&&!A.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==i.NODE_TEXT||s._4e_name(c)!=="br"){c=w.opera?b.ownerDocument.createTextNode(""):
b.ownerDocument.createElement("br");w.gecko&&c.setAttribute("type","_moz");b.appendChild(c)}},_4e_previous:function(b,c){b=h(b);var g;do g=(b=b.previousSibling)&&new B(b);while(g&&c&&!c(g));return g},_4e_last:function(b,c){if((b=(b=b[0].lastChild)&&new B(b))&&c&&!c(b))b=b._4e_previous(c);return b},_4e_next:function(b,c){b=h(b);var g;do g=(b=b.nextSibling)&&new B(b);while(g&&c&&!c(g));return g},_4e_outerHtml:function(b){b=h(b);if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var c=b.ownerDocument.createElement("div");
c.appendChild(b.cloneNode(true));return c.innerHTML},_4e_setMarker:function(b,c,g,f){b[0]||(b=new B(b));var m=b._4e_getData("list_marker_id")||b._4e_setData("list_marker_id",A.guid())._4e_getData("list_marker_id"),j=b._4e_getData("list_marker_names")||b._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[m]=b;j[g]=1;return b._4e_setData(g,f)},_4e_clearMarkers:function(b,c,g){b=k(b);var f=b._4e_getData("list_marker_names"),m=b._4e_getData("list_marker_id");for(var j in f)b._4e_removeData(j);
b._4e_removeData("list_marker_names");if(g){b._4e_removeData("list_marker_id");delete c[m]}},_4e_setData:function(b,c,g){var f=s._4e_getUniqueId(b);(l[f]||(l[f]={}))[c]=g;return b},_4e_getData:function(b,c){b=h(b);return(b=(b=b.getAttribute("_ke_expando"))&&l[b])&&b[c]},_4e_removeData:function(b,c){b=h(b);var g=b.getAttribute("_ke_expando");var f=(g=g&&l[g])&&g[c];typeof f!="undefined"&&g&&delete g[c];A.isEmptyObject(g)&&s._4e_clearData(b);return f||null},_4e_clearData:function(b){b=h(b);var c=b.getAttribute("_ke_expando");
c&&delete l[c];c&&b.removeAttribute("_ke_expando")},_4e_getUniqueId:function(b){b=h(b);var c=b.getAttribute("_ke_expando");if(c)return c;c=A.guid();b.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(b,c,g){b=h(b);var f=b.attributes;g=g||{};for(var m=0;m<f.length;m++){var j=f[m],a=j.nodeName.toLowerCase(),e;if(!(a in g))if(a=="checked"&&(e=s.attr(b,a)))c.attr(a,e);else if(j.specified||w.ie&&j.nodeValue&&a=="value"){e=s.attr(b,a);if(e===null)e=j.nodeValue;c.attr(a,e)}}if(b.style.cssText!==
"")c[0].style.cssText=b.style.cssText},_4e_isEditable:function(b){b=s._4e_name(b);var c=x.XHTML_DTD;return(b=!c.$nonEditable[b]&&(c[b]||c.span))&&b["#"]},_4e_scrollIntoView:function(b){b=k(b);var c=b[0].ownerDocument,g=s.scrollLeft(c),f=s.scrollTop(c),m=b.offset(),j=m.left;m=m.top;if(s.viewportHeight(c)+f<m||m<f||s.viewportWidth(c)+g<j||j<g)b.scrollIntoView(c)},_4e_getElementsByTagName:function(b,c,g){b=h(b);if(!w.ie&&g)c=g+":"+c;g=[];b=b.getElementsByTagName(c);for(c=0;c<b.length;c++)g.push(new B(b[c]));
return g}};A.DOM._4e_inject=function(b){A.mix(s,b);for(var c in b)b.hasOwnProperty(c)&&function(g){B.prototype[g]=function(){var f=[].slice.call(arguments,0);f.unshift(this);return b[g].apply(null,f)}}(c)};A.DOM._4e_inject(u)});
KISSY.Editor.add("elementpath",function(x){function r(l){var n=null,q=null,h=[];for(l=l;l&&l[0];){if(l[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=l;var k=l._4e_name();if(p.ie&&l[0].scopeName!="HTML")k=l[0].scopeName.toLowerCase()+":"+k;if(!q){if(!n&&t[k])n=l;if(i[k])if(!n&&k=="div"&&!d(l))n=l;else q=l}h.push(l);if(k=="body")break}l=l.parent()}this.block=n;this.blockLimit=q;this.elements=h}var A=KISSY,s=A.DOM,w=x.XHTML_DTD,B=x.NODE,p=A.UA,t={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},d=function(l){l=l[0]||l;l=l.childNodes;for(var n=0,q=l.length;n<q;n++){var h=l[n];if(h.nodeType==B.NODE_ELEMENT&&w.$block[h.nodeName.toLowerCase()])return true}return false};r.prototype={compare:function(l){var n=this.elements;l=l&&l.elements;if(!l||n.length!=l.length)return false;for(var q=0;q<n.length;q++)if(!s._4e_equals(n[q],l[q]))return false;return true},contains:function(l){for(var n=
this.elements,q=0;q<n.length;q++)if(n[q]._4e_name()in l)return n[q];return null}};x.ElementPath=r});
KISSY.Editor.add("walker",function(x){function r(i,d){if(this._.end)return null;var l=this.range,n,q=this.guard,h=this.type,k=i?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;l.trim();if(l.collapsed){this.end();return null}}if(!i&&!this._.guardLTR){var u=l.endContainer,b=new t(u[0].childNodes[l.endOffset]);this._.guardLTR=function(m,j){return(!j||!p._4e_equals(u,m))&&(!b[0]||m[0]!==b[0])&&(m[0].nodeType!=B.NODE_ELEMENT||!j||m._4e_name()!="body")}}if(i&&!this._.guardRTL){var c=
l.startContainer,g=l.startOffset>0&&new t(c[0].childNodes[l.startOffset-1]);this._.guardRTL=function(m,j){return m&&m[0]&&(!j||c[0]!==m[0])&&(!g[0]||m[0]!==g[0])&&(m[0].nodeType!=B.NODE_ELEMENT||!j||m._4e_name()!="body")}}var f=i?this._.guardRTL:this._.guardLTR;n=q?function(m,j){if(f(m,j)===false)return false;return q(m,j)}:f;if(this.current)i=this.current[k](false,h,n);else if(i){i=l.endContainer;if(l.endOffset>0){i=new t(i[0].childNodes[l.endOffset-1]);if(n(i)===false)i=null}else i=n(i,true)===
false?null:i._4e_previousSourceNode(true,h,n)}else{i=l.startContainer;if((i=new t(i[0].childNodes[l.startOffset]))&&i[0]){if(n(i)===false)i=null}else i=n(l.startContainer,true)===false?null:l.startContainer._4e_nextSourceNode(true,h,n)}for(;i&&i[0]&&!this._.end;){this.current=i;if(!this.evaluator||this.evaluator(i)!==false){if(!d)return i}else if(d&&this.evaluator)return false;i=i[k](false,h,n)}this.end();return this.current=null}function A(i){for(var d,l=null;d=r.call(this,i);)l=d;return l}function s(i){this.range=
i;this._={}}var w=KISSY,B=x.NODE,p=w.DOM,t=w.Node;w.augment(s,{end:function(){this._.end=1},next:function(){return r.call(this)},previous:function(){return r.call(this,true)},checkForward:function(){return r.call(this,false,true)!==false},checkBackward:function(){return r.call(this,true,true)!==false},lastForward:function(){return A.call(this)},lastBackward:function(){return A.call(this,true)},reset:function(){delete this.current;this._={}}});s.blockBoundary=function(i){return function(d){d[0]||(d=
new t(d));return!(d[0].nodeType==B.NODE_ELEMENT&&d._4e_isBlockBoundary(i))}};s.listItemBoundary=function(){return this.blockBoundary({br:1})};s.bookmark=function(i,d){function l(n){return n&&n[0]&&n._4e_name()=="span"&&n.attr("_ke_bookmark")}return function(n){var q,h;q=n&&n[0]&&n[0].nodeType==B.NODE_TEXT&&(h=n.parent())&&l(h);q=i?q:q||l(n);return d^q}};s.whitespaces=function(i){return function(d){d=(d=d[0]||d)&&d.nodeType==B.NODE_TEXT&&!w.trim(d.nodeValue);return i^d}};s.invisible=function(i){var d=
s.whitespaces();return function(l){l=d(l)||l[0].nodeType==B.NODE_ELEMENT&&!l[0].offsetHeight;return i^l}};x.Walker=s});
KISSY.Editor.add("range",function(x){function r(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=a}function A(a){var e=a[0].nodeType!=i.NODE_TEXT&&a._4e_name()in u.$removeEmpty,o=!t.trim(a[0].nodeValue);a=!!a.parent().attr("_ke_bookmark");return e||o||a}function s(a){return!m(a)&&!j(a)}function w(a){var e=false,o=n.bookmark(true);return function(v){if(o(v))return true;if(v[0].nodeType==i.NODE_TEXT){if(t.trim(v[0].nodeValue).length)return false}else if(v[0].nodeType==
i.NODE_ELEMENT)if(!f[v._4e_name()])if(!a&&!k.ie&&v._4e_name()=="br"&&!e)e=true;else return false;return true}}function B(a,e){function o(v){return v&&v.nodeName=="span"&&v.getAttribute("_ke_bookmark")}return function(v){var y,C;y=v&&!v.nodeName&&(C=v.parentNode)&&o(C);y=a?y:y||o(v);return e^y}}function p(a){return function(e){e=(e=e[0]||e)&&e.nodeType==i.NODE_TEXT&&!t.trim(e.nodeValue);return a^e}}x.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var t=KISSY,i=x.NODE,d=x.RANGE,l=x.POSITION,n=x.Walker,q=t.DOM,h=x.Utils.getByAddress,k=t.UA,u=x.XHTML_DTD,b=x.ElementPath,c=t.Node,g={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};r.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};t.augment(r,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&q._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,e=this.startOffset;if(a[0].nodeType!=i.NODE_ELEMENT)if(e)e>=a[0].nodeValue.length&&this.setStartAfter(a);else this.setStartBefore(a);a=this.endContainer;e=this.endOffset;if(a[0].nodeType!=i.NODE_ELEMENT)if(e)e>=a[0].nodeValue.length&&
this.setEndAfter(a);else this.setEndBefore(a)},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,e=this.endContainer;a&&a._4e_name()=="span"&&a.attr("_ke_bookmark")&&this.setStartAt(a,d.POSITION_BEFORE_START);e&&e._4e_name()=="span"&&
e.attr("_ke_bookmark")&&this.setEndAt(e,d.POSITION_AFTER_END)},setStart:function(a,e){if(a[0].nodeType==i.NODE_ELEMENT&&g[a._4e_name()]){a=a.parent();e=a._4e_index()}this.startContainer=a;this.startOffset=e;if(!this.endContainer){this.endContainer=a;this.endOffset=e}this.updateCollapsed()},setEnd:function(a,e){if(a[0].nodeType==i.NODE_ELEMENT&&g[a._4e_name()]){a=a.parent();e=a._4e_index()+1}this.endContainer=a;this.endOffset=e;if(!this.startContainer){this.startContainer=a;this.startOffset=e}this.updateCollapsed()},
setStartAt:function(a,e){switch(e){case d.POSITION_AFTER_START:this.setStart(a,0);break;case d.POSITION_BEFORE_END:a[0].nodeType==i.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setStartBefore(a);break;case d.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,e){switch(e){case d.POSITION_AFTER_START:this.setEnd(a,0);break;case d.POSITION_BEFORE_END:a[0].nodeType==i.NODE_TEXT?this.setEnd(a,
a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setEndBefore(a);break;case d.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},execContentsAction:function(a,e){var o=this.startContainer,v=this.endContainer,y=this.startOffset,C=this.endOffset,H,N;this.optimizeBookmark();if(v[0].nodeType==i.NODE_TEXT)v=v._4e_splitText(C);else if(v[0].childNodes.length>0)if(C>=v[0].childNodes.length){v=new c(v[0].appendChild(this.document.createTextNode("")));
N=true}else v=new c(v[0].childNodes[C]);if(o[0].nodeType==i.NODE_TEXT){o._4e_splitText(y);if(q._4e_equals(o,v))v=new c(o[0].nextSibling)}else if(y)if(y>=o[0].childNodes.length){H=new c(this.document.createTextNode(""));o[0].appendChild(H[0]);o=H;H=true}else o=new c(o[0].childNodes[y].previousSibling);else{H=new c(this.document.createTextNode(""));q.insertBefore(H[0],o[0].firstChild);o=H;H=true}y=o._4e_parents();C=v._4e_parents();var z,D,I;for(z=0;z<y.length;z++){D=y[z];I=C[z];if(D[0]!==I[0])break}for(var L=
e,M,O,S,R=z;R<y.length;R++){M=y[R];if(L&&M[0]!==o[0])O=L.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(C[R]&&M==C[R][0]||M==v[0])break;S=M.nextSibling;if(a==2)L.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);a==1&&L.appendChild(M)}M=S}if(O)L=O}L=e;for(e=z;e<C.length;e++){M=C[e];if(a>0&&M[0]!==v[0])O=L.appendChild(M._4e_clone()[0]);if(!y[e]||M[0].parentNode!==y[e][0].parentNode)for(M=M[0].previousSibling;M;){if(y[e]&&M==y[e][0]||M===o[0])break;S=M.previousSibling;if(a==
2)L.insertBefore(M.cloneNode(true),L.firstChild);else{M.parentNode.removeChild(M);a==1&&L.insertBefore(M,L.firstChild)}M=S}if(O)L=O}if(a==2){I=this.startContainer[0];if(I.nodeType==i.NODE_TEXT&&I.nextSibling&&I.nextSibling.nodeType==i.NODE_TEXT){I.data+=I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}I=this.endContainer[0];if(I.nodeType==i.NODE_TEXT&&I.nextSibling&&I.nextSibling.nodeType==i.NODE_TEXT){I.data+=I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}}else{if(D&&I&&(o[0].parentNode!=
D[0].parentNode||v[0].parentNode!=I[0].parentNode)){a=I._4e_index();H&&I[0].parentNode==o[0].parentNode&&a--;this.setStart(I.parent(),a)}this.collapse(true)}H&&o._4e_remove();N&&v[0].parentNode&&v._4e_remove()},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var a=new r(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;
a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=i.NODE_ELEMENT||a.endContainer[0].nodeType!=i.NODE_ELEMENT)return null;a=a.startContainer[0].childNodes[a.startOffset];for(var e=B(true,undefined),o=p(true),v=function(y){return o(y)&&e(y)};a&&v(a);)a=(new c(a))._4e_nextSourceNode()[0];return new c(a)},shrink:function(a,e){if(!this.collapsed){a=a||d.SHRINK_TEXT;
var o=this.clone(),v=this.startContainer,y=this.endContainer,C=this.startOffset,H=this.endOffset,N=1,z=1;if(v&&v[0].nodeType==i.NODE_TEXT)if(C)if(C>=v[0].nodeValue.length)o.setStartAfter(v);else{o.setStartBefore(v);N=0}else o.setStartBefore(v);if(y&&y[0].nodeType==i.NODE_TEXT)if(H)if(H>=y[0].nodeValue.length)o.setEndAfter(y);else{o.setEndAfter(y);z=0}else o.setEndBefore(y);o=new n(o);o.evaluator=function(I){I=I[0]||I;return I.nodeType==(a==d.SHRINK_ELEMENT?i.NODE_ELEMENT:i.NODE_TEXT)};var D;o.guard=
function(I,L){I=I[0]||I;if(a==d.SHRINK_ELEMENT&&I.nodeType==i.NODE_TEXT)return false;if(L&&I==D)return false;if(!L&&I.nodeType==i.NODE_ELEMENT)D=I;return true};if(N)(v=o[a==d.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(v,e?d.POSITION_AFTER_START:d.POSITION_BEFORE_START);if(z){o.reset();(o=o[a==d.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(o,e?d.POSITION_BEFORE_END:d.POSITION_AFTER_END)}return!!(N||z)}},getTouchedStartNode:function(){var a=this.startContainer;if(this.collapsed||
a[0].nodeType!=i.NODE_ELEMENT)return a;return a.childNodes[this.startOffset]||a},createBookmark2:function(a){var e=this.startContainer,o=this.endContainer,v=this.startOffset,y=this.endOffset,C,H;if(!e||!o)return{start:0,end:0};if(a){if(e[0].nodeType==i.NODE_ELEMENT)if((C=new c(e[0].childNodes[v]))&&C[0]&&C[0].nodeType==i.NODE_TEXT&&v>0&&C[0].previousSibling.nodeType==i.NODE_TEXT){e=C;v=0}for(;e[0].nodeType==i.NODE_TEXT&&(H=e._4e_previous())&&H[0].nodeType==i.NODE_TEXT;){e=H;v+=H[0].nodeValue.length}if(!this.collapsed){if(o[0].nodeType==
i.NODE_ELEMENT)if((C=new c(o[0].childNodes[y]))&&C[0]&&C[0].nodeType==i.NODE_TEXT&&y>0&&C[0].previousSibling.nodeType==i.NODE_TEXT){o=C;y=0}for(;o[0].nodeType==i.NODE_TEXT&&(H=o._4e_previous())&&H[0].nodeType==i.NODE_TEXT;){o=H;y+=H[0].nodeValue.length}}}return{start:e._4e_address(a),end:this.collapsed?null:o._4e_address(a),startOffset:v,endOffset:y,normalized:a,is2:true}},createBookmark:function(a){var e,o,v,y;e=new c("<span></span>",null,this.document);e.attr("_ke_bookmark",1);e.css("display","none");
e.html("&nbsp;");if(a){v=t.guid("ke_bm_");e.attr("id",v+"S")}if(!this.collapsed){o=e._4e_clone();o.html("&nbsp;");a&&o.attr("id",v+"E");y=this.clone();y.collapse();y.insertNode(o)}y=this.clone();y.collapse(true);y.insertNode(e);if(o){this.setStartAfter(e);this.setEndBefore(o)}else this.moveToPosition(e,d.POSITION_AFTER_END);return{startNode:a?v+"S":e,endNode:a?v+"E":o,serializable:a}},moveToPosition:function(a,e){this.setStartAt(a,e);this.collapse(true)},trim:function(a,e){var o=this.startContainer,
v=this.startOffset,y=this.collapsed;if((!a||y)&&o[0]&&o[0].nodeType==i.NODE_TEXT){if(v)if(v>=o[0].nodeValue.length){v=o._4e_index()+1;o=o.parent()}else{a=o._4e_splitText(v);v=o._4e_index()+1;o=o.parent();if(q._4e_equals(this.startContainer,this.endContainer))this.setEnd(a,this.endOffset-this.startOffset);else if(q._4e_equals(o,this.endContainer))this.endOffset+=1}else{v=o._4e_index();o=o.parent()}this.setStart(o,v);if(y){this.collapse(true);return}}o=this.endContainer;v=this.endOffset;if(!(e||y)&&
o[0]&&o[0].nodeType==i.NODE_TEXT){if(v){v>=o.nodeValue.length||o._4e_splitText(v);v=o._4e_index()+1}else v=o._4e_index();o=o.parent();this.setEnd(o,v)}},insertNode:function(a){this.optimizeBookmark();this.trim(false,true);var e=this.startContainer,o=e[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);o?q.insertBefore(a[0]||a,o):e[0].appendChild(a[0]||a);q._4e_equals(a.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){if(a.is2){var e=
h(this.document,a.start,a.normalized),o=a.startOffset,v=a.end&&h(this.document,a.end,a.normalized);a=a.endOffset;this.setStart(e,o);v?this.setEnd(v,a):this.collapse(true)}else{e=(o=a.serializable)?t.one("#"+a.startNode,this.document):a.startNode;a=o?t.one("#"+a.endNode,this.document):a.endNode;this.setStartBefore(e);e._4e_remove();if(a&&a[0]){this.setEndBefore(a);a._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(a,e){var o=this.startContainer,v=this.endContainer;a=q._4e_equals(o,
v)?a&&o[0].nodeType==i.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(o[0].childNodes[this.startOffset]):o:o._4e_commonAncestor(v);return e&&a[0].nodeType==i.NODE_TEXT?a.parent():a},enlarge:function(a){switch(a){case d.ENLARGE_ELEMENT:if(this.collapsed)return;a=this.getCommonAncestor();var e=new c(this.document.body),o,v,y,C,H,N=false,z,D;z=this.startContainer;D=this.startOffset;if(z[0].nodeType==i.NODE_TEXT){if(D){z=!t.trim(z[0].nodeValue.substring(0,D)).length&&z;N=!!z}if(z)if(!(C=z[0].previousSibling))y=
z.parent()}else{if(D)C=z[0].childNodes[D-1]||z[0].lastChild;C||(y=z)}for(;y||C;){if(y&&!C){if(!H&&q._4e_equals(y,a))H=true;if(!e._4e_contains(y))break;if(!N||y.css("display")!="inline"){N=false;if(H)o=y;else this.setStartBefore(y)}C=y[0].previousSibling}for(;C;){z=false;if(C.nodeType==i.NODE_TEXT){D=C.nodeValue;if(/[^\s\ufeff]/.test(D))C=null;z=/[\s\ufeff]$/.test(D)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(N&&u.$removeEmpty[C.nodeName.toLowerCase()]){D=q.text(C);if(/[^\s\ufeff]/.test(D))C=
null;else for(var I=C.all||C.getElementsByTagName("*"),L=0,M;M=I[L++];)if(!u.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}if(C)z=!!D.length}else C=null;if(z)if(N)if(H)o=y;else y&&this.setStartBefore(y);else N=true;if(C){z=C.previousSibling;if(!y&&!z){y=new c(C);C=null;break}C=z}else y=null}if(y)y=y.parent()}z=this.endContainer;D=this.endOffset;y=C=null;H=N=false;if(z[0].nodeType==i.NODE_TEXT){z=!t.trim(z[0].nodeValue.substring(D)).length&&z;N=!(z&&z[0].nodeValue.length);if(z)if(!(C=z[0].nextSibling))y=
z.parent()}else(C=z[0].childNodes[D])||(y=z);for(;y||C;){if(y&&!C){if(!H&&q._4e_equals(y,a))H=true;if(!e._4e_contains(y))break;if(!N||y.css("display")!="inline"){N=false;if(H)v=y;else y&&this.setEndAfter(y)}C=y[0].nextSibling}for(;C;){z=false;if(C.nodeType==i.NODE_TEXT){D=C.nodeValue;if(/[^\s\ufeff]/.test(D))C=null;z=/^[\s\ufeff]/.test(D)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(N&&u.$removeEmpty[C.nodeName.toLowerCase()]){D=q.text(C);if(/[^\s\ufeff]/.test(D))C=null;else{I=C.all||
C.getElementsByTagName("*");for(L=0;M=I[L++];)if(!u.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}}if(C)z=!!D.length}else C=null;if(z)if(N)if(H)v=y;else this.setEndAfter(y);if(C){z=C.nextSibling;if(!y&&!z){y=new c(C);C=null;break}C=z}else y=null}if(y)y=y.parent()}if(o&&v){a=o._4e_contains(v)?v:o;this.setStartBefore(a);this.setEndAfter(a)}break;case d.ENLARGE_BLOCK_CONTENTS:case d.ENLARGE_LIST_ITEM_CONTENTS:y=new r(this.document);e=new c(this.document.body);y.setStartAt(e,d.POSITION_AFTER_START);
y.setEnd(this.startContainer,this.startOffset);y=new n(y);var O,S,R=n.blockBoundary(a==d.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),Y=function(X){var E=R(X);E||(O=X);return E};o=function(X){var E=Y(X);if(!E&&X[0]&&X._4e_name()=="br")S=X;return E};y.guard=Y;y=y.lastBackward();O=O||e;this.setStartAt(O,O._4e_name()!="br"&&(!y&&this.checkStartOfBlock()||y&&O._4e_contains(y))?d.POSITION_AFTER_START:d.POSITION_AFTER_END);y=this.clone();y.collapse();y.setEndAt(e,d.POSITION_BEFORE_END);y=new n(y);y.guard=a==
d.ENLARGE_LIST_ITEM_CONTENTS?o:Y;O=null;y=y.lastForward();O=O||e;this.setEndAt(O,!y&&this.checkEndOfBlock()||y&&O._4e_contains(y)?d.POSITION_BEFORE_END:d.POSITION_BEFORE_START);S&&this.setEndAfter(S)}},checkStartOfBlock:function(){var a=this.startContainer,e=this.startOffset;if(e&&a[0].nodeType==i.NODE_TEXT)if(t.trim(a[0].nodeValue.substring(0,e)).length)return false;this.trim();a=new b(this.startContainer);e=this.clone();e.collapse(true);e.setStartAt(a.block||a.blockLimit,d.POSITION_AFTER_START);
a=new n(e);a.evaluator=w(true);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,e=this.endOffset;if(a[0].nodeType==i.NODE_TEXT)if(t.trim(a[0].nodeValue.substring(e)).length)return false;this.trim();a=new b(this.endContainer);e=this.clone();e.collapse(false);e.setEndAt(a.block||a.blockLimit,d.POSITION_BEFORE_END);a=new n(e);a.evaluator=w(false);return a.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,e){var o=this.clone();o[e==d.START?"setStartAt":"setEndAt"](a,e==d.START?d.POSITION_AFTER_START:d.POSITION_BEFORE_END);a=new n(o);a.evaluator=A;return a[e==d.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,e=this.endContainer,o=this.startOffset,v=this.endOffset,y;if(a[0].nodeType==i.NODE_ELEMENT){y=a[0].childNodes.length;if(y>
o)a=new c(a[0].childNodes[o]);else if(y<1)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new c(a);a=a._4e_nextSourceNode()||a}}if(e[0].nodeType==i.NODE_ELEMENT){y=e[0].childNodes.length;if(y>v)e=(new c(e[0].childNodes[v]))._4e_previousSourceNode(true);else if(y<1)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=new c(e)}}if(a._4e_position(e)&l.POSITION_FOLLOWING)a=e;return{startNode:a,endNode:e}},fixBlock:function(a,e){var o=this.createBookmark();
e=new c(this.document.createElement(e));this.collapse(a);this.enlarge(d.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();k.ie||e._4e_appendBogus();this.insertNode(e);this.moveToBookmark(o);return e},splitBlock:function(a){var e=new b(this.startContainer),o=new b(this.endContainer),v=e.block,y=o.block,C=null;if(e.blockLimit[0]!==o.blockLimit[0])return null;if(a!="br"){if(!v){v=this.fixBlock(true,a);y=(new b(this.endContainer)).block}y||(y=this.fixBlock(false,a))}a=v&&this.checkStartOfBlock();
e=y&&this.checkEndOfBlock();this.deleteContents();if(v&&q._4e_equals(v,y))if(e){C=new b(this.startContainer);this.moveToPosition(y,d.POSITION_AFTER_END);y=null}else if(a){C=new b(this.startContainer);this.moveToPosition(v,d.POSITION_BEFORE_START);v=null}else{y=this.splitElement(v);!k.ie&&!t.inArray(v._4e_name(),["ul","ol"])&&v._4e_appendBogus()}return{previousBlock:v,nextBlock:y,wasStartOfBlock:a,wasEndOfBlock:e,elementPath:C}},splitElement:function(a){if(!this.collapsed)return null;this.setEndAt(a,
d.POSITION_BEFORE_END);var e=this.extractContents(),o=a._4e_clone(false);o[0].appendChild(e);o.insertAfter(a);this.moveToPosition(a,d.POSITION_AFTER_END);return o},moveToElementEditablePosition:function(a,e){var o,v=x.XHTML_DTD;if(v.$empty[a._4e_name()])return false;for(;a&&a[0].nodeType==i.NODE_ELEMENT;){if(o=a._4e_isEditable())this.moveToPosition(a,e?d.POSITION_BEFORE_END:d.POSITION_AFTER_START);else if(v.$inline[a._4e_name()]){this.moveToPosition(a,e?d.POSITION_AFTER_END:d.POSITION_BEFORE_START);
return true}if((a=v.$empty[a._4e_name()]?a[e?"_4e_previous":"_4e_next"](s):a[e?"_4e_last":"_4e_first"](s))&&a[0].nodeType==i.NODE_TEXT){this.moveToPosition(a,e?d.POSITION_AFTER_END:d.POSITION_BEFORE_START);return true}}return o},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==i.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var f={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},m=new n.whitespaces,j=new n.bookmark;x.Range=r});
KISSY.Editor.add("domiterator",function(x){function r(h){if(!(arguments.length<1)){this.range=h;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var A=KISSY,s=A.UA,w=x.Walker,B=x.Range,p=x.RANGE,t=x.NODE,i=x.ElementPath,d=A.Node,l=A.DOM,n=/^[\r\n\t ]*$/,q=w.bookmark();A.augment(r,{getNextParagraph:function(h){var k,u,b,c,g;if(!this._.lastNode){u=this.range.clone();u.enlarge(this.forceBrBreak||!this.enlargeBr?p.ENLARGE_LIST_ITEM_CONTENTS:p.ENLARGE_BLOCK_CONTENTS);
var f=new w(u),m=w.bookmark(true,true);f.evaluator=m;this._.nextNode=f.next();f=new w(u);f.evaluator=m;f=f.previous();this._.lastNode=f._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==t.NODE_TEXT&&!A.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){m=new B(u.document);m.moveToPosition(this._.lastNode,p.POSITION_AFTER_END);if(m.checkEndOfBlock()){m=new i(m.endContainer);this._.lastNode=(m.block||m.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new d(u.document.createTextNode(""));l.insertAfter(this._.lastNode[0],f[0])}u=null}m=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;m;){var j=false,a=m[0].nodeType!=t.NODE_ELEMENT,e=false;if(a){if(m[0].nodeType==t.NODE_TEXT)if(n.test(m[0].nodeValue))a=false}else{var o=m._4e_name();if(m._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(o=="br")a=true;else if(!u&&!m[0].childNodes.length&&o!="hr"){k=m;b=m._4e_equals(f);break}if(u){u.setEndAt(m,p.POSITION_BEFORE_START);
if(o!="br")this._.nextNode=m}j=true}else{if(m[0].firstChild){if(!u){u=new B(this.range.document);u.setStartAt(m,p.POSITION_BEFORE_START)}m=new d(m[0].firstChild);continue}a=true}}if(a&&!u){u=new B(this.range.document);u.setStartAt(m,p.POSITION_BEFORE_START)}b=(!j||a)&&m._4e_equals(f);if(u&&!j)for(;!m[0].nextSibling&&!b;){o=m.parent();if(o._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){j=true;b||o._4e_equals(f);break}m=o;a=true;b=m._4e_equals(f);e=true}a&&u.setEndAt(m,p.POSITION_AFTER_END);m=m._4e_nextSourceNode(e,
null,f);b=!m;if((j||b)&&u){a=u.getBoundaryNodes();j=new i(u.startContainer);if(a.startNode.parent()._4e_equals(j.blockLimit)&&q(a.startNode)&&q(a.endNode)){u=null;this._.nextNode=null}else break}if(b)break}if(!k){if(!u){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}j=new i(u.startContainer);m=j.blockLimit;a={div:1,th:1,td:1};k=j.block;if((!k||!k[0])&&!this.enforceRealBlocks&&a[m._4e_name()]&&u.checkStartOfBlock()&&u.checkEndOfBlock())k=m;else if(!k||this.enforceRealBlocks&&
k._4e_name()=="li"){k=new d(this.range.document.createElement(h||"p"));k[0].appendChild(u.extractContents());k._4e_trim();u.insertNode(k);c=g=true}else if(k._4e_name()!="li"){if(!u.checkStartOfBlock()||!u.checkEndOfBlock()){k=k._4e_clone(false);k[0].appendChild(u.extractContents());k._4e_trim();g=u.splitBlock();c=!g.wasStartOfBlock;g=!g.wasEndOfBlock;u.insertNode(k)}}else if(!b)this._.nextNode=k._4e_equals(f)?null:u.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,f)}if(c){u=new d(k[0].previousSibling);
if(u[0]&&u[0].nodeType==t.NODE_ELEMENT)if(u._4e_name()=="br")u._4e_remove();else u[0].lastChild&&u[0].lastChild.nodeName.toLowerCase()=="br"&&l._4e_remove(u[0].lastChild)}if(g){u=w.bookmark(false,true);c=new d(k[0].lastChild);if(c[0]&&c[0].nodeType==t.NODE_ELEMENT&&c._4e_name()=="br")if(s.ie||c._4e_previous(u)||c._4e_next(u))c._4e_remove()}if(!this._.nextNode)this._.nextNode=b||k._4e_equals(f)?null:k._4e_nextSourceNode(true,null,f);return k}});B.prototype.createIterator=function(){return new r(this)}});
KISSY.Editor.add("selection",function(x){function r(f){this.document=f;this._={cache:{}};if(B.ie){var m=this.getNative().createRange();if(!m||m.item&&m.item(0).ownerDocument!=f||m.parentElement&&m.parentElement().ownerDocument!=f)this.isInvalid=true}}function A(f){f=new r(f);return!f||f.isInvalid?null:f}function s(f){var m=f.document,j=new d(m.body),a=new d(m.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)a.on("click",function(C){p._4e_name(C.target)==="html"&&f.getSelection().getRanges()[0].select()});
var e,o;j.on("focusin",function(C){if(C.target.nodeName.toUpperCase()=="BODY")if(e){try{e.select()}catch(H){}e=null}});j.on("focus",function(){o=true;y()});j.on("beforedeactivate",function(C){C.relatedTarget||(o=false)});B.ie<8&&t.on(p._4e_getWin(m),"blur",function(){m.selection.empty()});j.on("mousedown",v);j.on("mouseup",function(){o=true;setTimeout(function(){y(true)},0)});j.on("keydown",v);j.on("keyup",function(){o=true;y()});t.on(m,"selectionchange",y);var v=function(){o=false},y=function(C){if(o){var H=
f.document,N=f.getSelection(),z=N.getType(),D=N&&N.getNative();if(C&&D&&z==l.SELECTION_NONE)if(!H.queryCommandEnabled("InsertImage")){setTimeout(function(){y(true)},50);return}var I;if(!(D&&z==l.SELECTION_TEXT&&(I=p._4e_name(D.createRange().parentElement()))&&I in{input:1,textarea:1})){e=D&&N.getRanges()[0];f._monitor()}}}}else{t.on(m,"mouseup",f._monitor,f);t.on(m,"keyup",f._monitor,f)}}x.SELECTION={};var w=KISSY,B=w.UA,p=w.DOM,t=w.Event,i=x.Utils.tryThese,d=w.Node,l=x.SELECTION,n=x.RANGE,q=x.NODE,
h=x.Walker,k=x.Range;l.SELECTION_NONE=1;l.SELECTION_TEXT=2;l.SELECTION_ELEMENT=3;var u={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};w.augment(r,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=p._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var f=this._.cache;
if(f.type)return f.type;var m=l.SELECTION_NONE;try{var j=this.getNative(),a=j.type;if(a=="Text")m=l.SELECTION_TEXT;if(a=="Control")m=l.SELECTION_ELEMENT;if(j.createRange().parentElement)m=l.SELECTION_TEXT}catch(e){}return f.type=m}:function(){var f=this._.cache;if(f.type)return f.type;var m=l.SELECTION_TEXT,j=this.getNative();if(j){if(j.rangeCount==1){j=j.getRangeAt(0);var a=j.startContainer;if(a==j.endContainer&&a.nodeType==q.NODE_ELEMENT&&j.endOffset-j.startOffset===1&&u[a.childNodes[j.startOffset].nodeName.toLowerCase()])m=
l.SELECTION_ELEMENT}}else m=l.SELECTION_NONE;return f.type=m},getRanges:B.ie?function(){var f=function(m,j){m=m.duplicate();m.collapse(j);j=m.parentElement();for(var a=j.childNodes,e,o=0;o<a.length;o++){var v=a[o];if(v.nodeType==q.NODE_ELEMENT){e=m.duplicate();e.moveToElementText(v);v=e.compareEndPoints("StartToStart",m);var y=e.compareEndPoints("EndToStart",m);e.collapse();if(v>0)break;else if(!v||y==1&&v==-1)return{container:j,offset:o};else if(!y)return{container:j,offset:o+1};e=null}}if(!e){e=
m.duplicate();e.moveToElementText(j);e.collapse(false)}e.setEndPoint("StartToStart",m);m=e.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;m>0;)m-=a[--o].nodeValue.length}catch(C){m=0}return m===0?{container:j,offset:o}:{container:a[o],offset:-m}};return function(){var m=this._.cache;if(m.ranges)return m.ranges;var j=this.getNative(),a=j&&j.createRange(),e=this.getType();if(!j)return[];if(e==l.SELECTION_TEXT){j=new k(this.document);e=f(a,true);j.setStart(new d(e.container),e.offset);e=f(a);j.setEnd(new d(e.container),
e.offset);return m.ranges=[j]}else if(e==l.SELECTION_ELEMENT){m=this._.cache.ranges=[];for(e=0;e<a.length;e++){var o=a.item(e),v=o.parentNode,y=0;for(j=new k(this.document);y<v.childNodes.length&&v.childNodes[y]!=o;y++);j.setStart(new d(v),y);j.setEnd(new d(v),y+1);m.push(j)}return m}return m.ranges=[]}}():function(){var f=this._.cache;if(f.ranges)return f.ranges;var m=[],j=this.getNative();if(!j)return[];for(var a=0;a<j.rangeCount;a++){var e=j.getRangeAt(a),o=new k(this.document);o.setStart(new d(e.startContainer),
e.startOffset);o.setEnd(new d(e.endContainer),e.endOffset);m.push(o)}return f.ranges=m},getStartElement:function(){var f=this._.cache;if(f.startElement!==undefined)return f.startElement;var m,j=this.getNative();switch(this.getType()){case l.SELECTION_ELEMENT:return this.getSelectedElement();case l.SELECTION_TEXT:var a=this.getRanges()[0];if(a)if(!a.collapsed){for(a.optimize();;){m=a.startContainer;if(a.startOffset==(m[0].nodeType===q.NODE_ELEMENT?m[0].childNodes.length:m[0].nodeValue.length)&&!m._4e_isBlockBoundary())a.setStartAfter(m);
else break}m=a.startContainer;if(m[0].nodeType!=q.NODE_ELEMENT)return m.parent();m=new d(m[0].childNodes[a.startOffset]);if(!m[0]||m[0].nodeType!=q.NODE_ELEMENT)return a.startContainer;for(a=m[0].firstChild;a&&a.nodeType==q.NODE_ELEMENT;){m=new d(a);a=a.firstChild}return m}if(B.ie){a=j.createRange();a.collapse(true);m=a.parentElement()}else if((m=j.anchorNode)&&m.nodeType!=q.NODE_ELEMENT)m=m.parentNode}return f.startElement=m?new d(m):null},getSelectedElement:function(){var f=this._.cache;if(f.selectedElement!==
undefined)return f.selectedElement;var m=this,j=i(function(){return m.getNative().createRange().item(0)},function(){for(var a=m.getRanges()[0],e,o,v=2;v&&!((e=a.getEnclosedNode())&&e[0].nodeType==q.NODE_ELEMENT&&u[e._4e_name()]&&(o=e));v--)a.shrink(n.SHRINK_ELEMENT);return o[0]});return f.selectedElement=j?new d(j):null},reset:function(){this._.cache={}},selectElement:function(f){var m;if(B.ie)try{m=this.document.body.createControlRange();m.addElement(f[0]);m.select()}catch(j){m=this.document.body.createTextRange();
m.moveToElementText(f[0]);m.select()}finally{}else{m=this.document.createRange();m.selectNode(f[0]);f=this.getNative();f.removeAllRanges();f.addRange(m)}this.reset()},selectRanges:function(f){if(B.ie)f[0]&&f[0].select();else{var m=this.getNative();if(!m)return;m.removeAllRanges();for(var j=0;j<f.length;j++){var a=f[j],e=this.document.createRange(),o=a.startContainer;a.collapsed&&B.gecko&&B.gecko<1.09&&o[0].nodeType==q.NODE_ELEMENT&&!o[0].childNodes.length&&o[0].appendChild(this.document.createTextNode(""));
e.setStart(o[0],a.startOffset);e.setEnd(a.endContainer[0],a.endOffset);m.addRange(e)}}this.reset()},createBookmarks2:function(f){for(var m=[],j=this.getRanges(),a=0;a<j.length;a++)m.push(j[a].createBookmark2(f));return m},createBookmarks:function(f){for(var m=[],j=this.getRanges(),a=j.length,e=this.document,o,v=0;v<a;v++){m.push(o=j[v].createBookmark(f,true));var y=(f=o.serializable)?w.one("#"+o.startNode,e):o.startNode;o=f?w.one("#"+o.endNode,e):o.endNode;for(var C=v+1;C<a;C++){var H=j[C],N=H.startContainer,
z=H.endContainer;p._4e_equals(N,y.parent())&&H.startOffset++;p._4e_equals(N,o.parent())&&H.startOffset++;p._4e_equals(z,y.parent())&&H.endOffset++;p._4e_equals(z,o.parent())&&H.endOffset++}}return m},selectBookmarks:function(f){for(var m=[],j=0;j<f.length;j++){var a=new k(this.document);a.moveToBookmark(f[j]);m.push(a)}this.selectRanges(m);return this},getCommonAncestor:function(){var f=this.getRanges();return f[0].startContainer._4e_commonAncestor(f[f.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
x.Selection=r;var b={table:1,tbody:1,tr:1},c=h.whitespaces(true),g=/\ufeff|\u00a0/;k.prototype.select=B.ie?function(f){var m=this.collapsed,j,a;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==q.NODE_ELEMENT){(new r(this.document)).selectElement(new d(e));return}}if(this.startContainer[0].nodeType==q.NODE_ELEMENT&&this.startContainer._4e_name()in b||this.endContainer[0].nodeType==q.NODE_ELEMENT&&
this.endContainer._4e_name()in b)this.shrink(q.NODE_ELEMENT,true);var o=this.createBookmark();e=o.startNode;var v;if(!m)v=o.endNode;o=this.document.body.createTextRange();o.moveToElementText(e[0]);o.moveStart("character",1);if(v){f=this.document.body.createTextRange();f.moveToElementText(v[0]);o.setEndPoint("EndToEnd",f);o.moveEnd("character",-1)}else{for(j=e[0].nextSibling;j&&!c(j);)j=j.nextSibling;j=!(j&&j.nodeValue&&j.nodeValue.match(g))&&(f||!e[0].previousSibling||e[0].previousSibling&&p._4e_name(e[0].previousSibling)==
"br");a=this.document.createElement("span");a.innerHTML="&#65279;";a=new d(a);p.insertBefore(a[0],e[0]);j&&p.insertBefore(this.document.createTextNode("\ufeff"),e[0])}this.setStartBefore(e);e._4e_remove();if(m){if(j){o.moveStart("character",-1);o.select();this.document.selection.clear()}else o.select();if(a){this.moveToPosition(a,n.POSITION_BEFORE_START);a._4e_remove()}}else{this.setEndBefore(v);v._4e_remove();o.select()}}:function(){var f=this.startContainer;this.collapsed&&f[0].nodeType==q.NODE_ELEMENT&&
!f[0].childNodes.length&&f[0].appendChild(this.document.createTextNode(""));var m=this.document.createRange();m.setStart(f[0],this.startOffset);try{m.setEnd(this.endContainer[0],this.endOffset)}catch(j){if(j.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);m.setEnd(this.endContainer[0],this.endOffset)}else throw j;}f=A(this.document).getNative();f.removeAllRanges();f.addRange(m)};x.on("instanceCreated",function(f){s(f.editor)})});
KISSY.Editor.add("styles",function(x){function r(E,F){for(var G in E)E[G]=E[G].replace(X,function(K,J){return F[J]})}function A(E,F){if(F){E=v.clone(E);r(E.attributes,F);r(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||S[F]?C.STYLE_BLOCK:R[F]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:E}}function s(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new N(E);for(var G=E.getRanges(),K=0;K<G.length;K++)F.call(this,G[K]);E.selectRanges(G)}function w(E,
F){var G=E.element;if(G=="*")G="span";F=new L(F.createElement(G));return B(F,E)}function B(E,F){var G=F._.definition;F=G.attributes;G=A.getStyleText(G);if(F)for(var K in F)E.attr(K,F[K]);if(G)E[0].style.cssText=G;return E}function p(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var K,J=E.document;K=G.getNextParagraph();){var P=w(this,J);l(K,P)}E.moveToBookmark(F)}function t(E,F,G){var K="",J="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(P,Q,T){Q&&(K=Q);T&&(J=T);return""});return K+E.replace(F,G)+J}function i(E,F){var G=E.html();G=t(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new L(E.firstChild);F._4e_remove()}else F.html(G);return F}function d(E){var F=[];t(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,K,J){return K+"</pre>"+J+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,K){F.push(K)});return F}function l(E,F){var G=F._4e_name=="pre",K=E._4e_name=="pre",J=!G&&K;if(G&&!K)F=i(E,F);else if(J)F=q(d(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&n(F)}function n(E){var F;if((F=E._4e_previousSourceNode(true,z.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=t(F.html(),/\n$/,"")+"\n\n"+t(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function q(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),K=0;K<E.length;K++){var J=E[K];J=J.replace(/(\r\n|\r)/g,"\n");J=t(J,/^[ \t]*\n/,"");J=t(J,/\n$/,"");J=t(J,/^[ \t]+|[ \t]+$/g,function(Q,T){return Q.length==1?"&nbsp;":T?" "+(new Array(Q.length)).join("&nbsp;"):(new Array(Q.length)).join("&nbsp;")+" "});J=J.replace(/\n/g,"<br>");J=J.replace(/[ \t]{2,}/g,function(Q){return(new Array(Q.length)).join("&nbsp;")+" "});var P=F._4e_clone();P.html(J);G.appendChild(P[0])}return G}
function h(E){var F=E.document;if(E.collapsed){F=w(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,K=this._.definition,J,P=x.XHTML_DTD[G]||(J=true,x.XHTML_DTD.span),Q=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var T=E.createBookmark(),da=T.startNode;T=T.endNode;for(var V=da,Z;V&&V[0];){var U=false;if(y._4e_equals(V,T)){V=null;U=true}else{var W=V[0].nodeType,ba=W==z.NODE_ELEMENT?V._4e_name():null;if(ba&&V.attr("_ke_bookmark")){V=V._4e_nextSourceNode(true);
continue}if(!ba||P[ba]&&(V._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(V))){var ca=V.parent();if(ca&&ca[0]&&((x.XHTML_DTD[ca._4e_name()]||x.XHTML_DTD.span)[G]||J)&&(!K.parentRule||K.parentRule(ca))){if(!Z&&(!ba||!x.XHTML_DTD.$removeEmpty[ba]||(V._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+
D.POSITION_IS_CONTAINED)){Z=new I(F);Z.setStartBefore(V)}if(W==z.NODE_TEXT||W==z.NODE_ELEMENT&&!V[0].childNodes.length){W=V;for(var $;!W[0].nextSibling&&($=W.parent(),P[$._4e_name()])&&($._4e_position(da)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule($));)W=$;Z.setEndAfter(W);W[0].nextSibling||(U=true)}}else U=true}else U=true;V=V._4e_nextSourceNode()}if(U&&Z&&!Z.collapsed){U=w(this,
F);for(W=Z.getCommonAncestor();U&&W&&U[0]&&W[0];){if(W._4e_name()==G){for(var aa in K.attributes)U.attr(aa)==W.attr(aa)&&U[0].removeAttribute(aa);for(var ea in K.styles)U._4e_style(ea)==W._4e_style(ea)&&U._4e_style(ea,"");if(!U._4e_hasAttributes()){U=null;break}}W=W.parent()}if(U){U[0].appendChild(Z.extractContents());a(this,U);Z.insertNode(U);U._4e_mergeSiblings();M.ie||U[0].normalize()}Z=null}}da._4e_remove();T._4e_remove();E.moveToBookmark(Q);E.shrink(H.SHRINK_TEXT)}}function k(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var K=new O(G.parent()),J,P=0,Q;P<K.elements.length&&(Q=K.elements[P]);P++){if(Q==K.block||Q==K.blockLimit)break;if(this.checkElementRemovable(Q)){var T=E.checkBoundaryOfElement(Q,H.END),da=!T&&E.checkBoundaryOfElement(Q,H.START);if(da||T){J=Q;J.match=da?"start":"end"}else{Q._4e_mergeSiblings();Q._4e_name()==this.element?m(this,Q):e(Q,f(this)[Q._4e_name()])}}}if(J&&J[0]){Q=G;for(P=0;;P++){T=K.elements[P];if(y._4e_equals(T,J))break;else if(T.match)continue;
else T=T._4e_clone();T[0].appendChild(Q[0]);Q=T}y[J.match=="start"?"insertBefore":"insertAfter"](Q[0],J[0])}}else{var V=F.endNode,Z=this;K=function(){for(var U=new O(G.parent()),W=new O(V.parent()),ba=null,ca=null,$=0;$<U.elements.length;$++){var aa=U.elements[$];if(aa==U.block||aa==U.blockLimit)break;if(Z.checkElementRemovable(aa))ba=aa}for($=0;$<W.elements.length;$++){aa=W.elements[$];if(aa==W.block||aa==W.blockLimit)break;if(Z.checkElementRemovable(aa))ca=aa}ca&&V._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
K();for(J=new L(G[0].nextSibling);J[0]!==V[0];){P=J._4e_nextSourceNode();if(J[0]&&J[0].nodeType==z.NODE_ELEMENT&&this.checkElementRemovable(J)){J._4e_name()==this.element?m(this,J):e(J,f(this)[J._4e_name()]);if(P[0].nodeType==z.NODE_ELEMENT&&P._4e_contains(G)){K();P=new L(G[0].nextSibling)}}J=P}}E.moveToBookmark(F)}function u(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,K,J){F[K]=J});return F}function b(E,F){typeof E=="string"&&(E=u(E));typeof F==
"string"&&(F=u(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function c(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function g(E){var F=E._AC;if(F)return F;F={};var G=0,K=E.attributes;if(K)for(var J in K){G++;F[J]=K[J]}if(K=A.getStyleText(E)){F.style||G++;F.style=K}F._length=G;return E._AC=
F}function f(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){v.isArray(G)||(G=[G]);for(var K=0;K<G.length;K++){var J=G[K],P,Q;if(typeof J=="string")P=J.toLowerCase();else{P=J.element?J.element.toLowerCase():E.element;Q=J.attributes}J=F[P]||(F[P]={});if(Q){J=J.attributes=J.attributes||[];for(var T in Q)J.push([T.toLowerCase(),Q[T]])}}}return F}function m(E,F){var G=E._.definition,K=v.mix(v.mix({},G.attributes),f(E)[F._4e_name()]);G=G.styles;var J=v.isEmptyObject(K)&&
v.isEmptyObject(G);for(var P in K)if(!((P=="class"||E._.definition.fullMatch)&&F.attr(P)!=j(P,K[P]))){J=J||!!F._4e_hasAttribute(P);F.removeAttr(P)}for(var Q in G)if(!(E._.definition.fullMatch&&F._4e_style(Q)!=j(Q,G[Q],true))){J=J||!!F._4e_style(Q);F._4e_style(Q,"")}J&&o(F)}function j(E,F,G){var K=new L("<span></span>");K[G?"_4e_style":"attr"](E,F);return K[G?"_4e_style":"attr"](E)}function a(E,F){for(var G=f(E),K=F.all(E.element),J=K.length;--J>=0;)m(E,new L(K[J]));for(var P in G)if(P!=E.element){K=
F.all(P);for(J=K.length-1;J>=0;J--){var Q=new L(K[J]);e(Q,G[P])}}}function e(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var K=F[G][0],J;if(J=E.attr(K)){var P=F[G][1];if(P===null||P.test&&P.test(J)||typeof P=="string"&&J==P)E[0].removeAttribute(K)}}o(E)}function o(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==z.NODE_ELEMENT&&y._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==z.NODE_ELEMENT&&y._4e_mergeSiblings(G)}}}var v=KISSY,y=v.DOM,
C=x.STYLE={},H=x.RANGE,N=x.Selection,z=x.NODE,D=x.POSITION,I=x.Range,L=v.Node,M=v.UA,O=x.ElementPath,S={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},R={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Y=/\s*(?:;\s*|$)/,X=/#\((.+?)\)/g;C.STYLE_BLOCK=1;C.STYLE_INLINE=2;C.STYLE_OBJECT=3;A.prototype={apply:function(E){s.call(this,E,false)},remove:function(E){s.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==C.STYLE_INLINE?
h:this.type==C.STYLE_BLOCK?p:this.type==C.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==C.STYLE_INLINE?k:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=g(G);if(G._length){for(var K in G)if(K!="_length"){var J=E.attr(K)||"";if(K=="style"?b(G[K],c(J,false)):G[K]==J){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
f(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){K=G[F][0];if(K=E.attr(K)){J=G[F][1];if(J===null||typeof J=="string"&&K==J||J.test&&J.test(K))return true}}}return false},checkActive:function(E){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var F=E.elements,G=0,K;G<F.length;G++){K=F[G];if(!(this.type==C.STYLE_INLINE&&(y._4e_equals(K,E.block)||y._4e_equals(K,E.blockLimit))))if(!(this.type==
C.STYLE_OBJECT&&!(K._4e_name()in R)))if(this.checkElementRemovable(K,true))return true}}return false}};A.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",K="";if(G.length)G=G.replace(Y,";");for(var J in F){var P=F[J],Q=(J+":"+P).replace(Y,";");if(P=="inherit")K+=Q;else G+=Q}if(G.length)G=c(G);G+=K;return E._ST=G};x.Style=A});
KISSY.Editor.add("bubbleview",function(){function x(i){x.superclass.constructor.apply(this,arguments);i.init&&i.init.call(this)}function r(i){i=t[i];if(!i.bubble)i.bubble=new x(i.cfg);return i.bubble}var A=KISSY.Editor,s=KISSY,w=s.Event,B=s.DOM,p=s.Node;if(!A.BubbleView){var t={};x.attach=function(i){var d=i.pluginInstance,l=i.pluginName;i=d.editor;var n=t[l];if(n){var q=n.cfg.func,h=t[l].bubble;i.on("selectionChange",function(k){k=k.path;var u=k.elements;if(k&&u)if(k=k.lastElement)if(k=q(k)){h=r(l);
h._selectedEl=k;h._plugin=d;h.show()}else if(h){h._selectedEl=h._plugin=null;h.hide()}});w.on(B._4e_getWin(i.document),"scroll blur",function(){h&&h.hide()});w.on(document,"click",function(){h&&h.hide()})}};x.register=function(i){t[i.pluginName]={cfg:i}};x.ATTRS={focusMgr:{value:false},draggable:{value:false}};s.extend(x,A.SimpleOverlay,{_createEl:function(){var i=(new p('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>')).appendTo(document.body);this.el=i;this.set("el",i)},show:function(){var i=
this._selectedEl,d=i._4e_getOffset(document);d.top+=i.height()+5;x.superclass.show.call(this,d)}});A.BubbleView=x}});
KISSY.Editor.add("button",function(){function x(w){x.superclass.constructor.call(this,w);this._init()}var r=KISSY.Editor,A=KISSY,s=A.Node;if(!r.TripleButton){x.ON="on";x.OFF="off";x.DISABLED="disabled";x.ON_CLASS="ke-triplebutton-on";x.OFF_CLASS="ke-triplebutton-off";x.DISABLED_CLASS="ke-triplebutton-disabled";x.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};A.extend(x,A.Base,{_init:function(){var w=this.get("container")[0]||this.get("container");this.el=new s("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));w.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var w=this.get("cls");w&&this.el.addClass(w)},_stateChange:function(w){this["_"+
w.newVal]();this._attachCls()},_action:function(w){this.fire(this.get("state")+"Click",w);this.fire("click",w);w.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});r.TripleButton=x}});
KISSY.Editor.add("clipboard",function(x){var r=KISSY.Editor,A=KISSY,s=A.Node,w=A.UA,B=r.Range,p=r.RANGE,t=A.Event;r.Paste||function(){function i(d){this.editor=d;this._init()}A.augment(i,{_init:function(){var d=this.editor;w.ie?t.on(d.document,"keydown",this._paste,this):t.on(d.document,"paste",this._paste,this)},_paste:function(d){if(!(d.type==="keydown"&&!(d.keyCode===86&&(d.ctrlKey||d.metaKey)))){var l=this,n=l.editor,q=n.document;if(l._running)d.halt();else{var h=n.getSelection();d=new B(q);var k=
new s(w.webkit?"<body></body>":"<div></div>",null,q);w.webkit&&k[0].appendChild(q.createTextNode("\u00a0"));q.body.appendChild(k[0]);k.css({position:"absolute",top:h.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});k.css("left","-1000px");var u=h.createBookmarks();d.setStartAt(k,p.POSITION_AFTER_START);d.setEndAt(k,p.POSITION_BEFORE_END);d.select(true);l._running=true;setTimeout(function(){k._4e_remove();var b;k=w.webkit&&(b=k._4e_first())&&b.hasClass("Apple-style-span")?
b:k;h.selectBookmarks(u);n.insertHtml(k.html());l._running=false},0)}}}});r.Paste=i}();x.addPlugin(function(){new r.Paste(x)})});
KISSY.Editor.add("color",function(x){function r(m){return("0"+m).slice(m.length-1,m.length+1)}function A(m){m=w.trim(m);if(m.charAt(0)=="#")m=m.substring(1);m=m.replace(/\s+/g,"");var j="";if(/^[0-9a-f]{3,3}$/i.test(m))j=m.replace(/[0-9a-f]/ig,function(e){return e+e});else{var a=m.match(l);if(a&&a[0])for(m=1;m<4;m++)j+=r(parseInt(a[m]).toString(16));else j=m}return"#"+j.toLowerCase()}for(var s=KISSY.Editor,w=KISSY,B=w.Node,p=w.Event,t=s.SimpleOverlay,i=s.Style,d=w.DOM,l=/^rgb\((\d+),(\d+),(\d+)\)$/i,
n="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),q={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},h={element:"span",styles:{"background-color":"#(color)"}},k="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
u={},b={},c=0;c<5;c++){k+="<tr>";for(var g=0;g<8;g++){var f=A(n[8*c+g]);k+="<td>";k+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+f+"'></span></a>";k+="</td>";u[f]=new i(h,{color:f});b[f]=new i(q,{color:f})}k+="</tr>"}u.inherit=new i(h,{color:"inherit"});b.inherit=new i(q,{color:"inherit"});k+="</table></div>";s.ColorSupport||function(){function m(a){m.superclass.constructor.call(this,a);this._init()}var j=s.TripleButton;m.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};w.extend(m,w.Base,{_init:function(){var a=this.get("editor").toolBarDiv;a=new j({container:a,title:this.get("title"),contentCls:this.get("contentCls")});a.on("offClick",this._showColors,this);this.el=a;s.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(a){var e=this;d._4e_ascendant(a.target,function(o){return o[0]===e.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(a){a.halt();var e=this.get("editor");a=a.target;if(d._4e_name(a)=="span"||d._4e_name(a)=="a"){a=new B(a);
if(a._4e_name()=="a")a=a.one("span");var o=this.get("styles");e.fire("save");a._4e_style("background-color")?o[A(a._4e_style("background-color"))].apply(e.document):o.inherit.remove(e.document);e.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(k);this.colorWin=new t({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);p.on(document,"click",this._hidePanel,this);p.on(x.document,
"click",this._hidePanel,this)},_real:function(){var a=this.el.el.offset();a.top+=this.el.el.height()+5;if(a.left+this.colorPanel.width()>d.viewportWidth()-60)a.left=d.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(a)},_showColors:function(a){this._prepare(a)}});s.ColorSupport=m}();x.addPlugin(function(){new s.ColorSupport({editor:x,styles:u,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new s.ColorSupport({editor:x,styles:b,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("contextmenu",function(){function x(d){this.cfg=s.clone(d);A.Utils.lazyRun(this,"_prepareShow","_realShow")}function r(d,l){for(var n=0;n<l.length;n++){var q=l[n];if(s.isFunction(q)){if(q(new w(d)))return true}else if(B.test(d,q))return true}return false}var A=KISSY.Editor,s=KISSY,w=s.Node,B=s.DOM,p=s.Event;if(!A.ContextMenu){var t=[];x.register=function(d,l){var n=new x(l);t.push({doc:d,rules:l.rules||[],instance:n});if(!d.ke_contextmenu){d.ke_contextmenu=1;p.on(d,"mousedown",x.hide);
p.on(d,"contextmenu",function(q){x.hide.call(this);for(var h=new w(q.target);h;){var k=false;if(h._4e_name()=="body")break;for(var u=0;u<t.length;u++){var b=t[u].instance,c=t[u].rules;if(d===t[u].doc&&r(h[0],c)){q.preventDefault();k=true;setTimeout(function(){b.show(A.Utils.getXY(q.pageX,q.pageY,d,document))},30);break}}if(k)break;h=h.parent()}})}return n};x.hide=function(){for(var d=0;d<t.length;d++){var l=t[d].instance;this===t[d].doc&&l.hide()}};var i=A.SimpleOverlay;s.augment(x,{_init:function(){var d=
this,l=d.cfg,n=l.funcs;d.elDom=new w("<div class='ke-menu' onmousedown='return false;'></div>");var q=d.elDom;q.css("width",l.width);document.body.appendChild(q[0]);d.el=new i({el:q});for(var h in n){l=new w("<a href='#'>"+h+"</a>");q[0].appendChild(l[0]);(function(k,u){k._4e_unselectable();k.on("click",function(b){d.hide();b.halt();setTimeout(u,30)})})(l,n[h])}},hide:function(){this.el&&this.el.hide()},_realShow:function(d){this.el.show(d)},_prepareShow:function(){this._init()},show:function(d){this._prepareShow(d)}});
A.ContextMenu=x}});
KISSY.Editor.add("dd",function(){function x(){x.superclass.constructor.apply(this,arguments);this._init()}function r(){r.superclass.constructor.apply(this,arguments);this._init()}function A(){A.superclass.constructor.apply(this,arguments)}var s=KISSY,w=s.Editor,B=s.Event,p=s.DOM,t=s.Node;if(!w.DD){w.DD={};x.ATTRS={timeThred:{},activeDrag:{},drags:{value:{}}};s.extend(x,s.Base,{_init:function(){w.Utils.lazyRun(this,"_prepare","_real")},reg:function(d){var l=this.get("drags");if(!d[0].id)d[0].id=s.guid("drag-");
l[d[0].id]=d;this._prepare()},_move:function(d){var l=this.get("activeDrag");l&&l._move(d)},_start:function(d){this.set("activeDrag",d);this._pg.css({display:"",height:p.docHeight()})},_end:function(d){var l=this.get("activeDrag");if(l){l._end(d);this.set("activeDrag",null);this._pg.css({display:"none"})}},_prepare:function(){this._pg=(new t("<div style='background-color:red;position:absolute;left:0;width:100%;top:0;z-index:9999;'></div>")).appendTo(document.body);this._pg.css("opacity",0);B.on(document,
"mousemove",w.Utils.throttle(this._move,this,10));B.on(document,"mouseup",this._end,this)},_real:function(){}});w.DD.DDM=new x;var i=w.DD.DDM;r.ATTRS={node:{},handlers:{value:{}}};s.extend(r,s.Base,{_init:function(){var d=this.get("node"),l=this.get("handlers");i.reg(d);if(s.isEmptyObject(l))l[d[0].id]=d;for(var n in l)if(l.hasOwnProperty(n)){var q=l[n],h=q.css("cursor");if(!h||h==="auto")q.css("cursor","move");q._4e_unselectable()}d.on("mousedown",this._handleMouseDown,this);d.on("mouseup",function(){i._end()})},
_check:function(d){var l=this.get("handlers");for(var n in l)if(l.hasOwnProperty(n))if(l[n]._4e_equals(d))return true;return false},_handleMouseDown:function(d){if(this._check(new t(d.target))){d.halt();i._start(this);var l=this.get("node"),n=d.pageX;d=d.pageY;l=l.offset();this.startMousePos={left:n,top:d};this.startNodePos=l;this._diff={left:n-l.left,top:d-l.top};this.fire("start")}},_move:function(d){this.fire("move",d)},_end:function(){}});s.extend(A,r,{_init:function(){A.superclass._init.apply(this,
arguments);var d=this.get("node"),l=this;l.on("move",function(n){d.offset({left:n.pageX-l._diff.left,top:n.pageY-l._diff.top})})}});w.Draggable=r;w.Drag=A}});
KISSY.Editor.add("elementpaths",function(x){var r=KISSY.Editor,A=KISSY,s=A.Node,w=A.DOM;r.ElementPaths||function(){function B(p){this.cfg=p;this._cache=[];this._init()}A.augment(B,{_init:function(){var p=this.cfg.editor;this.holder=new s("<span>");this.holder.appendTo(p.statusDiv);p.on("selectionChange",this._selectionChange,this)},_selectionChange:function(p){var t=this.cfg.editor,i=this.holder;i=i[0]||i;p=p.path.elements;var d,l;d=this._cache;for(l=0;l<d.length;l++){d[l].detach("click");d[l]._4e_remove()}this._cache=
[];for(l=0;l<p.length;l++){d=p[l];var n=new s("<a href='#' class='elementpath'>"+(d.attr("_ke_real_element_type")||d._4e_name())+"</a>");this._cache.push(n);(function(q){n.on("click",function(h){h.halt();t.focus();setTimeout(function(){t.getSelection().selectElement(q)},50)})})(d);i.firstChild?w.insertBefore(n[0],i.firstChild):i.appendChild(n[0])}}});r.ElementPaths=B}();x.addPlugin(function(){new r.ElementPaths({editor:x})})});
KISSY.Editor.add("enterkey",function(x){var r=KISSY.Editor,A=KISSY,s=A.UA,w=/^h[1-6]$/,B=r.XHTML_DTD,p=A.Node,t=A.Event,i=r.Walker,d=r.ElementPath;r.enterBlock||function(){function l(h){h=h.getSelection().getRanges();for(var k=h.length-1;k>0;k--)h[k].deleteContents();return h[0]}function n(h){var k=l(h),u=k.document;if(k.checkStartOfBlock()&&k.checkEndOfBlock()){var b=(new d(k.startContainer)).block;if(b&&(b._4e_name()=="li"||b.parent()._4e_name()=="li")){h.execCommand("outdent");return}}var c=k.splitBlock("p");
if(c){h=c.previousBlock;b=c.nextBlock;var g=c.wasStartOfBlock,f=c.wasEndOfBlock,m;if(b){m=b.parent();if(m._4e_name()=="li"){b._4e_breakParent(m);b._4e_move(b._4e_next(),true)}}else if(h&&(m=h.parent())&&m._4e_name()=="li"){h._4e_breakParent(m);k.moveToElementEditablePosition(h._4e_next());h._4e_move(h._4e_previous())}if(!g&&!f){if(b._4e_name()=="li"&&(m=b._4e_first(i.invisible(true)))&&A.inArray(m._4e_name(),["ul","ol"]))(s.ie?new p(u.createTextNode("\u00a0")):new p(u.createElement("br"))).insertBefore(m);
b&&k.moveToElementEditablePosition(b)}else{var j;if(h){if(h._4e_name()=="li"||!w.test(h._4e_name()))j=h._4e_clone()}else if(b)j=b._4e_clone();j||(j=new p("p",null,u));if(m=c.elementPath){c=0;for(var a=m.elements.length;c<a;c++){var e=m.elements[c];if(e._4e_equals(m.block)||e._4e_equals(m.blockLimit))break;if(B.$removeEmpty[e._4e_name()]){e=e._4e_clone();j._4e_moveChildren(e);j.append(e)}}}s.ie||j._4e_appendBogus();k.insertNode(j);if(s.ie&&g&&(!f||!h[0].childNodes.length)){k.moveToElementEditablePosition(f?
h:j);k.select()}k.moveToElementEditablePosition(g&&!f?b:j)}if(!s.ie)if(b){u=new p(u.createElement("span"));u.html("&nbsp;");k.insertNode(u);u._4e_scrollIntoView();k.deleteContents()}else j._4e_scrollIntoView();k.select()}}function q(h){t.on(h.document,"keydown",function(k){if(k.keyCode===13)if(!k.shiftKey){h.execCommand("enterBlock");k.preventDefault()}})}q.enterBlock=n;r.EnterKey=q}();x.addPlugin(function(){x.addCommand("enterBlock",{exec:r.EnterKey.enterBlock});r.EnterKey(x)})});
KISSY.Editor.add("fakeobjects",function(x){var r=KISSY.Editor,A=KISSY,s=A.Node,w=r.NODE,B=r.Config.base+"theme/spacer.gif",p=r.HtmlParser;r=A.Editor;var t=(x=x.htmlDataProcessor)&&x.htmlFilter,i={elements:{$:function(d){var l=d.attributes;if((l=(l=(l=l&&l._ke_realelement)&&new p.Fragment.FromHtml(decodeURIComponent(l)))&&l.children[0])&&d.attributes._ke_resizable){var n=d.attributes.style;if(n){var q=/(?:^|\s)width\s*:\s*(\d+)/i.exec(n);d=q&&q[1];n=(q=/(?:^|\s)height\s*:\s*(\d+)/i.exec(n))&&q[1];
if(d)l.attributes.width=d;if(n)l.attributes.height=n}}return l}}};t&&t.addRules(i);x&&A.mix(x,{createFakeParserElement:function(d,l,n,q,h){var k;k=new p.BasicWriter;d.writeHtml(k);k=k.getHtml();var u=d.attributes.style;if(d.attributes.width)u="width:"+d.attributes.width+"px;"+u;if(d.attributes.height)u="height:"+d.attributes.height+"px;"+u;d={"class":l,src:B,_ke_realelement:encodeURIComponent(k),_ke_real_node_type:d.type,style:u,align:d.attributes.align||""};h&&delete h.width;h&&delete h.height;h&&
A.mix(d,h,false);if(n)d._ke_real_element_type=n;if(q)d._ke_resizable=q;return new p.Element("img",d)}});A.augment(r,{createFakeElement:function(d,l,n,q,h,k){var u=d.attr("style")||"";if(d.attr("width"))u="width:"+d.attr("width")+"px;"+u;if(d.attr("height"))u="height:"+d.attr("height")+"px;"+u;d={"class":l,src:B,_ke_realelement:encodeURIComponent(h||d._4e_outerHtml()),_ke_real_node_type:d[0].nodeType,align:d.attr("align")||"",style:u};k&&delete k.width;k&&delete k.height;k&&A.mix(d,k,false);if(n)d._ke_real_element_type=
n;if(q)d._ke_resizable=q;return new s("<img/>",d,this.document)},restoreRealElement:function(d){if(d.attr("_ke_real_node_type")!=w.NODE_ELEMENT)return null;d=decodeURIComponent(d.attr("_ke_realelement"));var l=new s("<div>",null,this.document);l.html(d);return l._4e_first(function(n){return n[0].nodeType==w.NODE_ELEMENT})._4e_remove()}})});KISSY.Editor.add("flash",function(x){x.addPlugin(function(){new KISSY.Editor.Flash(x)})});
KISSY.Editor.add("flashsupport",function(x){var r=KISSY.Editor,A=KISSY,s=A.UA,w=A.Event,B=r.ContextMenu,p=A.Node,t=r.BubbleView,i=r.TripleButton,d=r.SimpleOverlay,l=x.htmlDataProcessor,n="ke_flash",q=r.Utils.flash;x=l&&l.dataFilter;r.Flash||function(){function h(g){this.editor=g;this._init()}function k(g){return g._4e_name()==="img"&&!!g.hasClass(n)&&g}var u=/\.swf(?:$|\?)/i,b="<p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p><p style='margin:5px 0'><label>\u5bf9\u9f50\uff1a <select class='ke-flash-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
r.Utils.duplicateStr("&nbsp;",13)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-flash-margin' style='width:90px' value='5'/> px</label><p>";h.isFlashEmbed=function(g){g=g.attributes;return g.type=="application/x-shockwave-flash"||u.test(g.src||"")};A.augment(h,{_config:function(){this._cls=n;this._type="flash";this._title="Flash\u5c5e\u6027";this._bodyHtml=b;this._footHtml="<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button>";this._contentCls=
"ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=c;this._flashRules=["img."+n]},_init:function(){this._config();var g=this.editor,f={},m=this._contextMenu;g._toolbars=g._toolbars||{};g._toolbars[this._type]=this;this.el=new i({container:g.toolBarDiv,contentCls:this._contentCls,title:this._tip});this.el.on("click",this.show,this);if(m)for(var j in m)(function(a){f[a]=function(){m[a](g)}})(j);B.register(g.document,{rules:this._flashRules,width:"120px",funcs:f});t.attach({pluginName:this._type,
pluginInstance:this});w.on(g.document,"dblclick",this._dbclick,this);r.Utils.lazyRun(this,"_prepareShow","_realShow")},_getFlashUrl:function(g){return q.getUrl(g)},_updateTip:function(g,f){f=this.editor.restoreRealElement(f);g.html(this._getFlashUrl(f));g.attr("href",this._getFlashUrl(f))},_dbclick:function(g){var f=new p(g.target);if(f._4e_name()==="img"&&f.hasClass(this._cls)){this.show(null,f);g.halt()}},_prepareShow:function(){var g=new d({title:this._title,width:this._config_dwidth||"350px",
mask:true});g.body.html(this._bodyHtml);g.foot.html(this._footHtml);this.d=g;this._initD()},_realShow:function(){this._updateD();this.d.show()},_updateD:function(){var g=this.editor,f=this.selectedFlash;if(f){g=g.restoreRealElement(f);g.attr("width")&&this.dWidth.val(parseInt(g.attr("width")));g.attr("height")&&this.dHeight.val(parseInt(g.attr("height")));this.dAlign.val(g.attr("align"));this.dUrl.val(this._getFlashUrl(g));this.dMargin.val(parseInt(g._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");
this.dWidth.val("");this.dHeight.val("");this.dAlign.val("");this.dMargin.val("5")}},show:function(g,f){this.selectedFlash=f;this._prepareShow()},_initD:function(){var g=this,f=g.d;g.dHeight=f.el.one(".ke-flash-height");g.dWidth=f.el.one(".ke-flash-width");g.dUrl=f.el.one(".ke-flash-url");g.dAlign=f.el.one(".ke-flash-align");g.dMargin=f.el.one(".ke-flash-margin");var m=f.el.one(".ke-flash-ok");f=f.el.one(".ke-flash-cancel");m.on("click",g._gen,g);f.on("click",function(){g.d.hide()})},_getDInfo:function(){return{url:this.dUrl.val(),
attrs:{width:this.dWidth.val(),height:this.dHeight.val(),align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px"}}},_gen:function(){var g=this.editor,f=this._getDInfo(),m=f&&A.trim(f.url);f=f&&f.attrs;if(m){m=q.createSWF(m,f,g.document);var j=m.el;f=g.createFakeElement?g.createFakeElement(j,this._cls,this._type,true,m.html,f):j;f=g.insertElement(f);this.selectedFlash&&g.getSelection().selectElement(f);this.d.hide()}}});r.Flash=h;h.registerBubble=function(g,f,m){t.register({pluginName:g,
func:m,init:function(){var j=this,a=j.el;a.html(f+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');var e=a.one(".ke-bubbleview-url"),o=a.one(".ke-bubbleview-change");a=a.one(".ke-bubbleview-remove");o._4e_unselectable();e._4e_unselectable();a._4e_unselectable();o.on("click",function(v){j._plugin.show(null,j._selectedEl);v.halt()});
a.on("click",function(v){var y=j._plugin;if(s.webkit){var C=y.editor.getSelection().getRanges();C&&C[0]&&(C[0].collapse(true)||1)&&C[0].select()}j._selectedEl._4e_remove();j.hide();y.editor.notifySelectionChange();v.halt()});j.on("beforeVisibleChange",function(v){var y=j._selectedEl;v.newVal&&y&&j._plugin._updateTip(e,y)})}})};h.registerBubble("flash","Flash \u7f51\u5740\uff1a ",k);h.checkFlash=k;var c={"Flash\u5c5e\u6027":function(g){var f=g.getSelection();f=f&&f.getStartElement();f=k(f);g=g._toolbars.flash;
f&&g.show(null,f)}};h.CLS_FLASH=n;h.TYPE_FLASH="flash"}();x&&x.addRules({elements:{object:function(h){var k=h.attributes;if(!(k.classid&&String(k.classid).toLowerCase())){for(k=0;k<h.children.length;k++)if(h.children[k].name=="embed"){if(!r.Flash.isFlashEmbed(h.children[k]))return null;return l.createFakeParserElement(h,n,"flash",true)}return null}return l.createFakeParserElement(h,n,"flash",true)},embed:function(h){if(!r.Flash.isFlashEmbed(h))return null;return l.createFakeParserElement(h,n,"flash",
true)}}},5)});
KISSY.Editor.add("flashutils",function(){var x=KISSY,r=x.Editor,A=r.Utils.flash;if(!A){var s=x.DOM,w=x.Node;A={getUrl:function(B){var p="",t=r.NODE;if(B._4e_name()=="object"){B=B[0].childNodes;for(var i=0;i<B.length;i++)if(B[i].nodeType==t.NODE_ELEMENT)if((s.attr(B[i],"name")||"").toLowerCase()=="movie")p=s.attr(B[i],"value");else if(s._4e_name(B[i])=="embed")p=s.attr(B[i],"src");else if(s._4e_name(B[i])=="object")p=s.attr(B[i],"data")}else if(B._4e_name()=="embed")p=B.attr("src");return p},createSWF:function(B,
p,t){t=t||document;attrs_str="";if(p)for(var i in p)attrs_str+=i+"='"+p[i]+"' ";B="<object "+attrs_str+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" <param name="quality" value="high" /><param name="movie" value="'+B+'" /><embed '+attrs_str+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+B+'"  type="application/x-shockwave-flash"/></object>';return{el:new w(B,null,t),html:B}}};r.Utils.flash=A}});
KISSY.Editor.add("font",function(x){var r=KISSY.Editor,A=KISSY,s=r.Style,w=r.TripleButton,B=x.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],p={},t=[],i={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},d=x.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],l={},n=[],q={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},h;x.cfg.pluginConfig["font-size"]=B;x.cfg.pluginConfig["font-family"]=d;for(h=0;h<B.length;h++){var k=B[h];p[k]=new s(i,{size:k});t.push({name:k,value:k})}for(h=0;h<d.length;h++){B=d[h];l[B]=new s(q,{family:B});n.push({name:B,value:B,attrs:{style:"font-family:"+B}})}r.Font||function(){function u(c){u.superclass.constructor.call(this,c);this._init()}function b(c){b.superclass.constructor.call(this,
c);this._init()}u.ATTRS={title:{},html:{},styles:{},editor:{}};A.extend(u,A.Base,{_init:function(){var c=this.get("editor"),g=c.toolBarDiv;this.get("html");this.el=new r.Select({container:g,doc:c.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);c.on("selectionChange",this._selectionChange,this)},_vChange:function(c){var g=this.get("editor"),f=c.newVal;c=c.preVal;var m=this.get("styles");g.focus();
g.fire("save");if(f==c){m[f].remove(g.document);this.el.set("value","")}else m[f].apply(g.document);g.fire("save")},_selectionChange:function(c){this.get("editor");c=c.path.elements;for(var g=this.get("styles"),f=0,m;f<c.length;f++){m=c[f];for(var j in g)if(g[j].checkElementRemovable(m,true)){this.el.set("value",j);return}}this.el.reset("value")}});b.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};A.extend(b,A.Base,{_init:function(){var c=this.get("editor"),g=this.get("text");this.get("style");
var f=this.get("title");this.el=new w({text:g,title:f,contentCls:this.get("contentCls"),container:c.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);c.on("selectionChange",this._selectionChange,this)},_on:function(){var c=this.get("editor");this.get("text");var g=this.get("style");this.get("title");c.fire("save");g.apply(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_off:function(){var c=this.get("editor");this.get("text");var g=this.get("style");
this.get("title");c.fire("save");g.remove(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_selectionChange:function(c){this.get("editor");this.get("text");var g=this.get("style");this.get("title");g.checkActive(c.path)?this.el.set("state",w.ON):this.el.set("state",w.OFF)}});u.SingleFont=b;r.Font=u}();x.addPlugin(function(){new r.Font({editor:x,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:p,html:t});new r.Font({editor:x,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:l,html:n});new r.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:x,style:new s({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new r.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:x,style:new s({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new r.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:x,style:new s({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new r.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:x,style:new s({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(x){var r=KISSY.Editor,A=KISSY,s=[],w={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},B={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},p={},t=r.Style;for(var i in w)if(w[i]){p[w[i]]=new t({element:w[i]});s.push({name:i,value:w[i],attrs:{style:"font-size:"+B[w[i]]}})}r.Format||function(){function d(l){d.superclass.constructor.call(this,
l);this._init()}d.ATTRS={editor:{}};A.extend(d,A.Base,{_init:function(){var l=this.get("editor");this.el=new r.Select({container:l.toolBarDiv,value:"",doc:l.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);l.on("selectionChange",this._selectionChange,this)},_vChange:function(l){var n=this.get("editor"),q=l.newVal;l=l.preVal;n.fire("save");if(q!=l)p[q].apply(n.document);else{p.p.apply(n.document);
this.el.set("value","p")}n.fire("save")},_selectionChange:function(l){this.get("editor");l=l.path;for(var n in p)if(p[n].checkActive(l)){this.el.set("value",n);return}this.el.reset("value")}});r.Format=d}();x.addPlugin(function(){new r.Format({editor:x,html:s,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function x(){this._={output:[]}}var r=KISSY.Editor,A=r.Utils;if(!r.HtmlParser.BasicWriter){KISSY.augment(x,{openTag:function(s){this._.output.push("<",s)},openTagClose:function(s,w){w?this._.output.push(" />"):this._.output.push(">")},attribute:function(s,w){if(typeof w=="string")w=A.htmlEncodeAttr(w);this._.output.push(" ",s,'="',w,'"')},closeTag:function(s){this._.output.push("</",s,">")},text:function(s){this._.output.push(s)},comment:function(s){this._.output.push("<!--",
s,"--\>")},write:function(s){this._.output.push(s)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(s){var w=this._.output.join("");s&&this.reset();return w}});r.HtmlParser.BasicWriter=x}});
KISSY.Editor.add("htmlparser-comment",function(){function x(s){this.value=s;this._={isBlockLike:false}}var r=KISSY.Editor,A=r.NODE;if(!r.HtmlParser.Comment){r.HtmlParser.Comment=x;x.prototype={constructor:x,type:A.NODE_COMMENT,writeHtml:function(s,w){var B=this.value;if(w){if(!(B=w.onComment(B,this)))return;if(typeof B!="string"){B.parent=this.parent;B.writeHtml(s,w);return}}s.comment(B)}}}});
KISSY.Editor.add("htmlparser-element",function(){function x(w,B){this.name=w;this.attributes=B||(B={});this.children=[];var p=B._ke_real_element_type||w;B=r.XHTML_DTD;p=!!(B.$nonBodyContent[p]||B.$block[p]||B.$listItem[p]||B.$tableContent[p]||B.$nonEditable[p]||p=="br");var t=!!B.$empty[w];this.isEmpty=t;this.isUnknown=!B[w];this._={isBlockLike:p,hasInlineStarted:t||!p}}var r=KISSY.Editor;if(!r.HtmlParser.Element){var A=r.NODE,s=function(w,B){w=w[0];B=B[0];return w<B?-1:w>B?1:0};KISSY.augment(x,{type:A.NODE_ELEMENT,
add:r.HtmlParser.Fragment.prototype.add,clone:function(){return new x(this.name,this.attributes)},writeHtml:function(w,B){var p=this.attributes,t=this,i=t.name,d,l,n,q;t.filterChildren=function(){if(!q){var u=new r.HtmlParser.BasicWriter;r.HtmlParser.Fragment.prototype.writeChildrenHtml.call(t,u,B);t.children=(new r.HtmlParser.Fragment.FromHtml(u.getHtml())).children;q=1}};if(B){for(;;){if(!(i=B.onElementName(i)))return;t.name=i;if(!(t=B.onElement(t)))return;t.parent=this.parent;if(t.name==i)break;
if(t.type!=A.NODE_ELEMENT){t.writeHtml(w,B);return}i=t.name;if(!i){this.writeChildrenHtml.call(t,w,q?null:B);return}}p=t.attributes}w.openTag(i,p);for(var h=[],k=0;k<2;k++)for(d in p){l=d;n=p[d];if(k==1)h.push([d,n]);else if(B){for(;;)if(l=B.onAttributeName(d))if(l!=d){delete p[d];d=l}else break;else{delete p[d];break}if(l)if((n=B.onAttribute(t,l,n))===false)delete p[l];else p[l]=n}}w.sortAttributes&&h.sort(s);p=h.length;for(k=0;k<p;k++){d=h[k];w.attribute(d[0],d[1])}w.openTagClose(i,t.isEmpty);if(!t.isEmpty){this.writeChildrenHtml.call(t,
w,q?null:B);w.closeTag(i)}},writeChildrenHtml:function(){r.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});r.HtmlParser.Element=x}});
KISSY.Editor.add("htmlparser-filter",function(){function x(i){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};i&&this.addRules(i,10)}function r(i,d){for(var l=0;i&&l<d.length;l++){var n=d[l];i=i.replace(n[0],n[1])}return i}function A(i,d,l){if(typeof d=="function")d=[d];var n,q;q=i.length;var h=d&&d.length;if(h){for(n=0;n<q&&i[n].pri<l;n++);for(q=h-1;q>=0;q--)if(h=d[q]){h.pri=l;i.splice(n,0,h)}}}function s(i,d,l){if(d)for(var n in d){var q=i[n];i[n]=w(q,d[n],
l);q||i.$length++}}function w(i,d,l){if(d){d.pri=l;if(i){if(i.splice)A(i,d,l);else{i=i.pri>l?[d,i]:[i,d];i.filter=B}return i}else return d.filter=d}}function B(i){for(var d=i.type||i instanceof p.HtmlParser.Fragment,l=0;l<this.length;l++){if(d)var n=i.type,q=i.name;var h=this[l].apply(window,arguments);if(h===false)return h;if(d){if(h&&(h.name!=q||h.type!=n))return h}else if(typeof h!="string")return h;h!=undefined&&(i=h)}return i}var p=KISSY.Editor,t=p.NODE;if(!p.HtmlParser.Filter){KISSY.augment(x,
{addRules:function(i,d){if(typeof d!="number")d=10;A(this._.elementNames,i.elementNames,d);A(this._.attributeNames,i.attributeNames,d);s(this._.elements,i.elements,d);s(this._.attributes,i.attributes,d);this._.text=w(this._.text,i.text,d)||this._.text;this._.comment=w(this._.comment,i.comment,d)||this._.comment;this._.root=w(this._.root,i.root,d)||this._.root},onElementName:function(i){return r(i,this._.elementNames)},onAttributeName:function(i){return r(i,this._.attributeNames)},onText:function(i){var d=
this._.text;return d?d.filter(i):i},onComment:function(i,d){var l=this._.comment;return l?l.filter(i,d):i},onFragment:function(i){var d=this._.root;return d?d.filter(i):i},onElement:function(i){for(var d=[this._.elements["^"],this._.elements[i.name],this._.elements.$],l,n=0;n<3;n++)if(l=d[n]){l=l.filter(i,this);if(l===false)return null;if(l&&l!=i)return this.onNode(l);if(i.parent&&!i.name)break}return i},onNode:function(i){var d=i.type;return d==t.NODE_ELEMENT?this.onElement(i):d==t.NODE_TEXT?new p.HtmlParser.Text(this.onText(i.value)):
null},onAttribute:function(i,d,l){if(d=this._.attributes[d]){i=d.filter(l,i,this);if(i===false)return false;if(typeof i!="undefined")return i}return l}});p.HtmlParser.Filter=x}});
KISSY.Editor.add("htmlparser-fragment",function(){function x(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var r=KISSY.Editor;if(!r.HtmlParser.Fragment){var A={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},s=KISSY,w=r.Utils,B=r.NODE,p=r.XHTML_DTD,t=w.mix({table:1,ul:1,ol:1,dl:1},p.table,p.ul,p.ol,p.dl),i=p.$list,d=p.$listItem;x.FromHtml=function(l,n){function q(e){var o;if(c.length>0)for(var v=0;v<c.length;v++){var y=c[v],C=y.name,H=
p[C],N=f.name&&p[f.name];if((!N||N[C])&&(!e||!H||H[e]||!p[e])){if(!o){h();o=1}y=y.clone();y.parent=f;f=y;c.splice(v,1);v--}}}function h(){for(;g.length;)f.add(g.shift())}function k(e,o,v){o=o||f||b;if(n&&!o.type){var y,C;if((y=e.attributes&&(C=e.attributes._ke_real_element_type)?C:e.name)&&!(y in p.$body)&&!(y in p.$nonBodyContent)){y=f;f=o;u.onTagOpen(n,{});o=f;if(v)f=y}}if(e._.isBlockLike&&e.name!="pre"){v=e.children.length;if((y=e.children[v-1])&&y.type==B.NODE_TEXT)if(C=w.rtrim(y.value))y.value=
C;else e.children.length=v-1}o.add(e);if(e.returnPoint){f=e.returnPoint;delete e.returnPoint}}var u=new r.HtmlParser,b=new x,c=[],g=[],f=b,m=false,j;u.onTagOpen=function(e,o,v){var y=new r.HtmlParser.Element(e,o);if(y.isUnknown&&v)y.isEmpty=true;if(p.$removeEmpty[e])c.push(y);else{if(e=="pre")m=true;else if(e=="br"&&m){f.add(new r.HtmlParser.Text("\n"));return}if(e=="br")g.push(y);else{var C=f.name,H=C&&(p[C]||(f._.isBlockLike?p.div:p.span));if(H&&!y.isUnknown&&!f.isUnknown&&!H[e]){H=false;var N;
if(e in i&&C in i){C=f.children;(C=C[C.length-1])&&C.name in d||k(C=new r.HtmlParser.Element("li"),f);j=f;N=C}else if(e==C)k(f,f.parent);else{if(t[C])j||(j=f);else{k(f,f.parent,true);A[C]||c.unshift(f)}H=true}f=N?N:f.returnPoint||f.parent;if(H){u.onTagOpen.apply(this,arguments);return}}q(e);h();y.parent=f;y.returnPoint=j;j=0;if(y.isEmpty)k(y);else f=y}}};u.onTagClose=function(e){for(var o=c.length-1;o>=0;o--)if(e==c[o].name){c.splice(o,1);return}for(var v=[],y=[],C=f;C.type&&C.name!=e;){C._.isBlockLike||
y.unshift(C);v.push(C);C=C.parent}if(C.type){for(o=0;o<v.length;o++){var H=v[o];k(H,H.parent)}f=C;if(f.name=="pre")m=false;C._.isBlockLike&&h();k(C,C.parent);if(C==f)f=f.parent;c=c.concat(y)}if(e=="body")n=false};u.onText=function(e){if(!f._.hasInlineStarted&&!m){e=w.ltrim(e);if(e.length===0)return}h();q();if(n&&(!f.type||f.name=="body")&&w.trim(e))this.onTagOpen(n,{});m||(e=e.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));f.add(new r.HtmlParser.Text(e))};u.onCDATA=function(){};u.onComment=function(e){f.add(new r.HtmlParser.Comment(e))};
u.parse(l);for(h();f.type;){l=f.parent;var a=f;if(n&&(!l.type||l.name=="body")&&!p.$body[a.name]){f=l;u.onTagOpen(n,{});l=f}l.add(a);f=l}return b};s.augment(x,{add:function(l){var n=this.children.length;if(n=n>0&&this.children[n-1]||null){if(l._.isBlockLike&&n.type==B.NODE_TEXT){n.value=w.rtrim(n.value);if(n.value.length===0){this.children.pop();this.add(l);return}}n.next=l}l.previous=n;l.parent=this;this.children.push(l);this._.hasInlineStarted=l.type==B.NODE_TEXT||l.type==B.NODE_ELEMENT&&!l._.isBlockLike},
writeHtml:function(l,n){var q;this.filterChildren=function(){var h=new r.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,h,n,true);h=h.getHtml();this.children=(new x.FromHtml(h)).children;q=1};!this.name&&n&&n.onFragment(this);this.writeChildrenHtml(l,q?null:n)},writeChildrenHtml:function(l,n){for(var q=0;q<this.children.length;q++)this.children[q].writeHtml(l,n)}});r.HtmlParser.Fragment=x}});
KISSY.Editor.add("htmlparser",function(){function x(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var r=KISSY.Editor;if(!r.HtmlParser){var A=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,s={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},w=r.XHTML_DTD;KISSY.augment(x,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var p,t,i=0,d;p=this._.htmlPartsRegex.exec(B);){t=p.index;if(t>i){i=B.substring(i,t);d?d.push(i):this.onText(i)}i=this._.htmlPartsRegex.lastIndex;if(t=p[1]){t=t.toLowerCase();if(d&&w.$cdata[t]){this.onCDATA(d.join(""));d=null}if(!d){this.onTagClose(t);continue}}if(d)d.push(p[0]);else if(t=p[3]){t=t.toLowerCase();var l={},n;p=p[4];var q=!!(p&&p.charAt(p.length-1)=="/");if(p)for(;n=A.exec(p);){var h=
n[1].toLowerCase();n=n[2]||n[3]||n[4]||"";l[h]=!n&&s[h]?h:n}this.onTagOpen(t,l,q);if(!d&&w.$cdata[t])d=[]}else if(t=p[2])this.onComment(t)}B.length>i&&this.onText(B.substring(i,B.length))}});r.HtmlParser=x}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function x(){x.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var s=r.XHTML_DTD;for(var w in A.mix({},s.$nonBodyContent,s.$block,s.$listItem,s.$tableContent))this.setRules(w,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!s[w]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var r=KISSY.Editor,A=r.Utils;if(!r.HtmlParser.HtmlWriter){KISSY.extend(x,r.HtmlParser.BasicWriter,{openTag:function(s){var w=this._.rules[s];if(this._.indent)this.indentation();else if(w&&w.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",s)},openTagClose:function(s,w){s=this._.rules[s];
if(w)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(s&&s.indent)this._.indentation+=this.indentationChars}s&&s.breakAfterOpen&&this.lineBreak()},attribute:function(s,w){if(typeof w=="string"){this.forceSimpleAmpersand&&(w=w.replace(/&amp;/g,"&"));w=A.htmlEncodeAttr(w)}this._.output.push(" ",s,'="',w,'"')},closeTag:function(s){var w=this._.rules[s];if(w&&w.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(w&&w.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",s,">");w&&w.breakAfterClose&&this.lineBreak()},text:function(s){if(this._.indent){this.indentation();s=A.ltrim(s)}this._.output.push(s)},comment:function(s){this._.indent&&this.indentation();this._.output.push("<!--",s,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(s,w){var B=this._.rules[s];if(B)A.mix(B,w);else this._.rules[s]=w}});r.HtmlParser.HtmlWriter=x}});KISSY.Editor.add("htmlparser-text",function(){function x(A){this.value=A;this._={isBlockLike:false}}var r=KISSY.Editor;if(!r.HtmlParser.Text){KISSY.augment(x,{type:r.NODE.NODE_TEXT,writeHtml:function(A,s){var w=this.value;s&&!(w=s.onText(w,this))||A.text(w)}});r.HtmlParser.Text=x}});
KISSY.Editor.add("htmldataprocessor",function(x){function r(j){if(/mso-list\s*:\s*Ignore/i.test(j.attributes&&j.attributes.style))return true;return p}function A(j,a){var e=new t.HtmlParser.Element("ke:listbullet"),o;if(j)if(j[2]){j=isNaN(j[1])?/^[a-z]+$/.test(j[1])?"lower-alpha":/^[A-Z]+$/.test(j[1])?"upper-alpha":"decimal":"decimal";o="ol"}else{j=/[l\u00B7\u2002]/.test(j[1])?"disc":/[\u006F\u00D8]/.test(j[1])?"circle":/[\u006E\u25C6]/.test(j[1])?"square":"disc";o="ul"}else{j="decimal";o="ol"}e.attributes=
{"ke:listtype":o,style:"list-style-type:"+j+";"};e.add(new t.HtmlParser.Text(a));return e}function s(j){var a=j.attributes,e;if((e=j.removeAnyChildWithName("ke:listbullet"))&&e.length&&(e=e[0])){j.name="ke:li";if(a.style)a.style=w([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(o){o=o.split(" ");o=o[3]||o[1]||o[0];o=parseInt(o,10);if(!b&&c&&o>c)b=o-c;a["ke:margin"]=c=o}]],p)(a.style,j)||"";e=e.attributes;j.addStyle(e.style);i.mix(a,e);return true}return false}function w(j,a){return function(e,
o){var v=[];e.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(y,C,H){C=C.toLowerCase();C=="font-family"&&(H=H.replace(/["']/g,""));for(var N,z,D,I=0;I<j.length;I++)if(j[I]){y=j[I][0];N=j[I][1];z=j[I][2];D=j[I][3];if(C.match(y)&&(!N||H.match(N))){C=D||C;a&&(z=z||H);if(typeof z=="function")z=z(H,o,C);if(z&&z.push){C=z[0];z=z[1]}typeof z=="string"&&v.push([C,z]);return}}!a&&v.push([C,H])});for(e=0;e<v.length;e++)v[e]=v[e].join(":");return v.length?v.join(";")+";":false}}
function B(j){j=j.children;for(var a,e,o,v,y,C,H,N=0;N<j.length;N++){a=j[N];if("ke:li"==a.name){a.name="li";e=a.attributes;o=a.attributes["ke:listtype"];v=parseInt(e["ke:indent"],10)||b&&Math.ceil(e["ke:margin"]/b)||1;e.style&&(e.style=w([["list-style-type",o=="ol"?"decimal":"disc"]],p)(e.style)||"");if(C){if(v>H){C=new t.HtmlParser.Element(o);C.add(a);y.add(C)}else{if(v<H){y=H-v;for(var z;y--&&(z=C.parent);)C=z.parent}C.add(a)}j.splice(N--,1)}else{C=new t.HtmlParser.Element(o);C.add(a);j[N]=C}y=
a;H=v}else C=null}b=0}var p=p,t=KISSY.Editor,i=KISSY,d=i.UA,l=t.NODE,n=t.HtmlParser,q=new n.Filter,h=new n.Filter,k=t.XHTML_DTD;if(!x.htmlDataProcessor){(function(){var j=t.HtmlParser.Fragment.prototype,a=t.HtmlParser.Element.prototype;j.onlyChild=a.onlyChild=function(){var e=this.children;return e.length==1&&e[0]||null};a.removeAnyChildWithName=function(e){for(var o=this.children,v=[],y,C=0;C<o.length;C++){y=o[C];if(y.name){if(y.name==e){v.push(y);o.splice(C--,1)}v=v.concat(y.removeAnyChildWithName(e))}}return v};
a.getAncestor=function(e){for(var o=this.parent;o&&!(o.name&&o.name.match(e));)o=o.parent;return o};j.firstChild=a.firstChild=function(e){for(var o,v=0;v<this.children.length;v++){o=this.children[v];if(e(o))return o;else if(o.name)if(o=o.firstChild(e))return o}return null};a.addStyle=function(e,o,v){var y="";if(typeof o=="string")y+=e+":"+o+";";else{if(typeof e=="object")for(var C in e){if(e.hasOwnProperty(C))y+=C+":"+e[C]+";"}else y+=e;v=o}if(!this.attributes)this.attributes={};e=this.attributes.style||
"";e=(v?[y,e]:[e,y]).join(";");this.attributes.style=e.replace(/^;|;(?=;)/,"")};k.parentOf=function(e){var o={};for(var v in this)if(v.indexOf("$")==-1&&this[v][e])o[v]=1;return o}})();var u=w([[/mso/i],[/font-size/i,"",function(j){for(var a=x.cfg.pluginConfig["font-size"],e=0;e<a.length;e++)if(j.toLowerCase()==a[e])return j;return false},"font-size"],[/font-family/i,"",function(j){for(var a=x.cfg.pluginConfig["font-family"],e=0;e<a.length;e++)if(j.toLowerCase()==a[e].toLowerCase())return j;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],p),b,c=0,g=k.parentOf("ol"),f={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(j){j.filterChildren();B(j)},elements:{font:function(j){delete j.name},p:function(j){j.filterChildren();if(s(j))return p},$:function(j){var a=j.name||"";a.indexOf(":")!=-1&&a.indexOf("ke")==-1&&delete j.name;var e=j.attributes.style;if(a=="span"&&(!e||!u(e)))delete j.name;
if(a in g){j.filterChildren();B(j)}},table:function(j){var a=j.attributes.border;if(!a||a=="0")j.attributes["class"]="ke_show_border"},td:function(j){if(d.ie){j=j.children;var a=new t.HtmlParser.Text("&nbsp;");if(j.length)j[j.length-1].type!=l.NODE_TEXT&&j.push(a);else j.push(a)}},span:function(j){if(!d.gecko&&r(j.parent))return false;if(!d.gecko&&r(j)){j=(j=j.firstChild(function(e){return e.value||e.name=="img"}))&&(j.value||"l.");var a=j.match(/^([^\s]+?)([.)]?)$/);return A(a,j)}}},comment:!d.ie?
function(j,a){var e=j.match(/<img.*?>/);if(j=j.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){e=(a=j[1]||e&&"l.")&&a.match(/>([^\s]+?)([.)]?)</);return A(e,a)}if(d.gecko&&e){e=t.HtmlParser.Fragment.FromHtml(e[0]).children[0];(a=(a=(a=a.previous)&&a.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&a[1])&&(e.attributes.src=a);return e}return false}:function(){return false},attributes:{"class":function(j){if(/^ke_/.test(j))return j;return false},style:function(j){j=u(j);if(!j)return false;
return j}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},m={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(j){var a=j.parent;if(a&&a.name=="object"){var e=a.attributes.width;a=a.attributes.height;e&&(j.attributes.width=e);a&&(j.attributes.height=a)}},param:function(j){j.children=[];j.isEmpty=true;return j},a:function(j){if(!(j.children.length||j.attributes.name))return false},td:function(j){for(var a=j.children,e=0;e<a.length;e++)if(a[e].name=="br"){a.splice(e,1);--e}if(!j.children.length){a=
new t.HtmlParser.Text("&nbsp;");j.children.push(a)}},span:function(j){if(!j.children.length)return false}},attributes:{style:function(j){if(!i.trim(j))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(d.ie)m.attributes.style=function(j){return j.toLowerCase()};q.addRules(m);h.addRules(f);x.htmlDataProcessor={htmlFilter:q,dataFilter:h,toHtml:function(j,a){var e=new n.HtmlWriter;n.Fragment.FromHtml(j,a).writeHtml(e,q);return e.getHtml(true)},toDataFormat:function(j,a){if(d.gecko)j=
j.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var e=new n.BasicWriter;j=n.Fragment.FromHtml(j,a);e.reset();j.writeHtml(e,h);return e.getHtml(true)}}}});
KISSY.Editor.add("image",function(x){var r=KISSY.Editor,A=KISSY,s=A.UA,w=A.Node,B=A.Event,p=r.BubbleView,t=r.SimpleOverlay;r.ImageInserter||function(){function i(h){i.superclass.constructor.call(this,h);this._init()}var d=function(h){return h._4e_name()==="img"&&!/(^|\s+)ke_/.test(h[0].className)&&h},l=r.TripleButton,n="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></p><p style='margin:5px 0'><label><span style='color:#0066CC;font-weight:bold;'>\u9ad8\u5ea6\uff1a </span><input class='ke-img-height' style='width:90px' value='\u81ea\u52a8'/> px </label> &nbsp;<label><span style='color:#0066CC;font-weight:bold;'>\u5bbd\u5ea6\uff1a </span><input class='ke-img-width' style='width:90px' value='\u81ea\u52a8'/> px </label></p><p><label><span style='color:#0066CC;font-weight:bold;'>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
r.Utils.duplicateStr("&nbsp;",13)+"<label><span style='color:#0066CC;font-weight:bold;'>\u95f4\u8ddd\uff1a </span> <input class='ke-img-margin' style='width:80px' value='5'/> px</label></p></div>";i.ATTRS={editor:{}};var q={"\u56fe\u7247\u5c5e\u6027":function(h){var k=h.getSelection();k=k&&k.getStartElement();k=d(k);h=h._toolbars.image;k&&h.show(null,k)}};A.extend(i,A.Base,{_init:function(){var h=this.get("editor"),k=h.toolBarDiv,u={};this.editor=h;this.el=new l({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",
container:k});this.el.on("offClick",this.show,this);B.on(h.document,"dblclick",this._dblclick,this);r.Utils.lazyRun(this,"_prepare","_real");h._toolbars=h._toolbars||{};h._toolbars.image=this;if(q)for(var b in q)(function(c){u[c]=function(){q[c](h)}})(b);r.ContextMenu.register(h.document,{rules:[d],width:"120px",funcs:u});p.attach({pluginName:"image",pluginInstance:this})},_dblclick:function(h){var k=new w(h.target);if(d(k)){this.show(null,k);h.halt()}},_prepare:function(){var h=this;h.get("editor");
h.d=new t({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var k=h.d;k.body.html(n);k.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");h.content=k.el;k=h.content;var u=k.one(".ke-img-cancel"),b=k.one(".ke-img-insert");h.imgUrl=k.one(".ke-img-url");h.imgHeight=k.one(".ke-img-height");h.imgWidth=k.one(".ke-img-width");h.imgAlign=k.one(".ke-img-align");h.imgMargin=k.one(".ke-img-margin");u.on("click",function(c){h.d.hide();
c.halt()});b.on("click",function(){h._insert()})},_updateTip:function(h,k){h.html(k.attr("src"));h.attr("href",k.attr("src"))},_real:function(){this.d.show()},_insert:function(){var h=this.imgUrl.val();if(h){var k=parseInt(this.imgHeight.val()),u=this.get("editor"),b=parseInt(this.imgWidth.val()),c=this.imgAlign.val(),g=parseInt(this.imgMargin.val()),f="";if(k)f+="height:"+k+"px;";if(b)f+="width:"+b+"px;";if(c)f+="float:"+c+";";isNaN(g)||(f+="margin:"+g+"px;");if(f)f=" style='"+f+"' ";h=new w("<img "+
f+"src='"+h+"' alt='' />",null,u.document);h=u.insertElement(h,k||b?null:function(m){m.on("load",function(){m.detach();m.css({width:m.width()+"px",height:m.height()+"px"})})});this._selectedEl&&u.getSelection().selectElement(h);this.d.hide();u.notifySelectionChange()}},_updateD:function(h){if(this._selectedEl=h){this.imgUrl.val(h.attr("src"));this.imgHeight.val(h.height());this.imgWidth.val(h.width());this.imgAlign.val(h._4e_style("float"));this.imgMargin.val(parseInt(h._4e_style("margin"))||0)}else{this.imgUrl.val("http://");
this.imgHeight.val("\u81ea\u52a8");this.imgWidth.val("\u81ea\u52a8");this.imgAlign.val();this.imgMargin.val("5")}},show:function(h,k){this._prepare();this._updateD(k)}});r.ImageInserter=i;(function(h,k,u){p.register({pluginName:h,func:u,init:function(){var b=this,c=b.el;c.html(k+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var g=c.one(".ke-bubbleview-url"),f=c.one(".ke-bubbleview-change");c=c.one(".ke-bubbleview-remove");f._4e_unselectable();g._4e_unselectable();c._4e_unselectable();f.on("click",function(m){b._plugin.show(null,b._selectedEl);m.halt()});c.on("click",function(m){var j=b._plugin;if(s.webkit){var a=j.editor.getSelection().getRanges();a&&a[0]&&(a[0].collapse(true)||1)&&a[0].select()}b._selectedEl._4e_remove();b.hide();j.editor.notifySelectionChange();m.halt()});b.on("afterVisibleChange",function(m){var j=
b._selectedEl;m.newVal&&j&&b._plugin._updateTip(g,j)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",d)}();x.addPlugin(function(){new r.ImageInserter({editor:x})})});
KISSY.Editor.add("indent",function(x){var r=KISSY.Editor,A={ol:1,ul:1},s=KISSY,w=r.Walker,B=s.DOM,p=s.Node,t=s.UA,i=r.NODE;r.Indent||function(){function d(g){this.type=g;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function l(g){return g.type=CKEDITOR.NODE_ELEMENT&&g.is("li")}function n(g,f,m){var j=f.startContainer;for(g=f.endContainer;j&&j.parent()[0]!==m[0];)j=j.parent();for(;g&&g.parent()[0]!==m[0];)g=g.parent();if(j&&g){var a=j;j=[];for(var e=false;!e;){if(a[0]===
g[0])e=true;j.push(a);a=a.next()}if(!(j.length<1)){a=m._4e_parents(true);for(g=0;g<a.length;g++)if(A[a[g]._4e_name()]){m=a[g];break}a=this.type=="indent"?1:-1;g=j[0];e=j[j.length-1];j={};var o=r.ListUtils.listToArray(m,j),v=o[e._4e_getData("listarray_index")].indent;for(g=g._4e_getData("listarray_index");g<=e._4e_getData("listarray_index");g++){o[g].indent+=a;var y=o[g].parent;o[g].parent=new p(y[0].ownerDocument.createElement(y._4e_name()))}for(g=e._4e_getData("listarray_index")+1;g<o.length&&o[g].indent>
v;g++)o[g].indent+=a;e=r.ListUtils.arrayToList(o,j,null,"p",0);a=[];if(this.type=="outdent"){var C;if((C=m.parent())&&C._4e_name()=="li"){o=e.listNode.childNodes;var H;for(g=o.length-1;g>=0;g--)if((H=new p(o[g]))&&H._4e_name()=="li")a.push(H)}}if(e){B.insertBefore(e.listNode,m[0]);m._4e_remove()}if(a&&a.length)for(g=0;g<a.length;g++){for(H=m=a[g];(H=H.next())&&H._4e_name()in A;){t.ie&&!m._4e_first(function(N){return u(N)&&b(N)})&&m[0].appendChild(f.document.createTextNode("\u00a0"));m[0].appendChild(H[0])}B.insertAfter(m[0],
C[0])}for(g in j)j[g]._4e_clearMarkers(j,true)}}}function q(g,f){f=f.createIterator();f.enforceRealBlocks=true;f.enlargeBr=true;for(var m;m=f.getNextParagraph();)h.call(this,g,m)}function h(g,f){g=parseInt(f._4e_style(this.indentCssProperty),10);if(isNaN(g))g=0;g+=(this.type=="indent"?1:-1)*this.indentOffset;if(g<0)return false;g=Math.max(g,0);g=Math.ceil(g/this.indentOffset)*this.indentOffset;f.css(this.indentCssProperty,g?g+this.indentUnit:"");f[0].style.cssText===""&&f[0].removeAttribute("style");
return true}function k(g){k.superclass.constructor.call(this,g);g=this.get("editor").toolBarDiv;this.el=new c({container:g,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new d(this.get("type"));this._init()}var u=w.whitespaces(true),b=w.bookmark(false,true);s.augment(d,{exec:function(g){for(var f=g.getSelection(),m=f&&f.getRanges()[0],j=m.startContainer,a=m.endContainer,e=m.getCommonAncestor();e&&!(e[0].nodeType==i.NODE_ELEMENT&&A[e._4e_name()]);)e=e.parent();if(e&&
j[0].nodeType==i.NODE_ELEMENT&&j._4e_name()in A){j=new w(m);j.evaluator=l;m.startContainer=j.next()}if(e&&a[0].nodeType==i.NODE_ELEMENT&&a._4e_name()in A){j=new w(m);j.evaluator=l;m.endContainer=j.previous()}a=f.createBookmarks(true);if(e){for(j=e._4e_first();j&&j[0]&&j._4e_name()!="li";)j=j.next();var o=m.startContainer;(j[0]==o[0]||j._4e_contains(o))&&h.call(this,g,e)||n.call(this,g,m,e)}else q.call(this,g,m);f.selectBookmarks(a)}});var c=r.TripleButton;k.ATTRS={type:{},contentCls:{},editor:{}};
s.extend(k,s.Base,{_init:function(){var g=this.get("editor"),f=this.el;f.on("offClick",this.exec,this);this.get("type")=="outdent"?g.on("selectionChange",this._selectionChange,this):f.set("state",c.OFF)},exec:function(){var g=this.get("editor"),f=this;g.fire("save");setTimeout(function(){f.indentCommand.exec(g);g.fire("save");g.notifySelectionChange()},10)},_selectionChange:function(g){this.get("editor");this.get("type");var f=g.path,m=f.blockLimit;g=this.el;if(f.contains(A))g.set("state",c.OFF);
else(f=f.block||m)&&f._4e_style(this.indentCommand.indentCssProperty)?g.set("state",c.OFF):g.set("state",c.DISABLED)}});r.Indent=k}();x.addPlugin(function(){x.addCommand("outdent",new r.Indent({editor:x,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));x.addCommand("indent",new r.Indent({editor:x,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(x){var r=KISSY.Editor,A=KISSY,s=r.TripleButton;r.Justify||function(){function w(p,t,i,d){this.editor=p;this.v=t;this.contentCls=d;this.title=i;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;A.augment(w,{_init:function(){var p=this.editor;this.el=new s({contentCls:this.contentCls,title:this.title,container:p.toolBarDiv});p.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var p=this.editor,t=p.getSelection(),
i=this.el.get("state");if(t){var d=t.createBookmarks(),l=t.getRanges(),n,q;p.fire("save");for(var h=l.length-1;h>=0;h--){n=l[h].createIterator();for(n.enlargeBr=true;q=n.getNextParagraph();){q.removeAttr("align");i==s.OFF?q.css("text-align",this.v):q.css("text-align","")}}p.notifySelectionChange();t.selectBookmarks(d);p.fire("save")}},_selectionChange:function(p){var t=this.el;p=p.path;if(p=p.block||p.blockLimit){p=p.css("text-align").replace(B,"");p==this.v||!p&&this.v=="left"?t.set("state",s.ON):
t.set("state",s.OFF)}}});r.Justify=w}();x.addPlugin(function(){new r.Justify(x,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new r.Justify(x,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new r.Justify(x,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(x){var r=KISSY.Editor;r.Link||function(){function A(q){this.editor=q;this._init()}function s(q){return q._4e_ascendant(function(h){return h._4e_name()==="a"&&!!h.attr("href")},true)}var w=KISSY,B=r.TripleButton,p=r.Style,t=w.Node,i=r.Range,d=r.SimpleOverlay,l=r.BubbleView,n={element:"a",attributes:{href:"#(href)",target:"#(target)"}};A.init=function(){var q=new d({title:"\u94fe\u63a5\u5c5e\u6027",mask:true,width:"300px"});this.dialog=q;q.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input class='ke-link-url' style='width:220px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
q.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");q.urlEl=q.body.one(".ke-link-url");q.targetEl=q.body.one(".ke-link-blank");var h=q.foot.one(".ke-link-cancel");q.foot.one(".ke-link-ok").on("click",function(k){q.link._link();k.halt()},this);h.on("click",function(k){q.hide();k.halt()},this);A.init=null};l.register({pluginName:"link",func:s,init:function(){var q=this,h=q.el;h.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var k=h.one(".ke-bubbleview-url"),u=h.one(".ke-bubbleview-change");h=h.one(".ke-bubbleview-remove");u._4e_unselectable();k._4e_unselectable();h._4e_unselectable();u.on("click",function(b){q._plugin.show();b.halt()});h.on("click",function(b){var c=q._plugin;c._removeLink(q._selectedEl);c.editor.notifySelectionChange();b.halt()});q.on("afterVisibleChange",function(){var b=q._selectedEl;if(b){k.html(b.attr("href"));k.attr("href",b.attr("href"))}})}});w.augment(A,{_init:function(){this.el=new B({container:this.editor.toolBarDiv,
contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5 "});this.el.on("click",this.show,this);l.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(q){var h=this.editor,k={href:q.attr("href")};if(q._4e_hasAttribute("target"))k.target=q.attr("target");q=new p(n,k);h.fire("save");q.remove(h.document);h.fire("save")},_getSelectedLink:function(){var q=this.editor.getSelection();if(q=q&&q.getStartElement())q=s(q);return q},_link:function(){var q,h=this.editor,k=A.dialog,u=k.urlEl.val(),
b;if(w.trim(u)){k.hide();if(b=this._getSelectedLink()){q=new i(h.document);q.selectNodeContents(b);h.getSelection().selectRanges([q]);this._removeLink(b)}b={href:u};b.target=k.targetEl[0].checked?"_blank":"_self";q=h.getSelection().getRanges()[0];if(q.collapsed){q=new t("<a href='"+u+"' target='"+b.target+"'>"+u+"</a>",null,h.document);h.insertElement(q)}else{h.fire("save");q=new p(n,b);q.apply(h.document);h.fire("save")}h.notifySelectionChange()}},_prepare:function(){A.init&&A.init()},_real:function(){var q=
A.dialog,h=this._getSelectedLink();q.link=this;if(h){q.urlEl.val(h.attr("href"));q.targetEl[0].checked=h.attr("target")=="_blank"}q.show()},show:function(){this._prepare()}});r.Utils.lazyRun(A.prototype,"_prepare","_real");r.Link=A}();x.addPlugin(function(){new r.Link(x)})});
KISSY.Editor.add("list",function(x){var r=KISSY.Editor,A={ol:1,ul:1},s=["ol","ul"],w=KISSY,B=r.RANGE,p=r.ElementPath,t=r.Walker,i=r.NODE,d=w.UA,l=w.Node,n=w.DOM;r.List||function(){function q(c){this.type=c}function h(c){h.superclass.constructor.call(this,c);c=this.get("editor").toolBarDiv;this.el=new b({contentCls:this.get("contentCls"),title:this.get("title"),container:c});this.listCommand=new q(this.get("type"));this.listCommand.state=this.get("status");this._init()}var k={listToArray:function(c,
g,f,m,j){if(!A[c._4e_name()])return[];m||(m=0);f||(f=[]);for(var a=0,e=c[0].childNodes.length;a<e;a++){var o=new l(c[0].childNodes[a]);if(o._4e_name()=="li"){var v={parent:c,indent:m,element:o,contents:[]};if(j)v.grandparent=j;else{v.grandparent=c.parent();if(v.grandparent&&v.grandparent._4e_name()=="li")v.grandparent=v.grandparent.parent()}g&&o._4e_setMarker(g,"listarray_index",f.length);f.push(v);for(var y=0,C=o[0].childNodes.length,H;y<C;y++){H=new l(o[0].childNodes[y]);H[0].nodeType==i.NODE_ELEMENT&&
A[H._4e_name()]?k.listToArray(H,g,f,m+1,v.grandparent):v.contents.push(H)}}}return f},arrayToList:function(c,g,f,m){f||(f=0);if(!c||c.length<f+1)return null;for(var j=c[f].parent[0].ownerDocument,a=j.createDocumentFragment(),e=null,o=f,v=Math.max(c[f].indent,0),y=null;;){var C=c[o];if(C.indent==v){if(!e||c[o].parent._4e_name()!=e._4e_name()){e=c[o].parent._4e_clone(false,true);a.appendChild(e[0])}y=e[0].appendChild(C.element._4e_clone(false,true)[0]);for(var H=0;H<C.contents.length;H++)y.appendChild(C.contents[H]._4e_clone(true,
true)[0]);o++}else if(C.indent==Math.max(v,0)+1){o=k.arrayToList(c,null,o,m);y.appendChild(o.listNode);o=o.nextIndex}else if(C.indent==-1&&!f&&C.grandparent){y=A[C.grandparent._4e_name()]?C.element._4e_clone(false,true)[0]:C.grandparent._4e_name()!="td"?j.createElement(m):j.createDocumentFragment();for(H=0;H<C.contents.length;H++)y.appendChild(C.contents[H]._4e_clone(true,true)[0]);if(y.nodeType==i.NODE_DOCUMENT_FRAGMENT&&o!=c.length-1){y.lastChild&&y.lastChild.nodeType==i.NODE_ELEMENT&&y.lastChild.getAttribute("type")==
"_moz"&&n._4e_remove(y.lastChild);n._4e_appendBogus(y)}if(y.nodeType==i.NODE_ELEMENT&&n._4e_name(y)==m&&y.firstChild){n._4e_trim(y);e=y.firstChild;if(e.nodeType==i.NODE_ELEMENT&&n._4e_isBlockBoundary(e)){e=j.createDocumentFragment();n._4e_moveChildren(y,e);y=e}}e=n._4e_name(y);if(!d.ie&&(e=="div"||e=="p"))n._4e_appendBogus(y);a.appendChild(y);e=null;o++}else return null;if(c.length<=o||Math.max(c[o].indent,0)<v)break}if(g)for(c=new l(a.firstChild);c&&c[0];){c[0].nodeType==i.NODE_ELEMENT&&c._4e_clearMarkers(g,
true);c=c._4e_nextSourceNode()}return{listNode:a,nextIndex:o}}},u=/^h[1-6]$/;q.prototype={changeListType:function(c,g,f,m){var j=k.listToArray(g.root,f),a=[];for(c=0;c<g.contents.length;c++){var e=g.contents[c];e=e._4e_ascendant("li",true);if(!(!e||!e[0]||e._4e_getData("list_item_processed"))){a.push(e);e._4e_setMarker(f,"list_item_processed",true)}}e=new l(g.root[0].ownerDocument.createElement(this.type));for(c=0;c<a.length;c++){var o=a[c]._4e_getData("listarray_index");j[o].parent=e}f=k.arrayToList(j,
f,null,"p");var v;j=f.listNode.childNodes.length;for(c=0;c<j&&(v=new l(f.listNode.childNodes[c]));c++)v._4e_name()==this.type&&m.push(v);n.insertBefore(f.listNode,g.root[0]);g.root._4e_remove()},createList:function(c,g,f){var m=g.contents;c=g.root[0].ownerDocument;var j=[];if(m.length==1&&m[0][0]===g.root[0]){var a=new l(c.createElement("div"));m[0][0].nodeType!=i.NODE_TEXT&&m[0]._4e_moveChildren(a);m[0][0].appendChild(a[0]);m[0]=a}g=g.contents[0].parent();for(a=0;a<m.length;a++)g=g._4e_commonAncestor(m[a].parent());
for(a=0;a<m.length;a++)for(var e=m[a],o;o=e.parent();){if(o[0]===g[0]){j.push(e);break}e=o}if(!(j.length<1)){m=new l(j[j.length-1][0].nextSibling);a=new l(c.createElement(this.type));for(f.push(a);j.length;){f=j.shift();e=new l(c.createElement("li"));if(u.test(f._4e_name()))e[0].appendChild(f[0]);else{f._4e_copyAttributes(e);f._4e_moveChildren(e);f._4e_remove()}a[0].appendChild(e[0]);d.ie||e._4e_appendBogus()}m[0]?n.insertBefore(a[0],m[0]):g[0].appendChild(a[0])}},removeList:function(c,g,f){function m(H){if((y=
new l(v[H?"firstChild":"lastChild"]))&&!(y[0].nodeType==i.NODE_ELEMENT&&y._4e_isBlockBoundary())&&(C=g.root[H?"_4e_previous":"_4e_next"](t.whitespaces(true)))&&!(y[0].nodeType==i.NODE_ELEMENT&&C._4e_isBlockBoundary({br:1})))n[H?"insertBefore":"insertAfter"](c.document.createElement("br"),y[0])}for(var j=k.listToArray(g.root,f),a=[],e=0;e<g.contents.length;e++){var o=g.contents[e];o=o._4e_ascendant("li",true);if(!(!o||o._4e_getData("list_item_processed"))){a.push(o);o._4e_setMarker(f,"list_item_processed",
true)}}o=null;for(e=0;e<a.length;e++){o=a[e]._4e_getData("listarray_index");j[o].indent=-1;o=o}for(e=o+1;e<j.length;e++)if(j[e].indent>Math.max(j[e-1].indent,0)){a=j[e-1].indent+1-j[e].indent;for(o=j[e].indent;j[e]&&j[e].indent>=o;){j[e].indent+=a;e++}e--}var v=k.arrayToList(j,f,null,"p").listNode,y,C;m(true);m();n.insertBefore(v,g.root);g.root._4e_remove()},exec:function(c){var g=c.getSelection(),f=g&&g.getRanges();if(!(!f||f.length<1)){for(var m=g.createBookmarks(true),j=[],a={};f.length>0;){var e=
f.shift(),o=e.getBoundaryNodes(),v=o.startNode,y=o.endNode;v[0].nodeType==i.NODE_ELEMENT&&v._4e_name()=="td"&&e.setStartAt(o.startNode,B.POSITION_AFTER_START);y[0].nodeType==i.NODE_ELEMENT&&y._4e_name()=="td"&&e.setEndAt(o.endNode,B.POSITION_BEFORE_END);e=e.createIterator();for(e.forceBrBreak=false;o=e.getNextParagraph();){v=new p(o);y=v.elements;var C=null,H=false,N=v.blockLimit,z;for(v=y.length-1;v>=0&&(z=y[v]);v--)if(A[z._4e_name()]&&N.contains(z)){N._4e_removeData("list_group_object");if(v=z._4e_getData("list_group_object"))v.contents.push(o);
else{v={root:z,contents:[o]};j.push(v);z._4e_setMarker(a,"list_group_object",v)}H=true;break}if(!H)if(N._4e_getData("list_group_object"))N._4e_getData("list_group_object").contents.push(o);else{v={root:N,contents:[o]};N._4e_setMarker(a,"list_group_object",v);j.push(v)}}}for(f=[];j.length>0;){v=j.shift();if(this.state=="off")A[v.root._4e_name()]?this.changeListType(c,v,a,f):this.createList(c,v,f);else this.state=="on"&&A[v.root._4e_name()]&&this.removeList(c,v,a)}for(v=0;v<f.length;v++){C=f[v];var D=
this;(c=function(I){var L=C[I?"_4e_previous":"_4e_next"](t.whitespaces(true));if(L&&L[0]&&L._4e_name()==D.type){L._4e_remove();L._4e_moveChildren(C,I?true:false)}})();c(true)}r.Utils.clearAllMarkers(a);g.selectBookmarks(m)}}};var b=r.TripleButton;h.ATTRS={editor:{},type:{},contentCls:{}};w.extend(h,w.Base,{_init:function(){var c=this,g=c.get("editor"),f=c.el;c=c;f.on("click",c._change,c);g.on("selectionChange",c._selectionChange,c)},_change:function(){var c=this.get("editor");this.get("type");var g=
this.el;c.fire("save");this.listCommand.state=g.get("state");this.listCommand.exec(c);c.fire("save");c.notifySelectionChange()},_selectionChange:function(c){this.get("editor");var g=this.get("type"),f=c.path,m;c=this.el;var j=f.blockLimit;if(f=f.elements)for(var a=0;a<f.length&&(m=f[a])&&m[0]!==j[0];a++){var e=w.indexOf(f[a]._4e_name(),s);if(e!==-1)if(s[e]===g){c.set("state",b.ON);return}else break}c.set("state",b.OFF)}});r.ListUtils=k;r.List=h}();x.addPlugin(function(){new r.List({editor:x,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new r.List({editor:x,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(x){var r=KISSY.Editor,A=KISSY,s=A.UA,w=A.Node,B=A.Event,p=r.TripleButton,t=A.DOM,i;r.Maximize||function(){function d(l){this.editor=l;this._init()}d.init=function(){i=new w("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(i[0]);d.init=null};A.augment(d,{_init:function(){this.el=new p({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);r.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var l=this,n=l.editor;B.remove(window,"resize",l._maximize,l);this._saveEditorStatus();n.wrap.css({height:l.iframeHeight});(new w(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";n.editorWrap.css({position:"static",width:l.editorWrapWidth});i.css({left:"-99999px",top:"-99999px"});window.scrollTo(l.scrollLeft,
l.scrollTop);l.el.set("state",p.OFF);setTimeout(function(){l._restoreEditorStatus()},30);n.notifySelectionChange()},_saveSate:function(){var l=this.editor;this.iframeHeight=l.wrap._4e_style("height");this.editorWrapWidth=l.editorWrap._4e_style("width");this.scrollLeft=t.scrollLeft();this.scrollTop=t.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var l=this.editor;if(s.gecko&&l.iframeFocus)this.savedRanges=(l=l.getSelection())&&l.getRanges()},_restoreEditorStatus:function(){var l=this.editor,
n=l.getSelection();if(s.gecko&&l.iframeFocus){this.el.el[0].focus();l.focus();this.savedRanges&&n&&n.selectRanges(this.savedRanges)}if(l.iframeFocus&&n)(l=n.getStartElement())&&l[0]&&l._4e_scrollIntoView()},_maximize:function(){var l=this.editor,n=t.viewportHeight(),q=t.viewportWidth(),h=l.statusDiv?l.statusDiv.height():0,k=l.toolBarDiv.height();if(s.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new w(document.body)).css({width:0,height:0,overflow:"hidden"});
l.editorWrap.css({position:"absolute",zIndex:990,width:q+"px"});i.css({zIndex:985,height:n+"px",width:q+"px"});l.editorWrap.offset({left:0,top:0});i.css({left:0,top:0});l.wrap.css({height:n-h-k-14+"px"});l.notifySelectionChange()},_real:function(){var l=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",l._maximize,l);this.el.set("state",p.ON);setTimeout(function(){l._restoreEditorStatus()},30)},_prepare:function(){d.init&&d.init()},maximize:function(){this._prepare()}});
r.Maximize=d}();x.addPlugin(function(){new r.Maximize(x)})});
KISSY.Editor.add("music",function(x){function r(d){return d.indexOf(p)!=-1}var A=KISSY.Editor,s=KISSY,w=A.Flash,B="ke_music",p="niftyplayer.swf",t=x.htmlDataProcessor,i=t&&t.dataFilter;i&&i.addRules({elements:{object:function(d){var l=d.attributes;if(!(l.classid&&String(l.classid).toLowerCase())){for(l=0;l<d.children.length;l++)if(d.children[l].name=="embed"){if(!w.isFlashEmbed(d.children[l]))return null;if(r(d.children[l].attributes.src))return t.createFakeParserElement(d,B,"music",true)}return null}for(l=
0;l<d.children.length;l++){var n=d.children[l];if(n.name=="param"&&n.attributes.name=="movie")if(r(n.attributes.value))return t.createFakeParserElement(d,B,"music",true)}},embed:function(d){if(!w.isFlashEmbed(d))return null;if(r(d.attributes.src))return t.createFakeParserElement(d,B,"music",true)}}},4);A.MusicInserter||function(){function d(){d.superclass.constructor.apply(this,arguments)}function l(c){return c._4e_name()==="img"&&!!c.hasClass(B)&&c}function n(c){return c.replace(/^.+niftyplayer\.swf\?file=/,
"")}var q=A.Config.base+"plugins/music/niftyplayer.swf?file=#(music)",h="<p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3'/></label></p><p style='margin:5px 0'><label>\u5bf9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u9f50\uff1a <select class='ke-music-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
A.Utils.duplicateStr("&nbsp;",1)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-music-margin' style='width:90px' value='5'/> px</label><p>",k=/#\(music\)/g,u=["img."+B];s.extend(d,w,{_config:function(){this._cls=B;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml=h;this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=
b;this._flashRules=u},_initD:function(){var c=this,g=c.d;c.dUrl=g.el.one(".ke-music-url");c.dAlign=g.el.one(".ke-music-align");c.dMargin=g.el.one(".ke-music-margin");var f=g.el.one(".ke-music-ok");g=g.el.one(".ke-music-cancel");f.on("click",c._gen,c);g.on("click",function(){c.d.hide()})},_getDInfo:function(){return{url:q.replace(k,this.dUrl.val()),attrs:{width:165,height:37,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}},_getFlashUrl:function(c){return n(d.superclass._getFlashUrl.call(this,
c))},_updateD:function(){var c=this.editor,g=this.selectedFlash;if(g){c=c.restoreRealElement(g);this.dUrl.val(this._getFlashUrl(c));this.dAlign.val(g.attr("align"));this.dMargin.val(parseInt(c._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3");this.dAlign.val("");this.dMargin.val("5")}}});w.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",l);A.MusicInserter=d;var b={"\u97f3\u4e50\u5c5e\u6027":function(c){var g=c.getSelection();g=(g=g&&g.getStartElement())&&
l(g);c=c._toolbars.music;g&&c.show(null,g)}}}();x.addPlugin(function(){new A.MusicInserter(x)})});
KISSY.Editor.add("overlay",function(){function x(){x.superclass.constructor.apply(this,arguments);this._init()}var r=KISSY.Editor,A=KISSY,s=A.UA,w=r.focusManager,B=A.Node,p=A.Event,t=A.DOM,i,d,l,n={left:"-9999px",top:"-9999px"};if(!r.SimpleOverlay){x.init=function(){var q=document.body,h={width:"100%",height:t.docHeight()+"px",opacity:0.4};A.mix(h,n);i=(new B('<div class="ke-mask">&nbsp;</div>')).appendTo(q);i.css(h);if(s.ie&&s.ie==6){l=(new B("<iframe class='ke-dialog-iframe'></iframe>")).appendTo(q);
d=(new B("<iframe class='ke-mask'></iframe>")).appendTo(q);A.all([d[0],l[0]]).css(h)}x.init=null};x.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false},draggable:{value:true}};A.extend(x,A.Base,{_init:function(){var q=this;q._createEl();var h=q.el;q.on("afterVisibleChange",function(k){if(k=k.newVal){typeof k=="boolean"?q.center():h.offset(k);q.fire("show")}else{h.css(n);q.fire("hide")}});if(q.get("focusMgr")){q._initFocusNotice();q.on("afterVisibleChange",
q._editorFocusMg,q)}q.on("afterVisibleChange",function(k){k.newVal?q._register():q._unregister()});if(s.ie===6){q.on("show",function(){var k=h.width(),u=h.height();l.css({width:k+"px",height:u+"px"});l.css(h.offset())});q.on("hide",function(){l.css(n)})}if(q.get("mask")){q.on("show",function(){A.all([i[0],d&&d[0]]).css({left:"0px",top:"0px"})});q.on("hide",function(){A.all([i[0],d&&d[0]]).css(n)})}},_register:function(){p.on(document,"keydown",this._keydown,this);i&&i.on("click",this.hide,this)},
_keydown:function(q){if(q.keyCode==27){this.hide();q.halt()}},_unregister:function(){p.remove(document,"keydown",this._keydown,this);i&&i.detach("click",this.hide,this)},_createEl:function(){var q=this,h=q.get("el");if(!h){h=(new B("<div class='ke-dialog' style='width:@width@'><div class='ke-hd'><span class='ke-hd-title'>@title@</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>".replace(/@width@/,q.get("width")).replace(/@title@/,
q.get("title")))).appendTo(document.body);var k=h.one(".ke-hd"),u=A.guid("ke-overlay-head-");q.body=h.one(".ke-bd");q.foot=h.one(".ke-ft");q._close=h.one(".ke-close");q._title=k.one("h1");q._close.on("click",function(b){b.preventDefault();q.hide()});if(q.get("draggable")){k[0].id=u;k=new r.Drag({node:h,handlers:{id:k}});s.ie===6&&k.on("move",function(){l.offset(h.offset())})}}q.set("el",h);q.el=h;h.css(n)},center:function(){var q=this.el,h=q.width(),k=q.height(),u=t.viewportWidth(),b=t.viewportHeight();
h=(u-h)/2+t.scrollLeft();k=(b-k)/2+t.scrollTop();if(k-t.scrollTop()>200)k-=150;q.css({left:h+"px",top:k+"px"})},_prepareShow:function(){x.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;return this._focusEl=(new B("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.el)},_initFocusNotice:function(){var q=this,h=q._getFocusEl();h.on("focus",function(){q.fire("focus")});h.on("blur",function(){q.fire("blur")})},
_editorFocusMg:function(q){var h=this._focusEditor;if(q.newVal){h=this._focusEditor=w.currentInstance();s.webkit||this._getFocusEl()[0].focus();var k=this.el.one("input");if(k)setTimeout(function(){try{k[0].focus();k[0].select()}catch(u){}},0);else if(s.ie&&h)if(q=h.document.selection.createRange())if(q.item&&q.item(0).ownerDocument==h.document){h=document.body.createTextRange();h.moveToElementText(this.el._4e_first()[0]);h.collapse(true);h.select()}}else h&&h.focus()},_realShow:function(q){this.set("visible",
q||true)},show:function(q){this._prepareShow(q)},hide:function(){this.set("visible",false)}});r.Utils.lazyRun(x.prototype,"_prepareShow","_realShow");r.SimpleOverlay=x}});
KISSY.Editor.add("preview",function(x){var r=KISSY.Editor,A=KISSY,s=r.TripleButton;r.Preview||function(){function w(B){this.editor=B;this._init()}A.augment(w,{_init:function(){this.el=new s({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,p=640,t=420,i=80;try{var d=window.screen;p=Math.round(d.width*0.8);t=Math.round(d.height*0.7);i=Math.round(d.width*0.1)}catch(l){}B=
B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+B.getData()+"\n</body>");p=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+p+",height="+t+",left="+i);p.document.open();p.document.write(B);p.document.close();p.focus()}});r.Preview=w}();x.addPlugin(function(){new r.Preview(x)})});
KISSY.Editor.add("removeformat",function(x){function r(n){this.editor=n;this._init()}function A(n,q){for(var h=0;h<q.length;h++)n.removeAttr(q[h])}var s=KISSY.Editor,w=KISSY,B=s.RANGE,p=s.ElementPath,t=s.NODE,i=s.TripleButton,d="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",l="class,style,lang,width,height,align,hspace,valign".split(",");d=new RegExp("^(?:"+d.replace(/,/g,"|")+")$","i");w.augment(r,{_init:function(){this.el=new i({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var n=this.editor,q=d;q.lastIndex=0;var h=n.getSelection().getRanges();n.fire("save");for(var k=0,u;u=h[k];k++)if(!u.collapsed){u.enlarge(B.ENLARGE_ELEMENT);var b=u.createBookmark(),c=b.startNode,g=b.endNode,f=function(m){for(var j=new p(m),a=j.elements,e=1,o;o=a[e];e++){if(o._4e_equals(j.block)||o._4e_equals(j.blockLimit))break;q.test(o._4e_name())&&m._4e_breakParent(o)}};
f(c);f(g);for(c=c._4e_nextSourceNode(true,t.NODE_ELEMENT);c;){if(c._4e_equals(g))break;f=c._4e_nextSourceNode(false,t.NODE_ELEMENT);c._4e_name()=="img"&&c.attr("_cke_realelement")||(q.test(c._4e_name())?c._4e_remove(true):A(c,l));c=f}u.moveToBookmark(b)}n.getSelection().selectRanges(h);n.fire("save")}});x.addPlugin(function(){new r(x)})});
KISSY.Editor.add("resize",function(x){var r=KISSY,A=r.Editor,s=r.Node;A.Resizer||function(){function w(p){this.editor=p;this._init()}var B=A.Draggable;r.augment(w,{_init:function(){var p=this.editor,t=p.statusDiv,i=new s("<div class='ke-resizer'></div>");i.appendTo(t);t=new B({node:i});var d=0,l=0,n=p.wrap,q=p.editorWrap;t.on("start",function(){d=n.height();l=q.width()});t.on("move",function(h){var k=h.pageX-this.startMousePos.left;n.height(d+(h.pageY-this.startMousePos.top));q.width(l+k)})}});A.Resizer=
w}();x.addPlugin(function(){new A.Resizer(x)})});
KISSY.Editor.add("select",function(){function x(p){x.superclass.constructor.call(this,p);this._init()}var r=KISSY,A=r.Node,s=r.Event,w=r.DOM,B=r.Editor;if(!B.Select){x.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};r.extend(x,r.Base,{_init:function(){var p=this.get("container"),t=new A("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a></span>"),i=this.get("title"),d=t.one(".ke-select-text");
t.one(".ke-select-drop");d.html(i);d.css("width",this.get("width"));t._4e_unselectable();t.attr("title",i);t.appendTo(p);t.on("click",this._click,this);this.el=t;this.title=d;this._focusA=t.one("a.ke-select");B.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(p){p=p.newVal;for(var t=this.get("title"),i=this.get("items"),d=0;d<i.length;d++){var l=i[d];if(l.value==p){t=l.name;break}}this.title.html(t)},_prepare:function(){var p=this.el,
t=this._focusA,i=new A("<div class='ke-menu' onmousedown='return false;'></div>"),d=new B.SimpleOverlay({el:i,focusMgr:false}),l=this.get("items");this.get("title")&&(new A("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+this.get("title")+"</div>")).appendTo(i);for(var n=0;n<l.length;n++){var q=l[n];q=new A("<a class='ke-select-menu-item' href='#' data-value='"+q.value+"'>"+q.name+"</a>",q.attrs);q._4e_unselectable();q.appendTo(i)}this.get("popUpWidth")&&i.css("width",
this.get("popUpWidth"));i.appendTo(document.body);this.menu=d;d.on("show",function(){t.addClass("ke-select-active")});d.on("hide",function(){t.removeClass("ke-select-active")});s.on([document,this.get("doc")],"click",function(k){p._4e_contains(k.target)||d.hide()});i.on("click",this._select,this);var h=this.as=i.all("a");s.on(i[0],"mouseenter",function(){h.removeClass("ke-menu-selected")})},_select:function(p){p.halt();var t=this.menu,i=t.el;if(p=(new A(p.target))._4e_ascendant(function(n){return i._4e_contains(n)&&
n._4e_name()=="a"},true)){var d=this.get("value"),l=p.attr("data-value");this.set("value",l);this.fire("click",{newVal:l,preVal:d,name:p.html()});t.hide()}},_real:function(){var p=this.el.offset();p.top+=this.el.height();p.left+=1;if(p.left+this.menu.el.width()>w.viewportWidth()-60)p.left=w.viewportWidth()-this.menu.el.width()-60;this.menu.show(p)},_click:function(p){p.preventDefault();var t=this.get("value");if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();t&&this.menu&&
this.as.each(function(i){i.attr("data-value")==t?i.addClass("ke-menu-selected"):i.removeClass("ke-menu-selected")})}}});B.Select=x}});
KISSY.Editor.add("smiley",function(x){var r=KISSY.Editor,A=KISSY,s=A.DOM,w=A.Event,B=A.Node,p=r.SimpleOverlay,t=r.TripleButton;r.Smiley||function(){function i(n){this.editor=n;this._init()}for(var d="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",l=0;l<=98;l++)d+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+l+".gif'></a>";d+="</div></div>";A.augment(i,{_init:function(){this.el=new t({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);r.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(n){var q=this;s._4e_ascendant(n.target,function(h){return h[0]===q.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(n){n.halt();var q=this.editor;n=n.target;var h;if(s._4e_name(n)=="a"&&(h=s.attr(n,"data-icon"))){h=new B("<img alt='' src='"+h+"'/>",null,q.document);q.insertElement(h);this.smileyWin.hide()}},_prepare:function(){var n=this.editor;this.smileyPanel=new B(d);this.smileyWin=new p({el:this.smileyPanel,
focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);w.on(document,"click",this._hidePanel,this);w.on(n.document,"click",this._hidePanel,this)},_real:function(){var n=this.el.el.offset();n.top+=this.el.el.height()+5;if(n.left+this.smileyPanel.width()>s.viewportWidth()-60)n.left=s.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(n)},_show:function(n){this._prepare(n)}});r.Smiley=i}();x.addPlugin(function(){new r.Smiley(x)})});
KISSY.Editor.add("sourcearea",function(x){var r=KISSY.Editor,A=KISSY,s=A.UA,w=r.TripleButton;r.SourceArea||function(){function B(p){this.editor=p;this._init()}A.augment(B,{_init:function(){var p=this.editor;this.el=new w({container:p.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);p.textarea.on("mousedown",function(t){t.stopPropagation()})},_show:function(){var p=this.editor,t=
this.el;p.textarea.val(p.getData());p._showSource();t.set("state",w.ON)},_hide:function(){var p=this.editor,t=p.textarea,i=this.el;p._hideSource();p.setData(t.val());if(s.gecko&&p.iframeFocus){i.el[0].focus();p.focus()}i.set("state",w.OFF)}});r.SourceArea=B}();x.addPlugin(function(){new r.SourceArea(x)})});
KISSY.Editor.add("table",function(x,r){var A=KISSY.Editor,s=KISSY,w=s.Node,B=s.DOM,p=A.Walker,t=s.UA,i=A.NODE,d=A.TripleButton,l=A.SimpleOverlay,n=A.Utils.isNumber,q=A.ContextMenu,h=["tr","th","td","tbody","table"],k=s.trim,u;u=(t.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var b=x.htmlDataProcessor,c=b&&b.dataFilter;b=b&&b.htmlFilter;c&&c.addRules({elements:{table:function(g){g=g.attributes;var f=g["class"],m=parseInt(g.border,10);if(!m||m<=0)g["class"]=(f||"")+" ke_show_border"}}});b&&b.addRules({elements:{table:function(g){g=g.attributes;var f=g["class"];if(f)g["class"]=s.trim(f.replace("ke_show_border","").replace(/\s{2}/," "))}}});A.TableUI||function(){function g(z){this.editor=z;this.selectedTable=
null;z._toolbars=z._toolbars||{};z._toolbars.table=this;this._init()}function f(z){return k(z).length!=0}function m(z){function D(X){if(!(M.length>0))if(X[0].nodeType==i.NODE_ELEMENT&&H.test(X._4e_name())&&!X._4e_getData("selected_cell")){X._4e_setMarker(O,"selected_cell",true);M.push(X)}}for(var I=z.createBookmarks(),L=z.getRanges(),M=[],O={},S=0;S<L.length;S++){var R=L[S];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&M.push(R)}else{R=new p(R);
var Y;for(R.guard=D;Y=R.next();)if((Y=Y.parent())&&H.test(Y._4e_name())&&!Y._4e_getData("selected_cell")){Y._4e_setMarker(O,"selected_cell",true);M.push(Y)}}}A.Utils.clearAllMarkers(O);z.selectBookmarks(I);return M}function j(z){z=z.cells;for(var D=0;D<z.length;D++){z[D].innerHTML="";t.ie||(new w(z[D]))._4e_appendBogus()}}function a(z,D){if(z=z.getStartElement()._4e_ascendant("tr")){var I=z._4e_clone(true);I.insertBefore(z);j(D?I[0]:z[0])}}function e(z){if(z instanceof A.Selection){var D=m(z),I=D.length;
z=[];for(var L,M,O=0;O<I;O++){var S=D[O].parent(),R=S[0].rowIndex;!O&&(L=R-1);z[R]=S;O==I-1&&(M=R+1)}O=S._4e_ascendant("table");L=new w(M<O[0].rows.length&&O[0].rows[M]||L>0&&O[0].rows[L]||O[0].parentNode);for(O=z.length;O>=0;O--)z[O]&&e(z[O]);return L}else if(z instanceof w){O=z._4e_ascendant("table");O[0].rows.length==1?O._4e_remove():z._4e_remove()}return 0}function o(z,D){z=z.getStartElement();if(z=z._4e_ascendant("td",true)||z._4e_ascendant("th",true))for(var I=z._4e_ascendant("table"),L=z[0].cellIndex,
M=0;M<I[0].rows.length;M++){var O=I[0].rows[M];if(!(O.cells.length<L+1)){z=new w(O.cells[L].cloneNode(false));t.ie||z._4e_appendBogus();O=new w(O.cells[L]);D?z.insertBefore(O):z.insertAfter(O)}}}function v(z){var D=[],I=z[0]&&z[0]._4e_ascendant("table"),L,M,O,S;L=0;for(M=z.length;L<M;L++)D.push(z[L][0].cellIndex);D.sort();L=1;for(M=D.length;L<M;L++)if(D[L]-D[L-1]>1){O=D[L-1]+1;break}O||(O=D[0]>0?D[0]-1:D[D.length-1]+1);z=I[0].rows;L=0;for(M=z.length;L<M;L++)if(S=z[L].cells[O])break;return S?new w(S):
I._4e_previous()}function y(z){if(z instanceof A.Selection){var D=m(z),I=v(D);for(z=D.length-1;z>=0;z--)D[z]&&y(D[z]);return I}else if(z instanceof w){D=z._4e_ascendant("table");if(!D)return null;I=z[0].cellIndex;for(z=D[0].rows.length-1;z>=0;z--){var L=new w(D[0].rows[z]);if(!I&&L[0].cells.length==1)e(L);else L[0].cells[I]&&L[0].removeChild(L[0].cells[I])}}return null}function C(z,D){var I=new A.Range(z[0].ownerDocument);if(!I.moveToElementEditablePosition(z,D?true:r)){I.selectNodeContents(z);I.collapse(D?
false:true)}I.select(true)}s.augment(g,{_init:function(){var z=this.editor,D={};this.el=new d({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:z.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in N)(function(L){D[L]=function(){z.fire("save");N[L](z);z.fire("save")}})(I);q.register(z.document,{rules:h,width:"120px",funcs:D});A.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var z=this,D=new l({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});
D.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='6'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='6'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='6'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='6'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td></tr><tr><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='6'/></label> &nbsp;\u50cf\u7d20</select></td><td></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
D.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");var I=D.body;D.twidth=I.one(".ke-table-width");D.theight=I.one(".ke-table-height");D.tborder=I.one(".ke-table-border");D.tcaption=I.one(".ke-table-caption");D.talign=I.one(".ke-table-align");D.trows=I.one(".ke-table-rows");D.tcols=I.one(".ke-table-cols");D.thead=I.one(".ke-table-head");var L=D.foot.one(".ke-table-ok"),M=D.foot.one(".ke-table-cancel");D.twidthunit=I.one(".ke-table-width-unit");
z.tableDialog=D;L.on("click",z._tableOk,z);D.on("hide",function(){z.selectedTable=null});M.on("click",function(){D.hide()})},_tableOk:function(){for(var z=this.tableDialog,D=z.el.all("input"),I=0;I<D.length;I++){var L=new w(D[I]);if(L[0]!=z.tcaption[0])if(s.trim(L.val())&&!n(L.val())){z=L.parent("label").text().replace(/[:\uff1a]/g,"");alert(z+"\u8bf7\u8f93\u5165\u6570\u5b57");return}}this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var z=this.tableDialog,D=this.selectedTable,
I=D.one("caption");f(z.talign.val())?D.attr("align",k(z.talign.val())):D.removeAttr("align");f(z.tborder.val())?D.attr("border",k(z.tborder.val())):D.removeAttr("border");!f(z.tborder.val())||z.tborder.val()=="0"?D.addClass("ke_show_border"):D.removeClass("ke_show_border");f(z.twidth.val())?D.css("width",k(z.twidth.val())+z.twidthunit.val()):D.css("width","");f(z.theight.val())?D.css("height",k(z.theight.val())):D.css("height","");if(f(z.tcaption.val()))I&&I[0]?I.html(k(z.tcaption.val())):(new w("<caption><span>"+
k(z.tcaption.val())+"</span></caption>")).insertBefore(D[0].firstChild);else I&&I._4e_remove();z.hide()},_genTable:function(){var z=this.tableDialog,D="<table ",I,L=parseInt(z.tcols.val())||1,M=parseInt(z.trows.val())||1,O=t.ie?"":"<br/>",S=this.editor;if(f(z.talign.val()))D+="align='"+s.trim(z.talign.val())+"' ";if(f(z.tborder.val()))D+="border='"+s.trim(z.tborder.val())+"' ";if(f(z.twidth.val())||f(z.theight.val())){D+="style='";if(f(z.twidth.val()))D+="width:"+s.trim(z.twidth.val())+z.twidthunit.val()+
";";if(f(z.theight.val()))D+="height:"+s.trim(z.theight.val())+"px;";D+="' "}if(!f(z.tborder.val())||s.trim(z.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(f(z.tcaption.val()))D+="<caption><span>"+s.trim(z.tcaption.val())+"</span></caption>";if(z.thead.val()){D+="<thead>";D+="<tr>";for(I=0;I<L;I++)D+="<th>"+O+"</th>";D+="</tr>";D+="</thead>";M-=1}D+="<tbody>";for(var R=0;R<M;R++){D+="<tr>";for(I=0;I<L;I++)D+="<td>"+O+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new w(D,null,S.document);
S.insertElement(D);z.hide()},_fillTableDialog:function(){var z=this.tableDialog,D=this.selectedTable,I=D.one("caption");z.talign.val(D.attr("align")||"");z.tborder.val(D.attr("border")||"");var L=D._4e_style("width")||"";z.twidth.val(L.replace(/px|%/i,""));L.indexOf("%")!=-1?z.twidthunit.val("%"):z.twidthunit.val("px");z.theight.val((D._4e_style("height")||"").replace(/px|%/i,""));L="";if(I)L=I.text();z.tcaption.val(L);z.trows.val(D.one("tbody").children().length);z.tcols.val(D.one("tr").children().length);
z.thead.val(D._4e_first(function(M){return M._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var H=/^(?:td|th)$/,N={"\u8868\u683c\u5c5e\u6027":function(z){var D=z.getSelection();
if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",true)){z=z._toolbars.table;z.selectedTable=D;z._tableShow()}},"\u5220\u9664\u8868\u683c":function(z){var D=(z=z.getSelection())&&z.getStartElement();if(D=D&&D._4e_ascendant("table",true)){z.selectElement(D);var I=z.getRanges()[0];I.collapse();z.selectRanges([I]);z=D.parent();z[0].childNodes.length==1&&z._4e_name()!="body"&&z._4e_name()!="td"?z._4e_remove():D._4e_remove()}},"\u5220\u9664\u884c ":function(z){z=z.getSelection();C(e(z),r)},"\u5220\u9664\u5217 ":function(z){z=
z.getSelection();(z=y(z))&&C(z,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(z){z=z.getSelection();a(z,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(z){z=z.getSelection();a(z,r)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(z){z=z.getSelection();o(z,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(z){z=z.getSelection();o(z,r)}};A.TableUI=g}();x.addPlugin(function(){var g=x.document;new A.TableUI(x);var f=B.create("<style>",null,g);g.getElementsByTagName("head")[0].appendChild(f);
if(f.styleSheet)f.styleSheet.cssText=u;else f.appendChild(g.createTextNode(u))})});
KISSY.Editor.add("templates",function(x){var r=KISSY.Editor,A=KISSY,s=A.Node,w=r.TripleButton,B=r.SimpleOverlay;r.TplUI||function(){function p(t){this.editor=t;this._init()}A.augment(p,{_init:function(){(new w({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);r.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var t=this.editor,i=t.cfg.pluginConfig.templates||[],d="<div class='ke-tpl'>",l=0;l<i.length;l++)d+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
i[l].demo+"</a>";d+="</div>";this._initDialogOk=true;var n=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});n.body.html(d);n.body.all(".ke-tpl-list").on("click",function(q){q.halt();q=(new s(q.target))._4e_index();q!=-1&&t.insertHtml(i[q].html);n.hide()});this.ui=n},_real:function(){this.ui.show()},_show:function(){this._prepare()}});r.TplUI=p}();x.addPlugin(function(){new r.TplUI(x)})});
KISSY.Editor.add("undo",function(x){var r=KISSY,A=r.Editor,s=A.Utils.arrayCompare,w=r.UA,B=r.Event;A.UndoManager||function(){function p(h){var k=h._getRawData();h=k&&h.getSelection();this.contents=k;this.bookmarks=h&&h.createBookmarks2(true)}function t(h){this.history=[];this.index=-1;this.editor=h;this.bufferRunner=A.Utils.buffer(this.save,this,500);this._init()}function i(h,k,u,b){this.editor=h;this.title=u;this.text=k;this.contentCls=b;this._init()}r.augment(p,{equals:function(h){if(this.contents!=
h.contents)return false;var k=this.bookmarks;h=h.bookmarks;if(k||h){if(!k||!h||k.length!=h.length)return false;for(var u=0;u<k.length;u++){var b=k[u],c=h[u];if(b.startOffset!=c.startOffset||b.endOffset!=c.endOffset||!s(b.start,c.start)||!s(b.end,c.end))return false}}return true}});var d={16:1,17:1,18:1},l={37:1,38:1,39:1,40:1,33:1,34:1};r.augment(t,{_keyMonitor:function(){var h=this.editor;B.on(h.document,"keydown",function(k){var u=k.keyCode;if(!(u in l||u in d))if(u===90&&(k.ctrlKey||k.metaKey)){h.fire("restore",
{d:-1});k.halt()}else if(u===89&&(k.ctrlKey||k.metaKey)){h.fire("restore",{d:1});k.halt()}else h.fire("save",{buffer:1})})},_init:function(){var h=this,k=h.editor;k.on("save",function(u){u.buffer?h.bufferRunner():h.save()});k.on("restore",h.restore,h);h._keyMonitor()},save:function(){var h=this.history,k=this.index;h.length>k+1&&h.splice(k+1,h.length-k-1);var u=this.editor;k=h[h.length-1];var b=new p(u);if(!k||!k.equals(b)){h.length===30&&h.shift();h.push(b);this.index=k=h.length-1;u.fire("afterSave",
{history:h,index:k})}},restore:function(h){h=h.d;var k=this.history,u=this.editor,b=k[this.index+h];if(b){u._setRawData(b.contents);if(b.bookmarks)u.getSelection().selectBookmarks(b.bookmarks);else if(w.ie){b=u.document.body.createTextRange();b.collapse(true);b.select()}this.index+=h;u.fire("afterRestore",{history:k,index:this.index});u.notifySelectionChange()}}});var n=A.TripleButton,q={redo:1,undo:-1};r.augment(i,{_init:function(){var h=this,k=h.editor;h.el=new n({contentCls:h.contentCls,title:h.title,
container:k.toolBarDiv});var u=h.el;u.set("state",n.DISABLED);k.on("afterSave afterRestore",h._respond,h);u.on("offClick",function(){k.fire("restore",{d:q[h.text]})})},_respond:function(h){this.updateUI(h.history,h.index)},updateUI:function(h,k){var u=this.el,b=this.text;if(b=="undo")k>0?u.set("state",n.OFF):u.set("state",n.DISABLED);else if(b=="redo")k<h.length-1?u.set("state",n.OFF):u.set("state",n.DISABLED)}});A.UndoManager=t;A.RestoreUI=i}();x.addPlugin(function(){new A.UndoManager(x);new A.RestoreUI(x,
"undo","\u64a4\u9500","ke-toolbar-undo");new A.RestoreUI(x,"redo","\u91cd\u505a","ke-toolbar-redo")})});
