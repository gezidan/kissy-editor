/*
 Constructor for kissy editor and module dependency definition
 thanks to CKSource's intelligent work on CKEditor
 @author: yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.1
 @buildtime: 2010-12-03 15:06:45
*/
KISSY.add("editor",function(l,p){function v(q,g){function b(y){for(var t=v.Env.mods,r=0;r<y.length;r++){for(var m=y[r],A=n,E=0;E<r;E++)if(m==y[E]){A=s;break}E=t[m];if(A&&E){A=l.clone(E);m=m+"_"+r;A.name=m;y[r]=m;t[m]||(t[m]=A)}}}var d=this;if(!(d instanceof v))return new v(q,g);if(l.isString(q))q=l.one(q);q=w._4e_wrap(q);g=g||{};g.pluginConfig=g.pluginConfig||{};d.cfg=g;g.pluginConfig=g.pluginConfig;d.cfg=g;l.app(d,l.EventTarget);var i=["htmldataprocessor","enterkey","clipboard"],o=n;d.use=function(y,
t){y=y.split(",");b(y);if(!o)for(var r=0;r<i.length;r++){var m=i[r];l.inArray(m,y)||y.unshift(m)}l.use.call(d,y.join(","),function(){d.ready(function(){t&&t.call(d);if(!o){d.setData(q.val());if(g.focus)d.focus();else{var A=d.getSelection();A&&A.removeAllRanges()}d.fire("save");o=s}})},{order:s,global:v});return d};d.use=d.use;d.init(q);return d}function x(q){var g=l.Config.debug;q=g?g==="dev"?"../src/"+q:q:q.replace(/\.(js|css)/i,"-min.$1");q+=q.indexOf("?")!=-1?"&":"?";q+="t="+encodeURIComponent("2010-12-03 15:06:45");
return q}var w=l.DOM,s=true,n=false;l.app(v,l.EventTarget);v.Config.base=l.Config.base+"editor/";var j=["separator","sourcearea/support","tabs","flashbridge","flashutils","clipboard","colorsupport/dialog/colorpicker",{name:"colorsupport"},"color/dialog","color","elementpaths","enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},"draft",{name:"draft/support",requires:["localstorage"]},{name:"flash",requires:["fakeobjects"]},"flash/dialog",{name:"flash/support",
requires:["flashutils","contextmenu","bubbleview"]},{name:"font",requires:["select"]},"format","htmldataprocessor",{name:"image",requires:["contextmenu","bubbleview"]},{name:"image/dialog",requires:["tabs"]},"indent","indent/support","justify",{name:"link",requires:["bubbleview"]},"link/dialog","list/support","list","maximize","maximize/support",{name:"music/support",requires:["flash/support"]},{name:"music",requires:["fakeobjects"]},{name:"music/dialog",requires:["flash/dialog"]},"preview","removeformat",
"smiley",{name:"smiley/support"},{name:"sourcearea",requires:["sourcearea/support"]},{name:"table"},{name:"table/support",requires:["contextmenu"]},"table/dialog",{name:"templates"},"undo",{name:"resize"}],k,c,f,e,h={};k=0;for(c=j.length;k<c;k++){f=j[k];if(l.isString(f))f=j[k]={name:f+"",requires:null};e=f.requires||[];f.requires=e.concat(["button"])}j=[{name:"localstorage",requires:["flashutils","flashbridge"]},{name:"button"},"progressbar",{name:"contextmenu"},{name:"bubbleview"},{name:"select"}].concat(j);
k=0;for(c=j.length;k<c;k++){f=j[k];e=f.name;h[e]={attach:n,charset:"utf-8",requires:f.requires,csspath:f.useCss?x("plugins/"+e+"/plugin.css"):p,path:x("plugins/"+e+"/plugin.js")}}v.add(h);l.Editor=v;l.Editor=v});
KISSY.Editor.add("utils",function(l){var p=null,v=KISSY,x=v.Node,w=v.DOM,s=v.UA,n=v.Event,j;j=s.ie?document.documentMode||s.ie:void 0;var k={debugUrl:function(c){var f=v.Config.debug;c=f?f==="dev"?"../src/"+c:c:c.replace(/\.(js|css)/i,"-min.$1");c+=c.indexOf("?")!=-1?"&":"?";c+="t="+encodeURIComponent("2010-12-03 15:02:53");return c},lazyRun:function(c,f,e){var h=c[f],q=c[e];c[f]=function(){h.apply(this,arguments);c[f]=c[e];return q.apply(this,arguments)}},getXY:function(c,f,e,h){e=e.defaultView||
e.parentWindow;c-=w.scrollLeft(e);f-=w.scrollTop(e);if(h)if(e!=(h.defaultView||h.parentWindow)&&e.frameElement){h=w._4e_getOffset(e.frameElement,h);c+=h.left;f+=h.top}return{left:c,top:f}},tryThese:function(){for(var c,f=0,e=arguments.length;f<e;f++){var h=arguments[f];try{c=h();break}catch(q){}}return c},arrayCompare:function(c,f){if(!c&&!f)return true;if(!c||!f||c.length!=f.length)return false;for(var e=0;e<c.length;e++)if(c[e]!==f[e])return false;return true},getByAddress:function(c,f,e){c=c.documentElement;
for(var h=0;c&&h<f.length;h++){var q=f[h];if(e)for(var g=-1,b=0;b<c.childNodes.length;b++){var d=c.childNodes[b];if(!(e===true&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){g++;if(g==q){c=d;break}}}else c=c.childNodes[q]}return c?new x(c):p},clearAllMarkers:function(c){for(var f in c)c[f]._4e_clearMarkers(c,true)},htmlEncodeAttr:function(c){return c.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(c){return c.replace(/^\s+/,"")},rtrim:function(c){return c.replace(/\s+$/,
"")},trim:function(c){return this.ltrim(this.rtrim(c))},mix:function(){for(var c={},f=0;f<arguments.length;f++)c=v.mix(c,arguments[f]);return c},isCustomDomain:function(){if(!s.ie)return false;var c=document.domain,f=window.location.hostname;return c!=f&&c!="["+f+"]"},duplicateStr:function(c,f){return Array(f+1).join(c)},throttle:function(c,f,e){e=e||150;if(e===-1)return function(){c.apply(f,arguments)};var h=(new Date).getTime();return function(){var q=(new Date).getTime();if(q-h>e){h=q;c.apply(f,
arguments)}}},buffer:function(c,f,e){e=e||0;var h=p;return function(){h&&clearTimeout(h);var q=arguments;h=setTimeout(function(){return c.apply(f,q)},e)}},isNumber:function(c){return/^\d+(.\d+)?$/.test(v.trim(c))},verifyInputs:function(c){for(var f=0;f<c.length;f++){var e=w._4e_wrap(c[f]),h=v.trim(e.val()),q=e.attr("data-verify");e=e.attr("data-warning");if(q&&!RegExp(q).test(h)){alert(e);return false}}return true},sourceDisable:function(c,f){c.on("sourcemode",f.disable,f);c.on("wysiwygmode",f.enable,
f)},resetInput:function(c){var f=c.attr("placeholder");if(f&&!s.webkit){c.addClass("ke-input-tip");c.val(f)}else s.webkit&&c.val("")},valInput:function(c,f){c.removeClass("ke-input-tip");c.val(f)},placeholder:function(c,f){c.attr("placeholder",f);if(!s.webkit){c.on("blur",function(){if(!v.trim(c.val())){c.addClass("ke-input-tip");c.val(f)}});c.on("focus",function(){c.removeClass("ke-input-tip");v.trim(c.val())==f&&c.val("")})}},clean:function(c){c=c[0]||c;for(var f=v.makeArray(c.childNodes),e=0;e<
f.length;e++){var h=f[e];h.nodeType==l.NODE.NODE_TEXT&&!v.trim(h.nodeValue)&&c.removeChild(h)}},htmlEncode:function(c){return!c?c:String(c).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(c){return!c?c:String(c).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(c,f){return c.toLowerCase()==f.toLowerCase()},normParams:function(c){c=v.clone(c);for(var f in c)if(c.hasOwnProperty(f)){var e=
c[f];if(v.isFunction(e))c[f]=e()}return c},doFormUpload:function(c,f,e){function h(){var y={responseText:"",responseXML:p};y.argument=c?c.argument:p;try{var t;if((t=s.ie?g.contentWindow.document:g.contentDocument||window.frames[q].document)&&t.body)y.responseText=t.body.innerHTML;y.responseXML=t&&t.XMLDocument?t.XMLDocument:t}catch(r){v.log(r)}n.remove(g,"load",h);c.callback&&c.callback(y);setTimeout(function(){w._4e_remove(g)},100)}var q=v.guid("form-upload-"),g=document.createElement("iframe");
g.id=q;g.name=q;g.className="ke-hidden";var b="document.open();"+(k.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(s.ie)g.src=s.ie?"javascript:void(function(){"+encodeURIComponent(b)+"}())":"";v.log("doFormUpload : "+g.src);document.body.appendChild(g);if(s.ie)document.frames[q].name=q;b=w._4e_unwrap(c.form);var d={target:b.target,method:b.method,encoding:b.encoding,enctype:b.enctype,action:b.action};b.target=q;b.method="POST";b.enctype=b.encoding="multipart/form-data";
if(e)b.action=e;var i;if(f){i=[];f=l.Utils.normParams(f);for(var o in f)if(f.hasOwnProperty(o)){e=document.createElement("input");e.type="hidden";e.name=o;e.value=f[o];b.appendChild(e);i.push(e)}}n.on(g,"load",h);b.submit();b.target=d.target;b.method=d.method;b.enctype=d.enctype;b.encoding=d.encoding;b.action=d.action;if(i){f=0;for(o=i.length;f<o;f++)w._4e_remove(i[f])}return g},extern:function(c,f){for(var e in f)c[e]=f[e]},map:function(c,f){for(var e=0;e<c.length;e++)c[e]=f(c[e]);return c},ieEngine:j,
preventFocus:function(c){s.ie?c._4e_unselectable():c.attr("onmousedown","return false;")},isFlashEmbed:function(c){c=c.attributes;return c.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(c.src||"")}};l.Utils=k;l.Utils=k;k.extern(k,{debugUrl:k.debugUrl,lazyRun:k.lazyRun,getXY:k.getXY,tryThese:k.tryThese,arrayCompare:k.arrayCompare,getByAddress:k.getByAddress,clearAllMarkers:k.clearAllMarkers,htmlEncodeAttr:k.htmlEncodeAttr,ltrim:k.ltrim,rtrim:k.rtrim,trim:k.trim,mix:k.mix,isCustomDomain:k.isCustomDomain,
duplicateStr:k.duplicateStr,buffer:k.buffer,isNumber:k.isNumber,verifyInputs:k.verifyInputs,sourceDisable:k.sourceDisable,resetInput:k.resetInput,placeholder:k.placeholder,clean:k.clean,htmlEncode:k.htmlEncode,htmlDecode:k.htmlDecode,equalsIgnoreCase:k.equalsIgnoreCase,normParams:k.normParams,throttle:k.throttle,doFormUpload:k.doFormUpload,map:k.map})});
KISSY.Editor.add("dom",function(l){function p(b){return b.replace(/-(\w)/g,function(d,i){return i.toUpperCase()})}var v=KISSY,x=v.DOM,w=v.UA,s=v.Node,n=l.Utils,j={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};l.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};l.NODE=l.NODE;l.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};l.POSITION=l.POSITION;var k=l.NODE,c=l.POSITION,f={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},e={hr:1},h=function(b){return b[0]||b},q=function(b){if(b&&!b[0])return new s(b);return b},g={_4e_wrap:q,_4e_unwrap:h,_4e_equals:function(b,d){if(!b&&!d)return true;if(!b||!d)return false;b=h(b);d=h(d);
return b===d},_4e_isBlockBoundary:function(b,d){b=q(b);var i=v.mix(v.mix({},e),d||{});return f[b.css("display")]||i[b._4e_name()]},_4e_getWin:function(b){return b&&"scrollTo"in b&&b.document?b:b&&b.nodeType===9?b.defaultView||b.parentWindow:false},_4e_index:function(b){b=h(b);for(var d=b.parentNode.childNodes,i=0;i<d.length;i++)if(d[i]===b)return i;return-1},_4e_first:function(b,d){b=h(b);var i=b.firstChild;if((i=i&&new s(i))&&d&&!d(i))i=i._4e_next(d);return i},_4e_move:function(b,d,i){b=h(b);x._4e_remove(b);
d=h(d);i?d.insertBefore(b,d.firstChild):d.appendChild(b)},_4e_name:function(b){b=h(b);var d=b.nodeName.toLowerCase();if(w.ie)if((b=b.scopeName)&&b!="HTML")d=b.toLowerCase()+":"+d;return d},_4e_isIdentical:function(b,d){if(b._4e_name()!=d._4e_name())return false;var i=b[0].attributes,o=d[0].attributes,y=i.length,t=o.length;if(y!=t)return false;for(var r=0;r<y;r++){var m=i[r],A=m.name;if(m.specified&&b.attr(A)!=d.attr(A))return false}if(n.ieEngine<8)for(r=0;r<t;r++){m=o[r];A=m.name;if(m.specified&&
b.attr(A)!=d.attr(A))return false}return true},_4e_isEmptyInlineRemoveable:function(b){b=h(b).childNodes;for(var d=0,i=b.length;d<i;d++){var o=b[d],y=o.nodeType;if(!(y==k.NODE_ELEMENT&&o.getAttribute("_ke_bookmark")))if(y==k.NODE_ELEMENT&&!g._4e_isEmptyInlineRemoveable(o)||y==k.NODE_TEXT&&v.trim(o.nodeValue))return false}return true},_4e_moveChildren:function(b,d,i){b=h(b);d=d[0]||d;if(b!=d)if(i)for(;i=b.lastChild;)d.insertBefore(b.removeChild(i),d.firstChild);else for(;i=b.firstChild;)d.appendChild(b.removeChild(i))},
_4e_mergeSiblings:function(){function b(d,i,o){if(i[0]&&i[0].nodeType==k.NODE_ELEMENT){for(var y=[];i.attr("_ke_bookmark")||i._4e_isEmptyInlineRemoveable();){y.push(i);i=o?new s(i[0].nextSibling):new s(i[0].previousSibling);if(!i[0]||i[0].nodeType!=k.NODE_ELEMENT)return}if(d._4e_isIdentical(i)){for(var t=o?d[0].lastChild:d[0].firstChild;y.length;)y.shift()._4e_move(d,!o);i._4e_moveChildren(d,!o);i._4e_remove();t[0]&&t[0].nodeType==k.NODE_ELEMENT&&t._4e_mergeSiblings()}}}return function(d){if(d[0])if(j[d._4e_name()]||
d._4e_name()=="a"){b(d,new s(d[0].nextSibling),true);b(d,new s(d[0].previousSibling))}}}(),_4e_unselectable:w.gecko?function(b){b=h(b);b.style.MozUserSelect="none"}:w.webkit?function(b){b=h(b);b.style.KhtmlUserSelect="none"}:function(b){b=h(b);if(w.ie||w.opera){var d=0;b.unselectable="on";for(var i=b.getElementsByTagName("*");b=i[d++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable="on"}}},_4e_getOffset:function(b,d){b=h(b);var i,
o=0;i=0;var y=b.ownerDocument.defaultView||b.ownerDocument.parentWindow,t=b.ownerDocument,r=t.documentElement;d=d||t;if(b.getBoundingClientRect){if(b!==t.body&&r!==b){i=b.getBoundingClientRect();o=i.left+(d===t?x.scrollLeft(y):0);i=i.top+(d===t?x.scrollTop(y):0)}if(d)if(y!=(d.defaultView||d.parentWindow)&&y.frameElement){y=g._4e_getOffset(y.frameElement,d);o+=y.left;i+=y.top}}return{left:o,top:i}},_4e_getFrameDocument:function(b){return(b=h(b))&&b.contentWindow.document},_4e_splitText:function(b,
d){b=h(b);var i=b.ownerDocument;if(!(!b||b.nodeType!=k.NODE_TEXT)){if(w.ie&&d==b.nodeValue.length){var o=i.createTextNode("");x.insertAfter(o,b);return new s(o)}o=new s(b.splitText(d));if(i.documentMode){i=i.createTextNode("");x.insertAfter(i,o[0]);x._4e_remove(i)}return o}},_4e_parents:function(b,d){b=q(b);var i=[];do i[d?"push":"unshift"](b);while(b=b.parent());return i},_4e_clone:function(b,d,i){b=h(b);b=b.cloneNode(d);if(!i){var o=function(y){if(y.nodeType==k.NODE_ELEMENT){y.removeAttribute("id");
y=y.childNodes;for(var t=0;t<y.length;t++)o(y[t])}};o(b)}return new s(b)},_4e_nextSourceNode:function(b,d,i,o){b=h(b);if(o&&!o.call){var y=o[0]||o;o=function(r){r=r[0]||r;return r!==y}}d=!d&&b.firstChild;var t=new s(b);if(!d){if(b.nodeType==k.NODE_ELEMENT&&o&&o(b,true)===false)return null;d=b.nextSibling}for(;!d&&(t=t.parent());){if(o&&o(t,true)===false)return null;d=t[0].nextSibling}if(!d)return null;d=x._4e_wrap(d);if(o&&o(d)===false)return null;if(i&&i!=d[0].nodeType)return d._4e_nextSourceNode(false,
i,o);return d},_4e_previousSourceNode:function(b,d,i,o){b=h(b);if(o&&!o.call){var y=o[0]||o;o=function(r){r=r[0]||r;return r!==y}}d=!d&&b.lastChild;var t=new s(b);if(!d){if(b.nodeType==k.NODE_ELEMENT&&o&&o(b,true)===false)return null;d=b.previousSibling}for(;!d&&(t=t.parent());){if(o&&o(t,true)===false)return null;d=t[0].previousSibling}if(!d)return null;d=x._4e_wrap(d);if(o&&o(d)===false)return null;if(i&&d[0].nodeType!=i)return d._4e_previousSourceNode(false,i,o);return d},_4e_commonAncestor:function(b,
d){if(b._4e_equals(d))return b;if(d[0].nodeType!=k.NODE_TEXT&&d.contains(b))return d;var i=b[0].nodeType==k.NODE_TEXT?b.parent():b;do if(i[0].nodeType!=k.NODE_TEXT&&i.contains(d))return i;while(i=i.parent());return null},_4e_ascendant:function(b,d,i){b=h(b);if(!i)b=b.parentNode;if(d&&!v.isFunction(d)){var o=d;d=function(y){return y._4e_name()==o}}for(;b&&b.nodeType!=9;){if(!d||d(new s(b))===true)return new s(b);b=b.parentNode}return null},_4e_hasAttribute:n.ieEngine<9?function(b,d){b=h(b);var i=b.attributes[d];
return!!(i&&i.specified)}:function(b,d){b=h(b);return b.hasAttribute(d)},_4e_hasAttributes:n.ieEngine<9?function(b){b=h(b);for(var d=b.attributes,i=0;i<d.length;i++){var o=d[i];switch(o.name){case "class":if(b.getAttribute("class"))return true;break;default:if(o.specified)return true}}return false}:function(b){b=h(b);w.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},_4e_position:function(b,d){var i=h(b),o=h(d);if(i.compareDocumentPosition)return i.compareDocumentPosition(o);if(i==
o)return c.POSITION_IDENTICAL;if(i.nodeType==k.NODE_ELEMENT&&o.nodeType==k.NODE_ELEMENT){if(i.contains){if(i.contains(o))return c.POSITION_CONTAINS+c.POSITION_PRECEDING;if(o.contains(i))return c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING}if("sourceIndex"in i)return i.sourceIndex<0||o.sourceIndex<0?c.POSITION_DISCONNECTED:i.sourceIndex<o.sourceIndex?c.POSITION_PRECEDING:c.POSITION_FOLLOWING}i=b._4e_address();o=d._4e_address();for(var y=Math.min(i.length,o.length),t=0;t<=y-1;t++)if(i[t]!=o[t]){if(t<
y)return i[t]<o[t]?c.POSITION_PRECEDING:c.POSITION_FOLLOWING;break}return i.length<o.length?c.POSITION_CONTAINS+c.POSITION_PRECEDING:c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING},_4e_address:function(b,d){b=h(b);for(var i=[],o=b.ownerDocument.documentElement,y=b;y&&y!=o;){var t=y.parentNode,r=-1;if(t){for(var m=0;m<t.childNodes.length;m++){var A=t.childNodes[m];if(!(d&&A.nodeType==3&&A.previousSibling&&A.previousSibling.nodeType==3)){r++;if(A==y)break}}i.unshift(r)}y=t}return i},_4e_breakParent:function(b,
d){var i=new l.Range(b[0].ownerDocument);i.setStartAfter(b);i.setEndAfter(d);var o=i.extractContents();i.insertNode(b._4e_remove());b[0].parentNode.insertBefore(o,b[0].nextSibling)},_4e_style:function(b,d,i){b=q(b);if(i!==undefined)return b.css(d,i);b=h(b);return b.style[p(d)]},_4e_remove:function(b,d){var i=h(b),o=i.parentNode;if(o){if(d)for(var y;y=i.firstChild;)o.insertBefore(i.removeChild(y),i);o.removeChild(i)}return b},_4e_trim:function(b){x._4e_ltrim(b);x._4e_rtrim(b)},_4e_ltrim:function(b){b=
h(b);for(var d;d=b.firstChild;){if(d.nodeType==k.NODE_TEXT){var i=n.ltrim(d.nodeValue),o=d.nodeValue.length;if(i){if(i.length<o){(new s(d))._4e_splitText(o-i.length);b.removeChild(b.firstChild)}}else{b.removeChild(d);continue}}break}},_4e_rtrim:function(b){b=h(b);for(var d;d=b.lastChild;){if(d.type==k.NODE_TEXT){var i=n.rtrim(d.nodeValue),o=d.nodeValue.length;if(i){if(i.length<o){(new s(d))._4e_splitText(i.length);b.removeChild(b.lastChild)}}else{b.removeChild(d);continue}}break}if(!w.ie&&!w.opera)(d=
b.lastChild)&&d.nodeType==1&&d.nodeName.toLowerCase()=="br"&&d.parentNode.removeChild(d)},_4e_appendBogus:function(b){b=h(b);for(var d=b.lastChild;d&&d.nodeType==k.NODE_TEXT&&!v.trim(d.nodeValue);)d=d.previousSibling;if(!d||d.nodeType==k.NODE_TEXT||x._4e_name(d)!=="br"){d=w.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br");w.gecko&&d.setAttribute("type","_moz");b.appendChild(d)}},_4e_previous:function(b,d){var i=h(b),o;do o=(i=i.previousSibling)&&new s(i);while(o&&d&&!d(o));
return o},_4e_last:function(b,d){b=x._4e_wrap(b);var i=b[0].lastChild;if((i=i&&new s(i))&&d&&!d(i))i=i._4e_previous(d);return i},_4e_next:function(b,d){var i=h(b),o;do o=(i=i.nextSibling)&&new s(i);while(o&&d&&!d(o));return o},_4e_outerHtml:function(b){b=h(b);if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var d=b.ownerDocument.createElement("div");d.appendChild(b.cloneNode(true));return d.innerHTML},_4e_setMarker:function(b,d,i,o){b=x._4e_wrap(b);var y=b.data("list_marker_id")||b.data("list_marker_id",
v.guid()).data("list_marker_id"),t=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");d[y]=b;t[i]=1;return b.data(i,o)},_4e_clearMarkers:function(b,d,i){b=q(b);var o=b.data("list_marker_names"),y=b.data("list_marker_id"),t;for(t in o)b.removeData(t);b.removeData("list_marker_names");if(i){b.removeData("list_marker_id");delete d[y]}},_4e_copyAttributes:function(b,d,i){b=h(b);d=q(d);var o=b.attributes;i=i||{};for(var y=0;y<o.length;y++){var t=o[y],r=t.name.toLowerCase(),
m;if(!(r in i))if(r=="checked"&&(m=x.attr(b,r)))d.attr(r,m);else if(t.specified||w.ie&&t.value&&r=="value"){m=x.attr(b,r);if(m===null)m=t.nodeValue;d.attr(r,m)}}if(b.style.cssText!=="")d[0].style.cssText=b.style.cssText},_4e_isEditable:function(b){b=x._4e_name(b);var d=l.XHTML_DTD;return(b=!d.$nonEditable[b]&&(d[b]||d.span))&&b["#"]},_4e_scrollIntoView:function(b){b=q(b);var d=b[0].ownerDocument,i=x.scrollLeft(d),o=x.scrollTop(d),y=b.offset(),t=y.left;y=y.top;if(x.viewportHeight(d)+o<y||y<o||x.viewportWidth(d)+
i<t||t<i)b.scrollIntoView(d)},_4e_getElementsByTagName:function(b,d,i){b=h(b);if(!w.ie&&i)d=i+":"+d;i=[];b=b.getElementsByTagName(d);for(d=0;d<b.length;d++)i.push(new s(b[d]));return i}};v.DOM._4e_inject=function(b){v.mix(x,b);for(var d in b)b.hasOwnProperty(d)&&function(i){s.prototype[i]=function(){var o=[].slice.call(arguments,0);o.unshift(this);return b[i].apply(null,o)}}(d)};n.extern(g,{_4e_wrap:g._4e_wrap,_4e_unwrap:g._4e_unwrap,_4e_equals:g._4e_equals,_4e_isBlockBoundary:g._4e_isBlockBoundary,
_4e_getWin:g._4e_getWin,_4e_index:g._4e_index,_4e_first:g._4e_first,_4e_move:g._4e_move,_4e_name:g._4e_name,_4e_isIdentical:g._4e_isIdentical,_4e_isEmptyInlineRemoveable:g._4e_isEmptyInlineRemoveable,_4e_moveChildren:g._4e_moveChildren,_4e_mergeSiblings:g._4e_mergeSiblings,_4e_unselectable:g._4e_unselectable,_4e_getOffset:g._4e_getOffset,_4e_getFrameDocument:g._4e_getFrameDocument,_4e_splitText:g._4e_splitText,_4e_parents:g._4e_parents,_4e_clone:g._4e_clone,_4e_nextSourceNode:g._4e_nextSourceNode,
_4e_previousSourceNode:g._4e_previousSourceNode,_4e_commonAncestor:g._4e_commonAncestor,_4e_ascendant:g._4e_ascendant,_4e_hasAttribute:g._4e_hasAttribute,_4e_hasAttributes:g._4e_hasAttributes,_4e_position:g._4e_position,_4e_address:g._4e_address,_4e_breakParent:g._4e_breakParent,_4e_style:g._4e_style,_4e_remove:g._4e_remove,_4e_trim:g._4e_trim,_4e_ltrim:g._4e_ltrim,_4e_rtrim:g._4e_rtrim,_4e_appendBogus:g._4e_appendBogus,_4e_last:g._4e_last,_4e_previous:g._4e_previous,_4e_next:g._4e_next,_4e_outerHtml:g._4e_outerHtml,
_4e_setMarker:g._4e_setMarker,_4e_clearMarkers:g._4e_clearMarkers,_4e_getUniqueId:g._4e_getUniqueId,_4e_copyAttributes:g._4e_copyAttributes,_4e_isEditable:g._4e_isEditable,_4e_scrollIntoView:g._4e_scrollIntoView,_4e_getElementsByTagName:g._4e_getElementsByTagName});x._4e_inject(g)});
KISSY.Editor.add("focusmanager",function(l){function p(){this.iframeFocus=c;j=this;x.log(this._UUID+" focus")}function v(){this.iframeFocus=f;j=e;x.log(this._UUID+" blur")}var x=KISSY,w=x.DOM,s=x.Event,n={},j,k={refreshAll:function(){for(var h in n){var q=n[h];q.document.designMode="off";q.document.designMode="on"}},currentInstance:function(){return j},getInstance:function(h){return n[h]},add:function(h){var q=w._4e_getWin(h.document);s.on(q,"focus",p,h);s.on(q,"blur",v,h)},register:function(h){n[h._UUID]=
h},remove:function(h){delete n[h._UUID];var q=w._4e_getWin(h.document);s.remove(q,"focus",p,h);s.remove(q,"blur",v,h)}},c=true,f=false,e=null;l.focusManager=k;l.focusManager=k;l.getInstances=function(){return n};l.getInstances=l.getInstances});
KISSY.Editor.add("definition",function(l){var p=true,v=false,x=l.Utils,w=document,s=KISSY,n=s.UA,j=s.DOM,k=s.Node,c=s.Event,f=l.focusManager,e=x.tryThese,h=x.debugUrl("theme/editor-iframe.css"),q=1,g="document.open();"+(x.isCustomDomain()?'document.domain="'+w.domain+'";':"")+"document.close();",b="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(n.ie?"javascript:void(function(){"+encodeURIComponent(g)+"}())":"")+'"  tabIndex="'+(n.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";l.SOURCE_MODE=0;l.WYSIWYG_MODE=1;l.SOURCE_MODE=l.SOURCE_MODE;l.WYSIWYG_MODE=l.WYSIWYG_MODE;s.augment(l,{init:function(d){if(n.ie)j.addClass(w.body,"ie"+n.ie);else if(n.gecko)j.addClass(w.body,"gecko");else n.webkit&&j.addClass(w.body,"webkit");var i=this,o=new k(b.replace(/\$\(tabIndex\)/,
d.attr("tabIndex")));i.editorWrap=o;i._UUID=q++;f.register(i);i.wrap=o.one(".ke-textarea-wrap");i.wrap=i.wrap;i.iframe=i.wrap.one("iframe");i.iframe=i.iframe;i.toolBarDiv=o.one(".ke-editor-tools");i.toolBarDiv=i.toolBarDiv;i.textarea=d;i.textarea=i.textarea;i.statusDiv=o.one(".ke-editor-status");i.statusDiv=i.statusDiv;x.preventFocus(i.toolBarDiv);i._commands={};i._dialogs={};var y=d._4e_style("width"),t=d._4e_style("height");if(y){o.css("width",y);d.css("width","100%")}i.textarea.css("display","none");
o.insertAfter(d);i.wrap[0].appendChild(d[0]);if(t){i.wrap.css("height",t);d.css("height","100%")}o=i.iframe;i.on("dataReady",function(){i._ready=p;l.fire("instanceCreated",{editor:i})});n.gecko?o.on("load",i._setUpIFrame,i):i._setUpIFrame();i.cfg.attachForm&&d[0].form&&i._attachForm()},_attachForm:function(){(new k(this.textarea[0].form)).on("submit",this.sync,this)},useDialog:function(d,i){var o=this,y=l.Overlay;y.loading();o.use(d,function(){var t=o.getDialog(d);if(t){i(t);y.unloading()}else s.later(arguments.callee,
50,false,o)})},addDialog:function(d,i){this._dialogs[d]=i},getDialog:function(d){return this._dialogs[d]},addCommand:function(d,i){this._commands[d]=i},hasCommand:function(d){return this._commands[d]},execCommand:function(d){var i=this._commands[d],o=s.makeArray(arguments);o.shift();o.unshift(this);return i.exec.apply(i,o)},getMode:function(){return this.textarea.css("display")=="none"?l.WYSIWYG_MODE:l.SOURCE_MODE},getData:function(d){var i;i=this.getMode()==l.WYSIWYG_MODE?this.document.body.innerHTML:
this.textarea.val();if(this.htmlDataProcessor)i=d?this.htmlDataProcessor.toHtml(i,"p"):this.htmlDataProcessor.toServer(i,"p");i=s.trim(i);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(i))i="";return i},setData:function(d){var i=d;if(this.htmlDataProcessor)i=this.htmlDataProcessor.toDataFormat(d,"p");this.document.body.innerHTML=i;this.getMode()!=l.WYSIWYG_MODE&&this.textarea.val(d)},sync:function(){this.textarea.val(this.getData())},baseZIndex:function(d){d=d||0;return d+(this.cfg.baseZIndex||0)},_getRawData:function(){return this.document.body.innerHTML},
_setRawData:function(d){this.document.body.innerHTML=d},_prepareIFrameHtml:function(d){var i=this.cfg,o=i.customLink,y="";if(o)for(var t=0;t<o.length;t++)y+='<link href="'+o[t]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+l.Config.base+h+"' rel='stylesheet'/><style>"+(i.customStyle||"")+"</style>"+y+"</head><body class='ke-editor'>&nbsp;"+(d?'<script id="ke_actscript" type="text/javascript">'+(x.isCustomDomain()?'document.domain="'+w.domain+'";':"")+
'window.parent.KISSY.Editor._initIFrame("'+d+'");<\/script>':"")+"</body></html>"},getSelection:function(){return l.Selection.getSelection(this.document)},focus:function(){var d=this.document,i=j._4e_getWin(d);n.webkit&&i&&i.parent&&i.parent.focus();i&&i.focus();d&&d.body.focus();this.notifySelectionChange()},blur:function(){j._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(d){var i=this.cfg,o=this.document;i.customStyle=i.customStyle||"";i.customStyle+=
"\n"+d;i=o.createElement("style");o.getElementsByTagName("head")[0].appendChild(i);if(i.styleSheet)i.styleSheet.cssText=d;else i.appendChild(o.createTextNode(d))},addCustomLink:function(d){var i=this.cfg,o=this.document;i.customLink=i.customLink||[];i.customLink.push(d);i=o.createElement("link");i.rel="stylesheet";o.getElementsByTagName("head")[0].appendChild(i);i.href=d},removeCustomLink:function(d){for(var i=this.cfg,o=s.makeArray(this.document.getElementsByTagName("link")),y=0;y<o.length;y++)o[y].href==
d&&j._4e_remove(o[y]);i.customLink=i.customLink||[];i=i.customLink;d=s.indexOf(d,i);d!=-1&&i.splice(d,1)},_setUpIFrame:function(){function d(){r=t.document;i.document=r;o.detach();r.open("text/html","replace");r.write(y);r.close()}var i=this,o=i.iframe,y=i._prepareIFrameHtml(i._UUID),t=o[0].contentWindow,r;try{r=t.document}catch(m){o[0].src=o[0].src;if(n.ie<7){setTimeout(d,10);return}}d()},ready:function(d){this._ready?d():this.on("dataReady",d)},_monitor:function(){var d=this;d._monitorId&&clearTimeout(d._monitorId);
d._monitorId=setTimeout(function(){var i=d.getSelection();if(i&&!i.isInvalid){var o=i.getStartElement(),y=new l.ElementPath(o);if(!d.previousPath||!d.previousPath.compare(y)){d.previousPath=y;d.fire("selectionChange",{selection:i,path:y,element:o})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(d,i){var o=this;o.focus();var y=d._4e_name(),t=l.XHTML_DTD,r=l.RANGE,m=l.NODE,A=t.$block[y],E=o.getSelection(),D=E&&E.getRanges(),u,z,C,F,B;if(!D||
D.length==0){var G=arguments,M=G.callee;setTimeout(function(){M.apply(o,G)},30)}else{o.fire("save");for(var N=D.length-1;N>=0;N--){u=D[N];u.deleteContents();z=!N&&d||d._4e_clone(p);i&&i(z);if(A)for(;(F=u.getCommonAncestor(v,p))&&(B=t[F._4e_name()])&&!(B&&B[y]);)if(F._4e_name()in t.span)u.splitElement(F);else if(u.checkStartOfBlock()&&u.checkEndOfBlock()){u.setStartBefore(F);u.collapse(p);F._4e_remove()}else u.splitBlock();u.insertNode(z);C||(C=z)}if(C){y=C._4e_nextSourceNode(p);t=o.document;B=l.XHTML_DTD;
if(B.$inline[z._4e_name()]){y=new k(t.createTextNode(" "));y.insertAfter(C)}else if(y){if(y._4e_name()=="br"&&B[y.parent()._4e_name()].p){B=new k("<p>&nbsp;</p>",null,t);y[0].parentNode.replaceChild(B[0],y[0]);y=B}}else{B=new k("<p>&nbsp;</p>",null,t);B.insertAfter(C);y=B}u.moveToPosition(C,r.POSITION_AFTER_END);y&&y[0].nodeType==m.NODE_ELEMENT&&u.moveToElementEditablePosition(y);E.selectRanges([u]);o.focus();z&&z._4e_scrollIntoView();setTimeout(function(){o.fire("save")},10);return z}}},insertHtml:function(d){var i=
this;if(i.htmlDataProcessor)d=i.htmlDataProcessor.toDataFormat(d);if(n.webkit){var o=j.create(d,null,this.document);o=o.nodeType==11?s.makeArray(o.childNodes):[o];for(var y=0;y<o.length;y++)i.insertElement(new k(o[y]))}else{i.focus();y=(o=i.getSelection())&&o.getRanges();if(!y||y.length==0){var t=arguments,r=t.callee;setTimeout(function(){r.apply(i,t)},30)}else{i.fire("save");if(n.ie){o=o.getNative();o.type=="Control"&&o.clear();o.createRange().pasteHTML(d)}else i.document.execCommand("inserthtml",
v,d);i.focus();setTimeout(function(){i.fire("save")},10)}}}});l._initIFrame=function(d){function i(z){e(function(){t.designMode="on";setTimeout(function(){t.designMode="off";A.focus();if(!arguments.callee.retry)arguments.callee.retry=p},50)},function(){t.designMode="off";j.attr(A,"contentEditable",v);j.attr(A,"contentEditable",p);!z&&i(1)})}var o=f.getInstance(d);d=o.textarea[0];var y=o.iframe[0].contentWindow,t=o.document,r=o.cfg,m=t.getElementById("ke_actscript");j._4e_remove(m);var A=t.body;if(n.ie){A.hideFocus=
p;A.disabled=p;A.contentEditable=p;A.removeAttribute("disabled")}else setTimeout(function(){if(n.gecko||n.opera)A.contentEditable=p;else if(n.webkit)A.parentNode.contentEditable=p;else t.designMode="on"},0);if(n.webkit){c.on(t,"click",function(z){var C=new k(z.target);s.inArray(C._4e_name(),["input","select"])&&z.preventDefault()});c.on(t,"mouseup",function(z){var C=new k(z.target);s.inArray(C._4e_name(),["input","textarea"])&&z.preventDefault()})}if(n.gecko||n.ie||n.opera){var E;E=new k(j.insertAfter((new k('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],
d));E.on("focus",function(){o.focus()});o.activateGecko=function(){n.gecko&&o.iframeFocus&&E[0].focus()};o.on("destroy",function(){})}if(n.ie&&t.compatMode=="CSS1Compat"||n.gecko||n.opera){var D=new k(t.documentElement);D.on("mousedown",function(z){if((new k(z.target))[0]==D[0]){n.gecko&&i(v);E[0].focus()}})}c.on(y,"focus",function(){if(n.gecko)i(v);else n.opera&&A.focus();o.notifySelectionChange()});n.gecko&&c.on(o.document,"mousedown",function(){o.iframeFocus||i(v)});if(n.ie){c.on(t,"keydown",function(z){if(z.keyCode in
{8:1,46:1}){var C=o.getSelection(),F=C.getSelectedElement();if(F){o.fire("save");var B=C.getRanges()[0].createBookmark();F._4e_remove();C.selectBookmarks([B]);o.fire("save");z.preventDefault()}}});if(t.compatMode=="CSS1Compat"){var u={33:1,34:1};c.on(t,"keydown",function(z){z.keyCode in u&&setTimeout(function(){o.getSelection().scrollIntoView()},0)})}}setTimeout(function(){n.ie&&setTimeout(function(){if(t){A.runtimeStyle.marginBottom="0px";A.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){o.fire("dataReady");
var z=r.disableObjectResizing,C=r.disableInlineTableEditing;if(z||C)try{t.execCommand("enableObjectResizing",v,!z);t.execCommand("enableInlineTableEditing",v,!C)}catch(F){c.on(A,n.ie?"resizestart":"resize",function(B){var G=new k(B.target);if(z||G._4e_name()==="table"&&C)B.preventDefault()})}},10);n.webkit&&c.on(t,"mousedown",function(z){z=new k(z.target);s.inArray(z._4e_name(),["img","hr","input","textarea","select"])&&o.getSelection().selectElement(z)});n.gecko&&c.on(t,"dragstart",function(z){var C=
new k(z.target);C._4e_name()==="img"&&/ke_/.test(C[0].className)&&z.preventDefault()});f.add(o)};g=l.prototype;x.extern(g,{setData:g.setData,getData:g.getData,insertElement:g.insertElement,insertHtml:g.insertHtml,ready:g.ready,addCustomStyle:g.addCustomStyle,addCommand:g.addCommand,hasCommand:g.hasCommand,execCommand:g.execCommand,useDialog:g.useDialog,addDialog:g.addDialog,getDialog:g.getDialog,getMode:g.getMode,sync:g.sync,baseZIndex:g.baseZIndex,getSelection:g.getSelection,focus:g.focus,blur:g.blur,
notifySelectionChange:g.notifySelectionChange})});KISSY.Editor.add("zindex",function(){var l=KISSY.Editor;if(!l.zIndexManager){l.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};l.baseZIndex=function(p){var v=p,x=l.getInstances(),w;for(w in x){if(!x.hasOwnProperty(w))return;v=Math.max(v,x[w].baseZIndex(p))}return v};l.baseZIndex=l.baseZIndex;l.zIndexManager=l.zIndexManager}});
KISSY.Editor.add("dtd",function(l){l.XHTML_DTD=function(){function p(r){for(var m=arguments.length-1;m>0;)KISSY.mix(r,arguments[m--]);return r}var v={isindex:1,fieldset:1},x={input:1,button:1,select:1,textarea:1,label:1},w=p({a:1},x),s=p({iframe:1},w),n={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},j={ins:1,del:1,script:1,style:1},k=p({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},j),c=p({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},k),f=p({p:1},c);x=p({iframe:1},c,x);c={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var e=p({a:1},x),h={tr:1},q={"#":1},g=p({param:1},c),b=p({form:1},v,s,n,f),d={li:1},i={base:1,link:1,meta:1,title:1},o=p(i,{style:1,script:1}),y={head:1,body:1},t={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:p({html:1},y,i),$block:t,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:e,$body:p({script:1,style:1},t),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:y,head:o,style:q,body:b,base:{},link:{},meta:{},title:q,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:b,td:b,br:{},th:b,center:b,kbd:e,button:p(f,n),basefont:{},h5:e,h4:e,samp:e,h6:e,ol:d,h1:e,h3:e,option:q,h2:e,form:p(v,s,n,f),select:{optgroup:1,option:1},font:e,ins:e,menu:d,abbr:e,label:e,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:e,script:q,tfoot:h,cite:e,li:b,input:{},iframe:b,strong:e,textarea:q,noframes:b,big:e,small:e,span:e,hr:{},dt:e,sub:e,optgroup:{option:1},param:{},bdo:e,"var":e,div:b,object:g,sup:e,dd:b,strike:e,area:{},dir:d,map:p({area:1,form:1,p:1},v,j,n),applet:g,dl:{dt:1,dd:1},del:e,isindex:{},fieldset:p({legend:1},c),thead:h,ul:d,acronym:e,b:e,a:x,blockquote:b,caption:e,i:e,u:e,tbody:h,s:e,address:p(s,f),tt:e,legend:e,q:e,pre:p(k,w),p:e,em:e,dfn:e}}();l.XHTML_DTD=
l.XHTML_DTD});
KISSY.Editor.add("elementpath",function(l){function p(c){var f=s,e=s,h=[];for(c=c;c&&c[0];){if(c[0].nodeType==w.NODE_ELEMENT){if(!this.lastElement)this.lastElement=c;var q=c._4e_name();if(!e){if(!f&&n[q])f=c;if(j[q]){var g;if(g=!f){if(g=q=="div"){a:{g=c;g=g[0]||g;g=g.childNodes;for(var b=0,d=g.length;b<d;b++){var i=g[b];if(i.nodeType==w.NODE_ELEMENT&&x.$block[i.nodeName.toLowerCase()]){g=true;break a}}g=false}g=!g}g=g}if(g)f=c;else e=c}}h.push(c);if(q=="body")break}c=c.parent()}this.block=this.block=
f;this.blockLimit=this.blockLimit=e;this.elements=this.elements=h}var v=KISSY.DOM,x=l.XHTML_DTD,w=l.NODE,s=null,n={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};p.prototype={compare:function(c){var f=this.elements;c=c&&c.elements;if(!c||f.length!=c.length)return false;for(var e=0;e<f.length;e++)if(!v._4e_equals(f[e],c[e]))return false;return true},contains:function(c){for(var f=this.elements,e=0;e<
f.length;e++)if(f[e]._4e_name()in c)return f[e];return s}};l.ElementPath=l.ElementPath=p;var k=p.prototype;l.Utils.extern(k,{compare:k.compare,contains:k.contains})});
KISSY.Editor.add("walker",function(l){function p(h,q){if(this._.end)return n;var g,b=this.range,d,i=this.guard,o=this.type,y=h?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;b.trim();if(b.collapsed){this.end();return n}}if(!h&&!this._.guardLTR){var t=b.endContainer,r=new f(t[0].childNodes[b.endOffset]);this._.guardLTR=function(D,u){return(D=c._4e_wrap(D))&&D[0]&&(!u||!c._4e_equals(t,D))&&(!r[0]||!D._4e_equals(r))&&(D[0].nodeType!=k.NODE_ELEMENT||!u||D._4e_name()!="body")}}if(h&&
!this._.guardRTL){var m=b.startContainer,A=b.startOffset>0&&new f(m[0].childNodes[b.startOffset-1]);this._.guardRTL=function(D,u){return(D=c._4e_wrap(D))&&D[0]&&(!u||!D._4e_equals(m))&&(!A[0]||!D._4e_equals(A))&&(D[0].nodeType!=k.NODE_ELEMENT||!u||D._4e_name()!="body")}}var E=h?this._.guardRTL:this._.guardLTR;d=i?function(D,u){if(E(D,u)===s)return s;return i(D,u)}:E;if(this.current)g=this.current[y](s,o,d);else if(h){g=b.endContainer;if(b.endOffset>0){g=new f(g[0].childNodes[b.endOffset-1]);if(d(g)===
s)g=n}else g=d(g,w)===s?n:g._4e_previousSourceNode(w,o,d)}else{g=b.startContainer;if((g=new f(g[0].childNodes[b.startOffset]))&&g[0]){if(d(g)===s)g=n}else g=d(b.startContainer,w)===s?n:b.startContainer._4e_nextSourceNode(w,o,d)}for(;g&&g[0]&&!this._.end;){this.current=g;if(!this.evaluator||this.evaluator(g)!==s){if(!q)return g}else if(q&&this.evaluator)return s;g=g[y](s,o,d)}this.end();return this.current=n}function v(h){for(var q,g=n;q=p.call(this,h);)g=q;return g}function x(h){this.range=h;this._=
{}}var w=true,s=false,n=null,j=KISSY,k=l.NODE,c=j.DOM,f=j.Node;j.augment(x,{end:function(){this._.end=1},next:function(){return p.call(this)},previous:function(){return p.call(this,w)},checkForward:function(){return p.call(this,s,w)!==s},checkBackward:function(){return p.call(this,w,w)!==s},lastForward:function(){return v.call(this)},lastBackward:function(){return v.call(this,w)},reset:function(){delete this.current;this._={}}});x.blockBoundary=function(h){return function(q){q=c._4e_wrap(q);return!(q&&
q[0].nodeType==k.NODE_ELEMENT&&q._4e_isBlockBoundary(h))}};x.listItemBoundary=function(){return this.blockBoundary({br:1})};x.bookmark=function(h,q){function g(b){return b&&b[0]&&b._4e_name()=="span"&&b.attr("_ke_bookmark")}return function(b){var d,i;d=b&&b[0]&&b[0].nodeType==k.NODE_TEXT&&(i=b.parent())&&g(i);d=h?d:d||g(b);return q^d}};x.whitespaces=function(h){return function(q){q=(q=q[0]||q)&&q.nodeType==k.NODE_TEXT&&!j.trim(q.nodeValue);return h^q}};x.invisible=function(h){var q=x.whitespaces();
return function(g){g=q(g)||g[0].nodeType==k.NODE_ELEMENT&&!g[0].offsetHeight;return h^g}};l.Walker=x;l.Walker=x;var e=x.prototype;l.Utils.extern(e,{end:e.end,next:e.next,previous:e.previous,checkForward:e.checkForward,checkBackward:e.checkBackward,lastForward:e.lastForward,lastBackward:e.lastBackward,reset:e.reset});l.Utils.extern(x,{blockBoundary:x.blockBoundary,listItemBoundary:x.listItemBoundary,bookmark:x.bookmark,whitespaces:x.whitespaces,invisible:x.invisible})});
KISSY.Editor.add("range",function(l){function p(u){this.endOffset=this.endContainer=this.startOffset=this.startContainer=c;this.collapsed=j;this.document=u}function v(u){var z=u[0].nodeType!=e.NODE_TEXT&&u._4e_name()in o.$removeEmpty,C=!f.trim(u[0].nodeValue);u=!!u.parent().attr("_ke_bookmark");return z||C||u}function x(u){return!A(u)&&!E(u)}function w(u){var z=k,C=g.bookmark(j);return function(F){if(C(F))return j;if(F[0].nodeType==e.NODE_TEXT){if(f.trim(F[0].nodeValue).length)return k}else if(F[0].nodeType==
e.NODE_ELEMENT)if(!m[F._4e_name()])if(!u&&!i.ie&&F._4e_name()=="br"&&!z)z=j;else return k;return j}}function s(u,z){function C(F){return F&&F.nodeName=="span"&&F.getAttribute("_ke_bookmark")}return function(F){var B,G;B=F&&!F.nodeName&&(G=F.parentNode)&&C(G);B=u?B:B||C(F);return z^B}}function n(u){return function(z){z=(z=z[0]||z)&&z.nodeType==e.NODE_TEXT&&!f.trim(z.nodeValue);return u^z}}l.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};l.RANGE=l.RANGE;var j=true,k=false,c=null,f=KISSY,e=l.NODE,h=l.RANGE,q=l.POSITION,g=l.Walker,b=f.DOM,d=l.Utils.getByAddress,i=f.UA,o=l.XHTML_DTD,y=l.ElementPath,t=f.Node,r={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};p.prototype.toString=function(){var u=[];u.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);u.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return u.join("<br/>")};f.augment(p,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&b._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var u=this.startContainer,z=this.startOffset;if(u[0].nodeType!=e.NODE_ELEMENT)if(z)z>=u[0].nodeValue.length&&this.setStartAfter(u);else this.setStartBefore(u);u=this.endContainer;z=this.endOffset;if(u[0].nodeType!=e.NODE_ELEMENT)if(z)z>=
u[0].nodeValue.length&&this.setEndAfter(u);else this.setEndBefore(u)},setStartAfter:function(u){this.setStart(u.parent(),u._4e_index()+1)},setStartBefore:function(u){this.setStart(u.parent(),u._4e_index())},setEndAfter:function(u){this.setEnd(u.parent(),u._4e_index()+1)},setEndBefore:function(u){this.setEnd(u.parent(),u._4e_index())},optimizeBookmark:function(){var u=this.startContainer,z=this.endContainer;u&&u._4e_name()=="span"&&u.attr("_ke_bookmark")&&this.setStartAt(u,h.POSITION_BEFORE_START);
z&&z._4e_name()=="span"&&z.attr("_ke_bookmark")&&this.setEndAt(z,h.POSITION_AFTER_END)},setStart:function(u,z){if(u[0].nodeType==e.NODE_ELEMENT&&r[u._4e_name()]){u=u.parent();z=u._4e_index()}this.startContainer=u;this.startOffset=z;if(!this.endContainer){this.endContainer=u;this.endOffset=z}this.updateCollapsed()},setEnd:function(u,z){if(u[0].nodeType==e.NODE_ELEMENT&&r[u._4e_name()]){u=u.parent();z=u._4e_index()+1}this.endContainer=u;this.endOffset=z;if(!this.startContainer){this.startContainer=
u;this.startOffset=z}this.updateCollapsed()},setStartAt:function(u,z){switch(z){case h.POSITION_AFTER_START:this.setStart(u,0);break;case h.POSITION_BEFORE_END:u[0].nodeType==e.NODE_TEXT?this.setStart(u,u[0].nodeValue.length):this.setStart(u,u[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setStartBefore(u);break;case h.POSITION_AFTER_END:this.setStartAfter(u)}this.updateCollapsed()},setEndAt:function(u,z){switch(z){case h.POSITION_AFTER_START:this.setEnd(u,0);break;case h.POSITION_BEFORE_END:u[0].nodeType==
e.NODE_TEXT?this.setEnd(u,u[0].nodeValue.length):this.setEnd(u,u[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setEndBefore(u);break;case h.POSITION_AFTER_END:this.setEndAfter(u)}this.updateCollapsed()},execContentsAction:function(u,z){var C=this.startContainer,F=this.endContainer,B=this.startOffset,G=this.endOffset,M,N=this.document,Q;this.optimizeBookmark();if(F[0].nodeType==e.NODE_TEXT)F=F._4e_splitText(G);else if(F[0].childNodes.length>0)if(G>=F[0].childNodes.length){F=new t(F[0].appendChild(N.createTextNode("")));
Q=j}else F=new t(F[0].childNodes[G]);if(C[0].nodeType==e.NODE_TEXT){C._4e_splitText(B);if(C._4e_equals(F))F=new t(C[0].nextSibling)}else if(B)if(B>=C[0].childNodes.length){M=new t(N.createTextNode(""));C.append(M);C=M;M=j}else C=new t(C[0].childNodes[B].previousSibling);else{M=new t(N.createTextNode(""));C.prepend(M);C=M;M=j}B=C._4e_parents();G=F._4e_parents();var R,V,T;for(R=0;R<B.length;R++){V=B[R];T=G[R];if(!V._4e_equals(T))break}N=z;for(var U,W,H,L=R;L<B.length;L++){U=B[L];W=N&&!U._4e_equals(C)?
N.appendChild(U._4e_clone()[0]):null;for(U=U[0].nextSibling;U;){if(b._4e_equals(G[L],U)||b._4e_equals(F,U))break;H=U.nextSibling;if(u==2)N.appendChild(U.cloneNode(j));else{b._4e_remove(U);u==1&&N.appendChild(U)}U=H}if(W)N=W}N=z;for(R=R;R<G.length;R++){U=G[R];W=N&&u>0&&!U._4e_equals(F)?N.appendChild(U._4e_clone()[0]):null;if(!B[R]||!U.parent()._4e_equals(B[R].parent()))for(U=U[0].previousSibling;U;){if(b._4e_equals(B[R],U)||b._4e_equals(C,U))break;H=U.previousSibling;if(u==2)N.insertBefore(U.cloneNode(j),
N.firstChild);else{b._4e_remove(U);u==1&&N.insertBefore(U,N.firstChild)}U=H}if(W)N=W}if(u==2){T=this.startContainer[0];if(T.nodeType==e.NODE_TEXT&&T.nextSibling&&T.nextSibling.nodeType==e.NODE_TEXT){T.data+=T.nextSibling.data;T.parentNode.removeChild(T.nextSibling)}T=this.endContainer[0];if(T.nodeType==e.NODE_TEXT&&T.nextSibling&&T.nextSibling.nodeType==e.NODE_TEXT){T.data+=T.nextSibling.data;T.parentNode.removeChild(T.nextSibling)}}else{if(V&&T&&(!C.parent()._4e_equals(V.parent())||!F.parent()._4e_equals(T.parent()))){V=
T._4e_index();M&&T.parent()._4e_equals(C.parent())&&V--;this.setStart(T.parent(),V)}this.collapse(j)}M&&C._4e_remove();Q&&F[0].parentNode&&F._4e_remove()},collapse:function(u){if(u){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=j},clone:function(){var u=new p(this.document);u.startContainer=this.startContainer;u.startOffset=this.startOffset;u.endContainer=this.endContainer;u.endOffset=
this.endOffset;u.collapsed=this.collapsed;return u},getEnclosedNode:function(){var u=this.clone();u.optimize();if(u.startContainer[0].nodeType!=e.NODE_ELEMENT||u.endContainer[0].nodeType!=e.NODE_ELEMENT)return c;var z=new l.Walker(u),C=s(j,undefined),F=n(j);u.evaluator=function(B){return F(B)&&C(B)};u=z.next();z.reset();z=z.previous();return u&&u._4e_equals(z)?u:c},shrink:function(u,z){if(!this.collapsed){u=u||h.SHRINK_TEXT;var C=this.clone(),F=this.startContainer,B=this.endContainer,G=this.startOffset,
M=this.endOffset,N=1,Q=1;if(F&&F[0].nodeType==e.NODE_TEXT)if(G)if(G>=F[0].nodeValue.length)C.setStartAfter(F);else{C.setStartBefore(F);N=0}else C.setStartBefore(F);if(B&&B[0].nodeType==e.NODE_TEXT)if(M)if(M>=B[0].nodeValue.length)C.setEndAfter(B);else{C.setEndAfter(B);Q=0}else C.setEndBefore(B);C=new g(C);C.evaluator=function(V){V=V[0]||V;return V.nodeType==(u==h.SHRINK_ELEMENT?e.NODE_ELEMENT:e.NODE_TEXT)};var R;C.guard=function(V,T){V=V[0]||V;if(u==h.SHRINK_ELEMENT&&V.nodeType==e.NODE_TEXT)return k;
if(T&&V==R)return k;if(!T&&V.nodeType==e.NODE_ELEMENT)R=V;return j};if(N)(F=C[u==h.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(F,z?h.POSITION_AFTER_START:h.POSITION_BEFORE_START);if(Q){C.reset();(C=C[u==h.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(C,z?h.POSITION_BEFORE_END:h.POSITION_AFTER_END)}return!!(N||Q)}},getTouchedStartNode:function(){var u=this.startContainer;if(this.collapsed||u[0].nodeType!=e.NODE_ELEMENT)return u;return u.childNodes[this.startOffset]||u},createBookmark2:function(u){var z=
this.startContainer,C=this.endContainer,F=this.startOffset,B=this.endOffset,G,M;if(!z||!C)return{start:0,end:0};if(u){if(z[0].nodeType==e.NODE_ELEMENT)if((G=new t(z[0].childNodes[F]))&&G[0]&&G[0].nodeType==e.NODE_TEXT&&F>0&&G[0].previousSibling.nodeType==e.NODE_TEXT){z=G;F=0}for(;z[0].nodeType==e.NODE_TEXT&&(M=z._4e_previous())&&M[0].nodeType==e.NODE_TEXT;){z=M;F+=M[0].nodeValue.length}if(!this.collapsed){if(C[0].nodeType==e.NODE_ELEMENT)if((G=new t(C[0].childNodes[B]))&&G[0]&&G[0].nodeType==e.NODE_TEXT&&
B>0&&G[0].previousSibling.nodeType==e.NODE_TEXT){C=G;B=0}for(;C[0].nodeType==e.NODE_TEXT&&(M=C._4e_previous())&&M[0].nodeType==e.NODE_TEXT;){C=M;B+=M[0].nodeValue.length}}}return{start:z._4e_address(u),end:this.collapsed?c:C._4e_address(u),startOffset:F,endOffset:B,normalized:u,is2:j}},createBookmark:function(u){var z,C,F,B,G=this.collapsed;z=new t("<span>",c,this.document);z.attr("_ke_bookmark",1);z.css("display","none");z.html("&nbsp;");if(u){F=f.guid("ke_bm_");z.attr("id",F+"S")}if(!G){C=z._4e_clone();
C.html("&nbsp;");u&&C.attr("id",F+"E");B=this.clone();B.collapse();B.insertNode(C)}B=this.clone();B.collapse(j);B.insertNode(z);if(C){this.setStartAfter(z);this.setEndBefore(C)}else this.moveToPosition(z,h.POSITION_AFTER_END);return{startNode:u?F+"S":z,endNode:u?F+"E":C,serializable:u,collapsed:G}},moveToPosition:function(u,z){this.setStartAt(u,z);this.collapse(j)},trim:function(u,z){var C=this.startContainer,F=this.startOffset,B=this.collapsed;if((!u||B)&&C[0]&&C[0].nodeType==e.NODE_TEXT){if(F)if(F>=
C[0].nodeValue.length){F=C._4e_index()+1;C=C.parent()}else{var G=C._4e_splitText(F);F=C._4e_index()+1;C=C.parent();if(b._4e_equals(this.startContainer,this.endContainer))this.setEnd(G,this.endOffset-this.startOffset);else if(b._4e_equals(C,this.endContainer))this.endOffset+=1}else{F=C._4e_index();C=C.parent()}this.setStart(C,F);if(B){this.collapse(j);return}}C=this.endContainer;F=this.endOffset;if(!(z||B)&&C[0]&&C[0].nodeType==e.NODE_TEXT){if(F){F>=C.nodeValue.length||C._4e_splitText(F);F=C._4e_index()+
1}else F=C._4e_index();C=C.parent();this.setEnd(C,F)}},insertNode:function(u){this.optimizeBookmark();this.trim(k,j);var z=this.startContainer;z[0].insertBefore(u[0]||u,z[0].childNodes[this.startOffset]||null);b._4e_equals(u.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(u)},moveToBookmark:function(u){if(u.is2){var z=d(this.document,u.start,u.normalized),C=u.startOffset,F=u.end&&d(this.document,u.end,u.normalized);u=u.endOffset;this.setStart(z,C);F?this.setEnd(F,u):this.collapse(j)}else{z=
(C=u.serializable)?f.one("#"+u.startNode,this.document):u.startNode;u=C?f.one("#"+u.endNode,this.document):u.endNode;this.setStartBefore(z);z._4e_remove();if(u&&u[0]){this.setEndBefore(u);u._4e_remove()}else this.collapse(j)}},getCommonAncestor:function(u,z){var C=this.startContainer,F=this.endContainer;C=b._4e_equals(C,F)?u&&C[0].nodeType==e.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new t(C[0].childNodes[this.startOffset]):C:C._4e_commonAncestor(F);return z&&C[0].nodeType==e.NODE_TEXT?C.parent():
C},enlarge:function(u){switch(u){case h.ENLARGE_ELEMENT:if(this.collapsed)break;u=this.getCommonAncestor();var z=new t(this.document.body),C,F,B,G,M,N=k,Q,R;Q=this.startContainer;R=this.startOffset;if(Q[0].nodeType==e.NODE_TEXT){if(R){Q=!f.trim(Q[0].nodeValue.substring(0,R)).length&&Q;N=!!Q}if(Q)if(!(G=Q[0].previousSibling))B=Q.parent()}else{if(R)G=Q[0].childNodes[R-1]||Q[0].lastChild;G||(B=Q)}for(;B||G;){if(B&&!G){if(!M&&b._4e_equals(B,u))M=j;if(!z.contains(B))break;if(!N||B.css("display")!="inline"){N=
k;if(M)C=B;else this.setStartBefore(B)}G=B[0].previousSibling}for(;G;){Q=k;if(G.nodeType==e.NODE_TEXT){R=G.nodeValue;if(/[^\s\ufeff]/.test(R))G=c;Q=/[\s\ufeff]$/.test(R)}else if(G.offsetWidth>0&&!G.getAttribute("_ke_bookmark"))if(N&&o.$removeEmpty[G.nodeName.toLowerCase()]){R=b.text(G);if(/[^\s\ufeff]/.test(R))G=c;else for(var V=G.all||G.getElementsByTagName("*"),T=0,U;U=V[T++];)if(!o.$removeEmpty[U.nodeName.toLowerCase()]){G=c;break}if(G)Q=!!R.length}else G=c;if(Q)if(N)if(M)C=B;else B&&this.setStartBefore(B);
else N=j;if(G){Q=G.previousSibling;if(!B&&!Q){B=new t(G);G=c;break}G=Q}else B=c}if(B)B=B.parent()}Q=this.endContainer;R=this.endOffset;B=G=c;M=N=k;if(Q[0].nodeType==e.NODE_TEXT){Q=!f.trim(Q[0].nodeValue.substring(R)).length&&Q;N=!(Q&&Q[0].nodeValue.length);if(Q)if(!(G=Q[0].nextSibling))B=Q.parent()}else(G=Q[0].childNodes[R])||(B=Q);for(;B||G;){if(B&&!G){if(!M&&b._4e_equals(B,u))M=j;if(!z.contains(B))break;if(!N||B.css("display")!="inline"){N=k;if(M)F=B;else B&&this.setEndAfter(B)}G=B[0].nextSibling}for(;G;){Q=
k;if(G.nodeType==e.NODE_TEXT){R=G.nodeValue;if(/[^\s\ufeff]/.test(R))G=c;Q=/^[\s\ufeff]/.test(R)}else if(G.offsetWidth>0&&!G.getAttribute("_ke_bookmark"))if(N&&o.$removeEmpty[G.nodeName.toLowerCase()]){R=b.text(G);if(/[^\s\ufeff]/.test(R))G=c;else{V=G.all||G.getElementsByTagName("*");for(T=0;U=V[T++];)if(!o.$removeEmpty[U.nodeName.toLowerCase()]){G=c;break}}if(G)Q=!!R.length}else G=c;if(Q)if(N)if(M)F=B;else this.setEndAfter(B);if(G){Q=G.nextSibling;if(!B&&!Q){B=new t(G);G=c;break}G=Q}else B=c}if(B)B=
B.parent()}if(C&&F){u=C.contains(F)?F:C;this.setStartBefore(u);this.setEndAfter(u)}break;case h.ENLARGE_BLOCK_CONTENTS:case h.ENLARGE_LIST_ITEM_CONTENTS:B=new p(this.document);z=new t(this.document.body);B.setStartAt(z,h.POSITION_AFTER_START);B.setEnd(this.startContainer,this.startOffset);B=new g(B);var W,H,L=g.blockBoundary(u==h.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:c),J=function(I){var K=L(I);K||(W=I);return K};C=function(I){var K=J(I);if(!K&&I[0]&&I._4e_name()=="br")H=I;return K};B.guard=J;B=B.lastBackward();
W=W||z;this.setStartAt(W,W._4e_name()!="br"&&(!B&&this.checkStartOfBlock()||B&&W.contains(B))?h.POSITION_AFTER_START:h.POSITION_AFTER_END);B=this.clone();B.collapse();B.setEndAt(z,h.POSITION_BEFORE_END);B=new g(B);B.guard=u==h.ENLARGE_LIST_ITEM_CONTENTS?C:J;W=c;B=B.lastForward();W=W||z;this.setEndAt(W,!B&&this.checkEndOfBlock()||B&&W.contains(B)?h.POSITION_BEFORE_END:h.POSITION_BEFORE_START);H&&this.setEndAfter(H)}},checkStartOfBlock:function(){var u=this.startContainer,z=this.startOffset;if(z&&u[0].nodeType==
e.NODE_TEXT)if(f.trim(u[0].nodeValue.substring(0,z)).length)return k;this.trim();u=new y(this.startContainer);z=this.clone();z.collapse(j);z.setStartAt(u.block||u.blockLimit,h.POSITION_AFTER_START);u=new g(z);u.evaluator=w(j);return u.checkBackward()},checkEndOfBlock:function(){var u=this.endContainer,z=this.endOffset;if(u[0].nodeType==e.NODE_TEXT)if(f.trim(u[0].nodeValue.substring(z)).length)return k;this.trim();u=new y(this.endContainer);z=this.clone();z.collapse(k);z.setEndAt(u.block||u.blockLimit,
h.POSITION_BEFORE_END);u=new g(z);u.evaluator=w(k);return u.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var u=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,u);return u},checkBoundaryOfElement:function(u,z){var C=this.clone();C[z==h.START?"setStartAt":"setEndAt"](u,z==h.START?h.POSITION_AFTER_START:h.POSITION_BEFORE_END);C=new g(C);C.evaluator=v;return C[z==h.START?"checkBackward":"checkForward"]()},
getBoundaryNodes:function(){var u=this.startContainer,z=this.endContainer,C=this.startOffset,F=this.endOffset,B;if(u[0].nodeType==e.NODE_ELEMENT){B=u[0].childNodes.length;if(B>C)u=new t(u[0].childNodes[C]);else if(B<1)u=u._4e_previousSourceNode();else{for(u=u[0];u.lastChild;)u=u.lastChild;u=new t(u);u=u._4e_nextSourceNode()||u}}if(z[0].nodeType==e.NODE_ELEMENT){B=z[0].childNodes.length;if(B>F)z=(new t(z[0].childNodes[F]))._4e_previousSourceNode(j);else if(B<1)z=z._4e_previousSourceNode();else{for(z=
z[0];z.lastChild;)z=z.lastChild;z=new t(z)}}if(u._4e_position(z)&q.POSITION_FOLLOWING)u=z;return{startNode:u,endNode:z}},fixBlock:function(u,z){var C=this.createBookmark(),F=new t(this.document.createElement(z));this.collapse(u);this.enlarge(h.ENLARGE_BLOCK_CONTENTS);F[0].appendChild(this.extractContents());F._4e_trim();i.ie||F._4e_appendBogus();this.insertNode(F);this.moveToBookmark(C);return F},splitBlock:function(u){var z=new y(this.startContainer),C=new y(this.endContainer),F=z.block,B=C.block,
G=c;if(!z.blockLimit._4e_equals(C.blockLimit))return c;if(u!="br"){if(!F){F=this.fixBlock(j,u);B=(new y(this.endContainer)).block}B||(B=this.fixBlock(k,u))}u=F&&this.checkStartOfBlock();z=B&&this.checkEndOfBlock();this.deleteContents();if(F&&b._4e_equals(F,B))if(z){G=new y(this.startContainer);this.moveToPosition(B,h.POSITION_AFTER_END);B=c}else if(u){G=new y(this.startContainer);this.moveToPosition(F,h.POSITION_BEFORE_START);F=c}else{B=this.splitElement(F);!i.ie&&!f.inArray(F._4e_name(),["ul","ol"])&&
F._4e_appendBogus()}return{previousBlock:F,nextBlock:B,wasStartOfBlock:u,wasEndOfBlock:z,elementPath:G}},splitElement:function(u){if(!this.collapsed)return c;this.setEndAt(u,h.POSITION_BEFORE_END);var z=this.extractContents(),C=u._4e_clone(k);C[0].appendChild(z);C.insertAfter(u);this.moveToPosition(u,h.POSITION_AFTER_END);return C},moveToElementEditablePosition:function(u,z){var C,F=l.XHTML_DTD;if(F.$empty[u._4e_name()])return k;for(;u&&u[0].nodeType==e.NODE_ELEMENT;){if(C=u._4e_isEditable())this.moveToPosition(u,
z?h.POSITION_BEFORE_END:h.POSITION_AFTER_START);else if(F.$inline[u._4e_name()]){this.moveToPosition(u,z?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);return j}if((u=F.$empty[u._4e_name()]?u[z?"_4e_previous":"_4e_next"](x):u[z?"_4e_last":"_4e_first"](x))&&u[0].nodeType==e.NODE_TEXT){this.moveToPosition(u,z?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);return j}}return C},selectNodeContents:function(u){this.setStart(u,0);this.setEnd(u,u[0].nodeType==e.NODE_TEXT?u[0].nodeValue.length:u[0].childNodes.length)}});
var m={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},A=new g.whitespaces,E=new g.bookmark;l.Range=p;l.Range=p;var D=p.prototype;l.Utils.extern(D,{updateCollapsed:D.updateCollapsed,optimize:D.optimize,setStartAfter:D.setStartAfter,setEndAfter:D.setEndAfter,setStartBefore:D.setStartBefore,setEndBefore:D.setEndBefore,optimizeBookmark:D.optimizeBookmark,setStart:D.setStart,setEnd:D.setEnd,
setStartAt:D.setStartAt,setEndAt:D.setEndAt,execContentsAction:D.execContentsAction,collapse:D.collapse,clone:D.clone,getEnclosedNode:D.getEnclosedNode,shrink:D.shrink,getTouchedStartNode:D.getTouchedStartNode,createBookmark2:D.createBookmark2,createBookmark:D.createBookmark,moveToPosition:D.moveToPosition,trim:D.trim,insertNode:D.insertNode,moveToBookmark:D.moveToBookmark,getCommonAncestor:D.getCommonAncestor,enlarge:D.enlarge,checkStartOfBlock:D.checkStartOfBlock,checkEndOfBlock:D.checkEndOfBlock,
deleteContents:D.deleteContents,extractContents:D.extractContents,checkBoundaryOfElement:D.checkBoundaryOfElement,getBoundaryNodes:D.getBoundaryNodes,fixBlock:D.fixBlock,splitBlock:D.splitBlock,splitElement:D.splitElement,moveToElementEditablePosition:D.moveToElementEditablePosition,selectNodeContents:D.selectNodeContents})});
KISSY.Editor.add("domiterator",function(l){function p(g){if(!(arguments.length<1)){this.range=g;this.forceBrBreak=x;this.enlargeBr=v;this.enforceRealBlocks=x;this._||(this._={})}}var v=true,x=false,w=KISSY,s=w.UA,n=l.Walker,j=l.Range,k=l.RANGE,c=l.NODE,f=l.ElementPath,e=w.Node,h=w.DOM,q=/^[\r\n\t ]*$/;w.augment(p,{getNextParagraph:function(g){var b,d,i,o,y;if(!this._.lastNode){d=this.range.clone();d.shrink(k.SHRINK_ELEMENT,v);d.enlarge(this.forceBrBreak||!this.enlargeBr?k.ENLARGE_LIST_ITEM_CONTENTS:
k.ENLARGE_BLOCK_CONTENTS);var t=new n(d),r=n.bookmark(v,v);t.evaluator=r;this._.nextNode=t.next();t=new n(d);t.evaluator=r;t=t.previous();this._.lastNode=t._4e_nextSourceNode(v);if(this._.lastNode&&this._.lastNode[0].nodeType==c.NODE_TEXT&&!w.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){r=new j(d.document);r.moveToPosition(this._.lastNode,k.POSITION_AFTER_END);if(r.checkEndOfBlock()){r=new f(r.endContainer);this._.lastNode=(r.block||r.blockLimit)._4e_nextSourceNode(v)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new e(d.document.createTextNode(""));h.insertAfter(this._.lastNode[0],t[0])}d=null}r=this._.nextNode;t=this._.lastNode;for(this._.nextNode=null;r;){var m=x,A=r[0].nodeType!=c.NODE_ELEMENT,E=x;if(A){if(r[0].nodeType==c.NODE_TEXT)if(q.test(r[0].nodeValue))A=x}else{var D=r._4e_name();if(r._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(D=="br")A=v;else if(!d&&!r[0].childNodes.length&&D!="hr"){b=r;i=r._4e_equals(t);break}if(d){d.setEndAt(r,k.POSITION_BEFORE_START);if(D!="br")this._.nextNode=
r}m=v}else{if(r[0].firstChild){if(!d){d=new j(this.range.document);d.setStartAt(r,k.POSITION_BEFORE_START)}r=new e(r[0].firstChild);continue}A=v}}if(A&&!d){d=new j(this.range.document);d.setStartAt(r,k.POSITION_BEFORE_START)}i=(!m||A)&&r._4e_equals(t);if(d&&!m)for(;!r[0].nextSibling&&!i;){D=r.parent();if(D._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){m=v;i||D._4e_equals(t);break}r=D;A=v;i=r._4e_equals(t);E=v}A&&d.setEndAt(r,k.POSITION_AFTER_END);r=r._4e_nextSourceNode(E,null,t);if((i=!r)||m&&d)break}if(!b){if(!d){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}b=new f(d.startContainer);r=b.blockLimit;m={div:1,th:1,td:1};b=b.block;if((!b||!b[0])&&!this.enforceRealBlocks&&m[r._4e_name()]&&d.checkStartOfBlock()&&d.checkEndOfBlock())b=r;else if(!b||this.enforceRealBlocks&&b._4e_name()=="li"){b=new e(this.range.document.createElement(g||"p"));b[0].appendChild(d.extractContents());b._4e_trim();d.insertNode(b);o=y=v}else if(b._4e_name()!="li"){if(!d.checkStartOfBlock()||!d.checkEndOfBlock()){b=b._4e_clone(x);
b[0].appendChild(d.extractContents());b._4e_trim();y=d.splitBlock();o=!y.wasStartOfBlock;y=!y.wasEndOfBlock;d.insertNode(b)}}else if(!i)this._.nextNode=b._4e_equals(t)?null:d.getBoundaryNodes().endNode._4e_nextSourceNode(v,null,t)}if(o){d=new e(b[0].previousSibling);if(d[0]&&d[0].nodeType==c.NODE_ELEMENT)if(d._4e_name()=="br")d._4e_remove();else d[0].lastChild&&h._4e_name(d[0].lastChild)=="br"&&h._4e_remove(d[0].lastChild)}if(y){d=n.bookmark(x,v);o=new e(b[0].lastChild);if(o[0]&&o[0].nodeType==c.NODE_ELEMENT&&
o._4e_name()=="br")if(s.ie||o._4e_previous(d)||o._4e_next(d))o._4e_remove()}if(!this._.nextNode)this._.nextNode=i||b._4e_equals(t)?null:b._4e_nextSourceNode(v,null,t);return b}});j.prototype.createIterator=function(){return new p(this)}});
KISSY.Editor.add("selection",function(l){function p(r){this.document=this.document=r;this._={cache:{}};if(k.ie){var m=this.getNative().createRange();if(!m||m.item&&m.item(0).ownerDocument!=r||m.parentElement&&m.parentElement().ownerDocument!=r)this.isInvalid=w}}function v(r){r=new p(r);return!r||r.isInvalid?n:r}function x(r){var m=r.document,A=new e(m.body),E=new e(m.documentElement);if(k.ie){if(k.ie<8||document.documentMode==7)E.on("click",function(N){(new e(N.target))._4e_name()==="html"&&r.getSelection().getRanges()[0].select()});
var D,u,z=1;E.on("mousedown",function(){z=0});E.on("mouseup",function(){z=1});A.on("focusin",function(N){if((new e(N.target))._4e_name()=="body")if(D){try{z&&D.select()}catch(Q){}D=n}});A.on("focus",function(){u=w;F()});A.on("beforedeactivate",function(N){if(!N.relatedTarget){u=s;z=1}});f.on(c._4e_getWin(m),"blur",function(){m&&m.selection.empty()});A.on("mousedown",function(){C()});A.on("mouseup",function(){u=w;setTimeout(function(){F(w)},0)});var C=function(){u=s},F=function(N){if(u){var Q=r.document,
R=r.getSelection(),V=R&&R.getType(),T=R&&R.getNative();if(N&&T&&V==h.SELECTION_NONE)if(!Q.queryCommandEnabled("InsertImage")){setTimeout(function(){F(w)},50);return}var U;if(!(T&&V==h.SELECTION_TEXT&&(U=c._4e_name(T.createRange().parentElement()))&&U in{input:1,textarea:1})){D=T&&R.getRanges()[0];r._monitor()}}};A.on("keydown",C);A.on("keyup",function(){u=w;F()});f.on(m,"selectionchange",F)}else{f.on(m,"mouseup",r._monitor,r);f.on(m,"keyup",r._monitor,r)}var B={table:1,pre:1},G=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
M=l.Walker.whitespaces(w);r.on("selectionChange",function(N){var Q=N.path;N=(N=N.selection)&&N.getRanges()[0];if(!(!N||!N.collapsed||Q.block))if(Q.blockLimit._4e_name()=="body"){Q=N.fixBlock(w,"p");if(Q._4e_outerHtml().match(G)){var R=Q._4e_next(M);if(R&&R[0].nodeType==g.NODE_ELEMENT&&!B[R._4e_name()]){N.moveToElementEditablePosition(R);Q._4e_remove()}else if((R=Q._4e_previous(M))&&R[0].nodeType==g.NODE_ELEMENT&&!B[R._4e_name()]){N.moveToElementEditablePosition(R,R._4e_outerHtml().match(G)?s:w);Q._4e_remove()}}N.select();
k.ie||r.notifySelectionChange()}})}l.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var w=true,s=false,n=null,j=KISSY,k=j.UA,c=j.DOM,f=j.Event,e=j.Node,h=l.SELECTION,q=l.RANGE,g=l.NODE,b=l.Walker,d=l.Range,i={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};j.augment(p,{getNative:k.ie?function(){var r=this._.cache;return r.nativeSel||(r.nativeSel=this.document.selection)}:function(){var r=
this._.cache;return r.nativeSel||(r.nativeSel=c._4e_getWin(this.document).getSelection())},getType:k.ie?function(){var r=this._.cache;if(r.type)return r.type;var m=h.SELECTION_NONE;try{var A=this.getNative(),E=A.type;if(E=="Text")m=h.SELECTION_TEXT;if(E=="Control")m=h.SELECTION_ELEMENT;if(A.createRange().parentElement)m=h.SELECTION_TEXT}catch(D){}return r.type=m}:function(){var r=this._.cache;if(r.type)return r.type;var m=h.SELECTION_TEXT,A=this.getNative();if(A){if(A.rangeCount==1){A=A.getRangeAt(0);
var E=A.startContainer;if(E==A.endContainer&&E.nodeType==g.NODE_ELEMENT&&A.endOffset-A.startOffset===1&&i[E.childNodes[A.startOffset].nodeName.toLowerCase()])m=h.SELECTION_ELEMENT}}else m=h.SELECTION_NONE;return r.type=m},getRanges:k.ie?function(){var r=function(m,A){m=m.duplicate();m.collapse(A);for(var E=m.parentElement(),D=E.childNodes,u,z=0;z<D.length;z++){var C=D[z];if(C.nodeType==g.NODE_ELEMENT){u=m.duplicate();u.moveToElementText(C);C=u.compareEndPoints("StartToStart",m);var F=u.compareEndPoints("EndToStart",
m);u.collapse();if(C>0)break;else if(!C||F==1&&C==-1)return{container:E,offset:z};else if(!F)return{container:E,offset:z+1};u=n}}if(!u){u=m.duplicate();u.moveToElementText(E);u.collapse(s)}u.setEndPoint("StartToStart",m);u=u.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;u>0;)u-=D[--z].nodeValue.length}catch(B){u=0}return u===0?{container:E,offset:z}:{container:D[z],offset:-u}};return function(){var m=this._.cache;if(m.ranges)return m.ranges;var A=this.getNative(),E=A&&A.createRange(),D=this.getType();
if(!A)return[];if(D==h.SELECTION_TEXT){A=new d(this.document);D=r(E,w);A.setStart(new e(D.container),D.offset);D=r(E);A.setEnd(new e(D.container),D.offset);return m.ranges=[A]}else if(D==h.SELECTION_ELEMENT){m=m.ranges=[];for(D=0;D<E.length;D++){var u=E.item(D),z=u.parentNode,C=0;for(A=new d(this.document);C<z.childNodes.length&&z.childNodes[C]!=u;C++);A.setStart(new e(z),C);A.setEnd(new e(z),C+1);m.push(A)}return m}return m.ranges=[]}}():function(){var r=this._.cache;if(r.ranges)return r.ranges;
var m=[],A=this.getNative();if(!A)return[];for(var E=0;E<A.rangeCount;E++){var D=A.getRangeAt(E),u=new d(this.document);u.setStart(new e(D.startContainer),D.startOffset);u.setEnd(new e(D.endContainer),D.endOffset);m.push(u)}return r.ranges=m},getStartElement:function(){var r=this._.cache;if(r.startElement!==undefined)return r.startElement;var m,A=this.getNative();switch(this.getType()){case h.SELECTION_ELEMENT:return this.getSelectedElement();case h.SELECTION_TEXT:var E=this.getRanges()[0];if(E)if(!E.collapsed){for(E.optimize();w;){m=
E.startContainer;if(E.startOffset==(m[0].nodeType===g.NODE_ELEMENT?m[0].childNodes.length:m[0].nodeValue.length)&&!m._4e_isBlockBoundary())E.setStartAfter(m);else break}m=E.startContainer;if(m[0].nodeType!=g.NODE_ELEMENT)return m.parent();m=new e(m[0].childNodes[E.startOffset]);if(!m[0]||m[0].nodeType!=g.NODE_ELEMENT)return E.startContainer;for(E=m[0].firstChild;E&&E.nodeType==g.NODE_ELEMENT;){m=new e(E);E=E.firstChild}return m}if(k.ie){E=A.createRange();E.collapse(w);m=E.parentElement()}else if((m=
A.anchorNode)&&m.nodeType!=g.NODE_ELEMENT)m=m.parentNode}return r.startElement=m?c._4e_wrap(m):n},getSelectedElement:function(){var r=this,m,A=r._.cache;if(A.selectedElement!==undefined)return A.selectedElement;if(k.ie){m=r.getNative().createRange();m=m.item&&m.item(0)}m||(m=function(){for(var E=r.getRanges()[0],D,u,z=2;z&&!((D=E.getEnclosedNode())&&D[0].nodeType==g.NODE_ELEMENT&&i[D._4e_name()]&&(u=D));z--)E.shrink(q.SHRINK_ELEMENT);return u&&u[0]}());return A.selectedElement=c._4e_wrap(m)},reset:function(){this._.cache=
{}},selectElement:function(r){var m;if(k.ie)try{m=this.document.body.createControlRange();m.addElement(r[0]);m.select()}catch(A){m=this.document.body.createTextRange();m.moveToElementText(r[0]);m.select()}finally{}else{m=this.document.createRange();m.selectNode(r[0]);r=this.getNative();r.removeAllRanges();r.addRange(m)}this.reset()},selectRanges:function(r){if(k.ie){if(r.length>1){var m=r[r.length-1];r[0].setEnd(m.endContainer,m.endOffset);r.length=1}r[0]&&r[0].select()}else{m=this.getNative();if(!m)return;
m.removeAllRanges();for(var A=0;A<r.length;A++){var E=r[A],D=this.document.createRange(),u=E.startContainer;E.collapsed&&k.gecko&&k.gecko<1.09&&u[0].nodeType==g.NODE_ELEMENT&&!u[0].childNodes.length&&u[0].appendChild(this.document.createTextNode(""));D.setStart(u[0],E.startOffset);D.setEnd(E.endContainer[0],E.endOffset);m.addRange(D)}}this.reset()},createBookmarks2:function(r){for(var m=[],A=this.getRanges(),E=0;E<A.length;E++)m.push(A[E].createBookmark2(r));return m},createBookmarks:function(r,m){var A=
[],E=this.document,D;m=m||this.getRanges();for(var u=m.length,z=0;z<u;z++){A.push(D=m[z].createBookmark(r,w));var C=(r=D.serializable)?j.one("#"+D.startNode,E):D.startNode;D=r?j.one("#"+D.endNode,E):D.endNode;for(var F=z+1;F<u;F++){var B=m[F],G=B.startContainer,M=B.endContainer;c._4e_equals(G,C.parent())&&B.startOffset++;c._4e_equals(G,D.parent())&&B.startOffset++;c._4e_equals(M,C.parent())&&B.endOffset++;c._4e_equals(M,D.parent())&&B.endOffset++}}return A},selectBookmarks:function(r){for(var m=[],
A=0;A<r.length;A++){var E=new d(this.document);E.moveToBookmark(r[A]);m.push(E)}this.selectRanges(m);return this},getCommonAncestor:function(){var r=this.getRanges();return r[0].startContainer._4e_commonAncestor(r[r.length-1].endContainer)},scrollIntoView:function(){var r=this.getStartElement();r&&r._4e_scrollIntoView()},removeAllRanges:function(){var r=this.getNative();if(k.ie)r&&r.clear();else r&&r.removeAllRanges()}});var o={table:1,tbody:1,tr:1},y=b.whitespaces(w),t=/\ufeff|\u00a0/;d.prototype.select=
d.prototype.select=k.ie?function(r){var m=this.collapsed,A,E;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var D=this.startContainer[0].childNodes[this.startOffset];if(D.nodeType==g.NODE_ELEMENT){(new p(this.document)).selectElement(new e(D));return}}if(this.startContainer[0].nodeType==g.NODE_ELEMENT&&this.startContainer._4e_name()in o||this.endContainer[0].nodeType==g.NODE_ELEMENT&&this.endContainer._4e_name()in o)this.shrink(q.SHRINK_ELEMENT,w);var u=this.createBookmark();
D=u.startNode;var z;if(!m)z=u.endNode;u=this.document.body.createTextRange();u.moveToElementText(D[0]);u.moveStart("character",1);if(z){r=this.document.body.createTextRange();r.moveToElementText(z[0]);u.setEndPoint("EndToEnd",r);u.moveEnd("character",-1)}else{for(A=D[0].nextSibling;A&&!y(A);)A=A.nextSibling;A=!(A&&A.nodeValue&&A.nodeValue.match(t))&&(r||!D[0].previousSibling||D[0].previousSibling&&c._4e_name(D[0].previousSibling)=="br");E=this.document.createElement("span");E.innerHTML="&#65279;";
E=(new e(E)).insertBefore(D);A&&c.insertBefore(this.document.createTextNode("\ufeff"),D)}this.setStartBefore(D);D._4e_remove();if(m){if(A){u.moveStart("character",-1);u.select();this.document.selection.clear()}else u.select();if(E){this.moveToPosition(E,q.POSITION_BEFORE_START);E._4e_remove()}}else{this.setEndBefore(z);z._4e_remove();u.select()}}:function(){var r=this.startContainer;this.collapsed&&r[0].nodeType==g.NODE_ELEMENT&&!r[0].childNodes.length&&r[0].appendChild(this.document.createTextNode(""));
var m=this.document.createRange();m.setStart(r[0],this.startOffset);try{m.setEnd(this.endContainer[0],this.endOffset)}catch(A){if(A.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(w);m.setEnd(this.endContainer[0],this.endOffset)}else throw A;}r=v(this.document).getNative();r.removeAllRanges();r.addRange(m)};p.getSelection=v;l.Selection=p;l.Selection=p;b=p.prototype;l.Utils.extern(b,{getNative:b.getNative,getType:b.getType,getRanges:b.getRanges,getStartElement:b.getStartElement,getSelectedElement:b.getSelectedElement,
reset:b.reset,selectElement:b.selectElement,selectRanges:b.selectRanges,createBookmarks2:b.createBookmarks2,createBookmarks:b.createBookmarks,getCommonAncestor:b.getCommonAncestor,scrollIntoView:b.scrollIntoView,selectBookmarks:b.selectBookmarks,removeAllRanges:b.removeAllRanges});l.on("instanceCreated",function(r){x(r.editor)})});
KISSY.Editor.add("styles",function(l){function p(H,L){for(var J in H)H[J]=H[J].replace(U,function(I,K){return L[K]})}function v(H,L){if(L){H=A.clone(H);p(H.attributes,L);p(H.styles,L)}var J=this.element=this.element=(H.element||"*").toLowerCase();this.type=this.type=J=="#"||R[J]?u.STYLE_BLOCK:V[J]?u.STYLE_OBJECT:u.STYLE_INLINE;this._={definition:H}}function x(H,L){var J=L?this.removeFromRange:this.applyToRange;H.body.focus();for(var I=new C(H),K=I.getRanges(),P=0;P<K.length;P++)J.call(this,K[P]);
I.selectRanges(K)}function w(H,L){var J;J=H.element;if(J=="*")J="span";J=new M(L.createElement(J));return s(J,H)}function s(H,L){var J=L._.definition,I=J.attributes;J=v.getStyleText(J);if(I)for(var K in I)H.attr(K,I[K]);if(J)H[0].style.cssText=J;return H}function n(H){var L=H.createBookmark(t),J=H.createIterator();J.enforceRealBlocks=t;J.enlargeBr=t;for(var I,K=H.document;I=J.getNextParagraph();){var P=w(this,K);I=I;var O=P;P=O._4e_name=="pre";var S=I._4e_name=="pre",$=!P&&S;if(P&&!S){S=I;O=O;$=S.html();
$=j($,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");$=$.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");$=$.replace(/([ \t\n\r]+|&nbsp;)/g," ");$=$.replace(/<br\b[^>]*>/gi,"\n");if(N.ie){S=S[0].ownerDocument.createElement("div");S.appendChild(O[0]);O[0].outerHTML="<pre>"+$+"</pre>";O=new M(S.firstChild);O._4e_remove()}else O.html($);O=O}else if($)O=c(k(I),O);else I._4e_moveChildren(O);I[0].parentNode.replaceChild(O[0],I[0]);if(P){I=O;P=void 0;if((P=I._4e_previousSourceNode(t,F.NODE_ELEMENT))&&P._4e_name()==
"pre"){O=j(P.html(),/\n$/,"")+"\n\n"+j(I.html(),/^\n/,"");if(N.ie)I[0].outerHTML="<pre>"+O+"</pre>";else I.html(O);P._4e_remove()}}}H.moveToBookmark(L)}function j(H,L,J){var I="",K="";H=H.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(P,O,S){O&&(I=O);S&&(K=S);return""});return I+H.replace(L,J)+K}function k(H){var L=[];j(H._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(J,I,K){return I+"</pre>"+K+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(J,I){L.push(I)});return L}function c(H,L){for(var J=L[0].ownerDocument.createDocumentFragment(),I=0;I<H.length;I++){var K=H[I];K=K.replace(/(\r\n|\r)/g,"\n");K=j(K,/^[ \t]*\n/,"");K=j(K,/\n$/,"");K=j(K,/^[ \t]+|[ \t]+$/g,function(O,S){return O.length==1?"&nbsp;":S?" "+Array(O.length).join("&nbsp;"):Array(O.length).join("&nbsp;")+" "});K=K.replace(/\n/g,"<br>");K=K.replace(/[ \t]{2,}/g,function(O){return Array(O.length).join("&nbsp;")+" "});var P=L._4e_clone();P.html(K);J.appendChild(P[0])}return J}
function f(H){var L=H.document;if(H.collapsed){L=w(this,L);H.insertNode(L);H.moveToPosition(L,z.POSITION_BEFORE_END)}else{var J=this.element,I=this._.definition,K,P=l.XHTML_DTD[J]||(K=t,l.XHTML_DTD.span),O=H.createBookmark();H.enlarge(z.ENLARGE_ELEMENT);H.trim();var S=H.createBookmark(),$=S.startNode;S=S.endNode;for(var Y=$,aa;Y&&Y[0];){var X=r;if(D._4e_equals(Y,S)){Y=m;X=t}else{var Z=Y[0].nodeType,da=Z==F.NODE_ELEMENT?Y._4e_name():m;if(da&&Y.attr("_ke_bookmark")){Y=Y._4e_nextSourceNode(t);continue}if(!da||
P[da]&&(Y._4e_position(S)|B.POSITION_PRECEDING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_PRECEDING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(Y))){var ea=Y.parent();if(ea&&ea[0]&&((l.XHTML_DTD[ea._4e_name()]||l.XHTML_DTD.span)[J]||K)&&(!I.parentRule||I.parentRule(ea))){if(!aa&&(!da||!l.XHTML_DTD.$removeEmpty[da]||(Y._4e_position(S)|B.POSITION_PRECEDING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_PRECEDING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED)){aa=
new G(L);aa.setStartBefore(Y)}if(Z==F.NODE_TEXT||Z==F.NODE_ELEMENT&&!Y[0].childNodes.length){Z=Y;var ba;for(da=Z._4e_next(function(ga){return!ga.attr("_ke_bookmark")});!da&&(ba=Z.parent(),P[ba._4e_name()])&&(ba._4e_position($)|B.POSITION_FOLLOWING|B.POSITION_IDENTICAL|B.POSITION_IS_CONTAINED)==B.POSITION_FOLLOWING+B.POSITION_IDENTICAL+B.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(ba));)Z=ba;aa.setEndAfter(Z);Z[0].nextSibling||(X=t)}}else X=t}else X=t;Y=Y._4e_nextSourceNode()}if(X&&aa&&!aa.collapsed){X=
w(this,L);for(Z=aa.getCommonAncestor();X&&Z&&X[0]&&Z[0];){if(Z._4e_name()==J){for(var ca in I.attributes)X.attr(ca)==Z.attr(ca)&&X[0].removeAttribute(ca);for(var fa in I.styles)X._4e_style(fa)==Z._4e_style(fa)&&X._4e_style(fa,"");if(!X._4e_hasAttributes()){X=m;break}}Z=Z.parent()}if(X){X[0].appendChild(aa.extractContents());i(this,X);aa.insertNode(X);X._4e_mergeSiblings();N.ie||X[0].normalize()}aa=m}}$._4e_remove();S._4e_remove();H.moveToBookmark(O);H.shrink(z.SHRINK_TEXT)}}function e(H){H.enlarge(z.ENLARGE_ELEMENT);
var L=H.createBookmark(),J=L.startNode;if(H.collapsed){for(var I=new Q(J.parent()),K,P=0,O;P<I.elements.length&&(O=I.elements[P]);P++){if(O==I.block||O==I.blockLimit)break;if(this.checkElementRemovable(O)){var S=H.checkBoundaryOfElement(O,z.END),$=!S&&H.checkBoundaryOfElement(O,z.START);if($||S){K=O;K.match=$?"start":"end"}else{O._4e_mergeSiblings();O._4e_name()==this.element?b(this,O):o(O,g(this)[O._4e_name()])}}}if(K&&K[0]){O=J;for(P=0;;P++){S=I.elements[P];if(D._4e_equals(S,K))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(O[0]);O=S}D[K.match=="start"?"insertBefore":"insertAfter"](O,K)}}else{var Y=L.endNode,aa=this;I=function(){for(var X=new Q(J.parent()),Z=new Q(Y.parent()),da=m,ea=m,ba=0;ba<X.elements.length;ba++){var ca=X.elements[ba];if(ca==X.block||ca==X.blockLimit)break;if(aa.checkElementRemovable(ca))da=ca}for(ba=0;ba<Z.elements.length;ba++){ca=Z.elements[ba];if(ca==Z.block||ca==Z.blockLimit)break;if(aa.checkElementRemovable(ca))ea=ca}ea&&Y._4e_breakParent(ea);da&&J._4e_breakParent(da)};
I();for(K=new M(J[0].nextSibling);K[0]!==Y[0];){P=K._4e_nextSourceNode();if(K[0]&&K[0].nodeType==F.NODE_ELEMENT&&this.checkElementRemovable(K)){K._4e_name()==this.element?b(this,K):o(K,g(this)[K._4e_name()]);if(P[0].nodeType==F.NODE_ELEMENT&&P.contains(J)){I();P=new M(J[0].nextSibling)}}K=P}}H.moveToBookmark(L)}function h(H){var L={};H.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(J,I,K){L[I]=K});return L}function q(H,L){var J;if(L!==r){J=document.createElement("span");
J.style.cssText=H;J=J.style.cssText||""}else J=H;return J.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function g(H){if(H._.overrides)return H._.overrides;var L=H._.overrides={},J=H._.definition.overrides;if(J){A.isArray(J)||(J=[J]);for(var I=0;I<J.length;I++){var K=J[I],P,O;if(typeof K=="string")P=K.toLowerCase();else{P=K.element?K.element.toLowerCase():H.element;O=K.attributes}K=L[P]||(L[P]={});if(O){K=K.attributes=K.attributes||[];for(var S in O)K.push([S.toLowerCase(),
O[S]])}}}return L}function b(H,L){var J=H._.definition,I=E.mix(J.attributes,g(H)[L._4e_name()]);J=J.styles;var K=A.isEmptyObject(I)&&A.isEmptyObject(J),P;for(P in I)if(!((P=="class"||H._.definition.fullMatch)&&L.attr(P)!=d(P,I[P]))){K=K||!!L._4e_hasAttribute(P);L.removeAttr(P)}for(var O in J)if(!(H._.definition.fullMatch&&L._4e_style(O)!=d(O,J[O],t))){K=K||!!L._4e_style(O);L._4e_style(O,"")}y(L)}function d(H,L,J){var I=new M("<span>");I[J?"_4e_style":"attr"](H,L);return I[J?"_4e_style":"attr"](H)}
function i(H,L){for(var J=g(H),I=L.all(H.element),K=I.length;--K>=0;)b(H,new M(I[K]));for(var P in J)if(P!=H.element){I=L.all(P);for(K=I.length-1;K>=0;K--){var O=new M(I[K]);o(O,J[P])}}}function o(H,L){var J=L&&L.attributes;if(J)for(var I=0;I<J.length;I++){var K=J[I][0],P;if(P=H.attr(K)){var O=J[I][1];if(O===m||O.test&&O.test(P)||typeof O=="string"&&P==O)H[0].removeAttribute(K)}}y(H)}function y(H){if(!H._4e_hasAttributes()){var L=H[0].firstChild,J=H[0].lastChild;H._4e_remove(t);if(L){L.nodeType==
F.NODE_ELEMENT&&D._4e_mergeSiblings(L);J&&L!=J&&J.nodeType==F.NODE_ELEMENT&&D._4e_mergeSiblings(J)}}}var t=true,r=false,m=null,A=KISSY,E=l.Utils,D=A.DOM,u={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},z=l.RANGE,C=l.Selection,F=l.NODE,B=l.POSITION,G=l.Range,M=A.Node,N=A.UA,Q=l.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},V={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},T=/\s*(?:;\s*|$)/g,U=/#\((.+?)\)/g;l.STYLE=u;v.prototype={apply:function(H){x.call(this,
H,r)},remove:function(H){x.call(this,H,t)},applyToRange:function(H){return(this.applyToRange=this.type==u.STYLE_INLINE?f:this.type==u.STYLE_BLOCK?n:this.type==u.STYLE_OBJECT?m:m).call(this,H)},removeFromRange:function(H){return(this.removeFromRange=this.type==u.STYLE_INLINE?e:m).call(this,H)},applyToObject:function(H){s(H,this)},checkElementRemovable:function(H,L){if(!H)return r;var J=this._.definition;if(H._4e_name()==this.element){if(!L&&!H._4e_hasAttributes())return t;var I=J._AC;if(I)J=I;else{I=
{};var K=0,P=J.attributes;if(P)for(var O in P){K++;I[O]=P[O]}if(P=v.getStyleText(J)){I.style||K++;I.style=P}I._length=K;J=J._AC=I}if(J._length){for(var S in J)if(S!="_length"){K=H.attr(S)||"";if(S=="style")a:{I=J[S];K=q(K,r);typeof I=="string"&&(I=h(I));typeof K=="string"&&(K=h(K));P=void 0;for(P in I)if(!(P in K&&(K[P]==I[P]||I[P]=="inherit"||K[P]=="inherit"))){I=r;break a}I=t}else I=J[S]==K;if(I){if(!L)return t}else if(L)return r}if(L)return t}else return t}if(S=g(this)[H._4e_name()]){if(!(J=S.attributes))return t;
for(I=0;I<J.length;I++){S=J[I][0];if(S=H.attr(S)){K=J[I][1];if(K===m||typeof K=="string"&&S==K||K.test&&K.test(S))return t}}}return r},checkActive:function(H){switch(this.type){case u.STYLE_BLOCK:return this.checkElementRemovable(H.block||H.blockLimit,t);case u.STYLE_OBJECT:case u.STYLE_INLINE:for(var L=H.elements,J=0,I;J<L.length;J++){I=L[J];if(!(this.type==u.STYLE_INLINE&&(D._4e_equals(I,H.block)||D._4e_equals(I,H.blockLimit))))if(!(this.type==u.STYLE_OBJECT&&!(I._4e_name()in V)))if(this.checkElementRemovable(I,
t))return t}}return r}};v.getStyleText=function(H){var L=H._ST;if(L)return L;L=H.styles;var J=H.attributes&&H.attributes.style||"",I="";if(J.length)J=J.replace(T,";");for(var K in L){var P=L[K],O=(K+":"+P).replace(T,";");if(P=="inherit")I+=O;else J+=O}if(J.length)J=q(J);J+=I;return H._ST=J};l.Style=v;l.Style=v;var W=v.prototype;l.Utils.extern(W,{apply:W.apply,remove:W.remove,applyToRange:W.applyToRange,removeFromRange:W.removeFromRange,applyToObject:W.applyToObject,checkElementRemovable:W.checkElementRemovable,
checkActive:W.checkActive})});
KISSY.Editor.add("htmlparser",function(){function l(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var p=KISSY,v=function(){},x=p.Editor,w=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,s={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},n=x.XHTML_DTD;p.augment(l,{onTagOpen:v,onTagClose:v,
onText:v,onCDATA:v,onComment:v,parse:function(j){for(var k,c,f=0,e;k=this._.htmlPartsRegex.exec(j);){c=k.index;if(c>f){f=j.substring(f,c);e?e.push(f):this.onText(f)}f=this._.htmlPartsRegex.lastIndex;if(c=k[1]){c=c.toLowerCase();if(e&&n.$cdata[c]){this.onCDATA(e.join(""));e=null}if(!e){this.onTagClose(c);continue}}if(e)e.push(k[0]);else if(c=k[3]){c=c.toLowerCase();if(!/="/.test(c)){var h={},q;k=k[4];var g=!!(k&&k.charAt(k.length-1)=="/");if(k)for(;q=w.exec(k);){var b=q[1].toLowerCase();q=q[2]||q[3]||
q[4]||"";h[b]=!q&&s[b]?b:q}this.onTagOpen(c,h,g);if(!e&&n.$cdata[c])e=[]}}else if(c=k[2])this.onComment(c)}j.length>f&&this.onText(j.substring(f,j.length))}});x.HtmlParser=l;x.HtmlParser=l});
KISSY.Editor.add("htmlparser-basicwriter",function(){function l(){this._={output:[]}}var p=KISSY,v=p.Editor,x=v.Utils;p.augment(l,{openTag:function(w){this._.output.push("<",w)},openTagClose:function(w,s){s?this._.output.push(" />"):this._.output.push(">")},attribute:function(w,s){if(typeof s=="string")s=x.htmlEncodeAttr(s);this._.output.push(" ",w,'="',s,'"')},closeTag:function(w){this._.output.push("</",w,">")},text:function(w){this._.output.push(w)},comment:function(w){this._.output.push("<!--",
w,"--\>")},write:function(w){this._.output.push(w)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(w){var s=this._.output.join("");w&&this.reset();return s}});v.HtmlParser.BasicWriter=l;v.HtmlParser.BasicWriter=l;p=l.prototype;v.Utils.extern(p,{openTag:p.openTag,openTagClose:p.openTagClose,attribute:p.attribute,closeTag:p.closeTag,text:p.text,comment:p.comment,write:p.write,reset:p.reset,getHtml:p.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function l(){l.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=s;this.sortAttributes=w;this._.indent=s;this._.indentation="";this._.rules={};var n=v.XHTML_DTD,j;for(j in x.mix({},n.$nonBodyContent,n.$block,n.$listItem,n.$tableContent))this.setRules(j,{indent:w,breakBeforeOpen:w,breakAfterOpen:w,breakBeforeClose:!n[j]["#"],breakAfterClose:w});this.setRules("br",
{breakAfterOpen:w});this.setRules("title",{indent:s,breakAfterOpen:s});this.setRules("style",{indent:s,breakBeforeClose:w});this.setRules("pre",{indent:s})}var p=KISSY,v=p.Editor,x=v.Utils,w=true,s=false;p.extend(l,v.HtmlParser.BasicWriter,{openTag:function(n){var j=this._.rules[n];if(this._.indent)this.indentation();else if(j&&j.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",n)},openTagClose:function(n,j){var k=this._.rules[n];if(j)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(k&&k.indent)this._.indentation+=this.indentationChars}k&&k.breakAfterOpen&&this.lineBreak()},attribute:function(n,j){if(typeof j=="string"){this.forceSimpleAmpersand&&(j=j.replace(/&amp;/g,"&"));j=x.htmlEncodeAttr(j)}this._.output.push(" ",n,'="',j,'"')},closeTag:function(n){var j=this._.rules[n];if(j&&j.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(j&&j.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",n,">");j&&j.breakAfterClose&&this.lineBreak()},text:function(n){if(this._.indent){this.indentation();n=x.ltrim(n)}this._.output.push(n)},comment:function(n){this._.indent&&this.indentation();this._.output.push("<!--",n,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=w},indentation:function(){this._.output.push(this._.indentation);this._.indent=s},setRules:function(n,j){var k=this._.rules[n];if(k)x.mix(k,
j);else this._.rules[n]=j}});v.HtmlParser.HtmlWriter=l;v.HtmlParser.HtmlWriter=l;p=l.prototype;v.Utils.extern(p,{openTag:p.openTag,openTagClose:p.openTagClose,attribute:p.attribute,closeTag:p.closeTag,text:p.text,comment:p.comment,lineBreak:p.lineBreak,indentation:p.indentation,setRules:p.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function l(){this.children=[];this.parent=x;this._={isBlockLike:p,hasInlineStarted:v}}var p=true,v=false,x=null,w=KISSY.Editor,s={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},n=KISSY,j=w.Utils,k=w.NODE,c=w.XHTML_DTD,f=j.mix({table:1,ul:1,ol:1,dl:1},c.table,c.ul,c.ol,c.dl),e=c.$list,h=c.$listItem;l.FromHtml=function(q,g){function b(z){var C;if(t.length>0)for(var F=0;F<t.length;F++){var B=t[F],G=B.name,M=c[G],N=m.name&&c[m.name];
if((!N||N[G])&&(!z||!M||M[z]||!c[z])){if(!C){d();C=1}B=B.clone();B.parent=m;m=B;t.splice(F,1);F--}}}function d(){for(;r.length;)m.add(r.shift())}function i(z,C,F){C=C||m||y;if(g&&!C.type){var B,G;if((B=z.attributes&&(G=z.attributes._ke_real_element_type)?G:z.name)&&!(B in c.$body)&&!(B in c.$nonBodyContent)){B=m;m=C;o.onTagOpen(g,{});C=m;if(F)m=B}}if(z._.isBlockLike&&z.name!="pre"){F=z.children.length;if((B=z.children[F-1])&&B.type==k.NODE_TEXT)if(G=j.rtrim(B.value))B.value=G;else z.children.length=
F-1}C.add(z);if(z.returnPoint){m=z.returnPoint;delete z.returnPoint}}var o=new w.HtmlParser,y=new l,t=[],r=[],m=y,A=v,E;o.onTagOpen=function(z,C,F){var B=new w.HtmlParser.Element(z,C);if(B.isUnknown&&F)B.isEmpty=p;if(c.$removeEmpty[z])t.push(B);else{if(z=="pre")A=p;else if(z=="br"&&A){m.add(new w.HtmlParser.Text("\n"));return}if(z=="br")r.push(B);else{var G=m.name,M=G&&(c[G]||(m._.isBlockLike?c.div:c.span));if(M&&!B.isUnknown&&!m.isUnknown&&!M[z]){M=v;var N;if(z in e&&G in e){G=m.children;(G=G[G.length-
1])&&G.name in h||i(G=new w.HtmlParser.Element("li"),m);E=m;N=G}else if(z==G)i(m,m.parent);else{if(f[G])E||(E=m);else{i(m,m.parent,p);s[G]||t.unshift(m)}M=p}m=N?N:m.returnPoint||m.parent;if(M){o.onTagOpen.apply(this,arguments);return}}b(z);d();B.parent=m;B.returnPoint=E;E=0;if(B.isEmpty)i(B);else m=B}}};o.onTagClose=function(z){for(var C=t.length-1;C>=0;C--)if(z==t[C].name){t.splice(C,1);return}for(var F=[],B=[],G=m;G.type&&G.name!=z;){G._.isBlockLike||B.unshift(G);F.push(G);G=G.parent}if(G.type){for(C=
0;C<F.length;C++){var M=F[C];i(M,M.parent)}m=G;if(m.name=="pre")A=v;G._.isBlockLike&&d();i(G,G.parent);if(G==m)m=m.parent;t=t.concat(B)}if(z=="body")g=v};o.onText=function(z){if(!m._.hasInlineStarted&&!A){z=j.ltrim(z);if(z.length===0)return}d();b();if(g&&(!m.type||m.name=="body")&&j.trim(z))this.onTagOpen(g,{});A||(z=z.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));m.add(new w.HtmlParser.Text(z))};o.onCDATA=function(){};o.onComment=function(z){m.add(new w.HtmlParser.Comment(z))};o.parse(q);for(d();m.type;){var D=
m.parent,u=m;if(g&&(!D.type||D.name=="body")&&!c.$body[u.name]){m=D;o.onTagOpen(g,{});D=m}D.add(u);m=D}return y};n.augment(l,{add:function(q){var g=this.children.length;if(g=g>0&&this.children[g-1]||x){if(q._.isBlockLike&&g.type==k.NODE_TEXT){g.value=j.rtrim(g.value);if(g.value.length===0){this.children.pop();this.add(q);return}}g.next=q}q.previous=g;q.parent=this;this.children.push(q);this._.hasInlineStarted=q.type==k.NODE_TEXT||q.type==k.NODE_ELEMENT&&!q._.isBlockLike},writeHtml:function(q,g){var b;
this.filterChildren=this.filterChildren=function(){var d=new w.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,d,g,p);d=d.getHtml();this.children=(new l.FromHtml(d)).children;b=1};!this.name&&g&&g.onFragment(this);this.writeChildrenHtml(q,b?x:g)},writeChildrenHtml:function(q,g){for(var b=0;b<this.children.length;b++)this.children[b].writeHtml(q,g)}});w.HtmlParser.Fragment=l;w.HtmlParser.Fragment=l;l.FromHtml=l.FromHtml;n=l.prototype;w.Utils.extern(n,{add:n.add,writeHtml:n.writeHtml,writeChildrenHtml:n.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function l(s,n){this.name=s;this.attributes=n||(n={});this.children=[];var j=n._ke_real_element_type||s,k=p.XHTML_DTD;j=!!(k.$nonBodyContent[j]||k.$block[j]||k.$listItem[j]||k.$tableContent[j]||k.$nonEditable[j]||j=="br");var c=!!k.$empty[s];this.isEmpty=c;this.isUnknown=!k[s];this._={isBlockLike:j,hasInlineStarted:c||!j}}var p=KISSY.Editor,v=p.NODE,x=function(s,n){s=s[0];n=n[0];return s<n?-1:s>n?1:0};KISSY.augment(l,{type:v.NODE_ELEMENT,add:p.HtmlParser.Fragment.prototype.add,
clone:function(){return new l(this.name,this.attributes)},writeHtml:function(s,n){var j=this.attributes,k=this,c=k.name,f,e,h,q;k.filterChildren=function(){if(!q){var d=new p.HtmlParser.BasicWriter;p.HtmlParser.Fragment.prototype.writeChildrenHtml.call(k,d,n);k.children=(new p.HtmlParser.Fragment.FromHtml(d.getHtml())).children;q=1}};k.filterChildren=k.filterChildren;if(n){for(;;){if(!(c=n.onElementName(c)))return;k.name=c;if(!(k=n.onElement(k)))return;k.parent=this.parent;if(k.name==c)break;if(k.type!=
v.NODE_ELEMENT){k.writeHtml(s,n);return}c=k.name;if(!c){this.writeChildrenHtml.call(k,s,q?null:n);return}}j=k.attributes}s.openTag(c,j);for(var g=[],b=0;b<2;b++)for(f in j){e=f;h=j[f];if(b==1)g.push([f,h]);else if(n){for(;;)if(e=n.onAttributeName(f))if(e!=f){delete j[f];f=e}else break;else{delete j[f];break}if(e)if((h=n.onAttribute(k,e,h))===false)delete j[e];else j[e]=h}}s.sortAttributes&&g.sort(x);j=g.length;for(b=0;b<j;b++){f=g[b];s.attribute(f[0],f[1])}s.openTagClose(c,k.isEmpty);if(!k.isEmpty){this.writeChildrenHtml.call(k,
s,q?null:n);s.closeTag(c)}},writeChildrenHtml:function(){p.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});p.HtmlParser.Element=l;p.HtmlParser.Element=l;var w=l.prototype;p.Utils.extern(w,{type:w.type,add:w.add,clone:w.clone,writeHtml:w.writeHtml,writeChildrenHtml:w.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function l(f){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};f&&this.addRules(f,10)}function p(f,e){for(var h=0;f&&h<e.length;h++){var q=e[h];f=f.replace(q[0],q[1])}return f}function v(f,e,h){if(typeof e=="function")e=[e];var q,g;g=f.length;var b=e&&e.length;if(b){for(q=0;q<g&&f[q].pri<h;q++);for(g=b-1;g>=0;g--)if(b=e[g]){b.pri=h;f.splice(q,0,b)}}}function x(f,e,h){if(e)for(var q in e){var g=f[q];f[q]=w(g,e[q],
h);g||f.$length++}}function w(f,e,h){if(e){e.pri=h;if(f){if(f.splice)v(f,e,h);else{f=f.pri>h?[e,f]:[f,e];f.filter=s}return f}else return e.filter=e}}function s(f){for(var e=f.type||f instanceof j.HtmlParser.Fragment,h=0;h<this.length;h++){if(e)var q=f.type,g=f.name;var b=this[h].apply(window,arguments);if(b===c)return b;if(e){if(b&&(b.name!=g||b.type!=q))return b}else if(typeof b!="string")return b;b!=undefined&&(f=b)}return f}var n=KISSY,j=n.Editor,k=j.NODE,c=false;n.augment(l,{addRules:function(f,
e){if(typeof e!="number")e=10;v(this._.elementNames,f.elementNames,e);v(this._.attributeNames,f.attributeNames,e);x(this._.elements,f.elements,e);x(this._.attributes,f.attributes,e);this._.text=w(this._.text,f.text,e)||this._.text;this._.comment=w(this._.comment,f.comment,e)||this._.comment;this._.root=w(this._.root,f.root,e)||this._.root},onElementName:function(f){return p(f,this._.elementNames)},onAttributeName:function(f){return p(f,this._.attributeNames)},onText:function(f){var e=this._.text;
return e?e.filter(f):f},onComment:function(f,e){var h=this._.comment;return h?h.filter(f,e):f},onFragment:function(f){var e=this._.root;return e?e.filter(f):f},onElement:function(f){for(var e=[this._.elements["^"],this._.elements[f.name],this._.elements.$],h,q=0;q<3;q++)if(h=e[q]){h=h.filter(f,this);if(h===c)return null;if(h&&h!=f)return this.onNode(h);if(f.parent&&!f.name)break}return f},onNode:function(f){var e=f.type;return e==k.NODE_ELEMENT?this.onElement(f):e==k.NODE_TEXT?new j.HtmlParser.Text(this.onText(f.value)):
null},onAttribute:function(f,e,h){if(e=this._.attributes[e]){f=e.filter(h,f,this);if(f===c)return c;if(typeof f!="undefined")return f}return h}});j.HtmlParser.Filter=l;n=l.prototype;j.Utils.extern(n,{addRules:n.addRules,onElementName:n.onElementName,onAttributeName:n.onAttributeName,onText:n.onText,onComment:n.onComment,onFragment:n.onFragment,onElement:n.onElement,onNode:n.onNode,onAttribute:n.onAttribute});j.HtmlParser.Filter=l});
KISSY.Editor.add("htmlparser-text",function(){function l(w){this.value=w;this._={isBlockLike:x}}var p=KISSY,v=p.Editor,x=false;p.augment(l,{type:v.NODE.NODE_TEXT,writeHtml:function(w,s){var n=this.value;s&&!(n=s.onText(n,this))||w.text(n)}});v.HtmlParser.Text=l;v.HtmlParser.Text=l});
KISSY.Editor.add("htmlparser-comment",function(){function l(x){this.value=x;this._={isBlockLike:false}}var p=KISSY.Editor,v=p.NODE;p.HtmlParser.Comment=l;p.HtmlParser.Comment=l;l.prototype={constructor:l,type:v.NODE_COMMENT,writeHtml:function(x,w){var s=this.value;if(w){if(!(s=w.onComment(s,this)))return;if(typeof s!="string"){s.parent=this.parent;s.writeHtml(x,w);return}}x.comment(s)}}});
KISSY.Editor.add("bubbleview",function(){var l=KISSY.Editor,p=KISSY,v=p.Event,x=p.DOM;if(!l.BubbleView){var w=p.UIBase.create(l.Overlay,[],{renderUI:function(){this.get("el").addClass("ke-bubbleview-bubble")},show:function(){var n=this._selectedEl,j=n._4e_getOffset(document);j.top+=n.height()+5;w.superclass.show.call(this);this.set("xy",[j.left,j.top])}},{ATTRS:{focus4e:false,zIndex:{value:l.baseZIndex(l.zIndexManager.BUBBLE_VIEW)}}}),s={};w.attach=function(n){var j=n.pluginName;p.mix(n,s[j].cfg,
false);var k=n.pluginContext,c=n.func,f=n.editor,e=n.bubble;f.on("selectionChange",function(h){h=h.path;var q=h.elements;if(h&&q)if(h=h.lastElement)if(h=c(h)){q=s[j];if(!q.bubble){q.bubble=new w({autoRender:true});q.cfg.init&&q.cfg.init.call(q.bubble)}e=q.bubble;e._selectedEl=h;e._plugin=k;e.hide();e.show()}else if(e){e._selectedEl=e._plugin=null;e.hide()}});v.on(x._4e_getWin(f.document),"scroll blur",function(){e&&e.hide()})};w.register=function(n){var j=n.pluginName;s[j]=s[j]||{cfg:n};v.on(document,
"click",function(){n.bubble&&n.bubble.hide()});n.editor&&w.attach(n)};l.BubbleView=w}});
KISSY.Editor.add("button",function(){var l=KISSY,p=l.Editor;if(!p.TripleButton){var v=l.UIBase.create([l.UIBase.Box],{bindUI:function(){var x=this,w=x.get("el");w.on("click",x._action,x);w.on("mousedown",function(){x.get("state")=="off"&&w.addClass("ke-triplebutton-active")});w.on("mouseup mouseleave",function(){x.get("state")=="off"&&w.hasClass("ke-triplebutton-active")&&setTimeout(function(){w.removeClass("ke-triplebutton-active")},300)})},_uiSetTitle:function(){this.get("el").attr("title",this.get("title"))},
_uiSetContentCls:function(x){var w=this.get("el");if(x!==undefined){w.html("<span class='ke-toolbar-item "+x+"'>");w._4e_unselectable()}},_uiSetText:function(x){var w=this.get("el");x!==undefined&&w.html(x)},_uiSetState:function(x){this["_"+x]()},disable:function(){this._savedState=this.get("state");this.set("state","disabled")},enable:function(){this.get("state")=="disabled"&&this.set("state",this._savedState)},_action:function(x){this.fire(this.get("state")+"Click",x);x.type=this.get("state")+"Click";
this.fire("click",x);x.preventDefault()},bon:function(){this.set("state","on")},boff:function(){this.set("state","off")},_on:function(){var x=this.get("el");x.removeClass("ke-triplebutton-off ke-triplebutton-disabled");x.addClass("ke-triplebutton-on")},_off:function(){var x=this.get("el");x.removeClass("ke-triplebutton-on ke-triplebutton-disabled");x.addClass("ke-triplebutton-off")},_disabled:function(){var x=this.get("el");x.removeClass("ke-triplebutton-off ke-triplebutton-on");x.addClass("ke-triplebutton-disabled")}},
{ATTRS:{state:{value:"off"},elCls:{value:"ke-triplebutton ke-triplebutton-off"},elAttrs:{href:{value:"#"}},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});v.ON="on";v.OFF="off";v.DISABLED="disabled";v.ON_CLASS="ke-triplebutton-on";v.OFF_CLASS="ke-triplebutton-off";v.DISABLED_CLASS="ke-triplebutton-disabled";p.TripleButton=v;p.prototype.addButton=function(x,w){var s=this,n=new v({render:s.toolBarDiv,autoRender:true,title:w.title,text:w.text,contentCls:w.contentCls}),j={btn:n,editor:s,cfg:w,
call:function(){var k=l.makeArray(arguments),c=k.shift();return w[c].apply(j,k)},reload:function(k){l.mix(w,k);n.enable();s.on("selectionChange",function(){s.getMode()!=p.SOURCE_MODE&&w.selectionChange&&w.selectionChange.apply(j,arguments)});n.on("click",function(c){var f=c.type;w[f]&&w[f].apply(j,arguments)});if(w.mode==p.WYSIWYG_MODE){s.on("wysiwygmode",n.enable,n);s.on("sourcemode",n.disable,n)}w.init&&w.init.call(j)}};w.loading?n.disable():j.reload();return j}}});
KISSY.Editor.add("clipboard",function(l){var p=KISSY,v=p.Editor,x=p.Node,w=p.UA,s=v.Range,n=v.RANGE,j=p.Event;v.Paste||function(){function k(d){this.editor=d;this._init()}function c(d){if(!(!w.ie||d.document.compatMode=="BackCompat")){var i=d.getSelection(),o;if(i.getType()==g.SELECTION_ELEMENT&&(o=i.getSelectedElement())){var y=i.getRanges()[0],t=new x(d.document.createTextNode(""));t.insertBefore(o);y.setStartBefore(t);y.setEndAfter(o);i.selectRanges([y]);setTimeout(function(){if(o.parent()){t.remove();
i.selectElement(o)}},0)}}}p.augment(k,{_init:function(){var d=this.editor;w.ie?j.on(d.document,"keydown",this._paste,this):j.on(d.document,"paste",this._paste,this);d.addCommand("copy",new q("copy"));d.addCommand("cut",new q("cut"));d.addCommand("paste",new q("paste"))},_paste:function(d){if(!(d.type==="keydown"&&!(d.keyCode===86&&(d.ctrlKey||d.metaKey)))){var i=this,o=i.editor,y=o.document;if(i._running)d.halt();else{var t=o.getSelection();d=new s(y);var r=new x(w.webkit?"<body></body>":"<div></div>",
null,y);w.webkit&&r[0].appendChild(y.createTextNode("\u00a0"));y.body.appendChild(r[0]);r.css({position:"absolute",top:t.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});r.css("left","-1000px");var m=t.createBookmarks();d.setStartAt(r,n.POSITION_AFTER_START);d.setEndAt(r,n.POSITION_BEFORE_END);d.select(true);i._running=true;setTimeout(function(){r._4e_remove();var A;r=w.webkit&&(A=r._4e_first())&&A.hasClass("Apple-style-span")?A:r;t.selectBookmarks(m);o.insertHtml(r.html());
i._running=false},0)}}}});v.Paste=k;var f=function(d,i){var o=d.document,y=new x(o.body),t=false,r=function(){t=true};y.on(i,r);(w.ie>7?o:o.selection.createRange()).execCommand(i);y.detach(i,r);return t},e=w.ie?function(d,i){return f(d,i)}:function(d,i){try{return d.document.execCommand(i)}catch(o){return false}},h={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},q=function(d){this.type=
d;this.canUndo=this.type=="cut"};q.prototype={exec:function(d){this.type=="cut"&&c(d);(d=e(d,this.type))||alert(h[this.type]);return d}};var g=v.Selection,b={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};v.on("contextmenu",function(d){var i=d.contextmenu,o=i.cfg.editor,y=i.elDom,t={copy:0,cut:0,paste:0},r;for(r in t){if(!t.hasOwnProperty(r))break;t[r]=y.one(".ke-paste-"+r);(function(m){var A=t[m];if(!A){A=(new x("<a href='#'class='ke-paste-"+m+"'>"+b[m]+"</a>")).appendTo(y);A.on("click",function(E){E.halt();if(!A.hasClass("ke-menuitem-disable")){i.hide();
setTimeout(function(){o.execCommand(m)},30)}})}t[m]=A})(r);d=t[r];(o.document.queryCommandEnabled(r)?true:false)?d.removeClass("ke-menuitem-disable"):d.addClass("ke-menuitem-disable")}})}();l.ready(function(){new v.Paste(l)})});
KISSY.Editor.add("color",function(l){var p=KISSY.Editor;l.ready(function(){var v=l.cfg.pluginConfig;false!==v.forecolor&&function(){var x=l.addButton("color",{styles:{element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},mode:p.WYSIWYG_MODE,title:"\u6587\u672c\u989c\u8272",loading:true,contentCls:"ke-toolbar-color"});p.use("colorsupport",function(){x.reload(p.ColorSupport)})}();false!==v.bgcolor&&function(){var x=l.addButton("color",{styles:{element:"span",styles:{"background-color":"#(color)"}},
title:"\u80cc\u666f\u989c\u8272",mode:p.WYSIWYG_MODE,loading:true,contentCls:"ke-toolbar-bgcolor"});p.use("colorsupport",function(){x.reload(p.ColorSupport)})}()})});
KISSY.Editor.add("colorsupport",function(){function l(){if(!k){k="<div class='ke-color-panel'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\">\u6e05\u9664</a>";for(var c=0;c<3;c++){k+="<div class='ke-color-palette'><table>";for(var f=j[c],e=f.length/8,h=0;h<e;h++){k+="<tr>";for(var q=0;q<8;q++){var g="#"+f[8*h+q];k+="<td>";k+="<a href='javascript:void(0);' class='ke-color-a' style='background-color:"+g+"'></a>";k+="</td>"}k+="</tr>"}k+="</table></div>"}k+="<div><a class='ke-button ke-color-others'>\u5176\u4ed6\u989c\u8272</a></div></div>"}}
var p=KISSY,v=p.Editor,x=p.Node,w=p.Event,s=v.Overlay,n=p.DOM;n.addStyleSheet(".ke-color-panel a {display: block;color:black;text-decoration: none;}.ke-color-panel a:hover {color:black;text-decoration: none;}.ke-color-panel a:active {color:black;}.ke-color-palette {    margin: 5px 8px 8px;}.ke-color-palette table {    border: 1px solid #666666;    border-collapse: collapse;}.ke-color-palette td {    border-right: 1px solid #666666;    height: 18px;    width: 18px;}a.ke-color-a {    height: 18px;    width: 18px;}a.ke-color-a:hover {    border: 1px solid #ffffff;    height: 16px;    width: 16px;}a.ke-color-remove {  padding:3px 8px;  margin:2px 0 3px 0;}a.ke-color-remove:hover {    background-color: #D6E9F8;}",
"ke-color-plugin");var j=[["000","444","666","999","CCC","EEE","F3F3F3","FFF"],["F00","F90","FF0","0F0","0FF","00F","90F","F0F"],["F4CCCC","FCE5CD","FFF2CC","D9EAD3","D0E0E3","CFE2F3","D9D2E9","EAD1DC","EA9999","F9CB9C","FFE599","B6D7A8","A2C4C9","9FC5E8","B4A7D6","D5A6BD","E06666","F6B26B","FFD966","93C47D","76A5AF","6FA8DC","8E7CC3","C27BAD","CC0000","E69138","F1C232","6AA84F","45818E","3D85C6","674EA7","A64D79","990000","B45F06","BF9000","38761D","134F5C","0B5394","351C75","741B47","660000","783F04",
"7F6000","274E13","0C343D","073763","20124D","4C1130"]],k;v.ColorSupport={offClick:function(c){var f=this.cfg,e=this.colorWin;e&&e.get("visible")?e.hide():f._prepare.call(this,c)},_prepare:function(){var c=this,f=c.cfg,e=document,h=c.btn,q=c.editor,g;l();c.colorWin=new s({elCls:"ks-popup",content:k,focus4e:false,autoRender:true,width:"170px",zIndex:q.baseZIndex(v.zIndexManager.POPUP_MENU)});var b=c.colorWin;g=b.get("contentEl");g.on("click",f._selectColor,c);w.on(e,"click",f._hidePanel,c);w.on(q.document,
"click",f._hidePanel,c);b.on("show",h.bon,h);b.on("hide",h.boff,h);g.one(".ke-color-others").on("click",function(d){d.halt();b.hide();q.useDialog("color/dialog",function(i){i.show(c)})});f._prepare=f._show;f._show.call(c)},_show:function(){var c=this.btn.get("el"),f=this.colorWin,e=parseInt(f.get("width")),h=n.viewportWidth();f.align(c,["bl","tl"],[0,2]);f.get("x")+e>h-30&&f.set("x",h-30-e);f.show()},_hidePanel:function(c){var f=this.btn.get("el");c=new x(c.target);var e=this.colorWin;f._4e_equals(c)||
f.contains(c)||e.hide()},_selectColor:function(c){c.halt();var f=this.cfg;c=new x(c.target);if(c._4e_name()=="a"&&!c.hasClass("ke-button")){f._applyColor.call(this,c._4e_style("background-color"));this.colorWin.hide()}},_applyColor:function(c){var f=this.editor,e=f.document,h=this.cfg.styles;f.fire("save");c?(new v.Style(h,{color:c})).apply(e):(new v.Style(h,{color:"inherit"})).remove(e);f.fire("save")}}});
KISSY.Editor.add("contextmenu",function(){function l(c){this.cfg=c;v.Utils.lazyRun(this,"_prepareShow","_realShow")}function p(c,f){for(var e=0;e<f.length;e++){var h=f[e];if(x.isFunction(h)){if(h(new w(c)))return true}else if(s.test(c,h))return true}return false}var v=KISSY.Editor,x=KISSY,w=x.Node,s=x.DOM,n=x.Event;if(!v.ContextMenu){l.ATTRS={editor:{}};var j=[];l.register=function(c){var f=new l(c),e=c.editor.document;j.push({doc:e,rules:c.rules||[],instance:f});if(!e.ke_contextmenu){e.ke_contextmenu=
1;n.on(e,"mousedown",l.hide);n.on(e,"contextmenu",function(h){l.hide.call(this);for(var q=new w(h.target);q;){var g=false;if(q._4e_name()=="body")break;for(var b=0;b<j.length;b++){var d=j[b].instance,i=j[b].rules;if(e===j[b].doc&&p(q[0],i)){h.preventDefault();g=true;setTimeout(function(){d.show(v.Utils.getXY(h.pageX,h.pageY,e,document))},30);break}}if(g)break;q=q.parent()}})}return f};l.hide=function(){for(var c=0;c<j.length;c++){var f=j[c].instance;this===j[c].doc&&f.hide()}};var k=v.Overlay;x.augment(l,
{_init:function(){var c=this,f=c.cfg,e=f.funcs;c.el=new k({content:"<div>",autoRender:true,width:f.width,elCls:"ke-menu"});c.elDom=c.el.get("contentEl").one("div");f=c.elDom;for(var h in e){var q=new w("<a href='#'>"+h+"</a>");f[0].appendChild(q[0]);(function(g,b){g._4e_unselectable();g.on("click",function(d){c.hide();d.halt();setTimeout(b,30)})})(q,e[h])}},hide:function(){this.el&&this.el.hide()},_realShow:function(c){v.fire("contextmenu",{contextmenu:this});this.el.set("xy",[c.left,c.top]);this.el.show()},
_prepareShow:function(){this._init()},show:function(c){this._prepareShow(c)}});v.ContextMenu=l}});KISSY.Editor.add("draft",function(l){var p=KISSY.Editor;l.ready(function(){p.use("draft/support",function(){p.storeReady(function(){new p.Draft(l)})})})});
KISSY.Editor.add("draft/support",function(){function l(c,f,e){for(c+="";c.length<f;)c=e+c;return c}function p(c){if(x.isNumber(c))c=new Date(c);return c instanceof Date?[c.getFullYear(),"-",l(c.getMonth()+1,2,"0"),"-",l(c.getDate(),2,"0")," ",l(c.getHours(),2,"0"),":",l(c.getMinutes(),2,"0"),":",l(c.getSeconds(),2,"0")].join(""):c}function v(c){this.editor=c;this._init()}var x=KISSY,w=x.Editor,s=x.Node,n=x.Event,j=x.JSON,k=window[w.STORE];x.augment(v,{_init:function(){var c=this,f=c.editor,e=f.statusDiv,
h=f.cfg.pluginConfig;h.draft=h.draft||{};c.draftInterval=h.draft.interval=h.draft.interval||5;c.draftLimit=h.draft.limit=h.draft.limit||5;e=(new s("<div class='ke-draft'><spa class='ke-draft-title'>\u5185\u5bb9\u6b63\u6587\u6bcf"+h.draft.interval+"\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(e);c.timeTip=(new s("<span class='ke-draft-time'>")).appendTo(e);var q=(new s("<a class='ke-button ke-draft-save-btn' style='vertical-align:middle;padding:1px 9px;'><span class='ke-draft-mansave'></span><span>\u7acb\u5373\u4fdd\u5b58</span></a>")).appendTo(e),g=new w.Select({container:e,
menuContainer:document.body,doc:f.document,width:"85px",popUpWidth:"225px",align:["r","t"],title:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"}),b=k.getItem("ke-draft-save"),d=[];c.versions=g;if(b)d=x.isString(b)?j.parse(decodeURIComponent(b)):b;c.drafts=d;c.sync();q.on("click",function(){c.save(false)});(function(){var i=f.textarea[0].form;i&&n.on(i,"submit",function(){c.save(false)})})();setInterval(function(){c.save(true)},c.draftInterval*60*1E3);g.on("click",c.recover,c);c.holder=e;if(h.draft.helpHtml){h=new w.TripleButton({cls:"ke-draft-help",
title:"\u5e2e\u52a9",text:"\u5e2e\u52a9",container:e});h.on("click",function(){c._prepareHelp()});w.Utils.lazyRun(c,"_prepareHelp","_realHelp");c.helpBtn=h.el}c._holder=e},_prepareHelp:function(){var c=this,f=c.editor,e=c.helpBtn,h=new s(f.cfg.pluginConfig.draft.helpHtml||""),q=new s("<div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;border-top-color:#CED5E0;'><div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;left:-8px;top:-10px;border-top-color:white;'></div></div>");
h.append(q);h.css({border:"1px solid #ACB4BE","text-align":"left"});c._help=new x.Overlay({content:h,autoRender:true,width:h.width()+"px",mask:false});c._help.el.css("border","none");c._help.arrow=q;n.on([document,f.document],"click",function(g){g=new s(g.target);g[0]==e[0]||e.contains(g)||c._help.hide()})},_realHelp:function(){var c=this._help,f=this.helpBtn,e=c.arrow;c.show();f=f.offset();c.el.offset({left:f.left-c.el.width()+17,top:f.top-c.el.height()-7});e.offset({left:f.left-2,top:f.top-8})},
disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var c=this.draftLimit,f=this.timeTip,e=this.versions,h=this.drafts;h.length>c&&h.splice(0,h.length-c);c=[];for(var q,g=0;g<h.length;g++){q=h[g];q=(q.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e : "+p(q.date);c.push({name:q,value:g})}e.set("items",c.reverse());f.html(q);k.setItem("ke-draft-save",encodeURIComponent(j.stringify(h)))},save:function(c){var f=this.drafts,e=this.editor.getData(true);if(e){if(f[f.length-
1]&&e==f[f.length-1].content)f.length-=1;this.drafts=f.concat({content:e,date:(new Date).getTime(),auto:c});this.sync()}},recover:function(c){var f=this.editor,e=this.drafts;c=c.newVal;this.versions.reset("value");if(confirm("\u786e\u8ba4\u6062\u590d "+p(e[c].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")){f.fire("save");f.setData(e[c].content);f.fire("save")}}});w.Draft=v});
KISSY.Editor.add("elementpaths",function(l){var p=KISSY.Editor,v=KISSY,x=v.Node,w=v.DOM;p.ElementPaths||function(){function s(n){this.cfg=n;this._cache=[];this._init()}w.addStyleSheet(".elementpath {   padding: 0 5px;    text-decoration: none;}.elementpath:hover {    background: #CCFFFF;    text-decoration: none;}","ke-ElementPaths");v.augment(s,{_init:function(){var n=this.cfg.editor;this.holder=new x("<span>");this.holder.appendTo(n.statusDiv);n.on("selectionChange",this._selectionChange,this);
p.Utils.sourceDisable(n,this)},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},_selectionChange:function(n){var j=this.cfg.editor,k=this.holder;n=n.path.elements;var c,f;c=this._cache;for(f=0;f<c.length;f++){c[f].detach("click");c[f]._4e_remove()}this._cache=[];for(f=0;f<n.length;f++){c=n[f];var e=new x("<a href='#' class='elementpath'>"+(c.attr("_ke_real_element_type")||c._4e_name())+"</a>");this._cache.push(e);(function(h){e.on("click",
function(q){q.halt();j.focus();setTimeout(function(){j.getSelection().selectElement(h)},50)})})(c);k.prepend(e)}}});p.ElementPaths=s}();l.ready(function(){new p.ElementPaths({editor:l})})});
KISSY.Editor.add("enterkey",function(l){var p=KISSY.Editor,v=KISSY,x=v.UA,w=/^h[1-6]$/,s=p.XHTML_DTD,n=v.Node,j=v.Event,k=p.Walker,c=p.ElementPath;p.enterBlock||function(){function f(e){j.on(e.document,"keydown",function(h){if(h.keyCode===13)if(!h.shiftKey){e.fire("save");var q=e.execCommand("enterBlock");e.fire("save");q!==false&&h.preventDefault()}})}f.enterBlock=function(e){var h;h=e.getSelection().getRanges();for(var q=h.length-1;q>0;q--)h[q].deleteContents();h=h[0];q=h.document;if(h.checkStartOfBlock()&&
h.checkEndOfBlock()){var g=(new c(h.startContainer)).block;if(g&&(g._4e_name()=="li"||g.parent()._4e_name()=="li"))if(e.hasCommand("outdent")){e.fire("save");e.execCommand("outdent");e.fire("save");return}else return false}var b=h.splitBlock("p");if(b){e=b.previousBlock;g=b.nextBlock;var d=b.wasStartOfBlock,i=b.wasEndOfBlock,o;if(g){o=g.parent();if(o._4e_name()=="li"){g._4e_breakParent(o);g._4e_move(g._4e_next(),true)}}else if(e&&(o=e.parent())&&o._4e_name()=="li"){e._4e_breakParent(o);h.moveToElementEditablePosition(e._4e_next());
e._4e_move(e._4e_previous())}if(!d&&!i){if(g._4e_name()=="li"&&(o=g._4e_first(k.invisible(true)))&&v.inArray(o._4e_name(),["ul","ol"]))(x.ie?new n(q.createTextNode("\u00a0")):new n(q.createElement("br"))).insertBefore(o);g&&h.moveToElementEditablePosition(g)}else{var y;if(e){if(e._4e_name()=="li"||!w.test(e._4e_name()))y=e._4e_clone()}else if(g)y=g._4e_clone();y||(y=new n("<p>",null,q));if(o=b.elementPath){b=0;for(var t=o.elements.length;b<t;b++){var r=o.elements[b];if(r._4e_equals(o.block)||r._4e_equals(o.blockLimit))break;
if(s.$removeEmpty[r._4e_name()]){r=r._4e_clone();y._4e_moveChildren(r);y.append(r)}}}x.ie||y._4e_appendBogus();h.insertNode(y);if(x.ie&&d&&(!i||!e[0].childNodes.length)){h.moveToElementEditablePosition(i?e:y);h.select()}h.moveToElementEditablePosition(d&&!i?g:y)}if(!x.ie)if(g){y=new n(q.createElement("span"));y.html("&nbsp;");h.insertNode(y);y._4e_scrollIntoView();h.deleteContents()}else y._4e_scrollIntoView();h.select()}};p.EnterKey=f}();l.ready(function(){l.addCommand("enterBlock",{exec:p.EnterKey.enterBlock});
p.EnterKey(l)})});
KISSY.Editor.add("fakeobjects",function(l){var p=KISSY.Editor,v=KISSY,x=v.Node,w=p.NODE,s=p.Config.base+"theme/spacer.gif",n=p.HtmlParser;p=v.Editor;var j=(l=l.htmlDataProcessor)&&l.htmlFilter,k={elements:{$:function(c){var f=c.attributes;if((f=(f=(f=f&&f._ke_realelement)&&new n.Fragment.FromHtml(decodeURIComponent(f)))&&f.children[0])&&c.attributes._ke_resizable){var e=c.attributes.style;if(e){var h=/(?:^|\s)width\s*:\s*(\d+)/i.exec(e);c=h&&h[1];e=(h=/(?:^|\s)height\s*:\s*(\d+)/i.exec(e))&&h[1];
if(c)f.attributes.width=c;if(e)f.attributes.height=e}}return f}}};j&&j.addRules(k);l&&v.mix(l,{createFakeParserElement:function(c,f,e,h,q){var g;g=new n.BasicWriter;c.writeHtml(g);g=g.getHtml();var b=c.attributes.style;if(c.attributes.width)b="width:"+c.attributes.width+"px;"+b;if(c.attributes.height)b="height:"+c.attributes.height+"px;"+b;c={"class":f,src:s,_ke_realelement:encodeURIComponent(g),_ke_real_node_type:c.type,style:b,align:c.attributes.align||""};q&&delete q.width;q&&delete q.height;q&&
v.mix(c,q,false);if(e)c._ke_real_element_type=e;if(h)c._ke_resizable=h;return new n.Element("img",c)}});v.augment(p,{createFakeElement:function(c,f,e,h,q,g){var b=c.attr("style")||"";if(c.attr("width"))b="width:"+c.attr("width")+"px;"+b;if(c.attr("height"))b="height:"+c.attr("height")+"px;"+b;c={"class":f,src:s,_ke_realelement:encodeURIComponent(q||c._4e_outerHtml()),_ke_real_node_type:c[0].nodeType,style:b};g&&delete g.width;g&&delete g.height;g&&v.mix(c,g,false);if(e)c._ke_real_element_type=e;if(h)c._ke_resizable=
h;return new x("<img/>",c,this.document)},restoreRealElement:function(c){if(c.attr("_ke_real_node_type")!=w.NODE_ELEMENT)return null;c=decodeURIComponent(c.attr("_ke_realelement"));var f=new x("<div>",null,this.document);f.html(c);return f._4e_first(function(e){return e[0].nodeType==w.NODE_ELEMENT})._4e_remove()}})});
KISSY.Editor.add("flash",function(l){l.ready(function(){var p=KISSY,v=p.Editor,x=l.htmlDataProcessor,w=l.cfg.pluginConfig,s=x&&x.dataFilter;s&&s.addRules({elements:{object:function(n){var j=n.attributes;if(!(j.classid&&String(j.classid).toLowerCase())){for(j=0;j<n.children.length;j++)if(n.children[j].name=="embed"){if(!v.Utils.isFlashEmbed(n.children[j]))break;return x.createFakeParserElement(n,"ke_flash","flash",true)}return null}return x.createFakeParserElement(n,"ke_flash","flash",true)},embed:function(n){if(!v.Utils.isFlashEmbed(n))return null;
return x.createFakeParserElement(n,"ke_flash","flash",true)}}},5);v.use("flash/support",function(){var n=v.Flash;l.addCommand("insertFlash",{exec:function(){var j=p.makeArray(arguments);return v.Flash.Insert.apply(null,j)}});if(!w.flash||w.flash.btn!==false)new n(l)})})});
KISSY.Editor.add("flash/support",function(){function l(h){this.editor=h;this._init()}function p(h){return h._4e_name()==="img"&&!!h.hasClass(c)&&h}var v=KISSY.Editor,x=KISSY,w=x.UA,s=x.Event,n=v.ContextMenu,j=x.Node,k=v.BubbleView,c="ke_flash",f=v.Utils.flash;x.augment(l,{_config:function(){this._cls=c;this._type="flash";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=e;this._flashRules=["img."+c]},_init:function(){this._config();var h=this,q=h.editor,g={},b=h._contextMenu;
q.addButton("flash",{contentCls:h._contentCls,title:h._tip,mode:v.WYSIWYG_MODE,offClick:function(){h.show()}});if(b)for(var d in b)(function(i){g[i]=function(){b[i](h)}})(d);n.register({editor:q,rules:h._flashRules,width:"120px",funcs:g});k.attach({pluginName:h._type,editor:h.editor,pluginContext:h});s.on(q.document,"dblclick",h._dbclick,h)},_getFlashUrl:function(h){return f.getUrl(h)},_updateTip:function(h,q){var g=this.editor.restoreRealElement(q);if(g){g=this._getFlashUrl(g);h.html(g);h.attr("href",
g)}},_dbclick:function(h){var q=new j(h.target);if(q._4e_name()==="img"&&q.hasClass(this._cls)){this.show(null,q);h.halt()}},show:function(h,q){this.editor.useDialog(this._type+"/dialog",function(g){g.show(q)})}});v.Flash=l;l.registerBubble=function(h,q,g){k.register({pluginName:h,func:g,init:function(){var b=this,d=b.get("contentEl");d.html(q+' <a class="ke-bubbleview-url" target="_blank" href="#"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var i=d.one(".ke-bubbleview-url"),o=d.one(".ke-bubbleview-change"),y=d.one(".ke-bubbleview-remove");v.Utils.preventFocus(d);o.on("click",function(t){b._plugin.show(null,b._selectedEl);t.halt()});y.on("click",function(t){var r=b._plugin;if(w.webkit){var m=r.editor.getSelection().getRanges();m&&m[0]&&(m[0].collapse(true)||1)&&m[0].select()}b._selectedEl._4e_remove();b.hide();r.editor.notifySelectionChange();t.halt()});b.on("show",function(){var t=b._selectedEl;t&&b._plugin._updateTip(i,t)})}})};l.registerBubble("flash",
"Flash \u7f51\u5740\uff1a ",p);l.checkFlash=p;var e={"Flash\u5c5e\u6027":function(h){var q=h.editor.getSelection();q=q&&q.getStartElement();(q=p(q))&&h.show(null,q)}};l.CLS_FLASH=c;l.TYPE_FLASH="flash";l.Insert=function(h,q,g,b,d){q=f.createSWF(q,{attrs:g},h.document);var i=q.el;g=h.createFakeElement?h.createFakeElement(i,b||"ke_flash",d||"flash",true,q.html,g):i;return g=h.insertElement(g)};v.Flash=l});
KISSY.Editor.add("flashbridge",function(){function l(f){this._init(f)}function p(f){var e=x.isString(f)?f.match(/(\d)+/g):f;f=f;if(x.isArray(e))f=parseFloat(e[0]+"."+v(e[1],3)+v(e[2],5));return f||0}function v(f,e){for(var h=(f+"").length;h++<e;)f="0"+f;return f}var x=KISSY,w=x.Editor;if(!w.FlashBridge){var s={};x.augment(l,x.EventTarget,{_init:function(f){var e=x.guid("flashbridge-");f.flashVars=f.flashVars||{};f.attrs=f.attrs||{};f.params=f.params||{};var h=f.flashVars,q=f.params;x.mix(f.attrs,
{id:e,width:"100%",height:"100%"},false);x.mix(q,{allowScriptAccess:"always",allowNetworking:"all",scale:"noScale"},false);x.mix(h,{shareData:false,useCompression:false},false);q={YUISwfId:e,YUIBridgeCallback:"KISSY.Editor.FlashBridge.EventHandler"};if(f.ajbridge)q={swfID:e,jsEntry:"KISSY.Editor.FlashBridge.EventHandler"};x.mix(h,q);s[e]=this;this.id=e;this.swf=w.Utils.flash.createSWFRuntime(f.movie,f);this._expose(f.methods)},_expose:function(f){for(var e=this,h=0;h<f.length;h++)(function(q){e[q]=
function(){return e._callSWF(q,x.makeArray(arguments))}})(f[h])},_callSWF:function(f,e){e=e||[];try{if(this.swf[f])return this.swf[f].apply(this.swf,e)}catch(h){var q="";if(e.length!==0)q="'"+e.join("', '")+"'";return(new Function("self","return self.swf."+f+"("+q+");"))(this)}},_eventHandler:function(f){var e=f.type;if(e==="log")x.log(f.message);else e&&this.fire(e,f)},_destroy:function(){delete s[this.id]}});l.EventHandler=function(f,e){var h=s[f];h&&setTimeout(function(){h._eventHandler.call(h,
e)},100)};w.FlashBridge=l;var n=x.UA,j,k,c=true;n.fpv=function(f){if(f||c){c=false;var e;if(navigator.plugins&&navigator.mimeTypes.length)e=(navigator.plugins["Shockwave Flash"]||0).description;else if(window.ActiveXObject)try{e=(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version")}catch(h){}j=e?e.match(/(\d)+/g):void 0;k=p(j)}return j};n.fpvGEQ=function(f,e){c&&n.fpv(e);return!!k&&k>=p(f)}}});
KISSY.Editor.add("flashutils",function(){var l=KISSY,p=l.Editor,v=p.Utils.flash;if(!v){var x=l.DOM,w=l.Node,s=l.UA;v={getUrl:function(n){var j="",k=p.NODE;if(n._4e_name()=="object"){n=n[0].childNodes;for(var c=0;c<n.length;c++)if(n[c].nodeType==k.NODE_ELEMENT)if((x.attr(n[c],"name")||"").toLowerCase()=="movie")j=x.attr(n[c],"value");else if(x._4e_name(n[c])=="embed")j=x.attr(n[c],"src");else if(x._4e_name(n[c])=="object")j=x.attr(n[c],"data")}else if(n._4e_name()=="embed")j=n.attr("src");return j},
createSWF:function(n,j,k){var c=j.attrs||{},f=j.flashVars,e="",h="";j=j.params||{};var q="";k=k||document;l.mix(c,{wmode:"transparent"});for(var g in c)if(c.hasOwnProperty(g))e+=g+"='"+c[g]+"' ";l.mix(j,{quality:"high",movie:n,wmode:"transparent"});for(var b in j)if(j.hasOwnProperty(b))h+="<param name='"+b+"' value='"+j[b]+"'/>";if(f){for(var d in f)if(f.hasOwnProperty(d))q+="&"+d+"="+encodeURIComponent(f[d]);q=q.substring(1)}n="<object "+e+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >'+
h+(q?'<param name="flashVars" value="'+q+'"/>':"")+"<embed "+e+" "+(q?'FlashVars="'+q+'"':"")+' pluginspage="http://www.macromedia.com/go/getflashplayer"  quality="high"  src="'+n+'"  type="application/x-shockwave-flash"/></object>';return{el:new w(n,null,k),html:n}},createSWFRuntime2:function(n,j,k){k=k||document;var c=(new w("<div style='width:0;height:0;overflow:hidden;'>",null,k)).appendTo(k.body);c=v.createSWF.apply(this,arguments).el.appendTo(c);s.ie||(c=c.one("object"));return c[0]},createSWFRuntime:function(n,
j,k){var c=j.attrs||{},f=j.flashVars||{},e=j.params||{},h="",q="",g="";k=k||document;c.id=c.id||l.guid("ke-runtimeflash-");for(var b in c)if(c.hasOwnProperty(b))h+=b+"='"+c[b]+"' ";for(var d in e)if(e.hasOwnProperty(d))q+="<param name='"+d+"' value='"+e[d]+"'/>";for(var i in f)if(f.hasOwnProperty(i))g+="&"+i+"="+encodeURIComponent(f[i]);g=g.substring(1);n=s.ie?"<object "+h+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >'+q+'<param name="movie" value="'+n+'" />'+(g?'<param name="flashVars" value="'+
g+'" />':"")+"</object>":"<object type='application/x-shockwave-flash' data='"+n+"' "+h+">"+q+(g?'<param name="flashVars" value="'+g+'"/>':"")+"</object>";var o=j.holder;if(!o){o=(new w("<div style='"+(j.style?j.style:"width:1px;height:1px;position:absolute;"+ +"overflow:hidden;")+"'>",null,k)).appendTo(k.body);setTimeout(function(){o.offset({left:x.scrollLeft(),top:x.scrollTop()})},100)}o.html(n);return k.getElementById(c.id)}};p.Utils.flash=v}});
KISSY.Editor.add("font",function(l){function p(y){for(var t=[],r=0;r<y.length;r++)t.push({name:y[r],value:y[r]});return t}var v=KISSY,x=v.Editor,w=x.Style,s=x.TripleButton,n=l.cfg.pluginConfig,j=v.Node,k=n["font-size"],c,f,e;if(k!==false){k=k||{};v.mix(k,{items:p(["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px"]),width:"55px"},false);var h={},q=[],g={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]};for(o=0;o<k.items.length;o++){c=
k.items[o];f=c.name;e=c.attrs;c=c.value;h[c]=new w(g,{size:c});q.push({name:f,value:c,attrs:e})}n["font-size"]=k}var b=n["font-family"];if(b!==false){b=b||{};v.mix(b,{items:[{name:"\u5b8b\u4f53",value:"SimSun"},{name:"\u9ed1\u4f53",value:"SimHei"},{name:"\u96b6\u4e66",value:"LiSu"},{name:"\u6977\u4f53",value:"KaiTi_GB2312"},{name:"\u5fae\u8f6f\u96c5\u9ed1",value:"Microsoft YaHei"},{name:"Georgia",value:"Georgia"},{name:"Times New Roman",value:"Times New Roman"},{name:"Impact",value:"Impact"},{name:"Courier New",value:"Courier New"},{name:"Arial",value:"Arial"},
{name:"Verdana",value:"Verdana"},{name:"Tahoma",value:"Tahoma"}],width:"130px"},false);var d={},i=[];g={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]};var o;n["font-family"]=b;for(o=0;o<b.items.length;o++){c=b.items[o];f=c.name;e=c.attrs||{};c=c.value;e.style=e.style||"";e.style+=";font-family:"+c;d[c]=new w(g,{family:c});i.push({name:f,value:c,attrs:e})}}x.FontSelect||function(){function y(r){y.superclass.constructor.call(this,r);this._init()}
y.ATTRS={title:{},html:{},styles:{},editor:{}};var t=x.Select;v.extend(y,v.Base,{_init:function(){var r=this.get("editor"),m=r.toolBarDiv;this.get("html");this.el=new t({container:m,doc:r.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html"),showValue:this.get("showValue"),menuContainer:new j(document.body)});this.el.on("click",this._vChange,this);r.on("selectionChange",this._selectionChange,this);x.Utils.sourceDisable(r,this)},disable:function(){this.el.set("state",
t.DISABLED)},enable:function(){this.el.set("state",t.ENABLED)},_vChange:function(r){var m=this.get("editor"),A=r.newVal;r=r.prevVal;var E=this.get("styles");m.focus();m.fire("save");E=E[A];if(A==r){E.remove(m.document);this.el.set("value","")}else E.apply(m.document);m.fire("save")},_selectionChange:function(r){this.get("editor");r=r.path.elements;for(var m=this.get("styles"),A=0,E;A<r.length;A++){E=r[A];for(var D in m)if(m[D].checkElementRemovable(E,true)){this.el.set("value",D);return}}this.el.reset("value")}});
x.FontSelect=y}();l.ready(function(){false!==n["font-size"]&&new x.FontSelect({editor:l,title:"\u5927\u5c0f",width:"30px",showValue:true,popUpWidth:k.width,styles:h,html:q});false!==n["font-family"]&&new x.FontSelect({editor:l,title:"\u5b57\u4f53",width:"110px",popUpWidth:b.width,styles:d,html:i});var y={mode:x.WYSIWYG_MODE,offClick:function(){var t=this.editor,r=this.cfg.style;t.fire("save");r.apply(t.document);t.fire("save");t.notifySelectionChange();t.focus()},onClick:function(){var t=this.editor,r=this.cfg.style;
t.fire("save");r.remove(t.document);t.fire("save");t.notifySelectionChange();t.focus()},selectionChange:function(t){var r=this.btn;this.cfg.style.checkActive(t.path)?r.set("state",s.ON):r.set("state",s.OFF)}};false!==n["font-bold"]&&l.addButton("font-bold",v.mix({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",style:new w({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})},y));false!==n["font-italic"]&&l.addButton("font-italic",v.mix({contentCls:"ke-toolbar-italic",
title:"\u659c\u4f53 ",style:new w({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})},y));false!==n["font-underline"]&&l.addButton("font-underline",v.mix({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",style:new w({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})},y));false!==n["font-strikeThrough"]&&l.addButton("font-underline",v.mix({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",style:new w({element:"del",overrides:[{element:"span",
attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})},y))})});
KISSY.Editor.add("format",function(l){var p=KISSY.Editor,v=KISSY,x=v.Node,w=[],s={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},n={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},j={},k=p.Style,c;for(c in s)if(s[c]){j[s[c]]=new k({element:s[c]});w.push({name:c,value:s[c],attrs:{style:"font-size:"+n[s[c]]}})}p.Format||function(){function f(h){f.superclass.constructor.call(this,h);this._init()}f.ATTRS={editor:{}};var e=p.Select;v.extend(f,v.Base,
{_init:function(){var h=this.get("editor");this.el=new e({container:h.toolBarDiv,value:"",doc:h.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html"),menuContainer:new x(document.body)});this.el.on("click",this._vChange,this);h.on("selectionChange",this._selectionChange,this);p.Utils.sourceDisable(h,this)},disable:function(){this.el.set("state",e.DISABLED)},enable:function(){this.el.set("state",e.ENABLED)},_vChange:function(h){var q=this.get("editor"),
g=h.newVal;h=h.prevVal;q.fire("save");if(g!=h)j[g].apply(q.document);else{j.p.apply(q.document);this.el.set("value","p")}q.fire("save")},_selectionChange:function(h){this.get("editor");h=h.path;for(var q in j)if(j[q].checkActive(h)){this.el.set("value",q);break}}});p.Format=f}();l.ready(function(){new p.Format({editor:l,html:w,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmldataprocessor",function(l){var p=p,v=KISSY,x=v.Editor,w=v.Node,s=v.UA,n=x.NODE,j=x.HtmlParser,k=new j.Filter,c=new j.Filter,f=x.XHTML_DTD;if(!l.htmlDataProcessor){(function(){var e=x.HtmlParser.Fragment.prototype,h=x.HtmlParser.Element.prototype;e.onlyChild=h.onlyChild=function(){var q=this.children;return q.length==1&&q[0]||null};h.removeAnyChildWithName=function(q){for(var g=this.children,b=[],d,i=0;i<g.length;i++){d=g[i];if(d.name){if(d.name==q){b.push(d);g.splice(i--,1)}b=
b.concat(d.removeAnyChildWithName(q))}}return b};h.getAncestor=function(q){for(var g=this.parent;g&&!(g.name&&g.name.match(q));)g=g.parent;return g};e.firstChild=h.firstChild=function(q){for(var g,b=0;b<this.children.length;b++){g=this.children[b];if(q(g))return g;else if(g.name)if(g=g.firstChild(q))return g}return null};h.addStyle=function(q,g,b){var d="";if(typeof g=="string")d+=q+":"+g+";";else{if(typeof q=="object")for(var i in q){if(q.hasOwnProperty(i))d+=i+":"+q[i]+";"}else d+=q;b=g}if(!this.attributes)this.attributes=
{};q=this.attributes.style||"";q=(b?[d,q]:[q,d]).join(";");this.attributes.style=q.replace(/^;|;(?=;)/,"")};f.parentOf=function(q){var g={},b;for(b in this)if(b.indexOf("$")==-1&&this[b][q])g[b]=1;return g}})();(function(){function e(m){if(/mso-list\s*:\s*Ignore/i.test(m.attributes&&m.attributes.style))return true;return p}function h(m,A){var E=new x.HtmlParser.Element("ke:listbullet"),D;if(m)if(m[2]){m=isNaN(m[1])?/^[a-z]+$/.test(m[1])?"lower-alpha":/^[A-Z]+$/.test(m[1])?"upper-alpha":"decimal":
"decimal";D="ol"}else{m=/[l\u00B7\u2002]/.test(m[1])?"disc":/[\u006F\u00D8]/.test(m[1])?"circle":/[\u006E\u25C6]/.test(m[1])?"square":"disc";D="ul"}else{m="decimal";D="ol"}E.attributes={"ke:listtype":D,style:"list-style-type:"+m+";"};E.add(new x.HtmlParser.Text(A));return E}function q(m){var A=m.attributes,E;if((E=m.removeAnyChildWithName("ke:listbullet"))&&E.length&&(E=E[0])){m.name="ke:li";if(A.style)A.style=g([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(D){D=D.split(" ");
D=D[3]||D[1]||D[0];D=parseInt(D,10);if(!i&&o&&D>o)i=D-o;A["ke:margin"]=o=D}]],p)(A.style,m)||"";E=E.attributes;m.addStyle(E.style);v.mix(A,E);return true}return false}function g(m,A){return function(E,D){var u=[];E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(C,F,B){F=F.toLowerCase();F=="font-family"&&(B=B.replace(/["']/g,""));for(var G,M,N,Q=0;Q<m.length;Q++)if(m[Q]){C=m[Q][0];G=m[Q][1];M=m[Q][2];N=m[Q][3];if(F.match(C)&&(!G||B.match(G))){F=N||F;A&&(M=M||B);if(typeof M==
"function")M=M(B,D,F);if(M&&M.push){F=M[0];M=M[1]}typeof M=="string"&&u.push([F,M]);return}}!A&&u.push([F,B])});for(var z=0;z<u.length;z++)u[z]=u[z].join(":");return u.length?u.join(";")+";":false}}function b(m){m=m.children;for(var A,E,D,u,z,C,F,B=0;B<m.length;B++){A=m[B];if("ke:li"==A.name){A.name="li";A=A;E=A.attributes;D=A.attributes["ke:listtype"];u=parseInt(E["ke:indent"],10)||i&&Math.ceil(E["ke:margin"]/i)||1;E.style&&(E.style=g([["list-style-type",D=="ol"?"decimal":"disc"]],p)(E.style)||"");
if(C){if(u>F){C=new x.HtmlParser.Element(D);C.add(A);z.add(C)}else{if(u<F){z=F-u;for(var G;z--&&(G=C.parent);)C=G.parent}C.add(A)}m.splice(B--,1)}else{C=new x.HtmlParser.Element(D);C.add(A);m[B]=C}z=A;F=u}else C=null}i=0}var d=g([[/mso/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i],[/line-height/i],[/display/i,/none/i]],p),i,o=0,y=f.parentOf("ol"),t={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(m){m.filterChildren();
b(m)},elements:{font:function(m){delete m.name},p:function(m){m.filterChildren();if(q(m))return p},$:function(m){var A=m.name||"";A.indexOf(":")!=-1&&A.indexOf("ke")==-1&&delete m.name;var E=m.attributes.style;if(A=="span"&&(!E||!d(E)))delete m.name;if(A in y){m.filterChildren();b(m)}},span:function(m){if(!s.gecko&&e(m.parent))return false;if(!s.gecko&&e(m)){m=(m=m.firstChild(function(E){return E.value||E.name=="img"}))&&(m.value||"l.");var A=m.match(/^([^\s]+?)([.)]?)$/);return h(A,m)}},a:function(m){m=
m.attributes;if(m.href)m._ke_saved_href=m.href}},comment:!s.ie?function(m,A){var E=m.match(/<img.*?>/),D=m.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/);if(D){D=(E=D[1]||E&&"l.")&&E.match(/>([^\s]+?)([.)]?)</);return h(D,E)}if(s.gecko&&E){E=x.HtmlParser.Fragment.FromHtml(E[0]).children[0];(D=(D=(D=A.previous)&&D.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&D[1])&&(E.attributes.src=D);return E}return false}:function(){return false},attributes:{"class":function(m){if(/(^|\s+)ke_/.test(m))return m;
return false},style:function(m){m=d(m);if(!m)return false;return m}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},r={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(m){var A=m.parent;if(A&&A.name=="object"){var E=A.attributes.width;A=A.attributes.height;E&&(m.attributes.width=E);A&&(m.attributes.height=A)}},param:function(m){m.children=[];m.isEmpty=true;return m},a:function(m){if(!(m.children.length||m.attributes.name))return false;m=m.attributes;if(m._ke_saved_href)m.href=
m._ke_saved_href},td:function(m){for(var A=m.children,E=0;E<A.length;E++)if(A[E].name=="br"){A.splice(E,1);--E}if(!m.children.length){A=new x.HtmlParser.Text("&nbsp;");m.children.push(A)}},span:function(m){if(!m.children.length)return false}},attributes:{style:function(m){if(!v.trim(m))return false}},attributeNames:[[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,""]]};if(s.ie)r.attributes.style=function(m){return m.toLowerCase()};k.addRules(r);c.addRules(t)})();(function(){function e(r){for(var m=r.children.length,
A=r.children[m-1];A&&A.type==n.NODE_TEXT&&!v.trim(A.value);)A=r.children[--m];return A}function h(r){var m=e(r);return!m||m.type==n.NODE_ELEMENT&&m.name=="br"||r.name=="form"&&m.name=="input"}function q(r,m){var A=r.children,E=e(r);if(E){if((m||!s.ie)&&E.type==n.NODE_ELEMENT&&E.name=="br")A.pop();E.type==n.NODE_TEXT&&d.test(E.value)&&A.pop()}}function g(r){q(r,true);if(h(r))s.ie?r.add(new x.HtmlParser.Text("\u00a0")):r.add(new x.HtmlParser.Element("br",{}))}function b(r){q(r);h(r)&&r.add(new x.HtmlParser.Text("\u00a0"))}
var d=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=x.XHTML_DTD,o=x.Utils.mix({},i.$block,i.$listItem,i.$tableContent),y;for(y in o)"br"in i[y]||delete o[y];delete o.pre;i={elements:{}};var t={elements:{}};for(y in o){i.elements[y]=g;t.elements[y]=b}c.addRules(i);k.addRules(t)})();(function(){k.addRules({text:function(e){return e.replace(/\xa0/g,"&nbsp;")}})})();l.htmlDataProcessor={htmlFilter:k,dataFilter:c,toHtml:function(e,h){var q=new j.HtmlWriter;j.Fragment.FromHtml(e,h).writeHtml(q,k);return q.getHtml(true)},
toDataFormat:function(e,h){if(s.gecko)e=e.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var q=new w("<div>");q.html("a"+e);e=q.html().substr(1);q=new j.BasicWriter;var g=j.Fragment.FromHtml(e,h);q.reset();g.writeHtml(q,c);return q.getHtml(true)},toServer:function(e,h){var q=new j.BasicWriter;j.Fragment.FromHtml(e,h).writeHtml(q,k);return q.getHtml(true)}}}});
KISSY.Editor.add("image",function(l){var p=KISSY,v=p.Editor,x=p.UA,w=p.Node,s=p.Event,n=v.BubbleView,j=function(k){return k._4e_name()==="img"&&!/(^|\s+)ke_/.test(k[0].className)&&k};l.ready(function(){var k=l.addButton("image",{contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",mode:v.WYSIWYG_MODE,offClick:function(){this.call("show")},_updateTip:function(h,q){var g=q.attr("src");h.html(g);h.attr("href",g)},show:function(h,q){this.editor.useDialog("image/dialog",function(g){g.show(q)})}}),c={"\u56fe\u7247\u5c5e\u6027":function(h){h=
(h=h.getSelection())&&h.getStartElement();(h=j(h))&&k.call("show",null,h)}},f={},e;for(e in c)(function(h){f[h]=function(){c[h](l)}})(e);v.ContextMenu.register({editor:l,rules:[j],width:"120px",funcs:f});s.on(l.document,"dblclick",function(h){var q=new w(h.target);h.halt();j(q)&&k.call("show",null,q)});n.register({pluginName:"image",pluginContext:k,editor:l,func:j,init:function(){var h=this,q=h.get("contentEl");q.html('\u56fe\u7247\u7f51\u5740\uff1a   <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var g=q.one(".ke-bubbleview-url"),b=q.one(".ke-bubbleview-change"),d=q.one(".ke-bubbleview-remove");v.Utils.preventFocus(q);b.on("click",function(i){h._plugin.call("show",null,h._selectedEl);i.halt()});d.on("click",function(i){var o=h._plugin;if(x.webkit){var y=o.editor.getSelection().getRanges();y&&y[0]&&(y[0].collapse(true)||1)&&y[0].select()}h._selectedEl._4e_remove();h.hide();o.editor.notifySelectionChange();i.halt()});h.on("show",function(){var i=h._selectedEl;i&&h._plugin.call("_updateTip",
g,i)})}})})});
KISSY.Editor.add("indent",function(l){var p=KISSY.Editor;l.ready(function(){var v=l.addButton("outdent",{title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",mode:p.WYSIWYG_MODE,contentCls:"ke-toolbar-outdent",type:"outdent",loading:true}),x=l.addButton("indent",{title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",mode:p.WYSIWYG_MODE,contentCls:"ke-toolbar-indent",type:"indent",loading:true});p.use("indent/support",function(){v.reload(p.IndentSupport);x.reload(p.IndentSupport)});l.addCommand("indent",{exec:function(){x.call("offClick")}});l.addCommand("outdent",{exec:function(){v.call("offClick")}})})});
KISSY.Editor.add("indent/support",function(){function l(g){this.type=g;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function p(g){return g[0].nodeType==e.NODE_ELEMENT&&g._4e_name()=="li"}function v(g,b){for(var d=g.startContainer,i=g.endContainer;d&&!d.parent()._4e_equals(b);)d=d.parent();for(;i&&!i.parent()._4e_equals(b);)i=i.parent();if(d&&i){var o=d;d=[];for(var y=false;!y;){if(o._4e_equals(i))y=true;d.push(o);o=o.next()}if(!(d.length<1)){o=b._4e_parents(true);
for(i=0;i<o.length;i++)if(s[o[i]._4e_name()]){b=o[i];break}o=this.type=="indent"?1:-1;i=d[0];y=d[d.length-1];d={};var t=w.ListUtils.listToArray(b,d),r=t[y.data("listarray_index")].indent;for(i=i.data("listarray_index");i<=y.data("listarray_index");i++){t[i].indent+=o;var m=t[i].parent;t[i].parent=new c(m[0].ownerDocument.createElement(m._4e_name()))}for(i=y.data("listarray_index")+1;i<t.length&&t[i].indent>r;i++)t[i].indent+=o;y=w.ListUtils.arrayToList(t,d,null,"p",0);o=[];if(this.type=="outdent"){var A;
if((A=b.parent())&&A._4e_name()=="li"){t=y.listNode.childNodes;var E;for(i=t.length-1;i>=0;i--)if((E=new c(t[i]))&&E._4e_name()=="li")o.push(E)}}if(y){k.insertBefore(y.listNode,b);b._4e_remove()}if(o&&o.length)for(i=0;i<o.length;i++){for(y=E=o[i];(y=y.next())&&y._4e_name()in s;){f.ie&&!E._4e_first(function(D){return h(D)&&q(D)})&&E[0].appendChild(g.document.createTextNode("\u00a0"));E[0].appendChild(y[0])}k.insertAfter(E[0],A[0])}w.Utils.clearAllMarkers(d)}}}function x(g){var b=parseInt(g._4e_style(this.indentCssProperty),
10);if(isNaN(b))b=0;b+=(this.type=="indent"?1:-1)*this.indentOffset;if(b<0)return false;b=Math.max(b,0);b=Math.ceil(b/this.indentOffset)*this.indentOffset;g.css(this.indentCssProperty,b?b+this.indentUnit:"");g[0].style.cssText===""&&g.removeAttr("style");return true}var w=KISSY.Editor,s={ol:1,ul:1},n=KISSY,j=w.Walker,k=n.DOM,c=n.Node,f=n.UA,e=w.NODE,h=j.whitespaces(true),q=j.bookmark(false,true);n.augment(l,{exec:function(g){for(var b=(g=g.getSelection())&&g.getRanges()[0],d=b.startContainer,i=b.endContainer,
o=b.getCommonAncestor();o&&!(o[0].nodeType==e.NODE_ELEMENT&&s[o._4e_name()]);)o=o.parent();if(o&&d[0].nodeType==e.NODE_ELEMENT&&d._4e_name()in s){d=new j(b);d.evaluator=p;b.startContainer=d.next()}if(o&&i[0].nodeType==e.NODE_ELEMENT&&i._4e_name()in s){d=new j(b);d.evaluator=p;b.endContainer=d.previous()}i=g.createBookmarks(true);if(o){for(d=o._4e_first();d&&d._4e_name()!="li";)d=d.next();var y=b.startContainer;(d[0]==y[0]||d.contains(y))&&x.call(this,o)||v.call(this,b,o)}else{b=b.createIterator();
b.enforceRealBlocks=true;for(b.enlargeBr=true;o=b.getNextParagraph();)x.call(this,o)}g.selectBookmarks(i)}});w.IndentSupport={init:function(){this.indentCommand=new l(this.cfg.type)},offClick:function(){var g=this,b=g.editor;b.fire("save");setTimeout(function(){g.indentCommand.exec(b);b.fire("save");b.notifySelectionChange()},10)},selectionChange:function(g){if(this.cfg.type=="outdent"){var b=g.path,d=b.blockLimit;g=this.btn;if(b.contains(s))g.boff();else(b=b.block||d)&&b._4e_style(this.indentCommand.indentCssProperty)?
g.boff():g.disable()}}}});
KISSY.Editor.add("justify",function(l){var p=KISSY,v=p.Editor,x=v.TripleButton,w=/(-moz-|-webkit-|start|auto)/gi;l.ready(function(){var s={mode:v.WYSIWYG_MODE,offClick:function(){this.call("_change")},onClick:function(){this.call("_change")},_change:function(){var n=this.editor,j=n.getSelection(),k=this.btn.get("state");if(j){var c=j.createBookmarks(),f=j.getRanges(),e,h;n.fire("save");for(var q=f.length-1;q>=0;q--){e=f[q].createIterator();for(e.enlargeBr=true;h=e.getNextParagraph();){h.removeAttr("align");k==
x.OFF?h.css("text-align",this.cfg.v):h.css("text-align","")}}n.notifySelectionChange();j.selectBookmarks(c);n.fire("save")}},selectionChange:function(n){var j=this.btn;n=n.path;n=n.block||n.blockLimit;if(!n||n._4e_name()==="body")j.boff();else(n.css("text-align").replace(w,"")||"left")==this.cfg.v?j.bon():j.boff()}};l.addButton("alignleft",p.mix({contentCls:"ke-toolbar-alignleft",title:"\u5de6\u5bf9\u9f50",v:"left"},s));l.addButton("aligncenter",p.mix({contentCls:"ke-toolbar-aligncenter",title:"\u5c45\u4e2d\u5bf9\u9f50",v:"center"},
s));l.addButton("alignright",p.mix({contentCls:"ke-toolbar-alignright",title:"\u53f3\u5bf9\u9f50",v:"right"},s))})});
KISSY.Editor.add("link",function(l){function p(n){return n._4e_ascendant(function(j){return j._4e_name()==="a"&&!!j.attr("href")},true)}var v=KISSY.Editor,x=v.Style,w=v.BubbleView,s={element:"a",attributes:{href:"#(href)",title:"#(title)",_ke_saved_href:"#(_ke_saved_href)",target:"#(target)"}};l.ready(function(){var n=l.addButton("link",{contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5",mode:v.WYSIWYG_MODE,_getSelectedLink:function(){var j=this.editor.getSelection();if(j=j&&j.getStartElement())j=p(j);return j},
_getSelectionLinkUrl:function(){var j=this.cfg._getSelectedLink.call(this);if(j)return j.attr("_ke_saved_href")||j.attr("href")},_removeLink:function(j){var k=this.editor;k.fire("save");var c=k.getSelection(),f=c.getRanges()[0];if(f&&f.collapsed){f=c.createBookmarks();j._4e_remove(true);c.selectBookmarks(f)}else if(f){j=j[0];c=j.attributes;f={};for(var e=0;e<c.length;e++){var h=c[e];if(h.specified)f[h.name]=h.value}if(j.style.cssText)f.style=j.style.cssText;(new x(s,f)).remove(k.document)}k.fire("save");
k.notifySelectionChange()},_link:function(j){var k=this.editor,c=this.cfg._getSelectedLink.call(this);j._ke_saved_href=j.href;if(c){k.fire("save");c.attr(j);k.fire("save")}else{c=(c=k.getSelection())&&c.getRanges()[0];if(!c||c.collapsed){a=new Node("<a>"+url+"</a>",j,k.document);k.insertElement(a)}else{k.fire("save");(new x(s,j)).apply(k.document);k.fire("save")}}k.notifySelectionChange()},offClick:function(){var j=this;j.editor.useDialog("link/dialog",function(k){k.show(j)})}});w.register({pluginName:"link",
editor:l,pluginContext:n,func:p,init:function(){var j=this,k=j.get("contentEl");k.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');var c=k.one(".ke-bubbleview-url"),f=k.one(".ke-bubbleview-change"),e=k.one(".ke-bubbleview-remove");v.Utils.preventFocus(k);f.on("click",function(h){j._plugin.call("offClick");h.halt()});e.on("click",function(h){j._plugin.call("_removeLink",
j._selectedEl);h.halt()});j.on("show",function(){var h=j._selectedEl;if(h){h=h.attr("_ke_saved_href")||h.attr("href");c.html(h);c.attr("href",h)}})}})})});KISSY.Editor.add("list",function(l){var p=KISSY.Editor;l.ready(function(){var v=l.addButton("ul",{title:"\u9879\u76ee\u5217\u8868",mode:p.WYSIWYG_MODE,contentCls:"ke-toolbar-ul",loading:true,type:"ul"}),x=l.addButton("ol",{title:"\u7f16\u53f7\u5217\u8868",mode:p.WYSIWYG_MODE,contentCls:"ke-toolbar-ol",loading:true,type:"ol"});p.use("list/support",function(){v.reload(p.ListSupport);x.reload(p.ListSupport)})})});
KISSY.Editor.add("list/support",function(){function l(g){this.type=g}var p=KISSY.Editor,v={ol:1,ul:1},x=["ol","ul"],w=KISSY,s=p.RANGE,n=p.ElementPath,j=p.Walker,k=p.NODE,c=w.UA,f=w.Node,e=w.DOM,h={listToArray:function(g,b,d,i,o){if(!v[g._4e_name()])return[];i||(i=0);d||(d=[]);for(var y=0,t=g[0].childNodes.length;y<t;y++){var r=new f(g[0].childNodes[y]);if(r._4e_name()=="li"){var m={parent:g,indent:i,element:r,contents:[]};if(o)m.grandparent=o;else{m.grandparent=g.parent();if(m.grandparent&&m.grandparent._4e_name()==
"li")m.grandparent=m.grandparent.parent()}b&&r._4e_setMarker(b,"listarray_index",d.length);d.push(m);for(var A=0,E=r[0].childNodes.length,D;A<E;A++){D=new f(r[0].childNodes[A]);D[0].nodeType==k.NODE_ELEMENT&&v[D._4e_name()]?h.listToArray(D,b,d,i+1,m.grandparent):m.contents.push(D)}}}return d},arrayToList:function(g,b,d,i){d||(d=0);if(!g||g.length<d+1)return null;for(var o=g[d].parent[0].ownerDocument,y=o.createDocumentFragment(),t=null,r=d,m=Math.max(g[d].indent,0),A=null;;){var E=g[r];if(E.indent==
m){if(!t||g[r].parent._4e_name()!=t._4e_name()){t=g[r].parent._4e_clone(false,true);y.appendChild(t[0])}A=t[0].appendChild(E.element._4e_clone(false,true)[0]);for(var D=0;D<E.contents.length;D++)A.appendChild(E.contents[D]._4e_clone(true,true)[0]);r++}else if(E.indent==Math.max(m,0)+1){r=h.arrayToList(g,null,r,i);A.appendChild(r.listNode);r=r.nextIndex}else if(E.indent==-1&&!d&&E.grandparent){if(v[E.grandparent._4e_name()])A=E.element._4e_clone(false,true)[0];else if(E.grandparent._4e_name()!="td"){A=
o.createElement(i);E.element._4e_copyAttributes(new f(A))}else A=o.createDocumentFragment();for(D=0;D<E.contents.length;D++){t=E.contents[D]._4e_clone(true,true);A.nodeType==k.NODE_DOCUMENT_FRAGMENT&&E.element._4e_copyAttributes(new f(t));A.appendChild(t[0])}if(A.nodeType==k.NODE_DOCUMENT_FRAGMENT&&r!=g.length-1){A.lastChild&&A.lastChild.nodeType==k.NODE_ELEMENT&&A.lastChild.getAttribute("type")=="_moz"&&e._4e_remove(A.lastChild);e._4e_appendBogus(A)}if(A.nodeType==k.NODE_ELEMENT&&e._4e_name(A)==
i&&A.firstChild){e._4e_trim(A);t=A.firstChild;if(t.nodeType==k.NODE_ELEMENT&&e._4e_isBlockBoundary(t)){t=o.createDocumentFragment();e._4e_moveChildren(A,t);A=t}}t=e._4e_name(A);if(!c.ie&&(t=="div"||t=="p"))e._4e_appendBogus(A);y.appendChild(A);t=null;r++}else return null;if(g.length<=r||Math.max(g[r].indent,0)<m)break}if(b)for(g=new f(y.firstChild);g&&g[0];){g[0].nodeType==k.NODE_ELEMENT&&g._4e_clearMarkers(b,true);g=g._4e_nextSourceNode()}return{listNode:y,nextIndex:r}}},q=/^h[1-6]$/;l.prototype=
{changeListType:function(g,b,d,i){var o=h.listToArray(b.root,d),y=[];for(g=0;g<b.contents.length;g++){var t=b.contents[g];t=t._4e_ascendant("li",true);if(!(!t||!t[0]||t.data("list_item_processed"))){y.push(t);t._4e_setMarker(d,"list_item_processed",true)}}t=new f(b.root[0].ownerDocument.createElement(this.type));for(g=0;g<y.length;g++){var r=y[g].data("listarray_index");o[r].parent=t}d=h.arrayToList(o,d,null,"p");var m;o=d.listNode.childNodes.length;for(g=0;g<o&&(m=new f(d.listNode.childNodes[g]));g++)m._4e_name()==
this.type&&i.push(m);e.insertBefore(d.listNode,b.root);b.root._4e_remove()},createList:function(g,b,d){var i=b.contents;g=b.root[0].ownerDocument;var o=[];if(i.length==1&&i[0][0]===b.root[0]){var y=new f(g.createElement("div"));i[0][0].nodeType!=k.NODE_TEXT&&i[0]._4e_moveChildren(y);i[0][0].appendChild(y[0]);i[0]=y}b=b.contents[0].parent();for(y=0;y<i.length;y++)b=b._4e_commonAncestor(i[y].parent());for(y=0;y<i.length;y++)for(var t=i[y],r;r=t.parent();){if(r[0]===b[0]){o.push(t);break}t=r}if(!(o.length<
1)){i=new f(o[o.length-1][0].nextSibling);y=new f(g.createElement(this.type));for(d.push(y);o.length;){d=o.shift();t=new f(g.createElement("li"));if(q.test(d._4e_name()))t[0].appendChild(d[0]);else{d._4e_copyAttributes(t);d._4e_moveChildren(t);d._4e_remove()}y[0].appendChild(t[0]);c.ie||t._4e_appendBogus()}i[0]?e.insertBefore(y,i):b.append(y)}},removeList:function(g,b,d){function i(D){if((A=new f(m[D?"firstChild":"lastChild"]))&&!(A[0].nodeType==k.NODE_ELEMENT&&A._4e_isBlockBoundary())&&(E=b.root[D?
"_4e_previous":"_4e_next"](j.whitespaces(true)))&&!(A[0].nodeType==k.NODE_ELEMENT&&E._4e_isBlockBoundary({br:1})))e[D?"insertBefore":"insertAfter"](g.document.createElement("br"),A)}for(var o=h.listToArray(b.root,d),y=[],t=0;t<b.contents.length;t++){var r=b.contents[t];r=r._4e_ascendant("li",true);if(!(!r||r.data("list_item_processed"))){y.push(r);r._4e_setMarker(d,"list_item_processed",true)}}r=null;for(t=0;t<y.length;t++){r=y[t].data("listarray_index");o[r].indent=-1;r=r}for(t=r+1;t<o.length;t++)if(o[t].indent>
Math.max(o[t-1].indent,0)){y=o[t-1].indent+1-o[t].indent;for(r=o[t].indent;o[t]&&o[t].indent>=r;){o[t].indent+=y;t++}t--}var m=h.arrayToList(o,d,null,"p").listNode,A,E;i(true);i(undefined);e.insertBefore(m,b.root);b.root._4e_remove()},exec:function(g){var b=g.getSelection(),d=b&&b.getRanges();if(!(!d||d.length<1)){for(var i=b.createBookmarks(true),o=[],y={};d.length>0;){var t=d.shift(),r=t.getBoundaryNodes(),m=r.startNode,A=r.endNode;m[0].nodeType==k.NODE_ELEMENT&&m._4e_name()=="td"&&t.setStartAt(r.startNode,
s.POSITION_AFTER_START);A[0].nodeType==k.NODE_ELEMENT&&A._4e_name()=="td"&&t.setEndAt(r.endNode,s.POSITION_BEFORE_END);t=t.createIterator();for(t.forceBrBreak=false;r=t.getNextParagraph();)if(!r.data("list_block")){r._4e_setMarker(y,"list_block",1);A=new n(r);var E=A.elements,D=null,u=false,z=A.blockLimit,C;for(m=E.length-1;m>=0&&(C=E[m]);m--)if(v[C._4e_name()]&&z.contains(C)){z.removeData("list_group_object");if(m=C.data("list_group_object"))m.contents.push(r);else{m={root:C,contents:[r]};o.push(m);
C._4e_setMarker(y,"list_group_object",m)}u=true;break}if(!u){A=z||A.block;if(A.data("list_group_object"))A.data("list_group_object").contents.push(r);else{m={root:A,contents:[r]};A._4e_setMarker(y,"list_group_object",m);o.push(m)}}}}for(d=[];o.length>0;){m=o.shift();if(this.state=="off")if(v[m.root._4e_name()])this.changeListType(g,m,y,d);else{p.Utils.clearAllMarkers(y);this.createList(g,m,d)}else this.state=="on"&&v[m.root._4e_name()]&&this.removeList(g,m,y)}for(m=0;m<d.length;m++){D=d[m];var F=
this;(g=function(B){var G=D[B?"_4e_previous":"_4e_next"](j.whitespaces(true));if(G&&G[0]&&G._4e_name()==F.type){G._4e_remove();G._4e_moveChildren(D,B?true:false)}})();g(true)}p.Utils.clearAllMarkers(y);b.selectBookmarks(i)}}};p.ListUtils=h;p.ListSupport={init:function(){this.listCommand=new l(this.cfg.type)},selectionChange:function(g){var b=this.cfg.type,d=g.path,i;g=this.btn;var o=d.blockLimit;d=d.elements;if(o){if(d)for(var y=0;y<d.length&&(i=d[y])&&i[0]!==o[0];y++){var t=w.indexOf(d[y]._4e_name(),
x);if(t!==-1)if(x[t]===b){g.bon();return}else break}g.boff()}},offClick:function(){this.call("_change")},onClick:function(){this.call("_change")},_change:function(){var g=this.editor,b=this.btn;g.fire("save");this.listCommand.state=b.get("state");this.listCommand.exec(g);g.fire("save");g.notifySelectionChange()}}});
KISSY.Editor.add("localstorage",function(){var l=KISSY,p=l.Editor,v;v=p.STORE="localStorage";if(!p.storeReady){p.storeReady=function(w){p.on("storeReady",w)};p.on("storeReady",function(){p.storeReady=function(w){w()};p.detach("storeReady")})}if(window[v])window[v]._ke||p.fire("storeReady");else{var x=p.Config.base+p.Utils.debugUrl("plugins/localstorage/swfstore.swf?rand="+ +new Date);window[v]=new p.FlashBridge({movie:x,methods:["setItem","removeItem","getValueOf"]});l.mix(window[v],{_ke:1,getItem:function(w){return this.getValueOf(w)}});
window[v].on("contentReady",function(){p.fire("storeReady")})}});KISSY.Editor.add("maximize",function(l){var p=KISSY,v=p.Editor;p.UA.gecko<1.92||l.ready(function(){var x=l.addButton("maximize",{title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize",loading:true});v.use("maximize/support",function(){x.reload(v.Maximize)})})});
KISSY.Editor.add("maximize/support",function(){var l=KISSY.Editor,p=KISSY,v=p.UA,x=p.Node,w=p.Event,s=p.DOM,n;s.addStyleSheet(".ke-toolbar-padding {padding:5px;}","ke-maximize");var j={};p.mix(j,{onClick:function(){var k=this,c=k.editor;k._resize&&w.remove(window,"resize",k._resize);k.call("_saveEditorStatus");k.call("_restoreState");k.btn.boff();setTimeout(function(){k.call("_restoreEditorStatus");c.notifySelectionChange();c.fire("restoreWindow")},30)},_restoreState:function(){var k=document,c=this.editor,
f=this._savedParents;if(f){for(var e=0;e<f.length;e++){var h=f[e];h.el.css("position",h.position)}this._savedParents=null}c.wrap.css({height:this.iframeHeight});s.css(k.body,{width:"",height:"",overflow:""});k.documentElement.style.overflow="";c.editorWrap.css({position:"static",width:this.editorWrapWidth});n.css({left:"-99999px",top:"-99999px"});window.scrollTo(this.scrollLeft,this.scrollTop);k=this.btn.get("el");k.one("span").removeClass("ke-toolbar-restore").addClass("ke-toolbar-maximize");k.attr("title",
"\u5168\u5c4f");v.ie<8&&this.editor.toolBarDiv.removeClass("ke-toolbar-padding")},_saveSate:function(){var k=this.editor,c=[],f=k.editorWrap;this.iframeHeight=k.wrap._4e_style("height");this.editorWrapWidth=f._4e_style("width");this.scrollLeft=s.scrollLeft();this.scrollTop=s.scrollTop();window.scrollTo(0,0);for(k=f.parent();k;){f=k.css("position");if(f!="static"){c.push({el:k,position:f});k.css("position","static")}k=k.parent()}this._savedParents=c;c=this.btn.get("el");c.one("span").removeClass("ke-toolbar-maximize").addClass("ke-toolbar-restore");
c.attr("title","\u53d6\u6d88\u5168\u5c4f");v.ie<8&&this.editor.toolBarDiv.addClass("ke-toolbar-padding")},_saveEditorStatus:function(){var k=this.editor;this.savedRanges=null;if(v.gecko&&k.iframeFocus)this.savedRanges=(k=k.getSelection())&&k.getRanges()},_restoreEditorStatus:function(){var k=this.editor,c=k.getSelection(),f=this.savedRanges;k.activateGecko();f&&c&&c.selectRanges(f);if(k.iframeFocus&&c)(k=c.getStartElement())&&k[0]&&k._4e_scrollIntoView();v.ie<8&&this.btn.get("el").one("span").css("background-image",
"")},_maximize:function(k){var c=document,f=this.editor,e=f.editorWrap,h=s.viewportHeight(),q=s.viewportWidth(),g=f.statusDiv?f.statusDiv[0].offsetHeight:0,b=f.toolBarDiv[0].offsetHeight;if(v.ie)c.body.style.overflow="hidden";else s.css(c.body,{width:0,height:0,overflow:"hidden"});c.documentElement.style.overflow="hidden";e.css({position:"absolute",zIndex:f.baseZIndex(l.zIndexManager.MAXIMIZE),width:q+"px"});n.css({zIndex:f.baseZIndex(l.zIndexManager.MAXIMIZE-5),height:h+"px",width:q+"px"});e.offset({left:0,
top:0});n.css({left:0,top:0});f.wrap.css({height:h-g-b+"px"});k!==true&&arguments.callee.call(this,true)},_real:function(){var k=this,c=k.editor;k.call("_saveEditorStatus");k.call("_saveSate");k.call("_maximize");k._resize=k._resize||l.Utils.buffer(k.cfg._maximize,k,100);w.on(window,"resize",k._resize);k.btn.bon();setTimeout(function(){k.call("_restoreEditorStatus");c.notifySelectionChange();c.fire("maximizeWindow")},30)},offClick:function(){n||(n=(new x("<iframe  class='ke-maximize-shim' style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'>")).prependTo(document.body));
this.call("_real")}});l.Maximize=j});
KISSY.Editor.add("music",function(l){var p=KISSY.Editor,v=l.htmlDataProcessor,x=v&&v.dataFilter;l.ready(function(){x&&x.addRules({elements:{object:function(w){var s=w.attributes;if(!(s.classid&&String(s.classid).toLowerCase())){for(s=0;s<w.children.length;s++)if(w.children[s].name=="embed"){if(!p.Utils.isFlashEmbed(w.children[s]))break;if(w.children[s].attributes.src.indexOf("niftyplayer.swf")!=-1)return v.createFakeParserElement(w,"ke_music","music",true)}return null}for(s=0;s<w.children.length;s++){var n=
w.children[s];if(n.name=="param"&&n.attributes.name=="movie")if(n.attributes.value.indexOf("niftyplayer.swf")!=-1)return v.createFakeParserElement(w,"ke_music","music",true)}},embed:function(w){if(!p.Utils.isFlashEmbed(w))return null;if(w.attributes.src.indexOf("niftyplayer.swf")!=-1)return v.createFakeParserElement(w,"ke_music","music",true)}}},4);p.use("music/support",function(){new p.MusicInserter(l)})})});
KISSY.Editor.add("music/support",function(){function l(f){l.superclass.constructor.apply(this,arguments);f.cfg.disableObjectResizing||w.on(f.document.body,n.ie?"resizestart":"resize",function(e){(new v.Node(e.target)).hasClass(j)&&e.preventDefault()})}function p(f){return f._4e_name()==="img"&&!!f.hasClass(j)&&f}var v=KISSY,x=v.Editor,w=v.Event,s=x.Flash,n=v.UA,j="ke_music",k=["img."+j];v.extend(l,s,{_config:function(){this._cls=j;this._type="music";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";
this._contextMenu=c;this._flashRules=k}});s.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",p);x.MusicInserter=l;var c={"\u97f3\u4e50\u5c5e\u6027":function(f){var e=f.editor.getSelection();(e=(e=e&&e.getStartElement())&&p(e))&&f.show(null,e)}}});
KISSY.Editor.add("ext-focus",function(){function l(){p.log("FocusExt init")}var p=KISSY,v=p.UA,x=p.Editor,w=x.focusManager;x.namespace("UIBase");l.ATTRS={focus4e:{value:true}};l.prototype={_uiSetFocus4e:function(s){if(s){this.on("show",this._show4FocusExt,this);this.on("hide",this._hide4FocusExt,this)}else{this.detach("show",this._show4FocusExt,this);this.detach("hide",this._hide4FocusExt,this)}},__syncUI:function(){p.log("_syncUIFocusExt")},__renderUI:function(){p.log("_renderUIFocusExt")},__bindUI:function(){this._focus4e=
(new p.Node("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.get("el"))},_show4FocusExt:function(){var s=this._focusEditor=w.currentInstance();window.focus();document.body.focus();this._focus4e[0].focus();if(v.ie&&s){var n=s.document.selection.createRange();if(n)if(n.item&&n.item(0).ownerDocument==s.document){s=document.body.createTextRange();s.moveToElementText(this.get("el")._4e_first()[0]);s.collapse(true);
s.select()}}},_hide4FocusExt:function(){var s=this._focusEditor;s&&s.focus()}};x.UIBase.Focus=l},{host:"overlay"});
KISSY.Editor.add("overlay",function(){var l=KISSY,p=l.Editor;if(!p.Overlay){var v=l.UIBase.create(l.Overlay,[p.UIBase.Focus],{init:function(){l.log("Overlay4E init")},syncUI:function(){l.log("_syncUIOverlay4E");p.Utils.preventFocus(this.get("contentEl"))}},{ATTRS:{zIndex:{value:p.baseZIndex(p.zIndexManager.OVERLAY)}}}),x=l.UIBase.create(l.Dialog,[p.UIBase.Focus],{show:function(){this.center();var s=this.get("y");if(s-l.DOM.scrollTop()>200){s=l.DOM.scrollTop()+200;this.set("y",s)}x.superclass.show.call(this)}},
{ATTRS:{constrain:{value:true},zIndex:{value:p.baseZIndex(p.zIndexManager.OVERLAY)}}});p.Overlay=v;p.Dialog=x;var w;p.Overlay.loading=function(){w||(w=new p.Overlay({x:0,focus4e:false,width:l.UA.ie==6?l.DOM.docWidth():"100%",y:0,zIndex:p.baseZIndex(p.zIndexManager.LOADING),elCls:"ke-global-loading"}));w.set("height",l.DOM.docHeight());w.show();w.loading()};p.Overlay.unloading=function(){w&&w.hide()}}});
KISSY.Editor.add("pagebreak",function(l){var p=KISSY,v=p.Editor,x=p.Node,w=l.htmlDataProcessor;(p=w&&w.dataFilter)&&p.addRules({elements:{div:function(s){var n=s.attributes;var j=(n=n&&n.style)&&s.children.length==1&&s.children[0];if((j=j&&j.name=="span"&&j.attributes.style)&&/page-break-after\s*:\s*always/i.test(n)&&/display\s*:\s*none/i.test(j))return w.createFakeParserElement(s,"ke_pagebreak","div")}}});l.ready(function(){l.addButton("page-break",{title:"\u5206\u9875",mode:v.WYSIWYG_MODE,contentCls:"ke-toolbar-pagebreak",
offClick:function(){var s=this.editor,n=new x('<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>',null,s.document);n=s.createFakeElement?s.createFakeElement(n,"ke_pagebreak","div",true,'<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>'):n;n=(new x("<div>",null,s.document)).append(n);s.insertElement(n)}})})});
KISSY.Editor.add("preview",function(l){l.ready(function(){l.addButton("preview",{title:"\u9884\u89c8",contentCls:"ke-toolbar-preview",offClick:function(){var p=this.editor,v=640,x=420,w=80;try{var s=window.screen;v=Math.round(s.width*0.8);x=Math.round(s.height*0.7);w=Math.round(s.width*0.1)}catch(n){}p=p._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+p.getData(true)+"\n</body>").replace(/\${title}/,"\u9884\u89c8");v=window.open("","","toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+
v+",height="+x+",left="+w);x=v.document;x.open();x.write(p);x.close();v.focus()}})})});
KISSY.Editor.add("progressbar",function(){function l(){l.superclass.constructor.apply(this,arguments);this._init()}var p=KISSY,v=p.Editor;if(!v.ProgressBar){var x=p.Node;p.DOM.addStyleSheet(".ke-progressbar {border:1px solid #D6DEE6;position:relative;margin-left:auto;margin-right:auto;background-color: #EAEFF4;background: -webkit-gradient(linear, left top, left bottom, from(#EAEFF4), .to(#EBF0F3)); background: -moz-linear-gradient(top, #EAEFF4, #EBF0F3);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#EAEFF4', endColorstr = '#EBF0F3');}.ke-progressbar-inner {border:1px solid #3571B4;background-color:#6FA5DB;padding:1px;}.ke-progressbar-inner-bg {height:100%;background-color: #73B1E9;background: -webkit-gradient(linear, left top, left bottom, from(#73B1E9), .to(#3F81C8)); background: -moz-linear-gradient(top, #73B1E9, #3F81C8);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#73B1E9', endColorstr = '#3F81C8');}.ke-progressbar-title {width:30px;top:0;left:40%;line-height:1.2;position:absolute;}","ke_progressbar");
l.ATTRS={container:{},width:{},height:{},progress:{value:0}};p.extend(l,p.Base,{destroy:function(){this.detach();this.el._4e_remove()},_init:function(){var w=this.get("height"),s=new x("<div class='ke-progressbar'  style='width:"+this.get("width")+";height:"+w+";'></div>"),n=this.get("container");w=(new x("<div style='overflow:hidden;'><div class='ke-progressbar-inner' style='height:"+(parseInt(w)-4)+"px'><div class='ke-progressbar-inner-bg'></div></div></div>")).appendTo(s);var j=(new x("<span class='ke-progressbar-title'>")).appendTo(s);
n&&s.appendTo(n);this.el=s;this._title=j;this._p=w;this.on("afterProgressChange",this._progressChange,this);this._progressChange({newVal:this.get("progress")})},_progressChange:function(w){w=w.newVal;this._p.css("width",w+"%");this._title.html(w+"%")}});v.ProgressBar=l}});
KISSY.Editor.add("removeformat",function(l){function p(k,c){for(var f=0;f<c.length;f++)k.removeAttr(c[f])}var v=KISSY.Editor,x=v.RANGE,w=v.ElementPath,s=v.NODE,n="class,style,lang,width,height,align,hspace,valign".split(/,/),j=RegExp("^(?:"+"b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s".replace(/,/g,"|")+")$","i");l.ready(function(){l.addButton("removeformat",{title:"\u6e05\u9664\u683c\u5f0f",mode:v.WYSIWYG_MODE,contentCls:"ke-toolbar-removeformat",offClick:function(){var k=
this.editor;j.lastIndex=0;var c=k.getSelection().getRanges();k.fire("save");for(var f=0,e;e=c[f];f++)if(!e.collapsed){e.enlarge(x.ENLARGE_ELEMENT);var h=e.createBookmark(),q=h.startNode,g=h.endNode,b=function(d){for(var i=new w(d),o=i.elements,y=1,t;t=o[y];y++){if(t._4e_equals(i.block)||t._4e_equals(i.blockLimit))break;j.test(t._4e_name())&&d._4e_breakParent(t)}};b(q);b(g);for(q=q._4e_nextSourceNode(true,s.NODE_ELEMENT);q;){if(q._4e_equals(g))break;b=q._4e_nextSourceNode(false,s.NODE_ELEMENT);q._4e_name()==
"img"&&q.attr("_ke_realelement")||(j.test(q._4e_name())?q._4e_remove(true):p(q,n));q=b}e.moveToBookmark(h)}k.getSelection().selectRanges(c);k.fire("save")}})})});
KISSY.Editor.add("resize",function(l){var p=KISSY,v=p.Node;l.ready(function(){p.use("dd",function(){var x=p.Draggable,w=l.statusDiv,s=new v("<div class='ke-resizer'>"),n=l.cfg.pluginConfig.resize||{};n=n.direction||["x","y"];s.appendTo(w);l.on("maximizeWindow",function(){s.css("display","none")});l.on("restoreWindow",function(){s.css("display","")});x=new x({node:s});var j=0,k=0,c=l.wrap,f=l.editorWrap;x.on("dragstart",function(){j=c.height();k=f.width()});x.on("drag",function(e){var h=e.left-this.startNodePos.left;
e=e.top-this.startNodePos.top;p.inArray("y",n)&&c.height(j+e);p.inArray("x",n)&&f.width(k+h)})})})});
KISSY.Editor.add("select",function(){function l(j){l.superclass.constructor.call(this,j);this._init()}var p=KISSY,v=p.Node,x=p.Event,w=p.DOM,s=p.Editor;if(!s.Select){l.DISABLED=0;l.ENABLED=1;var n=s.XHTML_DTD;l.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var j=this.el.parent();j;){var k=j._4e_name();if(n[k]&&n[k].div)return j;j=j.parent()}return new v(document.body)}},state:{value:1}};l.decorate=
function(j){for(var k=j.width(),c=[],f=j.all("option"),e=0;e<f.length;e++){var h=f[e];c.push({name:w.html(h),value:w.attr(h,"value")})}return new l({width:k+"px",el:j,items:c,cls:"ke-combox",value:j.val()})};p.extend(l,p.Base,{_init:function(){var j=this.get("container"),k=this.get("el"),c=new v("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
f=this.get("title")||"",e=this.get("cls"),h=c.one(".ke-select-text"),q=c.one(".ke-select-text-inner");c.one(".ke-select-drop");this.get("value")!==undefined?q.html(this._findNameByV(this.get("value"))):q.html(f);h.css("width",this.get("width"));c._4e_unselectable();f&&c.attr("title",f);e&&c.addClass(e);if(k)k[0].parentNode.replaceChild(c[0],k[0]);else j&&c.appendTo(j);c.on("click",this._click,this);this.el=c;this.title=q;this._focusA=c.one("a.ke-select");s.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",
this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_findNameByV:function(j){var k=this.get("title")||"",c=this.get("items");if(this.get("showValue"))return j||k;for(var f=0;f<c.length;f++){var e=c[f];if(e.value==j){k=e.name;break}}return k},_valueChange:function(j){this.title.html(this._findNameByV(j.newVal))},_itemsChange:function(j){j=j.newVal;var k=this._selectList;k.html("");if(j)for(var c=0;c<j.length;c++){var f=j[c];(new v("<a class='ke-select-menu-item' href='#' data-value='"+
f.value+"'>"+f.name+"</a>",f.attrs)).appendTo(k)._4e_unselectable()}this.as=k.all("a")},val:function(j){if(j!==undefined){this.set("value",j);return this}else return this.get("value")},_resize:function(){this.menu.get("visible")&&this._real()},_prepare:function(){var j=this,k=j.el,c=j.get("popUpWidth"),f=j._focusA,e=new s.Overlay({autoRender:true,render:j.get("menuContainer"),content:"<div>",focus4e:false,elCls:"ke-menu",width:c?c:k.width(),zIndex:s.baseZIndex(s.zIndexManager.SELECT),focusMgr:false}),
h=j.get("items");c=e.get("contentEl").one("div");j.menu=e;x.on(window,"resize",j._resize,j);j.get("title")&&(new v("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+j.get("title")+"</div>")).appendTo(c);j._selectList=(new v("<div>")).appendTo(c);j._itemsChange({newVal:h});e.on("show",function(){f.addClass("ke-select-active")});e.on("hide",function(){f.removeClass("ke-select-active")});x.on([document,j.get("doc")],"click",function(q){k.contains(q.target)||e.hide()});c.on("click",
j._select,j);j.as=j._selectList.all("a");x.on(c[0],"mouseenter",function(){j.as.removeClass("ke-menu-selected")});j.on("afterItemsChange",j._itemsChange,j);j.menuNode=c},_stateChange:function(j){var k=this.el;j.newVal==1?k.removeClass("ke-select-disabled"):k.addClass("ke-select-disabled")},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(j){j.halt();var k=this.menu,c=this.menuNode;if(j=(new v(j.target))._4e_ascendant(function(h){return c.contains(h)&&
h._4e_name()=="a"},true)){var f=this.get("value"),e=j.attr("data-value");this.set("value",e);this.fire("click",{newVal:e,prevVal:f,name:j.html()});k.hide()}},_real:function(){var j=this.el,k=j.offset(),c=p.clone(k),f=this.menu.get("el").height(),e=this.menu.get("el").width(),h=w.scrollTop(),q=w.scrollLeft(),g=w.viewportHeight(),b=w.viewportWidth();b=q+b-60;g=h+g;var d=k.top+(j.height()-2);j=k.left+j.width()-2;var i=this.get("align"),o=i[0];if(i[1]=="b"){k.top=d;if(k.top+f>g&&c.top-h>g-d)k.top=c.top-
f}else{k.top=c.top-f;if(k.top<h&&c.top-h<g-d)k.top=d}if(o=="l"){if(k.left+e>b&&j-q>b-c.left)k.left=j-e}else{k.left=j-e;if(k.left<q&&j-q<b-c.left)k.left=c.left}this.menu.set("xy",[k.left,k.top]);this.menu.show()},_click:function(j){j.preventDefault();j=this.el;var k=this.get("value");if(!j.hasClass("ke-select-disabled"))if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();k&&this.menu&&this.as.each(function(c){c.attr("data-value")==k?c.addClass("ke-menu-selected"):c.removeClass("ke-menu-selected")})}}});
s.Select=l}});KISSY.Editor.add("separator",function(l){l.ready(function(){(new KISSY.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(l.toolBarDiv)})});KISSY.Editor.add("smiley",function(l){var p=KISSY.Editor;l.ready(function(){var v=l.addButton("smiley",{contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",mode:p.WYSIWYG_MODE,loading:true});p.use("smiley/support",function(){v.reload(p.SmileySupport)})})});
KISSY.Editor.add("smiley/support",function(){var l=KISSY,p=l.Event,v=l.Editor,x=l.DOM;x.addStyleSheet('.ke-smiley-sprite { background: url("http://a.tbcdn.cn/sys/wangwang/smiley/sprite.png") no-repeat scroll -1px 0 transparent; height: 235px; width: 288px; margin: 5px;zoom: 1; overflow: hidden;}.ke-smiley-sprite a {   width: 24px;height: 24px; border: 1px solid white; float: left;}.ke-smiley-sprite a:hover { border: 1px solid #808080;}',"smiley");var w;v.SmileySupport={_selectSmiley:function(s){s.halt();
var n=this.editor;s=new l.Node(s.target);var j;if(s._4e_name()=="a"&&(j=s.attr("data-icon"))){j=new l.Node("<img class='ke_smiley'alt='' src='"+j+"'/>",null,n.document);n.insertElement(j);this.smileyWin.hide()}},_hidePanel:function(s){var n=this.btn.get("el");s=new l.Node(s.target);var j=this.smileyWin;n._4e_equals(s)||n.contains(s)||j.hide()},_show:function(){var s=this.smileyWin;s&&s.get("visible")?s.hide():this.call("_prepare")},_prepare:function(){var s=this.cfg,n=this.btn,j=this.editor,k;if(!w){w=
"<div class='ke-smiley-sprite'>";for(k=0;k<=98;k++)w+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+k+".gif'></a>";w+="</div>"}k=w;k=this.smileyWin=new v.Overlay({content:k,focus4e:false,width:"297px",autoRender:true,elCls:"ks-popup",zIndex:j.baseZIndex(v.zIndexManager.POPUP_MENU),mask:false});this.smileyPanel=k.get("contentEl");k.on("show",n.bon,n);k.on("hide",n.boff,n);this.smileyPanel.on("click",s._selectSmiley,this);p.on(document,"click",s._hidePanel,this);p.on(j.document,
"click",s._hidePanel,this);this.cfg._prepare=this.cfg._real;this.call("_real")},_real:function(){var s=this.btn.get("el"),n=s.offset();n.top+=s.height()+5;if(n.left+this.smileyPanel.width()>x.viewportWidth()-60)n.left=x.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.set("xy",[n.left,n.top]);this.smileyWin.show()},offClick:function(){this.call("_prepare")},onClick:function(){this.call("_prepare")}}});
KISSY.Editor.add("sourcearea",function(l){var p=KISSY.Editor;KISSY.UA.gecko<1.92||l.ready(function(){var v=p.SOURCE_MODE,x=p.WYSIWYG_MODE;l.addButton("sourcearea",{title:"\u6e90\u7801",contentCls:"ke-toolbar-source",init:function(){var w=this.btn,s=this.editor;s.on("wysiwygmode",w.boff,w);s.on("sourcemode",w.bon,w)},offClick:function(){this.editor.execCommand("sourceAreaSupport",v)},onClick:function(){this.editor.execCommand("sourceAreaSupport",x)}})})});
KISSY.Editor.add("sourcearea/support",function(l){var p=KISSY,v=p.Editor,x=p.UA;v.SourceAreaSupport||function(){function w(){var j=this.mapper={};j[s]=this._show;j[n]=this._hide}var s=v.SOURCE_MODE,n=v.WYSIWYG_MODE;p.augment(w,{exec:function(j,k){var c=this.mapper;c[k]&&c[k].call(this,j)},_show:function(j){j.textarea.val(j.getData(true));this._showSource(j);j.fire("sourcemode")},_showSource:function(j){var k=j.textarea,c=j.iframe;k.css("display","");c.css("display","none");x.ie<8&&k.css("height",
j.wrap.css("height"));k[0].focus()},_hideSource:function(j){var k=j.textarea;j.iframe.css("display","");k.css("display","none")},_hide:function(j){var k=j.textarea;this._hideSource(j);j.fire("save");j.setData(k.val());j.fire("wysiwygmode");j.fire("save");x.gecko&&j.activateGecko()}});v.SourceAreaSupport=new w}();l.addCommand("sourceAreaSupport",v.SourceAreaSupport)});
KISSY.Editor.add("table",function(l){var p=KISSY,v=p.Editor,x=p.trim,w=(p.UA.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th","{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border"),s=l.htmlDataProcessor;
p=s&&s.dataFilter;s=s&&s.htmlFilter;p&&p.addRules({elements:{table:function(n){n=n.attributes;var j=n["class"],k=parseInt(n.border,10);if(!k||k<=0)n["class"]=(j||"")+" ke_show_border"}}});s&&s.addRules({elements:{table:function(n){n=n.attributes;var j=n["class"];if(j)n["class"]=x(j.replace("ke_show_border","").replace(/\s{2}/," "))}}});l.ready(function(){var n=l.addButton("table",{contentCls:"ke-toolbar-table",mode:v.WYSIWYG_MODE,title:"\u63d2\u5165\u8868\u683c",loading:true});v.use("table/support",function(){var j=
new v.TableUI(l);n.reload({offClick:function(){j._tableShow()}})});l.addCustomStyle(w)})});
KISSY.Editor.add("table/support",function(){function l(g){var b=this,d={},i;for(i in q)(function(o){d[o]=function(){g.fire("save");q[o](b);g.fire("save")}})(i);f.ContextMenu.register({editor:g,rules:e,width:"120px",funcs:d});b.editor=g}function p(g){function b(A){if(!(o.length>0))if(A[0].nodeType==KEN.NODE_ELEMENT&&h.test(A._4e_name())&&!A.data("selected_cell")){A._4e_setMarker(y,"selected_cell",true);o.push(A)}}for(var d=g.createBookmarks(),i=g.getRanges(),o=[],y={},t=0;t<i.length;t++){var r=i[t];
if(r.collapsed){r=r.getCommonAncestor();(r=r._4e_ascendant("td",true)||r._4e_ascendant("th",true))&&o.push(r)}else{r=new Walker(r);var m;for(r.guard=b;m=r.next();)if((m=m.parent())&&h.test(m._4e_name())&&!m.data("selected_cell")){m._4e_setMarker(y,"selected_cell",true);o.push(m)}}}f.Utils.clearAllMarkers(y);g.selectBookmarks(d);return o}function v(g,b){var d=g.getStartElement()._4e_ascendant("tr");if(d){var i=d._4e_clone(true);i.insertBefore(d);d=(b?i[0]:d[0]).cells;for(i=0;i<d.length;i++){d[i].innerHTML=
"";k.ie||(new c(d[i]))._4e_appendBogus()}}}function x(g){if(g instanceof f.Selection){var b=p(g),d=b.length;g=[];for(var i,o,y=0;y<d;y++){var t=b[y].parent(),r=t[0].rowIndex;!y&&(i=r-1);g[r]=t;y==d-1&&(o=r+1)}y=t._4e_ascendant("table");i=new c(o<y[0].rows.length&&y[0].rows[o]||i>0&&y[0].rows[i]||y[0].parentNode);for(y=g.length;y>=0;y--)g[y]&&x(g[y]);return i}else if(g instanceof c){y=g._4e_ascendant("table");y[0].rows.length==1?y._4e_remove():g._4e_remove()}return 0}function w(g,b){var d=g.getStartElement();
if(d=d._4e_ascendant("td",true)||d._4e_ascendant("th",true))for(var i=d._4e_ascendant("table"),o=d[0].cellIndex,y=0;y<i[0].rows.length;y++){var t=i[0].rows[y];if(!(t.cells.length<o+1)){d=new c(t.cells[o].cloneNode(false));k.ie||d._4e_appendBogus();t=new c(t.cells[o]);b?d.insertBefore(t):d.insertAfter(t)}}}function s(g){if(g instanceof f.Selection){var b=p(g),d,i=[];g=b[0]&&b[0]._4e_ascendant("table");var o,y,t;o=0;for(y=b.length;o<y;o++)i.push(b[o][0].cellIndex);i.sort();o=1;for(y=i.length;o<y;o++)if(i[o]-
i[o-1]>1){t=i[o-1]+1;break}t||(t=i[0]>0?i[0]-1:i[i.length-1]+1);i=g[0].rows;o=0;for(y=i.length;o<y;o++)if(d=i[o].cells[t])break;d=d?new c(d):g._4e_previous();for(t=b.length-1;t>=0;t--)b[t]&&s(b[t]);return d}else if(g instanceof c){b=g._4e_ascendant("table");if(!b)return null;d=g[0].cellIndex;for(t=b[0].rows.length-1;t>=0;t--){g=new c(b[0].rows[t]);if(!d&&g[0].cells.length==1)x(g);else g[0].cells[d]&&g[0].removeChild(g[0].cells[d])}}return null}function n(g,b){var d=new f.Range(g[0].ownerDocument);
if(!d.moveToElementEditablePosition(g,b?true:undefined)){d.selectNodeContents(g);d.collapse(b?false:true)}d.select(true)}var j=KISSY,k=j.UA,c=j.Node,f=j.Editor,e=["tr","th","td","tbody","table"];j.augment(l,{_tableShow:function(g,b,d){this.editor.useDialog("table/dialog",function(i){i.show(b,d)})}});var h=/^(?:td|th)$/,q={"\u8868\u683c\u5c5e\u6027":function(g){var b=g.editor.getSelection(),d=b&&b.getStartElement();if(b=d&&d._4e_ascendant("table",true)){d=d._4e_ascendant(function(i){i=i._4e_name();return i=="td"||i==
"th"},true);g._tableShow(null,b,d)}},"\u5220\u9664\u8868\u683c":function(g){var b=(g=g.editor.getSelection())&&g.getStartElement();if(b=b&&b._4e_ascendant("table",true)){g.selectElement(b);var d=g.getRanges()[0];d.collapse();g.selectRanges([d]);g=b.parent();g[0].childNodes.length==1&&g._4e_name()!="body"&&g._4e_name()!="td"?g._4e_remove():b._4e_remove()}},"\u5220\u9664\u884c ":function(g){g=g.editor.getSelection();n(x(g),undefined)},"\u5220\u9664\u5217 ":function(g){g=g.editor.getSelection();(g=s(g))&&n(g,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(g){g=g.editor.getSelection();
v(g,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(g){g=g.editor.getSelection();v(g,undefined)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(g){g=g.editor.getSelection();w(g,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(g){g=g.editor.getSelection();w(g,undefined)}};f.TableUI=l});
KISSY.Editor.add("tabs",function(){function l(s){this.cfg=s;this._init()}var p=KISSY,v=p.Editor,x=p.DOM,w=p.Node;if(!v.Tabs){p.augment(l,p.EventTarget,{_init:function(){var s=this,n=s.cfg,j=n.tabs,k=n.contents.children("div"),c=j.children("li");j.on("click",function(f){f=new w(f.target);if(f=f._4e_ascendant(function(h){return h._4e_name()==="li"&&j.contains(h)},true)){c.removeClass("ke-tab-selected");var e=f.attr("rel");f.addClass("ke-tab-selected");k.hide();x.show(k[p.indexOf(f[0],c)]);s.fire(e)}})},
getTab:function(s){var n=this.cfg,j=n.tabs;n=n.contents.children("div");j=j.children("li");for(var k=0;k<j.length;k++){var c=new w(j[k]),f=new w(n[k]);if(p.isNumber(s)&&s==k||p.isString(s)&&s==c.attr("rel"))return{tab:c,content:f}}},remove:function(s){s=this.getTab(s);s.tab.remove();s.content.remove()},_getActivate:function(){var s=this.cfg,n=s.tabs;s.contents.children("div");s=n.children("li");for(n=0;n<s.length;n++){var j=new w(s[n]);if(j.hasClass("ke-tab-selected"))return j.attr("rel")}},activate:function(s){if(arguments.length==
0)return this._getActivate();var n=this.cfg,j=n.tabs;n=n.contents.children("div");j.children("li").removeClass("ke-tab-selected");n.hide();j=this.getTab(s);j.tab.addClass("ke-tab-selected");j.content.show()}});v.Tabs=l}});
KISSY.Editor.add("templates",function(l){var p=KISSY,v=p.Editor,x=p.Node,w=v.Dialog;p.DOM.addStyleSheet(".ke-tpl {    border: 2px solid #EEEEEE;    width: 95%;    margin: 20px auto;}.ke-tpl-list {    border: 1px solid #EEEEEE;    margin: 5px;    padding: 7px;    display: block;    text-decoration: none;    zoom: 1;}.ke-tpl-list:hover, .ke-tpl-selected {    background-color: #FFFACD;    text-decoration: none;    border: 1px solid #FF9933;}","ke-templates");l.ready(function(){l.addButton("templates",
{contentCls:"ke-toolbar-template",title:"\u6a21\u677f",mode:v.WYSIWYG_MODE,offClick:function(){this.cfg._prepare.call(this)},_prepare:function(){for(var s=this.editor,n=s.cfg.pluginConfig.templates||[],j="<div class='ke-tpl'>",k=0;k<n.length;k++)j+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+n[k].demo+"</a>";j+="</div>";var c=new w({width:500,mask:true,autoRender:true,headerContent:"\u5185\u5bb9\u6a21\u677f",bodyContent:j});c.get("el").all(".ke-tpl-list").on("click",function(f){f.halt();f=(new x(f.target))._4e_index();
f!=-1&&s.insertHtml(n[f].html);c.hide()});this.ui=c;this.cfg.show.call(this);this.cfg._prepare=this.cfg.show},show:function(){this.ui.show()}})})});
KISSY.Editor.add("undo",function(l){var p=KISSY,v=p.Editor,x=v.Utils.arrayCompare,w=p.UA,s=p.Event;v.UndoManager||function(){function n(f){var e=f._getRawData(),h;if(e)h=f.getSelection();this.contents=e;this.bookmarks=h&&h.createBookmarks2(true)}function j(f){this.history=[];this.index=-1;this.editor=f;this.bufferRunner=v.Utils.buffer(this.save,this,500);this._init()}p.augment(n,{equals:function(f){if(this.contents!=f.contents)return false;var e=this.bookmarks;f=f.bookmarks;if(e||f){if(!e||!f||e.length!=
f.length)return false;for(var h=0;h<e.length;h++){var q=e[h],g=f[h];if(q.startOffset!=g.startOffset||q.endOffset!=g.endOffset||!x(q.start,g.start)||!x(q.end,g.end))return false}}return true}});var k={16:1,17:1,18:1},c={37:1,38:1,39:1,40:1,33:1,34:1};p.augment(j,{_keyMonitor:function(){var f=this.editor;s.on([f.document,f.textarea],"keydown",function(e){var h=e.keyCode;if(!(h in c||h in k))if(h===90&&(e.ctrlKey||e.metaKey)){f.fire("restore",{d:-1});e.halt()}else if(h===89&&(e.ctrlKey||e.metaKey)){f.fire("restore",
{d:1});e.halt()}else f.fire("save",{buffer:1})})},_init:function(){var f=this,e=f.editor;e.on("save",function(h){if(e.getMode()==v.WYSIWYG_MODE)h.buffer?f.bufferRunner():f.save()});e.on("restore",function(h){e.getMode()==v.WYSIWYG_MODE&&f.restore(h)});f._keyMonitor()},save:function(){var f=this.history,e=this.index;f.length>e+1&&f.splice(e+1,f.length-e-1);var h=this.editor;e=f[f.length-1];var q=new n(h);if(!e||!e.equals(q)){f.length===30&&f.shift();f.push(q);this.index=e=f.length-1;h.fire("afterSave",
{history:f,index:e})}},restore:function(f){f=f.d;var e=this.history,h=this.editor,q=e[this.index+f];if(q){h._setRawData(q.contents);if(q.bookmarks)h.getSelection().selectBookmarks(q.bookmarks);else if(w.ie){q=h.document.body.createTextRange();q.collapse(true);q.select()}(q=h.getSelection())&&q.scrollIntoView();this.index+=f;h.fire("afterRestore",{history:e,index:this.index});h.notifySelectionChange()}}});v.UndoManager=j}();l.ready(function(){new v.UndoManager(l);var n={redo:1,undo:-1},j={mode:v.WYSIWYG_MODE,
init:function(){this.editor.on("afterSave afterRestore",this.cfg._respond,this);this.btn.disable()},offClick:function(){this.editor.fire("restore",{d:n[this.cfg.flag]})}},k=p.mix({title:"\u64a4\u9500",flag:"undo",contentCls:"ke-toolbar-undo",_respond:function(c){var f=this.btn;c.index>0?f.boff():f.disable()}},j,false);j=p.mix({title:"\u91cd\u505a",flag:"redo",contentCls:"ke-toolbar-redo",_respond:function(c){var f=this.btn;c.index<c.history.length-1?f.boff():f.disable()}},j,false);l.addButton("undo",k);l.addButton("undo",
j)})});
