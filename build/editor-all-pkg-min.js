KISSY.add("editor",function(w,s){function A(t,b){var c=this;if(!(c instanceof A))return new A(t,b);if(w.isString(t))t=w.one(t);t[0]||(t=new Node(t));c.cfg=b||{pluginConfig:{}};w.app(c,w.EventTarget);c.use=function(f){if(w.isString(f))f=f.split(",");var e=f;f=[];f=w.indexOf("separator",e);var m=f!=-1;f=e.splice(0,m?f+1:e.length);m&&f.pop();f.length!=0?w.use.call(c,f.join(","),function(){m&&c.addPlugin(function(){A.Utils.addSeparator(c.toolBarDiv)});c.use(e)},{order:true,global:A}):c.on("dataReady",
function(){c.setData(t.val());c.fire("save")});return c};c.init(t);return s}function r(t){if(!x)return t.replace(/\.(js|css)/i,"-min.$1");if(x==="dev")return"../src/"+t;return t}w.app(A,w.EventTarget);A.Config.base=w.Config.base+"editor/";var x=w.Config.debug,C={htmlparser:{attach:false,path:r("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},p=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],v=["clipboard",{name:"color"},{name:"elementpaths"},
"enterkey","fakeobjects",{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["contextmenu","fakeobjects","overlay","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview"]},"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize",{name:"music",requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay",
"contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],i=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],
g=[{name:"button"},{name:"dd"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}],k,o,q,h,l;k=0;for(o=g.length;k<o;k++){h=q=g[k];l=s;if(!w.isString(q)){l=q.requires;h=q.name}C[h]={attach:false,requires:l,path:r("ui/"+h+".js"),csspath:q.useCss?r("ui/"+h+".css"):""}}k=0;for(o=v.length;k<o;k++){h=q=v[k];l=["button"];if(!w.isString(q)){q.requires&&(l=l.concat(q.requires));h=q.name}C[h]={attach:false,
requires:l,csspath:q.useCss?r("plugins/"+h+"/plugin.css"):s,path:r("plugins/"+h+"/plugin.js")}}k=0;for(o=i.length;k<o;k++){q=i[k];l=s;if(!w.isString(q)){l=q.requires;q=q.name}C[q]={attach:false,requires:l,path:r("plugins/htmldataprocessor/htmlparser/"+q.substring(11)+".js")}}A.add(C);C={};k=0;for(o=p.length;k<o;k++){q=p[k];C[q]={host:"editor",requires:k>0?p[k-1]:[]}}A.add(C);w.Editor=A});
KISSY.Editor.add("utils",function(w){var s=KISSY,A=s.Node,r=s.DOM,x=s.Config.debug,C=s.UA;w.Utils={getFlashUrl:function(p){var v="",i=w.NODE;if(p._4e_name()=="object"){p=p[0].childNodes;for(var g=0;g<p.length;g++)if(p[g].nodeType==i.NODE_ELEMENT)if((r.attr(p[g],"name")||"").toLowerCase()=="movie")v=r.attr(p[g],"value");else if(r._4e_name(p[g])=="embed")v=r.attr(p[g],"src");else if(r._4e_name(p[g])=="object")v=r.attr(p[g],"data")}else if(p._4e_name()=="embed")v=p.attr("src");return v},debugUrl:function(p){if(!x)return p.replace(/\.(js|css)/i,
"-min.$1");if(x==="dev")return"../src/"+p;return p},lazyRun:function(p,v,i){var g=p[v],k=p[i];p[v]=function(){g.apply(this,arguments);p[v]=p[i];return k.apply(this,arguments)}},getXY:function(p,v,i,g){i=i.defaultView||i.parentWindow;p-=r.scrollLeft(i);v-=r.scrollTop(i);if(g)if(i!=(g.defaultView||g.parentWindow)&&i.frameElement){g=r._4e_getOffset(i.frameElement,g);p+=g.left;v+=g.top}return{left:p,top:v}},tryThese:function(){for(var p,v=0,i=arguments.length;v<i;v++){var g=arguments[v];try{p=g();break}catch(k){}}return p},
arrayCompare:function(p,v){if(!p&&!v)return true;if(!p||!v||p.length!=v.length)return false;for(var i=0;i<p.length;i++)if(p[i]!==v[i])return false;return true},getByAddress:function(p,v,i){p=p.documentElement;for(var g=0;p&&g<v.length;g++){var k=v[g];if(i)for(var o=-1,q=0;q<p.childNodes.length;q++){var h=p.childNodes[q];if(!(i===true&&h.nodeType==3&&h.previousSibling&&h.previousSibling.nodeType==3)){o++;if(o==k){p=h;break}}}else p=p.childNodes[k]}return p?new A(p):null},clearAllMarkers:function(p){for(var v in p)p[v]._4e_clearMarkers(p,
true)},htmlEncodeAttr:function(p){return p.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(p){return p.replace(/^\s+/,"")},rtrim:function(p){return p.replace(/\s+$/,"")},trim:function(p){return this.ltrim(this.rtrim(p))},mix:function(){for(var p={},v=0;v<arguments.length;v++)p=s.mix(p,arguments[v]);return p},isCustomDomain:function(){if(!C.ie)return false;var p=document.domain,v=window.location.hostname;return p!=v&&p!="["+v+"]"},addSeparator:function(p){(new s.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(p)},
duplicateStr:function(p,v){return(new Array(v+1)).join(p)},throttle:function(p,v,i){i=i||150;if(i===-1)return function(){p.apply(v,arguments)};var g=(new Date).getTime();return function(){var k=(new Date).getTime();if(k-g>i){g=k;p.apply(v,arguments)}}},buffer:function(p,v,i){i=i||0;var g=null;return function(){g&&clearTimeout(g);var k=arguments;g=setTimeout(function(){return p.apply(v,k)},i)}},isNumber:function(p){return/^\d+(.\d+)?$/.test(s.trim(p))}}});
KISSY.Editor.add("focusmanager",function(w){function s(){this.iframeFocus=true;v=this}function A(){this.iframeFocus=false;v=null}var r=KISSY,x=r.DOM,C=r.Event;r={};var p={},v;r={refreshAll:function(){for(var i in p){var g=p[i];g.document.designMode="off";g.document.designMode="on"}},currentInstance:function(){return v},getInstance:function(i){return p[i]},add:function(i){var g=x._4e_getWin(i.document);C.on(g,"focus",s,i);C.on(g,"blur",A,i)},register:function(i){p[i._UUID]=i},remove:function(i){delete p[i._UUID];
var g=x._4e_getWin(i.document);C.remove(g,"focus",s,i);C.remove(g,"blur",A,i)}};w.focusManager=r});
KISSY.Editor.add("definition",function(w){function s(l){return g+"<html><head><title>kissy-editor</title><link href='"+w.Config.base+k+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(l?'<script id="ke_actscrpt" type="text/javascript">'+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+l+'");<\/script>':"")}var A=KISSY,r=A.UA,x=A.DOM,C=A.Node,p=A.Event,v=w.focusManager,i=w.Utils.tryThese,g="<!doctype html>",k=
w.Utils.debugUrl("theme/editor-iframe.css"),o=1,q="document.open();"+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",h="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(r.ie?"javascript:void(function(){"+encodeURIComponent(q)+"}())":"")+'"  tabIndex="'+
(r.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";A.augment(w,{init:function(l){var t=this,b=new C(h.replace(/\$\(tabIndex\)/,l.attr("tabIndex")));b.on("mousedown",function(e){if(r.webkit){var m=x._4e_name(e.target);if(m=="select"||m=="option")return true}e.halt()});t.editorWrap=b;t._UUID=o++;v.register(t);t.wrap=b.one(".ke-textarea-wrap");t.iframe=t.wrap.one("iframe");t.toolBarDiv=b.one(".ke-editor-tools");t.textarea=
l;t.statusDiv=b.one(".ke-editor-status");t.toolBarDiv._4e_unselectable();t._commands={};t._plugins={};var c=l._4e_style("width"),f=l._4e_style("height");if(c){b.css("width",c);l.css("width","100%")}t.textarea.css("display","none");b.insertAfter(l);t.wrap[0].appendChild(l[0]);if(f){t.wrap.css("height",f);l.css("height","100%")}l=t.iframe;t.on("dataReady",function(){t.ready=true;w.fire("instanceCreated",{editor:t})});r.gecko?l.on("load",t._setUpIFrame,t):t._setUpIFrame()},addCommand:function(l,t){this._commands[l]=
t},execCommand:function(l){this.fire("save");this._commands[l].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(l){if(this.htmlDataProcessor)l=this.htmlDataProcessor.toDataFormat(l,"p");this.document.body.innerHTML=l},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(l){this.document.body.innerHTML=
l},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");r.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:s,getSelection:function(){var l=new w.Selection(this.document);return!l||l.isInvalid?null:l},focus:function(){var l=x._4e_getWin(this.document);r.webkit&&l&&l.parent&&l.parent.focus();l&&l.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){x._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function l(){e=f.document;t.document=e;b.detach();e.open("text/html","replace");e.write(c);e.close()}
var t=this,b=t.iframe,c=s(t._UUID),f=b[0].contentWindow,e;try{e=f.document}catch(m){b[0].src=b[0].src;if(r.ie&&r.ie<7){setTimeout(l,10);return}}l()},addPlugin:function(l){this.ready?l():this.on("dataReady",l)},_monitor:function(){var l=this;l._monitorId&&clearTimeout(l._monitorId);l._monitorId=setTimeout(function(){var t=l.getSelection();if(t&&!t.isInvalid){t=t.getStartElement();var b=new w.ElementPath(t);if(!l.previousPath||!l.previousPath.compare(b)){l.previousPath=b;l.fire("selectionChange",{selection:l,
path:b,element:t})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(l,t){var b=this;b.focus();var c=l._4e_name(),f=w.XHTML_DTD,e=w.RANGE,m=w.NODE,j=f.$block[c],a=b.getSelection(),d=a.getRanges(),n,z,y,B,G;b.fire("save");for(var M=d.length-1;M>=0;M--){n=d[M];n.deleteContents();z=!M&&l||l._4e_clone(true);t&&t(z);if(j)for(;(B=n.getCommonAncestor(false,true))&&(G=f[B._4e_name()])&&!(G&&G[c]);)if(B._4e_name()in f.span)n.splitElement(B);else if(n.checkStartOfBlock()&&
n.checkEndOfBlock()){n.setStartBefore(B);n.collapse(true);B._4e_remove()}else n.splitBlock();n.insertNode(z);y||(y=z)}l=y._4e_nextSourceNode(true);t=b.document;G=w.XHTML_DTD;if(G.$inline[z._4e_name()]){l=new C(t.createTextNode(" "));l.insertAfter(y)}else if(l){if(l._4e_name()=="br"&&G[l.parent()._4e_name()].p){G=new C("<p>&nbsp;</p>",null,t);l[0].parentNode.replaceChild(G[0],l[0]);l=G}}else{G=new C("<p>&nbsp;</p>",null,t);G.insertAfter(y);l=G}n.moveToPosition(y,e.POSITION_AFTER_END);l&&l[0].nodeType==
m.NODE_ELEMENT&&n.moveToElementEditablePosition(l);a.selectRanges([n]);b.focus();z&&z._4e_scrollIntoView();setTimeout(function(){b.fire("save")},10);return z},insertHtml:function(l){var t=this;if(t.htmlDataProcessor)l=t.htmlDataProcessor.toDataFormat(l);if(r.webkit){l=x.create(l,null,this.document);l=l.nodeType==11?A.makeArray(l.childNodes):[l];for(var b=0;b<l.length;b++)t.insertElement(new C(l[b]))}else{t.focus();t.fire("save");b=t.getSelection();if(r.ie){b=b.getNative();b.type=="Control"&&b.clear();
b.createRange().pasteHTML(l)}else t.document.execCommand("inserthtml",false,l);t.focus();setTimeout(function(){t.fire("save")},10)}}});w._initIFrame=function(l){function t(B){i(function(){f.designMode="on";setTimeout(function(){f.designMode="off";j.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){f.designMode="off";x.attr(j,"contentEditable",false);x.attr(j,"contentEditable",true);!B&&t(1)})}var b=v.getInstance(l);l=b.textarea[0];var c=b.iframe[0].contentWindow,f=b.document,
e=b.cfg,m=f.getElementById("ke_actscrpt");m.parentNode.removeChild(m);var j=f.body;if(r.ie){j.hideFocus=true;j.disabled=true;j.contentEditable=true;j.removeAttribute("disabled")}else setTimeout(function(){if(r.gecko||r.opera)j.contentEditable=true;else if(r.webkit)j.parentNode.contentEditable=true;else f.designMode="on"},0);try{f.execCommand("enableObjectResizing",false,!e.disableObjectResizing)}catch(a){}try{f.execCommand("enableInlineTableEditing",false,!e.disableInlineTableEditing)}catch(d){}r.webkit&&
p.on(f,"mousedown",function(B){B=new C(B.target);A.inArray(B._4e_name(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(B)});if(r.webkit){p.on(f,"click",function(B){var G=new C(B.target);A.inArray(G._4e_name(),["input","select"])&&B.preventDefault()});p.on(f,"mouseup",function(B){var G=new C(B.target);A.inArray(G._4e_name(),["input","textarea"])&&B.preventDefault()})}if(r.gecko||r.ie||r.opera){var n;n=new C(x.insertAfter((new C('<span style="position:absolute; left:-10000"></span>'))[0],
l));n.on("focus",function(){b.focus()});b.on("destroy",function(){})}if(r.ie&&f.compatMode=="CSS1Compat"||r.gecko||r.opera){var z=new C(f.documentElement);z.on("mousedown",function(B){if(B.target===z[0]){r.gecko&&t(false);n[0].focus()}})}p.on(c,"focus",function(){if(r.gecko)t(false);else r.opera&&j.focus();b.notifySelectionChange()});r.gecko&&p.on(b.document,"mousedown",function(){b.iframeFocus||t(false)});if(r.ie){p.on(f,"keydown",function(B){if(B.keyCode in{8:1,46:1}){var G=b.getSelection(),M=G.getSelectedElement();
if(M){b.fire("save");var u=G.getRanges()[0].createBookmark();M._4e_remove();G.selectBookmarks([u]);b.fire("save");B.preventDefault()}}});if(f.compatMode=="CSS1Compat"){var y={33:1,34:1};p.on(f,"keydown",function(B){B.keyCode in y&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}}setTimeout(function(){r.ie&&setTimeout(function(){if(f){j.runtimeStyle.marginBottom="0px";j.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.fire("dataReady")},10);v.add(b)};r.gecko&&function(){var l=
document.body;if(l){var t=l.getAttribute("onpageshow");l.setAttribute("onpageshow",(t?t+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(w){w.XHTML_DTD=function(){var s=function(j){for(var a=arguments.length-1;a>0;)KISSY.mix(j,arguments[a--]);return j},A={isindex:1,fieldset:1},r={input:1,button:1,select:1,textarea:1,label:1},x=s({a:1},r),C=s({iframe:1},x),p={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},v={ins:1,del:1,script:1,style:1},i=s({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},v),g=s({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},i),k=s({p:1},g);r=s({iframe:1},g,r);g={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var o=s({a:1},r),q={tr:1},h={"#":1},l=s({param:1},g),t=s({form:1},A,C,p,k),b={li:1},c={base:1,link:1,meta:1,title:1},f=s(c,{style:1,script:1}),e={head:1,body:1},m={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:s({html:1},e,c),$block:m,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:o,$body:s({script:1,style:1},m),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:e,head:f,style:h,body:t,base:{},link:{},meta:{},title:h,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:t,td:t,br:{},th:t,center:t,kbd:o,button:s(k,p),basefont:{},h5:o,h4:o,samp:o,h6:o,ol:b,h1:o,h3:o,option:h,h2:o,form:s(A,C,p,k),select:{optgroup:1,option:1},font:o,ins:o,menu:b,abbr:o,label:o,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:o,script:h,tfoot:q,cite:o,li:t,input:{},iframe:t,strong:o,textarea:h,noframes:t,big:o,small:o,span:o,hr:{},dt:o,sub:o,optgroup:{option:1},param:{},bdo:o,"var":o,div:t,object:l,sup:o,dd:t,strike:o,area:{},dir:b,map:s({area:1,form:1,p:1},A,v,p),applet:l,dl:{dt:1,dd:1},del:o,isindex:{},fieldset:s({legend:1},g),thead:q,ul:b,acronym:o,b:o,a:r,blockquote:t,caption:o,i:o,u:o,tbody:q,s:o,address:s(C,k),tt:o,legend:o,q:o,pre:s(i,x),p:o,em:o,dfn:o}}()});
KISSY.Editor.add("dom",function(w){function s(b){return b.replace(/-(\w)/g,function(c,f){return f.toUpperCase()})}var A=KISSY,r=A.DOM,x=A.UA,C=A.Node,p=w.Utils,v={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};w.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};w.POSITION={};var i=w.NODE,g=w.POSITION;g.POSITION_IDENTICAL=0;g.POSITION_DISCONNECTED=
1;g.POSITION_FOLLOWING=2;g.POSITION_PRECEDING=4;g.POSITION_IS_CONTAINED=8;g.POSITION_CONTAINS=16;var k={},o={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},q={hr:1},h=function(b){return b[0]||b},l=function(b){if(!b[0])return new C(b);return b},t={_4e_equals:function(b,c){if(!b&&!c)return true;if(!b||!c)return false;b=h(b);c=h(c);return b===c},_4e_isBlockBoundary:function(b,
c){b=l(b);c=A.mix(A.mix({},q),c||{});return o[b.css("display")]||c[b._4e_name()]},_4e_getWin:function(b){return b&&"scrollTo"in b&&b.document?b:b&&b.nodeType===9?b.defaultView||b.parentWindow:false},_4e_index:function(b){b=h(b);for(var c=b.parentNode.childNodes,f=0;f<c.length;f++)if(c[f]===b)return f;return-1},_4e_first:function(b,c){b=h(b);if((b=(b=b.firstChild)&&new C(b))&&c&&!c(b))b=b._4e_next(c);return b},_4e_move:function(b,c,f){b._4e_remove();b=h(b);c=h(c);f?c.insertBefore(b,c.firstChild):c.appendChild(b)},
_4e_name:function(b){b=h(b);var c=b.nodeName.toLowerCase();if(x.ie)if((b=b.scopeName)&&b!="HTML")c=b.toLowerCase()+":"+c;return c},_4e_isIdentical:function(b,c){if(b._4e_name()!=c._4e_name())return false;var f=b[0].attributes,e=c[0].attributes,m=f.length,j=e.length;if(!x.ie&&m!=j)return false;for(var a=0;a<m;a++){var d=f[a];if((!x.ie||d.specified&&d.nodeName!="_ke_expando")&&d.nodeValue!=c.attr(d.nodeName))return false}if(x.ie)for(a=0;a<j;a++){d=e[a];if(d.specified&&d.nodeName!="_ke_expando"&&d.nodeValue!=
b.attr(d.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(b){b=h(b).childNodes;for(var c=0,f=b.length;c<f;c++){var e=b[c],m=e.nodeType;if(!(m==i.NODE_ELEMENT&&e.getAttribute("_ke_bookmark")))if(m==i.NODE_ELEMENT&&!t._4e_isEmptyInlineRemoveable(e)||m==i.NODE_TEXT&&A.trim(e.nodeValue))return false}return true},_4e_moveChildren:function(b,c,f){b=h(b);c=c[0]||c;if(b!=c)if(f)for(;f=b.lastChild;)c.insertBefore(b.removeChild(f),c.firstChild);else for(;f=b.firstChild;)c.appendChild(b.removeChild(f))},
_4e_mergeSiblings:function(){function b(c,f,e){if(f[0]&&f[0].nodeType==i.NODE_ELEMENT){for(var m=[];f.attr("_ke_bookmark")||f._4e_isEmptyInlineRemoveable();){m.push(f);f=e?new C(f[0].nextSibling):new C(f[0].previousSibling);if(!f[0]||f[0].nodeType!=i.NODE_ELEMENT)return}if(c._4e_isIdentical(f)){for(var j=e?c[0].lastChild:c[0].firstChild;m.length;)m.shift()._4e_move(c,!e);f._4e_moveChildren(c,!e);f._4e_remove();j[0]&&j[0].nodeType==i.NODE_ELEMENT&&j._4e_mergeSiblings()}}}return function(c){if(c[0])if(v[c._4e_name()]||
c._4e_name()=="a"){b(c,new C(c[0].nextSibling),true);b(c,new C(c[0].previousSibling))}}}(),_4e_unselectable:x.gecko?function(b){b=h(b);b.style.MozUserSelect="none"}:x.webkit?function(b){b=h(b);b.style.KhtmlUserSelect="none"}:function(b){b=h(b);if(x.ie||x.opera){var c,f=0;for(b.unselectable="on";c=b.all[f++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(b,c){b=h(b);var f,e=0;f=0;var m=b.ownerDocument.defaultView||
b.ownerDocument.parentWindow,j=b.ownerDocument,a=j.documentElement;c=c||j;if(b.getBoundingClientRect){if(b!==j.body&&a!==b){f=b.getBoundingClientRect();e=f.left+(c===j?r.scrollLeft(m):0);f=f.top+(c===j?r.scrollTop(m):0)}if(c)if(m!=(c.defaultView||c.parentWindow)&&m.frameElement){c=t._4e_getOffset(m.frameElement,c);e+=c.left;f+=c.top}}return{left:e,top:f}},_4e_getFrameDocument:function(b){return(b=h(b))&&b.contentWindow.document},_4e_splitText:function(b,c){b=h(b);var f=b.ownerDocument;if(!(!b||b.nodeType!=
i.NODE_TEXT)){if(x.ie&&c==b.nodeValue.length){f=f.createTextNode("");r.insertAfter(f,b);return f}b=new C(b.splitText(c));if(x.ie==8){f=f.createTextNode("");r.insertAfter(f,b[0]);f.parentNode.removeChild(f)}return b}},_4e_parents:function(b,c){b=l(b);var f=[];do f[c?"push":"unshift"](b);while(b=b.parent());return f},_4e_clone:function(b,c,f){b=h(b);b=b.cloneNode(c);if(!f){var e=function(m){if(m.nodeType==i.NODE_ELEMENT){m.removeAttribute("id",false);m.removeAttribute("_ke_expando",false);m=m.childNodes;
for(var j=0;j<m.length;j++)e(m[j])}};e(b)}return new C(b)},_4e_nextSourceNode:function(b,c,f,e){b=h(b);if(e&&!e.call){var m=e[0]||e;e=function(a){a=a[0]||a;return a!==m}}c=!c&&b.firstChild;var j=new C(b);if(!c){if(b.nodeType==i.NODE_ELEMENT&&e&&e(this,true)===false)return null;c=b.nextSibling}for(;!c&&(j=j.parent());){if(e&&e(j,true)===false)return null;c=j[0].nextSibling}if(!c)return null;c=new C(c);if(e&&e(c)===false)return null;if(f&&f!=c[0].nodeType)return c._4e_nextSourceNode(false,f,e);return c},
_4e_previousSourceNode:function(b,c,f,e){b=h(b);if(e&&!e.call){var m=e[0]||e;e=function(a){a=a[0]||a;return a!==m}}c=!c&&b.lastChild;var j=new C(b);if(!c){if(b.nodeType==i.NODE_ELEMENT&&e&&e(b,true)===false)return null;c=b.previousSibling}for(;!c&&(j=j.parent());){if(e&&e(j,true)===false)return null;c=j[0].previousSibling}if(!c)return null;c=new C(c);if(e&&e(c)===false)return null;if(f&&c[0].nodeType!=f)return c._4e_previousSourceNode(false,f,e);return c},_4e_contains:x.ie||x.webkit?function(b,c){b=
h(b);c=h(c);return c.nodeType!=i.NODE_ELEMENT?b.contains(c.parentNode):b!=c&&b.contains(c)}:function(b,c){b=h(b);c=h(c);return!!(b.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(b,c){if(b._4e_equals(c))return b;if(c[0].nodeType!=i.NODE_TEXT&&c._4e_contains(b))return c;b=b[0].nodeType==i.NODE_TEXT?b.parent():b;do if(b[0].nodeType!=i.NODE_TEXT&&b._4e_contains(c))return b;while(b=b.parent());return null},_4e_ascendant:function(b,c,f){b=h(b);if(!f)b=b.parentNode;if(c&&!A.isFunction(c)){var e=
c;c=function(m){return m._4e_name()==e}}for(;b&&b.nodeType!=9;){if(!c||c(new C(b))===true)return new C(b);b=b.parentNode}return null},_4e_hasAttribute:function(b,c){b=h(b);b=b.attributes.getNamedItem(c);return!!(b&&b.specified)},_4e_hasAttributes:x.ie?function(b){b=h(b);for(var c=b.attributes,f=0;f<c.length;f++){var e=c[f];switch(e.nodeName){case "class":if(b.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(e.specified)return true}}return false}:function(b){b=h(b);x.gecko&&
b.removeAttribute("_moz_dirty");b=b.attributes;return b.length>1||b.length==1&&b[0].nodeName!="_ke_expando"},_4e_position:function(b,c){var f=h(b),e=h(c);if(f.compareDocumentPosition)return f.compareDocumentPosition(e);if(f==e)return g.POSITION_IDENTICAL;if(f.nodeType==i.NODE_ELEMENT&&e.nodeType==i.NODE_ELEMENT){if(f.contains){if(f.contains(e))return g.POSITION_CONTAINS+g.POSITION_PRECEDING;if(e.contains(f))return g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING}if("sourceIndex"in f)return f.sourceIndex<
0||e.sourceIndex<0?g.POSITION_DISCONNECTED:f.sourceIndex<e.sourceIndex?g.POSITION_PRECEDING:g.POSITION_FOLLOWING}b=b._4e_address();c=c._4e_address();f=Math.min(b.length,c.length);for(e=0;e<=f-1;e++)if(b[e]!=c[e]){if(e<f)return b[e]<c[e]?g.POSITION_PRECEDING:g.POSITION_FOLLOWING;break}return b.length<c.length?g.POSITION_CONTAINS+g.POSITION_PRECEDING:g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING},_4e_address:function(b,c){b=h(b);var f=[],e=b.ownerDocument.documentElement;for(b=b;b&&b!=e;){var m=b.parentNode,
j=-1;if(m){for(var a=0;a<m.childNodes.length;a++){var d=m.childNodes[a];if(!(c&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){j++;if(d==b)break}}f.unshift(j)}b=m}return f},_4e_breakParent:function(b,c){var f=new w.Range(b[0].ownerDocument);f.setStartAfter(b);f.setEndAfter(c);c=f.extractContents();f.insertNode(b._4e_remove());b[0].parentNode.insertBefore(c,b[0].nextSibling)},_4e_style:function(b,c,f){if(f!==undefined)return b.css(c,f);b=b[0]||b;return b.style[s(c)]},_4e_remove:function(b,
c){var f=h(b),e=f.parentNode;if(e){if(c)for(;c=f.firstChild;)e.insertBefore(f.removeChild(c),f);e.removeChild(f)}return b},_4e_trim:function(b){r._4e_ltrim(b);r._4e_rtrim(b)},_4e_ltrim:function(b){b=h(b);for(var c;c=b.firstChild;){if(c.nodeType==i.NODE_TEXT){var f=p.ltrim(c.nodeValue),e=c.nodeValue.length;if(f){if(f.length<e){(new C(c))._4e_splitText(e-f.length);b.removeChild(b.firstChild)}}else{b.removeChild(c);continue}}break}},_4e_rtrim:function(b){b=h(b);for(var c;c=b.lastChild;){if(c.type==i.NODE_TEXT){var f=
p.rtrim(c.nodeValue),e=c.nodeValue.length;if(f){if(f.length<e){(new C(c))._4e_splitText(f.length);b.removeChild(b.lastChild)}}else{b.removeChild(c);continue}}break}if(!x.ie&&!x.opera)(c=b.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(b){b=h(b);for(var c=b.lastChild;c&&c.nodeType==i.NODE_TEXT&&!A.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==i.NODE_TEXT||r._4e_name(c)!=="br"){c=x.opera?b.ownerDocument.createTextNode(""):
b.ownerDocument.createElement("br");x.gecko&&c.setAttribute("type","_moz");b.appendChild(c)}},_4e_previous:function(b,c){b=h(b);var f;do f=(b=b.previousSibling)&&new C(b);while(f&&c&&!c(f));return f},_4e_last:function(b,c){if((b=(b=b[0].lastChild)&&new C(b))&&c&&!c(b))b=b._4e_previous(c);return b},_4e_next:function(b,c){b=h(b);var f;do f=(b=b.nextSibling)&&new C(b);while(f&&c&&!c(f));return f},_4e_outerHtml:function(b){b=h(b);if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var c=b.ownerDocument.createElement("div");
c.appendChild(b.cloneNode(true));return c.innerHTML},_4e_setMarker:function(b,c,f,e){b[0]||(b=new C(b));var m=b._4e_getData("list_marker_id")||b._4e_setData("list_marker_id",A.guid())._4e_getData("list_marker_id"),j=b._4e_getData("list_marker_names")||b._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[m]=b;j[f]=1;return b._4e_setData(f,e)},_4e_clearMarkers:function(b,c,f){b=l(b);var e=b._4e_getData("list_marker_names"),m=b._4e_getData("list_marker_id");for(var j in e)b._4e_removeData(j);
b._4e_removeData("list_marker_names");if(f){b._4e_removeData("list_marker_id");delete c[m]}},_4e_setData:function(b,c,f){var e=r._4e_getUniqueId(b);(k[e]||(k[e]={}))[c]=f;return b},_4e_getData:function(b,c){b=h(b);return(b=(b=b.getAttribute("_ke_expando"))&&k[b])&&b[c]},_4e_removeData:function(b,c){b=h(b);var f=b.getAttribute("_ke_expando");var e=(f=f&&k[f])&&f[c];typeof e!="undefined"&&f&&delete f[c];A.isEmptyObject(f)&&r._4e_clearData(b);return e||null},_4e_clearData:function(b){b=h(b);var c=b.getAttribute("_ke_expando");
c&&delete k[c];c&&b.removeAttribute("_ke_expando")},_4e_getUniqueId:function(b){b=h(b);var c=b.getAttribute("_ke_expando");if(c)return c;c=A.guid();b.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(b,c,f){b=h(b);var e=b.attributes;f=f||{};for(var m=0;m<e.length;m++){var j=e[m],a=j.nodeName.toLowerCase(),d;if(!(a in f))if(a=="checked"&&(d=r.attr(b,a)))c.attr(a,d);else if(j.specified||x.ie&&j.nodeValue&&a=="value"){d=r.attr(b,a);if(d===null)d=j.nodeValue;c.attr(a,d)}}if(b.style.cssText!==
"")c[0].style.cssText=b.style.cssText},_4e_isEditable:function(b){b=r._4e_name(b);var c=w.XHTML_DTD;return(b=!c.$nonEditable[b]&&(c[b]||c.span))&&b["#"]},_4e_scrollIntoView:function(b){b=l(b);var c=b[0].ownerDocument,f=r.scrollLeft(c),e=r.scrollTop(c),m=b.offset(),j=m.left;m=m.top;if(r.viewportHeight(c)+e<m||m<e||r.viewportWidth(c)+f<j||j<f)b.scrollIntoView(c)},_4e_getElementsByTagName:function(b,c,f){b=h(b);if(!x.ie&&f)c=f+":"+c;f=[];b=b.getElementsByTagName(c);for(c=0;c<b.length;c++)f.push(new C(b[c]));
return f}};A.DOM._4e_inject=function(b){A.mix(r,b);for(var c in b)b.hasOwnProperty(c)&&function(f){C.prototype[f]=function(){var e=[].slice.call(arguments,0);e.unshift(this);return b[f].apply(null,e)}}(c)};A.DOM._4e_inject(t)});
KISSY.Editor.add("elementpath",function(w){function s(k){var o=null,q=null,h=[];for(k=k;k&&k[0];){if(k[0].nodeType==C.NODE_ELEMENT){if(!this.lastElement)this.lastElement=k;var l=k._4e_name();if(p.ie&&k[0].scopeName!="HTML")l=k[0].scopeName.toLowerCase()+":"+l;if(!q){if(!o&&v[l])o=k;if(i[l])if(!o&&l=="div"&&!g(k))o=k;else q=k}h.push(k);if(l=="body")break}k=k.parent()}this.block=o;this.blockLimit=q;this.elements=h}var A=KISSY,r=A.DOM,x=w.XHTML_DTD,C=w.NODE,p=A.UA,v={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},g=function(k){k=k[0]||k;k=k.childNodes;for(var o=0,q=k.length;o<q;o++){var h=k[o];if(h.nodeType==C.NODE_ELEMENT&&x.$block[h.nodeName.toLowerCase()])return true}return false};s.prototype={compare:function(k){var o=this.elements;k=k&&k.elements;if(!k||o.length!=k.length)return false;for(var q=0;q<o.length;q++)if(!r._4e_equals(o[q],k[q]))return false;return true},contains:function(k){for(var o=
this.elements,q=0;q<o.length;q++)if(o[q]._4e_name()in k)return o[q];return null}};w.ElementPath=s});
KISSY.Editor.add("walker",function(w){function s(i,g){if(this._.end)return null;var k=this.range,o,q=this.guard,h=this.type,l=i?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;k.trim();if(k.collapsed){this.end();return null}}if(!i&&!this._.guardLTR){var t=k.endContainer,b=new v(t[0].childNodes[k.endOffset]);this._.guardLTR=function(m,j){return(!j||!p._4e_equals(t,m))&&(!b[0]||m[0]!==b[0])&&(m[0].nodeType!=C.NODE_ELEMENT||!j||m._4e_name()!="body")}}if(i&&!this._.guardRTL){var c=
k.startContainer,f=k.startOffset>0&&new v(c[0].childNodes[k.startOffset-1]);this._.guardRTL=function(m,j){return m&&m[0]&&(!j||c[0]!==m[0])&&(!f[0]||m[0]!==f[0])&&(m[0].nodeType!=C.NODE_ELEMENT||!j||m._4e_name()!="body")}}var e=i?this._.guardRTL:this._.guardLTR;o=q?function(m,j){if(e(m,j)===false)return false;return q(m,j)}:e;if(this.current)i=this.current[l](false,h,o);else if(i){i=k.endContainer;if(k.endOffset>0){i=new v(i[0].childNodes[k.endOffset-1]);if(o(i)===false)i=null}else i=o(i,true)===
false?null:i._4e_previousSourceNode(true,h,o)}else{i=k.startContainer;if((i=new v(i[0].childNodes[k.startOffset]))&&i[0]){if(o(i)===false)i=null}else i=o(k.startContainer,true)===false?null:k.startContainer._4e_nextSourceNode(true,h,o)}for(;i&&i[0]&&!this._.end;){this.current=i;if(!this.evaluator||this.evaluator(i)!==false){if(!g)return i}else if(g&&this.evaluator)return false;i=i[l](false,h,o)}this.end();return this.current=null}function A(i){for(var g,k=null;g=s.call(this,i);)k=g;return k}function r(i){this.range=
i;this._={}}var x=KISSY,C=w.NODE,p=x.DOM,v=x.Node;x.augment(r,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,true)},checkForward:function(){return s.call(this,false,true)!==false},checkBackward:function(){return s.call(this,true,true)!==false},lastForward:function(){return A.call(this)},lastBackward:function(){return A.call(this,true)},reset:function(){delete this.current;this._={}}});r.blockBoundary=function(i){return function(g){g[0]||(g=
new v(g));return!(g[0].nodeType==C.NODE_ELEMENT&&g._4e_isBlockBoundary(i))}};r.listItemBoundary=function(){return this.blockBoundary({br:1})};r.bookmark=function(i,g){function k(o){return o&&o[0]&&o._4e_name()=="span"&&o.attr("_ke_bookmark")}return function(o){var q,h;q=o&&o[0]&&o[0].nodeType==C.NODE_TEXT&&(h=o.parent())&&k(h);q=i?q:q||k(o);return g^q}};r.whitespaces=function(i){return function(g){g=(g=g[0]||g)&&g.nodeType==C.NODE_TEXT&&!x.trim(g.nodeValue);return i^g}};r.invisible=function(i){var g=
r.whitespaces();return function(k){k=g(k)||k[0].nodeType==C.NODE_ELEMENT&&!k[0].offsetHeight;return i^k}};w.Walker=r});
KISSY.Editor.add("range",function(w){function s(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=a}function A(a){var d=a[0].nodeType!=i.NODE_TEXT&&a._4e_name()in t.$removeEmpty,n=!v.trim(a[0].nodeValue);a=!!a.parent().attr("_ke_bookmark");return d||n||a}function r(a){return!m(a)&&!j(a)}function x(a){var d=false,n=o.bookmark(true);return function(z){if(n(z))return true;if(z[0].nodeType==i.NODE_TEXT){if(v.trim(z[0].nodeValue).length)return false}else if(z[0].nodeType==
i.NODE_ELEMENT)if(!e[z._4e_name()])if(!a&&!l.ie&&z._4e_name()=="br"&&!d)d=true;else return false;return true}}function C(a,d){function n(z){return z&&z.nodeName=="span"&&z.getAttribute("_ke_bookmark")}return function(z){var y,B;y=z&&!z.nodeName&&(B=z.parentNode)&&n(B);y=a?y:y||n(z);return d^y}}function p(a){return function(d){d=(d=d[0]||d)&&d.nodeType==i.NODE_TEXT&&!v.trim(d.nodeValue);return a^d}}w.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var v=KISSY,i=w.NODE,g=w.RANGE,k=w.POSITION,o=w.Walker,q=v.DOM,h=w.Utils.getByAddress,l=v.UA,t=w.XHTML_DTD,b=w.ElementPath,c=v.Node,f={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};s.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};v.augment(s,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&q._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,d=this.startOffset;if(a[0].nodeType!=i.NODE_ELEMENT)if(d)d>=a[0].nodeValue.length&&this.setStartAfter(a);else this.setStartBefore(a);a=this.endContainer;d=this.endOffset;if(a[0].nodeType!=i.NODE_ELEMENT)if(d)d>=a[0].nodeValue.length&&
this.setEndAfter(a);else this.setEndBefore(a)},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,d=this.endContainer;a&&a._4e_name()=="span"&&a.attr("_ke_bookmark")&&this.setStartAt(a,g.POSITION_BEFORE_START);d&&d._4e_name()=="span"&&
d.attr("_ke_bookmark")&&this.setEndAt(d,g.POSITION_AFTER_END)},setStart:function(a,d){if(a[0].nodeType==i.NODE_ELEMENT&&f[a._4e_name()]){a=a.parent();d=a._4e_index()}this.startContainer=a;this.startOffset=d;if(!this.endContainer){this.endContainer=a;this.endOffset=d}this.updateCollapsed()},setEnd:function(a,d){if(a[0].nodeType==i.NODE_ELEMENT&&f[a._4e_name()]){a=a.parent();d=a._4e_index()+1}this.endContainer=a;this.endOffset=d;if(!this.startContainer){this.startContainer=a;this.startOffset=d}this.updateCollapsed()},
setStartAt:function(a,d){switch(d){case g.POSITION_AFTER_START:this.setStart(a,0);break;case g.POSITION_BEFORE_END:a[0].nodeType==i.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setStartBefore(a);break;case g.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,d){switch(d){case g.POSITION_AFTER_START:this.setEnd(a,0);break;case g.POSITION_BEFORE_END:a[0].nodeType==i.NODE_TEXT?this.setEnd(a,
a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setEndBefore(a);break;case g.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},execContentsAction:function(a,d){var n=this.startContainer,z=this.endContainer,y=this.startOffset,B=this.endOffset,G,M;this.optimizeBookmark();if(z[0].nodeType==i.NODE_TEXT)z=z._4e_splitText(B);else if(z[0].childNodes.length>0)if(B>=z[0].childNodes.length){z=new c(z[0].appendChild(this.document.createTextNode("")));
M=true}else z=new c(z[0].childNodes[B]);if(n[0].nodeType==i.NODE_TEXT){n._4e_splitText(y);if(q._4e_equals(n,z))z=new c(n[0].nextSibling)}else if(y)if(y>=n[0].childNodes.length){G=new c(this.document.createTextNode(""));n[0].appendChild(G[0]);n=G;G=true}else n=new c(n[0].childNodes[y].previousSibling);else{G=new c(this.document.createTextNode(""));q.insertBefore(G[0],n[0].firstChild);n=G;G=true}y=n._4e_parents();B=z._4e_parents();var u,D,I;for(u=0;u<y.length;u++){D=y[u];I=B[u];if(D[0]!==I[0])break}for(var L=
d,N,O,S,R=u;R<y.length;R++){N=y[R];if(L&&N[0]!==n[0])O=L.appendChild(N._4e_clone()[0]);for(N=N[0].nextSibling;N;){if(B[R]&&N==B[R][0]||N==z[0])break;S=N.nextSibling;if(a==2)L.appendChild(N.cloneNode(true));else{N.parentNode.removeChild(N);a==1&&L.appendChild(N)}N=S}if(O)L=O}L=d;for(d=u;d<B.length;d++){N=B[d];if(a>0&&N[0]!==z[0])O=L.appendChild(N._4e_clone()[0]);if(!y[d]||N[0].parentNode!==y[d][0].parentNode)for(N=N[0].previousSibling;N;){if(y[d]&&N==y[d][0]||N===n[0])break;S=N.previousSibling;if(a==
2)L.insertBefore(N.cloneNode(true),L.firstChild);else{N.parentNode.removeChild(N);a==1&&L.insertBefore(N,L.firstChild)}N=S}if(O)L=O}if(a==2){I=this.startContainer[0];if(I.nodeType==i.NODE_TEXT&&I.nextSibling&&I.nextSibling.nodeType==i.NODE_TEXT){I.data+=I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}I=this.endContainer[0];if(I.nodeType==i.NODE_TEXT&&I.nextSibling&&I.nextSibling.nodeType==i.NODE_TEXT){I.data+=I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}}else{if(D&&I&&(n[0].parentNode!=
D[0].parentNode||z[0].parentNode!=I[0].parentNode)){a=I._4e_index();G&&I[0].parentNode==n[0].parentNode&&a--;this.setStart(I.parent(),a)}this.collapse(true)}G&&n._4e_remove();M&&z[0].parentNode&&z._4e_remove()},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var a=new s(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;
a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=i.NODE_ELEMENT||a.endContainer[0].nodeType!=i.NODE_ELEMENT)return null;a=a.startContainer[0].childNodes[a.startOffset];for(var d=C(true,undefined),n=p(true),z=function(y){return n(y)&&d(y)};a&&z(a);)a=(new c(a))._4e_nextSourceNode()[0];return new c(a)},shrink:function(a,d){if(!this.collapsed){a=a||g.SHRINK_TEXT;
var n=this.clone(),z=this.startContainer,y=this.endContainer,B=this.startOffset,G=this.endOffset,M=1,u=1;if(z&&z[0].nodeType==i.NODE_TEXT)if(B)if(B>=z[0].nodeValue.length)n.setStartAfter(z);else{n.setStartBefore(z);M=0}else n.setStartBefore(z);if(y&&y[0].nodeType==i.NODE_TEXT)if(G)if(G>=y[0].nodeValue.length)n.setEndAfter(y);else{n.setEndAfter(y);u=0}else n.setEndBefore(y);n=new o(n);n.evaluator=function(I){I=I[0]||I;return I.nodeType==(a==g.SHRINK_ELEMENT?i.NODE_ELEMENT:i.NODE_TEXT)};var D;n.guard=
function(I,L){I=I[0]||I;if(a==g.SHRINK_ELEMENT&&I.nodeType==i.NODE_TEXT)return false;if(L&&I==D)return false;if(!L&&I.nodeType==i.NODE_ELEMENT)D=I;return true};if(M)(z=n[a==g.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(z,d?g.POSITION_AFTER_START:g.POSITION_BEFORE_START);if(u){n.reset();(n=n[a==g.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,d?g.POSITION_BEFORE_END:g.POSITION_AFTER_END)}return!!(M||u)}},getTouchedStartNode:function(){var a=this.startContainer;if(this.collapsed||
a[0].nodeType!=i.NODE_ELEMENT)return a;return a.childNodes[this.startOffset]||a},createBookmark2:function(a){var d=this.startContainer,n=this.endContainer,z=this.startOffset,y=this.endOffset,B,G;if(!d||!n)return{start:0,end:0};if(a){if(d[0].nodeType==i.NODE_ELEMENT)if((B=new c(d[0].childNodes[z]))&&B[0]&&B[0].nodeType==i.NODE_TEXT&&z>0&&B[0].previousSibling.nodeType==i.NODE_TEXT){d=B;z=0}for(;d[0].nodeType==i.NODE_TEXT&&(G=d._4e_previous())&&G[0].nodeType==i.NODE_TEXT;){d=G;z+=G[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==
i.NODE_ELEMENT)if((B=new c(n[0].childNodes[y]))&&B[0]&&B[0].nodeType==i.NODE_TEXT&&y>0&&B[0].previousSibling.nodeType==i.NODE_TEXT){n=B;y=0}for(;n[0].nodeType==i.NODE_TEXT&&(G=n._4e_previous())&&G[0].nodeType==i.NODE_TEXT;){n=G;y+=G[0].nodeValue.length}}}return{start:d._4e_address(a),end:this.collapsed?null:n._4e_address(a),startOffset:z,endOffset:y,normalized:a,is2:true}},createBookmark:function(a){var d,n,z,y;d=new c("<span></span>",null,this.document);d.attr("_ke_bookmark",1);d.css("display","none");
d.html("&nbsp;");if(a){z=v.guid("ke_bm_");d.attr("id",z+"S")}if(!this.collapsed){n=d._4e_clone();n.html("&nbsp;");a&&n.attr("id",z+"E");y=this.clone();y.collapse();y.insertNode(n)}y=this.clone();y.collapse(true);y.insertNode(d);if(n){this.setStartAfter(d);this.setEndBefore(n)}else this.moveToPosition(d,g.POSITION_AFTER_END);return{startNode:a?z+"S":d,endNode:a?z+"E":n,serializable:a}},moveToPosition:function(a,d){this.setStartAt(a,d);this.collapse(true)},trim:function(a,d){var n=this.startContainer,
z=this.startOffset,y=this.collapsed;if((!a||y)&&n[0]&&n[0].nodeType==i.NODE_TEXT){if(z)if(z>=n[0].nodeValue.length){z=n._4e_index()+1;n=n.parent()}else{a=n._4e_splitText(z);z=n._4e_index()+1;n=n.parent();if(q._4e_equals(this.startContainer,this.endContainer))this.setEnd(a,this.endOffset-this.startOffset);else if(q._4e_equals(n,this.endContainer))this.endOffset+=1}else{z=n._4e_index();n=n.parent()}this.setStart(n,z);if(y){this.collapse(true);return}}n=this.endContainer;z=this.endOffset;if(!(d||y)&&
n[0]&&n[0].nodeType==i.NODE_TEXT){if(z){z>=n.nodeValue.length||n._4e_splitText(z);z=n._4e_index()+1}else z=n._4e_index();n=n.parent();this.setEnd(n,z)}},insertNode:function(a){this.optimizeBookmark();this.trim(false,true);var d=this.startContainer,n=d[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);n?q.insertBefore(a[0]||a,n):d[0].appendChild(a[0]||a);q._4e_equals(a.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){if(a.is2){var d=
h(this.document,a.start,a.normalized),n=a.startOffset,z=a.end&&h(this.document,a.end,a.normalized);a=a.endOffset;this.setStart(d,n);z?this.setEnd(z,a):this.collapse(true)}else{d=(n=a.serializable)?v.one("#"+a.startNode,this.document):a.startNode;a=n?v.one("#"+a.endNode,this.document):a.endNode;this.setStartBefore(d);d._4e_remove();if(a&&a[0]){this.setEndBefore(a);a._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(a,d){var n=this.startContainer,z=this.endContainer;a=q._4e_equals(n,
z)?a&&n[0].nodeType==i.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(z);return d&&a[0].nodeType==i.NODE_TEXT?a.parent():a},enlarge:function(a){switch(a){case g.ENLARGE_ELEMENT:if(this.collapsed)return;a=this.getCommonAncestor();var d=new c(this.document.body),n,z,y,B,G,M=false,u,D;u=this.startContainer;D=this.startOffset;if(u[0].nodeType==i.NODE_TEXT){if(D){u=!v.trim(u[0].nodeValue.substring(0,D)).length&&u;M=!!u}if(u)if(!(B=u[0].previousSibling))y=
u.parent()}else{if(D)B=u[0].childNodes[D-1]||u[0].lastChild;B||(y=u)}for(;y||B;){if(y&&!B){if(!G&&q._4e_equals(y,a))G=true;if(!d._4e_contains(y))break;if(!M||y.css("display")!="inline"){M=false;if(G)n=y;else this.setStartBefore(y)}B=y[0].previousSibling}for(;B;){u=false;if(B.nodeType==i.NODE_TEXT){D=B.nodeValue;if(/[^\s\ufeff]/.test(D))B=null;u=/[\s\ufeff]$/.test(D)}else if(B.offsetWidth>0&&!B.getAttribute("_ke_bookmark"))if(M&&t.$removeEmpty[B.nodeName.toLowerCase()]){D=q.text(B);if(/[^\s\ufeff]/.test(D))B=
null;else for(var I=B.all||B.getElementsByTagName("*"),L=0,N;N=I[L++];)if(!t.$removeEmpty[N.nodeName.toLowerCase()]){B=null;break}if(B)u=!!D.length}else B=null;if(u)if(M)if(G)n=y;else y&&this.setStartBefore(y);else M=true;if(B){u=B.previousSibling;if(!y&&!u){y=new c(B);B=null;break}B=u}else y=null}if(y)y=y.parent()}u=this.endContainer;D=this.endOffset;y=B=null;G=M=false;if(u[0].nodeType==i.NODE_TEXT){u=!v.trim(u[0].nodeValue.substring(D)).length&&u;M=!(u&&u[0].nodeValue.length);if(u)if(!(B=u[0].nextSibling))y=
u.parent()}else(B=u[0].childNodes[D])||(y=u);for(;y||B;){if(y&&!B){if(!G&&q._4e_equals(y,a))G=true;if(!d._4e_contains(y))break;if(!M||y.css("display")!="inline"){M=false;if(G)z=y;else y&&this.setEndAfter(y)}B=y[0].nextSibling}for(;B;){u=false;if(B.nodeType==i.NODE_TEXT){D=B.nodeValue;if(/[^\s\ufeff]/.test(D))B=null;u=/^[\s\ufeff]/.test(D)}else if(B.offsetWidth>0&&!B.getAttribute("_ke_bookmark"))if(M&&t.$removeEmpty[B.nodeName.toLowerCase()]){D=q.text(B);if(/[^\s\ufeff]/.test(D))B=null;else{I=B.all||
B.getElementsByTagName("*");for(L=0;N=I[L++];)if(!t.$removeEmpty[N.nodeName.toLowerCase()]){B=null;break}}if(B)u=!!D.length}else B=null;if(u)if(M)if(G)z=y;else this.setEndAfter(y);if(B){u=B.nextSibling;if(!y&&!u){y=new c(B);B=null;break}B=u}else y=null}if(y)y=y.parent()}if(n&&z){a=n._4e_contains(z)?z:n;this.setStartBefore(a);this.setEndAfter(a)}break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:y=new s(this.document);d=new c(this.document.body);y.setStartAt(d,g.POSITION_AFTER_START);
y.setEnd(this.startContainer,this.startOffset);y=new o(y);var O,S,R=o.blockBoundary(a==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),Y=function(X){var E=R(X);E||(O=X);return E};n=function(X){var E=Y(X);if(!E&&X[0]&&X._4e_name()=="br")S=X;return E};y.guard=Y;y=y.lastBackward();O=O||d;this.setStartAt(O,O._4e_name()!="br"&&(!y&&this.checkStartOfBlock()||y&&O._4e_contains(y))?g.POSITION_AFTER_START:g.POSITION_AFTER_END);y=this.clone();y.collapse();y.setEndAt(d,g.POSITION_BEFORE_END);y=new o(y);y.guard=a==
g.ENLARGE_LIST_ITEM_CONTENTS?n:Y;O=null;y=y.lastForward();O=O||d;this.setEndAt(O,!y&&this.checkEndOfBlock()||y&&O._4e_contains(y)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START);S&&this.setEndAfter(S)}},checkStartOfBlock:function(){var a=this.startContainer,d=this.startOffset;if(d&&a[0].nodeType==i.NODE_TEXT)if(v.trim(a[0].nodeValue.substring(0,d)).length)return false;this.trim();a=new b(this.startContainer);d=this.clone();d.collapse(true);d.setStartAt(a.block||a.blockLimit,g.POSITION_AFTER_START);
a=new o(d);a.evaluator=x(true);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,d=this.endOffset;if(a[0].nodeType==i.NODE_TEXT)if(v.trim(a[0].nodeValue.substring(d)).length)return false;this.trim();a=new b(this.endContainer);d=this.clone();d.collapse(false);d.setEndAt(a.block||a.blockLimit,g.POSITION_BEFORE_END);a=new o(d);a.evaluator=x(false);return a.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,d){var n=this.clone();n[d==g.START?"setStartAt":"setEndAt"](a,d==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);a=new o(n);a.evaluator=A;return a[d==g.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,d=this.endContainer,n=this.startOffset,z=this.endOffset,y;if(a[0].nodeType==i.NODE_ELEMENT){y=a[0].childNodes.length;if(y>
n)a=new c(a[0].childNodes[n]);else if(y<1)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new c(a);a=a._4e_nextSourceNode()||a}}if(d[0].nodeType==i.NODE_ELEMENT){y=d[0].childNodes.length;if(y>z)d=(new c(d[0].childNodes[z]))._4e_previousSourceNode(true);else if(y<1)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=new c(d)}}if(a._4e_position(d)&k.POSITION_FOLLOWING)a=d;return{startNode:a,endNode:d}},fixBlock:function(a,d){var n=this.createBookmark();
d=new c(this.document.createElement(d));this.collapse(a);this.enlarge(g.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();l.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(n);return d},splitBlock:function(a){var d=new b(this.startContainer),n=new b(this.endContainer),z=d.block,y=n.block,B=null;if(d.blockLimit[0]!==n.blockLimit[0])return null;if(a!="br"){if(!z){z=this.fixBlock(true,a);y=(new b(this.endContainer)).block}y||(y=this.fixBlock(false,a))}a=z&&this.checkStartOfBlock();
d=y&&this.checkEndOfBlock();this.deleteContents();if(z&&q._4e_equals(z,y))if(d){B=new b(this.startContainer);this.moveToPosition(y,g.POSITION_AFTER_END);y=null}else if(a){B=new b(this.startContainer);this.moveToPosition(z,g.POSITION_BEFORE_START);z=null}else{y=this.splitElement(z);!l.ie&&!v.inArray(z._4e_name(),["ul","ol"])&&z._4e_appendBogus()}return{previousBlock:z,nextBlock:y,wasStartOfBlock:a,wasEndOfBlock:d,elementPath:B}},splitElement:function(a){if(!this.collapsed)return null;this.setEndAt(a,
g.POSITION_BEFORE_END);var d=this.extractContents(),n=a._4e_clone(false);n[0].appendChild(d);n.insertAfter(a);this.moveToPosition(a,g.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(a,d){var n,z=w.XHTML_DTD;if(z.$empty[a._4e_name()])return false;for(;a&&a[0].nodeType==i.NODE_ELEMENT;){if(n=a._4e_isEditable())this.moveToPosition(a,d?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(z.$inline[a._4e_name()]){this.moveToPosition(a,d?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);
return true}if((a=z.$empty[a._4e_name()]?a[d?"_4e_previous":"_4e_next"](r):a[d?"_4e_last":"_4e_first"](r))&&a[0].nodeType==i.NODE_TEXT){this.moveToPosition(a,d?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return true}}return n},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==i.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var e={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},m=new o.whitespaces,j=new o.bookmark;w.Range=s});
KISSY.Editor.add("domiterator",function(w){function s(h){if(!(arguments.length<1)){this.range=h;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var A=KISSY,r=A.UA,x=w.Walker,C=w.Range,p=w.RANGE,v=w.NODE,i=w.ElementPath,g=A.Node,k=A.DOM,o=/^[\r\n\t ]*$/,q=x.bookmark();A.augment(s,{getNextParagraph:function(h){var l,t,b,c,f;if(!this._.lastNode){t=this.range.clone();t.enlarge(this.forceBrBreak||!this.enlargeBr?p.ENLARGE_LIST_ITEM_CONTENTS:p.ENLARGE_BLOCK_CONTENTS);
var e=new x(t),m=x.bookmark(true,true);e.evaluator=m;this._.nextNode=e.next();e=new x(t);e.evaluator=m;e=e.previous();this._.lastNode=e._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==v.NODE_TEXT&&!A.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){m=new C(t.document);m.moveToPosition(this._.lastNode,p.POSITION_AFTER_END);if(m.checkEndOfBlock()){m=new i(m.endContainer);this._.lastNode=(m.block||m.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new g(t.document.createTextNode(""));k.insertAfter(this._.lastNode[0],e[0])}t=null}m=this._.nextNode;e=this._.lastNode;for(this._.nextNode=null;m;){var j=false,a=m[0].nodeType!=v.NODE_ELEMENT,d=false;if(a){if(m[0].nodeType==v.NODE_TEXT)if(o.test(m[0].nodeValue))a=false}else{var n=m._4e_name();if(m._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(n=="br")a=true;else if(!t&&!m[0].childNodes.length&&n!="hr"){l=m;b=m._4e_equals(e);break}if(t){t.setEndAt(m,p.POSITION_BEFORE_START);
if(n!="br")this._.nextNode=m}j=true}else{if(m[0].firstChild){if(!t){t=new C(this.range.document);t.setStartAt(m,p.POSITION_BEFORE_START)}m=new g(m[0].firstChild);continue}a=true}}if(a&&!t){t=new C(this.range.document);t.setStartAt(m,p.POSITION_BEFORE_START)}b=(!j||a)&&m._4e_equals(e);if(t&&!j)for(;!m[0].nextSibling&&!b;){n=m.parent();if(n._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){j=true;b||n._4e_equals(e);break}m=n;a=true;b=m._4e_equals(e);d=true}a&&t.setEndAt(m,p.POSITION_AFTER_END);m=m._4e_nextSourceNode(d,
null,e);b=!m;if((j||b)&&t){a=t.getBoundaryNodes();j=new i(t.startContainer);if(a.startNode.parent()._4e_equals(j.blockLimit)&&q(a.startNode)&&q(a.endNode)){t=null;this._.nextNode=null}else break}if(b)break}if(!l){if(!t){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}j=new i(t.startContainer);m=j.blockLimit;a={div:1,th:1,td:1};l=j.block;if((!l||!l[0])&&!this.enforceRealBlocks&&a[m._4e_name()]&&t.checkStartOfBlock()&&t.checkEndOfBlock())l=m;else if(!l||this.enforceRealBlocks&&
l._4e_name()=="li"){l=new g(this.range.document.createElement(h||"p"));l[0].appendChild(t.extractContents());l._4e_trim();t.insertNode(l);c=f=true}else if(l._4e_name()!="li"){if(!t.checkStartOfBlock()||!t.checkEndOfBlock()){l=l._4e_clone(false);l[0].appendChild(t.extractContents());l._4e_trim();f=t.splitBlock();c=!f.wasStartOfBlock;f=!f.wasEndOfBlock;t.insertNode(l)}}else if(!b)this._.nextNode=l._4e_equals(e)?null:t.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,e)}if(c){t=new g(l[0].previousSibling);
if(t[0]&&t[0].nodeType==v.NODE_ELEMENT)if(t._4e_name()=="br")t._4e_remove();else t[0].lastChild&&t[0].lastChild.nodeName.toLowerCase()=="br"&&k._4e_remove(t[0].lastChild)}if(f){t=x.bookmark(false,true);c=new g(l[0].lastChild);if(c[0]&&c[0].nodeType==v.NODE_ELEMENT&&c._4e_name()=="br")if(r.ie||c._4e_previous(t)||c._4e_next(t))c._4e_remove()}if(!this._.nextNode)this._.nextNode=b||l._4e_equals(e)?null:l._4e_nextSourceNode(true,null,e);return l}});C.prototype.createIterator=function(){return new s(this)}});
KISSY.Editor.add("selection",function(w){function s(e){this.document=e;this._={cache:{}};if(C.ie){var m=this.getNative().createRange();if(!m||m.item&&m.item(0).ownerDocument!=e||m.parentElement&&m.parentElement().ownerDocument!=e)this.isInvalid=true}}function A(e){e=new s(e);return!e||e.isInvalid?null:e}function r(e){var m=e.document,j=new g(m.body),a=new g(m.documentElement);if(C.ie){if(C.ie<8||document.documentMode==7)a.on("click",function(B){p._4e_name(B.target)==="html"&&e.getSelection().getRanges()[0].select()});
var d,n;j.on("focusin",function(B){if(B.target.nodeName.toUpperCase()=="BODY")if(d){try{d.select()}catch(G){}d=null}});j.on("focus",function(){n=true;y()});j.on("beforedeactivate",function(B){B.relatedTarget||(n=false)});C.ie<8&&v.on(p._4e_getWin(m),"blur",function(){m.selection.empty()});j.on("mousedown",z);j.on("mouseup",function(){n=true;setTimeout(function(){y(true)},0)});j.on("keydown",z);j.on("keyup",function(){n=true;y()});v.on(m,"selectionchange",y);var z=function(){n=false},y=function(B){if(n){var G=
e.document,M=e.getSelection(),u=M.getType(),D=M&&M.getNative();if(B&&D&&u==k.SELECTION_NONE)if(!G.queryCommandEnabled("InsertImage")){setTimeout(function(){y(true)},50);return}var I;if(!(D&&u==k.SELECTION_TEXT&&(I=p._4e_name(D.createRange().parentElement()))&&I in{input:1,textarea:1})){d=D&&M.getRanges()[0];e._monitor()}}}}else{v.on(m,"mouseup",e._monitor,e);v.on(m,"keyup",e._monitor,e)}}w.SELECTION={};var x=KISSY,C=x.UA,p=x.DOM,v=x.Event,i=w.Utils.tryThese,g=x.Node,k=w.SELECTION,o=w.RANGE,q=w.NODE,
h=w.Walker,l=w.Range;k.SELECTION_NONE=1;k.SELECTION_TEXT=2;k.SELECTION_ELEMENT=3;var t={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};x.augment(s,{getNative:C.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=p._4e_getWin(this.document).getSelection())},getType:C.ie?function(){var e=this._.cache;
if(e.type)return e.type;var m=k.SELECTION_NONE;try{var j=this.getNative(),a=j.type;if(a=="Text")m=k.SELECTION_TEXT;if(a=="Control")m=k.SELECTION_ELEMENT;if(j.createRange().parentElement)m=k.SELECTION_TEXT}catch(d){}return e.type=m}:function(){var e=this._.cache;if(e.type)return e.type;var m=k.SELECTION_TEXT,j=this.getNative();if(j){if(j.rangeCount==1){j=j.getRangeAt(0);var a=j.startContainer;if(a==j.endContainer&&a.nodeType==q.NODE_ELEMENT&&j.endOffset-j.startOffset===1&&t[a.childNodes[j.startOffset].nodeName.toLowerCase()])m=
k.SELECTION_ELEMENT}}else m=k.SELECTION_NONE;return e.type=m},getRanges:C.ie?function(){var e=function(m,j){m=m.duplicate();m.collapse(j);j=m.parentElement();for(var a=j.childNodes,d,n=0;n<a.length;n++){var z=a[n];if(z.nodeType==q.NODE_ELEMENT){d=m.duplicate();d.moveToElementText(z);z=d.compareEndPoints("StartToStart",m);var y=d.compareEndPoints("EndToStart",m);d.collapse();if(z>0)break;else if(!z||y==1&&z==-1)return{container:j,offset:n};else if(!y)return{container:j,offset:n+1};d=null}}if(!d){d=
m.duplicate();d.moveToElementText(j);d.collapse(false)}d.setEndPoint("StartToStart",m);m=d.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;m>0;)m-=a[--n].nodeValue.length}catch(B){m=0}return m===0?{container:j,offset:n}:{container:a[n],offset:-m}};return function(){var m=this._.cache;if(m.ranges)return m.ranges;var j=this.getNative(),a=j&&j.createRange(),d=this.getType();if(!j)return[];if(d==k.SELECTION_TEXT){j=new l(this.document);d=e(a,true);j.setStart(new g(d.container),d.offset);d=e(a);j.setEnd(new g(d.container),
d.offset);return m.ranges=[j]}else if(d==k.SELECTION_ELEMENT){m=this._.cache.ranges=[];for(d=0;d<a.length;d++){var n=a.item(d),z=n.parentNode,y=0;for(j=new l(this.document);y<z.childNodes.length&&z.childNodes[y]!=n;y++);j.setStart(new g(z),y);j.setEnd(new g(z),y+1);m.push(j)}return m}return m.ranges=[]}}():function(){var e=this._.cache;if(e.ranges)return e.ranges;var m=[],j=this.getNative();if(!j)return[];for(var a=0;a<j.rangeCount;a++){var d=j.getRangeAt(a),n=new l(this.document);n.setStart(new g(d.startContainer),
d.startOffset);n.setEnd(new g(d.endContainer),d.endOffset);m.push(n)}return e.ranges=m},getStartElement:function(){var e=this._.cache;if(e.startElement!==undefined)return e.startElement;var m,j=this.getNative();switch(this.getType()){case k.SELECTION_ELEMENT:return this.getSelectedElement();case k.SELECTION_TEXT:var a=this.getRanges()[0];if(a)if(!a.collapsed){for(a.optimize();;){m=a.startContainer;if(a.startOffset==(m[0].nodeType===q.NODE_ELEMENT?m[0].childNodes.length:m[0].nodeValue.length)&&!m._4e_isBlockBoundary())a.setStartAfter(m);
else break}m=a.startContainer;if(m[0].nodeType!=q.NODE_ELEMENT)return m.parent();m=new g(m[0].childNodes[a.startOffset]);if(!m[0]||m[0].nodeType!=q.NODE_ELEMENT)return a.startContainer;for(a=m[0].firstChild;a&&a.nodeType==q.NODE_ELEMENT;){m=new g(a);a=a.firstChild}return m}if(C.ie){a=j.createRange();a.collapse(true);m=a.parentElement()}else if((m=j.anchorNode)&&m.nodeType!=q.NODE_ELEMENT)m=m.parentNode}return e.startElement=m?new g(m):null},getSelectedElement:function(){var e=this._.cache;if(e.selectedElement!==
undefined)return e.selectedElement;var m=this,j=i(function(){return m.getNative().createRange().item(0)},function(){for(var a=m.getRanges()[0],d,n,z=2;z&&!((d=a.getEnclosedNode())&&d[0].nodeType==q.NODE_ELEMENT&&t[d._4e_name()]&&(n=d));z--)a.shrink(o.SHRINK_ELEMENT);return n[0]});return e.selectedElement=j?new g(j):null},reset:function(){this._.cache={}},selectElement:function(e){var m;if(C.ie)try{m=this.document.body.createControlRange();m.addElement(e[0]);m.select()}catch(j){m=this.document.body.createTextRange();
m.moveToElementText(e[0]);m.select()}finally{}else{m=this.document.createRange();m.selectNode(e[0]);e=this.getNative();e.removeAllRanges();e.addRange(m)}this.reset()},selectRanges:function(e){if(C.ie)e[0]&&e[0].select();else{var m=this.getNative();if(!m)return;m.removeAllRanges();for(var j=0;j<e.length;j++){var a=e[j],d=this.document.createRange(),n=a.startContainer;a.collapsed&&C.gecko&&C.gecko<1.09&&n[0].nodeType==q.NODE_ELEMENT&&!n[0].childNodes.length&&n[0].appendChild(this.document.createTextNode(""));
d.setStart(n[0],a.startOffset);d.setEnd(a.endContainer[0],a.endOffset);m.addRange(d)}}this.reset()},createBookmarks2:function(e){for(var m=[],j=this.getRanges(),a=0;a<j.length;a++)m.push(j[a].createBookmark2(e));return m},createBookmarks:function(e){for(var m=[],j=this.getRanges(),a=j.length,d=this.document,n,z=0;z<a;z++){m.push(n=j[z].createBookmark(e,true));var y=(e=n.serializable)?x.one("#"+n.startNode,d):n.startNode;n=e?x.one("#"+n.endNode,d):n.endNode;for(var B=z+1;B<a;B++){var G=j[B],M=G.startContainer,
u=G.endContainer;p._4e_equals(M,y.parent())&&G.startOffset++;p._4e_equals(M,n.parent())&&G.startOffset++;p._4e_equals(u,y.parent())&&G.endOffset++;p._4e_equals(u,n.parent())&&G.endOffset++}}return m},selectBookmarks:function(e){for(var m=[],j=0;j<e.length;j++){var a=new l(this.document);a.moveToBookmark(e[j]);m.push(a)}this.selectRanges(m);return this},getCommonAncestor:function(){var e=this.getRanges();return e[0].startContainer._4e_commonAncestor(e[e.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
w.Selection=s;var b={table:1,tbody:1,tr:1},c=h.whitespaces(true),f=/\ufeff|\u00a0/;l.prototype.select=C.ie?function(e){var m=this.collapsed,j,a;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var d=this.startContainer[0].childNodes[this.startOffset];if(d.nodeType==q.NODE_ELEMENT){(new s(this.document)).selectElement(new g(d));return}}if(this.startContainer[0].nodeType==q.NODE_ELEMENT&&this.startContainer._4e_name()in b||this.endContainer[0].nodeType==q.NODE_ELEMENT&&
this.endContainer._4e_name()in b)this.shrink(q.NODE_ELEMENT,true);var n=this.createBookmark();d=n.startNode;var z;if(!m)z=n.endNode;n=this.document.body.createTextRange();n.moveToElementText(d[0]);n.moveStart("character",1);if(z){e=this.document.body.createTextRange();e.moveToElementText(z[0]);n.setEndPoint("EndToEnd",e);n.moveEnd("character",-1)}else{for(j=d[0].nextSibling;j&&!c(j);)j=j.nextSibling;j=!(j&&j.nodeValue&&j.nodeValue.match(f))&&(e||!d[0].previousSibling||d[0].previousSibling&&p._4e_name(d[0].previousSibling)==
"br");a=this.document.createElement("span");a.innerHTML="&#65279;";a=new g(a);p.insertBefore(a[0],d[0]);j&&p.insertBefore(this.document.createTextNode("\ufeff"),d[0])}this.setStartBefore(d);d._4e_remove();if(m){if(j){n.moveStart("character",-1);n.select();this.document.selection.clear()}else n.select();if(a){this.moveToPosition(a,o.POSITION_BEFORE_START);a._4e_remove()}}else{this.setEndBefore(z);z._4e_remove();n.select()}}:function(){var e=this.startContainer;this.collapsed&&e[0].nodeType==q.NODE_ELEMENT&&
!e[0].childNodes.length&&e[0].appendChild(this.document.createTextNode(""));var m=this.document.createRange();m.setStart(e[0],this.startOffset);try{m.setEnd(this.endContainer[0],this.endOffset)}catch(j){if(j.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);m.setEnd(this.endContainer[0],this.endOffset)}else throw j;}e=A(this.document).getNative();e.removeAllRanges();e.addRange(m)};w.on("instanceCreated",function(e){r(e.editor)})});
KISSY.Editor.add("styles",function(w){function s(E,F){for(var H in E)E[H]=E[H].replace(X,function(K,J){return F[J]})}function A(E,F){if(F){E=z.clone(E);s(E.attributes,F);s(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||S[F]?B.STYLE_BLOCK:R[F]?B.STYLE_OBJECT:B.STYLE_INLINE;this._={definition:E}}function r(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new M(E);for(var H=E.getRanges(),K=0;K<H.length;K++)F.call(this,H[K]);E.selectRanges(H)}function x(E,
F){var H=E.element;if(H=="*")H="span";F=new L(F.createElement(H));return C(F,E)}function C(E,F){var H=F._.definition;F=H.attributes;H=A.getStyleText(H);if(F)for(var K in F)E.attr(K,F[K]);if(H)E[0].style.cssText=H;return E}function p(E){var F=E.createBookmark(true),H=E.createIterator();H.enforceRealBlocks=true;H.enlargeBr=true;for(var K,J=E.document;K=H.getNextParagraph();){var P=x(this,J);k(K,P)}E.moveToBookmark(F)}function v(E,F,H){var K="",J="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(P,Q,T){Q&&(K=Q);T&&(J=T);return""});return K+E.replace(F,H)+J}function i(E,F){var H=E.html();H=v(H,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");H=H.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");H=H.replace(/([ \t\n\r]+|&nbsp;)/g," ");H=H.replace(/<br\b[^>]*>/gi,"\n");if(N.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+H+"</pre>";F=new L(E.firstChild);F._4e_remove()}else F.html(H);return F}function g(E){var F=[];v(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(H,K,J){return K+"</pre>"+J+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(H,K){F.push(K)});return F}function k(E,F){var H=F._4e_name=="pre",K=E._4e_name=="pre",J=!H&&K;if(H&&!K)F=i(E,F);else if(J)F=q(g(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);H&&o(F)}function o(E){var F;if((F=E._4e_previousSourceNode(true,u.NODE_ELEMENT))&&F._4e_name()=="pre"){var H=v(F.html(),/\n$/,"")+"\n\n"+v(E.html(),/^\n/,"");if(N.ie)E[0].outerHTML="<pre>"+H+"</pre>";else E.html(H);
F._4e_remove()}}function q(E,F){for(var H=F[0].ownerDocument.createDocumentFragment(),K=0;K<E.length;K++){var J=E[K];J=J.replace(/(\r\n|\r)/g,"\n");J=v(J,/^[ \t]*\n/,"");J=v(J,/\n$/,"");J=v(J,/^[ \t]+|[ \t]+$/g,function(Q,T){return Q.length==1?"&nbsp;":T?" "+(new Array(Q.length)).join("&nbsp;"):(new Array(Q.length)).join("&nbsp;")+" "});J=J.replace(/\n/g,"<br>");J=J.replace(/[ \t]{2,}/g,function(Q){return(new Array(Q.length)).join("&nbsp;")+" "});var P=F._4e_clone();P.html(J);H.appendChild(P[0])}return H}
function h(E){var F=E.document;if(E.collapsed){F=x(this,F);E.insertNode(F);E.moveToPosition(F,G.POSITION_BEFORE_END)}else{var H=this.element,K=this._.definition,J,P=w.XHTML_DTD[H]||(J=true,w.XHTML_DTD.span),Q=E.createBookmark();E.enlarge(G.ENLARGE_ELEMENT);E.trim();var T=E.createBookmark(),da=T.startNode;T=T.endNode;for(var V=da,Z;V&&V[0];){var U=false;if(y._4e_equals(V,T)){V=null;U=true}else{var W=V[0].nodeType,ba=W==u.NODE_ELEMENT?V._4e_name():null;if(ba&&V.attr("_ke_bookmark")){V=V._4e_nextSourceNode(true);
continue}if(!ba||P[ba]&&(V._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(V))){var ca=V.parent();if(ca&&ca[0]&&((w.XHTML_DTD[ca._4e_name()]||w.XHTML_DTD.span)[H]||J)&&(!K.parentRule||K.parentRule(ca))){if(!Z&&(!ba||!w.XHTML_DTD.$removeEmpty[ba]||(V._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+
D.POSITION_IS_CONTAINED)){Z=new I(F);Z.setStartBefore(V)}if(W==u.NODE_TEXT||W==u.NODE_ELEMENT&&!V[0].childNodes.length){W=V;for(var $;!W[0].nextSibling&&($=W.parent(),P[$._4e_name()])&&($._4e_position(da)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule($));)W=$;Z.setEndAfter(W);W[0].nextSibling||(U=true)}}else U=true}else U=true;V=V._4e_nextSourceNode()}if(U&&Z&&!Z.collapsed){U=x(this,
F);for(W=Z.getCommonAncestor();U&&W&&U[0]&&W[0];){if(W._4e_name()==H){for(var aa in K.attributes)U.attr(aa)==W.attr(aa)&&U[0].removeAttribute(aa);for(var ea in K.styles)U._4e_style(ea)==W._4e_style(ea)&&U._4e_style(ea,"");if(!U._4e_hasAttributes()){U=null;break}}W=W.parent()}if(U){U[0].appendChild(Z.extractContents());a(this,U);Z.insertNode(U);U._4e_mergeSiblings();N.ie||U[0].normalize()}Z=null}}da._4e_remove();T._4e_remove();E.moveToBookmark(Q);E.shrink(G.SHRINK_TEXT)}}function l(E){E.enlarge(G.ENLARGE_ELEMENT);
var F=E.createBookmark(),H=F.startNode;if(E.collapsed){for(var K=new O(H.parent()),J,P=0,Q;P<K.elements.length&&(Q=K.elements[P]);P++){if(Q==K.block||Q==K.blockLimit)break;if(this.checkElementRemovable(Q)){var T=E.checkBoundaryOfElement(Q,G.END),da=!T&&E.checkBoundaryOfElement(Q,G.START);if(da||T){J=Q;J.match=da?"start":"end"}else{Q._4e_mergeSiblings();Q._4e_name()==this.element?m(this,Q):d(Q,e(this)[Q._4e_name()])}}}if(J&&J[0]){Q=H;for(P=0;;P++){T=K.elements[P];if(y._4e_equals(T,J))break;else if(T.match)continue;
else T=T._4e_clone();T[0].appendChild(Q[0]);Q=T}y[J.match=="start"?"insertBefore":"insertAfter"](Q[0],J[0])}}else{var V=F.endNode,Z=this;K=function(){for(var U=new O(H.parent()),W=new O(V.parent()),ba=null,ca=null,$=0;$<U.elements.length;$++){var aa=U.elements[$];if(aa==U.block||aa==U.blockLimit)break;if(Z.checkElementRemovable(aa))ba=aa}for($=0;$<W.elements.length;$++){aa=W.elements[$];if(aa==W.block||aa==W.blockLimit)break;if(Z.checkElementRemovable(aa))ca=aa}ca&&V._4e_breakParent(ca);ba&&H._4e_breakParent(ba)};
K();for(J=new L(H[0].nextSibling);J[0]!==V[0];){P=J._4e_nextSourceNode();if(J[0]&&J[0].nodeType==u.NODE_ELEMENT&&this.checkElementRemovable(J)){J._4e_name()==this.element?m(this,J):d(J,e(this)[J._4e_name()]);if(P[0].nodeType==u.NODE_ELEMENT&&P._4e_contains(H)){K();P=new L(H[0].nextSibling)}}J=P}}E.moveToBookmark(F)}function t(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(H,K,J){F[K]=J});return F}function b(E,F){typeof E=="string"&&(E=t(E));typeof F==
"string"&&(F=t(F));for(var H in E)if(!(H in F&&(F[H]==E[H]||E[H]=="inherit"||F[H]=="inherit")))return false;return true}function c(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function f(E){var F=E._AC;if(F)return F;F={};var H=0,K=E.attributes;if(K)for(var J in K){H++;F[J]=K[J]}if(K=A.getStyleText(E)){F.style||H++;F.style=K}F._length=H;return E._AC=
F}function e(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},H=E._.definition.overrides;if(H){z.isArray(H)||(H=[H]);for(var K=0;K<H.length;K++){var J=H[K],P,Q;if(typeof J=="string")P=J.toLowerCase();else{P=J.element?J.element.toLowerCase():E.element;Q=J.attributes}J=F[P]||(F[P]={});if(Q){J=J.attributes=J.attributes||[];for(var T in Q)J.push([T.toLowerCase(),Q[T]])}}}return F}function m(E,F){var H=E._.definition,K=z.mix(z.mix({},H.attributes),e(E)[F._4e_name()]);H=H.styles;var J=z.isEmptyObject(K)&&
z.isEmptyObject(H);for(var P in K)if(!((P=="class"||E._.definition.fullMatch)&&F.attr(P)!=j(P,K[P]))){J=J||!!F._4e_hasAttribute(P);F.removeAttr(P)}for(var Q in H)if(!(E._.definition.fullMatch&&F._4e_style(Q)!=j(Q,H[Q],true))){J=J||!!F._4e_style(Q);F._4e_style(Q,"")}J&&n(F)}function j(E,F,H){var K=new L("<span></span>");K[H?"_4e_style":"attr"](E,F);return K[H?"_4e_style":"attr"](E)}function a(E,F){for(var H=e(E),K=F.all(E.element),J=K.length;--J>=0;)m(E,new L(K[J]));for(var P in H)if(P!=E.element){K=
F.all(P);for(J=K.length-1;J>=0;J--){var Q=new L(K[J]);d(Q,H[P])}}}function d(E,F){if(F=F&&F.attributes)for(var H=0;H<F.length;H++){var K=F[H][0],J;if(J=E.attr(K)){var P=F[H][1];if(P===null||P.test&&P.test(J)||typeof P=="string"&&J==P)E[0].removeAttribute(K)}}n(E)}function n(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,H=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==u.NODE_ELEMENT&&y._4e_mergeSiblings(F);H&&!F===H&&H.nodeType==u.NODE_ELEMENT&&y._4e_mergeSiblings(H)}}}var z=KISSY,y=z.DOM,
B=w.STYLE={},G=w.RANGE,M=w.Selection,u=w.NODE,D=w.POSITION,I=w.Range,L=z.Node,N=z.UA,O=w.ElementPath,S={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},R={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Y=/\s*(?:;\s*|$)/,X=/#\((.+?)\)/g;B.STYLE_BLOCK=1;B.STYLE_INLINE=2;B.STYLE_OBJECT=3;A.prototype={apply:function(E){r.call(this,E,false)},remove:function(E){r.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==B.STYLE_INLINE?
h:this.type==B.STYLE_BLOCK?p:this.type==B.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==B.STYLE_INLINE?l:null).call(this,E)},applyToObject:function(E){C(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var H=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;H=f(H);if(H._length){for(var K in H)if(K!="_length"){var J=E.attr(K)||"";if(K=="style"?b(H[K],c(J,false)):H[K]==J){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(H=
e(this)[E._4e_name()]){if(!(H=H.attributes))return true;for(F=0;F<H.length;F++){K=H[F][0];if(K=E.attr(K)){J=H[F][1];if(J===null||typeof J=="string"&&K==J||J.test&&J.test(K))return true}}}return false},checkActive:function(E){switch(this.type){case B.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case B.STYLE_OBJECT:case B.STYLE_INLINE:for(var F=E.elements,H=0,K;H<F.length;H++){K=F[H];if(!(this.type==B.STYLE_INLINE&&(y._4e_equals(K,E.block)||y._4e_equals(K,E.blockLimit))))if(!(this.type==
B.STYLE_OBJECT&&!(K._4e_name()in R)))if(this.checkElementRemovable(K,true))return true}}return false}};A.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var H=E.attributes&&E.attributes.style||"",K="";if(H.length)H=H.replace(Y,";");for(var J in F){var P=F[J],Q=(J+":"+P).replace(Y,";");if(P=="inherit")K+=Q;else H+=Q}if(H.length)H=c(H);H+=K;return E._ST=H};w.Style=A});
KISSY.Editor.add("clipboard",function(w){var s=KISSY.Editor,A=KISSY,r=A.Node,x=A.UA,C=s.Range,p=s.RANGE,v=A.Event;s.Paste||function(){function i(g){this.editor=g;this._init()}A.augment(i,{_init:function(){var g=this.editor;x.ie?v.on(g.document,"keydown",this._paste,this):v.on(g.document,"paste",this._paste,this)},_paste:function(g){if(!(g.type==="keydown"&&!(g.keyCode===86&&(g.ctrlKey||g.metaKey)))){var k=this,o=k.editor,q=o.document;if(k._running)g.halt();else{var h=o.getSelection();g=new C(q);var l=
new r(x.webkit?"<body></body>":"<div></div>",null,q);x.webkit&&l[0].appendChild(q.createTextNode("\u00a0"));q.body.appendChild(l[0]);l.css({position:"absolute",top:h.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});l.css("left","-1000px");var t=h.createBookmarks();g.setStartAt(l,p.POSITION_AFTER_START);g.setEndAt(l,p.POSITION_BEFORE_END);g.select(true);k._running=true;setTimeout(function(){l._4e_remove();var b;l=x.webkit&&(b=l._4e_first())&&b.hasClass("Apple-style-span")?
b:l;h.selectBookmarks(t);o.insertHtml(l.html());k._running=false},0)}}}});s.Paste=i}();w.addPlugin(function(){new s.Paste(w)})});
KISSY.Editor.add("color",function(w){function s(m){return("0"+m).slice(m.length-1,m.length+1)}function A(m){m=x.trim(m);if(m.charAt(0)=="#")m=m.substring(1);m=m.replace(/\s+/g,"");var j="";if(/^[0-9a-f]{3,3}$/i.test(m))j=m.replace(/[0-9a-f]/ig,function(d){return d+d});else{var a=m.match(k);if(a&&a[0])for(m=1;m<4;m++)j+=s(parseInt(a[m]).toString(16));else j=m}return"#"+j.toLowerCase()}for(var r=KISSY.Editor,x=KISSY,C=x.Node,p=x.Event,v=r.SimpleOverlay,i=r.Style,g=x.DOM,k=/^rgb\((\d+),(\d+),(\d+)\)$/i,
o="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),q={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},h={element:"span",styles:{"background-color":"#(color)"}},l="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
t={},b={},c=0;c<5;c++){l+="<tr>";for(var f=0;f<8;f++){var e=A(o[8*c+f]);l+="<td>";l+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+e+"'></span></a>";l+="</td>";t[e]=new i(h,{color:e});b[e]=new i(q,{color:e})}l+="</tr>"}t.inherit=new i(h,{color:"inherit"});b.inherit=new i(q,{color:"inherit"});l+="</table></div>";r.ColorSupport||function(){function m(a){m.superclass.constructor.call(this,a);this._init()}var j=r.TripleButton;m.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};x.extend(m,x.Base,{_init:function(){var a=this.get("editor").toolBarDiv;a=new j({container:a,title:this.get("title"),contentCls:this.get("contentCls")});a.on("offClick",this._showColors,this);this.el=a;r.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(a){var d=this;g._4e_ascendant(a.target,function(n){return n[0]===d.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(a){a.halt();var d=this.get("editor");a=a.target;if(g._4e_name(a)=="span"||g._4e_name(a)=="a"){a=new C(a);
if(a._4e_name()=="a")a=a.one("span");var n=this.get("styles");d.fire("save");a._4e_style("background-color")?n[A(a._4e_style("background-color"))].apply(d.document):n.inherit.remove(d.document);d.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new C(l);this.colorWin=new v({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);p.on(document,"click",this._hidePanel,this);p.on(w.document,
"click",this._hidePanel,this)},_real:function(){var a=this.el.el.offset();a.top+=this.el.el.height()+5;if(a.left+this.colorPanel.width()>g.viewportWidth()-60)a.left=g.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(a)},_showColors:function(a){this._prepare(a)}});r.ColorSupport=m}();w.addPlugin(function(){new r.ColorSupport({editor:w,styles:t,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new r.ColorSupport({editor:w,styles:b,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(w){var s=KISSY.Editor,A=KISSY,r=A.Node,x=A.DOM;s.ElementPaths||function(){function C(p){this.cfg=p;this._cache=[];this._init()}A.augment(C,{_init:function(){var p=this.cfg.editor;this.holder=new r("<span>");this.holder.appendTo(p.statusDiv);p.on("selectionChange",this._selectionChange,this)},_selectionChange:function(p){var v=this.cfg.editor,i=this.holder;i=i[0]||i;p=p.path.elements;var g,k;g=this._cache;for(k=0;k<g.length;k++){g[k].detach("click");g[k]._4e_remove()}this._cache=
[];for(k=0;k<p.length;k++){g=p[k];var o=new r("<a href='#' class='elementpath'>"+(g.attr("_ke_real_element_type")||g._4e_name())+"</a>");this._cache.push(o);(function(q){o.on("click",function(h){h.halt();v.focus();setTimeout(function(){v.getSelection().selectElement(q)},50)})})(g);i.firstChild?x.insertBefore(o[0],i.firstChild):i.appendChild(o[0])}}});s.ElementPaths=C}();w.addPlugin(function(){new s.ElementPaths({editor:w})})});
KISSY.Editor.add("enterkey",function(w){var s=KISSY.Editor,A=KISSY,r=A.UA,x=/^h[1-6]$/,C=s.XHTML_DTD,p=A.Node,v=A.Event,i=s.Walker,g=s.ElementPath;s.enterBlock||function(){function k(h){h=h.getSelection().getRanges();for(var l=h.length-1;l>0;l--)h[l].deleteContents();return h[0]}function o(h){var l=k(h),t=l.document;if(l.checkStartOfBlock()&&l.checkEndOfBlock()){var b=(new g(l.startContainer)).block;if(b&&(b._4e_name()=="li"||b.parent()._4e_name()=="li")){h.execCommand("outdent");return}}var c=l.splitBlock("p");
if(c){h=c.previousBlock;b=c.nextBlock;var f=c.wasStartOfBlock,e=c.wasEndOfBlock,m;if(b){m=b.parent();if(m._4e_name()=="li"){b._4e_breakParent(m);b._4e_move(b._4e_next(),true)}}else if(h&&(m=h.parent())&&m._4e_name()=="li"){h._4e_breakParent(m);l.moveToElementEditablePosition(h._4e_next());h._4e_move(h._4e_previous())}if(!f&&!e){if(b._4e_name()=="li"&&(m=b._4e_first(i.invisible(true)))&&A.inArray(m._4e_name(),["ul","ol"]))(r.ie?new p(t.createTextNode("\u00a0")):new p(t.createElement("br"))).insertBefore(m);
b&&l.moveToElementEditablePosition(b)}else{var j;if(h){if(h._4e_name()=="li"||!x.test(h._4e_name()))j=h._4e_clone()}else if(b)j=b._4e_clone();j||(j=new p("p",null,t));if(m=c.elementPath){c=0;for(var a=m.elements.length;c<a;c++){var d=m.elements[c];if(d._4e_equals(m.block)||d._4e_equals(m.blockLimit))break;if(C.$removeEmpty[d._4e_name()]){d=d._4e_clone();j._4e_moveChildren(d);j.append(d)}}}r.ie||j._4e_appendBogus();l.insertNode(j);if(r.ie&&f&&(!e||!h[0].childNodes.length)){l.moveToElementEditablePosition(e?
h:j);l.select()}l.moveToElementEditablePosition(f&&!e?b:j)}if(!r.ie)if(b){t=new p(t.createElement("span"));t.html("&nbsp;");l.insertNode(t);t._4e_scrollIntoView();l.deleteContents()}else j._4e_scrollIntoView();l.select()}}function q(h){v.on(h.document,"keydown",function(l){if(l.keyCode===13)if(!l.shiftKey){h.execCommand("enterBlock");l.preventDefault()}})}q.enterBlock=o;s.EnterKey=q}();w.addPlugin(function(){w.addCommand("enterBlock",{exec:s.EnterKey.enterBlock});s.EnterKey(w)})});
KISSY.Editor.add("fakeobjects",function(w){var s=KISSY.Editor,A=KISSY,r=A.Node,x=s.NODE,C=s.Config.base+"theme/spacer.gif",p=s.HtmlParser;s=A.Editor;var v=(w=w.htmlDataProcessor)&&w.htmlFilter,i={elements:{$:function(g){var k=g.attributes;if((k=(k=(k=k&&k._ke_realelement)&&new p.Fragment.FromHtml(decodeURIComponent(k)))&&k.children[0])&&g.attributes._ke_resizable){var o=g.attributes.style;if(o){var q=/(?:^|\s)width\s*:\s*(\d+)/i.exec(o);g=q&&q[1];o=(q=/(?:^|\s)height\s*:\s*(\d+)/i.exec(o))&&q[1];
if(g)k.attributes.width=g;if(o)k.attributes.height=o}}return k}}};v&&v.addRules(i);w&&A.mix(w,{createFakeParserElement:function(g,k,o,q,h){var l;l=new p.BasicWriter;g.writeHtml(l);l=l.getHtml();var t=g.attributes.style;if(g.attributes.width)t="width:"+g.attributes.width+"px;"+t;if(g.attributes.height)t="height:"+g.attributes.height+"px;"+t;g={"class":k,src:C,_ke_realelement:encodeURIComponent(l),_ke_real_node_type:g.type,style:t,align:g.attributes.align||""};h&&delete h.width;h&&delete h.height;h&&
A.mix(g,h,false);if(o)g._ke_real_element_type=o;if(q)g._ke_resizable=q;return new p.Element("img",g)}});A.augment(s,{createFakeElement:function(g,k,o,q,h,l){var t=g.attr("style")||"";if(g.attr("width"))t="width:"+g.attr("width")+"px;"+t;if(g.attr("height"))t="height:"+g.attr("height")+"px;"+t;g={"class":k,src:C,_ke_realelement:encodeURIComponent(h||g._4e_outerHtml()),_ke_real_node_type:g[0].nodeType,align:g.attr("align")||"",style:t};l&&delete l.width;l&&delete l.height;l&&A.mix(g,l,false);if(o)g._ke_real_element_type=
o;if(q)g._ke_resizable=q;return new r("<img/>",g,this.document)},restoreRealElement:function(g){if(g.attr("_ke_real_node_type")!=x.NODE_ELEMENT)return null;g=decodeURIComponent(g.attr("_ke_realelement"));var k=new r("<div>",null,this.document);k.html(g);return k._4e_first(function(o){return o[0].nodeType==x.NODE_ELEMENT})._4e_remove()}})});KISSY.Editor.add("flash",function(w){w.addPlugin(function(){new KISSY.Editor.Flash(w)})});
KISSY.Editor.add("flashsupport",function(w){var s=KISSY.Editor,A=KISSY,r=A.UA,x=A.Event,C=s.ContextMenu,p=A.Node,v=s.BubbleView,i=s.TripleButton,g=s.SimpleOverlay,k=w.htmlDataProcessor,o="ke_flash",q=s.Utils.getFlashUrl;w=k&&k.dataFilter;s.Flash||function(){function h(f){this.editor=f;this._init()}function l(f){return f._4e_name()==="img"&&!!f.hasClass(o)&&f}var t=/\.swf(?:$|\?)/i,b="<p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p><p style='margin:5px 0'><label>\u5bf9\u9f50\uff1a <select class='ke-flash-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
s.Utils.duplicateStr("&nbsp;",13)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-flash-margin' style='width:90px' value='5'/> px</label><p>";h.isFlashEmbed=function(f){f=f.attributes;return f.type=="application/x-shockwave-flash"||t.test(f.src||"")};A.augment(h,{_config:function(){this._cls=o;this._type="flash";this._title="Flash\u5c5e\u6027";this._bodyHtml=b;this._footHtml="<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button>";this._contentCls=
"ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=c;this._flashRules=["img."+o]},_init:function(){this._config();var f=this.editor,e={},m=this._contextMenu;f._toolbars=f._toolbars||{};f._toolbars[this._type]=this;this.el=new i({container:f.toolBarDiv,contentCls:this._contentCls,title:this._tip});this.el.on("click",this.show,this);if(m)for(var j in m)(function(a){e[a]=function(){m[a](f)}})(j);C.register(f.document,{rules:this._flashRules,width:"120px",funcs:e});v.attach({pluginName:this._type,
pluginInstance:this});x.on(f.document,"dblclick",this._dbclick,this);s.Utils.lazyRun(this,"_prepareShow","_realShow")},_getFlashUrl:function(f){return q(f)},_updateTip:function(f,e){e=this.editor.restoreRealElement(e);f.html(this._getFlashUrl(e));f.attr("href",this._getFlashUrl(e))},_dbclick:function(f){var e=new p(f.target);if(e._4e_name()==="img"&&e.hasClass(this._cls)){this.show(null,e);f.halt()}},_prepareShow:function(){var f=new g({title:this._title,width:this._config_dwidth||"350px",mask:true});
f.body.html(this._bodyHtml);f.foot.html(this._footHtml);this.d=f;this._initD()},_realShow:function(){this._updateD();this.d.show()},_updateD:function(){var f=this.editor,e=this.selectedFlash;if(e){f=f.restoreRealElement(e);f.attr("width")&&this.dWidth.val(parseInt(f.attr("width")));f.attr("height")&&this.dHeight.val(parseInt(f.attr("height")));this.dAlign.val(f.attr("align"));this.dUrl.val(q(f));this.dMargin.val(parseInt(f._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");
this.dWidth.val("");this.dHeight.val("");this.dAlign.val("");this.dMargin.val("5")}},show:function(f,e){this.selectedFlash=e;this._prepareShow()},_initD:function(){var f=this,e=f.d;f.dHeight=e.el.one(".ke-flash-height");f.dWidth=e.el.one(".ke-flash-width");f.dUrl=e.el.one(".ke-flash-url");f.dAlign=e.el.one(".ke-flash-align");f.dMargin=e.el.one(".ke-flash-margin");var m=e.el.one(".ke-flash-ok");e=e.el.one(".ke-flash-cancel");m.on("click",f._gen,f);e.on("click",function(){f.d.hide()})},_getDInfo:function(){return{url:this.dUrl.val(),
attrs:{width:this.dWidth.val(),height:this.dHeight.val(),align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px"}}},_gen:function(){var f=this.editor,e=this._getDInfo(),m=e&&e.url;e=e&&e.attrs;var j=" ";if(A.trim(m)){if(e)for(var a in e)j+=a+"='"+e[a]+"' ";m="<object "+j+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+
m+'" /><embed '+j+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+m+'"  type="application/x-shockwave-flash"/></object>';a=new p(m,null,f.document);e=f.createFakeElement?f.createFakeElement(a,this._cls,this._type,true,m,e):a;e=f.insertElement(e);this.selectedFlash&&f.getSelection().selectElement(e);this.d.hide()}}});s.Flash=h;h.registerBubble=function(f,e,m){v.register({pluginName:f,func:m,init:function(){var j=this,a=j.el;a.html(e+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var d=a.one(".ke-bubbleview-url"),n=a.one(".ke-bubbleview-change");a=a.one(".ke-bubbleview-remove");n._4e_unselectable();d._4e_unselectable();a._4e_unselectable();n.on("click",function(z){j._plugin.show(null,j._selectedEl);z.halt()});a.on("click",function(z){var y=j._plugin;if(r.webkit){var B=y.editor.getSelection().getRanges();B&&B[0]&&(B[0].collapse(true)||1)&&B[0].select()}j._selectedEl._4e_remove();j.hide();y.editor.notifySelectionChange();z.halt()});j.on("beforeVisibleChange",function(z){var y=
j._selectedEl;z.newVal&&y&&j._plugin._updateTip(d,y)})}})};h.registerBubble("flash","Flash \u7f51\u5740\uff1a ",l);h.checkFlash=l;var c={"Flash\u5c5e\u6027":function(f){var e=f.getSelection();e=e&&e.getStartElement();e=l(e);f=f._toolbars.flash;e&&f.show(null,e)}};h.CLS_FLASH=o;h.TYPE_FLASH="flash"}();w&&w.addRules({elements:{object:function(h){var l=h.attributes;if(!(l.classid&&String(l.classid).toLowerCase())){for(l=0;l<h.children.length;l++)if(h.children[l].name=="embed"){if(!s.Flash.isFlashEmbed(h.children[l]))return null;
return k.createFakeParserElement(h,o,"flash",true)}return null}return k.createFakeParserElement(h,o,"flash",true)},embed:function(h){if(!s.Flash.isFlashEmbed(h))return null;return k.createFakeParserElement(h,o,"flash",true)}}},5)});
KISSY.Editor.add("font",function(w){var s=KISSY.Editor,A=KISSY,r=s.Style,x=s.TripleButton,C=w.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],p={},v=[],i={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},g=w.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],k={},o=[],q={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},h;w.cfg.pluginConfig["font-size"]=C;w.cfg.pluginConfig["font-family"]=g;for(h=0;h<C.length;h++){var l=C[h];p[l]=new r(i,{size:l});v.push({name:l,value:l})}for(h=0;h<g.length;h++){C=g[h];k[C]=new r(q,{family:C});o.push({name:C,value:C,attrs:{style:"font-family:"+C}})}s.Font||function(){function t(c){t.superclass.constructor.call(this,c);this._init()}function b(c){b.superclass.constructor.call(this,
c);this._init()}t.ATTRS={title:{},html:{},styles:{},editor:{}};A.extend(t,A.Base,{_init:function(){var c=this.get("editor"),f=c.toolBarDiv;this.get("html");this.el=new s.Select({container:f,doc:c.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);c.on("selectionChange",this._selectionChange,this)},_vChange:function(c){var f=this.get("editor"),e=c.newVal;c=c.preVal;var m=this.get("styles");f.focus();
f.fire("save");if(e==c){m[e].remove(f.document);this.el.set("value","")}else m[e].apply(f.document);f.fire("save")},_selectionChange:function(c){this.get("editor");c=c.path.elements;for(var f=this.get("styles"),e=0,m;e<c.length;e++){m=c[e];for(var j in f)if(f[j].checkElementRemovable(m,true)){this.el.set("value",j);return}}this.el.reset("value")}});b.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};A.extend(b,A.Base,{_init:function(){var c=this.get("editor"),f=this.get("text");this.get("style");
var e=this.get("title");this.el=new x({text:f,title:e,contentCls:this.get("contentCls"),container:c.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);c.on("selectionChange",this._selectionChange,this)},_on:function(){var c=this.get("editor");this.get("text");var f=this.get("style");this.get("title");c.fire("save");f.apply(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_off:function(){var c=this.get("editor");this.get("text");var f=this.get("style");
this.get("title");c.fire("save");f.remove(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_selectionChange:function(c){this.get("editor");this.get("text");var f=this.get("style");this.get("title");f.checkActive(c.path)?this.el.set("state",x.ON):this.el.set("state",x.OFF)}});t.SingleFont=b;s.Font=t}();w.addPlugin(function(){new s.Font({editor:w,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:p,html:v});new s.Font({editor:w,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:k,html:o});new s.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:w,style:new r({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:w,style:new r({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:w,style:new r({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:w,style:new r({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(w){var s=KISSY.Editor,A=KISSY,r=[],x={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},C={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},p={},v=s.Style;for(var i in x)if(x[i]){p[x[i]]=new v({element:x[i]});r.push({name:i,value:x[i],attrs:{style:"font-size:"+C[x[i]]}})}s.Format||function(){function g(k){g.superclass.constructor.call(this,
k);this._init()}g.ATTRS={editor:{}};A.extend(g,A.Base,{_init:function(){var k=this.get("editor");this.el=new s.Select({container:k.toolBarDiv,value:"",doc:k.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);k.on("selectionChange",this._selectionChange,this)},_vChange:function(k){var o=this.get("editor"),q=k.newVal;k=k.preVal;o.fire("save");if(q!=k)p[q].apply(o.document);else{p.p.apply(o.document);
this.el.set("value","p")}o.fire("save")},_selectionChange:function(k){this.get("editor");k=k.path;for(var o in p)if(p[o].checkActive(k)){this.el.set("value",o);return}this.el.reset("value")}});s.Format=g}();w.addPlugin(function(){new s.Format({editor:w,html:r,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function w(){this._={output:[]}}var s=KISSY.Editor,A=s.Utils;if(!s.HtmlParser.BasicWriter){KISSY.augment(w,{openTag:function(r){this._.output.push("<",r)},openTagClose:function(r,x){x?this._.output.push(" />"):this._.output.push(">")},attribute:function(r,x){if(typeof x=="string")x=A.htmlEncodeAttr(x);this._.output.push(" ",r,'="',x,'"')},closeTag:function(r){this._.output.push("</",r,">")},text:function(r){this._.output.push(r)},comment:function(r){this._.output.push("<!--",
r,"--\>")},write:function(r){this._.output.push(r)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(r){var x=this._.output.join("");r&&this.reset();return x}});s.HtmlParser.BasicWriter=w}});
KISSY.Editor.add("htmlparser-comment",function(){function w(r){this.value=r;this._={isBlockLike:false}}var s=KISSY.Editor,A=s.NODE;if(!s.HtmlParser.Comment){s.HtmlParser.Comment=w;w.prototype={constructor:w,type:A.NODE_COMMENT,writeHtml:function(r,x){var C=this.value;if(x){if(!(C=x.onComment(C,this)))return;if(typeof C!="string"){C.parent=this.parent;C.writeHtml(r,x);return}}r.comment(C)}}}});
KISSY.Editor.add("htmlparser-element",function(){function w(x,C){this.name=x;this.attributes=C||(C={});this.children=[];var p=C._ke_real_element_type||x;C=s.XHTML_DTD;p=!!(C.$nonBodyContent[p]||C.$block[p]||C.$listItem[p]||C.$tableContent[p]||C.$nonEditable[p]||p=="br");var v=!!C.$empty[x];this.isEmpty=v;this.isUnknown=!C[x];this._={isBlockLike:p,hasInlineStarted:v||!p}}var s=KISSY.Editor;if(!s.HtmlParser.Element){var A=s.NODE,r=function(x,C){x=x[0];C=C[0];return x<C?-1:x>C?1:0};KISSY.augment(w,{type:A.NODE_ELEMENT,
add:s.HtmlParser.Fragment.prototype.add,clone:function(){return new w(this.name,this.attributes)},writeHtml:function(x,C){var p=this.attributes,v=this,i=v.name,g,k,o,q;v.filterChildren=function(){if(!q){var t=new s.HtmlParser.BasicWriter;s.HtmlParser.Fragment.prototype.writeChildrenHtml.call(v,t,C);v.children=(new s.HtmlParser.Fragment.FromHtml(t.getHtml())).children;q=1}};if(C){for(;;){if(!(i=C.onElementName(i)))return;v.name=i;if(!(v=C.onElement(v)))return;v.parent=this.parent;if(v.name==i)break;
if(v.type!=A.NODE_ELEMENT){v.writeHtml(x,C);return}i=v.name;if(!i){this.writeChildrenHtml.call(v,x,q?null:C);return}}p=v.attributes}x.openTag(i,p);for(var h=[],l=0;l<2;l++)for(g in p){k=g;o=p[g];if(l==1)h.push([g,o]);else if(C){for(;;)if(k=C.onAttributeName(g))if(k!=g){delete p[g];g=k}else break;else{delete p[g];break}if(k)if((o=C.onAttribute(v,k,o))===false)delete p[k];else p[k]=o}}x.sortAttributes&&h.sort(r);p=h.length;for(l=0;l<p;l++){g=h[l];x.attribute(g[0],g[1])}x.openTagClose(i,v.isEmpty);if(!v.isEmpty){this.writeChildrenHtml.call(v,
x,q?null:C);x.closeTag(i)}},writeChildrenHtml:function(){s.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});s.HtmlParser.Element=w}});
KISSY.Editor.add("htmlparser-filter",function(){function w(i){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};i&&this.addRules(i,10)}function s(i,g){for(var k=0;i&&k<g.length;k++){var o=g[k];i=i.replace(o[0],o[1])}return i}function A(i,g,k){if(typeof g=="function")g=[g];var o,q;q=i.length;var h=g&&g.length;if(h){for(o=0;o<q&&i[o].pri<k;o++);for(q=h-1;q>=0;q--)if(h=g[q]){h.pri=k;i.splice(o,0,h)}}}function r(i,g,k){if(g)for(var o in g){var q=i[o];i[o]=x(q,g[o],
k);q||i.$length++}}function x(i,g,k){if(g){g.pri=k;if(i){if(i.splice)A(i,g,k);else{i=i.pri>k?[g,i]:[i,g];i.filter=C}return i}else return g.filter=g}}function C(i){for(var g=i.type||i instanceof p.HtmlParser.Fragment,k=0;k<this.length;k++){if(g)var o=i.type,q=i.name;var h=this[k].apply(window,arguments);if(h===false)return h;if(g){if(h&&(h.name!=q||h.type!=o))return h}else if(typeof h!="string")return h;h!=undefined&&(i=h)}return i}var p=KISSY.Editor,v=p.NODE;if(!p.HtmlParser.Filter){KISSY.augment(w,
{addRules:function(i,g){if(typeof g!="number")g=10;A(this._.elementNames,i.elementNames,g);A(this._.attributeNames,i.attributeNames,g);r(this._.elements,i.elements,g);r(this._.attributes,i.attributes,g);this._.text=x(this._.text,i.text,g)||this._.text;this._.comment=x(this._.comment,i.comment,g)||this._.comment;this._.root=x(this._.root,i.root,g)||this._.root},onElementName:function(i){return s(i,this._.elementNames)},onAttributeName:function(i){return s(i,this._.attributeNames)},onText:function(i){var g=
this._.text;return g?g.filter(i):i},onComment:function(i,g){var k=this._.comment;return k?k.filter(i,g):i},onFragment:function(i){var g=this._.root;return g?g.filter(i):i},onElement:function(i){for(var g=[this._.elements["^"],this._.elements[i.name],this._.elements.$],k,o=0;o<3;o++)if(k=g[o]){k=k.filter(i,this);if(k===false)return null;if(k&&k!=i)return this.onNode(k);if(i.parent&&!i.name)break}return i},onNode:function(i){var g=i.type;return g==v.NODE_ELEMENT?this.onElement(i):g==v.NODE_TEXT?new p.HtmlParser.Text(this.onText(i.value)):
null},onAttribute:function(i,g,k){if(g=this._.attributes[g]){i=g.filter(k,i,this);if(i===false)return false;if(typeof i!="undefined")return i}return k}});p.HtmlParser.Filter=w}});
KISSY.Editor.add("htmlparser-fragment",function(){function w(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var s=KISSY.Editor;if(!s.HtmlParser.Fragment){var A={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},r=KISSY,x=s.Utils,C=s.NODE,p=s.XHTML_DTD,v=x.mix({table:1,ul:1,ol:1,dl:1},p.table,p.ul,p.ol,p.dl),i=p.$list,g=p.$listItem;w.FromHtml=function(k,o){function q(d){var n;if(c.length>0)for(var z=0;z<c.length;z++){var y=c[z],B=y.name,G=
p[B],M=e.name&&p[e.name];if((!M||M[B])&&(!d||!G||G[d]||!p[d])){if(!n){h();n=1}y=y.clone();y.parent=e;e=y;c.splice(z,1);z--}}}function h(){for(;f.length;)e.add(f.shift())}function l(d,n,z){n=n||e||b;if(o&&!n.type){var y,B;if((y=d.attributes&&(B=d.attributes._ke_real_element_type)?B:d.name)&&!(y in p.$body)&&!(y in p.$nonBodyContent)){y=e;e=n;t.onTagOpen(o,{});n=e;if(z)e=y}}if(d._.isBlockLike&&d.name!="pre"){z=d.children.length;if((y=d.children[z-1])&&y.type==C.NODE_TEXT)if(B=x.rtrim(y.value))y.value=
B;else d.children.length=z-1}n.add(d);if(d.returnPoint){e=d.returnPoint;delete d.returnPoint}}var t=new s.HtmlParser,b=new w,c=[],f=[],e=b,m=false,j;t.onTagOpen=function(d,n,z){var y=new s.HtmlParser.Element(d,n);if(y.isUnknown&&z)y.isEmpty=true;if(p.$removeEmpty[d])c.push(y);else{if(d=="pre")m=true;else if(d=="br"&&m){e.add(new s.HtmlParser.Text("\n"));return}if(d=="br")f.push(y);else{var B=e.name,G=B&&(p[B]||(e._.isBlockLike?p.div:p.span));if(G&&!y.isUnknown&&!e.isUnknown&&!G[d]){G=false;var M;
if(d in i&&B in i){B=e.children;(B=B[B.length-1])&&B.name in g||l(B=new s.HtmlParser.Element("li"),e);j=e;M=B}else if(d==B)l(e,e.parent);else{if(v[B])j||(j=e);else{l(e,e.parent,true);A[B]||c.unshift(e)}G=true}e=M?M:e.returnPoint||e.parent;if(G){t.onTagOpen.apply(this,arguments);return}}q(d);h();y.parent=e;y.returnPoint=j;j=0;if(y.isEmpty)l(y);else e=y}}};t.onTagClose=function(d){for(var n=c.length-1;n>=0;n--)if(d==c[n].name){c.splice(n,1);return}for(var z=[],y=[],B=e;B.type&&B.name!=d;){B._.isBlockLike||
y.unshift(B);z.push(B);B=B.parent}if(B.type){for(n=0;n<z.length;n++){var G=z[n];l(G,G.parent)}e=B;if(e.name=="pre")m=false;B._.isBlockLike&&h();l(B,B.parent);if(B==e)e=e.parent;c=c.concat(y)}if(d=="body")o=false};t.onText=function(d){if(!e._.hasInlineStarted&&!m){d=x.ltrim(d);if(d.length===0)return}h();q();if(o&&(!e.type||e.name=="body")&&x.trim(d))this.onTagOpen(o,{});m||(d=d.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));e.add(new s.HtmlParser.Text(d))};t.onCDATA=function(){};t.onComment=function(d){e.add(new s.HtmlParser.Comment(d))};
t.parse(k);for(h();e.type;){k=e.parent;var a=e;if(o&&(!k.type||k.name=="body")&&!p.$body[a.name]){e=k;t.onTagOpen(o,{});k=e}k.add(a);e=k}return b};r.augment(w,{add:function(k){var o=this.children.length;if(o=o>0&&this.children[o-1]||null){if(k._.isBlockLike&&o.type==C.NODE_TEXT){o.value=x.rtrim(o.value);if(o.value.length===0){this.children.pop();this.add(k);return}}o.next=k}k.previous=o;k.parent=this;this.children.push(k);this._.hasInlineStarted=k.type==C.NODE_TEXT||k.type==C.NODE_ELEMENT&&!k._.isBlockLike},
writeHtml:function(k,o){var q;this.filterChildren=function(){var h=new s.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,h,o,true);h=h.getHtml();this.children=(new w.FromHtml(h)).children;q=1};!this.name&&o&&o.onFragment(this);this.writeChildrenHtml(k,q?null:o)},writeChildrenHtml:function(k,o){for(var q=0;q<this.children.length;q++)this.children[q].writeHtml(k,o)}});s.HtmlParser.Fragment=w}});
KISSY.Editor.add("htmlparser",function(){function w(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var s=KISSY.Editor;if(!s.HtmlParser){var A=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,r={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},x=s.XHTML_DTD;KISSY.augment(w,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(C){for(var p,v,i=0,g;p=this._.htmlPartsRegex.exec(C);){v=p.index;if(v>i){i=C.substring(i,v);g?g.push(i):this.onText(i)}i=this._.htmlPartsRegex.lastIndex;if(v=p[1]){v=v.toLowerCase();if(g&&x.$cdata[v]){this.onCDATA(g.join(""));g=null}if(!g){this.onTagClose(v);continue}}if(g)g.push(p[0]);else if(v=p[3]){v=v.toLowerCase();var k={},o;p=p[4];var q=!!(p&&p.charAt(p.length-1)=="/");if(p)for(;o=A.exec(p);){var h=
o[1].toLowerCase();o=o[2]||o[3]||o[4]||"";k[h]=!o&&r[h]?h:o}this.onTagOpen(v,k,q);if(!g&&x.$cdata[v])g=[]}else if(v=p[2])this.onComment(v)}C.length>i&&this.onText(C.substring(i,C.length))}});s.HtmlParser=w}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function w(){w.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var r=s.XHTML_DTD;for(var x in A.mix({},r.$nonBodyContent,r.$block,r.$listItem,r.$tableContent))this.setRules(x,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!r[x]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var s=KISSY.Editor,A=s.Utils;if(!s.HtmlParser.HtmlWriter){KISSY.extend(w,s.HtmlParser.BasicWriter,{openTag:function(r){var x=this._.rules[r];if(this._.indent)this.indentation();else if(x&&x.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",r)},openTagClose:function(r,x){r=this._.rules[r];
if(x)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(r&&r.indent)this._.indentation+=this.indentationChars}r&&r.breakAfterOpen&&this.lineBreak()},attribute:function(r,x){if(typeof x=="string"){this.forceSimpleAmpersand&&(x=x.replace(/&amp;/g,"&"));x=A.htmlEncodeAttr(x)}this._.output.push(" ",r,'="',x,'"')},closeTag:function(r){var x=this._.rules[r];if(x&&x.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(x&&x.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",r,">");x&&x.breakAfterClose&&this.lineBreak()},text:function(r){if(this._.indent){this.indentation();r=A.ltrim(r)}this._.output.push(r)},comment:function(r){this._.indent&&this.indentation();this._.output.push("<!--",r,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(r,x){var C=this._.rules[r];if(C)A.mix(C,x);else this._.rules[r]=x}});s.HtmlParser.HtmlWriter=w}});KISSY.Editor.add("htmlparser-text",function(){function w(A){this.value=A;this._={isBlockLike:false}}var s=KISSY.Editor;if(!s.HtmlParser.Text){KISSY.augment(w,{type:s.NODE.NODE_TEXT,writeHtml:function(A,r){var x=this.value;r&&!(x=r.onText(x,this))||A.text(x)}});s.HtmlParser.Text=w}});
KISSY.Editor.add("htmldataprocessor",function(w){function s(j){if(/mso-list\s*:\s*Ignore/i.test(j.attributes&&j.attributes.style))return true;return p}function A(j,a){var d=new v.HtmlParser.Element("ke:listbullet"),n;if(j)if(j[2]){j=isNaN(j[1])?/^[a-z]+$/.test(j[1])?"lower-alpha":/^[A-Z]+$/.test(j[1])?"upper-alpha":"decimal":"decimal";n="ol"}else{j=/[l\u00B7\u2002]/.test(j[1])?"disc":/[\u006F\u00D8]/.test(j[1])?"circle":/[\u006E\u25C6]/.test(j[1])?"square":"disc";n="ul"}else{j="decimal";n="ol"}d.attributes=
{"ke:listtype":n,style:"list-style-type:"+j+";"};d.add(new v.HtmlParser.Text(a));return d}function r(j){var a=j.attributes,d;if((d=j.removeAnyChildWithName("ke:listbullet"))&&d.length&&(d=d[0])){j.name="ke:li";if(a.style)a.style=x([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(n){n=n.split(" ");n=n[3]||n[1]||n[0];n=parseInt(n,10);if(!b&&c&&n>c)b=n-c;a["ke:margin"]=c=n}]],p)(a.style,j)||"";d=d.attributes;j.addStyle(d.style);i.mix(a,d);return true}return false}function x(j,a){return function(d,
n){var z=[];d.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(y,B,G){B=B.toLowerCase();B=="font-family"&&(G=G.replace(/["']/g,""));for(var M,u,D,I=0;I<j.length;I++)if(j[I]){y=j[I][0];M=j[I][1];u=j[I][2];D=j[I][3];if(B.match(y)&&(!M||G.match(M))){B=D||B;a&&(u=u||G);if(typeof u=="function")u=u(G,n,B);if(u&&u.push){B=u[0];u=u[1]}typeof u=="string"&&z.push([B,u]);return}}!a&&z.push([B,G])});for(d=0;d<z.length;d++)z[d]=z[d].join(":");return z.length?z.join(";")+";":false}}
function C(j){j=j.children;for(var a,d,n,z,y,B,G,M=0;M<j.length;M++){a=j[M];if("ke:li"==a.name){a.name="li";d=a.attributes;n=a.attributes["ke:listtype"];z=parseInt(d["ke:indent"],10)||b&&Math.ceil(d["ke:margin"]/b)||1;d.style&&(d.style=x([["list-style-type",n=="ol"?"decimal":"disc"]],p)(d.style)||"");if(B){if(z>G){B=new v.HtmlParser.Element(n);B.add(a);y.add(B)}else{if(z<G){y=G-z;for(var u;y--&&(u=B.parent);)B=u.parent}B.add(a)}j.splice(M--,1)}else{B=new v.HtmlParser.Element(n);B.add(a);j[M]=B}y=
a;G=z}else B=null}b=0}var p=p,v=KISSY.Editor,i=KISSY,g=i.UA,k=v.NODE,o=v.HtmlParser,q=new o.Filter,h=new o.Filter,l=v.XHTML_DTD;if(!w.htmlDataProcessor){(function(){var j=v.HtmlParser.Fragment.prototype,a=v.HtmlParser.Element.prototype;j.onlyChild=a.onlyChild=function(){var d=this.children;return d.length==1&&d[0]||null};a.removeAnyChildWithName=function(d){for(var n=this.children,z=[],y,B=0;B<n.length;B++){y=n[B];if(y.name){if(y.name==d){z.push(y);n.splice(B--,1)}z=z.concat(y.removeAnyChildWithName(d))}}return z};
a.getAncestor=function(d){for(var n=this.parent;n&&!(n.name&&n.name.match(d));)n=n.parent;return n};j.firstChild=a.firstChild=function(d){for(var n,z=0;z<this.children.length;z++){n=this.children[z];if(d(n))return n;else if(n.name)if(n=n.firstChild(d))return n}return null};a.addStyle=function(d,n,z){var y="";if(typeof n=="string")y+=d+":"+n+";";else{if(typeof d=="object")for(var B in d){if(d.hasOwnProperty(B))y+=B+":"+d[B]+";"}else y+=d;z=n}if(!this.attributes)this.attributes={};d=this.attributes.style||
"";d=(z?[y,d]:[d,y]).join(";");this.attributes.style=d.replace(/^;|;(?=;)/,"")};l.parentOf=function(d){var n={};for(var z in this)if(z.indexOf("$")==-1&&this[z][d])n[z]=1;return n}})();var t=x([[/mso/i],[/font-size/i,"",function(j){for(var a=w.cfg.pluginConfig["font-size"],d=0;d<a.length;d++)if(j.toLowerCase()==a[d])return j;return false},"font-size"],[/font-family/i,"",function(j){for(var a=w.cfg.pluginConfig["font-family"],d=0;d<a.length;d++)if(j.toLowerCase()==a[d].toLowerCase())return j;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],p),b,c=0,f=l.parentOf("ol"),e={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(j){j.filterChildren();C(j)},elements:{font:function(j){delete j.name},p:function(j){j.filterChildren();if(r(j))return p},$:function(j){var a=j.name||"";a.indexOf(":")!=-1&&a.indexOf("ke")==-1&&delete j.name;var d=j.attributes.style;if(a=="span"&&(!d||!t(d)))delete j.name;
if(a in f){j.filterChildren();C(j)}},table:function(j){var a=j.attributes.border;if(!a||a=="0")j.attributes["class"]="ke_show_border"},td:function(j){if(g.ie){j=j.children;var a=new v.HtmlParser.Text("&nbsp;");if(j.length)j[j.length-1].type!=k.NODE_TEXT&&j.push(a);else j.push(a)}},span:function(j){if(!g.gecko&&s(j.parent))return false;if(!g.gecko&&s(j)){j=(j=j.firstChild(function(d){return d.value||d.name=="img"}))&&(j.value||"l.");var a=j.match(/^([^\s]+?)([.)]?)$/);return A(a,j)}}},comment:!g.ie?
function(j,a){var d=j.match(/<img.*?>/);if(j=j.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){d=(a=j[1]||d&&"l.")&&a.match(/>([^\s]+?)([.)]?)</);return A(d,a)}if(g.gecko&&d){d=v.HtmlParser.Fragment.FromHtml(d[0]).children[0];(a=(a=(a=a.previous)&&a.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&a[1])&&(d.attributes.src=a);return d}return false}:function(){return false},attributes:{"class":function(j){if(/^ke_/.test(j))return j;return false},style:function(j){j=t(j);if(!j)return false;
return j}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},m={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(j){var a=j.parent;if(a&&a.name=="object"){var d=a.attributes.width;a=a.attributes.height;d&&(j.attributes.width=d);a&&(j.attributes.height=a)}},param:function(j){j.children=[];j.isEmpty=true;return j},a:function(j){if(!(j.children.length||j.attributes.name))return false},td:function(j){for(var a=j.children,d=0;d<a.length;d++)if(a[d].name=="br"){a.splice(d,1);--d}if(!j.children.length){a=
new v.HtmlParser.Text("&nbsp;");j.children.push(a)}},span:function(j){if(!j.children.length)return false}},attributes:{style:function(j){if(!i.trim(j))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(g.ie)m.attributes.style=function(j){return j.toLowerCase()};q.addRules(m);h.addRules(e);w.htmlDataProcessor={htmlFilter:q,dataFilter:h,toHtml:function(j,a){var d=new o.HtmlWriter;o.Fragment.FromHtml(j,a).writeHtml(d,q);return d.getHtml(true)},toDataFormat:function(j,a){if(g.gecko)j=
j.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var d=new o.BasicWriter;j=o.Fragment.FromHtml(j,a);d.reset();j.writeHtml(d,h);return d.getHtml(true)}}}});
KISSY.Editor.add("image",function(w){var s=KISSY.Editor,A=KISSY,r=A.UA,x=A.Node,C=A.Event,p=s.BubbleView,v=s.SimpleOverlay;s.ImageInserter||function(){function i(h){i.superclass.constructor.call(this,h);this._init()}var g=function(h){return h._4e_name()==="img"&&!/(^|\s+)ke_/.test(h[0].className)&&h},k=s.TripleButton,o="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></p><p style='margin:5px 0'><label><span style='color:#0066CC;font-weight:bold;'>\u9ad8\u5ea6\uff1a </span><input class='ke-img-height' style='width:90px' value='\u81ea\u52a8'/> px </label> &nbsp;<label><span style='color:#0066CC;font-weight:bold;'>\u5bbd\u5ea6\uff1a </span><input class='ke-img-width' style='width:90px' value='\u81ea\u52a8'/> px </label></p><p><label><span style='color:#0066CC;font-weight:bold;'>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
s.Utils.duplicateStr("&nbsp;",13)+"<label><span style='color:#0066CC;font-weight:bold;'>\u95f4\u8ddd\uff1a </span> <input class='ke-img-margin' style='width:80px' value='5'/> px</label></p></div>";i.ATTRS={editor:{}};var q={"\u56fe\u7247\u5c5e\u6027":function(h){var l=h.getSelection();l=l&&l.getStartElement();l=g(l);h=h._toolbars.image;l&&h.show(null,l)}};A.extend(i,A.Base,{_init:function(){var h=this.get("editor"),l=h.toolBarDiv,t={};this.editor=h;this.el=new k({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",
container:l});this.el.on("offClick",this.show,this);C.on(h.document,"dblclick",this._dblclick,this);s.Utils.lazyRun(this,"_prepare","_real");h._toolbars=h._toolbars||{};h._toolbars.image=this;if(q)for(var b in q)(function(c){t[c]=function(){q[c](h)}})(b);s.ContextMenu.register(h.document,{rules:[g],width:"120px",funcs:t});p.attach({pluginName:"image",pluginInstance:this})},_dblclick:function(h){var l=new x(h.target);if(g(l)){this.show(null,l);h.halt()}},_prepare:function(){var h=this;h.get("editor");
h.d=new v({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var l=h.d;l.body.html(o);l.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");h.content=l.el;l=h.content;var t=l.one(".ke-img-cancel"),b=l.one(".ke-img-insert");h.imgUrl=l.one(".ke-img-url");h.imgHeight=l.one(".ke-img-height");h.imgWidth=l.one(".ke-img-width");h.imgAlign=l.one(".ke-img-align");h.imgMargin=l.one(".ke-img-margin");t.on("click",function(c){h.d.hide();
c.halt()});b.on("click",function(){h._insert()})},_updateTip:function(h,l){h.html(l.attr("src"));h.attr("href",l.attr("src"))},_real:function(){this.d.show()},_insert:function(){var h=this.imgUrl.val();if(h){var l=parseInt(this.imgHeight.val()),t=this.get("editor"),b=parseInt(this.imgWidth.val()),c=this.imgAlign.val(),f=parseInt(this.imgMargin.val()),e="";if(l)e+="height:"+l+"px;";if(b)e+="width:"+b+"px;";if(c)e+="float:"+c+";";isNaN(f)||(e+="margin:"+f+"px;");if(e)e=" style='"+e+"' ";h=new x("<img "+
e+"src='"+h+"' alt='' />",null,t.document);h=t.insertElement(h,l||b?null:function(m){m.on("load",function(){m.detach();m.css({width:m.width()+"px",height:m.height()+"px"})})});this._selectedEl&&t.getSelection().selectElement(h);this.d.hide();t.notifySelectionChange()}},_updateD:function(h){if(this._selectedEl=h){this.imgUrl.val(h.attr("src"));this.imgHeight.val(h.height());this.imgWidth.val(h.width());this.imgAlign.val(h._4e_style("float"));this.imgMargin.val(parseInt(h._4e_style("margin"))||0)}else{this.imgUrl.val("http://");
this.imgHeight.val("\u81ea\u52a8");this.imgWidth.val("\u81ea\u52a8");this.imgAlign.val();this.imgMargin.val("5")}},show:function(h,l){this._prepare();this._updateD(l)}});s.ImageInserter=i;(function(h,l,t){p.register({pluginName:h,func:t,init:function(){var b=this,c=b.el;c.html(l+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var f=c.one(".ke-bubbleview-url"),e=c.one(".ke-bubbleview-change");c=c.one(".ke-bubbleview-remove");e._4e_unselectable();f._4e_unselectable();c._4e_unselectable();e.on("click",function(m){b._plugin.show(null,b._selectedEl);m.halt()});c.on("click",function(m){var j=b._plugin;if(r.webkit){var a=j.editor.getSelection().getRanges();a&&a[0]&&(a[0].collapse(true)||1)&&a[0].select()}b._selectedEl._4e_remove();b.hide();j.editor.notifySelectionChange();m.halt()});b.on("afterVisibleChange",function(m){var j=
b._selectedEl;m.newVal&&j&&b._plugin._updateTip(f,j)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",g)}();w.addPlugin(function(){new s.ImageInserter({editor:w})})});
KISSY.Editor.add("indent",function(w){var s=KISSY.Editor,A={ol:1,ul:1},r=KISSY,x=s.Walker,C=r.DOM,p=r.Node,v=r.UA,i=s.NODE;s.Indent||function(){function g(f){this.type=f;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function k(f){return f.type=CKEDITOR.NODE_ELEMENT&&f.is("li")}function o(f,e,m){var j=e.startContainer;for(f=e.endContainer;j&&j.parent()[0]!==m[0];)j=j.parent();for(;f&&f.parent()[0]!==m[0];)f=f.parent();if(j&&f){var a=j;j=[];for(var d=false;!d;){if(a[0]===
f[0])d=true;j.push(a);a=a.next()}if(!(j.length<1)){a=m._4e_parents(true);for(f=0;f<a.length;f++)if(A[a[f]._4e_name()]){m=a[f];break}a=this.type=="indent"?1:-1;f=j[0];d=j[j.length-1];j={};var n=s.ListUtils.listToArray(m,j),z=n[d._4e_getData("listarray_index")].indent;for(f=f._4e_getData("listarray_index");f<=d._4e_getData("listarray_index");f++){n[f].indent+=a;var y=n[f].parent;n[f].parent=new p(y[0].ownerDocument.createElement(y._4e_name()))}for(f=d._4e_getData("listarray_index")+1;f<n.length&&n[f].indent>
z;f++)n[f].indent+=a;d=s.ListUtils.arrayToList(n,j,null,"p",0);a=[];if(this.type=="outdent"){var B;if((B=m.parent())&&B._4e_name()=="li"){n=d.listNode.childNodes;var G;for(f=n.length-1;f>=0;f--)if((G=new p(n[f]))&&G._4e_name()=="li")a.push(G)}}if(d){C.insertBefore(d.listNode,m[0]);m._4e_remove()}if(a&&a.length)for(f=0;f<a.length;f++){for(G=m=a[f];(G=G.next())&&G._4e_name()in A;){v.ie&&!m._4e_first(function(M){return t(M)&&b(M)})&&m[0].appendChild(e.document.createTextNode("\u00a0"));m[0].appendChild(G[0])}C.insertAfter(m[0],
B[0])}for(f in j)j[f]._4e_clearMarkers(j,true)}}}function q(f,e){e=e.createIterator();e.enforceRealBlocks=true;e.enlargeBr=true;for(var m;m=e.getNextParagraph();)h.call(this,f,m)}function h(f,e){f=parseInt(e._4e_style(this.indentCssProperty),10);if(isNaN(f))f=0;f+=(this.type=="indent"?1:-1)*this.indentOffset;if(f<0)return false;f=Math.max(f,0);f=Math.ceil(f/this.indentOffset)*this.indentOffset;e.css(this.indentCssProperty,f?f+this.indentUnit:"");e[0].style.cssText===""&&e[0].removeAttribute("style");
return true}function l(f){l.superclass.constructor.call(this,f);f=this.get("editor").toolBarDiv;this.el=new c({container:f,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new g(this.get("type"));this._init()}var t=x.whitespaces(true),b=x.bookmark(false,true);r.augment(g,{exec:function(f){for(var e=f.getSelection(),m=e&&e.getRanges()[0],j=m.startContainer,a=m.endContainer,d=m.getCommonAncestor();d&&!(d[0].nodeType==i.NODE_ELEMENT&&A[d._4e_name()]);)d=d.parent();if(d&&
j[0].nodeType==i.NODE_ELEMENT&&j._4e_name()in A){j=new x(m);j.evaluator=k;m.startContainer=j.next()}if(d&&a[0].nodeType==i.NODE_ELEMENT&&a._4e_name()in A){j=new x(m);j.evaluator=k;m.endContainer=j.previous()}a=e.createBookmarks(true);if(d){for(j=d._4e_first();j&&j[0]&&j._4e_name()!="li";)j=j.next();var n=m.startContainer;(j[0]==n[0]||j._4e_contains(n))&&h.call(this,f,d)||o.call(this,f,m,d)}else q.call(this,f,m);e.selectBookmarks(a)}});var c=s.TripleButton;l.ATTRS={type:{},contentCls:{},editor:{}};
r.extend(l,r.Base,{_init:function(){var f=this.get("editor"),e=this.el;e.on("offClick",this.exec,this);this.get("type")=="outdent"?f.on("selectionChange",this._selectionChange,this):e.set("state",c.OFF)},exec:function(){var f=this.get("editor"),e=this;f.fire("save");setTimeout(function(){e.indentCommand.exec(f);f.fire("save");f.notifySelectionChange()},10)},_selectionChange:function(f){this.get("editor");this.get("type");var e=f.path,m=e.blockLimit;f=this.el;if(e.contains(A))f.set("state",c.OFF);
else(e=e.block||m)&&e._4e_style(this.indentCommand.indentCssProperty)?f.set("state",c.OFF):f.set("state",c.DISABLED)}});s.Indent=l}();w.addPlugin(function(){w.addCommand("outdent",new s.Indent({editor:w,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));w.addCommand("indent",new s.Indent({editor:w,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(w){var s=KISSY.Editor,A=KISSY,r=s.TripleButton;s.Justify||function(){function x(p,v,i,g){this.editor=p;this.v=v;this.contentCls=g;this.title=i;this._init()}var C=/(-moz-|-webkit-|start|auto)/i;A.augment(x,{_init:function(){var p=this.editor;this.el=new r({contentCls:this.contentCls,title:this.title,container:p.toolBarDiv});p.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var p=this.editor,v=p.getSelection(),
i=this.el.get("state");if(v){var g=v.createBookmarks(),k=v.getRanges(),o,q;p.fire("save");for(var h=k.length-1;h>=0;h--){o=k[h].createIterator();for(o.enlargeBr=true;q=o.getNextParagraph();){q.removeAttr("align");i==r.OFF?q.css("text-align",this.v):q.css("text-align","")}}p.notifySelectionChange();v.selectBookmarks(g);p.fire("save")}},_selectionChange:function(p){var v=this.el;p=p.path;if(p=p.block||p.blockLimit){p=p.css("text-align").replace(C,"");p==this.v||!p&&this.v=="left"?v.set("state",r.ON):
v.set("state",r.OFF)}}});s.Justify=x}();w.addPlugin(function(){new s.Justify(w,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new s.Justify(w,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new s.Justify(w,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(w){var s=KISSY.Editor;s.Link||function(){function A(q){this.editor=q;this._init()}function r(q){return q._4e_ascendant(function(h){return h._4e_name()==="a"&&!!h.attr("href")},true)}var x=KISSY,C=s.TripleButton,p=s.Style,v=x.Node,i=s.Range,g=s.SimpleOverlay,k=s.BubbleView,o={element:"a",attributes:{href:"#(href)",target:"#(target)"}};A.init=function(){var q=new g({title:"\u94fe\u63a5\u5c5e\u6027",mask:true,width:"300px"});this.dialog=q;q.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input class='ke-link-url' style='width:220px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
q.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");q.urlEl=q.body.one(".ke-link-url");q.targetEl=q.body.one(".ke-link-blank");var h=q.foot.one(".ke-link-cancel");q.foot.one(".ke-link-ok").on("click",function(l){q.link._link();l.halt()},this);h.on("click",function(l){q.hide();l.halt()},this);A.init=null};k.register({pluginName:"link",func:r,init:function(){var q=this,h=q.el;h.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var l=h.one(".ke-bubbleview-url"),t=h.one(".ke-bubbleview-change");h=h.one(".ke-bubbleview-remove");t._4e_unselectable();l._4e_unselectable();h._4e_unselectable();t.on("click",function(b){q._plugin.show();b.halt()});h.on("click",function(b){var c=q._plugin;c._removeLink(q._selectedEl);c.editor.notifySelectionChange();b.halt()});q.on("afterVisibleChange",function(){var b=q._selectedEl;if(b){l.html(b.attr("href"));l.attr("href",b.attr("href"))}})}});x.augment(A,{_init:function(){this.el=new C({container:this.editor.toolBarDiv,
contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5 "});this.el.on("click",this.show,this);k.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(q){var h=this.editor,l={href:q.attr("href")};if(q._4e_hasAttribute("target"))l.target=q.attr("target");q=new p(o,l);h.fire("save");q.remove(h.document);h.fire("save")},_getSelectedLink:function(){var q=this.editor.getSelection();if(q=q&&q.getStartElement())q=r(q);return q},_link:function(){var q,h=this.editor,l=A.dialog,t=l.urlEl.val(),
b;if(x.trim(t)){l.hide();if(b=this._getSelectedLink()){q=new i(h.document);q.selectNodeContents(b);h.getSelection().selectRanges([q]);this._removeLink(b)}b={href:t};b.target=l.targetEl[0].checked?"_blank":"_self";q=h.getSelection().getRanges()[0];if(q.collapsed){q=new v("<a href='"+t+"' target='"+b.target+"'>"+t+"</a>",null,h.document);h.insertElement(q)}else{h.fire("save");q=new p(o,b);q.apply(h.document);h.fire("save")}h.notifySelectionChange()}},_prepare:function(){A.init&&A.init()},_real:function(){var q=
A.dialog,h=this._getSelectedLink();q.link=this;if(h){q.urlEl.val(h.attr("href"));q.targetEl[0].checked=h.attr("target")=="_blank"}q.show()},show:function(){this._prepare()}});s.Utils.lazyRun(A.prototype,"_prepare","_real");s.Link=A}();w.addPlugin(function(){new s.Link(w)})});
KISSY.Editor.add("list",function(w){var s=KISSY.Editor,A={ol:1,ul:1},r=["ol","ul"],x=KISSY,C=s.RANGE,p=s.ElementPath,v=s.Walker,i=s.NODE,g=x.UA,k=x.Node,o=x.DOM;s.List||function(){function q(c){this.type=c}function h(c){h.superclass.constructor.call(this,c);c=this.get("editor").toolBarDiv;this.el=new b({contentCls:this.get("contentCls"),title:this.get("title"),container:c});this.listCommand=new q(this.get("type"));this.listCommand.state=this.get("status");this._init()}var l={listToArray:function(c,
f,e,m,j){if(!A[c._4e_name()])return[];m||(m=0);e||(e=[]);for(var a=0,d=c[0].childNodes.length;a<d;a++){var n=new k(c[0].childNodes[a]);if(n._4e_name()=="li"){var z={parent:c,indent:m,element:n,contents:[]};if(j)z.grandparent=j;else{z.grandparent=c.parent();if(z.grandparent&&z.grandparent._4e_name()=="li")z.grandparent=z.grandparent.parent()}f&&n._4e_setMarker(f,"listarray_index",e.length);e.push(z);for(var y=0,B=n[0].childNodes.length,G;y<B;y++){G=new k(n[0].childNodes[y]);G[0].nodeType==i.NODE_ELEMENT&&
A[G._4e_name()]?l.listToArray(G,f,e,m+1,z.grandparent):z.contents.push(G)}}}return e},arrayToList:function(c,f,e,m){e||(e=0);if(!c||c.length<e+1)return null;for(var j=c[e].parent[0].ownerDocument,a=j.createDocumentFragment(),d=null,n=e,z=Math.max(c[e].indent,0),y=null;;){var B=c[n];if(B.indent==z){if(!d||c[n].parent._4e_name()!=d._4e_name()){d=c[n].parent._4e_clone(false,true);a.appendChild(d[0])}y=d[0].appendChild(B.element._4e_clone(false,true)[0]);for(var G=0;G<B.contents.length;G++)y.appendChild(B.contents[G]._4e_clone(true,
true)[0]);n++}else if(B.indent==Math.max(z,0)+1){n=l.arrayToList(c,null,n,m);y.appendChild(n.listNode);n=n.nextIndex}else if(B.indent==-1&&!e&&B.grandparent){y=A[B.grandparent._4e_name()]?B.element._4e_clone(false,true)[0]:B.grandparent._4e_name()!="td"?j.createElement(m):j.createDocumentFragment();for(G=0;G<B.contents.length;G++)y.appendChild(B.contents[G]._4e_clone(true,true)[0]);if(y.nodeType==i.NODE_DOCUMENT_FRAGMENT&&n!=c.length-1){y.lastChild&&y.lastChild.nodeType==i.NODE_ELEMENT&&y.lastChild.getAttribute("type")==
"_moz"&&o._4e_remove(y.lastChild);o._4e_appendBogus(y)}if(y.nodeType==i.NODE_ELEMENT&&o._4e_name(y)==m&&y.firstChild){o._4e_trim(y);d=y.firstChild;if(d.nodeType==i.NODE_ELEMENT&&o._4e_isBlockBoundary(d)){d=j.createDocumentFragment();o._4e_moveChildren(y,d);y=d}}d=o._4e_name(y);if(!g.ie&&(d=="div"||d=="p"))o._4e_appendBogus(y);a.appendChild(y);d=null;n++}else return null;if(c.length<=n||Math.max(c[n].indent,0)<z)break}if(f)for(c=new k(a.firstChild);c&&c[0];){c[0].nodeType==i.NODE_ELEMENT&&c._4e_clearMarkers(f,
true);c=c._4e_nextSourceNode()}return{listNode:a,nextIndex:n}}},t=/^h[1-6]$/;q.prototype={changeListType:function(c,f,e,m){var j=l.listToArray(f.root,e),a=[];for(c=0;c<f.contents.length;c++){var d=f.contents[c];d=d._4e_ascendant("li",true);if(!(!d||!d[0]||d._4e_getData("list_item_processed"))){a.push(d);d._4e_setMarker(e,"list_item_processed",true)}}d=new k(f.root[0].ownerDocument.createElement(this.type));for(c=0;c<a.length;c++){var n=a[c]._4e_getData("listarray_index");j[n].parent=d}e=l.arrayToList(j,
e,null,"p");var z;j=e.listNode.childNodes.length;for(c=0;c<j&&(z=new k(e.listNode.childNodes[c]));c++)z._4e_name()==this.type&&m.push(z);o.insertBefore(e.listNode,f.root[0]);f.root._4e_remove()},createList:function(c,f,e){var m=f.contents;c=f.root[0].ownerDocument;var j=[];if(m.length==1&&m[0][0]===f.root[0]){var a=new k(c.createElement("div"));m[0][0].nodeType!=i.NODE_TEXT&&m[0]._4e_moveChildren(a);m[0][0].appendChild(a[0]);m[0]=a}f=f.contents[0].parent();for(a=0;a<m.length;a++)f=f._4e_commonAncestor(m[a].parent());
for(a=0;a<m.length;a++)for(var d=m[a],n;n=d.parent();){if(n[0]===f[0]){j.push(d);break}d=n}if(!(j.length<1)){m=new k(j[j.length-1][0].nextSibling);a=new k(c.createElement(this.type));for(e.push(a);j.length;){e=j.shift();d=new k(c.createElement("li"));if(t.test(e._4e_name()))d[0].appendChild(e[0]);else{e._4e_copyAttributes(d);e._4e_moveChildren(d);e._4e_remove()}a[0].appendChild(d[0]);g.ie||d._4e_appendBogus()}m[0]?o.insertBefore(a[0],m[0]):f[0].appendChild(a[0])}},removeList:function(c,f,e){function m(G){if((y=
new k(z[G?"firstChild":"lastChild"]))&&!(y[0].nodeType==i.NODE_ELEMENT&&y._4e_isBlockBoundary())&&(B=f.root[G?"_4e_previous":"_4e_next"](v.whitespaces(true)))&&!(y[0].nodeType==i.NODE_ELEMENT&&B._4e_isBlockBoundary({br:1})))o[G?"insertBefore":"insertAfter"](c.document.createElement("br"),y[0])}for(var j=l.listToArray(f.root,e),a=[],d=0;d<f.contents.length;d++){var n=f.contents[d];n=n._4e_ascendant("li",true);if(!(!n||n._4e_getData("list_item_processed"))){a.push(n);n._4e_setMarker(e,"list_item_processed",
true)}}n=null;for(d=0;d<a.length;d++){n=a[d]._4e_getData("listarray_index");j[n].indent=-1;n=n}for(d=n+1;d<j.length;d++)if(j[d].indent>Math.max(j[d-1].indent,0)){a=j[d-1].indent+1-j[d].indent;for(n=j[d].indent;j[d]&&j[d].indent>=n;){j[d].indent+=a;d++}d--}var z=l.arrayToList(j,e,null,"p").listNode,y,B;m(true);m();o.insertBefore(z,f.root);f.root._4e_remove()},exec:function(c){var f=c.getSelection(),e=f&&f.getRanges();if(!(!e||e.length<1)){for(var m=f.createBookmarks(true),j=[],a={};e.length>0;){var d=
e.shift(),n=d.getBoundaryNodes(),z=n.startNode,y=n.endNode;z[0].nodeType==i.NODE_ELEMENT&&z._4e_name()=="td"&&d.setStartAt(n.startNode,C.POSITION_AFTER_START);y[0].nodeType==i.NODE_ELEMENT&&y._4e_name()=="td"&&d.setEndAt(n.endNode,C.POSITION_BEFORE_END);d=d.createIterator();for(d.forceBrBreak=false;n=d.getNextParagraph();){z=new p(n);y=z.elements;var B=null,G=false,M=z.blockLimit,u;for(z=y.length-1;z>=0&&(u=y[z]);z--)if(A[u._4e_name()]&&M.contains(u)){M._4e_removeData("list_group_object");if(z=u._4e_getData("list_group_object"))z.contents.push(n);
else{z={root:u,contents:[n]};j.push(z);u._4e_setMarker(a,"list_group_object",z)}G=true;break}if(!G)if(M._4e_getData("list_group_object"))M._4e_getData("list_group_object").contents.push(n);else{z={root:M,contents:[n]};M._4e_setMarker(a,"list_group_object",z);j.push(z)}}}for(e=[];j.length>0;){z=j.shift();if(this.state=="off")A[z.root._4e_name()]?this.changeListType(c,z,a,e):this.createList(c,z,e);else this.state=="on"&&A[z.root._4e_name()]&&this.removeList(c,z,a)}for(z=0;z<e.length;z++){B=e[z];var D=
this;(c=function(I){var L=B[I?"_4e_previous":"_4e_next"](v.whitespaces(true));if(L&&L[0]&&L._4e_name()==D.type){L._4e_remove();L._4e_moveChildren(B,I?true:false)}})();c(true)}s.Utils.clearAllMarkers(a);f.selectBookmarks(m)}}};var b=s.TripleButton;h.ATTRS={editor:{},type:{},contentCls:{}};x.extend(h,x.Base,{_init:function(){var c=this,f=c.get("editor"),e=c.el;c=c;e.on("click",c._change,c);f.on("selectionChange",c._selectionChange,c)},_change:function(){var c=this.get("editor");this.get("type");var f=
this.el;c.fire("save");this.listCommand.state=f.get("state");this.listCommand.exec(c);c.fire("save");c.notifySelectionChange()},_selectionChange:function(c){this.get("editor");var f=this.get("type"),e=c.path,m;c=this.el;var j=e.blockLimit;if(e=e.elements)for(var a=0;a<e.length&&(m=e[a])&&m[0]!==j[0];a++){var d=x.indexOf(e[a]._4e_name(),r);if(d!==-1)if(r[d]===f){c.set("state",b.ON);return}else break}c.set("state",b.OFF)}});s.ListUtils=l;s.List=h}();w.addPlugin(function(){new s.List({editor:w,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new s.List({editor:w,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(w){var s=KISSY.Editor,A=KISSY,r=A.UA,x=A.Node,C=A.Event,p=s.TripleButton,v=A.DOM,i;s.Maximize||function(){function g(k){this.editor=k;this._init()}g.init=function(){i=new x("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(i[0]);g.init=null};A.augment(g,{_init:function(){this.el=new p({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);s.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var k=this,o=k.editor;C.remove(window,"resize",k._maximize,k);this._saveEditorStatus();o.wrap.css({height:k.iframeHeight});(new x(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";o.editorWrap.css({position:"static",width:k.editorWrapWidth});i.css({left:"-99999px",top:"-99999px"});window.scrollTo(k.scrollLeft,
k.scrollTop);k.el.set("state",p.OFF);setTimeout(function(){k._restoreEditorStatus()},30);o.notifySelectionChange()},_saveSate:function(){var k=this.editor;this.iframeHeight=k.wrap._4e_style("height");this.editorWrapWidth=k.editorWrap._4e_style("width");this.scrollLeft=v.scrollLeft();this.scrollTop=v.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var k=this.editor;if(r.gecko&&k.iframeFocus)this.savedRanges=(k=k.getSelection())&&k.getRanges()},_restoreEditorStatus:function(){var k=this.editor,
o=k.getSelection();if(r.gecko&&k.iframeFocus){this.el.el[0].focus();k.focus();this.savedRanges&&o&&o.selectRanges(this.savedRanges)}if(k.iframeFocus&&o)(k=o.getStartElement())&&k[0]&&k._4e_scrollIntoView()},_maximize:function(){var k=this.editor,o=v.viewportHeight(),q=v.viewportWidth(),h=k.statusDiv?k.statusDiv.height():0,l=k.toolBarDiv.height();if(r.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new x(document.body)).css({width:0,height:0,overflow:"hidden"});
k.editorWrap.css({position:"absolute",zIndex:990,width:q+"px"});i.css({zIndex:985,height:o+"px",width:q+"px"});k.editorWrap.offset({left:0,top:0});i.css({left:0,top:0});k.wrap.css({height:o-h-l-14+"px"});k.notifySelectionChange()},_real:function(){var k=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();C.on(window,"resize",k._maximize,k);this.el.set("state",p.ON);setTimeout(function(){k._restoreEditorStatus()},30)},_prepare:function(){g.init&&g.init()},maximize:function(){this._prepare()}});
s.Maximize=g}();w.addPlugin(function(){new s.Maximize(w)})});
KISSY.Editor.add("music",function(w){function s(k){return k.indexOf(p)!=-1}var A=KISSY.Editor,r=KISSY,x=A.Flash,C="ke_music",p="niftyplayer.swf",v=A.Utils.getFlashUrl,i=w.htmlDataProcessor,g=i&&i.dataFilter;g&&g.addRules({elements:{object:function(k){var o=k.attributes;if(!(o.classid&&String(o.classid).toLowerCase())){for(o=0;o<k.children.length;o++)if(k.children[o].name=="embed"){if(!x.isFlashEmbed(k.children[o]))return null;if(s(k.children[o].attributes.src))return i.createFakeParserElement(k,C,
"music",true)}return null}for(o=0;o<k.children.length;o++){var q=k.children[o];if(q.name=="param"&&q.attributes.name=="movie")if(s(q.attributes.value))return i.createFakeParserElement(k,C,"music",true)}},embed:function(k){if(!x.isFlashEmbed(k))return null;if(s(k.attributes.src))return i.createFakeParserElement(k,C,"music",true)}}},4);A.MusicInserter||function(){function k(){k.superclass.constructor.apply(this,arguments)}function o(f){return f._4e_name()==="img"&&!!f.hasClass(C)&&f}function q(f){return f.replace(/^.+niftyplayer\.swf\?file=/,
"")}var h=A.Config.base+"plugins/music/niftyplayer.swf?file=#(music)",l="<p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3'/></label></p><p style='margin:5px 0'><label>\u5bf9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u9f50\uff1a <select class='ke-music-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
A.Utils.duplicateStr("&nbsp;",1)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-music-margin' style='width:90px' value='5'/> px</label><p>",t=/#\(music\)/g,b=["img."+C];r.extend(k,x,{_config:function(){this._cls=C;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml=l;this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=
c;this._flashRules=b},_initD:function(){var f=this,e=f.d;f.dUrl=e.el.one(".ke-music-url");f.dAlign=e.el.one(".ke-music-align");f.dMargin=e.el.one(".ke-music-margin");var m=e.el.one(".ke-music-ok");e=e.el.one(".ke-music-cancel");m.on("click",f._gen,f);e.on("click",function(){f.d.hide()})},_getDInfo:function(){return{url:h.replace(t,this.dUrl.val()),attrs:{width:165,height:37,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}},_getFlashUrl:function(f){return q(v(f))},
_updateD:function(){var f=this.editor,e=this.selectedFlash;if(e){f=f.restoreRealElement(e);this.dUrl.val(this._getFlashUrl(f));this.dAlign.val(e.attr("align"));this.dMargin.val(parseInt(f._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3");this.dAlign.val("");this.dMargin.val("5")}}});x.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",o);A.MusicInserter=k;var c={"\u97f3\u4e50\u5c5e\u6027":function(f){var e=f.getSelection();e=(e=e&&e.getStartElement())&&
o(e);f=f._toolbars.music;e&&f.show(null,e)}}}();w.addPlugin(function(){new A.MusicInserter(w)})});
KISSY.Editor.add("preview",function(w){var s=KISSY.Editor,A=KISSY,r=s.TripleButton;s.Preview||function(){function x(C){this.editor=C;this._init()}A.augment(x,{_init:function(){this.el=new r({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var C=this.editor,p=640,v=420,i=80;try{var g=window.screen;p=Math.round(g.width*0.8);v=Math.round(g.height*0.7);i=Math.round(g.width*0.1)}catch(k){}C=
C._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+C.getData()+"\n</body>");p=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+p+",height="+v+",left="+i);p.document.open();p.document.write(C);p.document.close();p.focus()}});s.Preview=x}();w.addPlugin(function(){new s.Preview(w)})});
KISSY.Editor.add("removeformat",function(w){function s(o){this.editor=o;this._init()}function A(o,q){for(var h=0;h<q.length;h++)o.removeAttr(q[h])}var r=KISSY.Editor,x=KISSY,C=r.RANGE,p=r.ElementPath,v=r.NODE,i=r.TripleButton,g="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",k="class,style,lang,width,height,align,hspace,valign".split(",");g=new RegExp("^(?:"+g.replace(/,/g,"|")+")$","i");x.augment(s,{_init:function(){this.el=new i({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var o=this.editor,q=g;q.lastIndex=0;var h=o.getSelection().getRanges();o.fire("save");for(var l=0,t;t=h[l];l++)if(!t.collapsed){t.enlarge(C.ENLARGE_ELEMENT);var b=t.createBookmark(),c=b.startNode,f=b.endNode,e=function(m){for(var j=new p(m),a=j.elements,d=1,n;n=a[d];d++){if(n._4e_equals(j.block)||n._4e_equals(j.blockLimit))break;q.test(n._4e_name())&&m._4e_breakParent(n)}};
e(c);e(f);for(c=c._4e_nextSourceNode(true,v.NODE_ELEMENT);c;){if(c._4e_equals(f))break;e=c._4e_nextSourceNode(false,v.NODE_ELEMENT);c._4e_name()=="img"&&c.attr("_cke_realelement")||(q.test(c._4e_name())?c._4e_remove(true):A(c,k));c=e}t.moveToBookmark(b)}o.getSelection().selectRanges(h);o.fire("save")}});w.addPlugin(function(){new s(w)})});
KISSY.Editor.add("resize",function(w){var s=KISSY,A=s.Editor,r=s.Node;A.Resizer||function(){function x(p){this.editor=p;this._init()}var C=A.Draggable;s.augment(x,{_init:function(){var p=this.editor,v=p.statusDiv,i=new r("<div class='ke-resizer'></div>");i.appendTo(v);v=new C({node:i});var g=0,k=0,o=p.wrap,q=p.editorWrap;v.on("start",function(){g=o.height();k=q.width()});v.on("move",function(h){var l=h.pageX-this.startMousePos.left;o.height(g+(h.pageY-this.startMousePos.top));q.width(k+l)})}});A.Resizer=
x}();w.addPlugin(function(){new A.Resizer(w)})});
KISSY.Editor.add("smiley",function(w){var s=KISSY.Editor,A=KISSY,r=A.DOM,x=A.Event,C=A.Node,p=s.SimpleOverlay,v=s.TripleButton;s.Smiley||function(){function i(o){this.editor=o;this._init()}for(var g="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",k=0;k<=98;k++)g+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+k+".gif'></a>";g+="</div></div>";A.augment(i,{_init:function(){this.el=new v({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(o){var q=this;r._4e_ascendant(o.target,function(h){return h[0]===q.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(o){o.halt();var q=this.editor;o=o.target;var h;if(r._4e_name(o)=="a"&&(h=r.attr(o,"data-icon"))){h=new C("<img alt='' src='"+h+"'/>",null,q.document);q.insertElement(h);this.smileyWin.hide()}},_prepare:function(){var o=this.editor;this.smileyPanel=new C(g);this.smileyWin=new p({el:this.smileyPanel,
focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);x.on(document,"click",this._hidePanel,this);x.on(o.document,"click",this._hidePanel,this)},_real:function(){var o=this.el.el.offset();o.top+=this.el.el.height()+5;if(o.left+this.smileyPanel.width()>r.viewportWidth()-60)o.left=r.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(o)},_show:function(o){this._prepare(o)}});s.Smiley=i}();w.addPlugin(function(){new s.Smiley(w)})});
KISSY.Editor.add("sourcearea",function(w){var s=KISSY.Editor,A=KISSY,r=A.UA,x=s.TripleButton;s.SourceArea||function(){function C(p){this.editor=p;this._init()}A.augment(C,{_init:function(){var p=this.editor;this.el=new x({container:p.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);p.textarea.on("mousedown",function(v){v.stopPropagation()})},_show:function(){var p=this.editor,v=
this.el;p.textarea.val(p.getData());p._showSource();v.set("state",x.ON)},_hide:function(){var p=this.editor,v=p.textarea,i=this.el;p._hideSource();p.setData(v.val());if(r.gecko&&p.iframeFocus){i.el[0].focus();p.focus()}i.set("state",x.OFF)}});s.SourceArea=C}();w.addPlugin(function(){new s.SourceArea(w)})});
KISSY.Editor.add("table",function(w,s){var A=KISSY.Editor,r=KISSY,x=r.Node,C=r.DOM,p=A.Walker,v=r.UA,i=A.NODE,g=A.TripleButton,k=A.SimpleOverlay,o=A.Utils.isNumber,q=A.ContextMenu,h=["tr","th","td","tbody","table"],l=r.trim,t;t=(v.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var b=w.htmlDataProcessor,c=b&&b.dataFilter;b=b&&b.htmlFilter;c&&c.addRules({elements:{table:function(f){f=f.attributes;var e=f["class"],m=parseInt(f.border,10);if(!m||m<=0)f["class"]=(e||"")+" ke_show_border"}}});b&&b.addRules({elements:{table:function(f){f=f.attributes;var e=f["class"];if(e)f["class"]=r.trim(e.replace("ke_show_border","").replace(/\s{2}/," "))}}});A.TableUI||function(){function f(u){this.editor=u;this.selectedTable=
null;u._toolbars=u._toolbars||{};u._toolbars.table=this;this._init()}function e(u){return l(u).length!=0}function m(u){function D(X){if(!(N.length>0))if(X[0].nodeType==i.NODE_ELEMENT&&G.test(X._4e_name())&&!X._4e_getData("selected_cell")){X._4e_setMarker(O,"selected_cell",true);N.push(X)}}for(var I=u.createBookmarks(),L=u.getRanges(),N=[],O={},S=0;S<L.length;S++){var R=L[S];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new p(R);
var Y;for(R.guard=D;Y=R.next();)if((Y=Y.parent())&&G.test(Y._4e_name())&&!Y._4e_getData("selected_cell")){Y._4e_setMarker(O,"selected_cell",true);N.push(Y)}}}A.Utils.clearAllMarkers(O);u.selectBookmarks(I);return N}function j(u){u=u.cells;for(var D=0;D<u.length;D++){u[D].innerHTML="";v.ie||(new x(u[D]))._4e_appendBogus()}}function a(u,D){if(u=u.getStartElement()._4e_ascendant("tr")){var I=u._4e_clone(true);I.insertBefore(u);j(D?I[0]:u[0])}}function d(u){if(u instanceof A.Selection){var D=m(u),I=D.length;
u=[];for(var L,N,O=0;O<I;O++){var S=D[O].parent(),R=S[0].rowIndex;!O&&(L=R-1);u[R]=S;O==I-1&&(N=R+1)}O=S._4e_ascendant("table");L=new x(N<O[0].rows.length&&O[0].rows[N]||L>0&&O[0].rows[L]||O[0].parentNode);for(O=u.length;O>=0;O--)u[O]&&d(u[O]);return L}else if(u instanceof x){O=u._4e_ascendant("table");O[0].rows.length==1?O._4e_remove():u._4e_remove()}return 0}function n(u,D){u=u.getStartElement();if(u=u._4e_ascendant("td",true)||u._4e_ascendant("th",true))for(var I=u._4e_ascendant("table"),L=u[0].cellIndex,
N=0;N<I[0].rows.length;N++){var O=I[0].rows[N];if(!(O.cells.length<L+1)){u=new x(O.cells[L].cloneNode(false));v.ie||u._4e_appendBogus();O=new x(O.cells[L]);D?u.insertBefore(O):u.insertAfter(O)}}}function z(u){var D=[],I=u[0]&&u[0]._4e_ascendant("table"),L,N,O,S;L=0;for(N=u.length;L<N;L++)D.push(u[L][0].cellIndex);D.sort();L=1;for(N=D.length;L<N;L++)if(D[L]-D[L-1]>1){O=D[L-1]+1;break}O||(O=D[0]>0?D[0]-1:D[D.length-1]+1);u=I[0].rows;L=0;for(N=u.length;L<N;L++)if(S=u[L].cells[O])break;return S?new x(S):
I._4e_previous()}function y(u){if(u instanceof A.Selection){var D=m(u),I=z(D);for(u=D.length-1;u>=0;u--)D[u]&&y(D[u]);return I}else if(u instanceof x){D=u._4e_ascendant("table");if(!D)return null;I=u[0].cellIndex;for(u=D[0].rows.length-1;u>=0;u--){var L=new x(D[0].rows[u]);if(!I&&L[0].cells.length==1)d(L);else L[0].cells[I]&&L[0].removeChild(L[0].cells[I])}}return null}function B(u,D){var I=new A.Range(u[0].ownerDocument);if(!I.moveToElementEditablePosition(u,D?true:s)){I.selectNodeContents(u);I.collapse(D?
false:true)}I.select(true)}r.augment(f,{_init:function(){var u=this.editor,D={};this.el=new g({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:u.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in M)(function(L){D[L]=function(){u.fire("save");M[L](u);u.fire("save")}})(I);q.register(u.document,{rules:h,width:"120px",funcs:D});A.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var u=this,D=new k({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});
D.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
D.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");D.twidth=D.body.one(".ke-table-width");D.theight=D.body.one(".ke-table-height");D.tcellspacing=D.body.one(".ke-table-cellspacing");D.tcellpadding=D.body.one(".ke-table-cellpadding");D.tborder=D.body.one(".ke-table-border");D.tcaption=D.body.one(".ke-table-caption");D.talign=D.body.one(".ke-table-align");D.trows=D.body.one(".ke-table-rows");D.tcols=D.body.one(".ke-table-cols");D.thead=
D.body.one(".ke-table-head");var I=D.foot.one(".ke-table-ok"),L=D.foot.one(".ke-table-cancel");D.twidthunit=D.body.one(".ke-table-width-unit");u.tableDialog=D;I.on("click",u._tableOk,u);D.on("hide",function(){u.selectedTable=null});L.on("click",function(){D.hide()})},_tableOk:function(){for(var u=this.tableDialog,D=u.el.all("input"),I=0;I<D.length;I++){var L=new x(D[I]);if(L[0]!=u.tcaption[0])if(r.trim(L.val())&&!o(L.val())){u=L.parent("label").text().replace(/[:\uff1a]/g,"");alert(u+"\u8bf7\u8f93\u5165\u6570\u5b57");
return}}this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var u=this.tableDialog,D=this.selectedTable,I=D.one("caption");e(u.talign.val())&&D.attr("align",l(u.talign.val()));e(u.tcellspacing.val())&&D.attr("cellspacing",l(u.tcellspacing.val()));e(u.tcellpadding.val())&&D.attr("cellpadding",l(u.tcellpadding.val()));e(u.tborder.val())&&D.attr("border",l(u.tborder.val()));!e(u.tborder.val())||u.tborder.val()=="0"?D.addClass("ke_show_border"):D.removeClass("ke_show_border");
e(u.twidth.val())&&D.css("width",l(u.twidth.val())+u.twidthunit.val());e(u.theight.val())&&D.css("height",l(u.theight.val()));if(e(u.tcaption.val()))I&&I[0]?I.html(l(u.tcaption.val())):(new x("<caption><span>"+l(u.tcaption.val())+"</span></caption>")).insertBefore(D[0].firstChild);else I&&I._4e_remove();u.hide()},_genTable:function(){var u=this.tableDialog,D="<table ",I,L=parseInt(u.tcols.val())||1,N=parseInt(u.trows.val())||1,O=v.ie?"":"<br/>",S=this.editor;if(r.trim(u.talign.val()).length!=0)D+=
"align='"+r.trim(u.talign.val())+"' ";if(r.trim(u.tcellspacing.val()).length!=0)D+="cellspacing='"+r.trim(u.tcellspacing.val())+"' ";if(r.trim(u.tcellpadding.val()).length!=0)D+="cellpadding='"+r.trim(u.tcellpadding.val())+"' ";if(r.trim(u.tborder.val()).length!=0)D+="border='"+r.trim(u.tborder.val())+"' ";if(r.trim(u.twidth.val()).length!=0||r.trim(u.theight.val()).length!=0){D+="style='";if(r.trim(u.twidth.val()).length!=0)D+="width:"+r.trim(u.twidth.val())+u.twidthunit.val()+";";if(r.trim(u.theight.val()).length!=
0)D+="height:"+r.trim(u.theight.val())+"px;";D+="' "}if(r.trim(u.tborder.val()).length==0||r.trim(u.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(r.trim(u.tcaption.val()))D+="<caption><span>"+r.trim(u.tcaption.val())+"</span></caption>";if(u.thead.val()){D+="<thead>";D+="<tr>";for(I=0;I<L;I++)D+="<th>"+O+"</th>";D+="</tr>";D+="</thead>";N-=1}D+="<tbody>";for(var R=0;R<N;R++){D+="<tr>";for(I=0;I<L;I++)D+="<td>"+O+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new x(D,null,S.document);
S.insertElement(D);u.hide()},_fillTableDialog:function(){var u=this.tableDialog,D=this.selectedTable,I=D.one("caption");u.talign.val(D.attr("align")||"");u.tcellspacing.val(D.attr("cellspacing")||"");u.tcellpadding.val(D.attr("cellpadding")||"");u.tborder.val(D.attr("border")|"");var L=D._4e_style("width")||"";u.twidth.val(L.replace(/px|%/i,""));L.indexOf("%")!=-1?u.twidthunit.val("%"):u.twidthunit.val("px");u.theight.val((D._4e_style("height")||"").replace(/px|%/i,""));L="";if(I)L=I.text();u.tcaption.val(L);
u.trows.val(D.one("tbody").children().length);u.tcols.val(D.one("tr").children().length);u.thead.val(D._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});
var G=/^(?:td|th)$/,M={"\u8868\u683c\u5c5e\u6027":function(u){var D=u.getSelection();if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",true)){u=u._toolbars.table;u.selectedTable=D;u._tableShow()}},"\u5220\u9664\u8868\u683c":function(u){var D=(u=u.getSelection())&&u.getStartElement();if(D=D&&D._4e_ascendant("table",true)){u.selectElement(D);var I=u.getRanges()[0];I.collapse();u.selectRanges([I]);u=D.parent();u[0].childNodes.length==1&&u._4e_name()!="body"&&u._4e_name()!="td"?u._4e_remove():
D._4e_remove()}},"\u5220\u9664\u884c ":function(u){u=u.getSelection();B(d(u),s)},"\u5220\u9664\u5217 ":function(u){u=u.getSelection();(u=y(u))&&B(u,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(u){u=u.getSelection();a(u,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(u){u=u.getSelection();a(u,s)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(u){u=u.getSelection();n(u,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(u){u=u.getSelection();n(u,s)}};A.TableUI=f}();w.addPlugin(function(){var f=
w.document;new A.TableUI(w);var e=C.create("<style>",null,f);f.getElementsByTagName("head")[0].appendChild(e);if(e.styleSheet)e.styleSheet.cssText=t;else e.appendChild(f.createTextNode(t))})});
KISSY.Editor.add("templates",function(w){var s=KISSY.Editor,A=KISSY,r=A.Node,x=s.TripleButton,C=s.SimpleOverlay;s.TplUI||function(){function p(v){this.editor=v;this._init()}A.augment(p,{_init:function(){(new x({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var v=this.editor,i=v.cfg.pluginConfig.templates||[],g="<div class='ke-tpl'>",k=0;k<i.length;k++)g+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
i[k].demo+"</a>";g+="</div>";this._initDialogOk=true;var o=new C({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});o.body.html(g);o.body.all(".ke-tpl-list").on("click",function(q){q.halt();q=(new r(q.target))._4e_index();q!=-1&&v.insertHtml(i[q].html);o.hide()});this.ui=o},_real:function(){this.ui.show()},_show:function(){this._prepare()}});s.TplUI=p}();w.addPlugin(function(){new s.TplUI(w)})});
KISSY.Editor.add("undo",function(w){var s=KISSY,A=s.Editor,r=A.Utils.arrayCompare,x=s.UA,C=s.Event;A.UndoManager||function(){function p(h){var l=h._getRawData();h=l&&h.getSelection();this.contents=l;this.bookmarks=h&&h.createBookmarks2(true)}function v(h){this.history=[];this.index=-1;this.editor=h;this.bufferRunner=A.Utils.buffer(this.save,this,500);this._init()}function i(h,l,t,b){this.editor=h;this.title=t;this.text=l;this.contentCls=b;this._init()}s.augment(p,{equals:function(h){if(this.contents!=
h.contents)return false;var l=this.bookmarks;h=h.bookmarks;if(l||h){if(!l||!h||l.length!=h.length)return false;for(var t=0;t<l.length;t++){var b=l[t],c=h[t];if(b.startOffset!=c.startOffset||b.endOffset!=c.endOffset||!r(b.start,c.start)||!r(b.end,c.end))return false}}return true}});var g={16:1,17:1,18:1},k={37:1,38:1,39:1,40:1,33:1,34:1};s.augment(v,{_keyMonitor:function(){var h=this.editor;C.on(h.document,"keydown",function(l){var t=l.keyCode;if(!(t in k||t in g))if(t===90&&(l.ctrlKey||l.metaKey)){h.fire("restore",
{d:-1});l.halt()}else if(t===89&&(l.ctrlKey||l.metaKey)){h.fire("restore",{d:1});l.halt()}else h.fire("save",{buffer:1})})},_init:function(){var h=this,l=h.editor;l.on("save",function(t){t.buffer?h.bufferRunner():h.save()});l.on("restore",h.restore,h);h._keyMonitor()},save:function(){var h=this.history,l=this.index;h.length>l+1&&h.splice(l+1,h.length-l-1);var t=this.editor;l=h[h.length-1];var b=new p(t);if(!l||!l.equals(b)){h.length===30&&h.shift();h.push(b);this.index=l=h.length-1;t.fire("afterSave",
{history:h,index:l})}},restore:function(h){h=h.d;var l=this.history,t=this.editor,b=l[this.index+h];if(b){t._setRawData(b.contents);if(b.bookmarks)t.getSelection().selectBookmarks(b.bookmarks);else if(x.ie){b=t.document.body.createTextRange();b.collapse(true);b.select()}this.index+=h;t.fire("afterRestore",{history:l,index:this.index});t.notifySelectionChange()}}});var o=A.TripleButton,q={redo:1,undo:-1};s.augment(i,{_init:function(){var h=this,l=h.editor;h.el=new o({contentCls:h.contentCls,title:h.title,
container:l.toolBarDiv});var t=h.el;t.set("state",o.DISABLED);l.on("afterSave afterRestore",h._respond,h);t.on("offClick",function(){l.fire("restore",{d:q[h.text]})})},_respond:function(h){this.updateUI(h.history,h.index)},updateUI:function(h,l){var t=this.el,b=this.text;if(b=="undo")l>0?t.set("state",o.OFF):t.set("state",o.DISABLED);else if(b=="redo")l<h.length-1?t.set("state",o.OFF):t.set("state",o.DISABLED)}});A.UndoManager=v;A.RestoreUI=i}();w.addPlugin(function(){new A.UndoManager(w);new A.RestoreUI(w,
"undo","\u64a4\u9500","ke-toolbar-undo");new A.RestoreUI(w,"redo","\u91cd\u505a","ke-toolbar-redo")})});
KISSY.Editor.add("bubbleview",function(){function w(i){w.superclass.constructor.apply(this,arguments);i.init&&i.init.call(this)}function s(i){i=v[i];if(!i.bubble)i.bubble=new w(i.cfg);return i.bubble}var A=KISSY.Editor,r=KISSY,x=r.Event,C=r.DOM,p=r.Node;if(!A.BubbleView){var v={};w.attach=function(i){var g=i.pluginInstance,k=i.pluginName;i=g.editor;var o=v[k];if(o){var q=o.cfg.func,h=v[k].bubble;i.on("selectionChange",function(l){l=l.path;var t=l.elements;if(l&&t)if(l=l.lastElement)if(l=q(l)){h=s(k);
h._selectedEl=l;h._plugin=g;h.show()}else if(h){h._selectedEl=h._plugin=null;h.hide()}});x.on(C._4e_getWin(i.document),"scroll blur",function(){h&&h.hide()});x.on(document,"click",function(){h&&h.hide()})}};w.register=function(i){v[i.pluginName]={cfg:i}};w.ATTRS={focusMgr:{value:false},draggable:{value:false}};r.extend(w,A.SimpleOverlay,{_createEl:function(){var i=(new p('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>')).appendTo(document.body);this.el=i;this.set("el",i)},show:function(){var i=
this._selectedEl,g=i._4e_getOffset(document);g.top+=i.height()+5;w.superclass.show.call(this,g)}});A.BubbleView=w}});
KISSY.Editor.add("button",function(){function w(x){w.superclass.constructor.call(this,x);this._init()}var s=KISSY.Editor,A=KISSY,r=A.Node;if(!s.TripleButton){w.ON="on";w.OFF="off";w.DISABLED="disabled";w.ON_CLASS="ke-triplebutton-on";w.OFF_CLASS="ke-triplebutton-off";w.DISABLED_CLASS="ke-triplebutton-disabled";w.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};A.extend(w,A.Base,{_init:function(){var x=this.get("container")[0]||this.get("container");this.el=new r("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));x.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var x=this.get("cls");x&&this.el.addClass(x)},_stateChange:function(x){this["_"+
x.newVal]();this._attachCls()},_action:function(x){this.fire(this.get("state")+"Click",x);this.fire("click",x);x.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});s.TripleButton=w}});
KISSY.Editor.add("contextmenu",function(){function w(g){this.cfg=r.clone(g);A.Utils.lazyRun(this,"_prepareShow","_realShow")}function s(g,k){for(var o=0;o<k.length;o++){var q=k[o];if(r.isFunction(q)){if(q(new x(g)))return true}else if(C.test(g,q))return true}return false}var A=KISSY.Editor,r=KISSY,x=r.Node,C=r.DOM,p=r.Event;if(!A.ContextMenu){var v=[];w.register=function(g,k){var o=new w(k);v.push({doc:g,rules:k.rules||[],instance:o});if(!g.ke_contextmenu){g.ke_contextmenu=1;p.on(g,"mousedown",w.hide);
p.on(g,"contextmenu",function(q){w.hide.call(this);for(var h=new x(q.target);h;){var l=false;if(h._4e_name()=="body")break;for(var t=0;t<v.length;t++){var b=v[t].instance,c=v[t].rules;if(g===v[t].doc&&s(h[0],c)){q.preventDefault();l=true;setTimeout(function(){b.show(A.Utils.getXY(q.pageX,q.pageY,g,document))},30);break}}if(l)break;h=h.parent()}})}return o};w.hide=function(){for(var g=0;g<v.length;g++){var k=v[g].instance;this===v[g].doc&&k.hide()}};var i=A.SimpleOverlay;r.augment(w,{_init:function(){var g=
this,k=g.cfg,o=k.funcs;g.elDom=new x("<div class='ke-menu' onmousedown='return false;'></div>");var q=g.elDom;q.css("width",k.width);document.body.appendChild(q[0]);g.el=new i({el:q});for(var h in o){k=new x("<a href='#'>"+h+"</a>");q[0].appendChild(k[0]);(function(l,t){l._4e_unselectable();l.on("click",function(b){g.hide();b.halt();setTimeout(t,30)})})(k,o[h])}},hide:function(){this.el&&this.el.hide()},_realShow:function(g){this.el.show(g)},_prepareShow:function(){this._init()},show:function(g){this._prepareShow(g)}});
A.ContextMenu=w}});
KISSY.Editor.add("dd",function(){function w(){w.superclass.constructor.apply(this,arguments);this._init()}function s(){s.superclass.constructor.apply(this,arguments);this._init()}function A(){A.superclass.constructor.apply(this,arguments)}var r=KISSY,x=r.Editor,C=r.Event,p=r.DOM,v=r.Node;if(!x.DD){x.DD={};w.ATTRS={timeThred:{},activeDrag:{},drags:{value:{}}};r.extend(w,r.Base,{_init:function(){x.Utils.lazyRun(this,"_prepare","_real")},reg:function(g){var k=this.get("drags");if(!g[0].id)g[0].id=r.guid("drag-");
k[g[0].id]=g;this._prepare()},_move:function(g){var k=this.get("activeDrag");k&&k._move(g)},_start:function(g){this.set("activeDrag",g);this._pg.css({display:"",height:p.docHeight()})},_end:function(g){var k=this.get("activeDrag");if(k){k._end(g);this.set("activeDrag",null);this._pg.css({display:"none"})}},_prepare:function(){this._pg=(new v("<div style='background-color:red;position:absolute;left:0;width:100%;top:0;z-index:9999;'></div>")).appendTo(document.body);this._pg.css("opacity",0);C.on(document,
"mousemove",x.Utils.throttle(this._move,this,10));C.on(document,"mouseup",this._end,this)},_real:function(){}});x.DD.DDM=new w;var i=x.DD.DDM;s.ATTRS={node:{},handlers:{value:{}}};r.extend(s,r.Base,{_init:function(){var g=this.get("node"),k=this.get("handlers");i.reg(g);if(r.isEmptyObject(k))k[g[0].id]=g;for(var o in k)if(k.hasOwnProperty(o)){var q=k[o],h=q.css("cursor");if(!h||h==="auto")q.css("cursor","move");q._4e_unselectable()}g.on("mousedown",this._handleMouseDown,this);g.on("mouseup",function(){i._end()})},
_check:function(g){var k=this.get("handlers");for(var o in k)if(k.hasOwnProperty(o))if(k[o]._4e_equals(g))return true;return false},_handleMouseDown:function(g){if(this._check(new v(g.target))){g.halt();i._start(this);var k=this.get("node"),o=g.pageX;g=g.pageY;k=k.offset();this.startMousePos={left:o,top:g};this.startNodePos=k;this._diff={left:o-k.left,top:g-k.top};this.fire("start")}},_move:function(g){this.fire("move",g)},_end:function(){}});r.extend(A,s,{_init:function(){A.superclass._init.apply(this,
arguments);var g=this.get("node"),k=this;k.on("move",function(o){g.offset({left:o.pageX-k._diff.left,top:o.pageY-k._diff.top})})}});x.Draggable=s;x.Drag=A}});
KISSY.Editor.add("overlay",function(){function w(){w.superclass.constructor.apply(this,arguments);this._init()}var s=KISSY.Editor,A=KISSY,r=A.UA,x=s.focusManager,C=A.Node,p=A.Event,v=A.DOM,i,g,k,o={left:"-9999px",top:"-9999px"};if(!s.SimpleOverlay){w.init=function(){var q=document.body,h={width:"100%",height:v.docHeight()+"px",opacity:0.4};A.mix(h,o);i=(new C('<div class="ke-mask">&nbsp;</div>')).appendTo(q);i.css(h);if(r.ie&&r.ie==6){k=(new C("<iframe class='ke-dialog-iframe'></iframe>")).appendTo(q);
g=(new C("<iframe class='ke-mask'></iframe>")).appendTo(q);A.all([g[0],k[0]]).css(h)}w.init=null};w.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false},draggable:{value:true}};A.extend(w,A.Base,{_init:function(){var q=this;q._createEl();var h=q.el;q.on("afterVisibleChange",function(l){if(l=l.newVal){typeof l=="boolean"?q.center():h.offset(l);q.fire("show")}else{h.css(o);q.fire("hide")}});if(q.get("focusMgr")){q._initFocusNotice();q.on("afterVisibleChange",
q._editorFocusMg,q)}q.on("afterVisibleChange",function(l){l.newVal?q._register():q._unregister()});if(r.ie===6){q.on("show",function(){var l=h.width(),t=h.height();k.css({width:l+"px",height:t+"px"});k.css(h.offset())});q.on("hide",function(){k.css(o)})}if(q.get("mask")){q.on("show",function(){A.all([i[0],g&&g[0]]).css({left:"0px",top:"0px"})});q.on("hide",function(){A.all([i[0],g&&g[0]]).css(o)})}},_register:function(){p.on(document,"keydown",this._keydown,this);i&&i.on("click",this.hide,this)},
_keydown:function(q){if(q.keyCode==27){this.hide();q.halt()}},_unregister:function(){p.remove(document,"keydown",this._keydown,this);i&&i.detach("click",this.hide,this)},_createEl:function(){var q=this,h=q.get("el");if(!h){h=(new C("<div class='ke-dialog' style='width:@width@'><div class='ke-hd'><span class='ke-hd-title'>@title@</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>".replace(/@width@/,q.get("width")).replace(/@title@/,
q.get("title")))).appendTo(document.body);var l=h.one(".ke-hd"),t=A.guid("ke-overlay-head-");q.body=h.one(".ke-bd");q.foot=h.one(".ke-ft");q._close=h.one(".ke-close");q._title=l.one("h1");q._close.on("click",function(b){b.preventDefault();q.hide()});if(q.get("draggable")){l[0].id=t;l=new s.Drag({node:h,handlers:{id:l}});r.ie===6&&l.on("move",function(){k.offset(h.offset())})}}q.set("el",h);q.el=h;h.css(o)},center:function(){var q=this.el,h=q.width(),l=q.height(),t=v.viewportWidth(),b=v.viewportHeight();
h=(t-h)/2+v.scrollLeft();l=(b-l)/2+v.scrollTop();if(l-v.scrollTop()>200)l-=150;q.css({left:h+"px",top:l+"px"})},_prepareShow:function(){w.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;return this._focusEl=(new C("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.el)},_initFocusNotice:function(){var q=this,h=q._getFocusEl();h.on("focus",function(){q.fire("focus")});h.on("blur",function(){q.fire("blur")})},
_editorFocusMg:function(q){var h=this._focusEditor;if(q.newVal){h=this._focusEditor=x.currentInstance();r.webkit||this._getFocusEl()[0].focus();var l=this.el.one("input");if(l)setTimeout(function(){try{l[0].focus();l[0].select()}catch(t){}},0);else if(r.ie&&h)if(q=h.document.selection.createRange())if(q.item&&q.item(0).ownerDocument==h.document){h=document.body.createTextRange();h.moveToElementText(this.el._4e_first()[0]);h.collapse(true);h.select()}}else h&&h.focus()},_realShow:function(q){this.set("visible",
q||true)},show:function(q){this._prepareShow(q)},hide:function(){this.set("visible",false)}});s.Utils.lazyRun(w.prototype,"_prepareShow","_realShow");s.SimpleOverlay=w}});
KISSY.Editor.add("select",function(){function w(p){w.superclass.constructor.call(this,p);this._init()}var s=KISSY,A=s.Node,r=s.Event,x=s.DOM,C=s.Editor;if(!C.Select){w.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};s.extend(w,s.Base,{_init:function(){var p=this.get("container"),v=new A("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a></span>"),i=this.get("title"),g=v.one(".ke-select-text");
v.one(".ke-select-drop");g.html(i);g.css("width",this.get("width"));v._4e_unselectable();v.attr("title",i);v.appendTo(p);v.on("click",this._click,this);this.el=v;this.title=g;this._focusA=v.one("a.ke-select");C.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(p){p=p.newVal;for(var v=this.get("title"),i=this.get("items"),g=0;g<i.length;g++){var k=i[g];if(k.value==p){v=k.name;break}}this.title.html(v)},_prepare:function(){var p=this.el,
v=this._focusA,i=new A("<div class='ke-menu' onmousedown='return false;'></div>"),g=new C.SimpleOverlay({el:i,focusMgr:false}),k=this.get("items");this.get("title")&&(new A("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+this.get("title")+"</div>")).appendTo(i);for(var o=0;o<k.length;o++){var q=k[o];q=new A("<a class='ke-select-menu-item' href='#' data-value='"+q.value+"'>"+q.name+"</a>",q.attrs);q._4e_unselectable();q.appendTo(i)}this.get("popUpWidth")&&i.css("width",
this.get("popUpWidth"));i.appendTo(document.body);this.menu=g;g.on("show",function(){v.addClass("ke-select-active")});g.on("hide",function(){v.removeClass("ke-select-active")});r.on([document,this.get("doc")],"click",function(l){p._4e_contains(l.target)||g.hide()});i.on("click",this._select,this);var h=this.as=i.all("a");r.on(i[0],"mouseenter",function(){h.removeClass("ke-menu-selected")})},_select:function(p){p.halt();var v=this.menu,i=v.el;if(p=(new A(p.target))._4e_ascendant(function(o){return i._4e_contains(o)&&
o._4e_name()=="a"},true)){var g=this.get("value"),k=p.attr("data-value");this.set("value",k);this.fire("click",{newVal:k,preVal:g,name:p.html()});v.hide()}},_real:function(){var p=this.el.offset();p.top+=this.el.height();p.left+=1;if(p.left+this.menu.el.width()>x.viewportWidth()-60)p.left=x.viewportWidth()-this.menu.el.width()-60;this.menu.show(p)},_click:function(p){p.preventDefault();var v=this.get("value");if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();v&&this.menu&&
this.as.each(function(i){i.attr("data-value")==v?i.addClass("ke-menu-selected"):i.removeClass("ke-menu-selected")})}}});C.Select=w}});
