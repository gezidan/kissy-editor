KISSY.add("editor",function(w,s){function z(t,b){var c=this;if(!(c instanceof z))return new z(t,b);if(w.isString(t))t=w.one(t);t[0]||(t=new Node(t));c.cfg=b||{pluginConfig:{}};w.app(c,w.EventTarget);c.use=function(e){if(w.isString(e))e=e.split(",");var f=e;e=[];e=w.indexOf("separator",f);var l=e!=-1;e=f.splice(0,l?e+1:f.length);l&&e.pop();e.length!=0?w.use.call(c,e.join(","),function(){l&&c.addPlugin(function(){z.Utils.addSeparator(c.toolBarDiv)});c.use(f)},{order:true,global:z}):c.on("dataReady",
function(){c.setData(t.val())});return c};c.init(t);return s}function r(t){if(!x)return t.replace(/\.(js|css)/i,"-min.$1");if(x==="dev")return"../src/"+t;return t}w.app(z,w.EventTarget);z.Config.base=w.Config.base+"editor/";var x=w.Config.debug,B={htmlparser:{attach:false,path:r("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},p=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],u=["clipboard",{name:"color"},{name:"elementpaths"},
"enterkey","fakeobjects",{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["contextmenu","fakeobjects","overlay"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize","music","preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",
{name:"resize",requires:["dd"]}],h=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],g=[{name:"button"},{name:"dd"},{name:"overlay",
requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}],i,j,q,n,m;i=0;for(j=g.length;i<j;i++){n=q=g[i];m=s;if(!w.isString(q)){m=q.requires;n=q.name}B[n]={attach:false,requires:m,path:r("ui/"+n+".js"),csspath:q.useCss?r("ui/"+n+".css"):""}}i=0;for(j=u.length;i<j;i++){n=q=u[i];m=["button"];if(!w.isString(q)){q.requires&&(m=m.concat(q.requires));n=q.name}B[n]={attach:false,requires:m,csspath:q.useCss?r("plugins/"+n+"/plugin.css"):
s,path:r("plugins/"+n+"/plugin.js")}}i=0;for(j=h.length;i<j;i++){q=h[i];m=s;if(!w.isString(q)){m=q.requires;q=q.name}B[q]={attach:false,requires:m,path:r("plugins/htmldataprocessor/htmlparser/"+q.substring(11)+".js")}}z.add(B);B={};i=0;for(j=p.length;i<j;i++){q=p[i];B[q]={host:"editor",requires:i>0?p[i-1]:[]}}z.add(B);w.Editor=z});
KISSY.Editor.add("utils",function(w){var s=KISSY,z=s.Node,r=s.DOM,x=s.Config.debug,B=s.UA;w.Utils={getFlashUrl:function(p){var u="",h=w.NODE;if(p._4e_name()=="object"){p=p[0].childNodes;for(var g=0;g<p.length;g++)if(p[g].nodeType==h.NODE_ELEMENT)if((r.attr(p[g],"name")||"").toLowerCase()=="movie")u=r.attr(p[g],"value");else if(r._4e_name(p[g])=="embed")u=r.attr(p[g],"src");else if(r._4e_name(p[g])=="object")u=r.attr(p[g],"data")}else if(p._4e_name()=="embed")u=p.attr("src");return u},debugUrl:function(p){if(!x)return p.replace(/\.(js|css)/i,
"-min.$1");if(x==="dev")return"../src/"+p;return p},lazyRun:function(p,u,h){var g=p[u],i=p[h];p[u]=function(){g.apply(this,arguments);p[u]=p[h];return i.apply(this,arguments)}},getXY:function(p,u,h,g){h=h.defaultView||h.parentWindow;p-=r.scrollLeft(h);u-=r.scrollTop(h);if(g)if(h!=(g.defaultView||g.parentWindow)&&h.frameElement){g=r._4e_getOffset(h.frameElement,g);p+=g.left;u+=g.top}return{left:p,top:u}},tryThese:function(){for(var p,u=0,h=arguments.length;u<h;u++){var g=arguments[u];try{p=g();break}catch(i){}}return p},
arrayCompare:function(p,u){if(!p&&!u)return true;if(!p||!u||p.length!=u.length)return false;for(var h=0;h<p.length;h++)if(p[h]!==u[h])return false;return true},getByAddress:function(p,u,h){p=p.documentElement;for(var g=0;p&&g<u.length;g++){var i=u[g];if(h)for(var j=-1,q=0;q<p.childNodes.length;q++){var n=p.childNodes[q];if(!(h===true&&n.nodeType==3&&n.previousSibling&&n.previousSibling.nodeType==3)){j++;if(j==i){p=n;break}}}else p=p.childNodes[i]}return p?new z(p):null},clearAllMarkers:function(p){for(var u in p)p[u]._4e_clearMarkers(p,
true)},htmlEncodeAttr:function(p){return p.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(p){return p.replace(/^\s+/,"")},rtrim:function(p){return p.replace(/\s+$/,"")},trim:function(p){return this.ltrim(this.rtrim(p))},mix:function(){for(var p={},u=0;u<arguments.length;u++)p=s.mix(p,arguments[u]);return p},isCustomDomain:function(){if(!B.ie)return false;var p=document.domain,u=window.location.hostname;return p!=u&&p!="["+u+"]"},addSeparator:function(p){(new s.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(p)},
duplicateStr:function(p,u){return(new Array(u+1)).join(p)},throttle:function(p,u,h){h=h||150;if(h===-1)return function(){p.apply(u,arguments)};var g=(new Date).getTime();return function(){var i=(new Date).getTime();if(i-g>h){g=i;p.apply(u,arguments)}}}}});
KISSY.Editor.add("focusmanager",function(w){function s(){this.iframeFocus=true;u=this}function z(){this.iframeFocus=false;u=null}var r=KISSY,x=r.DOM,B=r.Event;r={};var p={},u;r={refreshAll:function(){for(var h in p){var g=p[h];g.document.designMode="off";g.document.designMode="on"}},currentInstance:function(){return u},getInstance:function(h){return p[h]},add:function(h){var g=x._4e_getWin(h.document);B.on(g,"focus",s,h);B.on(g,"blur",z,h)},register:function(h){p[h._UUID]=h},remove:function(h){delete p[h._UUID];
var g=x._4e_getWin(h.document);B.remove(g,"focus",s,h);B.remove(g,"blur",z,h)}};w.focusManager=r});
KISSY.Editor.add("definition",function(w){function s(m){return g+"<html><head><title>kissy-editor</title><link href='"+w.Config.base+i+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(m?'<script id="ke_actscrpt" type="text/javascript">'+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+m+'");<\/script>':"")}var z=KISSY,r=z.UA,x=z.DOM,B=z.Node,p=z.Event,u=w.focusManager,h=w.Utils.tryThese,g="<!doctype html>",i=
w.Utils.debugUrl("theme/editor-iframe.css"),j=1,q="document.open();"+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",n="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(r.ie?"javascript:void(function(){"+encodeURIComponent(q)+"}())":"")+'"  tabIndex="'+
(r.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";z.augment(w,{init:function(m){var t=this,b=new B(n.replace(/\$\(tabIndex\)/,m.attr("tabIndex")));b.on("mousedown",function(f){if(r.webkit){var l=x._4e_name(f.target);if(l=="select"||l=="option")return true}f.halt()});t.editorWrap=b;t._UUID=j++;u.register(t);t.wrap=b.one(".ke-textarea-wrap");t.iframe=t.wrap.one("iframe");t.toolBarDiv=b.one(".ke-editor-tools");t.textarea=
m;t.statusDiv=b.one(".ke-editor-status");t.toolBarDiv._4e_unselectable();t._commands={};t._plugins={};var c=m._4e_style("width"),e=m._4e_style("height");if(c){b.css("width",c);m.css("width","100%")}t.textarea.css("display","none");b.insertAfter(m);t.wrap[0].appendChild(m[0]);if(e){t.wrap.css("height",e);m.css("height","100%")}m=t.iframe;t.on("dataReady",function(){t.ready=true;w.fire("instanceCreated",{editor:t})});r.gecko?m.on("load",t._setUpIFrame,t):t._setUpIFrame()},addCommand:function(m,t){this._commands[m]=
t},execCommand:function(m){this.fire("save");this._commands[m].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(m){if(this.htmlDataProcessor)m=this.htmlDataProcessor.toDataFormat(m,"p");this.document.body.innerHTML=m},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(m){this.document.body.innerHTML=
m},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");r.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:s,getSelection:function(){var m=new w.Selection(this.document);return!m||m.isInvalid?null:m},focus:function(){var m=x._4e_getWin(this.document);r.webkit&&m&&m.parent&&m.parent.focus();m&&m.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){x._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function m(){f=e.document;t.document=f;b.detach();f.open("text/html","replace");f.write(c);f.close()}
var t=this,b=t.iframe,c=s(t._UUID),e=b[0].contentWindow,f;try{f=e.document}catch(l){b[0].src=b[0].src;if(r.ie&&r.ie<7){setTimeout(m,10);return}}m()},addPlugin:function(m){this.ready?m():this.on("dataReady",m)},_monitor:function(){var m=this;m._monitorId&&clearTimeout(m._monitorId);m._monitorId=setTimeout(function(){var t=m.getSelection();if(t&&!t.isInvalid){t=t.getStartElement();var b=new w.ElementPath(t);if(!m.previousPath||!m.previousPath.compare(b)){m.previousPath=b;m.fire("selectionChange",{selection:m,
path:b,element:t})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(m,t){var b=this;b.focus();var c=m._4e_name(),e=w.XHTML_DTD,f=w.RANGE,l=w.NODE,k=e.$block[c],a=b.getSelection(),d=a.getRanges(),o,y,v,C,H;b.fire("save");for(var A=d.length-1;A>=0;A--){o=d[A];o.deleteContents();y=!A&&m||m._4e_clone(true);t&&t(y);if(k)for(;(C=o.getCommonAncestor(false,true))&&(H=e[C._4e_name()])&&!(H&&H[c]);)if(C._4e_name()in e.span)o.splitElement(C);else if(o.checkStartOfBlock()&&
o.checkEndOfBlock()){o.setStartBefore(C);o.collapse(true);C._4e_remove()}else o.splitBlock();o.insertNode(y);v||(v=y)}m=v._4e_nextSourceNode(true);t=b.document;H=w.XHTML_DTD;if(H.$inline[y._4e_name()]){m=new B(t.createTextNode(" "));m.insertAfter(v)}else if(m){if(m._4e_name()=="br"&&H[m.parent()._4e_name()].p){H=new B("<p>&nbsp;</p>",null,t);m[0].parentNode.replaceChild(H[0],m[0]);m=H}}else{H=new B("<p>&nbsp;</p>",null,t);H.insertAfter(v);m=H}o.moveToPosition(v,f.POSITION_AFTER_END);m&&m[0].nodeType==
l.NODE_ELEMENT&&o.moveToElementEditablePosition(m);a.selectRanges([o]);b.focus();y&&y._4e_scrollIntoView();setTimeout(function(){b.fire("save")},10);return y},insertHtml:function(m){var t=this;if(t.htmlDataProcessor)m=t.htmlDataProcessor.toDataFormat(m);if(r.webkit){m=x.create(m,null,this.document);m=m.nodeType==11?z.makeArray(m.childNodes):[m];for(var b=0;b<m.length;b++)t.insertElement(new B(m[b]))}else{t.focus();t.fire("save");b=t.getSelection();if(r.ie){b=b.getNative();b.type=="Control"&&b.clear();
b.createRange().pasteHTML(m)}else t.document.execCommand("inserthtml",false,m);t.focus();setTimeout(function(){t.fire("save")},10)}}});w._initIFrame=function(m){function t(v){h(function(){e.designMode="on";setTimeout(function(){e.designMode="off";l.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){e.designMode="off";x.attr(l,"contentEditable",false);x.attr(l,"contentEditable",true);!v&&t(1)})}var b=u.getInstance(m);m=b.textarea[0];var c=b.iframe[0].contentWindow,e=b.document,
f=e.getElementById("ke_actscrpt");f.parentNode.removeChild(f);var l=e.body;if(r.ie){l.hideFocus=true;l.disabled=true;l.contentEditable=true;l.removeAttribute("disabled")}else setTimeout(function(){if(r.gecko||r.opera)l.contentEditable=true;else if(r.webkit)l.parentNode.contentEditable=true;else e.designMode="on"},0);try{e.execCommand("enableObjectResizing",false,true)}catch(k){}try{e.execCommand("enableInlineTableEditing",false,true)}catch(a){}r.webkit&&p.on(e,"mousedown",function(v){v=new B(v.target);
z.inArray(v._4e_name(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(v)});if(r.webkit){p.on(e,"click",function(v){var C=new B(v.target);z.inArray(C._4e_name(),["input","select"])&&v.preventDefault()});p.on(e,"mouseup",function(v){var C=new B(v.target);z.inArray(C._4e_name(),["input","textarea"])&&v.preventDefault()})}if(r.gecko||r.ie||r.opera){var d;d=new B(x.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],m));d.on("focus",function(){b.focus()});
b.on("destroy",function(){})}if(r.ie&&e.compatMode=="CSS1Compat"||r.gecko||r.opera){var o=new B(e.documentElement);o.on("mousedown",function(v){if(v.target===o[0]){r.gecko&&t(false);d[0].focus()}})}p.on(c,"focus",function(){if(r.gecko)t(false);else r.opera&&l.focus();b.notifySelectionChange()});r.gecko&&p.on(b.document,"mousedown",function(){b.iframeFocus||t(false)});if(r.ie){p.on(e,"keydown",function(v){if(v.keyCode in{8:1,46:1}){var C=b.getSelection(),H=C.getSelectedElement();if(H){b.fire("save");
var A=C.getRanges()[0].createBookmark();H._4e_remove();C.selectBookmarks([A]);b.fire("save");v.preventDefault()}}});if(e.compatMode=="CSS1Compat"){var y={33:1,34:1};p.on(e,"keydown",function(v){v.keyCode in y&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}}setTimeout(function(){r.ie&&setTimeout(function(){if(e){l.runtimeStyle.marginBottom="0px";l.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.fire("dataReady")},10);u.add(b)};r.gecko&&function(){var m=document.body;
if(m){var t=m.getAttribute("onpageshow");m.setAttribute("onpageshow",(t?t+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(w){w.XHTML_DTD=function(){var s=function(k){for(var a=arguments.length-1;a>0;)KISSY.mix(k,arguments[a--]);return k},z={isindex:1,fieldset:1},r={input:1,button:1,select:1,textarea:1,label:1},x=s({a:1},r),B=s({iframe:1},x),p={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},u={ins:1,del:1,script:1,style:1},h=s({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},u),g=s({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},h),i=s({p:1},g);r=s({iframe:1},g,r);g={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var j=s({a:1},r),q={tr:1},n={"#":1},m=s({param:1},g),t=s({form:1},z,B,p,i),b={li:1},c={base:1,link:1,meta:1,title:1},e=s(c,{style:1,script:1}),f={head:1,body:1},l={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:s({html:1},f,c),$block:l,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:j,$body:s({script:1,style:1},l),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:f,head:e,style:n,body:t,base:{},link:{},meta:{},title:n,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:t,td:t,br:{},th:t,center:t,kbd:j,button:s(i,p),basefont:{},h5:j,h4:j,samp:j,h6:j,ol:b,h1:j,h3:j,option:n,h2:j,form:s(z,B,p,i),select:{optgroup:1,option:1},font:j,ins:j,menu:b,abbr:j,label:j,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:j,script:n,tfoot:q,cite:j,li:t,input:{},iframe:t,strong:j,textarea:n,noframes:t,big:j,small:j,span:j,hr:{},dt:j,sub:j,optgroup:{option:1},param:{},bdo:j,"var":j,div:t,object:m,sup:j,dd:t,strike:j,area:{},dir:b,map:s({area:1,form:1,p:1},z,u,p),applet:m,dl:{dt:1,dd:1},del:j,isindex:{},fieldset:s({legend:1},g),thead:q,ul:b,acronym:j,b:j,a:r,blockquote:t,caption:j,i:j,u:j,tbody:q,s:j,address:s(B,i),tt:j,legend:j,q:j,pre:s(h,x),p:j,em:j,dfn:j}}()});
KISSY.Editor.add("dom",function(w){function s(b){return b.replace(/-(\w)/g,function(c,e){return e.toUpperCase()})}var z=KISSY,r=z.DOM,x=z.UA,B=z.Node,p=w.Utils,u={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};w.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};w.POSITION={};var h=w.NODE,g=w.POSITION;g.POSITION_IDENTICAL=0;g.POSITION_DISCONNECTED=
1;g.POSITION_FOLLOWING=2;g.POSITION_PRECEDING=4;g.POSITION_IS_CONTAINED=8;g.POSITION_CONTAINS=16;var i={},j={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},q={hr:1},n=function(b){return b[0]||b},m=function(b){if(!b[0])return new B(b);return b},t={_4e_equals:function(b,c){if(!b&&!c)return true;if(!b||!c)return false;b=n(b);c=n(c);return b===c},_4e_isBlockBoundary:function(b,
c){b=m(b);c=z.mix(z.mix({},q),c||{});return j[b.css("display")]||c[b._4e_name()]},_4e_getWin:function(b){return b&&"scrollTo"in b&&b.document?b:b&&b.nodeType===9?b.defaultView||b.parentWindow:false},_4e_index:function(b){b=n(b);for(var c=b.parentNode.childNodes,e=0;e<c.length;e++)if(c[e]===b)return e;return-1},_4e_first:function(b,c){b=n(b);if((b=(b=b.firstChild)&&new B(b))&&c&&!c(b))b=b._4e_next(c);return b},_4e_move:function(b,c,e){b._4e_remove();b=n(b);c=n(c);e?c.insertBefore(b,c.firstChild):c.appendChild(b)},
_4e_name:function(b){b=n(b);var c=b.nodeName.toLowerCase();if(x.ie)if((b=b.scopeName)&&b!="HTML")c=b.toLowerCase()+":"+c;return c},_4e_isIdentical:function(b,c){if(b._4e_name()!=c._4e_name())return false;var e=b[0].attributes,f=c[0].attributes,l=e.length,k=f.length;if(!x.ie&&l!=k)return false;for(var a=0;a<l;a++){var d=e[a];if((!x.ie||d.specified&&d.nodeName!="_ke_expando")&&d.nodeValue!=c.attr(d.nodeName))return false}if(x.ie)for(a=0;a<k;a++){d=f[a];if(d.specified&&d.nodeName!="_ke_expando"&&d.nodeValue!=
b.attr(d.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(b){b=n(b).childNodes;for(var c=0,e=b.length;c<e;c++){var f=b[c],l=f.nodeType;if(!(l==h.NODE_ELEMENT&&f.getAttribute("_ke_bookmark")))if(l==h.NODE_ELEMENT&&!t._4e_isEmptyInlineRemoveable(f)||l==h.NODE_TEXT&&z.trim(f.nodeValue))return false}return true},_4e_moveChildren:function(b,c,e){b=n(b);c=c[0]||c;if(b!=c)if(e)for(;e=b.lastChild;)c.insertBefore(b.removeChild(e),c.firstChild);else for(;e=b.firstChild;)c.appendChild(b.removeChild(e))},
_4e_mergeSiblings:function(){function b(c,e,f){if(e[0]&&e[0].nodeType==h.NODE_ELEMENT){for(var l=[];e.attr("_ke_bookmark")||e._4e_isEmptyInlineRemoveable();){l.push(e);e=f?new B(e[0].nextSibling):new B(e[0].previousSibling);if(!e[0]||e[0].nodeType!=h.NODE_ELEMENT)return}if(c._4e_isIdentical(e)){for(var k=f?c[0].lastChild:c[0].firstChild;l.length;)l.shift()._4e_move(c,!f);e._4e_moveChildren(c,!f);e._4e_remove();k[0]&&k[0].nodeType==h.NODE_ELEMENT&&k._4e_mergeSiblings()}}}return function(c){if(c[0])if(u[c._4e_name()]||
c._4e_name()=="a"){b(c,new B(c[0].nextSibling),true);b(c,new B(c[0].previousSibling))}}}(),_4e_unselectable:x.gecko?function(b){b=n(b);b.style.MozUserSelect="none"}:x.webkit?function(b){b=n(b);b.style.KhtmlUserSelect="none"}:function(b){b=n(b);if(x.ie||x.opera){var c,e=0;for(b.unselectable="on";c=b.all[e++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(b,c){b=n(b);var e,f=0;e=0;var l=b.ownerDocument.defaultView||
b.ownerDocument.parentWindow,k=b.ownerDocument,a=k.documentElement;c=c||k;if(b.getBoundingClientRect){if(b!==k.body&&a!==b){e=b.getBoundingClientRect();f=e.left+(c===k?r.scrollLeft(l):0);e=e.top+(c===k?r.scrollTop(l):0)}if(c)if(l!=(c.defaultView||c.parentWindow)&&l.frameElement){c=t._4e_getOffset(l.frameElement,c);f+=c.left;e+=c.top}}return{left:f,top:e}},_4e_getFrameDocument:function(b){return(b=n(b))&&b.contentWindow.document},_4e_splitText:function(b,c){b=n(b);var e=b.ownerDocument;if(!(!b||b.nodeType!=
h.NODE_TEXT)){if(x.ie&&c==b.nodeValue.length){e=e.createTextNode("");r.insertAfter(e,b);return e}b=new B(b.splitText(c));if(x.ie==8){e=e.createTextNode("");r.insertAfter(e,b[0]);e.parentNode.removeChild(e)}return b}},_4e_parents:function(b,c){b=m(b);var e=[];do e[c?"push":"unshift"](b);while(b=b.parent());return e},_4e_clone:function(b,c,e){b=n(b);b=b.cloneNode(c);if(!e){var f=function(l){if(l.nodeType==h.NODE_ELEMENT){l.removeAttribute("id",false);l.removeAttribute("_ke_expando",false);l=l.childNodes;
for(var k=0;k<l.length;k++)f(l[k])}};f(b)}return new B(b)},_4e_nextSourceNode:function(b,c,e,f){b=n(b);if(f&&!f.call){var l=f[0]||f;f=function(a){a=a[0]||a;return a!==l}}c=!c&&b.firstChild;var k=new B(b);if(!c){if(b.nodeType==h.NODE_ELEMENT&&f&&f(this,true)===false)return null;c=b.nextSibling}for(;!c&&(k=k.parent());){if(f&&f(k,true)===false)return null;c=k[0].nextSibling}if(!c)return null;c=new B(c);if(f&&f(c)===false)return null;if(e&&e!=c[0].nodeType)return c._4e_nextSourceNode(false,e,f);return c},
_4e_previousSourceNode:function(b,c,e,f){b=n(b);if(f&&!f.call){var l=f[0]||f;f=function(a){a=a[0]||a;return a!==l}}c=!c&&b.lastChild;var k=new B(b);if(!c){if(b.nodeType==h.NODE_ELEMENT&&f&&f(b,true)===false)return null;c=b.previousSibling}for(;!c&&(k=k.parent());){if(f&&f(k,true)===false)return null;c=k[0].previousSibling}if(!c)return null;c=new B(c);if(f&&f(c)===false)return null;if(e&&c[0].nodeType!=e)return c._4e_previousSourceNode(false,e,f);return c},_4e_contains:x.ie||x.webkit?function(b,c){b=
n(b);c=n(c);return c.nodeType!=h.NODE_ELEMENT?b.contains(c.parentNode):b!=c&&b.contains(c)}:function(b,c){b=n(b);c=n(c);return!!(b.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(b,c){if(b._4e_equals(c))return b;if(c[0].nodeType!=h.NODE_TEXT&&c._4e_contains(b))return c;b=b[0].nodeType==h.NODE_TEXT?b.parent():b;do if(b[0].nodeType!=h.NODE_TEXT&&b._4e_contains(c))return b;while(b=b.parent());return null},_4e_ascendant:function(b,c,e){b=n(b);if(!e)b=b.parentNode;if(c&&!z.isFunction(c)){var f=
c;c=function(l){return l._4e_name()==f}}for(;b&&b.nodeType!=9;){if(!c||c(new B(b))===true)return new B(b);b=b.parentNode}return null},_4e_hasAttribute:function(b,c){b=n(b);b=b.attributes.getNamedItem(c);return!!(b&&b.specified)},_4e_hasAttributes:x.ie?function(b){b=n(b);for(var c=b.attributes,e=0;e<c.length;e++){var f=c[e];switch(f.nodeName){case "class":if(b.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(f.specified)return true}}return false}:function(b){b=n(b);x.gecko&&
b.removeAttribute("_moz_dirty");b=b.attributes;return b.length>1||b.length==1&&b[0].nodeName!="_ke_expando"},_4e_position:function(b,c){var e=n(b),f=n(c);if(e.compareDocumentPosition)return e.compareDocumentPosition(f);if(e==f)return g.POSITION_IDENTICAL;if(e.nodeType==h.NODE_ELEMENT&&f.nodeType==h.NODE_ELEMENT){if(e.contains){if(e.contains(f))return g.POSITION_CONTAINS+g.POSITION_PRECEDING;if(f.contains(e))return g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING}if("sourceIndex"in e)return e.sourceIndex<
0||f.sourceIndex<0?g.POSITION_DISCONNECTED:e.sourceIndex<f.sourceIndex?g.POSITION_PRECEDING:g.POSITION_FOLLOWING}b=b._4e_address();c=c._4e_address();e=Math.min(b.length,c.length);for(f=0;f<=e-1;f++)if(b[f]!=c[f]){if(f<e)return b[f]<c[f]?g.POSITION_PRECEDING:g.POSITION_FOLLOWING;break}return b.length<c.length?g.POSITION_CONTAINS+g.POSITION_PRECEDING:g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING},_4e_address:function(b,c){b=n(b);var e=[],f=b.ownerDocument.documentElement;for(b=b;b&&b!=f;){var l=b.parentNode,
k=-1;if(l){for(var a=0;a<l.childNodes.length;a++){var d=l.childNodes[a];if(!(c&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){k++;if(d==b)break}}e.unshift(k)}b=l}return e},_4e_breakParent:function(b,c){var e=new w.Range(b[0].ownerDocument);e.setStartAfter(b);e.setEndAfter(c);c=e.extractContents();e.insertNode(b._4e_remove());b[0].parentNode.insertBefore(c,b[0].nextSibling)},_4e_style:function(b,c,e){if(e!==undefined)return b.css(c,e);b=b[0]||b;return b.style[s(c)]},_4e_remove:function(b,
c){var e=n(b),f=e.parentNode;if(f){if(c)for(;c=e.firstChild;)f.insertBefore(e.removeChild(c),e);f.removeChild(e)}return b},_4e_trim:function(b){r._4e_ltrim(b);r._4e_rtrim(b)},_4e_ltrim:function(b){b=n(b);for(var c;c=b.firstChild;){if(c.nodeType==h.NODE_TEXT){var e=p.ltrim(c.nodeValue),f=c.nodeValue.length;if(e){if(e.length<f){(new B(c))._4e_splitText(f-e.length);b.removeChild(b.firstChild)}}else{b.removeChild(c);continue}}break}},_4e_rtrim:function(b){b=n(b);for(var c;c=b.lastChild;){if(c.type==h.NODE_TEXT){var e=
p.rtrim(c.nodeValue),f=c.nodeValue.length;if(e){if(e.length<f){(new B(c))._4e_splitText(e.length);b.removeChild(b.lastChild)}}else{b.removeChild(c);continue}}break}if(!x.ie&&!x.opera)(c=b.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(b){b=n(b);for(var c=b.lastChild;c&&c.nodeType==h.NODE_TEXT&&!z.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==h.NODE_TEXT||r._4e_name(c)!=="br"){c=x.opera?b.ownerDocument.createTextNode(""):
b.ownerDocument.createElement("br");x.gecko&&c.setAttribute("type","_moz");b.appendChild(c)}},_4e_previous:function(b,c){b=n(b);var e;do e=(b=b.previousSibling)&&new B(b);while(e&&c&&!c(e));return e},_4e_last:function(b,c){if((b=(b=b[0].lastChild)&&new B(b))&&c&&!c(b))b=b._4e_previous(c);return b},_4e_next:function(b,c){b=n(b);var e;do e=(b=b.nextSibling)&&new B(b);while(e&&c&&!c(e));return e},_4e_outerHtml:function(b){b=n(b);if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var c=b.ownerDocument.createElement("div");
c.appendChild(b.cloneNode(true));return c.innerHTML},_4e_setMarker:function(b,c,e,f){b[0]||(b=new B(b));var l=b._4e_getData("list_marker_id")||b._4e_setData("list_marker_id",z.guid())._4e_getData("list_marker_id"),k=b._4e_getData("list_marker_names")||b._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[l]=b;k[e]=1;return b._4e_setData(e,f)},_4e_clearMarkers:function(b,c,e){b=m(b);var f=b._4e_getData("list_marker_names"),l=b._4e_getData("list_marker_id");for(var k in f)b._4e_removeData(k);
b._4e_removeData("list_marker_names");if(e){b._4e_removeData("list_marker_id");delete c[l]}},_4e_setData:function(b,c,e){var f=r._4e_getUniqueId(b);(i[f]||(i[f]={}))[c]=e;return b},_4e_getData:function(b,c){b=n(b);return(b=(b=b.getAttribute("_ke_expando"))&&i[b])&&b[c]},_4e_removeData:function(b,c){b=n(b);var e=b.getAttribute("_ke_expando");var f=(e=e&&i[e])&&e[c];typeof f!="undefined"&&e&&delete e[c];z.isEmptyObject(e)&&r._4e_clearData(b);return f||null},_4e_clearData:function(b){b=n(b);var c=b.getAttribute("_ke_expando");
c&&delete i[c];c&&b.removeAttribute("_ke_expando")},_4e_getUniqueId:function(b){b=n(b);var c=b.getAttribute("_ke_expando");if(c)return c;c=z.guid();b.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(b,c,e){b=n(b);var f=b.attributes;e=e||{};for(var l=0;l<f.length;l++){var k=f[l],a=k.nodeName.toLowerCase(),d;if(!(a in e))if(a=="checked"&&(d=r.attr(b,a)))c.attr(a,d);else if(k.specified||x.ie&&k.nodeValue&&a=="value"){d=r.attr(b,a);if(d===null)d=k.nodeValue;c.attr(a,d)}}if(b.style.cssText!==
"")c[0].style.cssText=b.style.cssText},_4e_isEditable:function(b){b=r._4e_name(b);var c=w.XHTML_DTD;return(b=!c.$nonEditable[b]&&(c[b]||c.span))&&b["#"]},_4e_scrollIntoView:function(b){b=m(b);var c=b[0].ownerDocument,e=r.scrollLeft(c),f=r.scrollTop(c),l=b.offset(),k=l.left;l=l.top;if(r.viewportHeight(c)+f<l||l<f||r.viewportWidth(c)+e<k||k<e)b.scrollIntoView(c)},_4e_getElementsByTagName:function(b,c,e){b=n(b);if(!x.ie&&e)c=e+":"+c;e=[];b=b.getElementsByTagName(c);for(c=0;c<b.length;c++)e.push(new B(b[c]));
return e}};z.DOM._4e_inject=function(b){z.mix(r,b);for(var c in b)b.hasOwnProperty(c)&&function(e){B.prototype[e]=function(){var f=[].slice.call(arguments,0);f.unshift(this);return b[e].apply(null,f)}}(c)};z.DOM._4e_inject(t)});
KISSY.Editor.add("elementpath",function(w){function s(i){var j=null,q=null,n=[];for(i=i;i&&i[0];){if(i[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=i;var m=i._4e_name();if(p.ie&&i[0].scopeName!="HTML")m=i[0].scopeName.toLowerCase()+":"+m;if(!q){if(!j&&u[m])j=i;if(h[m])if(!j&&m=="div"&&!g(i))j=i;else q=i}n.push(i);if(m=="body")break}i=i.parent()}this.block=j;this.blockLimit=q;this.elements=n}var z=KISSY,r=z.DOM,x=w.XHTML_DTD,B=w.NODE,p=z.UA,u={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},h={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},g=function(i){i=i[0]||i;i=i.childNodes;for(var j=0,q=i.length;j<q;j++){var n=i[j];if(n.nodeType==B.NODE_ELEMENT&&x.$block[n.nodeName.toLowerCase()])return true}return false};s.prototype={compare:function(i){var j=this.elements;i=i&&i.elements;if(!i||j.length!=i.length)return false;for(var q=0;q<j.length;q++)if(!r._4e_equals(j[q],i[q]))return false;return true},contains:function(i){for(var j=
this.elements,q=0;q<j.length;q++)if(j[q]._4e_name()in i)return j[q];return null}};w.ElementPath=s});
KISSY.Editor.add("walker",function(w){function s(h,g){if(this._.end)return null;var i=this.range,j,q=this.guard,n=this.type,m=h?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;i.trim();if(i.collapsed){this.end();return null}}if(!h&&!this._.guardLTR){var t=i.endContainer,b=new u(t[0].childNodes[i.endOffset]);this._.guardLTR=function(l,k){return(!k||!p._4e_equals(t,l))&&(!b[0]||l[0]!==b[0])&&(l[0].nodeType!=B.NODE_ELEMENT||!k||l._4e_name()!="body")}}if(h&&!this._.guardRTL){var c=
i.startContainer,e=i.startOffset>0&&new u(c[0].childNodes[i.startOffset-1]);this._.guardRTL=function(l,k){return l&&l[0]&&(!k||c[0]!==l[0])&&(!e[0]||l[0]!==e[0])&&(l[0].nodeType!=B.NODE_ELEMENT||!k||l._4e_name()!="body")}}var f=h?this._.guardRTL:this._.guardLTR;j=q?function(l,k){if(f(l,k)===false)return false;return q(l,k)}:f;if(this.current)h=this.current[m](false,n,j);else if(h){h=i.endContainer;if(i.endOffset>0){h=new u(h[0].childNodes[i.endOffset-1]);if(j(h)===false)h=null}else h=j(h,true)===
false?null:h._4e_previousSourceNode(true,n,j)}else{h=i.startContainer;if((h=new u(h[0].childNodes[i.startOffset]))&&h[0]){if(j(h)===false)h=null}else h=j(i.startContainer,true)===false?null:i.startContainer._4e_nextSourceNode(true,n,j)}for(;h&&h[0]&&!this._.end;){this.current=h;if(!this.evaluator||this.evaluator(h)!==false){if(!g)return h}else if(g&&this.evaluator)return false;h=h[m](false,n,j)}this.end();return this.current=null}function z(h){for(var g,i=null;g=s.call(this,h);)i=g;return i}function r(h){this.range=
h;this._={}}var x=KISSY,B=w.NODE,p=x.DOM,u=x.Node;x.augment(r,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,true)},checkForward:function(){return s.call(this,false,true)!==false},checkBackward:function(){return s.call(this,true,true)!==false},lastForward:function(){return z.call(this)},lastBackward:function(){return z.call(this,true)},reset:function(){delete this.current;this._={}}});r.blockBoundary=function(h){return function(g){g[0]||(g=
new u(g));return!(g[0].nodeType==B.NODE_ELEMENT&&g._4e_isBlockBoundary(h))}};r.listItemBoundary=function(){return this.blockBoundary({br:1})};r.bookmark=function(h,g){function i(j){return j&&j[0]&&j._4e_name()=="span"&&j.attr("_ke_bookmark")}return function(j){var q,n;q=j&&j[0]&&j[0].nodeType==B.NODE_TEXT&&(n=j.parent())&&i(n);q=h?q:q||i(j);return g^q}};r.whitespaces=function(h){return function(g){g=(g=g[0]||g)&&g.nodeType==B.NODE_TEXT&&!x.trim(g.nodeValue);return h^g}};r.invisible=function(h){var g=
r.whitespaces();return function(i){i=g(i)||i[0].nodeType==B.NODE_ELEMENT&&!i[0].offsetHeight;return h^i}};w.Walker=r});
KISSY.Editor.add("range",function(w){function s(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=a}function z(a){var d=a[0].nodeType!=h.NODE_TEXT&&a._4e_name()in t.$removeEmpty,o=!u.trim(a[0].nodeValue);a=!!a.parent().attr("_ke_bookmark");return d||o||a}function r(a){return!l(a)&&!k(a)}function x(a){var d=false,o=j.bookmark(true);return function(y){if(o(y))return true;if(y[0].nodeType==h.NODE_TEXT){if(u.trim(y[0].nodeValue).length)return false}else if(y[0].nodeType==
h.NODE_ELEMENT)if(!f[y._4e_name()])if(!a&&!m.ie&&y._4e_name()=="br"&&!d)d=true;else return false;return true}}function B(a,d){function o(y){return y&&y.nodeName=="span"&&y.getAttribute("_ke_bookmark")}return function(y){var v,C;v=y&&!y.nodeName&&(C=y.parentNode)&&o(C);v=a?v:v||o(y);return d^v}}function p(a){return function(d){d=(d=d[0]||d)&&d.nodeType==h.NODE_TEXT&&!u.trim(d.nodeValue);return a^d}}w.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var u=KISSY,h=w.NODE,g=w.RANGE,i=w.POSITION,j=w.Walker,q=u.DOM,n=w.Utils.getByAddress,m=u.UA,t=w.XHTML_DTD,b=w.ElementPath,c=u.Node,e={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};s.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};u.augment(s,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&q._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,d=this.startOffset;if(a[0].nodeType!=h.NODE_ELEMENT)if(d)d>=a[0].nodeValue.length&&this.setStartAfter(a);else this.setStartBefore(a);a=this.endContainer;d=this.endOffset;if(a[0].nodeType!=h.NODE_ELEMENT)if(d)d>=a[0].nodeValue.length&&
this.setEndAfter(a);else this.setEndBefore(a)},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,d=this.endContainer;a&&a._4e_name()=="span"&&a.attr("_ke_bookmark")&&this.setStartAt(a,g.POSITION_BEFORE_START);d&&d._4e_name()=="span"&&
d.attr("_ke_bookmark")&&this.setEndAt(d,g.POSITION_AFTER_END)},setStart:function(a,d){if(a[0].nodeType==h.NODE_ELEMENT&&e[a._4e_name()]){a=a.parent();d=a._4e_index()}this.startContainer=a;this.startOffset=d;if(!this.endContainer){this.endContainer=a;this.endOffset=d}this.updateCollapsed()},setEnd:function(a,d){if(a[0].nodeType==h.NODE_ELEMENT&&e[a._4e_name()]){a=a.parent();d=a._4e_index()+1}this.endContainer=a;this.endOffset=d;if(!this.startContainer){this.startContainer=a;this.startOffset=d}this.updateCollapsed()},
setStartAt:function(a,d){switch(d){case g.POSITION_AFTER_START:this.setStart(a,0);break;case g.POSITION_BEFORE_END:a[0].nodeType==h.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setStartBefore(a);break;case g.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,d){switch(d){case g.POSITION_AFTER_START:this.setEnd(a,0);break;case g.POSITION_BEFORE_END:a[0].nodeType==h.NODE_TEXT?this.setEnd(a,
a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setEndBefore(a);break;case g.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},execContentsAction:function(a,d){var o=this.startContainer,y=this.endContainer,v=this.startOffset,C=this.endOffset,H,A;this.optimizeBookmark();if(y[0].nodeType==h.NODE_TEXT)y=y._4e_splitText(C);else if(y[0].childNodes.length>0)if(C>=y[0].childNodes.length){y=new c(y[0].appendChild(this.document.createTextNode("")));
A=true}else y=new c(y[0].childNodes[C]);if(o[0].nodeType==h.NODE_TEXT){o._4e_splitText(v);if(q._4e_equals(o,y))y=new c(o[0].nextSibling)}else if(v)if(v>=o[0].childNodes.length){H=new c(this.document.createTextNode(""));o[0].appendChild(H[0]);o=H;H=true}else o=new c(o[0].childNodes[v].previousSibling);else{H=new c(this.document.createTextNode(""));q.insertBefore(H[0],o[0].firstChild);o=H;H=true}v=o._4e_parents();C=y._4e_parents();var D,I,J;for(D=0;D<v.length;D++){I=v[D];J=C[D];if(I[0]!==J[0])break}for(var N=
d,M,Q,R,W=D;W<v.length;W++){M=v[W];if(N&&M[0]!==o[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(C[W]&&M==C[W][0]||M==y[0])break;R=M.nextSibling;if(a==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);a==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=d;for(d=D;d<C.length;d++){M=C[d];if(a>0&&M[0]!==y[0])Q=N.appendChild(M._4e_clone()[0]);if(!v[d]||M[0].parentNode!==v[d][0].parentNode)for(M=M[0].previousSibling;M;){if(v[d]&&M==v[d][0]||M===o[0])break;R=M.previousSibling;if(a==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);a==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(a==2){J=this.startContainer[0];if(J.nodeType==h.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==h.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==h.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==h.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(I&&J&&(o[0].parentNode!=
I[0].parentNode||y[0].parentNode!=J[0].parentNode)){a=J._4e_index();H&&J[0].parentNode==o[0].parentNode&&a--;this.setStart(J.parent(),a)}this.collapse(true)}H&&o._4e_remove();A&&y[0].parentNode&&y._4e_remove()},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var a=new s(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;
a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=h.NODE_ELEMENT||a.endContainer[0].nodeType!=h.NODE_ELEMENT)return null;a=a.startContainer[0].childNodes[a.startOffset];for(var d=B(true,undefined),o=p(true),y=function(v){return o(v)&&d(v)};a&&y(a);)a=(new c(a))._4e_nextSourceNode()[0];return new c(a)},shrink:function(a,d){if(!this.collapsed){a=a||g.SHRINK_TEXT;
var o=this.clone(),y=this.startContainer,v=this.endContainer,C=this.startOffset,H=this.endOffset,A=1,D=1;if(y&&y[0].nodeType==h.NODE_TEXT)if(C)if(C>=y[0].nodeValue.length)o.setStartAfter(y);else{o.setStartBefore(y);A=0}else o.setStartBefore(y);if(v&&v[0].nodeType==h.NODE_TEXT)if(H)if(H>=v[0].nodeValue.length)o.setEndAfter(v);else{o.setEndAfter(v);D=0}else o.setEndBefore(v);o=new j(o);o.evaluator=function(J){J=J[0]||J;return J.nodeType==(a==g.SHRINK_ELEMENT?h.NODE_ELEMENT:h.NODE_TEXT)};var I;o.guard=
function(J,N){J=J[0]||J;if(a==g.SHRINK_ELEMENT&&J.nodeType==h.NODE_TEXT)return false;if(N&&J==I)return false;if(!N&&J.nodeType==h.NODE_ELEMENT)I=J;return true};if(A)(y=o[a==g.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(y,d?g.POSITION_AFTER_START:g.POSITION_BEFORE_START);if(D){o.reset();(o=o[a==g.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(o,d?g.POSITION_BEFORE_END:g.POSITION_AFTER_END)}return!!(A||D)}},getTouchedStartNode:function(){var a=this.startContainer;if(this.collapsed||
a[0].nodeType!=h.NODE_ELEMENT)return a;return a.childNodes[this.startOffset]||a},createBookmark2:function(a){var d=this.startContainer,o=this.endContainer,y=this.startOffset,v=this.endOffset,C,H;if(!d||!o)return{start:0,end:0};if(a){if(d[0].nodeType==h.NODE_ELEMENT)if((C=new c(d[0].childNodes[y]))&&C[0]&&C[0].nodeType==h.NODE_TEXT&&y>0&&C[0].previousSibling.nodeType==h.NODE_TEXT){d=C;y=0}for(;d[0].nodeType==h.NODE_TEXT&&(H=d._4e_previous())&&H[0].nodeType==h.NODE_TEXT;){d=H;y+=H[0].nodeValue.length}if(!this.collapsed){if(o[0].nodeType==
h.NODE_ELEMENT)if((C=new c(o[0].childNodes[v]))&&C[0]&&C[0].nodeType==h.NODE_TEXT&&v>0&&C[0].previousSibling.nodeType==h.NODE_TEXT){o=C;v=0}for(;o[0].nodeType==h.NODE_TEXT&&(H=o._4e_previous())&&H[0].nodeType==h.NODE_TEXT;){o=H;v+=H[0].nodeValue.length}}}return{start:d._4e_address(a),end:this.collapsed?null:o._4e_address(a),startOffset:y,endOffset:v,normalized:a,is2:true}},createBookmark:function(a){var d,o,y,v;d=new c("<span></span>",null,this.document);d.attr("_ke_bookmark",1);d.css("display","none");
d.html("&nbsp;");if(a){y=u.guid("ke_bm_");d.attr("id",y+"S")}if(!this.collapsed){o=d._4e_clone();o.html("&nbsp;");a&&o.attr("id",y+"E");v=this.clone();v.collapse();v.insertNode(o)}v=this.clone();v.collapse(true);v.insertNode(d);if(o){this.setStartAfter(d);this.setEndBefore(o)}else this.moveToPosition(d,g.POSITION_AFTER_END);return{startNode:a?y+"S":d,endNode:a?y+"E":o,serializable:a}},moveToPosition:function(a,d){this.setStartAt(a,d);this.collapse(true)},trim:function(a,d){var o=this.startContainer,
y=this.startOffset,v=this.collapsed;if((!a||v)&&o[0]&&o[0].nodeType==h.NODE_TEXT){if(y)if(y>=o[0].nodeValue.length){y=o._4e_index()+1;o=o.parent()}else{a=o._4e_splitText(y);y=o._4e_index()+1;o=o.parent();if(q._4e_equals(this.startContainer,this.endContainer))this.setEnd(a,this.endOffset-this.startOffset);else if(q._4e_equals(o,this.endContainer))this.endOffset+=1}else{y=o._4e_index();o=o.parent()}this.setStart(o,y);if(v){this.collapse(true);return}}o=this.endContainer;y=this.endOffset;if(!(d||v)&&
o[0]&&o[0].nodeType==h.NODE_TEXT){if(y){y>=o.nodeValue.length||o._4e_splitText(y);y=o._4e_index()+1}else y=o._4e_index();o=o.parent();this.setEnd(o,y)}},insertNode:function(a){this.optimizeBookmark();this.trim(false,true);var d=this.startContainer,o=d[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);o?q.insertBefore(a[0]||a,o):d[0].appendChild(a[0]||a);q._4e_equals(a.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){if(a.is2){var d=
n(this.document,a.start,a.normalized),o=a.startOffset,y=a.end&&n(this.document,a.end,a.normalized);a=a.endOffset;this.setStart(d,o);y?this.setEnd(y,a):this.collapse(true)}else{d=(o=a.serializable)?u.one("#"+a.startNode,this.document):a.startNode;a=o?u.one("#"+a.endNode,this.document):a.endNode;this.setStartBefore(d);d._4e_remove();if(a&&a[0]){this.setEndBefore(a);a._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(a,d){var o=this.startContainer,y=this.endContainer;a=q._4e_equals(o,
y)?a&&o[0].nodeType==h.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(o[0].childNodes[this.startOffset]):o:o._4e_commonAncestor(y);return d&&a[0].nodeType==h.NODE_TEXT?a.parent():a},enlarge:function(a){switch(a){case g.ENLARGE_ELEMENT:if(this.collapsed)return;a=this.getCommonAncestor();var d=new c(this.document.body),o,y,v,C,H,A=false,D,I;D=this.startContainer;I=this.startOffset;if(D[0].nodeType==h.NODE_TEXT){if(I){D=!u.trim(D[0].nodeValue.substring(0,I)).length&&D;A=!!D}if(D)if(!(C=D[0].previousSibling))v=
D.parent()}else{if(I)C=D[0].childNodes[I-1]||D[0].lastChild;C||(v=D)}for(;v||C;){if(v&&!C){if(!H&&q._4e_equals(v,a))H=true;if(!d._4e_contains(v))break;if(!A||v.css("display")!="inline"){A=false;if(H)o=v;else this.setStartBefore(v)}C=v[0].previousSibling}for(;C;){D=false;if(C.nodeType==h.NODE_TEXT){I=C.nodeValue;if(/[^\s\ufeff]/.test(I))C=null;D=/[\s\ufeff]$/.test(I)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(A&&t.$removeEmpty[C.nodeName.toLowerCase()]){I=q.text(C);if(/[^\s\ufeff]/.test(I))C=
null;else for(var J=C.all||C.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!t.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}if(C)D=!!I.length}else C=null;if(D)if(A)if(H)o=v;else v&&this.setStartBefore(v);else A=true;if(C){D=C.previousSibling;if(!v&&!D){v=new c(C);C=null;break}C=D}else v=null}if(v)v=v.parent()}D=this.endContainer;I=this.endOffset;v=C=null;H=A=false;if(D[0].nodeType==h.NODE_TEXT){D=!u.trim(D[0].nodeValue.substring(I)).length&&D;A=!(D&&D[0].nodeValue.length);if(D)if(!(C=D[0].nextSibling))v=
D.parent()}else(C=D[0].childNodes[I])||(v=D);for(;v||C;){if(v&&!C){if(!H&&q._4e_equals(v,a))H=true;if(!d._4e_contains(v))break;if(!A||v.css("display")!="inline"){A=false;if(H)y=v;else v&&this.setEndAfter(v)}C=v[0].nextSibling}for(;C;){D=false;if(C.nodeType==h.NODE_TEXT){I=C.nodeValue;if(/[^\s\ufeff]/.test(I))C=null;D=/^[\s\ufeff]/.test(I)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(A&&t.$removeEmpty[C.nodeName.toLowerCase()]){I=q.text(C);if(/[^\s\ufeff]/.test(I))C=null;else{J=C.all||
C.getElementsByTagName("*");for(N=0;M=J[N++];)if(!t.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}}if(C)D=!!I.length}else C=null;if(D)if(A)if(H)y=v;else this.setEndAfter(v);if(C){D=C.nextSibling;if(!v&&!D){v=new c(C);C=null;break}C=D}else v=null}if(v)v=v.parent()}if(o&&y){a=o._4e_contains(y)?y:o;this.setStartBefore(a);this.setEndAfter(a)}break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:v=new s(this.document);d=new c(this.document.body);v.setStartAt(d,g.POSITION_AFTER_START);
v.setEnd(this.startContainer,this.startOffset);v=new j(v);var Q,R,W=j.blockBoundary(a==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};o=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};v.guard=$;v=v.lastBackward();Q=Q||d;this.setStartAt(Q,Q._4e_name()!="br"&&(!v&&this.checkStartOfBlock()||v&&Q._4e_contains(v))?g.POSITION_AFTER_START:g.POSITION_AFTER_END);v=this.clone();v.collapse();v.setEndAt(d,g.POSITION_BEFORE_END);v=new j(v);v.guard=
a==g.ENLARGE_LIST_ITEM_CONTENTS?o:$;Q=null;v=v.lastForward();Q=Q||d;this.setEndAt(Q,!v&&this.checkEndOfBlock()||v&&Q._4e_contains(v)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var a=this.startContainer,d=this.startOffset;if(d&&a[0].nodeType==h.NODE_TEXT)if(u.trim(a[0].nodeValue.substring(0,d)).length)return false;this.trim();a=new b(this.startContainer);d=this.clone();d.collapse(true);d.setStartAt(a.block||a.blockLimit,g.POSITION_AFTER_START);
a=new j(d);a.evaluator=x(true);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,d=this.endOffset;if(a[0].nodeType==h.NODE_TEXT)if(u.trim(a[0].nodeValue.substring(d)).length)return false;this.trim();a=new b(this.endContainer);d=this.clone();d.collapse(false);d.setEndAt(a.block||a.blockLimit,g.POSITION_BEFORE_END);a=new j(d);a.evaluator=x(false);return a.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,d){var o=this.clone();o[d==g.START?"setStartAt":"setEndAt"](a,d==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);a=new j(o);a.evaluator=z;return a[d==g.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,d=this.endContainer,o=this.startOffset,y=this.endOffset,v;if(a[0].nodeType==h.NODE_ELEMENT){v=a[0].childNodes.length;if(v>
o)a=new c(a[0].childNodes[o]);else if(v<1)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new c(a);a=a._4e_nextSourceNode()||a}}if(d[0].nodeType==h.NODE_ELEMENT){v=d[0].childNodes.length;if(v>y)d=(new c(d[0].childNodes[y]))._4e_previousSourceNode(true);else if(v<1)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=new c(d)}}if(a._4e_position(d)&i.POSITION_FOLLOWING)a=d;return{startNode:a,endNode:d}},fixBlock:function(a,d){var o=this.createBookmark();
d=new c(this.document.createElement(d));this.collapse(a);this.enlarge(g.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();m.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(o);return d},splitBlock:function(a){var d=new b(this.startContainer),o=new b(this.endContainer),y=d.block,v=o.block,C=null;if(d.blockLimit[0]!==o.blockLimit[0])return null;if(a!="br"){if(!y){y=this.fixBlock(true,a);v=(new b(this.endContainer)).block}v||(v=this.fixBlock(false,a))}a=y&&this.checkStartOfBlock();
d=v&&this.checkEndOfBlock();this.deleteContents();if(y&&q._4e_equals(y,v))if(d){C=new b(this.startContainer);this.moveToPosition(v,g.POSITION_AFTER_END);v=null}else if(a){C=new b(this.startContainer);this.moveToPosition(y,g.POSITION_BEFORE_START);y=null}else{v=this.splitElement(y);!m.ie&&!u.inArray(y._4e_name(),["ul","ol"])&&y._4e_appendBogus()}return{previousBlock:y,nextBlock:v,wasStartOfBlock:a,wasEndOfBlock:d,elementPath:C}},splitElement:function(a){if(!this.collapsed)return null;this.setEndAt(a,
g.POSITION_BEFORE_END);var d=this.extractContents(),o=a._4e_clone(false);o[0].appendChild(d);o.insertAfter(a);this.moveToPosition(a,g.POSITION_AFTER_END);return o},moveToElementEditablePosition:function(a,d){var o,y=w.XHTML_DTD;if(y.$empty[a._4e_name()])return false;for(;a&&a[0].nodeType==h.NODE_ELEMENT;){if(o=a._4e_isEditable())this.moveToPosition(a,d?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(y.$inline[a._4e_name()]){this.moveToPosition(a,d?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);
return true}if((a=y.$empty[a._4e_name()]?a[d?"_4e_previous":"_4e_next"](r):a[d?"_4e_last":"_4e_first"](r))&&a[0].nodeType==h.NODE_TEXT){this.moveToPosition(a,d?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return true}}return o},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==h.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var f={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},l=new j.whitespaces,k=new j.bookmark;w.Range=s});
KISSY.Editor.add("domiterator",function(w){function s(n){if(!(arguments.length<1)){this.range=n;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var z=KISSY,r=z.UA,x=w.Walker,B=w.Range,p=w.RANGE,u=w.NODE,h=w.ElementPath,g=z.Node,i=z.DOM,j=/^[\r\n\t ]*$/,q=x.bookmark();z.augment(s,{getNextParagraph:function(n){var m,t,b,c,e;if(!this._.lastNode){t=this.range.clone();t.enlarge(this.forceBrBreak||!this.enlargeBr?p.ENLARGE_LIST_ITEM_CONTENTS:p.ENLARGE_BLOCK_CONTENTS);
var f=new x(t),l=x.bookmark(true,true);f.evaluator=l;this._.nextNode=f.next();f=new x(t);f.evaluator=l;f=f.previous();this._.lastNode=f._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==u.NODE_TEXT&&!z.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){l=new B(t.document);l.moveToPosition(this._.lastNode,p.POSITION_AFTER_END);if(l.checkEndOfBlock()){l=new h(l.endContainer);this._.lastNode=(l.block||l.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new g(t.document.createTextNode(""));i.insertAfter(this._.lastNode[0],f[0])}t=null}l=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;l;){var k=false,a=l[0].nodeType!=u.NODE_ELEMENT,d=false;if(a){if(l[0].nodeType==u.NODE_TEXT)if(j.test(l[0].nodeValue))a=false}else{var o=l._4e_name();if(l._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(o=="br")a=true;else if(!t&&!l[0].childNodes.length&&o!="hr"){m=l;b=l._4e_equals(f);break}if(t){t.setEndAt(l,p.POSITION_BEFORE_START);
if(o!="br")this._.nextNode=l}k=true}else{if(l[0].firstChild){if(!t){t=new B(this.range.document);t.setStartAt(l,p.POSITION_BEFORE_START)}l=new g(l[0].firstChild);continue}a=true}}if(a&&!t){t=new B(this.range.document);t.setStartAt(l,p.POSITION_BEFORE_START)}b=(!k||a)&&l._4e_equals(f);if(t&&!k)for(;!l[0].nextSibling&&!b;){o=l.parent();if(o._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){k=true;b||o._4e_equals(f);break}l=o;a=true;b=l._4e_equals(f);d=true}a&&t.setEndAt(l,p.POSITION_AFTER_END);l=l._4e_nextSourceNode(d,
null,f);b=!l;if((k||b)&&t){a=t.getBoundaryNodes();k=new h(t.startContainer);if(a.startNode.parent()._4e_equals(k.blockLimit)&&q(a.startNode)&&q(a.endNode)){t=null;this._.nextNode=null}else break}if(b)break}if(!m){if(!t){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}k=new h(t.startContainer);l=k.blockLimit;a={div:1,th:1,td:1};m=k.block;if((!m||!m[0])&&!this.enforceRealBlocks&&a[l._4e_name()]&&t.checkStartOfBlock()&&t.checkEndOfBlock())m=l;else if(!m||this.enforceRealBlocks&&
m._4e_name()=="li"){m=new g(this.range.document.createElement(n||"p"));m[0].appendChild(t.extractContents());m._4e_trim();t.insertNode(m);c=e=true}else if(m._4e_name()!="li"){if(!t.checkStartOfBlock()||!t.checkEndOfBlock()){m=m._4e_clone(false);m[0].appendChild(t.extractContents());m._4e_trim();e=t.splitBlock();c=!e.wasStartOfBlock;e=!e.wasEndOfBlock;t.insertNode(m)}}else if(!b)this._.nextNode=m._4e_equals(f)?null:t.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,f)}if(c){t=new g(m[0].previousSibling);
if(t[0]&&t[0].nodeType==u.NODE_ELEMENT)if(t._4e_name()=="br")t._4e_remove();else t[0].lastChild&&t[0].lastChild.nodeName.toLowerCase()=="br"&&i._4e_remove(t[0].lastChild)}if(e){t=x.bookmark(false,true);c=new g(m[0].lastChild);if(c[0]&&c[0].nodeType==u.NODE_ELEMENT&&c._4e_name()=="br")if(r.ie||c._4e_previous(t)||c._4e_next(t))c._4e_remove()}if(!this._.nextNode)this._.nextNode=b||m._4e_equals(f)?null:m._4e_nextSourceNode(true,null,f);return m}});B.prototype.createIterator=function(){return new s(this)}});
KISSY.Editor.add("selection",function(w){function s(f){this.document=f;this._={cache:{}};if(B.ie){var l=this.getNative().createRange();if(!l||l.item&&l.item(0).ownerDocument!=f||l.parentElement&&l.parentElement().ownerDocument!=f)this.isInvalid=true}}function z(f){f=new s(f);return!f||f.isInvalid?null:f}function r(f){var l=f.document,k=new g(l.body),a=new g(l.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)a.on("click",function(C){p._4e_name(C.target)==="html"&&f.getSelection().getRanges()[0].select()});
var d,o;k.on("focusin",function(C){if(C.target.nodeName.toUpperCase()=="BODY")if(d){try{d.select()}catch(H){}d=null}});k.on("focus",function(){o=true;v()});k.on("beforedeactivate",function(C){C.relatedTarget||(o=false)});B.ie<8&&u.on(p._4e_getWin(l),"blur",function(){l.selection.empty()});k.on("mousedown",y);k.on("mouseup",function(){o=true;setTimeout(function(){v(true)},0)});k.on("keydown",y);k.on("keyup",function(){o=true;v()});u.on(l,"selectionchange",v);var y=function(){o=false},v=function(C){if(o){var H=
f.document,A=f.getSelection(),D=A&&A.getNative();if(C&&D&&D.type=="None")if(!H.queryCommandEnabled("InsertImage")){setTimeout(function(){v(true)},50);return}var I;if(!(D&&D.type=="Text"&&(I=D.createRange().parentElement().nodeName.toLowerCase())&&I in{input:1,textarea:1})){d=D&&A.getRanges()[0];f._monitor()}}}}else{u.on(l,"mouseup",f._monitor,f);u.on(l,"keyup",f._monitor,f)}}w.SELECTION={};var x=KISSY,B=x.UA,p=x.DOM,u=x.Event,h=w.Utils.tryThese,g=x.Node,i=w.SELECTION,j=w.RANGE,q=w.NODE,n=w.Walker,
m=w.Range;i.SELECTION_NONE=1;i.SELECTION_TEXT=2;i.SELECTION_ELEMENT=3;var t={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};x.augment(s,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=p._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var f=this._.cache;if(f.type)return f.type;
var l=i.SELECTION_NONE;try{var k=this.getNative(),a=k.type;if(a=="Text")l=i.SELECTION_TEXT;if(a=="Control")l=i.SELECTION_ELEMENT;if(k.createRange().parentElement)l=i.SELECTION_TEXT}catch(d){}return f.type=l}:function(){var f=this._.cache;if(f.type)return f.type;var l=i.SELECTION_TEXT,k=this.getNative();if(k){if(k.rangeCount==1){k=k.getRangeAt(0);var a=k.startContainer;if(a==k.endContainer&&a.nodeType==q.NODE_ELEMENT&&k.endOffset-k.startOffset===1&&t[a.childNodes[k.startOffset].nodeName.toLowerCase()])l=
i.SELECTION_ELEMENT}}else l=i.SELECTION_NONE;return f.type=l},getRanges:B.ie?function(){var f=function(l,k){l=l.duplicate();l.collapse(k);k=l.parentElement();for(var a=k.childNodes,d,o=0;o<a.length;o++){var y=a[o];if(y.nodeType==q.NODE_ELEMENT){d=l.duplicate();d.moveToElementText(y);y=d.compareEndPoints("StartToStart",l);var v=d.compareEndPoints("EndToStart",l);d.collapse();if(y>0)break;else if(!y||v==1&&y==-1)return{container:k,offset:o};else if(!v)return{container:k,offset:o+1};d=null}}if(!d){d=
l.duplicate();d.moveToElementText(k);d.collapse(false)}d.setEndPoint("StartToStart",l);l=d.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;l>0;)l-=a[--o].nodeValue.length}catch(C){l=0}return l===0?{container:k,offset:o}:{container:a[o],offset:-l}};return function(){var l=this._.cache;if(l.ranges)return l.ranges;var k=this.getNative(),a=k&&k.createRange(),d=this.getType();if(!k)return[];if(d==i.SELECTION_TEXT){k=new m(this.document);d=f(a,true);k.setStart(new g(d.container),d.offset);d=f(a);k.setEnd(new g(d.container),
d.offset);return l.ranges=[k]}else if(d==i.SELECTION_ELEMENT){l=this._.cache.ranges=[];for(d=0;d<a.length;d++){var o=a.item(d),y=o.parentNode,v=0;for(k=new m(this.document);v<y.childNodes.length&&y.childNodes[v]!=o;v++);k.setStart(new g(y),v);k.setEnd(new g(y),v+1);l.push(k)}return l}return l.ranges=[]}}():function(){var f=this._.cache;if(f.ranges)return f.ranges;var l=[],k=this.getNative();if(!k)return[];for(var a=0;a<k.rangeCount;a++){var d=k.getRangeAt(a),o=new m(this.document);o.setStart(new g(d.startContainer),
d.startOffset);o.setEnd(new g(d.endContainer),d.endOffset);l.push(o)}return f.ranges=l},getStartElement:function(){var f=this._.cache;if(f.startElement!==undefined)return f.startElement;var l,k=this.getNative();switch(this.getType()){case i.SELECTION_ELEMENT:return this.getSelectedElement();case i.SELECTION_TEXT:var a=this.getRanges()[0];if(a)if(!a.collapsed){for(a.optimize();;){l=a.startContainer;if(a.startOffset==(l[0].nodeType===q.NODE_ELEMENT?l[0].childNodes.length:l[0].nodeValue.length)&&!l._4e_isBlockBoundary())a.setStartAfter(l);
else break}l=a.startContainer;if(l[0].nodeType!=q.NODE_ELEMENT)return l.parent();l=new g(l[0].childNodes[a.startOffset]);if(!l[0]||l[0].nodeType!=q.NODE_ELEMENT)return a.startContainer;for(a=l[0].firstChild;a&&a.nodeType==q.NODE_ELEMENT;){l=new g(a);a=a.firstChild}return l}if(B.ie){a=k.createRange();a.collapse(true);l=a.parentElement()}else if((l=k.anchorNode)&&l.nodeType!=q.NODE_ELEMENT)l=l.parentNode}return f.startElement=l?new g(l):null},getSelectedElement:function(){var f=this._.cache;if(f.selectedElement!==
undefined)return f.selectedElement;var l=this,k=h(function(){return l.getNative().createRange().item(0)},function(){for(var a=l.getRanges()[0],d,o,y=2;y&&!((d=a.getEnclosedNode())&&d[0].nodeType==q.NODE_ELEMENT&&t[d._4e_name()]&&(o=d));y--)a.shrink(j.SHRINK_ELEMENT);return o[0]});return f.selectedElement=k?new g(k):null},reset:function(){this._.cache={}},selectElement:function(f){var l;if(B.ie)try{l=this.document.body.createControlRange();l.addElement(f[0]);l.select()}catch(k){l=this.document.body.createTextRange();
l.moveToElementText(f[0]);l.select()}finally{}else{l=this.document.createRange();l.selectNode(f[0]);f=this.getNative();f.removeAllRanges();f.addRange(l)}this.reset()},selectRanges:function(f){if(B.ie)f[0]&&f[0].select();else{var l=this.getNative();if(!l)return;l.removeAllRanges();for(var k=0;k<f.length;k++){var a=f[k],d=this.document.createRange(),o=a.startContainer;a.collapsed&&B.gecko&&B.gecko<1.09&&o[0].nodeType==q.NODE_ELEMENT&&!o[0].childNodes.length&&o[0].appendChild(this.document.createTextNode(""));
d.setStart(o[0],a.startOffset);d.setEnd(a.endContainer[0],a.endOffset);l.addRange(d)}}this.reset()},createBookmarks2:function(f){for(var l=[],k=this.getRanges(),a=0;a<k.length;a++)l.push(k[a].createBookmark2(f));return l},createBookmarks:function(f){for(var l=[],k=this.getRanges(),a=k.length,d=this.document,o,y=0;y<a;y++){l.push(o=k[y].createBookmark(f,true));var v=(f=o.serializable)?x.one("#"+o.startNode,d):o.startNode;o=f?x.one("#"+o.endNode,d):o.endNode;for(var C=y+1;C<a;C++){var H=k[C],A=H.startContainer,
D=H.endContainer;p._4e_equals(A,v.parent())&&H.startOffset++;p._4e_equals(A,o.parent())&&H.startOffset++;p._4e_equals(D,v.parent())&&H.endOffset++;p._4e_equals(D,o.parent())&&H.endOffset++}}return l},selectBookmarks:function(f){for(var l=[],k=0;k<f.length;k++){var a=new m(this.document);a.moveToBookmark(f[k]);l.push(a)}this.selectRanges(l);return this},getCommonAncestor:function(){var f=this.getRanges();return f[0].startContainer._4e_commonAncestor(f[f.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
w.Selection=s;var b={table:1,tbody:1,tr:1},c=n.whitespaces(true),e=/\ufeff|\u00a0/;m.prototype.select=B.ie?function(f){var l=this.collapsed,k,a;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var d=this.startContainer[0].childNodes[this.startOffset];if(d.nodeType==q.NODE_ELEMENT){(new s(this.document)).selectElement(new g(d));return}}if(this.startContainer[0].nodeType==q.NODE_ELEMENT&&this.startContainer._4e_name()in b||this.endContainer[0].nodeType==q.NODE_ELEMENT&&
this.endContainer._4e_name()in b)this.shrink(q.NODE_ELEMENT,true);var o=this.createBookmark();d=o.startNode;var y;if(!l)y=o.endNode;o=this.document.body.createTextRange();o.moveToElementText(d[0]);o.moveStart("character",1);if(y){f=this.document.body.createTextRange();f.moveToElementText(y[0]);o.setEndPoint("EndToEnd",f);o.moveEnd("character",-1)}else{for(k=d[0].nextSibling;k&&!c(k);)k=k.nextSibling;k=!(k&&k.nodeValue&&k.nodeValue.match(e))&&(f||!d[0].previousSibling||d[0].previousSibling&&p._4e_name(d[0].previousSibling)==
"br");a=this.document.createElement("span");a.innerHTML="&#65279;";a=new g(a);p.insertBefore(a[0],d[0]);k&&p.insertBefore(this.document.createTextNode("\ufeff"),d[0])}this.setStartBefore(d);d._4e_remove();if(l){if(k){o.moveStart("character",-1);o.select();this.document.selection.clear()}else o.select();if(a){this.moveToPosition(a,j.POSITION_BEFORE_START);a._4e_remove()}}else{this.setEndBefore(y);y._4e_remove();o.select()}}:function(){var f=this.startContainer;this.collapsed&&f[0].nodeType==q.NODE_ELEMENT&&
!f[0].childNodes.length&&f[0].appendChild(this.document.createTextNode(""));var l=this.document.createRange();l.setStart(f[0],this.startOffset);try{l.setEnd(this.endContainer[0],this.endOffset)}catch(k){if(k.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);l.setEnd(this.endContainer[0],this.endOffset)}else throw k;}f=z(this.document).getNative();f.removeAllRanges();f.addRange(l)};w.on("instanceCreated",function(f){r(f.editor)})});
KISSY.Editor.add("styles",function(w){function s(E,F){for(var G in E)E[G]=E[G].replace(aa,function(L,K){return F[K]})}function z(E,F){if(F){E=y.clone(E);s(E.attributes,F);s(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?C.STYLE_BLOCK:W[F]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:E}}function r(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new A(E);for(var G=E.getRanges(),L=0;L<G.length;L++)F.call(this,G[L]);E.selectRanges(G)}function x(E,
F){var G=E.element;if(G=="*")G="span";F=new N(F.createElement(G));return B(F,E)}function B(E,F){var G=F._.definition;F=G.attributes;G=z.getStyleText(G);if(F)for(var L in F)E.attr(L,F[L]);if(G)E[0].style.cssText=G;return E}function p(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var L,K=E.document;L=G.getNextParagraph();){var O=x(this,K);i(L,O)}E.moveToBookmark(F)}function u(E,F,G){var L="",K="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(L=P);S&&(K=S);return""});return L+E.replace(F,G)+K}function h(E,F){var G=E.html();G=u(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(G);return F}function g(E){var F=[];u(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,L,K){return L+"</pre>"+K+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,L){F.push(L)});return F}function i(E,F){var G=F._4e_name=="pre",L=E._4e_name=="pre",K=!G&&L;if(G&&!L)F=h(E,F);else if(K)F=q(g(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&j(F)}function j(E){var F;if((F=E._4e_previousSourceNode(true,D.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=u(F.html(),/\n$/,"")+"\n\n"+u(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function q(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),L=0;L<E.length;L++){var K=E[L];K=K.replace(/(\r\n|\r)/g,"\n");K=u(K,/^[ \t]*\n/,"");K=u(K,/\n$/,"");K=u(K,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});K=K.replace(/\n/g,"<br>");K=K.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(K);G.appendChild(O[0])}return G}
function n(E){var F=E.document;if(E.collapsed){F=x(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,L=this._.definition,K,O=w.XHTML_DTD[G]||(K=true,w.XHTML_DTD.span),P=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(v._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==D.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((w.XHTML_DTD[ca._4e_name()]||w.XHTML_DTD.span)[G]||K)&&(!L.parentRule||L.parentRule(ca))){if(!X&&(!ba||!w.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+
I.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==D.NODE_TEXT||V==D.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|I.POSITION_FOLLOWING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_FOLLOWING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=x(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==G){for(var Z in L.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in L.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());a(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(H.SHRINK_TEXT)}}function m(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var L=new Q(G.parent()),K,O=0,P;O<L.elements.length&&(P=L.elements[O]);O++){if(P==L.block||P==L.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,H.END),da=!S&&E.checkBoundaryOfElement(P,H.START);if(da||S){K=P;K.match=da?"start":"end"}else{P._4e_mergeSiblings();P._4e_name()==this.element?l(this,P):d(P,f(this)[P._4e_name()])}}}if(K&&K[0]){P=G;for(O=0;;O++){S=L.elements[O];if(v._4e_equals(S,K))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(P[0]);P=S}v[K.match=="start"?"insertBefore":"insertAfter"](P[0],K[0])}}else{var U=F.endNode,X=this;L=function(){for(var T=new Q(G.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
L();for(K=new N(G[0].nextSibling);K[0]!==U[0];){O=K._4e_nextSourceNode();if(K[0]&&K[0].nodeType==D.NODE_ELEMENT&&this.checkElementRemovable(K)){K._4e_name()==this.element?l(this,K):d(K,f(this)[K._4e_name()]);if(O[0].nodeType==D.NODE_ELEMENT&&O._4e_contains(G)){L();O=new N(G[0].nextSibling)}}K=O}}E.moveToBookmark(F)}function t(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,L,K){F[L]=K});return F}function b(E,F){typeof E=="string"&&(E=t(E));typeof F==
"string"&&(F=t(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function c(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function e(E){var F=E._AC;if(F)return F;F={};var G=0,L=E.attributes;if(L)for(var K in L){G++;F[K]=L[K]}if(L=z.getStyleText(E)){F.style||G++;F.style=L}F._length=G;return E._AC=
F}function f(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){y.isArray(G)||(G=[G]);for(var L=0;L<G.length;L++){var K=G[L],O,P;if(typeof K=="string")O=K.toLowerCase();else{O=K.element?K.element.toLowerCase():E.element;P=K.attributes}K=F[O]||(F[O]={});if(P){K=K.attributes=K.attributes||[];for(var S in P)K.push([S.toLowerCase(),P[S]])}}}return F}function l(E,F){var G=E._.definition,L=y.mix(y.mix({},G.attributes),f(E)[F._4e_name()]);G=G.styles;var K=y.isEmptyObject(L)&&
y.isEmptyObject(G);for(var O in L)if(!((O=="class"||E._.definition.fullMatch)&&F.attr(O)!=k(O,L[O]))){K=K||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in G)if(!(E._.definition.fullMatch&&F._4e_style(P)!=k(P,G[P],true))){K=K||!!F._4e_style(P);F._4e_style(P,"")}K&&o(F)}function k(E,F,G){var L=new N("<span></span>");L[G?"_4e_style":"attr"](E,F);return L[G?"_4e_style":"attr"](E)}function a(E,F){for(var G=f(E),L=F.all(E.element),K=L.length;--K>=0;)l(E,new N(L[K]));for(var O in G)if(O!=E.element){L=
F.all(O);for(K=L.length-1;K>=0;K--){var P=new N(L[K]);d(P,G[O])}}}function d(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var L=F[G][0],K;if(K=E.attr(L)){var O=F[G][1];if(O===null||O.test&&O.test(K)||typeof O=="string"&&K==O)E[0].removeAttribute(L)}}o(E)}function o(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==D.NODE_ELEMENT&&v._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==D.NODE_ELEMENT&&v._4e_mergeSiblings(G)}}}var y=KISSY,v=y.DOM,
C=w.STYLE={},H=w.RANGE,A=w.Selection,D=w.NODE,I=w.POSITION,J=w.Range,N=y.Node,M=y.UA,Q=w.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;C.STYLE_BLOCK=1;C.STYLE_INLINE=2;C.STYLE_OBJECT=3;z.prototype={apply:function(E){r.call(this,E,false)},remove:function(E){r.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==C.STYLE_INLINE?
n:this.type==C.STYLE_BLOCK?p:this.type==C.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==C.STYLE_INLINE?m:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=e(G);if(G._length){for(var L in G)if(L!="_length"){var K=E.attr(L)||"";if(L=="style"?b(G[L],c(K,false)):G[L]==K){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
f(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){L=G[F][0];if(L=E.attr(L)){K=G[F][1];if(K===null||typeof K=="string"&&L==K||K.test&&K.test(L))return true}}}return false},checkActive:function(E){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var F=E.elements,G=0,L;G<F.length;G++){L=F[G];if(!(this.type==C.STYLE_INLINE&&(v._4e_equals(L,E.block)||v._4e_equals(L,E.blockLimit))))if(!(this.type==
C.STYLE_OBJECT&&!(L._4e_name()in W)))if(this.checkElementRemovable(L,true))return true}}return false}};z.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",L="";if(G.length)G=G.replace($,";");for(var K in F){var O=F[K],P=(K+":"+O).replace($,";");if(O=="inherit")L+=P;else G+=P}if(G.length)G=c(G);G+=L;return E._ST=G};w.Style=z});
KISSY.Editor.add("clipboard",function(w){var s=KISSY.Editor,z=KISSY,r=z.Node,x=z.UA,B=s.Range,p=s.RANGE,u=z.Event;s.Paste||function(){function h(g){this.editor=g;this._init()}z.augment(h,{_init:function(){var g=this.editor;x.ie?u.on(g.document,"keydown",this._paste,this):u.on(g.document,"paste",this._paste,this)},_paste:function(g){if(!(g.type==="keydown"&&!(g.keyCode===86&&(g.ctrlKey||g.metaKey)))){var i=this.editor;g=i.document;var j=i.getSelection(),q=new B(g),n=new r(x.webkit?"<body></body>":
"<div></div>",null,g);x.webkit&&n[0].appendChild(g.createTextNode("\u00a0"));g.body.appendChild(n[0]);n.css({position:"absolute",top:j.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});n.css("left","-1000px");var m=j.createBookmarks();q.setStartAt(n,p.POSITION_AFTER_START);q.setEndAt(n,p.POSITION_BEFORE_END);q.select(true);setTimeout(function(){n._4e_remove();var t;n=x.webkit&&(t=n._4e_first())&&t[0]&&t.hasClass("Apple-style-span")?t:n;j.selectBookmarks(m);i.insertHtml(n.html())},
0)}}});s.Paste=h}();w.addPlugin(function(){new s.Paste(w)})});
KISSY.Editor.add("color",function(w){function s(l){return("0"+l).slice(l.length-1,l.length+1)}function z(l){l=x.trim(l);if(l.charAt(0)=="#")l=l.substring(1);l=l.replace(/\s+/g,"");var k="";if(/^[0-9a-f]{3,3}$/i.test(l))k=l.replace(/[0-9a-f]/ig,function(d){return d+d});else{var a=l.match(i);if(a&&a[0])for(l=1;l<4;l++)k+=s(parseInt(a[l]).toString(16));else k=l}return"#"+k.toLowerCase()}for(var r=KISSY.Editor,x=KISSY,B=x.Node,p=x.Event,u=r.SimpleOverlay,h=r.Style,g=x.DOM,i=/^rgb\((\d+),(\d+),(\d+)\)$/i,
j="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),q={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},n={element:"span",styles:{"background-color":"#(color)"}},m="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
t={},b={},c=0;c<5;c++){m+="<tr>";for(var e=0;e<8;e++){var f=z(j[8*c+e]);m+="<td>";m+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+f+"'></span></a>";m+="</td>";t[f]=new h(n,{color:f});b[f]=new h(q,{color:f})}m+="</tr>"}t.inherit=new h(n,{color:"inherit"});b.inherit=new h(q,{color:"inherit"});m+="</table></div>";r.ColorSupport||function(){function l(a){l.superclass.constructor.call(this,a);this._init()}var k=r.TripleButton;l.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};x.extend(l,x.Base,{_init:function(){var a=this.get("editor").toolBarDiv;a=new k({container:a,title:this.get("title"),contentCls:this.get("contentCls")});a.on("offClick",this._showColors,this);this.el=a;r.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(a){var d=this;g._4e_ascendant(a.target,function(o){return o[0]===d.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(a){a.halt();var d=this.get("editor");a=a.target;if(g._4e_name(a)=="span"||g._4e_name(a)=="a"){a=new B(a);
if(a._4e_name()=="a")a=a.one("span");var o=this.get("styles");d.fire("save");a._4e_style("background-color")?o[z(a._4e_style("background-color"))].apply(d.document):o.inherit.remove(d.document);d.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(m);this.colorWin=new u({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);p.on(document,"click",this._hidePanel,this);p.on(w.document,
"click",this._hidePanel,this)},_real:function(){var a=this.el.el.offset();a.top+=this.el.el.height()+5;if(a.left+this.colorPanel.width()>g.viewportWidth()-60)a.left=g.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(a)},_showColors:function(a){this._prepare(a)}});r.ColorSupport=l}();w.addPlugin(function(){new r.ColorSupport({editor:w,styles:t,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new r.ColorSupport({editor:w,styles:b,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(w){var s=KISSY.Editor,z=KISSY,r=z.Node,x=z.DOM;s.ElementPaths||function(){function B(p){this.cfg=p;this._cache=[];this._init()}z.augment(B,{_init:function(){var p=this.cfg.editor;this.holder=new r("<span>");this.holder.appendTo(p.statusDiv);p.on("selectionChange",this._selectionChange,this)},_selectionChange:function(p){var u=this.cfg.editor,h=this.holder;h=h[0]||h;p=p.path.elements;var g,i;g=this._cache;for(i=0;i<g.length;i++){g[i].detach("click");g[i]._4e_remove()}this._cache=
[];for(i=0;i<p.length;i++){g=p[i];var j=new r("<a href='#' class='elementpath'>"+(g.attr("_ke_real_element_type")||g._4e_name())+"</a>");this._cache.push(j);(function(q){j.on("click",function(n){n.halt();u.focus();setTimeout(function(){u.getSelection().selectElement(q)},50)})})(g);h.firstChild?x.insertBefore(j[0],h.firstChild):h.appendChild(j[0])}}});s.ElementPaths=B}();w.addPlugin(function(){new s.ElementPaths({editor:w})})});
KISSY.Editor.add("enterkey",function(w){var s=KISSY.Editor,z=KISSY,r=z.UA,x=/^h[1-6]$/,B=s.XHTML_DTD,p=z.Node,u=z.Event,h=s.Walker,g=s.ElementPath;s.enterBlock||function(){function i(n){n=n.getSelection().getRanges();for(var m=n.length-1;m>0;m--)n[m].deleteContents();return n[0]}function j(n){var m=i(n),t=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var b=(new g(m.startContainer)).block;if(b&&(b._4e_name()=="li"||b.parent()._4e_name()=="li")){n.execCommand("outdent");return}}var c=m.splitBlock("p");
if(c){n=c.previousBlock;b=c.nextBlock;var e=c.wasStartOfBlock,f=c.wasEndOfBlock,l;if(b){l=b.parent();if(l._4e_name()=="li"){b._4e_breakParent(l);b._4e_move(b._4e_next(),true)}}else if(n&&(l=n.parent())&&l._4e_name()=="li"){n._4e_breakParent(l);m.moveToElementEditablePosition(n._4e_next());n._4e_move(n._4e_previous())}if(!e&&!f){if(b._4e_name()=="li"&&(l=b._4e_first(h.invisible(true)))&&z.inArray(l._4e_name(),["ul","ol"]))(r.ie?new p(t.createTextNode("\u00a0")):new p(t.createElement("br"))).insertBefore(l);
b&&m.moveToElementEditablePosition(b)}else{var k;if(n){if(n._4e_name()=="li"||!x.test(n._4e_name()))k=n._4e_clone()}else if(b)k=b._4e_clone();k||(k=new p("p",null,t));if(l=c.elementPath){c=0;for(var a=l.elements.length;c<a;c++){var d=l.elements[c];if(d._4e_equals(l.block)||d._4e_equals(l.blockLimit))break;if(B.$removeEmpty[d._4e_name()]){d=d._4e_clone();k._4e_moveChildren(d);k.append(d)}}}r.ie||k._4e_appendBogus();m.insertNode(k);if(r.ie&&e&&(!f||!n[0].childNodes.length)){m.moveToElementEditablePosition(f?
n:k);m.select()}m.moveToElementEditablePosition(e&&!f?b:k)}if(!r.ie)if(b){t=new p(t.createElement("span"));t.html("&nbsp;");m.insertNode(t);t._4e_scrollIntoView();m.deleteContents()}else k._4e_scrollIntoView();m.select()}}function q(n){u.on(n.document,"keydown",function(m){if(m.keyCode===13)if(!m.shiftKey){n.execCommand("enterBlock");m.preventDefault()}})}q.enterBlock=j;s.EnterKey=q}();w.addPlugin(function(){w.addCommand("enterBlock",{exec:s.EnterKey.enterBlock});s.EnterKey(w)})});
KISSY.Editor.add("fakeobjects",function(w){var s=KISSY.Editor,z=KISSY,r=z.Node,x=s.NODE,B=s.Config.base+"theme/spacer.gif",p=s.HtmlParser;s=z.Editor;var u=(w=w.htmlDataProcessor)&&w.htmlFilter,h={elements:{$:function(g){var i=g.attributes;if((i=(i=(i=i&&i._ke_realelement)&&new p.Fragment.FromHtml(decodeURIComponent(i)))&&i.children[0])&&g.attributes._ke_resizable){var j=g.attributes.style;if(j){var q=/(?:^|\s)width\s*:\s*(\d+)/i.exec(j);g=q&&q[1];j=(q=/(?:^|\s)height\s*:\s*(\d+)/i.exec(j))&&q[1];
if(g)i.attributes.width=g;if(j)i.attributes.height=j}}return i}}};u&&u.addRules(h);w&&z.mix(w,{createFakeParserElement:function(g,i,j,q,n){var m;m=new p.BasicWriter;g.writeHtml(m);m=m.getHtml();var t=g.attributes.style;if(g.attributes.width)t="width:"+g.attributes.width+"px;"+t;if(g.attributes.height)t="height:"+g.attributes.height+"px;"+t;g={"class":i,src:B,_ke_realelement:encodeURIComponent(m),_ke_real_node_type:g.type,style:t,align:g.attributes.align||""};n&&delete n.width;n&&delete n.height;n&&
z.mix(g,n,false);if(j)g._ke_real_element_type=j;if(q)g._ke_resizable=q;return new p.Element("img",g)}});z.augment(s,{createFakeElement:function(g,i,j,q,n,m){var t=g.attr("style")||"";if(g.attr("width"))t="width:"+g.attr("width")+"px;"+t;if(g.attr("height"))t="height:"+g.attr("height")+"px;"+t;g={"class":i,src:B,_ke_realelement:encodeURIComponent(n||g._4e_outerHtml()),_ke_real_node_type:g[0].nodeType,align:g.attr("align")||"",style:t};m&&delete m.width;m&&delete m.height;m&&z.mix(g,m,false);if(j)g._ke_real_element_type=
j;if(q)g._ke_resizable=q;return new r("<img/>",g,this.document)},restoreRealElement:function(g){if(g.attr("_ke_real_node_type")!=x.NODE_ELEMENT)return null;g=decodeURIComponent(g.attr("_ke_realelement"));var i=new r("<div>",null,this.document);i.html(g);return i._4e_first(function(j){return j[0].nodeType==x.NODE_ELEMENT})._4e_remove()}})});KISSY.Editor.add("flash",function(w){w.addPlugin(function(){new KISSY.Editor.Flash(w)})});
KISSY.Editor.add("flashsupport",function(w){var s=KISSY.Editor,z=KISSY,r=z.UA,x=z.Event,B=s.ContextMenu,p=z.Node,u=s.BubbleView,h=s.TripleButton,g=s.SimpleOverlay,i=w.htmlDataProcessor,j="ke_flash",q=s.Utils.getFlashUrl;w=i&&i.dataFilter;s.Flash||function(){function n(e){this.editor=e;this._init()}function m(e){return e._4e_name()==="img"&&!!e.hasClass(j)&&e}var t=/\.swf(?:$|\?)/i,b="<p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p><p style='margin:5px 0'><label>\u5bf9\u9f50\uff1a <select class='ke-flash-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
s.Utils.duplicateStr("&nbsp;",13)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-flash-margin' style='width:90px' value='5'/> px</label><p>";n.isFlashEmbed=function(e){e=e.attributes;return e.type=="application/x-shockwave-flash"||t.test(e.src||"")};z.augment(n,{_config:function(){this._cls=j;this._type="flash";this._title="Flash\u5c5e\u6027";this._bodyHtml=b;this._footHtml="<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button>";this._contentCls=
"ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=c;this._flashRules=["img."+j]},_init:function(){this._config();var e=this.editor,f={},l=this._contextMenu;e._toolbars=e._toolbars||{};e._toolbars[this._type]=this;this.el=new h({container:e.toolBarDiv,contentCls:this._contentCls,title:this._tip});this.el.on("click",this.show,this);if(l)for(var k in l)(function(a){f[a]=function(){l[a](e)}})(k);B.register(e.document,{rules:this._flashRules,width:"120px",funcs:f});u.attach({pluginName:this._type,
pluginInstance:this});x.on(e.document,"dblclick",this._dbclick,this);s.Utils.lazyRun(this,"_prepareShow","_realShow")},_getFlashUrl:function(e){return q(e)},_updateTip:function(e,f){f=this.editor.restoreRealElement(f);e.html(this._getFlashUrl(f));e.attr("href",this._getFlashUrl(f))},_dbclick:function(e){var f=new p(e.target);if(f._4e_name()==="img"&&f.hasClass(this._cls)){this.show(null,f);e.halt()}},_prepareShow:function(){var e=new g({title:this._title,width:this._config_dwidth||"350px",mask:true});
e.body.html(this._bodyHtml);e.foot.html(this._footHtml);this.d=e;this._initD()},_realShow:function(){this._updateD();this.d.show()},_updateD:function(){var e=this.editor,f=this.selectedFlash;if(f){e=e.restoreRealElement(f);e.attr("width")&&this.dWidth.val(parseInt(e.attr("width")));e.attr("height")&&this.dHeight.val(parseInt(e.attr("height")));this.dAlign.val(e.attr("align"));this.dUrl.val(q(e));this.dMargin.val(parseInt(e._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");
this.dWidth.val("");this.dHeight.val("");this.dAlign.val("");this.dMargin.val("5")}},show:function(e,f){this.selectedFlash=f;this._prepareShow()},_initD:function(){var e=this,f=e.d;e.dHeight=f.el.one(".ke-flash-height");e.dWidth=f.el.one(".ke-flash-width");e.dUrl=f.el.one(".ke-flash-url");e.dAlign=f.el.one(".ke-flash-align");e.dMargin=f.el.one(".ke-flash-margin");var l=f.el.one(".ke-flash-ok");f=f.el.one(".ke-flash-cancel");l.on("click",e._gen,e);f.on("click",function(){e.d.hide()})},_getDInfo:function(){return{url:this.dUrl.val(),
attrs:{width:this.dWidth.val(),height:this.dHeight.val(),align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px"}}},_gen:function(){var e=this.editor,f=this._getDInfo(),l=f&&f.url;f=f&&f.attrs;var k=" ";if(z.trim(l)){if(f)for(var a in f)k+=a+"='"+f[a]+"' ";l="<object "+k+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+
l+'" /><embed '+k+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+l+'"  type="application/x-shockwave-flash"/></object>';a=new p(l,null,e.document);f=e.createFakeElement?e.createFakeElement(a,this._cls,this._type,true,l,f):a;f=e.insertElement(f);this.selectedFlash&&e.getSelection().selectElement(f);this.d.hide()}}});s.Flash=n;n.registerBubble=function(e,f,l){u.register({pluginName:e,func:l,init:function(){var k=this,a=k.el;a.html(f+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var d=a.one(".ke-bubbleview-url"),o=a.one(".ke-bubbleview-change");a=a.one(".ke-bubbleview-remove");o._4e_unselectable();d._4e_unselectable();a._4e_unselectable();o.on("click",function(y){k._plugin.show(null,k._selectedEl);y.halt()});a.on("click",function(y){var v=k._plugin;if(r.webkit){var C=v.editor.getSelection().getRanges();C&&C[0]&&(C[0].collapse(true)||1)&&C[0].select()}k._selectedEl._4e_remove();k.hide();v.editor.notifySelectionChange();y.halt()});k.on("beforeVisibleChange",function(y){var v=
k._selectedEl;y.newVal&&v&&k._plugin._updateTip(d,v)})}})};n.registerBubble("flash","Flash \u7f51\u5740\uff1a ",m);n.checkFlash=m;var c={"Flash\u5c5e\u6027":function(e){var f=e.getSelection();f=f&&f.getStartElement();f=m(f);e=e._toolbars.flash;f&&e.show(null,f)}};n.CLS_FLASH=j;n.TYPE_FLASH="flash"}();w&&w.addRules({elements:{object:function(n){var m=n.attributes;if(!(m.classid&&String(m.classid).toLowerCase())){for(m=0;m<n.children.length;m++)if(n.children[m].name=="embed"){if(!s.Flash.isFlashEmbed(n.children[m]))return null;
return i.createFakeParserElement(n,j,"flash",true)}return null}return i.createFakeParserElement(n,j,"flash",true)},embed:function(n){if(!s.Flash.isFlashEmbed(n))return null;return i.createFakeParserElement(n,j,"flash",true)}}},5)});
KISSY.Editor.add("font",function(w){var s=KISSY.Editor,z=KISSY,r=s.Style,x=s.TripleButton,B=w.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],p={},u=[],h={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},g=w.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],i={},j=[],q={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},n;w.cfg.pluginConfig["font-size"]=B;w.cfg.pluginConfig["font-family"]=g;for(n=0;n<B.length;n++){var m=B[n];p[m]=new r(h,{size:m});u.push({name:m,value:m})}for(n=0;n<g.length;n++){B=g[n];i[B]=new r(q,{family:B});j.push({name:B,value:B,attrs:{style:"font-family:"+B}})}s.Font||function(){function t(c){t.superclass.constructor.call(this,c);this._init()}function b(c){b.superclass.constructor.call(this,
c);this._init()}t.ATTRS={title:{},html:{},styles:{},editor:{}};z.extend(t,z.Base,{_init:function(){var c=this.get("editor"),e=c.toolBarDiv;this.get("html");this.el=new s.Select({container:e,doc:c.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);c.on("selectionChange",this._selectionChange,this)},_vChange:function(c){var e=this.get("editor"),f=c.newVal;c=c.preVal;var l=this.get("styles");e.focus();
e.fire("save");if(f==c){l[f].remove(e.document);this.el.set("value","")}else l[f].apply(e.document);e.fire("save")},_selectionChange:function(c){this.get("editor");c=c.path.elements;for(var e=this.get("styles"),f=0,l;f<c.length;f++){l=c[f];for(var k in e)if(e[k].checkElementRemovable(l,true)){this.el.set("value",k);return}}this.el.reset("value")}});b.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};z.extend(b,z.Base,{_init:function(){var c=this.get("editor"),e=this.get("text");this.get("style");
var f=this.get("title");this.el=new x({text:e,title:f,contentCls:this.get("contentCls"),container:c.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);c.on("selectionChange",this._selectionChange,this)},_on:function(){var c=this.get("editor");this.get("text");var e=this.get("style");this.get("title");c.fire("save");e.apply(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_off:function(){var c=this.get("editor");this.get("text");var e=this.get("style");
this.get("title");c.fire("save");e.remove(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_selectionChange:function(c){this.get("editor");this.get("text");var e=this.get("style");this.get("title");e.checkActive(c.path)?this.el.set("state",x.ON):this.el.set("state",x.OFF)}});t.SingleFont=b;s.Font=t}();w.addPlugin(function(){new s.Font({editor:w,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:p,html:u});new s.Font({editor:w,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:i,html:j});new s.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:w,style:new r({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:w,style:new r({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:w,style:new r({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:w,style:new r({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(w){var s=KISSY.Editor,z=KISSY,r=[],x={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},B={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},p={},u=s.Style;for(var h in x)if(x[h]){p[x[h]]=new u({element:x[h]});r.push({name:h,value:x[h],attrs:{style:"font-size:"+B[x[h]]}})}s.Format||function(){function g(i){g.superclass.constructor.call(this,
i);this._init()}g.ATTRS={editor:{}};z.extend(g,z.Base,{_init:function(){var i=this.get("editor");this.el=new s.Select({container:i.toolBarDiv,value:"",doc:i.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);i.on("selectionChange",this._selectionChange,this)},_vChange:function(i){var j=this.get("editor"),q=i.newVal;i=i.preVal;j.fire("save");if(q!=i)p[q].apply(j.document);else{p.p.apply(j.document);
this.el.set("value","p")}j.fire("save")},_selectionChange:function(i){this.get("editor");i=i.path;for(var j in p)if(p[j].checkActive(i)){this.el.set("value",j);return}this.el.reset("value")}});s.Format=g}();w.addPlugin(function(){new s.Format({editor:w,html:r,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function w(){this._={output:[]}}var s=KISSY.Editor,z=s.Utils;if(!s.HtmlParser.BasicWriter){KISSY.augment(w,{openTag:function(r){this._.output.push("<",r)},openTagClose:function(r,x){x?this._.output.push(" />"):this._.output.push(">")},attribute:function(r,x){if(typeof x=="string")x=z.htmlEncodeAttr(x);this._.output.push(" ",r,'="',x,'"')},closeTag:function(r){this._.output.push("</",r,">")},text:function(r){this._.output.push(r)},comment:function(r){this._.output.push("<!--",
r,"--\>")},write:function(r){this._.output.push(r)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(r){var x=this._.output.join("");r&&this.reset();return x}});s.HtmlParser.BasicWriter=w}});
KISSY.Editor.add("htmlparser-comment",function(){function w(r){this.value=r;this._={isBlockLike:false}}var s=KISSY.Editor,z=s.NODE;if(!s.HtmlParser.Comment){s.HtmlParser.Comment=w;w.prototype={constructor:w,type:z.NODE_COMMENT,writeHtml:function(r,x){var B=this.value;if(x){if(!(B=x.onComment(B,this)))return;if(typeof B!="string"){B.parent=this.parent;B.writeHtml(r,x);return}}r.comment(B)}}}});
KISSY.Editor.add("htmlparser-element",function(){function w(x,B){this.name=x;this.attributes=B||(B={});this.children=[];var p=B._ke_real_element_type||x;B=s.XHTML_DTD;p=!!(B.$nonBodyContent[p]||B.$block[p]||B.$listItem[p]||B.$tableContent[p]||B.$nonEditable[p]||p=="br");var u=!!B.$empty[x];this.isEmpty=u;this.isUnknown=!B[x];this._={isBlockLike:p,hasInlineStarted:u||!p}}var s=KISSY.Editor;if(!s.HtmlParser.Element){var z=s.NODE,r=function(x,B){x=x[0];B=B[0];return x<B?-1:x>B?1:0};KISSY.augment(w,{type:z.NODE_ELEMENT,
add:s.HtmlParser.Fragment.prototype.add,clone:function(){return new w(this.name,this.attributes)},writeHtml:function(x,B){var p=this.attributes,u=this,h=u.name,g,i,j,q;u.filterChildren=function(){if(!q){var t=new s.HtmlParser.BasicWriter;s.HtmlParser.Fragment.prototype.writeChildrenHtml.call(u,t,B);u.children=(new s.HtmlParser.Fragment.FromHtml(t.getHtml())).children;q=1}};if(B){for(;;){if(!(h=B.onElementName(h)))return;u.name=h;if(!(u=B.onElement(u)))return;u.parent=this.parent;if(u.name==h)break;
if(u.type!=z.NODE_ELEMENT){u.writeHtml(x,B);return}h=u.name;if(!h){this.writeChildrenHtml.call(u,x,q?null:B);return}}p=u.attributes}x.openTag(h,p);for(var n=[],m=0;m<2;m++)for(g in p){i=g;j=p[g];if(m==1)n.push([g,j]);else if(B){for(;;)if(i=B.onAttributeName(g))if(i!=g){delete p[g];g=i}else break;else{delete p[g];break}if(i)if((j=B.onAttribute(u,i,j))===false)delete p[i];else p[i]=j}}x.sortAttributes&&n.sort(r);p=n.length;for(m=0;m<p;m++){g=n[m];x.attribute(g[0],g[1])}x.openTagClose(h,u.isEmpty);if(!u.isEmpty){this.writeChildrenHtml.call(u,
x,q?null:B);x.closeTag(h)}},writeChildrenHtml:function(){s.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});s.HtmlParser.Element=w}});
KISSY.Editor.add("htmlparser-filter",function(){function w(h){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};h&&this.addRules(h,10)}function s(h,g){for(var i=0;h&&i<g.length;i++){var j=g[i];h=h.replace(j[0],j[1])}return h}function z(h,g,i){if(typeof g=="function")g=[g];var j,q;q=h.length;var n=g&&g.length;if(n){for(j=0;j<q&&h[j].pri<i;j++);for(q=n-1;q>=0;q--)if(n=g[q]){n.pri=i;h.splice(j,0,n)}}}function r(h,g,i){if(g)for(var j in g){var q=h[j];h[j]=x(q,g[j],
i);q||h.$length++}}function x(h,g,i){if(g){g.pri=i;if(h){if(h.splice)z(h,g,i);else{h=h.pri>i?[g,h]:[h,g];h.filter=B}return h}else return g.filter=g}}function B(h){for(var g=h.type||h instanceof p.HtmlParser.Fragment,i=0;i<this.length;i++){if(g)var j=h.type,q=h.name;var n=this[i].apply(window,arguments);if(n===false)return n;if(g){if(n&&(n.name!=q||n.type!=j))return n}else if(typeof n!="string")return n;n!=undefined&&(h=n)}return h}var p=KISSY.Editor,u=p.NODE;if(!p.HtmlParser.Filter){KISSY.augment(w,
{addRules:function(h,g){if(typeof g!="number")g=10;z(this._.elementNames,h.elementNames,g);z(this._.attributeNames,h.attributeNames,g);r(this._.elements,h.elements,g);r(this._.attributes,h.attributes,g);this._.text=x(this._.text,h.text,g)||this._.text;this._.comment=x(this._.comment,h.comment,g)||this._.comment;this._.root=x(this._.root,h.root,g)||this._.root},onElementName:function(h){return s(h,this._.elementNames)},onAttributeName:function(h){return s(h,this._.attributeNames)},onText:function(h){var g=
this._.text;return g?g.filter(h):h},onComment:function(h,g){var i=this._.comment;return i?i.filter(h,g):h},onFragment:function(h){var g=this._.root;return g?g.filter(h):h},onElement:function(h){for(var g=[this._.elements["^"],this._.elements[h.name],this._.elements.$],i,j=0;j<3;j++)if(i=g[j]){i=i.filter(h,this);if(i===false)return null;if(i&&i!=h)return this.onNode(i);if(h.parent&&!h.name)break}return h},onNode:function(h){var g=h.type;return g==u.NODE_ELEMENT?this.onElement(h):g==u.NODE_TEXT?new p.HtmlParser.Text(this.onText(h.value)):
null},onAttribute:function(h,g,i){if(g=this._.attributes[g]){h=g.filter(i,h,this);if(h===false)return false;if(typeof h!="undefined")return h}return i}});p.HtmlParser.Filter=w}});
KISSY.Editor.add("htmlparser-fragment",function(){function w(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var s=KISSY.Editor;if(!s.HtmlParser.Fragment){var z={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},r=KISSY,x=s.Utils,B=s.NODE,p=s.XHTML_DTD,u=x.mix({table:1,ul:1,ol:1,dl:1},p.table,p.ul,p.ol,p.dl),h=p.$list,g=p.$listItem;w.FromHtml=function(i,j){function q(d){var o;if(c.length>0)for(var y=0;y<c.length;y++){var v=c[y],C=v.name,H=
p[C],A=f.name&&p[f.name];if((!A||A[C])&&(!d||!H||H[d]||!p[d])){if(!o){n();o=1}v=v.clone();v.parent=f;f=v;c.splice(y,1);y--}}}function n(){for(;e.length;)f.add(e.shift())}function m(d,o,y){o=o||f||b;if(j&&!o.type){var v,C;if((v=d.attributes&&(C=d.attributes._ke_real_element_type)?C:d.name)&&!(v in p.$body)&&!(v in p.$nonBodyContent)){v=f;f=o;t.onTagOpen(j,{});o=f;if(y)f=v}}if(d._.isBlockLike&&d.name!="pre"){y=d.children.length;if((v=d.children[y-1])&&v.type==B.NODE_TEXT)if(C=x.rtrim(v.value))v.value=
C;else d.children.length=y-1}o.add(d);if(d.returnPoint){f=d.returnPoint;delete d.returnPoint}}var t=new s.HtmlParser,b=new w,c=[],e=[],f=b,l=false,k;t.onTagOpen=function(d,o,y){var v=new s.HtmlParser.Element(d,o);if(v.isUnknown&&y)v.isEmpty=true;if(p.$removeEmpty[d])c.push(v);else{if(d=="pre")l=true;else if(d=="br"&&l){f.add(new s.HtmlParser.Text("\n"));return}if(d=="br")e.push(v);else{var C=f.name,H=C&&(p[C]||(f._.isBlockLike?p.div:p.span));if(H&&!v.isUnknown&&!f.isUnknown&&!H[d]){H=false;var A;
if(d in h&&C in h){C=f.children;(C=C[C.length-1])&&C.name in g||m(C=new s.HtmlParser.Element("li"),f);k=f;A=C}else if(d==C)m(f,f.parent);else{if(u[C])k||(k=f);else{m(f,f.parent,true);z[C]||c.unshift(f)}H=true}f=A?A:f.returnPoint||f.parent;if(H){t.onTagOpen.apply(this,arguments);return}}q(d);n();v.parent=f;v.returnPoint=k;k=0;if(v.isEmpty)m(v);else f=v}}};t.onTagClose=function(d){for(var o=c.length-1;o>=0;o--)if(d==c[o].name){c.splice(o,1);return}for(var y=[],v=[],C=f;C.type&&C.name!=d;){C._.isBlockLike||
v.unshift(C);y.push(C);C=C.parent}if(C.type){for(o=0;o<y.length;o++){var H=y[o];m(H,H.parent)}f=C;if(f.name=="pre")l=false;C._.isBlockLike&&n();m(C,C.parent);if(C==f)f=f.parent;c=c.concat(v)}if(d=="body")j=false};t.onText=function(d){if(!f._.hasInlineStarted&&!l){d=x.ltrim(d);if(d.length===0)return}n();q();if(j&&(!f.type||f.name=="body")&&x.trim(d))this.onTagOpen(j,{});l||(d=d.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));f.add(new s.HtmlParser.Text(d))};t.onCDATA=function(){};t.onComment=function(d){f.add(new s.HtmlParser.Comment(d))};
t.parse(i);for(n();f.type;){i=f.parent;var a=f;if(j&&(!i.type||i.name=="body")&&!p.$body[a.name]){f=i;t.onTagOpen(j,{});i=f}i.add(a);f=i}return b};r.augment(w,{add:function(i){var j=this.children.length;if(j=j>0&&this.children[j-1]||null){if(i._.isBlockLike&&j.type==B.NODE_TEXT){j.value=x.rtrim(j.value);if(j.value.length===0){this.children.pop();this.add(i);return}}j.next=i}i.previous=j;i.parent=this;this.children.push(i);this._.hasInlineStarted=i.type==B.NODE_TEXT||i.type==B.NODE_ELEMENT&&!i._.isBlockLike},
writeHtml:function(i,j){var q;this.filterChildren=function(){var n=new s.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,n,j,true);n=n.getHtml();this.children=(new w.FromHtml(n)).children;q=1};!this.name&&j&&j.onFragment(this);this.writeChildrenHtml(i,q?null:j)},writeChildrenHtml:function(i,j){for(var q=0;q<this.children.length;q++)this.children[q].writeHtml(i,j)}});s.HtmlParser.Fragment=w}});
KISSY.Editor.add("htmlparser",function(){function w(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var s=KISSY.Editor;if(!s.HtmlParser){var z=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,r={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},x=s.XHTML_DTD;KISSY.augment(w,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var p,u,h=0,g;p=this._.htmlPartsRegex.exec(B);){u=p.index;if(u>h){h=B.substring(h,u);g?g.push(h):this.onText(h)}h=this._.htmlPartsRegex.lastIndex;if(u=p[1]){u=u.toLowerCase();if(g&&x.$cdata[u]){this.onCDATA(g.join(""));g=null}if(!g){this.onTagClose(u);continue}}if(g)g.push(p[0]);else if(u=p[3]){u=u.toLowerCase();var i={},j;p=p[4];var q=!!(p&&p.charAt(p.length-1)=="/");if(p)for(;j=z.exec(p);){var n=
j[1].toLowerCase();j=j[2]||j[3]||j[4]||"";i[n]=!j&&r[n]?n:j}this.onTagOpen(u,i,q);if(!g&&x.$cdata[u])g=[]}else if(u=p[2])this.onComment(u)}B.length>h&&this.onText(B.substring(h,B.length))}});s.HtmlParser=w}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function w(){w.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var r=s.XHTML_DTD;for(var x in z.mix({},r.$nonBodyContent,r.$block,r.$listItem,r.$tableContent))this.setRules(x,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!r[x]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var s=KISSY.Editor,z=s.Utils;if(!s.HtmlParser.HtmlWriter){KISSY.extend(w,s.HtmlParser.BasicWriter,{openTag:function(r){var x=this._.rules[r];if(this._.indent)this.indentation();else if(x&&x.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",r)},openTagClose:function(r,x){r=this._.rules[r];
if(x)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(r&&r.indent)this._.indentation+=this.indentationChars}r&&r.breakAfterOpen&&this.lineBreak()},attribute:function(r,x){if(typeof x=="string"){this.forceSimpleAmpersand&&(x=x.replace(/&amp;/g,"&"));x=z.htmlEncodeAttr(x)}this._.output.push(" ",r,'="',x,'"')},closeTag:function(r){var x=this._.rules[r];if(x&&x.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(x&&x.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",r,">");x&&x.breakAfterClose&&this.lineBreak()},text:function(r){if(this._.indent){this.indentation();r=z.ltrim(r)}this._.output.push(r)},comment:function(r){this._.indent&&this.indentation();this._.output.push("<!--",r,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(r,x){var B=this._.rules[r];if(B)z.mix(B,x);else this._.rules[r]=x}});s.HtmlParser.HtmlWriter=w}});KISSY.Editor.add("htmlparser-text",function(){function w(z){this.value=z;this._={isBlockLike:false}}var s=KISSY.Editor;if(!s.HtmlParser.Text){KISSY.augment(w,{type:s.NODE.NODE_TEXT,writeHtml:function(z,r){var x=this.value;r&&!(x=r.onText(x,this))||z.text(x)}});s.HtmlParser.Text=w}});
KISSY.Editor.add("htmldataprocessor",function(w){function s(k){if(/mso-list\s*:\s*Ignore/i.test(k.attributes&&k.attributes.style))return true;return p}function z(k,a){var d=new u.HtmlParser.Element("ke:listbullet"),o;if(k)if(k[2]){k=isNaN(k[1])?/^[a-z]+$/.test(k[1])?"lower-alpha":/^[A-Z]+$/.test(k[1])?"upper-alpha":"decimal":"decimal";o="ol"}else{k=/[l\u00B7\u2002]/.test(k[1])?"disc":/[\u006F\u00D8]/.test(k[1])?"circle":/[\u006E\u25C6]/.test(k[1])?"square":"disc";o="ul"}else{k="decimal";o="ol"}d.attributes=
{"ke:listtype":o,style:"list-style-type:"+k+";"};d.add(new u.HtmlParser.Text(a));return d}function r(k){var a=k.attributes,d;if((d=k.removeAnyChildWithName("ke:listbullet"))&&d.length&&(d=d[0])){k.name="ke:li";if(a.style)a.style=x([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(o){o=o.split(" ");o=o[3]||o[1]||o[0];o=parseInt(o,10);if(!b&&c&&o>c)b=o-c;a["ke:margin"]=c=o}]],p)(a.style,k)||"";d=d.attributes;k.addStyle(d.style);h.mix(a,d);return true}return false}function x(k,a){return function(d,
o){var y=[];d.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(v,C,H){C=C.toLowerCase();C=="font-family"&&(H=H.replace(/["']/g,""));for(var A,D,I,J=0;J<k.length;J++)if(k[J]){v=k[J][0];A=k[J][1];D=k[J][2];I=k[J][3];if(C.match(v)&&(!A||H.match(A))){C=I||C;a&&(D=D||H);if(typeof D=="function")D=D(H,o,C);if(D&&D.push){C=D[0];D=D[1]}typeof D=="string"&&y.push([C,D]);return}}!a&&y.push([C,H])});for(d=0;d<y.length;d++)y[d]=y[d].join(":");return y.length?y.join(";")+";":false}}
function B(k){k=k.children;for(var a,d,o,y,v,C,H,A=0;A<k.length;A++){a=k[A];if("ke:li"==a.name){a.name="li";d=a.attributes;o=a.attributes["ke:listtype"];y=parseInt(d["ke:indent"],10)||b&&Math.ceil(d["ke:margin"]/b)||1;d.style&&(d.style=x([["list-style-type",o=="ol"?"decimal":"disc"]],p)(d.style)||"");if(C){if(y>H){C=new u.HtmlParser.Element(o);C.add(a);v.add(C)}else{if(y<H){v=H-y;for(var D;v--&&(D=C.parent);)C=D.parent}C.add(a)}k.splice(A--,1)}else{C=new u.HtmlParser.Element(o);C.add(a);k[A]=C}v=
a;H=y}else C=null}b=0}var p=p,u=KISSY.Editor,h=KISSY,g=h.UA,i=u.NODE,j=u.HtmlParser,q=new j.Filter,n=new j.Filter,m=u.XHTML_DTD;if(!w.htmlDataProcessor){(function(){var k=u.HtmlParser.Fragment.prototype,a=u.HtmlParser.Element.prototype;k.onlyChild=a.onlyChild=function(){var d=this.children;return d.length==1&&d[0]||null};a.removeAnyChildWithName=function(d){for(var o=this.children,y=[],v,C=0;C<o.length;C++){v=o[C];if(v.name){if(v.name==d){y.push(v);o.splice(C--,1)}y=y.concat(v.removeAnyChildWithName(d))}}return y};
a.getAncestor=function(d){for(var o=this.parent;o&&!(o.name&&o.name.match(d));)o=o.parent;return o};k.firstChild=a.firstChild=function(d){for(var o,y=0;y<this.children.length;y++){o=this.children[y];if(d(o))return o;else if(o.name)if(o=o.firstChild(d))return o}return null};a.addStyle=function(d,o,y){var v="";if(typeof o=="string")v+=d+":"+o+";";else{if(typeof d=="object")for(var C in d){if(d.hasOwnProperty(C))v+=C+":"+d[C]+";"}else v+=d;y=o}if(!this.attributes)this.attributes={};d=this.attributes.style||
"";d=(y?[v,d]:[d,v]).join(";");this.attributes.style=d.replace(/^;|;(?=;)/,"")};m.parentOf=function(d){var o={};for(var y in this)if(y.indexOf("$")==-1&&this[y][d])o[y]=1;return o}})();var t=x([[/mso/i],[/font-size/i,"",function(k){for(var a=w.cfg.pluginConfig["font-size"],d=0;d<a.length;d++)if(k.toLowerCase()==a[d])return k;return false},"font-size"],[/font-family/i,"",function(k){for(var a=w.cfg.pluginConfig["font-family"],d=0;d<a.length;d++)if(k.toLowerCase()==a[d].toLowerCase())return k;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],p),b,c=0,e=m.parentOf("ol"),f={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(k){k.filterChildren();B(k)},elements:{font:function(k){delete k.name},p:function(k){k.filterChildren();if(r(k))return p},$:function(k){var a=k.name||"";a.indexOf(":")!=-1&&a.indexOf("ke")==-1&&delete k.name;var d=k.attributes.style;if(a=="span"&&(!d||!t(d)))delete k.name;
if(a in e){k.filterChildren();B(k)}},table:function(k){var a=k.attributes.border;if(!a||a=="0")k.attributes["class"]="ke_show_border"},td:function(k){if(g.ie){k=k.children;var a=new u.HtmlParser.Text("&nbsp;");if(k.length)k[k.length-1].type!=i.NODE_TEXT&&k.push(a);else k.push(a)}},span:function(k){if(!g.gecko&&s(k.parent))return false;if(!g.gecko&&s(k)){k=(k=k.firstChild(function(d){return d.value||d.name=="img"}))&&(k.value||"l.");var a=k.match(/^([^\s]+?)([.)]?)$/);return z(a,k)}}},comment:!g.ie?
function(k,a){var d=k.match(/<img.*?>/);if(k=k.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){d=(a=k[1]||d&&"l.")&&a.match(/>([^\s]+?)([.)]?)</);return z(d,a)}if(g.gecko&&d){d=u.HtmlParser.Fragment.FromHtml(d[0]).children[0];(a=(a=(a=a.previous)&&a.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&a[1])&&(d.attributes.src=a);return d}return false}:function(){return false},attributes:{"class":function(k){if(/^ke_/.test(k))return k;return false},style:function(k){k=t(k);if(!k)return false;
return k}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},l={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(k){var a=k.parent;if(a&&a.name=="object"){var d=a.attributes.width;a=a.attributes.height;d&&(k.attributes.width=d);a&&(k.attributes.height=a)}},param:function(k){k.children=[];k.isEmpty=true;return k},a:function(k){if(!(k.children.length||k.attributes.name))return false},td:function(k){for(var a=k.children,d=0;d<a.length;d++)if(a[d].name=="br"){a.splice(d,1);--d}if(!k.children.length){a=
new u.HtmlParser.Text("&nbsp;");k.children.push(a)}},span:function(k){if(!k.children.length)return false}},attributes:{style:function(k){if(!h.trim(k))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(g.ie)l.attributes.style=function(k){return k.toLowerCase()};q.addRules(l);n.addRules(f);w.htmlDataProcessor={htmlFilter:q,dataFilter:n,toHtml:function(k,a){var d=new j.HtmlWriter;j.Fragment.FromHtml(k,a).writeHtml(d,q);return d.getHtml(true)},toDataFormat:function(k,a){if(g.gecko)k=
k.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var d=new j.BasicWriter;k=j.Fragment.FromHtml(k,a);d.reset();k.writeHtml(d,n);return d.getHtml(true)}}}});
KISSY.Editor.add("image",function(w){var s=KISSY.Editor,z=KISSY,r=z.UA,x=z.Node,B=z.Event,p=s.BubbleView,u=s.SimpleOverlay;s.ImageInserter||function(){function h(n){h.superclass.constructor.call(this,n);this._init()}var g=function(n){return n._4e_name()==="img"&&!/(^|\s+)ke_/.test(n[0].className)&&n},i=s.TripleButton,j="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></p><p style='margin:5px 0'><label><span style='color:#0066CC;font-weight:bold;'>\u9ad8\u5ea6\uff1a </span><input class='ke-img-height' style='width:90px' value='\u81ea\u52a8'/> px </label> &nbsp;<label><span style='color:#0066CC;font-weight:bold;'>\u5bbd\u5ea6\uff1a </span><input class='ke-img-width' style='width:90px' value='\u81ea\u52a8'/> px </label></p><p><label><span style='color:#0066CC;font-weight:bold;'>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
s.Utils.duplicateStr("&nbsp;",13)+"<label><span style='color:#0066CC;font-weight:bold;'>\u95f4\u8ddd\uff1a </span> <input class='ke-img-margin' style='width:80px' value='5'/> px</label></p></div>";h.ATTRS={editor:{}};var q={"\u56fe\u7247\u5c5e\u6027":function(n){var m=n.getSelection();m=m&&m.getStartElement();m=g(m);n=n._toolbars.image;m&&n.show(null,m)}};z.extend(h,z.Base,{_init:function(){var n=this.get("editor"),m=n.toolBarDiv,t={};this.editor=n;this.el=new i({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",
container:m});this.el.on("offClick",this.show,this);B.on(n.document,"dblclick",this._dblclick,this);s.Utils.lazyRun(this,"_prepare","_real");n._toolbars=n._toolbars||{};n._toolbars.image=this;if(q)for(var b in q)(function(c){t[c]=function(){q[c](n)}})(b);s.ContextMenu.register(n.document,{rules:[g],width:"120px",funcs:t});p.attach({pluginName:"image",pluginInstance:this})},_dblclick:function(n){var m=new x(n.target);if(g(m)){this.show(null,m);n.halt()}},_prepare:function(){var n=this;n.get("editor");
n.d=new u({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var m=n.d;m.body.html(j);m.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");n.content=m.el;m=n.content;var t=m.one(".ke-img-cancel"),b=m.one(".ke-img-insert");n.imgUrl=m.one(".ke-img-url");n.imgHeight=m.one(".ke-img-height");n.imgWidth=m.one(".ke-img-width");n.imgAlign=m.one(".ke-img-align");n.imgMargin=m.one(".ke-img-margin");t.on("click",function(c){n.d.hide();
c.halt()});b.on("click",function(){n._insert()})},_updateTip:function(n,m){n.html(m.attr("src"));n.attr("href",m.attr("src"))},_real:function(){this.d.show()},_insert:function(){var n=this.get("editor"),m=this.imgUrl.val();if(m){var t=parseInt(this.imgHeight.val()),b=parseInt(this.imgWidth.val()),c=this.imgAlign.val(),e=parseInt(this.imgMargin.val()),f="";if(t)f+="height:"+t+"px;";if(b)f+="width:"+b+"px;";if(c)f+="float:"+c;isNaN(e)||(f+="margin:"+e+"px;");if(f)f=" style='"+f+"' ";m=new x("<img "+
f+"src='"+m+"' alt='' />",null,n.document);m=n.insertElement(m,t||b?null:function(l){l.on("load",function(){l.detach();l.css({width:l.width()+"px",height:l.height()+"px"})})});this._selectedEl&&n.getSelection().selectElement(m);this.d.hide();n.notifySelectionChange()}},_updateD:function(n){if(this._selectedEl=n){this.imgUrl.val(n.attr("src"));this.imgHeight.val(n.height());this.imgWidth.val(n.width());this.imgAlign.val(n._4e_style("float"));this.imgMargin.val(parseInt(n._4e_style("margin"))||0)}else{this.imgUrl.val("http://");
this.imgHeight.val("\u81ea\u52a8");this.imgWidth.val("\u81ea\u52a8");this.imgAlign.val();this.imgMargin.val("5")}},show:function(n,m){this._prepare();this._updateD(m)}});s.ImageInserter=h;(function(n,m,t){p.register({pluginName:n,func:t,init:function(){var b=this,c=b.el;c.html(m+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var e=c.one(".ke-bubbleview-url"),f=c.one(".ke-bubbleview-change");c=c.one(".ke-bubbleview-remove");f._4e_unselectable();e._4e_unselectable();c._4e_unselectable();f.on("click",function(l){b._plugin.show(null,b._selectedEl);l.halt()});c.on("click",function(l){var k=b._plugin;if(r.webkit){var a=k.editor.getSelection().getRanges();a&&a[0]&&(a[0].collapse(true)||1)&&a[0].select()}b._selectedEl._4e_remove();b.hide();k.editor.notifySelectionChange();l.halt()});b.on("afterVisibleChange",function(l){var k=
b._selectedEl;l.newVal&&k&&b._plugin._updateTip(e,k)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",g)}();w.addPlugin(function(){new s.ImageInserter({editor:w})})});
KISSY.Editor.add("indent",function(w){var s=KISSY.Editor,z={ol:1,ul:1},r=KISSY,x=s.Walker,B=r.DOM,p=r.Node,u=r.UA,h=s.NODE;s.Indent||function(){function g(e){this.type=e;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function i(e){return e.type=CKEDITOR.NODE_ELEMENT&&e.is("li")}function j(e,f,l){var k=f.startContainer;for(e=f.endContainer;k&&k.parent()[0]!==l[0];)k=k.parent();for(;e&&e.parent()[0]!==l[0];)e=e.parent();if(k&&e){var a=k;k=[];for(var d=false;!d;){if(a[0]===
e[0])d=true;k.push(a);a=a.next()}if(!(k.length<1)){a=l._4e_parents(true);for(e=0;e<a.length;e++)if(z[a[e]._4e_name()]){l=a[e];break}a=this.type=="indent"?1:-1;e=k[0];d=k[k.length-1];k={};var o=s.ListUtils.listToArray(l,k),y=o[d._4e_getData("listarray_index")].indent;for(e=e._4e_getData("listarray_index");e<=d._4e_getData("listarray_index");e++){o[e].indent+=a;var v=o[e].parent;o[e].parent=new p(v[0].ownerDocument.createElement(v._4e_name()))}for(e=d._4e_getData("listarray_index")+1;e<o.length&&o[e].indent>
y;e++)o[e].indent+=a;d=s.ListUtils.arrayToList(o,k,null,"p",0);a=[];if(this.type=="outdent"){var C;if((C=l.parent())&&C._4e_name()=="li"){o=d.listNode.childNodes;var H;for(e=o.length-1;e>=0;e--)if((H=new p(o[e]))&&H._4e_name()=="li")a.push(H)}}if(d){B.insertBefore(d.listNode,l[0]);l._4e_remove()}if(a&&a.length)for(e=0;e<a.length;e++){for(H=l=a[e];(H=H.next())&&H._4e_name()in z;){u.ie&&!l._4e_first(function(A){return t(A)&&b(A)})&&l[0].appendChild(f.document.createTextNode("\u00a0"));l[0].appendChild(H[0])}B.insertAfter(l[0],
C[0])}for(e in k)k[e]._4e_clearMarkers(k,true)}}}function q(e,f){f=f.createIterator();f.enforceRealBlocks=true;f.enlargeBr=true;for(var l;l=f.getNextParagraph();)n.call(this,e,l)}function n(e,f){e=parseInt(f._4e_style(this.indentCssProperty),10);if(isNaN(e))e=0;e+=(this.type=="indent"?1:-1)*this.indentOffset;if(e<0)return false;e=Math.max(e,0);e=Math.ceil(e/this.indentOffset)*this.indentOffset;f.css(this.indentCssProperty,e?e+this.indentUnit:"");f[0].style.cssText===""&&f[0].removeAttribute("style");
return true}function m(e){m.superclass.constructor.call(this,e);e=this.get("editor").toolBarDiv;this.el=new c({container:e,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new g(this.get("type"));this._init()}var t=x.whitespaces(true),b=x.bookmark(false,true);r.augment(g,{exec:function(e){for(var f=e.getSelection(),l=f&&f.getRanges()[0],k=l.startContainer,a=l.endContainer,d=l.getCommonAncestor();d&&!(d[0].nodeType==h.NODE_ELEMENT&&z[d._4e_name()]);)d=d.parent();if(d&&
k[0].nodeType==h.NODE_ELEMENT&&k._4e_name()in z){k=new x(l);k.evaluator=i;l.startContainer=k.next()}if(d&&a[0].nodeType==h.NODE_ELEMENT&&a._4e_name()in z){k=new x(l);k.evaluator=i;l.endContainer=k.previous()}a=f.createBookmarks(true);if(d){for(k=d._4e_first();k&&k[0]&&k._4e_name()!="li";)k=k.next();var o=l.startContainer;(k[0]==o[0]||k._4e_contains(o))&&n.call(this,e,d)||j.call(this,e,l,d)}else q.call(this,e,l);f.selectBookmarks(a)}});var c=s.TripleButton;m.ATTRS={type:{},contentCls:{},editor:{}};
r.extend(m,r.Base,{_init:function(){var e=this.get("editor"),f=this.el;f.on("offClick",this.exec,this);this.get("type")=="outdent"?e.on("selectionChange",this._selectionChange,this):f.set("state",c.OFF)},exec:function(){var e=this.get("editor"),f=this;e.fire("save");setTimeout(function(){f.indentCommand.exec(e);e.fire("save");e.notifySelectionChange()},10)},_selectionChange:function(e){this.get("editor");this.get("type");var f=e.path,l=f.blockLimit;e=this.el;if(f.contains(z))e.set("state",c.OFF);
else(f=f.block||l)&&f._4e_style(this.indentCommand.indentCssProperty)?e.set("state",c.OFF):e.set("state",c.DISABLED)}});s.Indent=m}();w.addPlugin(function(){w.addCommand("outdent",new s.Indent({editor:w,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));w.addCommand("indent",new s.Indent({editor:w,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(w){var s=KISSY.Editor,z=KISSY,r=s.TripleButton;s.Justify||function(){function x(p,u,h,g){this.editor=p;this.v=u;this.contentCls=g;this.title=h;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;z.augment(x,{_init:function(){var p=this.editor;this.el=new r({contentCls:this.contentCls,title:this.title,container:p.toolBarDiv});p.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var p=this.editor,u=p.getSelection(),
h=this.el.get("state");if(u){var g=u.createBookmarks(),i=u.getRanges(),j,q;p.fire("save");for(var n=i.length-1;n>=0;n--){j=i[n].createIterator();for(j.enlargeBr=true;q=j.getNextParagraph();){q.removeAttr("align");h==r.OFF?q.css("text-align",this.v):q.css("text-align","")}}p.notifySelectionChange();u.selectBookmarks(g);p.fire("save")}},_selectionChange:function(p){var u=this.el;p=p.path;if(p=p.block||p.blockLimit){p=p.css("text-align").replace(B,"");p==this.v||!p&&this.v=="left"?u.set("state",r.ON):
u.set("state",r.OFF)}}});s.Justify=x}();w.addPlugin(function(){new s.Justify(w,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new s.Justify(w,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new s.Justify(w,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(w){var s=KISSY.Editor;s.Link||function(){function z(q){this.editor=q;this._init()}function r(q){return q._4e_ascendant(function(n){return n._4e_name()==="a"&&!!n.attr("href")},true)}var x=KISSY,B=s.TripleButton,p=s.Style,u=x.Node,h=s.Range,g=s.SimpleOverlay,i=s.BubbleView,j={element:"a",attributes:{href:"#(href)",target:"#(target)"}};z.init=function(){var q=new g({title:"\u94fe\u63a5\u5c5e\u6027",mask:true,width:"300px"});this.dialog=q;q.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input class='ke-link-url' style='width:220px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
q.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");q.urlEl=q.body.one(".ke-link-url");q.targetEl=q.body.one(".ke-link-blank");var n=q.foot.one(".ke-link-cancel");q.foot.one(".ke-link-ok").on("click",function(m){q.link._link();m.halt()},this);n.on("click",function(m){q.hide();m.halt()},this);z.init=null};i.register({pluginName:"link",func:r,init:function(){var q=this,n=q.el;n.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var m=n.one(".ke-bubbleview-url"),t=n.one(".ke-bubbleview-change");n=n.one(".ke-bubbleview-remove");t._4e_unselectable();m._4e_unselectable();n._4e_unselectable();t.on("click",function(b){q._plugin.show();b.halt()});n.on("click",function(b){var c=q._plugin;c._removeLink(q._selectedEl);c.editor.notifySelectionChange();b.halt()});q.on("afterVisibleChange",function(){var b=q._selectedEl;if(b){m.html(b.attr("href"));m.attr("href",b.attr("href"))}})}});x.augment(z,{_init:function(){this.el=new B({container:this.editor.toolBarDiv,
contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5 "});this.el.on("click",this.show,this);i.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(q){var n=this.editor,m={href:q.attr("href")};if(q._4e_hasAttribute("target"))m.target=q.attr("target");q=new p(j,m);n.fire("save");q.remove(n.document);n.fire("save")},_getSelectedLink:function(){var q=this.editor.getSelection();if(q=q&&q.getStartElement())q=r(q);return q},_link:function(){var q,n=this.editor,m=z.dialog,t=m.urlEl.val(),
b;if(x.trim(t)){m.hide();if(b=this._getSelectedLink()){q=new h(n.document);q.selectNodeContents(b);n.getSelection().selectRanges([q]);this._removeLink(b)}b={href:t};b.target=m.targetEl[0].checked?"_blank":"_self";q=n.getSelection().getRanges()[0];if(q.collapsed){q=new u("<a href='"+t+"' target='"+b.target+"'>"+t+"</a>",null,n.document);n.insertElement(q)}else{n.fire("save");q=new p(j,b);q.apply(n.document);n.fire("save")}n.notifySelectionChange()}},_prepare:function(){z.init&&z.init()},_real:function(){var q=
z.dialog,n=this._getSelectedLink();q.link=this;if(n){q.urlEl.val(n.attr("href"));q.targetEl[0].checked=n.attr("target")=="_blank"}q.show()},show:function(){this._prepare()}});s.Utils.lazyRun(z.prototype,"_prepare","_real");s.Link=z}();w.addPlugin(function(){new s.Link(w)})});
KISSY.Editor.add("list",function(w){var s=KISSY.Editor,z={ol:1,ul:1},r=["ol","ul"],x=KISSY,B=s.RANGE,p=s.ElementPath,u=s.Walker,h=s.NODE,g=x.UA,i=x.Node,j=x.DOM;s.List||function(){function q(c){this.type=c}function n(c){n.superclass.constructor.call(this,c);c=this.get("editor").toolBarDiv;this.el=new b({contentCls:this.get("contentCls"),title:this.get("title"),container:c});this.listCommand=new q(this.get("type"));this.listCommand.state=this.get("status");this._init()}var m={listToArray:function(c,
e,f,l,k){if(!z[c._4e_name()])return[];l||(l=0);f||(f=[]);for(var a=0,d=c[0].childNodes.length;a<d;a++){var o=new i(c[0].childNodes[a]);if(o._4e_name()=="li"){var y={parent:c,indent:l,element:o,contents:[]};if(k)y.grandparent=k;else{y.grandparent=c.parent();if(y.grandparent&&y.grandparent._4e_name()=="li")y.grandparent=y.grandparent.parent()}e&&o._4e_setMarker(e,"listarray_index",f.length);f.push(y);for(var v=0,C=o[0].childNodes.length,H;v<C;v++){H=new i(o[0].childNodes[v]);H[0].nodeType==h.NODE_ELEMENT&&
z[H._4e_name()]?m.listToArray(H,e,f,l+1,y.grandparent):y.contents.push(H)}}}return f},arrayToList:function(c,e,f,l){f||(f=0);if(!c||c.length<f+1)return null;for(var k=c[f].parent[0].ownerDocument,a=k.createDocumentFragment(),d=null,o=f,y=Math.max(c[f].indent,0),v=null;;){var C=c[o];if(C.indent==y){if(!d||c[o].parent._4e_name()!=d._4e_name()){d=c[o].parent._4e_clone(false,true);a.appendChild(d[0])}v=d[0].appendChild(C.element._4e_clone(false,true)[0]);for(var H=0;H<C.contents.length;H++)v.appendChild(C.contents[H]._4e_clone(true,
true)[0]);o++}else if(C.indent==Math.max(y,0)+1){o=m.arrayToList(c,null,o,l);v.appendChild(o.listNode);o=o.nextIndex}else if(C.indent==-1&&!f&&C.grandparent){v=z[C.grandparent._4e_name()]?C.element._4e_clone(false,true)[0]:C.grandparent._4e_name()!="td"?k.createElement(l):k.createDocumentFragment();for(H=0;H<C.contents.length;H++)v.appendChild(C.contents[H]._4e_clone(true,true)[0]);if(v.nodeType==h.NODE_DOCUMENT_FRAGMENT&&o!=c.length-1){v.lastChild&&v.lastChild.nodeType==h.NODE_ELEMENT&&v.lastChild.getAttribute("type")==
"_moz"&&j._4e_remove(v.lastChild);j._4e_appendBogus(v)}if(v.nodeType==h.NODE_ELEMENT&&j._4e_name(v)==l&&v.firstChild){j._4e_trim(v);d=v.firstChild;if(d.nodeType==h.NODE_ELEMENT&&j._4e_isBlockBoundary(d)){d=k.createDocumentFragment();j._4e_moveChildren(v,d);v=d}}d=j._4e_name(v);if(!g.ie&&(d=="div"||d=="p"))j._4e_appendBogus(v);a.appendChild(v);d=null;o++}else return null;if(c.length<=o||Math.max(c[o].indent,0)<y)break}if(e)for(c=new i(a.firstChild);c&&c[0];){c[0].nodeType==h.NODE_ELEMENT&&c._4e_clearMarkers(e,
true);c=c._4e_nextSourceNode()}return{listNode:a,nextIndex:o}}},t=/^h[1-6]$/;q.prototype={changeListType:function(c,e,f,l){var k=m.listToArray(e.root,f),a=[];for(c=0;c<e.contents.length;c++){var d=e.contents[c];d=d._4e_ascendant("li",true);if(!(!d||!d[0]||d._4e_getData("list_item_processed"))){a.push(d);d._4e_setMarker(f,"list_item_processed",true)}}d=new i(e.root[0].ownerDocument.createElement(this.type));for(c=0;c<a.length;c++){var o=a[c]._4e_getData("listarray_index");k[o].parent=d}f=m.arrayToList(k,
f,null,"p");var y;k=f.listNode.childNodes.length;for(c=0;c<k&&(y=new i(f.listNode.childNodes[c]));c++)y._4e_name()==this.type&&l.push(y);j.insertBefore(f.listNode,e.root[0]);e.root._4e_remove()},createList:function(c,e,f){var l=e.contents;c=e.root[0].ownerDocument;var k=[];if(l.length==1&&l[0][0]===e.root[0]){var a=new i(c.createElement("div"));l[0][0].nodeType!=h.NODE_TEXT&&l[0]._4e_moveChildren(a);l[0][0].appendChild(a[0]);l[0]=a}e=e.contents[0].parent();for(a=0;a<l.length;a++)e=e._4e_commonAncestor(l[a].parent());
for(a=0;a<l.length;a++)for(var d=l[a],o;o=d.parent();){if(o[0]===e[0]){k.push(d);break}d=o}if(!(k.length<1)){l=new i(k[k.length-1][0].nextSibling);a=new i(c.createElement(this.type));for(f.push(a);k.length;){f=k.shift();d=new i(c.createElement("li"));if(t.test(f._4e_name()))d[0].appendChild(f[0]);else{f._4e_copyAttributes(d);f._4e_moveChildren(d);f._4e_remove()}a[0].appendChild(d[0]);g.ie||d._4e_appendBogus()}l[0]?j.insertBefore(a[0],l[0]):e[0].appendChild(a[0])}},removeList:function(c,e,f){function l(H){if((v=
new i(y[H?"firstChild":"lastChild"]))&&!(v[0].nodeType==h.NODE_ELEMENT&&v._4e_isBlockBoundary())&&(C=e.root[H?"_4e_previous":"_4e_next"](u.whitespaces(true)))&&!(v[0].nodeType==h.NODE_ELEMENT&&C._4e_isBlockBoundary({br:1})))j[H?"insertBefore":"insertAfter"](c.document.createElement("br"),v[0])}for(var k=m.listToArray(e.root,f),a=[],d=0;d<e.contents.length;d++){var o=e.contents[d];o=o._4e_ascendant("li",true);if(!(!o||o._4e_getData("list_item_processed"))){a.push(o);o._4e_setMarker(f,"list_item_processed",
true)}}o=null;for(d=0;d<a.length;d++){o=a[d]._4e_getData("listarray_index");k[o].indent=-1;o=o}for(d=o+1;d<k.length;d++)if(k[d].indent>Math.max(k[d-1].indent,0)){a=k[d-1].indent+1-k[d].indent;for(o=k[d].indent;k[d]&&k[d].indent>=o;){k[d].indent+=a;d++}d--}var y=m.arrayToList(k,f,null,"p").listNode,v,C;l(true);l();j.insertBefore(y,e.root);e.root._4e_remove()},exec:function(c){var e=c.getSelection(),f=e&&e.getRanges();if(!(!f||f.length<1)){for(var l=e.createBookmarks(true),k=[],a={};f.length>0;){var d=
f.shift(),o=d.getBoundaryNodes(),y=o.startNode,v=o.endNode;y[0].nodeType==h.NODE_ELEMENT&&y._4e_name()=="td"&&d.setStartAt(o.startNode,B.POSITION_AFTER_START);v[0].nodeType==h.NODE_ELEMENT&&v._4e_name()=="td"&&d.setEndAt(o.endNode,B.POSITION_BEFORE_END);d=d.createIterator();for(d.forceBrBreak=false;o=d.getNextParagraph();){y=new p(o);v=y.elements;var C=null,H=false,A=y.blockLimit,D;for(y=v.length-1;y>=0&&(D=v[y]);y--)if(z[D._4e_name()]&&A.contains(D)){A._4e_removeData("list_group_object");if(y=D._4e_getData("list_group_object"))y.contents.push(o);
else{y={root:D,contents:[o]};k.push(y);D._4e_setMarker(a,"list_group_object",y)}H=true;break}if(!H)if(A._4e_getData("list_group_object"))A._4e_getData("list_group_object").contents.push(o);else{y={root:A,contents:[o]};A._4e_setMarker(a,"list_group_object",y);k.push(y)}}}for(f=[];k.length>0;){y=k.shift();if(this.state=="off")z[y.root._4e_name()]?this.changeListType(c,y,a,f):this.createList(c,y,f);else this.state=="on"&&z[y.root._4e_name()]&&this.removeList(c,y,a)}for(y=0;y<f.length;y++){C=f[y];var I=
this;(c=function(J){var N=C[J?"_4e_previous":"_4e_next"](u.whitespaces(true));if(N&&N[0]&&N._4e_name()==I.type){N._4e_remove();N._4e_moveChildren(C,J?true:false)}})();c(true)}s.Utils.clearAllMarkers(a);e.selectBookmarks(l)}}};var b=s.TripleButton;n.ATTRS={editor:{},type:{},contentCls:{}};x.extend(n,x.Base,{_init:function(){var c=this,e=c.get("editor"),f=c.el;c=c;f.on("click",c._change,c);e.on("selectionChange",c._selectionChange,c)},_change:function(){var c=this.get("editor");this.get("type");var e=
this.el;c.fire("save");this.listCommand.state=e.get("state");this.listCommand.exec(c);c.fire("save");c.notifySelectionChange()},_selectionChange:function(c){this.get("editor");var e=this.get("type"),f=c.path,l;c=this.el;var k=f.blockLimit;if(f=f.elements)for(var a=0;a<f.length&&(l=f[a])&&l[0]!==k[0];a++){var d=x.indexOf(f[a]._4e_name(),r);if(d!==-1)if(r[d]===e){c.set("state",b.ON);return}else break}c.set("state",b.OFF)}});s.ListUtils=m;s.List=n}();w.addPlugin(function(){new s.List({editor:w,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new s.List({editor:w,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(w){var s=KISSY.Editor,z=KISSY,r=z.UA,x=z.Node,B=z.Event,p=s.TripleButton,u=z.DOM,h;s.Maximize||function(){function g(i){this.editor=i;this._init()}g.init=function(){h=new x("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(h[0]);g.init=null};z.augment(g,{_init:function(){this.el=new p({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);s.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var i=this,j=i.editor;B.remove(window,"resize",i._maximize,i);this._saveEditorStatus();j.wrap.css({height:i.iframeHeight});(new x(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";j.editorWrap.css({position:"static",width:i.editorWrapWidth});h.css({left:"-99999px",top:"-99999px"});window.scrollTo(i.scrollLeft,
i.scrollTop);i.el.set("state",p.OFF);setTimeout(function(){i._restoreEditorStatus()},30);j.notifySelectionChange()},_saveSate:function(){var i=this.editor;this.iframeHeight=i.wrap._4e_style("height");this.editorWrapWidth=i.editorWrap._4e_style("width");this.scrollLeft=u.scrollLeft();this.scrollTop=u.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var i=this.editor;if(r.gecko&&i.iframeFocus)this.savedRanges=(i=i.getSelection())&&i.getRanges()},_restoreEditorStatus:function(){var i=this.editor,
j=i.getSelection();if(r.gecko&&i.iframeFocus){this.el.el[0].focus();i.focus();this.savedRanges&&j&&j.selectRanges(this.savedRanges)}if(i.iframeFocus&&j)(i=j.getStartElement())&&i[0]&&i._4e_scrollIntoView()},_maximize:function(){var i=this.editor,j=u.viewportHeight(),q=u.viewportWidth(),n=i.statusDiv?i.statusDiv.height():0,m=i.toolBarDiv.height();if(r.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new x(document.body)).css({width:0,height:0,overflow:"hidden"});
i.editorWrap.css({position:"absolute",zIndex:990,width:q+"px"});h.css({zIndex:985,height:j+"px",width:q+"px"});i.editorWrap.offset({left:0,top:0});h.css({left:0,top:0});i.wrap.css({height:j-n-m-14+"px"});i.notifySelectionChange()},_real:function(){var i=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",i._maximize,i);this.el.set("state",p.ON);setTimeout(function(){i._restoreEditorStatus()},30)},_prepare:function(){g.init&&g.init()},maximize:function(){this._prepare()}});
s.Maximize=g}();w.addPlugin(function(){new s.Maximize(w)})});
KISSY.Editor.add("music",function(w){function s(i){return i.indexOf(p)!=-1}var z=KISSY.Editor,r=KISSY,x=z.Flash,B="ke_music",p="niftyplayer.swf",u=z.Utils.getFlashUrl,h=w.htmlDataProcessor,g=h&&h.dataFilter;g&&g.addRules({elements:{object:function(i){var j=i.attributes;if(!(j.classid&&String(j.classid).toLowerCase())){for(j=0;j<i.children.length;j++)if(i.children[j].name=="embed"){if(!x.isFlashEmbed(i.children[j]))return null;if(s(i.children[j].attributes.src))return h.createFakeParserElement(i,B,
"music",true)}return null}for(j=0;j<i.children.length;j++){var q=i.children[j];if(q.name=="param"&&q.attributes.name=="movie")if(s(q.attributes.value))return h.createFakeParserElement(i,B,"music",true)}},embed:function(i){if(!x.isFlashEmbed(i))return null;if(s(i.attributes.src))return h.createFakeParserElement(i,B,"music",true)}}},4);z.MusicInserter||function(){function i(){i.superclass.constructor.apply(this,arguments)}function j(e){return e._4e_name()==="img"&&!!e.hasClass(B)&&e}function q(e){return e.replace(/^.+niftyplayer\.swf\?file=/,
"")}var n=z.Config.base+"plugins/music/niftyplayer.swf?file=#(music)",m="<p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3'/></label></p><p style='margin:5px 0'><label>\u5bf9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u9f50\uff1a <select class='ke-music-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
z.Utils.duplicateStr("&nbsp;",1)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-music-margin' style='width:90px' value='5'/> px</label><p>",t=/#\(music\)/g,b=["img."+B];r.extend(i,x,{_config:function(){this._cls=B;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml=m;this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=
c;this._flashRules=b},_initD:function(){var e=this,f=e.d;e.dUrl=f.el.one(".ke-music-url");e.dAlign=f.el.one(".ke-music-align");e.dMargin=f.el.one(".ke-music-margin");var l=f.el.one(".ke-music-ok");f=f.el.one(".ke-music-cancel");l.on("click",e._gen,e);f.on("click",function(){e.d.hide()})},_getDInfo:function(){return{url:n.replace(t,this.dUrl.val()),attrs:{width:165,height:37,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}},_getFlashUrl:function(e){return q(u(e))},
_updateD:function(){var e=this.editor,f=this.selectedFlash;if(f){e=e.restoreRealElement(f);this.dUrl.val(this._getFlashUrl(e));this.dAlign.val(f.attr("align"));this.dMargin.val(parseInt(e._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3");this.dAlign.val("");this.dMargin.val("5")}}});x.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",j);z.MusicInserter=i;var c={"\u97f3\u4e50\u5c5e\u6027":function(e){var f=e.getSelection();f=(f=f&&f.getStartElement())&&
j(f);e=e._toolbars.music;f&&e.show(null,f)}}}();w.addPlugin(function(){new z.MusicInserter(w)})});
KISSY.Editor.add("preview",function(w){var s=KISSY.Editor,z=KISSY,r=s.TripleButton;s.Preview||function(){function x(B){this.editor=B;this._init()}z.augment(x,{_init:function(){this.el=new r({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,p=640,u=420,h=80;try{var g=window.screen;p=Math.round(g.width*0.8);u=Math.round(g.height*0.7);h=Math.round(g.width*0.1)}catch(i){}B=
B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+B.getData()+"\n</body>");p=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+p+",height="+u+",left="+h);p.document.open();p.document.write(B);p.document.close()}});s.Preview=x}();w.addPlugin(function(){new s.Preview(w)})});
KISSY.Editor.add("removeformat",function(w){function s(j){this.editor=j;this._init()}function z(j,q){for(var n=0;n<q.length;n++)j.removeAttr(q[n])}var r=KISSY.Editor,x=KISSY,B=r.RANGE,p=r.ElementPath,u=r.NODE,h=r.TripleButton,g="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",i="class,style,lang,width,height,align,hspace,valign".split(",");g=new RegExp("^(?:"+g.replace(/,/g,"|")+")$","i");x.augment(s,{_init:function(){this.el=new h({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var j=this.editor,q=g;q.lastIndex=0;var n=j.getSelection().getRanges();j.fire("save");for(var m=0,t;t=n[m];m++)if(!t.collapsed){t.enlarge(B.ENLARGE_ELEMENT);var b=t.createBookmark(),c=b.startNode,e=b.endNode,f=function(l){for(var k=new p(l),a=k.elements,d=1,o;o=a[d];d++){if(o._4e_equals(k.block)||o._4e_equals(k.blockLimit))break;q.test(o._4e_name())&&l._4e_breakParent(o)}};
f(c);f(e);for(c=c._4e_nextSourceNode(true,u.NODE_ELEMENT);c;){if(c._4e_equals(e))break;f=c._4e_nextSourceNode(false,u.NODE_ELEMENT);c._4e_name()=="img"&&c.attr("_cke_realelement")||(q.test(c._4e_name())?c._4e_remove(true):z(c,i));c=f}t.moveToBookmark(b)}j.getSelection().selectRanges(n);j.fire("save")}});w.addPlugin(function(){new s(w)})});
KISSY.Editor.add("resize",function(w){var s=KISSY,z=s.Editor,r=s.Node;z.Resizer||function(){function x(p){this.editor=p;this._init()}var B=z.Draggable;s.augment(x,{_init:function(){var p=this.editor,u=p.statusDiv,h=new r("<div class='ke-resizer'></div>");h.appendTo(u);u=new B({node:h});var g=0,i=0,j=p.wrap,q=p.editorWrap;u.on("start",function(){g=j.height();i=q.width()});u.on("move",function(n){var m=n.pageX-this.startMousePos.left;j.height(g+(n.pageY-this.startMousePos.top));q.width(i+m)})}});z.Resizer=
x}();w.addPlugin(function(){new z.Resizer(w)})});
KISSY.Editor.add("smiley",function(w){var s=KISSY.Editor,z=KISSY,r=z.DOM,x=z.Event,B=z.Node,p=s.SimpleOverlay,u=s.TripleButton;s.Smiley||function(){function h(j){this.editor=j;this._init()}for(var g="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",i=0;i<=98;i++)g+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+i+".gif'></a>";g+="</div></div>";z.augment(h,{_init:function(){this.el=new u({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(j){var q=this;r._4e_ascendant(j.target,function(n){return n[0]===q.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(j){j.halt();var q=this.editor;j=j.target;var n;if(r._4e_name(j)=="a"&&(n=r.attr(j,"data-icon"))){n=new B("<img alt='' style='width:52px;height:48px;' src='"+n+"'/>",null,q.document);q.insertElement(n);this.smileyWin.hide()}},_prepare:function(){var j=this.editor;this.smileyPanel=
new B(g);this.smileyWin=new p({el:this.smileyPanel,focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);x.on(document,"click",this._hidePanel,this);x.on(j.document,"click",this._hidePanel,this)},_real:function(){var j=this.el.el.offset();j.top+=this.el.el.height()+5;if(j.left+this.smileyPanel.width()>r.viewportWidth()-60)j.left=r.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(j)},_show:function(j){this._prepare(j)}});
s.Smiley=h}();w.addPlugin(function(){new s.Smiley(w)})});
KISSY.Editor.add("sourcearea",function(w){var s=KISSY.Editor,z=KISSY,r=z.UA,x=s.TripleButton;s.SourceArea||function(){function B(p){this.editor=p;this._init()}z.augment(B,{_init:function(){var p=this.editor;this.el=new x({container:p.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);p.textarea.on("mousedown",function(u){u.stopPropagation()})},_show:function(){var p=this.editor,u=
this.el;p.textarea.val(p.getData());p._showSource();u.set("state",x.ON)},_hide:function(){var p=this.editor,u=p.textarea,h=this.el;p._hideSource();p.setData(u.val());if(r.gecko&&p.iframeFocus){h.el[0].focus();p.focus()}h.set("state",x.OFF)}});s.SourceArea=B}();w.addPlugin(function(){new s.SourceArea(w)})});
KISSY.Editor.add("table",function(w,s){var z=KISSY.Editor,r=KISSY,x=r.Node,B=r.DOM,p=z.Walker,u=r.UA,h=z.NODE,g=z.TripleButton,i=z.SimpleOverlay,j=z.ContextMenu,q=["tr","th","td","tbody","table"],n=r.trim,m;m=(u.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var t=w.htmlDataProcessor,b=t&&t.dataFilter;t=t&&t.htmlFilter;b&&b.addRules({elements:{table:function(c){c=c.attributes;var e=c["class"],f=parseInt(c.border,10);if(!f||f<=0)c["class"]=(e||"")+" ke_show_border"}}});t&&t.addRules({elements:{table:function(c){c=c.attributes;var e=c["class"];if(e)c["class"]=r.trim(e.replace("ke_show_border","").replace(/\s{2}/," "))}}});z.TableUI||function(){function c(A){this.editor=A;this.selectedTable=
null;A._toolbars=A._toolbars||{};A._toolbars.table=this;this._init()}function e(A){return n(A).length!=0}function f(A){function D($){if(!(N.length>0))if($[0].nodeType==h.NODE_ELEMENT&&C.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var I=A.createBookmarks(),J=A.getRanges(),N=[],M={},Q=0;Q<J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new p(R);
var W;for(R.guard=D;W=R.next();)if((W=W.parent())&&C.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}z.Utils.clearAllMarkers(M);A.selectBookmarks(I);return N}function l(A){A=A.cells;for(var D=0;D<A.length;D++){A[D].innerHTML="";u.ie||(new x(A[D]))._4e_appendBogus()}}function k(A,D){if(A=A.getStartElement()._4e_ascendant("tr")){var I=A._4e_clone(true);I.insertBefore(A);l(D?I[0]:A[0])}}function a(A){if(A instanceof z.Selection){var D=f(A),I=D.length;
A=[];for(var J,N,M=0;M<I;M++){var Q=D[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);A[R]=Q;M==I-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new x(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=A.length;M>=0;M--)A[M]&&a(A[M]);return J}else if(A instanceof x){M=A._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():A._4e_remove()}return 0}function d(A,D){A=A.getStartElement();if(A=A._4e_ascendant("td",true)||A._4e_ascendant("th",true))for(var I=A._4e_ascendant("table"),J=A[0].cellIndex,
N=0;N<I[0].rows.length;N++){var M=I[0].rows[N];if(!(M.cells.length<J+1)){A=new x(M.cells[J].cloneNode(false));u.ie||A._4e_appendBogus();M=new x(M.cells[J]);D?A.insertBefore(M):A.insertAfter(M)}}}function o(A){var D=[],I=A[0]&&A[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=A.length;J<N;J++)D.push(A[J][0].cellIndex);D.sort();J=1;for(N=D.length;J<N;J++)if(D[J]-D[J-1]>1){M=D[J-1]+1;break}M||(M=D[0]>0?D[0]-1:D[D.length-1]+1);A=I[0].rows;J=0;for(N=A.length;J<N;J++)if(Q=A[J].cells[M])break;return Q?new x(Q):
I._4e_previous()}function y(A){if(A instanceof z.Selection){var D=f(A),I=o(D);for(A=D.length-1;A>=0;A--)D[A]&&y(D[A]);return I}else if(A instanceof x){D=A._4e_ascendant("table");if(!D)return null;I=A[0].cellIndex;for(A=D[0].rows.length-1;A>=0;A--){var J=new x(D[0].rows[A]);if(!I&&J[0].cells.length==1)a(J);else J[0].cells[I]&&J[0].removeChild(J[0].cells[I])}}return null}function v(A,D){var I=new z.Range(A[0].ownerDocument);if(!I.moveToElementEditablePosition(A,D?true:s)){I.selectNodeContents(A);I.collapse(D?
false:true)}I.select(true)}r.augment(c,{_init:function(){var A=this.editor,D={};this.el=new g({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:A.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in H)(function(J){D[J]=function(){A.fire("save");H[J](A);A.fire("save")}})(I);j.register(A.document,{rules:q,width:"120px",funcs:D});z.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var A=this,D=new i({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});
D.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
D.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");D.twidth=D.body.one(".ke-table-width");D.theight=D.body.one(".ke-table-height");D.tcellspacing=D.body.one(".ke-table-cellspacing");D.tcellpadding=D.body.one(".ke-table-cellpadding");D.tborder=D.body.one(".ke-table-border");D.tcaption=D.body.one(".ke-table-caption");D.talign=D.body.one(".ke-table-align");D.trows=D.body.one(".ke-table-rows");D.tcols=D.body.one(".ke-table-cols");D.thead=
D.body.one(".ke-table-head");var I=D.foot.one(".ke-table-ok"),J=D.foot.one(".ke-table-cancel");D.twidthunit=D.body.one(".ke-table-width-unit");A.tableDialog=D;I.on("click",A._tableOk,A);D.on("hide",function(){A.selectedTable=null});J.on("click",function(){D.hide()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var A=this.tableDialog,D=this.selectedTable,I=D.one("caption");e(A.talign.val())&&D.attr("align",n(A.talign.val()));e(A.tcellspacing.val())&&
D.attr("cellspacing",n(A.tcellspacing.val()));e(A.tcellpadding.val())&&D.attr("cellpadding",n(A.tcellpadding.val()));e(A.tborder.val())&&D.attr("border",n(A.tborder.val()));!e(A.tborder.val())||A.tborder.val()=="0"?D.addClass("ke_show_border"):D.removeClass("ke_show_border");e(A.twidth.val())&&D.css("width",n(A.twidth.val())+A.twidthunit.val());e(A.theight.val())&&D.css("height",n(A.theight.val()));if(e(A.tcaption.val()))I&&I[0]?I.html(n(A.tcaption.val())):(new x("<caption><span>"+n(A.tcaption.val())+
"</span></caption>")).insertBefore(D[0].firstChild);else I&&I._4e_remove();A.hide()},_genTable:function(){var A=this.tableDialog,D="<table ",I,J=parseInt(A.tcols.val())||1,N=parseInt(A.trows.val())||1,M=u.ie?"":"<br/>",Q=this.editor;if(r.trim(A.talign.val()).length!=0)D+="align='"+r.trim(A.talign.val())+"' ";if(r.trim(A.tcellspacing.val()).length!=0)D+="cellspacing='"+r.trim(A.tcellspacing.val())+"' ";if(r.trim(A.tcellpadding.val()).length!=0)D+="cellpadding='"+r.trim(A.tcellpadding.val())+"' ";if(r.trim(A.tborder.val()).length!=
0)D+="border='"+r.trim(A.tborder.val())+"' ";if(r.trim(A.twidth.val()).length!=0||r.trim(A.theight.val()).length!=0){D+="style='";if(r.trim(A.twidth.val()).length!=0)D+="width:"+r.trim(A.twidth.val())+A.twidthunit.val()+";";if(r.trim(A.theight.val()).length!=0)D+="height:"+r.trim(A.theight.val())+"px;";D+="' "}if(r.trim(A.tborder.val()).length==0||r.trim(A.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(r.trim(A.tcaption.val()))D+="<caption><span>"+r.trim(A.tcaption.val())+"</span></caption>";
if(A.thead.val()){D+="<thead>";D+="<tr>";for(I=0;I<J;I++)D+="<th>"+M+"</th>";D+="</tr>";D+="</thead>";N-=1}D+="<tbody>";for(var R=0;R<N;R++){D+="<tr>";for(I=0;I<J;I++)D+="<td>"+M+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new x(D,null,Q.document);Q.insertElement(D);A.hide()},_fillTableDialog:function(){var A=this.tableDialog,D=this.selectedTable,I=D.one("caption");A.talign.val(D.attr("align")||"");A.tcellspacing.val(D.attr("cellspacing")||"");A.tcellpadding.val(D.attr("cellpadding")||"");A.tborder.val(D.attr("border")|
"");var J=D._4e_style("width")||"";A.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?A.twidthunit.val("%"):A.twidthunit.val("px");A.theight.val((D._4e_style("height")||"").replace(/px|%/i,""));J="";if(I)J=I.text();A.tcaption.val(J);A.trows.val(D.one("tbody").children().length);A.tcols.val(D.one("tr").children().length);A.thead.val(D._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled",
"disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var C=/^(?:td|th)$/,H={"\u8868\u683c\u5c5e\u6027":function(A){var D=A.getSelection();if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",true)){A=A._toolbars.table;A.selectedTable=D;A._tableShow()}},"\u5220\u9664\u8868\u683c":function(A){var D=(A=A.getSelection())&&A.getStartElement();
if(D=D&&D._4e_ascendant("table",true)){A.selectElement(D);var I=A.getRanges()[0];I.collapse();A.selectRanges([I]);A=D.parent();A[0].childNodes.length==1&&A._4e_name()!="body"?A._4e_remove():D._4e_remove()}},"\u5220\u9664\u884c ":function(A){A=A.getSelection();v(a(A),s)},"\u5220\u9664\u5217 ":function(A){A=A.getSelection();(A=y(A))&&v(A,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(A){A=A.getSelection();k(A,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(A){A=A.getSelection();k(A,s)},
"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(A){A=A.getSelection();d(A,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(A){A=A.getSelection();d(A,s)}};z.TableUI=c}();w.addPlugin(function(){var c=w.document;new z.TableUI(w);var e=B.create("<style>",null,c);c.getElementsByTagName("head")[0].appendChild(e);if(e.styleSheet)e.styleSheet.cssText=m;else e.appendChild(c.createTextNode(m))})});
KISSY.Editor.add("templates",function(w){var s=KISSY.Editor,z=KISSY,r=z.Node,x=s.TripleButton,B=s.SimpleOverlay;s.TplUI||function(){function p(u){this.editor=u;this._init()}z.augment(p,{_init:function(){(new x({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var u=this.editor,h=u.cfg.pluginConfig.templates,g="<div class='ke-tpl'>",i=0;i<h.length;i++)g+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
h[i].demo+"</a>";g+="</div>";this._initDialogOk=true;var j=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});j.body.html(g);j.body.all(".ke-tpl-list").on("click",function(q){q.halt();q=(new r(q.target))._4e_index();q!=-1&&u.insertHtml(h[q].html);j.hide()});this.ui=j},_real:function(){this.ui.show()},_show:function(){this._prepare()}});s.TplUI=p}();w.addPlugin(function(){new s.TplUI(w)})});
KISSY.Editor.add("undo",function(w){var s=KISSY.Editor,z=KISSY,r=s.Utils.arrayCompare,x=z.UA,B=z.Event;s.UndoManager||function(){function p(m){var t=m._getRawData();m=t&&m.getSelection();this.contents=t;this.bookmarks=m&&m.createBookmarks2(true)}function u(m,t,b){this.s=m;this.fn=t;this.scope=b||window;this.bufferTimer=null}function h(m){this.history=[];this.index=0;this.editor=m;this.bufferTimer=new u(500,this.save,this);this._init()}function g(m,t,b,c){this.editor=m;this.title=b;this.text=t;this.contentCls=
c;this._init()}z.augment(p,{equals:function(m){if(this.contents!=m.contents)return false;var t=this.bookmarks;m=m.bookmarks;if(t||m){if(!t||!m||t.length!=m.length)return false;for(var b=0;b<t.length;b++){var c=t[b],e=m[b];if(c.startOffset!=e.startOffset||c.endOffset!=e.endOffset||!r(c.start,e.start)||!r(c.end,e.end))return false}}return true}});z.augment(u,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var m=this;this.bufferTimer=setTimeout(function(){m.fn.call(m.scope)},
this.s)}});var i={16:1,17:1,18:1},j={37:1,38:1,39:1,40:1};z.augment(h,{_keyMonitor:function(){var m=this.editor;B.on(m.document,"keydown",function(t){var b=t.keyCode;if(!(b in j||b in i))if(b===90&&(t.ctrlKey||t.metaKey)){m.fire("restore",{d:-1});t.halt()}else if(b===89&&(t.ctrlKey||t.metaKey)){m.fire("restore",{d:1});t.halt()}else m.fire("save",{buffer:1})})},_init:function(){var m=this,t=m.editor;t.on("save",function(b){b.buffer?m.bufferTimer.run():m.save()});t.on("restore",this.restore,this);m._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var m=this.editor,t=this.history.length>0?this.history[this.history.length-1]:null,b=new p(this.editor);if(!t||!t.equals(b)){this.history.length===30&&this.history.shift();this.history.push(b);this.index=this.history.length-1;m.fire("afterSave",{history:this.history,index:this.index})}},restore:function(m){m=m.d;var t=this.editor,b=this.history.length>0?this.history[this.index+m]:null;
if(b){t._setRawData(b.contents);if(b.bookmarks)this.editor.getSelection().selectBookmarks(b.bookmarks);else if(x.ie){b=this.editor.document.body.createTextRange();b.collapse(true);b.select()}this.index+=m;t.fire("afterRestore",{history:this.history,index:this.index});t.notifySelectionChange()}}});var q=s.TripleButton,n={redo:1,undo:-1};z.augment(g,{_init:function(){var m=this,t=m.editor;m.el=new q({contentCls:m.contentCls,title:m.title,container:t.toolBarDiv});this.el.set("state",q.DISABLED);t.on("afterSave",
this._respond,this);t.on("afterRestore",this._respond,this);m.el.on("offClick",function(){t.fire("restore",{d:n[m.text]})})},_respond:function(m){this.updateUI(m.history,m.index)},updateUI:function(m,t){if(this.text=="undo")t>0&&m.length>0?this.el.set("state",q.OFF):this.el.set("state",q.DISABLED);else if(this.text=="redo")t<m.length-1?this.el.set("state",q.OFF):this.el.set("state",q.DISABLED)}});s.UndoManager=h;s.RestoreUI=g}();w.addPlugin(function(){new s.UndoManager(w);new s.RestoreUI(w,"undo",
"\u64a4\u9500","ke-toolbar-undo");new s.RestoreUI(w,"redo","\u91cd\u505a","ke-toolbar-redo")})});
KISSY.Editor.add("bubbleview",function(){function w(h){w.superclass.constructor.apply(this,arguments);h.init&&h.init.call(this)}function s(h){h=u[h];if(!h.bubble)h.bubble=new w(h.cfg);return h.bubble}var z=KISSY.Editor,r=KISSY,x=r.Event,B=r.DOM,p=r.Node;if(!z.BubbleView){var u={};w.attach=function(h){var g=h.pluginInstance,i=h.pluginName;h=g.editor;var j=u[i];if(j){var q=j.cfg.func,n=u[i].bubble;h.on("selectionChange",function(m){m=m.path;var t=m.elements;if(m&&t)if(m=m.lastElement)if(m=q(m)){n=s(i);
n._selectedEl=m;n._plugin=g;n.show()}else if(n){n._selectedEl=n._plugin=null;n.hide()}});x.on(B._4e_getWin(h.document),"scroll blur",function(){n&&n.hide()});x.on(document,"click",function(){n&&n.hide()})}};w.register=function(h){u[h.pluginName]={cfg:h}};w.ATTRS={focusMgr:{value:false}};r.extend(w,z.SimpleOverlay,{_initEl:function(){var h=new p('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>');h.appendTo(document.body);this.el=h;this.set("el",h)},show:function(){var h=this._selectedEl,
g=h._4e_getOffset(document);g.top+=h.height()+5;w.superclass.show.call(this,g)}});z.BubbleView=w}});
KISSY.Editor.add("button",function(){function w(x){w.superclass.constructor.call(this,x);this._init()}var s=KISSY.Editor,z=KISSY,r=z.Node;if(!s.TripleButton){w.ON="on";w.OFF="off";w.DISABLED="disabled";w.ON_CLASS="ke-triplebutton-on";w.OFF_CLASS="ke-triplebutton-off";w.DISABLED_CLASS="ke-triplebutton-disabled";w.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};z.extend(w,z.Base,{_init:function(){var x=this.get("container")[0]||this.get("container");this.el=new r("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));x.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var x=this.get("cls");x&&this.el.addClass(x)},_stateChange:function(x){this["_"+
x.newVal]();this._attachCls()},_action:function(x){this.fire(this.get("state")+"Click",x);this.fire("click",x);x.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});s.TripleButton=w}});
KISSY.Editor.add("contextmenu",function(){function w(g){this.cfg=r.clone(g);z.Utils.lazyRun(this,"_prepareShow","_realShow")}function s(g,i){for(var j=0;j<i.length;j++){var q=i[j];if(r.isFunction(q)){if(q(new x(g)))return true}else if(B.test(g,q))return true}return false}var z=KISSY.Editor,r=KISSY,x=r.Node,B=r.DOM,p=r.Event;if(!z.ContextMenu){var u=[];w.register=function(g,i){var j=new w(i);u.push({doc:g,rules:i.rules||[],instance:j});if(!g.ke_contextmenu){g.ke_contextmenu=1;p.on(g,"mousedown",w.hide);
p.on(g,"contextmenu",function(q){w.hide.call(this);for(var n=new x(q.target);n;){var m=false;if(n._4e_name()=="body")break;for(var t=0;t<u.length;t++){var b=u[t].instance,c=u[t].rules;if(g===u[t].doc&&s(n[0],c)){q.preventDefault();m=true;setTimeout(function(){b.show(z.Utils.getXY(q.pageX,q.pageY,g,document))},30);break}}if(m)break;n=n.parent()}})}return j};w.hide=function(){for(var g=0;g<u.length;g++){var i=u[g].instance;this===u[g].doc&&i.hide()}};var h=z.SimpleOverlay;r.augment(w,{_init:function(){var g=
this,i=g.cfg,j=i.funcs;g.elDom=new x("<div class='ke-menu' onmousedown='return false;'></div>");var q=g.elDom;q.css("width",i.width);document.body.appendChild(q[0]);g.el=new h({el:q});for(var n in j){i=new x("<a href='#'>"+n+"</a>");q[0].appendChild(i[0]);(function(m,t){m._4e_unselectable();m.on("click",function(b){g.hide();b.halt();setTimeout(t,30)})})(i,j[n])}},hide:function(){this.el&&this.el.hide()},_realShow:function(g){this.el.show(g)},_prepareShow:function(){this._init()},show:function(g){this._prepareShow(g)}});
z.ContextMenu=w}});
KISSY.Editor.add("dd",function(){function w(){w.superclass.constructor.apply(this,arguments);this._init()}function s(){s.superclass.constructor.apply(this,arguments);this._init()}function z(){z.superclass.constructor.apply(this,arguments)}var r=KISSY,x=r.Editor,B=r.Event,p=r.DOM,u=r.Node;if(!x.DD){x.DD={};w.ATTRS={timeThred:{},activeDrag:{},drags:{value:{}}};r.extend(w,r.Base,{_init:function(){x.Utils.lazyRun(this,"_prepare","_real")},reg:function(g){var i=this.get("drags");if(!g[0].id)g[0].id=r.guid("drag-");
i[g[0].id]=g;this._prepare()},_move:function(g){var i=this.get("activeDrag");i&&i._move(g)},_start:function(g){this.set("activeDrag",g);this._pg.css({display:"",height:p.docHeight()})},_end:function(g){var i=this.get("activeDrag");if(i){i._end(g);this.set("activeDrag",null);this._pg.css({display:"none"})}},_prepare:function(){this._pg=(new u("<div style='background-color:red;position:absolute;left:0;width:100%;top:0;z-index:9999;'></div>")).appendTo(document.body);this._pg.css("opacity",0);B.on(document,
"mousemove",x.Utils.throttle(this._move,this,10));B.on(document,"mouseup",this._end,this)},_real:function(){}});x.DD.DDM=new w;var h=x.DD.DDM;s.ATTRS={node:{},handlers:{value:{}}};r.extend(s,r.Base,{_init:function(){var g=this.get("node"),i=this.get("handlers");h.reg(g);if(r.isEmptyObject(i))i[g[0].id]=g;for(var j in i){var q=i[j].css("cursor");if(!q||q==="auto")i[j].css("cursor","move");i[j]._4e_unselectable()}g.on("mousedown",this._handleMouseDown,this);g.on("mouseup",function(){h._end()})},_check:function(g){var i=
this.get("handlers");for(var j in i)if(i[j]._4e_equals(g))return true;return false},_handleMouseDown:function(g){if(this._check(new u(g.target))){g.halt();h._start(this);var i=this.get("node"),j=g.pageX;g=g.pageY;i=i.offset();this.startMousePos={left:j,top:g};this.startNodePos=i;this._diff={left:j-i.left,top:g-i.top};this.fire("start")}},_move:function(g){this.fire("move",g)},_end:function(){}});r.extend(z,s,{_init:function(){z.superclass._init.apply(this,arguments);var g=this.get("node"),i=this;
i.on("move",function(j){g.offset({left:j.pageX-i._diff.left,top:j.pageY-i._diff.top})})}});x.Draggable=s;x.Drag=z}});
KISSY.Editor.add("overlay",function(){function w(){var j=this;w.superclass.constructor.apply(j,arguments);j._init();if(z.UA.ie===6){j.on("show",function(){var q=j.get("el"),n=q.width(),m=q.height();i.css({width:n+"px",height:m+"px"});i.offset(q.offset())});j.on("hide",function(){i.offset({left:-999,top:-999})})}if(j.get("mask")){j.on("show",function(){h&&h.css({left:"0px",top:"0px"});g&&g.css({left:"0px",top:"0px"})});j.on("hide",function(){h&&h.css({left:"-9999px",top:"-9999px"});g&&g.css({left:"-9999px",
top:"-9999px"})})}}var s=KISSY.Editor,z=KISSY,r=z.UA,x=s.focusManager,B=z.Node,p=z.Event,u=z.DOM,h,g,i;if(!s.SimpleOverlay){w.init=function(){var j=document.body;h=new B('<div class="ke-mask">&nbsp;</div>');h.css({left:"-9999px",top:"-9999px"});h.css({width:"100%",height:u.docHeight()+"px",opacity:0.4});h.appendTo(j);if(r.ie&&r.ie==6){i=new B("<iframe class='ke-dialog-iframe'></iframe>");i.appendTo(j);g=new B("<iframe class='ke-mask'></iframe>");g.css({left:"-9999px",top:"-9999px"});g.css({width:"100%",
height:u.docHeight()+"px",opacity:0.4});g.appendTo(j)}w.init=null};w.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false},draggable:{value:true}};z.extend(w,z.Base,{_init:function(){var j=this;j._initEl();var q=j.get("el");j.on("afterVisibleChange",function(n){if(n=n.newVal){typeof n=="boolean"?j.center():q.offset(n);j.fire("show")}else{q.css({left:"-9999px",top:"-9999px"});j.fire("hide")}});if(j.get("focusMgr")){j._initFocusNotice();j.on("beforeVisibleChange",
j._editorFocusMg,j)}q.css({left:"-9999px",top:"-9999px"});j.on("afterVisibleChange",function(n){n.newVal?j._register():j._unregister()})},_register:function(){p.on(document,"keydown",this._keydown,this);h.on("click",this.hide,this)},_keydown:function(j){if(j.keyCode==27){this.hide();j.halt()}},_unregister:function(){p.remove(document,"keydown",this._keydown,this);h.detach("click",this.hide,this)},_initEl:function(){var j=this,q=j.get("el");if(q)j.el=q;else{q=new B("<div class='ke-dialog' style='width:"+
j.get("width")+"'><div class='ke-hd'><span class='ke-hd-title'>"+j.get("title")+"</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>");document.body.appendChild(q[0]);j.set("el",q);j.el=q;j.body=q.one(".ke-bd");j.foot=q.one(".ke-ft");j._close=q.one(".ke-close");j._title=q.one(".ke-hd-title").one("h1");j._close.on("click",function(m){m.preventDefault();j.hide()});var n=q.one(".ke-hd");n=new s.Drag({node:q,handlers:[n]});
r.ie===6&&n.on("move",function(){i.offset(q.offset())})}},center:function(){var j=this.get("el"),q=parseInt(j.css("width")),n=j[0].offsetHeight,m=u.viewportWidth(),t=u.viewportHeight();q=(m-q)/2+u.scrollLeft();n=(t-n)/2+u.scrollTop();if(n-u.scrollTop()>200)n-=150;j.css({left:q+"px",top:n+"px"})},_prepareShow:function(){w.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;this._focusEl=new B("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>");
this._focusEl.appendTo(this.el);return this._focusEl},_initFocusNotice:function(){var j=this,q=j._getFocusEl();q.on("focus",function(){j.fire("focus")});q.on("blur",function(){j.fire("blur")})},_editorFocusMg:function(j){var q=this._focusEditor;if(j.newVal){q=this._focusEditor=x.currentInstance();this._getFocusEl()[0].focus();var n=this.el.one("input");if(n)setTimeout(function(){try{n[0].focus();n[0].select()}catch(m){}},0);else if(r.ie&&q)if(j=q.document.selection.createRange())if(j.item&&j.item(0).ownerDocument==
q.document){q=document.body.createTextRange();q.moveToElementText(this.el._4e_first()[0]);q.collapse(true);q.select()}}else q&&q.focus()},_realShow:function(j){this.get("el");this.set("visible",j||true)},show:function(j){this._prepareShow(j)},hide:function(){this.get("el");this.set("visible",false)}});s.Utils.lazyRun(w.prototype,"_prepareShow","_realShow");s.SimpleOverlay=w}});
KISSY.Editor.add("select",function(){function w(p){w.superclass.constructor.call(this,p);this._init()}var s=KISSY,z=s.Node,r=s.Event,x=s.DOM,B=s.Editor;if(!B.Select){w.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};s.extend(w,s.Base,{_init:function(){var p=this.get("container"),u=new z("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a></span>"),h=this.get("title"),g=u.one(".ke-select-text");
u.one(".ke-select-drop");g.html(h);g.css("width",this.get("width"));u._4e_unselectable();u.attr("title",h);u.appendTo(p);u.on("click",this._click,this);this.el=u;this.title=g;this._focusA=u.one("a.ke-select");B.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(p){p=p.newVal;for(var u=this.get("title"),h=this.get("items"),g=0;g<h.length;g++){var i=h[g];if(i.value==p){u=i.name;break}}this.title.html(u)},_prepare:function(){var p=this.el,
u=this._focusA,h=new z("<div class='ke-menu' onmousedown='return false;'></div>"),g=new B.SimpleOverlay({el:h,focusMgr:false}),i=this.get("items");this.get("title")&&(new z("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+this.get("title")+"</div>")).appendTo(h);for(var j=0;j<i.length;j++){var q=i[j];q=new z("<a class='ke-select-menu-item' href='#' data-value='"+q.value+"'>"+q.name+"</a>",q.attrs);q._4e_unselectable();q.appendTo(h)}this.get("popUpWidth")&&h.css("width",
this.get("popUpWidth"));h.appendTo(document.body);this.menu=g;g.on("show",function(){u.addClass("ke-select-active")});g.on("hide",function(){u.removeClass("ke-select-active")});r.on([document,this.get("doc")],"click",function(m){p._4e_contains(m.target)||g.hide()});h.on("click",this._select,this);var n=this.as=h.all("a");r.on(h[0],"mouseenter",function(){n.removeClass("ke-menu-selected")})},_select:function(p){p.halt();var u=this.menu,h=u.el;if(p=(new z(p.target))._4e_ascendant(function(j){return h._4e_contains(j)&&
j._4e_name()=="a"},true)){var g=this.get("value"),i=p.attr("data-value");this.set("value",i);this.fire("click",{newVal:i,preVal:g,name:p.html()});u.hide()}},_real:function(){var p=this.el.offset();p.top+=this.el.height();p.left+=1;if(p.left+this.menu.el.width()>x.viewportWidth()-60)p.left=x.viewportWidth()-this.menu.el.width()-60;this.menu.show(p)},_click:function(p){p.preventDefault();var u=this.get("value");if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();u&&this.menu&&
this.as.each(function(h){h.attr("data-value")==u?h.addClass("ke-menu-selected"):h.removeClass("ke-menu-selected")})}}});B.Select=w}});
