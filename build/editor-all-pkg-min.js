KISSY.add("editor",function(u,r){function w(o,x){var a=this;if(!(a instanceof w))return new w(o,x);if(u.isString(o))o=u.one(o);o=v._4e_wrap(o);x=x||{};x.pluginConfig=x.pluginConfig||{};a.cfg=x;u.app(a,u.EventTarget);a.use=function(d){if(u.isString(d))d=d.split(",");var e=d;d=[];d=u.indexOf("separator",e);var i=d!=-1;d=e.splice(0,i?d+1:e.length);i&&d.pop();d.length!=0?u.use.call(a,d.join(","),function(){i&&a.addPlugin(function(){w.Utils.addSeparator(a.toolBarDiv)});a.use(e)},{order:true,global:w}):
a.on("dataReady",function(){a.setData(o.val());a.fire("save")});return a};a.init(o);return r}function t(o){if(!B)return o.replace(/\.(js|css)/i,"-min.$1");if(B==="dev")return"../src/"+o;return o}var v=u.DOM;u.app(w,u.EventTarget);w.Config.base=u.Config.base+"editor/";var B=u.Config.debug,n={htmlparser:{attach:false,path:t("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},s=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],f=["flashutils",
"clipboard",{name:"color"},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["flashutils","contextmenu","fakeobjects","overlay","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview"]},"indent",
"justify",{name:"link",requires:["bubbleview"]},"list","maximize",{name:"music",requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],c=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},
{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],k,m,l,h;k=0;for(m=f.length;k<m;k++){l=f[k];if(u.isString(l))l=f[k]={name:l};l.requires=l.requires||[];l.requires=l.requires.concat(["button"])}f=[{name:"localStorage",requires:["flashutils"]},{name:"button"},{name:"dd"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},
{name:"select",requires:["overlay"]}].concat(f);k=0;for(m=f.length;k<m;k++){l=f[k];h=l.name;n[h]={attach:false,requires:l.requires,csspath:l.useCss?t("plugins/"+h+"/plugin.css"):r,path:t("plugins/"+h+"/plugin.js")}}k=0;for(m=c.length;k<m;k++){l=c[k];f=r;if(!u.isString(l)){f=l.requires;l=l.name}n[l]={attach:false,requires:f,path:t("plugins/htmldataprocessor/htmlparser/"+l.substring(11)+".js")}}k=0;for(m=s.length;k<m;k++){l=s[k];n[l]={host:"editor",requires:k>0?s[k-1]:[]}}w.add(n);u.Editor=w});
KISSY.Editor.add("utils",function(u){var r=KISSY,w=r.Node,t=r.DOM,v=r.Config.debug,B=r.UA;u.Utils={debugUrl:function(n){if(!v)return n.replace(/\.(js|css)/i,"-min.$1");if(v==="dev")return"../src/"+n;return n},lazyRun:function(n,s,f){var c=n[s],k=n[f];n[s]=function(){c.apply(this,arguments);n[s]=n[f];return k.apply(this,arguments)}},getXY:function(n,s,f,c){f=f.defaultView||f.parentWindow;n-=t.scrollLeft(f);s-=t.scrollTop(f);if(c)if(f!=(c.defaultView||c.parentWindow)&&f.frameElement){c=t._4e_getOffset(f.frameElement,
c);n+=c.left;s+=c.top}return{left:n,top:s}},tryThese:function(){for(var n,s=0,f=arguments.length;s<f;s++){var c=arguments[s];try{n=c();break}catch(k){}}return n},arrayCompare:function(n,s){if(!n&&!s)return true;if(!n||!s||n.length!=s.length)return false;for(var f=0;f<n.length;f++)if(n[f]!==s[f])return false;return true},getByAddress:function(n,s,f){n=n.documentElement;for(var c=0;n&&c<s.length;c++){var k=s[c];if(f)for(var m=-1,l=0;l<n.childNodes.length;l++){var h=n.childNodes[l];if(!(f===true&&h.nodeType==
3&&h.previousSibling&&h.previousSibling.nodeType==3)){m++;if(m==k){n=h;break}}}else n=n.childNodes[k]}return n?new w(n):null},clearAllMarkers:function(n){for(var s in n)n[s]._4e_clearMarkers(n,true)},htmlEncodeAttr:function(n){return n.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(n){return n.replace(/^\s+/,"")},rtrim:function(n){return n.replace(/\s+$/,"")},trim:function(n){return this.ltrim(this.rtrim(n))},mix:function(){for(var n={},s=0;s<arguments.length;s++)n=
r.mix(n,arguments[s]);return n},isCustomDomain:function(){if(!B.ie)return false;var n=document.domain,s=window.location.hostname;return n!=s&&n!="["+s+"]"},addSeparator:function(n){(new r.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(n)},duplicateStr:function(n,s){return(new Array(s+1)).join(n)},throttle:function(n,s,f){f=f||150;if(f===-1)return function(){n.apply(s,arguments)};var c=(new Date).getTime();return function(){var k=(new Date).getTime();if(k-c>f){c=k;n.apply(s,arguments)}}},
buffer:function(n,s,f){f=f||0;var c=null;return function(){c&&clearTimeout(c);var k=arguments;c=setTimeout(function(){return n.apply(s,k)},f)}},isNumber:function(n){return/^\d+(.\d+)?$/.test(r.trim(n))},verifyInputs:function(n){for(var s=0;s<n.length;s++){var f=t._4e_wrap(n[s]),c=r.trim(f.val()),k=f.attr("data-verify");f=f.attr("data-warning");if(k&&!(new RegExp(k)).test(c)){alert(f);return}}return true},sourceDisable:function(n,s){n.on("sourcemode",s.disable,s);n.on("wysiwygmode",s.enable,s)}}});
KISSY.Editor.add("focusmanager",function(u){function r(){this.iframeFocus=true;s=this}function w(){this.iframeFocus=false;s=null}var t=KISSY,v=t.DOM,B=t.Event;t={};var n={},s;t={refreshAll:function(){for(var f in n){var c=n[f];c.document.designMode="off";c.document.designMode="on"}},currentInstance:function(){return s},getInstance:function(f){return n[f]},add:function(f){var c=v._4e_getWin(f.document);B.on(c,"focus",r,f);B.on(c,"blur",w,f)},register:function(f){n[f._UUID]=f},remove:function(f){delete n[f._UUID];
var c=v._4e_getWin(f.document);B.remove(c,"focus",r,f);B.remove(c,"blur",w,f)}};u.focusManager=t});
KISSY.Editor.add("definition",function(u){function r(o){return c+"<html><head><title>kissy-editor</title><link href='"+u.Config.base+k+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(o?'<script id="ke_actscrpt" type="text/javascript">'+(u.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+o+'");<\/script>':"")}var w=KISSY,t=w.UA,v=w.DOM,B=w.Node,n=w.Event,s=u.focusManager,f=u.Utils.tryThese,c="<!doctype html>",k=
u.Utils.debugUrl("theme/editor-iframe.css"),m=1,l="document.open();"+(u.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",h="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(t.ie?"javascript:void(function(){"+encodeURIComponent(l)+"}())":"")+'"  tabIndex="'+
(t.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";u.SOURCE_MODE=0;u.WYSIWYG_MODE=1;w.augment(u,{init:function(o){var x=this,a=new B(h.replace(/\$\(tabIndex\)/,o.attr("tabIndex")));a.on("mousedown",function(i){if(t.webkit){var p=v._4e_name(i.target);if(p=="select"||p=="option")return true}i.halt()});x.editorWrap=a;x._UUID=m++;s.register(x);x.wrap=a.one(".ke-textarea-wrap");x.iframe=x.wrap.one("iframe");x.toolBarDiv=
a.one(".ke-editor-tools");x.textarea=o;x.statusDiv=a.one(".ke-editor-status");x.toolBarDiv._4e_unselectable();x._commands={};var d=o._4e_style("width"),e=o._4e_style("height");if(d){a.css("width",d);o.css("width","100%")}x.textarea.css("display","none");a.insertAfter(o);x.wrap[0].appendChild(o[0]);if(e){x.wrap.css("height",e);o.css("height","100%")}o=x.iframe;x.on("dataReady",function(){x.ready=true;u.fire("instanceCreated",{editor:x})});t.gecko?o.on("load",x._setUpIFrame,x):x._setUpIFrame()},addCommand:function(o,
x){this._commands[o]=x},execCommand:function(o){this.fire("save");this._commands[o].exec(this);this.fire("save")},getMode:function(){return this.textarea.css("display")=="none"?u.WYSIWYG_MODE:u.SOURCE_MODE},getData:function(){var o;o=this.getMode()==u.WYSIWYG_MODE?this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(o,"p");return o},setData:function(o){if(this.htmlDataProcessor)o=this.htmlDataProcessor.toDataFormat(o,"p");this.document.body.innerHTML=
o;if(this.getMode()==u.WYSIWYG_MODE)this.document.body.innerHTML=o;else this.textarea.val(o)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(o){this.document.body.innerHTML=o},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.fire("wysiwygmode")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");t.ie<8&&this.textarea.css("height",this.wrap.css("height"));
this.fire("sourcemode")},_prepareIFrameHtml:r,getSelection:function(){var o=new u.Selection(this.document);return!o||o.isInvalid?null:o},focus:function(){var o=v._4e_getWin(this.document);t.webkit&&o&&o.parent&&o.parent.focus();o&&o.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){v._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function o(){i=e.document;x.document=i;a.detach();i.open("text/html","replace");
i.write(d);i.close()}var x=this,a=x.iframe,d=r(x._UUID),e=a[0].contentWindow,i;try{i=e.document}catch(p){a[0].src=a[0].src;if(t.ie&&t.ie<7){setTimeout(o,10);return}}o()},addPlugin:function(o){this.ready?o():this.on("dataReady",o)},_monitor:function(){var o=this;o._monitorId&&clearTimeout(o._monitorId);o._monitorId=setTimeout(function(){var x=o.getSelection();if(x&&!x.isInvalid){x=x.getStartElement();var a=new u.ElementPath(x);if(!o.previousPath||!o.previousPath.compare(a)){o.previousPath=a;o.fire("selectionChange",
{selection:o,path:a,element:x})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(o,x){var a=this;a.focus();var d=o._4e_name(),e=u.XHTML_DTD,i=u.RANGE,p=u.NODE,j=e.$block[d],b=a.getSelection(),g=b.getRanges(),q,y,z,C,H;a.fire("save");for(var A=g.length-1;A>=0;A--){q=g[A];q.deleteContents();y=!A&&o||o._4e_clone(true);x&&x(y);if(j)for(;(C=q.getCommonAncestor(false,true))&&(H=e[C._4e_name()])&&!(H&&H[d]);)if(C._4e_name()in e.span)q.splitElement(C);
else if(q.checkStartOfBlock()&&q.checkEndOfBlock()){q.setStartBefore(C);q.collapse(true);C._4e_remove()}else q.splitBlock();q.insertNode(y);z||(z=y)}o=z._4e_nextSourceNode(true);x=a.document;H=u.XHTML_DTD;if(H.$inline[y._4e_name()]){o=new B(x.createTextNode(" "));o.insertAfter(z)}else if(o){if(o._4e_name()=="br"&&H[o.parent()._4e_name()].p){H=new B("<p>&nbsp;</p>",null,x);o[0].parentNode.replaceChild(H[0],o[0]);o=H}}else{H=new B("<p>&nbsp;</p>",null,x);H.insertAfter(z);o=H}q.moveToPosition(z,i.POSITION_AFTER_END);
o&&o[0].nodeType==p.NODE_ELEMENT&&q.moveToElementEditablePosition(o);b.selectRanges([q]);a.focus();y&&y._4e_scrollIntoView();setTimeout(function(){a.fire("save")},10);return y},insertHtml:function(o){var x=this;if(x.htmlDataProcessor)o=x.htmlDataProcessor.toDataFormat(o);if(t.webkit){o=v.create(o,null,this.document);o=o.nodeType==11?w.makeArray(o.childNodes):[o];for(var a=0;a<o.length;a++)x.insertElement(new B(o[a]))}else{x.focus();x.fire("save");a=x.getSelection();if(t.ie){a=a.getNative();a.type==
"Control"&&a.clear();a.createRange().pasteHTML(o)}else x.document.execCommand("inserthtml",false,o);x.focus();setTimeout(function(){x.fire("save")},10)}}});u._initIFrame=function(o){function x(y){f(function(){e.designMode="on";setTimeout(function(){e.designMode="off";j.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){e.designMode="off";v.attr(j,"contentEditable",false);v.attr(j,"contentEditable",true);!y&&x(1)})}var a=s.getInstance(o);o=a.textarea[0];var d=a.iframe[0].contentWindow,
e=a.document,i=a.cfg,p=e.getElementById("ke_actscrpt");p.parentNode.removeChild(p);var j=e.body;if(t.ie){j.hideFocus=true;j.disabled=true;j.contentEditable=true;j.removeAttribute("disabled")}else setTimeout(function(){if(t.gecko||t.opera)j.contentEditable=true;else if(t.webkit)j.parentNode.contentEditable=true;else e.designMode="on"},0);if(t.webkit){n.on(e,"click",function(y){var z=new B(y.target);w.inArray(z._4e_name(),["input","select"])&&y.preventDefault()});n.on(e,"mouseup",function(y){var z=
new B(y.target);w.inArray(z._4e_name(),["input","textarea"])&&y.preventDefault()})}if(t.gecko||t.ie||t.opera){var b;b=new B(v.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],o));b.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(t.ie&&e.compatMode=="CSS1Compat"||t.gecko||t.opera){var g=new B(e.documentElement);g.on("mousedown",function(y){if(y.target===g[0]){t.gecko&&x(false);b[0].focus()}})}n.on(d,"focus",function(){if(t.gecko)x(false);else t.opera&&
j.focus();a.notifySelectionChange()});t.gecko&&n.on(a.document,"mousedown",function(){a.iframeFocus||x(false)});if(t.ie){n.on(e,"keydown",function(y){if(y.keyCode in{8:1,46:1}){var z=a.getSelection(),C=z.getSelectedElement();if(C){a.fire("save");var H=z.getRanges()[0].createBookmark();C._4e_remove();z.selectBookmarks([H]);a.fire("save");y.preventDefault()}}});if(e.compatMode=="CSS1Compat"){var q={33:1,34:1};n.on(e,"keydown",function(y){y.keyCode in q&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}}setTimeout(function(){t.ie&&setTimeout(function(){if(e){j.runtimeStyle.marginBottom="0px";j.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady");var y=i.disableObjectResizing,z=i.disableInlineTableEditing;if(y||z)try{e.execCommand("enableObjectResizing",false,!y);e.execCommand("enableInlineTableEditing",false,!z)}catch(C){n.on(j,t.ie?"resizestart":"resize",function(H){if(y||v._4e_name(H.target)==="table"&&z)H.preventDefault()})}},10);t.webkit&&n.on(e,"mousedown",
function(y){y=new B(y.target);w.inArray(y._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(y)});s.add(a)};t.gecko&&function(){var o=document.body;if(o){var x=o.getAttribute("onpageshow");o.setAttribute("onpageshow",(x?x+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(u){u.XHTML_DTD=function(){var r=function(j){for(var b=arguments.length-1;b>0;)KISSY.mix(j,arguments[b--]);return j},w={isindex:1,fieldset:1},t={input:1,button:1,select:1,textarea:1,label:1},v=r({a:1},t),B=r({iframe:1},v),n={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},s={ins:1,del:1,script:1,style:1},f=r({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},s),c=r({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},f),k=r({p:1},c);t=r({iframe:1},c,t);c={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var m=r({a:1},t),l={tr:1},h={"#":1},o=r({param:1},c),x=r({form:1},w,B,n,k),a={li:1},d={base:1,link:1,meta:1,title:1},e=r(d,{style:1,script:1}),i={head:1,body:1},p={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:r({html:1},i,d),$block:p,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:m,$body:r({script:1,style:1},p),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:i,head:e,style:h,body:x,base:{},link:{},meta:{},title:h,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:x,td:x,br:{},th:x,center:x,kbd:m,button:r(k,n),basefont:{},h5:m,h4:m,samp:m,h6:m,ol:a,h1:m,h3:m,option:h,h2:m,form:r(w,B,n,k),select:{optgroup:1,option:1},font:m,ins:m,menu:a,abbr:m,label:m,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:m,script:h,tfoot:l,cite:m,li:x,input:{},iframe:x,strong:m,textarea:h,noframes:x,big:m,small:m,span:m,hr:{},dt:m,sub:m,optgroup:{option:1},param:{},bdo:m,"var":m,div:x,object:o,sup:m,dd:x,strike:m,area:{},dir:a,map:r({area:1,form:1,p:1},w,s,n),applet:o,dl:{dt:1,dd:1},del:m,isindex:{},fieldset:r({legend:1},c),thead:l,ul:a,acronym:m,b:m,a:t,blockquote:x,caption:m,i:m,u:m,tbody:l,s:m,address:r(B,k),tt:m,legend:m,q:m,pre:r(f,v),p:m,em:m,dfn:m}}()});
KISSY.Editor.add("dom",function(u){function r(a){return a.replace(/-(\w)/g,function(d,e){return e.toUpperCase()})}var w=KISSY,t=w.DOM,v=w.UA,B=w.Node,n=u.Utils,s={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};u.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};u.POSITION={};var f=u.NODE,c=u.POSITION;c.POSITION_IDENTICAL=0;c.POSITION_DISCONNECTED=
1;c.POSITION_FOLLOWING=2;c.POSITION_PRECEDING=4;c.POSITION_IS_CONTAINED=8;c.POSITION_CONTAINS=16;var k={},m={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},l={hr:1},h=function(a){return a[0]||a},o=function(a){if(a&&!a[0])return new B(a);return a},x={_4e_wrap:o,_4e_equals:function(a,d){if(!a&&!d)return true;if(!a||!d)return false;a=h(a);d=h(d);return a===d},_4e_isBlockBoundary:function(a,
d){a=o(a);d=w.mix(w.mix({},l),d||{});return m[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=h(a);for(var d=a.parentNode.childNodes,e=0;e<d.length;e++)if(d[e]===a)return e;return-1},_4e_first:function(a,d){a=h(a);if((a=(a=a.firstChild)&&new B(a))&&d&&!d(a))a=a._4e_next(d);return a},_4e_move:function(a,d,e){a._4e_remove();a=h(a);d=h(d);e?d.insertBefore(a,d.firstChild):d.appendChild(a)},
_4e_name:function(a){a=h(a);var d=a.nodeName.toLowerCase();if(v.ie)if((a=a.scopeName)&&a!="HTML")d=a.toLowerCase()+":"+d;return d},_4e_isIdentical:function(a,d){if(a._4e_name()!=d._4e_name())return false;var e=a[0].attributes,i=d[0].attributes,p=e.length,j=i.length;if(!v.ie&&p!=j)return false;for(var b=0;b<p;b++){var g=e[b];if((!v.ie||g.specified&&g.nodeName!="_ke_expando")&&g.nodeValue!=d.attr(g.nodeName))return false}if(v.ie)for(b=0;b<j;b++){g=i[b];if(g.specified&&g.nodeName!="_ke_expando"&&g.nodeValue!=
a.attr(g.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=h(a).childNodes;for(var d=0,e=a.length;d<e;d++){var i=a[d],p=i.nodeType;if(!(p==f.NODE_ELEMENT&&i.getAttribute("_ke_bookmark")))if(p==f.NODE_ELEMENT&&!x._4e_isEmptyInlineRemoveable(i)||p==f.NODE_TEXT&&w.trim(i.nodeValue))return false}return true},_4e_moveChildren:function(a,d,e){a=h(a);d=d[0]||d;if(a!=d)if(e)for(;e=a.lastChild;)d.insertBefore(a.removeChild(e),d.firstChild);else for(;e=a.firstChild;)d.appendChild(a.removeChild(e))},
_4e_mergeSiblings:function(){function a(d,e,i){if(e[0]&&e[0].nodeType==f.NODE_ELEMENT){for(var p=[];e.attr("_ke_bookmark")||e._4e_isEmptyInlineRemoveable();){p.push(e);e=i?new B(e[0].nextSibling):new B(e[0].previousSibling);if(!e[0]||e[0].nodeType!=f.NODE_ELEMENT)return}if(d._4e_isIdentical(e)){for(var j=i?d[0].lastChild:d[0].firstChild;p.length;)p.shift()._4e_move(d,!i);e._4e_moveChildren(d,!i);e._4e_remove();j[0]&&j[0].nodeType==f.NODE_ELEMENT&&j._4e_mergeSiblings()}}}return function(d){if(d[0])if(s[d._4e_name()]||
d._4e_name()=="a"){a(d,new B(d[0].nextSibling),true);a(d,new B(d[0].previousSibling))}}}(),_4e_unselectable:v.gecko?function(a){a=h(a);a.style.MozUserSelect="none"}:v.webkit?function(a){a=h(a);a.style.KhtmlUserSelect="none"}:function(a){a=h(a);if(v.ie||v.opera){var d,e=0;for(a.unselectable="on";d=a.all[e++];)switch(d.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:d.unselectable="on"}}},_4e_getOffset:function(a,d){a=h(a);var e,i=0;e=0;var p=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,j=a.ownerDocument,b=j.documentElement;d=d||j;if(a.getBoundingClientRect){if(a!==j.body&&b!==a){e=a.getBoundingClientRect();i=e.left+(d===j?t.scrollLeft(p):0);e=e.top+(d===j?t.scrollTop(p):0)}if(d)if(p!=(d.defaultView||d.parentWindow)&&p.frameElement){d=x._4e_getOffset(p.frameElement,d);i+=d.left;e+=d.top}}return{left:i,top:e}},_4e_getFrameDocument:function(a){return(a=h(a))&&a.contentWindow.document},_4e_splitText:function(a,d){a=h(a);var e=a.ownerDocument;if(!(!a||a.nodeType!=
f.NODE_TEXT)){if(v.ie&&d==a.nodeValue.length){e=e.createTextNode("");t.insertAfter(e,a);return e}a=new B(a.splitText(d));if(v.ie==8){e=e.createTextNode("");t.insertAfter(e,a[0]);e.parentNode.removeChild(e)}return a}},_4e_parents:function(a,d){a=o(a);var e=[];do e[d?"push":"unshift"](a);while(a=a.parent());return e},_4e_clone:function(a,d,e){a=h(a);a=a.cloneNode(d);if(!e){var i=function(p){if(p.nodeType==f.NODE_ELEMENT){p.removeAttribute("id",false);p.removeAttribute("_ke_expando",false);p=p.childNodes;
for(var j=0;j<p.length;j++)i(p[j])}};i(a)}return new B(a)},_4e_nextSourceNode:function(a,d,e,i){a=h(a);if(i&&!i.call){var p=i[0]||i;i=function(b){b=b[0]||b;return b!==p}}d=!d&&a.firstChild;var j=new B(a);if(!d){if(a.nodeType==f.NODE_ELEMENT&&i&&i(a,true)===false)return null;d=a.nextSibling}for(;!d&&(j=j.parent());){if(i&&i(j,true)===false)return null;d=j[0].nextSibling}if(!d)return null;d=t._4e_wrap(d);if(i&&i(d)===false)return null;if(e&&e!=d[0].nodeType)return d._4e_nextSourceNode(false,e,i);return d},
_4e_previousSourceNode:function(a,d,e,i){a=h(a);if(i&&!i.call){var p=i[0]||i;i=function(b){b=b[0]||b;return b!==p}}d=!d&&a.lastChild;var j=new B(a);if(!d){if(a.nodeType==f.NODE_ELEMENT&&i&&i(a,true)===false)return null;d=a.previousSibling}for(;!d&&(j=j.parent());){if(i&&i(j,true)===false)return null;d=j[0].previousSibling}if(!d)return null;d=t._4e_wrap(d);if(i&&i(d)===false)return null;if(e&&d[0].nodeType!=e)return d._4e_previousSourceNode(false,e,i);return d},_4e_contains:v.ie||v.webkit?function(a,
d){a=h(a);d=h(d);return d.nodeType!=f.NODE_ELEMENT?a.contains(d.parentNode):a!=d&&a.contains(d)}:function(a,d){a=h(a);d=h(d);return!!(a.compareDocumentPosition(d)&16)},_4e_commonAncestor:function(a,d){if(a._4e_equals(d))return a;if(d[0].nodeType!=f.NODE_TEXT&&d._4e_contains(a))return d;a=a[0].nodeType==f.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=f.NODE_TEXT&&a._4e_contains(d))return a;while(a=a.parent());return null},_4e_ascendant:function(a,d,e){a=h(a);if(!e)a=a.parentNode;if(d&&!w.isFunction(d)){var i=
d;d=function(p){return p._4e_name()==i}}for(;a&&a.nodeType!=9;){if(!d||d(new B(a))===true)return new B(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,d){a=h(a);a=a.attributes.getNamedItem(d);return!!(a&&a.specified)},_4e_hasAttributes:v.ie?function(a){a=h(a);for(var d=a.attributes,e=0;e<d.length;e++){var i=d[e];switch(i.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(i.specified)return true}}return false}:function(a){a=h(a);v.gecko&&
a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,d){var e=h(a),i=h(d);if(e.compareDocumentPosition)return e.compareDocumentPosition(i);if(e==i)return c.POSITION_IDENTICAL;if(e.nodeType==f.NODE_ELEMENT&&i.nodeType==f.NODE_ELEMENT){if(e.contains){if(e.contains(i))return c.POSITION_CONTAINS+c.POSITION_PRECEDING;if(i.contains(e))return c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING}if("sourceIndex"in e)return e.sourceIndex<
0||i.sourceIndex<0?c.POSITION_DISCONNECTED:e.sourceIndex<i.sourceIndex?c.POSITION_PRECEDING:c.POSITION_FOLLOWING}a=a._4e_address();d=d._4e_address();e=Math.min(a.length,d.length);for(i=0;i<=e-1;i++)if(a[i]!=d[i]){if(i<e)return a[i]<d[i]?c.POSITION_PRECEDING:c.POSITION_FOLLOWING;break}return a.length<d.length?c.POSITION_CONTAINS+c.POSITION_PRECEDING:c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING},_4e_address:function(a,d){a=h(a);var e=[],i=a.ownerDocument.documentElement;for(a=a;a&&a!=i;){var p=a.parentNode,
j=-1;if(p){for(var b=0;b<p.childNodes.length;b++){var g=p.childNodes[b];if(!(d&&g.nodeType==3&&g.previousSibling&&g.previousSibling.nodeType==3)){j++;if(g==a)break}}e.unshift(j)}a=p}return e},_4e_breakParent:function(a,d){var e=new u.Range(a[0].ownerDocument);e.setStartAfter(a);e.setEndAfter(d);d=e.extractContents();e.insertNode(a._4e_remove());a[0].parentNode.insertBefore(d,a[0].nextSibling)},_4e_style:function(a,d,e){if(e!==undefined)return a.css(d,e);a=a[0]||a;return a.style[r(d)]},_4e_remove:function(a,
d){var e=h(a),i=e.parentNode;if(i){if(d)for(;d=e.firstChild;)i.insertBefore(e.removeChild(d),e);i.removeChild(e)}return a},_4e_trim:function(a){t._4e_ltrim(a);t._4e_rtrim(a)},_4e_ltrim:function(a){a=h(a);for(var d;d=a.firstChild;){if(d.nodeType==f.NODE_TEXT){var e=n.ltrim(d.nodeValue),i=d.nodeValue.length;if(e){if(e.length<i){(new B(d))._4e_splitText(i-e.length);a.removeChild(a.firstChild)}}else{a.removeChild(d);continue}}break}},_4e_rtrim:function(a){a=h(a);for(var d;d=a.lastChild;){if(d.type==f.NODE_TEXT){var e=
n.rtrim(d.nodeValue),i=d.nodeValue.length;if(e){if(e.length<i){(new B(d))._4e_splitText(e.length);a.removeChild(a.lastChild)}}else{a.removeChild(d);continue}}break}if(!v.ie&&!v.opera)(d=a.lastChild)&&d.nodeType==1&&d.nodeName.toLowerCase()=="br"&&d.parentNode.removeChild(d)},_4e_appendBogus:function(a){a=h(a);for(var d=a.lastChild;d&&d.nodeType==f.NODE_TEXT&&!w.trim(d.nodeValue);)d=d.previousSibling;if(!d||d.nodeType==f.NODE_TEXT||t._4e_name(d)!=="br"){d=v.opera?a.ownerDocument.createTextNode(""):
a.ownerDocument.createElement("br");v.gecko&&d.setAttribute("type","_moz");a.appendChild(d)}},_4e_previous:function(a,d){a=h(a);var e;do e=(a=a.previousSibling)&&new B(a);while(e&&d&&!d(e));return e},_4e_last:function(a,d){a=t._4e_wrap(a);if((a=(a=a[0].lastChild)&&new B(a))&&d&&!d(a))a=a._4e_previous(d);return a},_4e_next:function(a,d){a=h(a);var e;do e=(a=a.nextSibling)&&new B(a);while(e&&d&&!d(e));return e},_4e_outerHtml:function(a){a=h(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");
var d=a.ownerDocument.createElement("div");d.appendChild(a.cloneNode(true));return d.innerHTML},_4e_setMarker:function(a,d,e,i){a=t._4e_wrap(a);var p=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",w.guid())._4e_getData("list_marker_id"),j=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");d[p]=a;j[e]=1;return a._4e_setData(e,i)},_4e_clearMarkers:function(a,d,e){a=o(a);var i=a._4e_getData("list_marker_names"),p=a._4e_getData("list_marker_id");
for(var j in i)a._4e_removeData(j);a._4e_removeData("list_marker_names");if(e){a._4e_removeData("list_marker_id");delete d[p]}},_4e_setData:function(a,d,e){var i=t._4e_getUniqueId(a);(k[i]||(k[i]={}))[d]=e;return a},_4e_getData:function(a,d){a=h(a);return(a=(a=a.getAttribute("_ke_expando"))&&k[a])&&a[d]},_4e_removeData:function(a,d){a=h(a);var e=a.getAttribute("_ke_expando");var i=(e=e&&k[e])&&e[d];typeof i!="undefined"&&e&&delete e[d];w.isEmptyObject(e)&&t._4e_clearData(a);return i||null},_4e_clearData:function(a){a=
h(a);var d=a.getAttribute("_ke_expando");d&&delete k[d];d&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=h(a);var d=a.getAttribute("_ke_expando");if(d)return d;d=w.guid();a.setAttribute("_ke_expando",d);return d},_4e_copyAttributes:function(a,d,e){a=h(a);var i=a.attributes;e=e||{};for(var p=0;p<i.length;p++){var j=i[p],b=j.nodeName.toLowerCase(),g;if(!(b in e))if(b=="checked"&&(g=t.attr(a,b)))d.attr(b,g);else if(j.specified||v.ie&&j.nodeValue&&b=="value"){g=t.attr(a,b);if(g===null)g=
j.nodeValue;d.attr(b,g)}}if(a.style.cssText!=="")d[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=t._4e_name(a);var d=u.XHTML_DTD;return(a=!d.$nonEditable[a]&&(d[a]||d.span))&&a["#"]},_4e_scrollIntoView:function(a){a=o(a);var d=a[0].ownerDocument,e=t.scrollLeft(d),i=t.scrollTop(d),p=a.offset(),j=p.left;p=p.top;if(t.viewportHeight(d)+i<p||p<i||t.viewportWidth(d)+e<j||j<e)a.scrollIntoView(d)},_4e_getElementsByTagName:function(a,d,e){a=h(a);if(!v.ie&&e)d=e+":"+d;e=[];a=a.getElementsByTagName(d);
for(d=0;d<a.length;d++)e.push(new B(a[d]));return e}};w.DOM._4e_inject=function(a){w.mix(t,a);for(var d in a)a.hasOwnProperty(d)&&function(e){B.prototype[e]=function(){var i=[].slice.call(arguments,0);i.unshift(this);return a[e].apply(null,i)}}(d)};w.DOM._4e_inject(x)});
KISSY.Editor.add("elementpath",function(u){function r(k){var m=null,l=null,h=[];for(k=k;k&&k[0];){if(k[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=k;var o=k._4e_name();if(n.ie&&k[0].scopeName!="HTML")o=k[0].scopeName.toLowerCase()+":"+o;if(!l){if(!m&&s[o])m=k;if(f[o])if(!m&&o=="div"&&!c(k))m=k;else l=k}h.push(k);if(o=="body")break}k=k.parent()}this.block=m;this.blockLimit=l;this.elements=h}var w=KISSY,t=w.DOM,v=u.XHTML_DTD,B=u.NODE,n=w.UA,s={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},f={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},c=function(k){k=k[0]||k;k=k.childNodes;for(var m=0,l=k.length;m<l;m++){var h=k[m];if(h.nodeType==B.NODE_ELEMENT&&v.$block[h.nodeName.toLowerCase()])return true}return false};r.prototype={compare:function(k){var m=this.elements;k=k&&k.elements;if(!k||m.length!=k.length)return false;for(var l=0;l<m.length;l++)if(!t._4e_equals(m[l],k[l]))return false;return true},contains:function(k){for(var m=
this.elements,l=0;l<m.length;l++)if(m[l]._4e_name()in k)return m[l];return null}};u.ElementPath=r});
KISSY.Editor.add("walker",function(u){function r(f,c){if(this._.end)return null;var k=this.range,m,l=this.guard,h=this.type,o=f?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;k.trim();if(k.collapsed){this.end();return null}}if(!f&&!this._.guardLTR){var x=k.endContainer,a=new s(x[0].childNodes[k.endOffset]);this._.guardLTR=function(p,j){return(p=n._4e_wrap(p))&&p[0]&&(!j||!n._4e_equals(x,p))&&(!a[0]||!p._4e_equals(a))&&(p[0].nodeType!=B.NODE_ELEMENT||!j||p._4e_name()!=
"body")}}if(f&&!this._.guardRTL){var d=k.startContainer,e=k.startOffset>0&&new s(d[0].childNodes[k.startOffset-1]);this._.guardRTL=function(p,j){return(p=n._4e_wrap(p))&&p[0]&&(!j||!p._4e_equals(d))&&(!e[0]||!p._4e_equals(e))&&(p[0].nodeType!=B.NODE_ELEMENT||!j||p._4e_name()!="body")}}var i=f?this._.guardRTL:this._.guardLTR;m=l?function(p,j){if(i(p,j)===false)return false;return l(p,j)}:i;if(this.current)f=this.current[o](false,h,m);else if(f){f=k.endContainer;if(k.endOffset>0){f=new s(f[0].childNodes[k.endOffset-
1]);if(m(f)===false)f=null}else f=m(f,true)===false?null:f._4e_previousSourceNode(true,h,m)}else{f=k.startContainer;if((f=new s(f[0].childNodes[k.startOffset]))&&f[0]){if(m(f)===false)f=null}else f=m(k.startContainer,true)===false?null:k.startContainer._4e_nextSourceNode(true,h,m)}for(;f&&f[0]&&!this._.end;){this.current=f;if(!this.evaluator||this.evaluator(f)!==false){if(!c)return f}else if(c&&this.evaluator)return false;f=f[o](false,h,m)}this.end();return this.current=null}function w(f){for(var c,
k=null;c=r.call(this,f);)k=c;return k}function t(f){this.range=f;this._={}}var v=KISSY,B=u.NODE,n=v.DOM,s=v.Node;v.augment(t,{end:function(){this._.end=1},next:function(){return r.call(this)},previous:function(){return r.call(this,true)},checkForward:function(){return r.call(this,false,true)!==false},checkBackward:function(){return r.call(this,true,true)!==false},lastForward:function(){return w.call(this)},lastBackward:function(){return w.call(this,true)},reset:function(){delete this.current;this._=
{}}});t.blockBoundary=function(f){return function(c){c=n._4e_wrap(c);return!(c&&c[0].nodeType==B.NODE_ELEMENT&&c._4e_isBlockBoundary(f))}};t.listItemBoundary=function(){return this.blockBoundary({br:1})};t.bookmark=function(f,c){function k(m){return m&&m[0]&&m._4e_name()=="span"&&m.attr("_ke_bookmark")}return function(m){var l,h;l=m&&m[0]&&m[0].nodeType==B.NODE_TEXT&&(h=m.parent())&&k(h);l=f?l:l||k(m);return c^l}};t.whitespaces=function(f){return function(c){c=(c=c[0]||c)&&c.nodeType==B.NODE_TEXT&&
!v.trim(c.nodeValue);return f^c}};t.invisible=function(f){var c=t.whitespaces();return function(k){k=c(k)||k[0].nodeType==B.NODE_ELEMENT&&!k[0].offsetHeight;return f^k}};u.Walker=t});
KISSY.Editor.add("range",function(u){function r(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function w(b){var g=b[0].nodeType!=f.NODE_TEXT&&b._4e_name()in x.$removeEmpty,q=!s.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return g||q||b}function t(b){return!p(b)&&!j(b)}function v(b){var g=false,q=m.bookmark(true);return function(y){if(q(y))return true;if(y[0].nodeType==f.NODE_TEXT){if(s.trim(y[0].nodeValue).length)return false}else if(y[0].nodeType==
f.NODE_ELEMENT)if(!i[y._4e_name()])if(!b&&!o.ie&&y._4e_name()=="br"&&!g)g=true;else return false;return true}}function B(b,g){function q(y){return y&&y.nodeName=="span"&&y.getAttribute("_ke_bookmark")}return function(y){var z,C;z=y&&!y.nodeName&&(C=y.parentNode)&&q(C);z=b?z:z||q(y);return g^z}}function n(b){return function(g){g=(g=g[0]||g)&&g.nodeType==f.NODE_TEXT&&!s.trim(g.nodeValue);return b^g}}u.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var s=KISSY,f=u.NODE,c=u.RANGE,k=u.POSITION,m=u.Walker,l=s.DOM,h=u.Utils.getByAddress,o=s.UA,x=u.XHTML_DTD,a=u.ElementPath,d=s.Node,e={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};r.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};s.augment(r,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&l._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,g=this.startOffset;if(b[0].nodeType!=f.NODE_ELEMENT)if(g)g>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;g=this.endOffset;if(b[0].nodeType!=f.NODE_ELEMENT)if(g)g>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,g=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,c.POSITION_BEFORE_START);g&&g._4e_name()=="span"&&
g.attr("_ke_bookmark")&&this.setEndAt(g,c.POSITION_AFTER_END)},setStart:function(b,g){if(b[0].nodeType==f.NODE_ELEMENT&&e[b._4e_name()]){b=b.parent();g=b._4e_index()}this.startContainer=b;this.startOffset=g;if(!this.endContainer){this.endContainer=b;this.endOffset=g}this.updateCollapsed()},setEnd:function(b,g){if(b[0].nodeType==f.NODE_ELEMENT&&e[b._4e_name()]){b=b.parent();g=b._4e_index()+1}this.endContainer=b;this.endOffset=g;if(!this.startContainer){this.startContainer=b;this.startOffset=g}this.updateCollapsed()},
setStartAt:function(b,g){switch(g){case c.POSITION_AFTER_START:this.setStart(b,0);break;case c.POSITION_BEFORE_END:b[0].nodeType==f.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(b);break;case c.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,g){switch(g){case c.POSITION_AFTER_START:this.setEnd(b,0);break;case c.POSITION_BEFORE_END:b[0].nodeType==f.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(b);break;case c.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,g){var q=this.startContainer,y=this.endContainer,z=this.startOffset,C=this.endOffset,H,A;this.optimizeBookmark();if(y[0].nodeType==f.NODE_TEXT)y=y._4e_splitText(C);else if(y[0].childNodes.length>0)if(C>=y[0].childNodes.length){y=new d(y[0].appendChild(this.document.createTextNode("")));
A=true}else y=new d(y[0].childNodes[C]);if(q[0].nodeType==f.NODE_TEXT){q._4e_splitText(z);if(l._4e_equals(q,y))y=new d(q[0].nextSibling)}else if(z)if(z>=q[0].childNodes.length){H=new d(this.document.createTextNode(""));q[0].appendChild(H[0]);q=H;H=true}else q=new d(q[0].childNodes[z].previousSibling);else{H=new d(this.document.createTextNode(""));l.insertBefore(H[0],q[0].firstChild);q=H;H=true}z=q._4e_parents();C=y._4e_parents();var D,I,J;for(D=0;D<z.length;D++){I=z[D];J=C[D];if(I[0]!==J[0])break}for(var N=
g,M,Q,R,W=D;W<z.length;W++){M=z[W];if(N&&M[0]!==q[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(C[W]&&M==C[W][0]||M==y[0])break;R=M.nextSibling;if(b==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);b==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=g;for(g=D;g<C.length;g++){M=C[g];if(b>0&&M[0]!==y[0])Q=N.appendChild(M._4e_clone()[0]);if(!z[g]||M[0].parentNode!==z[g][0].parentNode)for(M=M[0].previousSibling;M;){if(z[g]&&M==z[g][0]||M===q[0])break;R=M.previousSibling;if(b==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);b==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(b==2){J=this.startContainer[0];if(J.nodeType==f.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==f.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==f.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==f.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(I&&J&&(q[0].parentNode!=
I[0].parentNode||y[0].parentNode!=J[0].parentNode)){b=J._4e_index();H&&J[0].parentNode==q[0].parentNode&&b--;this.setStart(J.parent(),b)}this.collapse(true)}H&&q._4e_remove();A&&y[0].parentNode&&y._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new r(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=f.NODE_ELEMENT||b.endContainer[0].nodeType!=f.NODE_ELEMENT)return null;var g=new u.Walker(b),q=B(true,undefined),y=n(true);b.evaluator=function(z){return y(z)&&q(z)};b=g.next();g.reset();g=g.previous();return b&&b._4e_equals(g)?b:null},shrink:function(b,g){if(!this.collapsed){b=b||c.SHRINK_TEXT;var q=this.clone(),
y=this.startContainer,z=this.endContainer,C=this.startOffset,H=this.endOffset,A=1,D=1;if(y&&y[0].nodeType==f.NODE_TEXT)if(C)if(C>=y[0].nodeValue.length)q.setStartAfter(y);else{q.setStartBefore(y);A=0}else q.setStartBefore(y);if(z&&z[0].nodeType==f.NODE_TEXT)if(H)if(H>=z[0].nodeValue.length)q.setEndAfter(z);else{q.setEndAfter(z);D=0}else q.setEndBefore(z);q=new m(q);q.evaluator=function(J){J=J[0]||J;return J.nodeType==(b==c.SHRINK_ELEMENT?f.NODE_ELEMENT:f.NODE_TEXT)};var I;q.guard=function(J,N){J=
J[0]||J;if(b==c.SHRINK_ELEMENT&&J.nodeType==f.NODE_TEXT)return false;if(N&&J==I)return false;if(!N&&J.nodeType==f.NODE_ELEMENT)I=J;return true};if(A)(y=q[b==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(y,g?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);if(D){q.reset();(q=q[b==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(q,g?c.POSITION_BEFORE_END:c.POSITION_AFTER_END)}return!!(A||D)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||b[0].nodeType!=
f.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var g=this.startContainer,q=this.endContainer,y=this.startOffset,z=this.endOffset,C,H;if(!g||!q)return{start:0,end:0};if(b){if(g[0].nodeType==f.NODE_ELEMENT)if((C=new d(g[0].childNodes[y]))&&C[0]&&C[0].nodeType==f.NODE_TEXT&&y>0&&C[0].previousSibling.nodeType==f.NODE_TEXT){g=C;y=0}for(;g[0].nodeType==f.NODE_TEXT&&(H=g._4e_previous())&&H[0].nodeType==f.NODE_TEXT;){g=H;y+=H[0].nodeValue.length}if(!this.collapsed){if(q[0].nodeType==
f.NODE_ELEMENT)if((C=new d(q[0].childNodes[z]))&&C[0]&&C[0].nodeType==f.NODE_TEXT&&z>0&&C[0].previousSibling.nodeType==f.NODE_TEXT){q=C;z=0}for(;q[0].nodeType==f.NODE_TEXT&&(H=q._4e_previous())&&H[0].nodeType==f.NODE_TEXT;){q=H;z+=H[0].nodeValue.length}}}return{start:g._4e_address(b),end:this.collapsed?null:q._4e_address(b),startOffset:y,endOffset:z,normalized:b,is2:true}},createBookmark:function(b){var g,q,y,z;g=new d("<span></span>",null,this.document);g.attr("_ke_bookmark",1);g.css("display","none");
g.html("&nbsp;");if(b){y=s.guid("ke_bm_");g.attr("id",y+"S")}if(!this.collapsed){q=g._4e_clone();q.html("&nbsp;");b&&q.attr("id",y+"E");z=this.clone();z.collapse();z.insertNode(q)}z=this.clone();z.collapse(true);z.insertNode(g);if(q){this.setStartAfter(g);this.setEndBefore(q)}else this.moveToPosition(g,c.POSITION_AFTER_END);return{startNode:b?y+"S":g,endNode:b?y+"E":q,serializable:b}},moveToPosition:function(b,g){this.setStartAt(b,g);this.collapse(true)},trim:function(b,g){var q=this.startContainer,
y=this.startOffset,z=this.collapsed;if((!b||z)&&q[0]&&q[0].nodeType==f.NODE_TEXT){if(y)if(y>=q[0].nodeValue.length){y=q._4e_index()+1;q=q.parent()}else{b=q._4e_splitText(y);y=q._4e_index()+1;q=q.parent();if(l._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(l._4e_equals(q,this.endContainer))this.endOffset+=1}else{y=q._4e_index();q=q.parent()}this.setStart(q,y);if(z){this.collapse(true);return}}q=this.endContainer;y=this.endOffset;if(!(g||z)&&
q[0]&&q[0].nodeType==f.NODE_TEXT){if(y){y>=q.nodeValue.length||q._4e_splitText(y);y=q._4e_index()+1}else y=q._4e_index();q=q.parent();this.setEnd(q,y)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var g=this.startContainer,q=g[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);q?l.insertBefore(b[0]||b,q):g[0].appendChild(b[0]||b);l._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var g=
h(this.document,b.start,b.normalized),q=b.startOffset,y=b.end&&h(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(g,q);y?this.setEnd(y,b):this.collapse(true)}else{g=(q=b.serializable)?s.one("#"+b.startNode,this.document):b.startNode;b=q?s.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(g);g._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,g){var q=this.startContainer,y=this.endContainer;b=l._4e_equals(q,
y)?b&&q[0].nodeType==f.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new d(q[0].childNodes[this.startOffset]):q:q._4e_commonAncestor(y);return g&&b[0].nodeType==f.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case c.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var g=new d(this.document.body),q,y,z,C,H,A=false,D,I;D=this.startContainer;I=this.startOffset;if(D[0].nodeType==f.NODE_TEXT){if(I){D=!s.trim(D[0].nodeValue.substring(0,I)).length&&D;A=!!D}if(D)if(!(C=D[0].previousSibling))z=
D.parent()}else{if(I)C=D[0].childNodes[I-1]||D[0].lastChild;C||(z=D)}for(;z||C;){if(z&&!C){if(!H&&l._4e_equals(z,b))H=true;if(!g._4e_contains(z))break;if(!A||z.css("display")!="inline"){A=false;if(H)q=z;else this.setStartBefore(z)}C=z[0].previousSibling}for(;C;){D=false;if(C.nodeType==f.NODE_TEXT){I=C.nodeValue;if(/[^\s\ufeff]/.test(I))C=null;D=/[\s\ufeff]$/.test(I)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(A&&x.$removeEmpty[C.nodeName.toLowerCase()]){I=l.text(C);if(/[^\s\ufeff]/.test(I))C=
null;else for(var J=C.all||C.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!x.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}if(C)D=!!I.length}else C=null;if(D)if(A)if(H)q=z;else z&&this.setStartBefore(z);else A=true;if(C){D=C.previousSibling;if(!z&&!D){z=new d(C);C=null;break}C=D}else z=null}if(z)z=z.parent()}D=this.endContainer;I=this.endOffset;z=C=null;H=A=false;if(D[0].nodeType==f.NODE_TEXT){D=!s.trim(D[0].nodeValue.substring(I)).length&&D;A=!(D&&D[0].nodeValue.length);if(D)if(!(C=D[0].nextSibling))z=
D.parent()}else(C=D[0].childNodes[I])||(z=D);for(;z||C;){if(z&&!C){if(!H&&l._4e_equals(z,b))H=true;if(!g._4e_contains(z))break;if(!A||z.css("display")!="inline"){A=false;if(H)y=z;else z&&this.setEndAfter(z)}C=z[0].nextSibling}for(;C;){D=false;if(C.nodeType==f.NODE_TEXT){I=C.nodeValue;if(/[^\s\ufeff]/.test(I))C=null;D=/^[\s\ufeff]/.test(I)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(A&&x.$removeEmpty[C.nodeName.toLowerCase()]){I=l.text(C);if(/[^\s\ufeff]/.test(I))C=null;else{J=C.all||
C.getElementsByTagName("*");for(N=0;M=J[N++];)if(!x.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}}if(C)D=!!I.length}else C=null;if(D)if(A)if(H)y=z;else this.setEndAfter(z);if(C){D=C.nextSibling;if(!z&&!D){z=new d(C);C=null;break}C=D}else z=null}if(z)z=z.parent()}if(q&&y){b=q._4e_contains(y)?y:q;this.setStartBefore(b);this.setEndAfter(b)}break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:z=new r(this.document);g=new d(this.document.body);z.setStartAt(g,c.POSITION_AFTER_START);
z.setEnd(this.startContainer,this.startOffset);z=new m(z);var Q,R,W=m.blockBoundary(b==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};q=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};z.guard=$;z=z.lastBackward();Q=Q||g;this.setStartAt(Q,Q._4e_name()!="br"&&(!z&&this.checkStartOfBlock()||z&&Q._4e_contains(z))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);z=this.clone();z.collapse();z.setEndAt(g,c.POSITION_BEFORE_END);z=new m(z);z.guard=
b==c.ENLARGE_LIST_ITEM_CONTENTS?q:$;Q=null;z=z.lastForward();Q=Q||g;this.setEndAt(Q,!z&&this.checkEndOfBlock()||z&&Q._4e_contains(z)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var b=this.startContainer,g=this.startOffset;if(g&&b[0].nodeType==f.NODE_TEXT)if(s.trim(b[0].nodeValue.substring(0,g)).length)return false;this.trim();b=new a(this.startContainer);g=this.clone();g.collapse(true);g.setStartAt(b.block||b.blockLimit,c.POSITION_AFTER_START);
b=new m(g);b.evaluator=v(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,g=this.endOffset;if(b[0].nodeType==f.NODE_TEXT)if(s.trim(b[0].nodeValue.substring(g)).length)return false;this.trim();b=new a(this.endContainer);g=this.clone();g.collapse(false);g.setEndAt(b.block||b.blockLimit,c.POSITION_BEFORE_END);b=new m(g);b.evaluator=v(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,g){var q=this.clone();q[g==c.START?"setStartAt":"setEndAt"](b,g==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);b=new m(q);b.evaluator=w;return b[g==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,g=this.endContainer,q=this.startOffset,y=this.endOffset,z;if(b[0].nodeType==f.NODE_ELEMENT){z=b[0].childNodes.length;if(z>
q)b=new d(b[0].childNodes[q]);else if(z<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new d(b);b=b._4e_nextSourceNode()||b}}if(g[0].nodeType==f.NODE_ELEMENT){z=g[0].childNodes.length;if(z>y)g=(new d(g[0].childNodes[y]))._4e_previousSourceNode(true);else if(z<1)g=g._4e_previousSourceNode();else{for(g=g[0];g.lastChild;)g=g.lastChild;g=new d(g)}}if(b._4e_position(g)&k.POSITION_FOLLOWING)b=g;return{startNode:b,endNode:g}},fixBlock:function(b,g){var q=this.createBookmark();
g=new d(this.document.createElement(g));this.collapse(b);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);g[0].appendChild(this.extractContents());g._4e_trim();o.ie||g._4e_appendBogus();this.insertNode(g);this.moveToBookmark(q);return g},splitBlock:function(b){var g=new a(this.startContainer),q=new a(this.endContainer),y=g.block,z=q.block,C=null;if(g.blockLimit[0]!==q.blockLimit[0])return null;if(b!="br"){if(!y){y=this.fixBlock(true,b);z=(new a(this.endContainer)).block}z||(z=this.fixBlock(false,b))}b=y&&this.checkStartOfBlock();
g=z&&this.checkEndOfBlock();this.deleteContents();if(y&&l._4e_equals(y,z))if(g){C=new a(this.startContainer);this.moveToPosition(z,c.POSITION_AFTER_END);z=null}else if(b){C=new a(this.startContainer);this.moveToPosition(y,c.POSITION_BEFORE_START);y=null}else{z=this.splitElement(y);!o.ie&&!s.inArray(y._4e_name(),["ul","ol"])&&y._4e_appendBogus()}return{previousBlock:y,nextBlock:z,wasStartOfBlock:b,wasEndOfBlock:g,elementPath:C}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
c.POSITION_BEFORE_END);var g=this.extractContents(),q=b._4e_clone(false);q[0].appendChild(g);q.insertAfter(b);this.moveToPosition(b,c.POSITION_AFTER_END);return q},moveToElementEditablePosition:function(b,g){var q,y=u.XHTML_DTD;if(y.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==f.NODE_ELEMENT;){if(q=b._4e_isEditable())this.moveToPosition(b,g?c.POSITION_BEFORE_END:c.POSITION_AFTER_START);else if(y.$inline[b._4e_name()]){this.moveToPosition(b,g?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);
return true}if((b=y.$empty[b._4e_name()]?b[g?"_4e_previous":"_4e_next"](t):b[g?"_4e_last":"_4e_first"](t))&&b[0].nodeType==f.NODE_TEXT){this.moveToPosition(b,g?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);return true}}return q},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==f.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var i={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},p=new m.whitespaces,j=new m.bookmark;u.Range=r});
KISSY.Editor.add("domiterator",function(u){function r(h){if(!(arguments.length<1)){this.range=h;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var w=KISSY,t=w.UA,v=u.Walker,B=u.Range,n=u.RANGE,s=u.NODE,f=u.ElementPath,c=w.Node,k=w.DOM,m=/^[\r\n\t ]*$/,l=v.bookmark();w.augment(r,{getNextParagraph:function(h){var o,x,a,d,e;if(!this._.lastNode){x=this.range.clone();x.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var i=new v(x),p=v.bookmark(true,true);i.evaluator=p;this._.nextNode=i.next();i=new v(x);i.evaluator=p;i=i.previous();this._.lastNode=i._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==s.NODE_TEXT&&!w.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){p=new B(x.document);p.moveToPosition(this._.lastNode,n.POSITION_AFTER_END);if(p.checkEndOfBlock()){p=new f(p.endContainer);this._.lastNode=(p.block||p.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new c(x.document.createTextNode(""));k.insertAfter(this._.lastNode[0],i[0])}x=null}p=this._.nextNode;i=this._.lastNode;for(this._.nextNode=null;p;){var j=false,b=p[0].nodeType!=s.NODE_ELEMENT,g=false;if(b){if(p[0].nodeType==s.NODE_TEXT)if(m.test(p[0].nodeValue))b=false}else{var q=p._4e_name();if(p._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(q=="br")b=true;else if(!x&&!p[0].childNodes.length&&q!="hr"){o=p;a=p._4e_equals(i);break}if(x){x.setEndAt(p,n.POSITION_BEFORE_START);
if(q!="br")this._.nextNode=p}j=true}else{if(p[0].firstChild){if(!x){x=new B(this.range.document);x.setStartAt(p,n.POSITION_BEFORE_START)}p=new c(p[0].firstChild);continue}b=true}}if(b&&!x){x=new B(this.range.document);x.setStartAt(p,n.POSITION_BEFORE_START)}a=(!j||b)&&p._4e_equals(i);if(x&&!j)for(;!p[0].nextSibling&&!a;){q=p.parent();if(q._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){j=true;a||q._4e_equals(i);break}p=q;b=true;a=p._4e_equals(i);g=true}b&&x.setEndAt(p,n.POSITION_AFTER_END);p=p._4e_nextSourceNode(g,
null,i);a=!p;if((j||a)&&x){b=x.getBoundaryNodes();j=new f(x.startContainer);if(b.startNode.parent()._4e_equals(j.blockLimit)&&l(b.startNode)&&l(b.endNode)){x=null;this._.nextNode=null}else break}if(a)break}if(!o){if(!x){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}j=new f(x.startContainer);p=j.blockLimit;b={div:1,th:1,td:1};o=j.block;if((!o||!o[0])&&!this.enforceRealBlocks&&b[p._4e_name()]&&x.checkStartOfBlock()&&x.checkEndOfBlock())o=p;else if(!o||this.enforceRealBlocks&&
o._4e_name()=="li"){o=new c(this.range.document.createElement(h||"p"));o[0].appendChild(x.extractContents());o._4e_trim();x.insertNode(o);d=e=true}else if(o._4e_name()!="li"){if(!x.checkStartOfBlock()||!x.checkEndOfBlock()){o=o._4e_clone(false);o[0].appendChild(x.extractContents());o._4e_trim();e=x.splitBlock();d=!e.wasStartOfBlock;e=!e.wasEndOfBlock;x.insertNode(o)}}else if(!a)this._.nextNode=o._4e_equals(i)?null:x.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,i)}if(d){x=new c(o[0].previousSibling);
if(x[0]&&x[0].nodeType==s.NODE_ELEMENT)if(x._4e_name()=="br")x._4e_remove();else x[0].lastChild&&x[0].lastChild.nodeName.toLowerCase()=="br"&&k._4e_remove(x[0].lastChild)}if(e){x=v.bookmark(false,true);d=new c(o[0].lastChild);if(d[0]&&d[0].nodeType==s.NODE_ELEMENT&&d._4e_name()=="br")if(t.ie||d._4e_previous(x)||d._4e_next(x))d._4e_remove()}if(!this._.nextNode)this._.nextNode=a||o._4e_equals(i)?null:o._4e_nextSourceNode(true,null,i);return o}});B.prototype.createIterator=function(){return new r(this)}});
KISSY.Editor.add("selection",function(u){function r(e){this.document=e;this._={cache:{}};if(B.ie){var i=this.getNative().createRange();if(!i||i.item&&i.item(0).ownerDocument!=e||i.parentElement&&i.parentElement().ownerDocument!=e)this.isInvalid=true}}function w(e){e=new r(e);return!e||e.isInvalid?null:e}function t(e){var i=e.document,p=new f(i.body),j=new f(i.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)j.on("click",function(z){n._4e_name(z.target)==="html"&&e.getSelection().getRanges()[0].select()});
var b,g;p.on("focusin",function(z){if(z.target.nodeName.toUpperCase()=="BODY")if(b){try{b.select()}catch(C){}b=null}});p.on("focus",function(){g=true;y()});p.on("beforedeactivate",function(z){z.relatedTarget||(g=false)});B.ie<8&&s.on(n._4e_getWin(i),"blur",function(){i.selection.empty()});p.on("mousedown",q);p.on("mouseup",function(){g=true;setTimeout(function(){y(true)},0)});p.on("keydown",q);p.on("keyup",function(){g=true;y()});s.on(i,"selectionchange",y);var q=function(){g=false},y=function(z){if(g){var C=
e.document,H=e.getSelection(),A=H&&H.getType(),D=H&&H.getNative();if(z&&D&&A==c.SELECTION_NONE)if(!C.queryCommandEnabled("InsertImage")){setTimeout(function(){y(true)},50);return}var I;if(!(D&&A==c.SELECTION_TEXT&&(I=n._4e_name(D.createRange().parentElement()))&&I in{input:1,textarea:1})){b=D&&H.getRanges()[0];e._monitor()}}}}else{s.on(i,"mouseup",e._monitor,e);s.on(i,"keyup",e._monitor,e)}}u.SELECTION={};var v=KISSY,B=v.UA,n=v.DOM,s=v.Event,f=v.Node,c=u.SELECTION,k=u.RANGE,m=u.NODE,l=u.Walker,h=
u.Range;c.SELECTION_NONE=1;c.SELECTION_TEXT=2;c.SELECTION_ELEMENT=3;var o={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};v.augment(r,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=n._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var e=this._.cache;if(e.type)return e.type;
var i=c.SELECTION_NONE;try{var p=this.getNative(),j=p.type;if(j=="Text")i=c.SELECTION_TEXT;if(j=="Control")i=c.SELECTION_ELEMENT;if(p.createRange().parentElement)i=c.SELECTION_TEXT}catch(b){}return e.type=i}:function(){var e=this._.cache;if(e.type)return e.type;var i=c.SELECTION_TEXT,p=this.getNative();if(p){if(p.rangeCount==1){p=p.getRangeAt(0);var j=p.startContainer;if(j==p.endContainer&&j.nodeType==m.NODE_ELEMENT&&p.endOffset-p.startOffset===1&&o[j.childNodes[p.startOffset].nodeName.toLowerCase()])i=
c.SELECTION_ELEMENT}}else i=c.SELECTION_NONE;return e.type=i},getRanges:B.ie?function(){var e=function(i,p){i=i.duplicate();i.collapse(p);p=i.parentElement();for(var j=p.childNodes,b,g=0;g<j.length;g++){var q=j[g];if(q.nodeType==m.NODE_ELEMENT){b=i.duplicate();b.moveToElementText(q);q=b.compareEndPoints("StartToStart",i);var y=b.compareEndPoints("EndToStart",i);b.collapse();if(q>0)break;else if(!q||y==1&&q==-1)return{container:p,offset:g};else if(!y)return{container:p,offset:g+1};b=null}}if(!b){b=
i.duplicate();b.moveToElementText(p);b.collapse(false)}b.setEndPoint("StartToStart",i);i=b.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;i>0;)i-=j[--g].nodeValue.length}catch(z){i=0}return i===0?{container:p,offset:g}:{container:j[g],offset:-i}};return function(){var i=this._.cache;if(i.ranges)return i.ranges;var p=this.getNative(),j=p&&p.createRange(),b=this.getType();if(!p)return[];if(b==c.SELECTION_TEXT){p=new h(this.document);b=e(j,true);p.setStart(new f(b.container),b.offset);b=e(j);p.setEnd(new f(b.container),
b.offset);return i.ranges=[p]}else if(b==c.SELECTION_ELEMENT){i=this._.cache.ranges=[];for(b=0;b<j.length;b++){var g=j.item(b),q=g.parentNode,y=0;for(p=new h(this.document);y<q.childNodes.length&&q.childNodes[y]!=g;y++);p.setStart(new f(q),y);p.setEnd(new f(q),y+1);i.push(p)}return i}return i.ranges=[]}}():function(){var e=this._.cache;if(e.ranges)return e.ranges;var i=[],p=this.getNative();if(!p)return[];for(var j=0;j<p.rangeCount;j++){var b=p.getRangeAt(j),g=new h(this.document);g.setStart(new f(b.startContainer),
b.startOffset);g.setEnd(new f(b.endContainer),b.endOffset);i.push(g)}return e.ranges=i},getStartElement:function(){var e=this._.cache;if(e.startElement!==undefined)return e.startElement;var i,p=this.getNative();switch(this.getType()){case c.SELECTION_ELEMENT:return this.getSelectedElement();case c.SELECTION_TEXT:var j=this.getRanges()[0];if(j)if(!j.collapsed){for(j.optimize();;){i=j.startContainer;if(j.startOffset==(i[0].nodeType===m.NODE_ELEMENT?i[0].childNodes.length:i[0].nodeValue.length)&&!i._4e_isBlockBoundary())j.setStartAfter(i);
else break}i=j.startContainer;if(i[0].nodeType!=m.NODE_ELEMENT)return i.parent();i=new f(i[0].childNodes[j.startOffset]);if(!i[0]||i[0].nodeType!=m.NODE_ELEMENT)return j.startContainer;for(j=i[0].firstChild;j&&j.nodeType==m.NODE_ELEMENT;){i=new f(j);j=j.firstChild}return i}if(B.ie){j=p.createRange();j.collapse(true);i=j.parentElement()}else if((i=p.anchorNode)&&i.nodeType!=m.NODE_ELEMENT)i=i.parentNode}return e.startElement=i?n._4e_wrap(i):null},getSelectedElement:function(){var e=this._.cache;if(e.selectedElement!==
undefined)return e.selectedElement;var i=this,p;if(B.ie){p=i.getNative().createRange();p=p.item&&p.item(0)}p||(p=function(){for(var j=i.getRanges()[0],b,g,q=2;q&&!((b=j.getEnclosedNode())&&b[0].nodeType==m.NODE_ELEMENT&&o[b._4e_name()]&&(g=b));q--)j.shrink(k.SHRINK_ELEMENT);return g&&g[0]}());return e.selectedElement=n._4e_wrap(p)},reset:function(){this._.cache={}},selectElement:function(e){var i;if(B.ie)try{i=this.document.body.createControlRange();i.addElement(e[0]);i.select()}catch(p){i=this.document.body.createTextRange();
i.moveToElementText(e[0]);i.select()}finally{}else{i=this.document.createRange();i.selectNode(e[0]);e=this.getNative();e.removeAllRanges();e.addRange(i)}this.reset()},selectRanges:function(e){if(B.ie)e[0]&&e[0].select();else{var i=this.getNative();if(!i)return;i.removeAllRanges();for(var p=0;p<e.length;p++){var j=e[p],b=this.document.createRange(),g=j.startContainer;j.collapsed&&B.gecko&&B.gecko<1.09&&g[0].nodeType==m.NODE_ELEMENT&&!g[0].childNodes.length&&g[0].appendChild(this.document.createTextNode(""));
b.setStart(g[0],j.startOffset);b.setEnd(j.endContainer[0],j.endOffset);i.addRange(b)}}this.reset()},createBookmarks2:function(e){for(var i=[],p=this.getRanges(),j=0;j<p.length;j++)i.push(p[j].createBookmark2(e));return i},createBookmarks:function(e){for(var i=[],p=this.getRanges(),j=p.length,b=this.document,g,q=0;q<j;q++){i.push(g=p[q].createBookmark(e,true));var y=(e=g.serializable)?v.one("#"+g.startNode,b):g.startNode;g=e?v.one("#"+g.endNode,b):g.endNode;for(var z=q+1;z<j;z++){var C=p[z],H=C.startContainer,
A=C.endContainer;n._4e_equals(H,y.parent())&&C.startOffset++;n._4e_equals(H,g.parent())&&C.startOffset++;n._4e_equals(A,y.parent())&&C.endOffset++;n._4e_equals(A,g.parent())&&C.endOffset++}}return i},selectBookmarks:function(e){for(var i=[],p=0;p<e.length;p++){var j=new h(this.document);j.moveToBookmark(e[p]);i.push(j)}this.selectRanges(i);return this},getCommonAncestor:function(){var e=this.getRanges();return e[0].startContainer._4e_commonAncestor(e[e.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
u.Selection=r;var x={table:1,tbody:1,tr:1},a=l.whitespaces(true),d=/\ufeff|\u00a0/;h.prototype.select=B.ie?function(e){var i=this.collapsed,p,j;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var b=this.startContainer[0].childNodes[this.startOffset];if(b.nodeType==m.NODE_ELEMENT){(new r(this.document)).selectElement(new f(b));return}}if(this.startContainer[0].nodeType==m.NODE_ELEMENT&&this.startContainer._4e_name()in x||this.endContainer[0].nodeType==m.NODE_ELEMENT&&
this.endContainer._4e_name()in x)this.shrink(m.NODE_ELEMENT,true);var g=this.createBookmark();b=g.startNode;var q;if(!i)q=g.endNode;g=this.document.body.createTextRange();g.moveToElementText(b[0]);g.moveStart("character",1);if(q){e=this.document.body.createTextRange();e.moveToElementText(q[0]);g.setEndPoint("EndToEnd",e);g.moveEnd("character",-1)}else{for(p=b[0].nextSibling;p&&!a(p);)p=p.nextSibling;p=!(p&&p.nodeValue&&p.nodeValue.match(d))&&(e||!b[0].previousSibling||b[0].previousSibling&&n._4e_name(b[0].previousSibling)==
"br");j=this.document.createElement("span");j.innerHTML="&#65279;";j=new f(j);n.insertBefore(j[0],b[0]);p&&n.insertBefore(this.document.createTextNode("\ufeff"),b[0])}this.setStartBefore(b);b._4e_remove();if(i){if(p){g.moveStart("character",-1);g.select();this.document.selection.clear()}else g.select();if(j){this.moveToPosition(j,k.POSITION_BEFORE_START);j._4e_remove()}}else{this.setEndBefore(q);q._4e_remove();g.select()}}:function(){var e=this.startContainer;this.collapsed&&e[0].nodeType==m.NODE_ELEMENT&&
!e[0].childNodes.length&&e[0].appendChild(this.document.createTextNode(""));var i=this.document.createRange();i.setStart(e[0],this.startOffset);try{i.setEnd(this.endContainer[0],this.endOffset)}catch(p){if(p.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);i.setEnd(this.endContainer[0],this.endOffset)}else throw p;}e=w(this.document).getNative();e.removeAllRanges();e.addRange(i)};u.on("instanceCreated",function(e){t(e.editor)})});
KISSY.Editor.add("styles",function(u){function r(E,F){for(var G in E)E[G]=E[G].replace(aa,function(L,K){return F[K]})}function w(E,F){if(F){E=y.clone(E);r(E.attributes,F);r(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?C.STYLE_BLOCK:W[F]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:E}}function t(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new A(E);for(var G=E.getRanges(),L=0;L<G.length;L++)F.call(this,G[L]);E.selectRanges(G)}function v(E,
F){var G=E.element;if(G=="*")G="span";F=new N(F.createElement(G));return B(F,E)}function B(E,F){var G=F._.definition;F=G.attributes;G=w.getStyleText(G);if(F)for(var L in F)E.attr(L,F[L]);if(G)E[0].style.cssText=G;return E}function n(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var L,K=E.document;L=G.getNextParagraph();){var O=v(this,K);k(L,O)}E.moveToBookmark(F)}function s(E,F,G){var L="",K="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(L=P);S&&(K=S);return""});return L+E.replace(F,G)+K}function f(E,F){var G=E.html();G=s(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(G);return F}function c(E){var F=[];s(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,L,K){return L+"</pre>"+K+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,L){F.push(L)});return F}function k(E,F){var G=F._4e_name=="pre",L=E._4e_name=="pre",K=!G&&L;if(G&&!L)F=f(E,F);else if(K)F=l(c(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&m(F)}function m(E){var F;if((F=E._4e_previousSourceNode(true,D.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=s(F.html(),/\n$/,"")+"\n\n"+s(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function l(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),L=0;L<E.length;L++){var K=E[L];K=K.replace(/(\r\n|\r)/g,"\n");K=s(K,/^[ \t]*\n/,"");K=s(K,/\n$/,"");K=s(K,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});K=K.replace(/\n/g,"<br>");K=K.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(K);G.appendChild(O[0])}return G}
function h(E){var F=E.document;if(E.collapsed){F=v(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,L=this._.definition,K,O=u.XHTML_DTD[G]||(K=true,u.XHTML_DTD.span),P=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(z._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==D.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((u.XHTML_DTD[ca._4e_name()]||u.XHTML_DTD.span)[G]||K)&&(!L.parentRule||L.parentRule(ca))){if(!X&&(!ba||!u.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+
I.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==D.NODE_TEXT||V==D.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|I.POSITION_FOLLOWING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_FOLLOWING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=v(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==G){for(var Z in L.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in L.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());b(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(H.SHRINK_TEXT)}}function o(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var L=new Q(G.parent()),K,O=0,P;O<L.elements.length&&(P=L.elements[O]);O++){if(P==L.block||P==L.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,H.END),da=!S&&E.checkBoundaryOfElement(P,H.START);if(da||S){K=P;K.match=da?"start":"end"}else{P._4e_mergeSiblings();P._4e_name()==this.element?p(this,P):g(P,i(this)[P._4e_name()])}}}if(K&&K[0]){P=G;for(O=0;;O++){S=L.elements[O];if(z._4e_equals(S,K))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(P[0]);P=S}z[K.match=="start"?"insertBefore":"insertAfter"](P[0],K[0])}}else{var U=F.endNode,X=this;L=function(){for(var T=new Q(G.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
L();for(K=new N(G[0].nextSibling);K[0]!==U[0];){O=K._4e_nextSourceNode();if(K[0]&&K[0].nodeType==D.NODE_ELEMENT&&this.checkElementRemovable(K)){K._4e_name()==this.element?p(this,K):g(K,i(this)[K._4e_name()]);if(O[0].nodeType==D.NODE_ELEMENT&&O._4e_contains(G)){L();O=new N(G[0].nextSibling)}}K=O}}E.moveToBookmark(F)}function x(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,L,K){F[L]=K});return F}function a(E,F){typeof E=="string"&&(E=x(E));typeof F==
"string"&&(F=x(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function d(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function e(E){var F=E._AC;if(F)return F;F={};var G=0,L=E.attributes;if(L)for(var K in L){G++;F[K]=L[K]}if(L=w.getStyleText(E)){F.style||G++;F.style=L}F._length=G;return E._AC=
F}function i(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){y.isArray(G)||(G=[G]);for(var L=0;L<G.length;L++){var K=G[L],O,P;if(typeof K=="string")O=K.toLowerCase();else{O=K.element?K.element.toLowerCase():E.element;P=K.attributes}K=F[O]||(F[O]={});if(P){K=K.attributes=K.attributes||[];for(var S in P)K.push([S.toLowerCase(),P[S]])}}}return F}function p(E,F){var G=E._.definition,L=y.mix(y.mix({},G.attributes),i(E)[F._4e_name()]);G=G.styles;var K=y.isEmptyObject(L)&&
y.isEmptyObject(G);for(var O in L)if(!((O=="class"||E._.definition.fullMatch)&&F.attr(O)!=j(O,L[O]))){K=K||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in G)if(!(E._.definition.fullMatch&&F._4e_style(P)!=j(P,G[P],true))){K=K||!!F._4e_style(P);F._4e_style(P,"")}K&&q(F)}function j(E,F,G){var L=new N("<span></span>");L[G?"_4e_style":"attr"](E,F);return L[G?"_4e_style":"attr"](E)}function b(E,F){for(var G=i(E),L=F.all(E.element),K=L.length;--K>=0;)p(E,new N(L[K]));for(var O in G)if(O!=E.element){L=
F.all(O);for(K=L.length-1;K>=0;K--){var P=new N(L[K]);g(P,G[O])}}}function g(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var L=F[G][0],K;if(K=E.attr(L)){var O=F[G][1];if(O===null||O.test&&O.test(K)||typeof O=="string"&&K==O)E[0].removeAttribute(L)}}q(E)}function q(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==D.NODE_ELEMENT&&z._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==D.NODE_ELEMENT&&z._4e_mergeSiblings(G)}}}var y=KISSY,z=y.DOM,
C=u.STYLE={},H=u.RANGE,A=u.Selection,D=u.NODE,I=u.POSITION,J=u.Range,N=y.Node,M=y.UA,Q=u.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;C.STYLE_BLOCK=1;C.STYLE_INLINE=2;C.STYLE_OBJECT=3;w.prototype={apply:function(E){t.call(this,E,false)},remove:function(E){t.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==C.STYLE_INLINE?
h:this.type==C.STYLE_BLOCK?n:this.type==C.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==C.STYLE_INLINE?o:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=e(G);if(G._length){for(var L in G)if(L!="_length"){var K=E.attr(L)||"";if(L=="style"?a(G[L],d(K,false)):G[L]==K){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
i(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){L=G[F][0];if(L=E.attr(L)){K=G[F][1];if(K===null||typeof K=="string"&&L==K||K.test&&K.test(L))return true}}}return false},checkActive:function(E){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var F=E.elements,G=0,L;G<F.length;G++){L=F[G];if(!(this.type==C.STYLE_INLINE&&(z._4e_equals(L,E.block)||z._4e_equals(L,E.blockLimit))))if(!(this.type==
C.STYLE_OBJECT&&!(L._4e_name()in W)))if(this.checkElementRemovable(L,true))return true}}return false}};w.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",L="";if(G.length)G=G.replace($,";");for(var K in F){var O=F[K],P=(K+":"+O).replace($,";");if(O=="inherit")L+=P;else G+=P}if(G.length)G=d(G);G+=L;return E._ST=G};u.Style=w});
KISSY.Editor.add("bubbleview",function(){function u(f){u.superclass.constructor.apply(this,arguments);f.init&&f.init.call(this)}function r(f){f=s[f];if(!f.bubble)f.bubble=new u(f.cfg);return f.bubble}var w=KISSY.Editor,t=KISSY,v=t.Event,B=t.DOM,n=t.Node;if(!w.BubbleView){var s={};u.attach=function(f){var c=f.pluginInstance,k=f.pluginName;f=c.editor;var m=s[k];if(m){var l=m.cfg.func,h=s[k].bubble;f.on("selectionChange",function(o){o=o.path;var x=o.elements;if(o&&x)if(o=o.lastElement)if(o=l(o)){h=r(k);
h._selectedEl=o;h._plugin=c;h.show()}else if(h){h._selectedEl=h._plugin=null;h.hide()}});v.on(B._4e_getWin(f.document),"scroll blur",function(){h&&h.hide()});v.on(document,"click",function(){h&&h.hide()})}};u.register=function(f){s[f.pluginName]={cfg:f}};u.ATTRS={focusMgr:{value:false},draggable:{value:false}};t.extend(u,w.SimpleOverlay,{_createEl:function(){var f=(new n('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>')).appendTo(document.body);this.el=f;this.set("el",f)},show:function(){var f=
this._selectedEl,c=f._4e_getOffset(document);c.top+=f.height()+5;u.superclass.show.call(this,c)}});w.BubbleView=u}});
KISSY.Editor.add("button",function(){function u(v){u.superclass.constructor.call(this,v);this._init()}var r=KISSY.Editor,w=KISSY,t=w.Node;if(!r.TripleButton){u.ON="on";u.OFF="off";u.DISABLED="disabled";u.ON_CLASS="ke-triplebutton-on";u.OFF_CLASS="ke-triplebutton-off";u.DISABLED_CLASS="ke-triplebutton-disabled";u.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};w.extend(u,w.Base,{_init:function(){var v=this.get("container")[0]||this.get("container");this.el=new t("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));v.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var v=this.get("cls");v&&this.el.addClass(v)},_stateChange:function(v){this["_"+
v.newVal]();this._attachCls()},_action:function(v){this.fire(this.get("state")+"Click",v);this.fire("click",v);v.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});r.TripleButton=u}});
KISSY.Editor.add("clipboard",function(u){var r=KISSY.Editor,w=KISSY,t=w.Node,v=w.UA,B=r.Range,n=r.RANGE,s=w.Event;r.Paste||function(){function f(c){this.editor=c;this._init()}w.augment(f,{_init:function(){var c=this.editor;v.ie?s.on(c.document,"keydown",this._paste,this):s.on(c.document,"paste",this._paste,this)},_paste:function(c){if(!(c.type==="keydown"&&!(c.keyCode===86&&(c.ctrlKey||c.metaKey)))){var k=this,m=k.editor,l=m.document;if(k._running)c.halt();else{var h=m.getSelection();c=new B(l);var o=
new t(v.webkit?"<body></body>":"<div></div>",null,l);v.webkit&&o[0].appendChild(l.createTextNode("\u00a0"));l.body.appendChild(o[0]);o.css({position:"absolute",top:h.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});o.css("left","-1000px");var x=h.createBookmarks();c.setStartAt(o,n.POSITION_AFTER_START);c.setEndAt(o,n.POSITION_BEFORE_END);c.select(true);k._running=true;setTimeout(function(){o._4e_remove();var a;o=v.webkit&&(a=o._4e_first())&&a.hasClass("Apple-style-span")?
a:o;h.selectBookmarks(x);m.insertHtml(o.html());k._running=false},0)}}}});r.Paste=f}();u.addPlugin(function(){new r.Paste(u)})});
KISSY.Editor.add("color",function(u){function r(p){return("0"+p).slice(p.length-1,p.length+1)}function w(p){p=v.trim(p);if(p.charAt(0)=="#")p=p.substring(1);p=p.replace(/\s+/g,"");var j="";if(/^[0-9a-f]{3,3}$/i.test(p))j=p.replace(/[0-9a-f]/ig,function(g){return g+g});else{var b=p.match(k);if(b&&b[0])for(p=1;p<4;p++)j+=r(parseInt(b[p]).toString(16));else j=p}return"#"+j.toLowerCase()}for(var t=KISSY.Editor,v=KISSY,B=v.Node,n=v.Event,s=t.SimpleOverlay,f=t.Style,c=v.DOM,k=/^rgb\((\d+),(\d+),(\d+)\)$/i,
m="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),l={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},h={element:"span",styles:{"background-color":"#(color)"}},o="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
x={},a={},d=0;d<5;d++){o+="<tr>";for(var e=0;e<8;e++){var i=w(m[8*d+e]);o+="<td>";o+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+i+"'></span></a>";o+="</td>";x[i]=new f(h,{color:i});a[i]=new f(l,{color:i})}o+="</tr>"}x.inherit=new f(h,{color:"inherit"});a.inherit=new f(l,{color:"inherit"});o+="</table></div>";t.ColorSupport||function(){function p(b){p.superclass.constructor.call(this,b);this._init()}var j=t.TripleButton;p.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};v.extend(p,v.Base,{_init:function(){var b=this.get("editor"),g=new j({container:b.toolBarDiv,title:this.get("title"),contentCls:this.get("contentCls")});g.on("offClick",this._showColors,this);this.el=g;t.Utils.lazyRun(this,"_prepare","_real");t.Utils.sourceDisable(b,this)},disable:function(){this.el.set("state",j.DISABLED)},enable:function(){this.el.set("state",j.OFF)},_hidePanel:function(b){var g=this;c._4e_ascendant(b.target,function(q){return q[0]===g.el.el[0]},true)||this.colorWin.hide()},
_selectColor:function(b){b.halt();var g=this.get("editor");b=b.target;if(c._4e_name(b)=="span"||c._4e_name(b)=="a"){b=new B(b);if(b._4e_name()=="a")b=b.one("span");var q=this.get("styles");g.fire("save");b._4e_style("background-color")?q[w(b._4e_style("background-color"))].apply(g.document):q.inherit.remove(g.document);g.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(o);this.colorWin=new s({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);
this.colorPanel.on("click",this._selectColor,this);n.on(document,"click",this._hidePanel,this);n.on(u.document,"click",this._hidePanel,this)},_real:function(){var b=this.el.el.offset();b.top+=this.el.el.height()+5;if(b.left+this.colorPanel.width()>c.viewportWidth()-60)b.left=c.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(b)},_showColors:function(b){this._prepare(b)}});t.ColorSupport=p}();u.addPlugin(function(){new t.ColorSupport({editor:u,styles:x,title:"\u80cc\u666f\u989c\u8272",
contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new t.ColorSupport({editor:u,styles:a,title:"\u6587\u672c\u989c\u8272",contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("contextmenu",function(){function u(c){this.cfg=t.clone(c);w.Utils.lazyRun(this,"_prepareShow","_realShow")}function r(c,k){for(var m=0;m<k.length;m++){var l=k[m];if(t.isFunction(l)){if(l(new v(c)))return true}else if(B.test(c,l))return true}return false}var w=KISSY.Editor,t=KISSY,v=t.Node,B=t.DOM,n=t.Event;if(!w.ContextMenu){var s=[];u.register=function(c,k){var m=new u(k);s.push({doc:c,rules:k.rules||[],instance:m});if(!c.ke_contextmenu){c.ke_contextmenu=1;n.on(c,"mousedown",u.hide);
n.on(c,"contextmenu",function(l){u.hide.call(this);for(var h=new v(l.target);h;){var o=false;if(h._4e_name()=="body")break;for(var x=0;x<s.length;x++){var a=s[x].instance,d=s[x].rules;if(c===s[x].doc&&r(h[0],d)){l.preventDefault();o=true;setTimeout(function(){a.show(w.Utils.getXY(l.pageX,l.pageY,c,document))},30);break}}if(o)break;h=h.parent()}})}return m};u.hide=function(){for(var c=0;c<s.length;c++){var k=s[c].instance;this===s[c].doc&&k.hide()}};var f=w.SimpleOverlay;t.augment(u,{_init:function(){var c=
this,k=c.cfg,m=k.funcs;c.elDom=new v("<div class='ke-menu' onmousedown='return false;'></div>");var l=c.elDom;l.css("width",k.width);document.body.appendChild(l[0]);c.el=new f({el:l});for(var h in m){k=new v("<a href='#'>"+h+"</a>");l[0].appendChild(k[0]);(function(o,x){o._4e_unselectable();o.on("click",function(a){c.hide();a.halt();setTimeout(x,30)})})(k,m[h])}},hide:function(){this.el&&this.el.hide()},_realShow:function(c){this.el.show(c)},_prepareShow:function(){this._init()},show:function(c){this._prepareShow(c)}});
w.ContextMenu=u}});
KISSY.Editor.add("dd",function(){function u(){u.superclass.constructor.apply(this,arguments);this._init()}function r(){r.superclass.constructor.apply(this,arguments);this._init()}function w(){w.superclass.constructor.apply(this,arguments)}var t=KISSY,v=t.Editor,B=t.Event,n=t.DOM,s=t.Node;if(!v.DD){v.DD={};u.ATTRS={timeThred:{},activeDrag:{},drags:{value:{}}};t.extend(u,t.Base,{_init:function(){v.Utils.lazyRun(this,"_prepare","_real")},reg:function(c){var k=this.get("drags");if(!c[0].id)c[0].id=t.guid("drag-");
k[c[0].id]=c;this._prepare()},_move:function(c){var k=this.get("activeDrag");k&&k._move(c)},_start:function(c){this.set("activeDrag",c);this._pg.css({display:"",height:n.docHeight()})},_end:function(c){var k=this.get("activeDrag");if(k){k._end(c);this.set("activeDrag",null);this._pg.css({display:"none"})}},_prepare:function(){this._pg=(new s("<div style='background-color:red;position:absolute;left:0;width:100%;top:0;z-index:9999;'></div>")).appendTo(document.body);this._pg.css("opacity",0);B.on(document,
"mousemove",v.Utils.throttle(this._move,this,10));B.on(document,"mouseup",this._end,this)},_real:function(){}});v.DD.DDM=new u;var f=v.DD.DDM;r.ATTRS={node:{},handlers:{value:{}}};t.extend(r,t.Base,{_init:function(){var c=this.get("node"),k=this.get("handlers");f.reg(c);if(t.isEmptyObject(k))k[c[0].id]=c;for(var m in k)if(k.hasOwnProperty(m)){var l=k[m],h=l.css("cursor");if(!h||h==="auto")l.css("cursor","move");l._4e_unselectable()}c.on("mousedown",this._handleMouseDown,this);c.on("mouseup",function(){f._end()})},
_check:function(c){var k=this.get("handlers");for(var m in k)if(k.hasOwnProperty(m))if(k[m]._4e_equals(c))return true;return false},_handleMouseDown:function(c){if(this._check(new s(c.target))){c.halt();f._start(this);var k=this.get("node"),m=c.pageX;c=c.pageY;k=k.offset();this.startMousePos={left:m,top:c};this.startNodePos=k;this._diff={left:m-k.left,top:c-k.top};this.fire("start")}},_move:function(c){this.fire("move",c)},_end:function(){}});t.extend(w,r,{_init:function(){w.superclass._init.apply(this,
arguments);var c=this.get("node"),k=this;k.on("move",function(m){c.offset({left:m.pageX-k._diff.left,top:m.pageY-k._diff.top})})}});v.Draggable=r;v.Drag=w}});
KISSY.Editor.add("draft",function(u){var r=KISSY,w=r.Editor;w.Draft||function(){function t(c,k,m){for(c+="";c.length<k;)c=m+c;return c}function v(c){if(r.isNumber(c))c=new Date(c);return c instanceof Date?[c.getFullYear(),"-",t(c.getMonth()-1,2,"0"),"-",t(c.getDay(),2,"0")," ",t(c.getHours(),2,"0"),":",t(c.getMinutes(),2,"0"),":",t(c.getSeconds(),2,"0")].join(""):c}function B(c){this.editor=c;this._init()}var n=r.Node,s=r.JSON,f=window[w.STORE];r.augment(B,{_init:function(){var c=this,k=c.editor,
m=k.statusDiv;m=(new n("<div style='position:absolute;right:30px;bottom:0;width:600px'><span style=' vertical-align:middle;'>\u5185\u5bb9\u6b63\u6587\u6bcf5\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(m);c.timeTip=(new n("<span style=' vertical-align:middle;margin:0 10px;'>")).appendTo(m);var l=new w.Select({container:m,doc:k.document,width:"100px",popUpWidth:"220px",title:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"}),h=new w.TripleButton({text:"\u7acb\u5373\u4fdd\u5b58",
title:"\u7acb\u5373\u4fdd\u5b58",container:m}),o=f.getItem("ke-draft-save"),x=[];c.versions=l;if(o)x=r.isString(o)?s.parse(decodeURIComponent(o)):o;c.drafts=x;c.sync();h.on("click",function(){c.save(false)});setInterval(function(){c.save(true)},3E5);l.on("click",c.recover,c);c.holder=m;w.Utils.sourceDisable(k,c)},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var c=this.timeTip,k=this.versions,m=this.drafts;m.length>5&&
m.splice(0,m.length-5);for(var l=[],h,o=0;o<m.length;o++){h=m[o];h=(h.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e\uff1a"+v(h.date);l.push({name:h,value:o})}k.set("items",l.reverse());c.html(h);f.setItem("ke-draft-save",encodeURIComponent(s.stringify(m)))},save:function(c){var k=this.drafts,m=u._getRawData();if(k[k.length-1]&&m==k[k.length-1].content)k.length-=1;this.drafts=k.concat({content:m,date:(new Date).getTime(),auto:c});this.sync()},recover:function(c){var k=this.editor,m=this.drafts;
c=c.newVal;this.versions.reset("value");if(confirm("\u786e\u8ba4\u6062\u590d "+v(m[c].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")){k.fire("save");k._setRawData(m[c].content);k.fire("save")}}});w.Draft=B}();u.addPlugin(function(){w.storeReady(function(){new w.Draft(u)})})});
KISSY.Editor.add("elementpaths",function(u){var r=KISSY.Editor,w=KISSY,t=w.Node,v=w.DOM;r.ElementPaths||function(){function B(n){this.cfg=n;this._cache=[];this._init()}w.augment(B,{_init:function(){var n=this.cfg.editor;this.holder=new t("<span>");this.holder.appendTo(n.statusDiv);n.on("selectionChange",this._selectionChange,this);r.Utils.sourceDisable(n,this)},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},_selectionChange:function(n){var s=
this.cfg.editor,f=this.holder;f=f[0]||f;n=n.path.elements;var c,k;c=this._cache;for(k=0;k<c.length;k++){c[k].detach("click");c[k]._4e_remove()}this._cache=[];for(k=0;k<n.length;k++){c=n[k];var m=new t("<a href='#' class='elementpath'>"+(c.attr("_ke_real_element_type")||c._4e_name())+"</a>");this._cache.push(m);(function(l){m.on("click",function(h){h.halt();s.focus();setTimeout(function(){s.getSelection().selectElement(l)},50)})})(c);f.firstChild?v.insertBefore(m[0],f.firstChild):f.appendChild(m[0])}}});
r.ElementPaths=B}();u.addPlugin(function(){new r.ElementPaths({editor:u})})});
KISSY.Editor.add("enterkey",function(u){var r=KISSY.Editor,w=KISSY,t=w.UA,v=/^h[1-6]$/,B=r.XHTML_DTD,n=w.Node,s=w.Event,f=r.Walker,c=r.ElementPath;r.enterBlock||function(){function k(h){h=h.getSelection().getRanges();for(var o=h.length-1;o>0;o--)h[o].deleteContents();return h[0]}function m(h){var o=k(h),x=o.document;if(o.checkStartOfBlock()&&o.checkEndOfBlock()){var a=(new c(o.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){h.execCommand("outdent");return}}var d=o.splitBlock("p");
if(d){h=d.previousBlock;a=d.nextBlock;var e=d.wasStartOfBlock,i=d.wasEndOfBlock,p;if(a){p=a.parent();if(p._4e_name()=="li"){a._4e_breakParent(p);a._4e_move(a._4e_next(),true)}}else if(h&&(p=h.parent())&&p._4e_name()=="li"){h._4e_breakParent(p);o.moveToElementEditablePosition(h._4e_next());h._4e_move(h._4e_previous())}if(!e&&!i){if(a._4e_name()=="li"&&(p=a._4e_first(f.invisible(true)))&&w.inArray(p._4e_name(),["ul","ol"]))(t.ie?new n(x.createTextNode("\u00a0")):new n(x.createElement("br"))).insertBefore(p);
a&&o.moveToElementEditablePosition(a)}else{var j;if(h){if(h._4e_name()=="li"||!v.test(h._4e_name()))j=h._4e_clone()}else if(a)j=a._4e_clone();j||(j=new n("p",null,x));if(p=d.elementPath){d=0;for(var b=p.elements.length;d<b;d++){var g=p.elements[d];if(g._4e_equals(p.block)||g._4e_equals(p.blockLimit))break;if(B.$removeEmpty[g._4e_name()]){g=g._4e_clone();j._4e_moveChildren(g);j.append(g)}}}t.ie||j._4e_appendBogus();o.insertNode(j);if(t.ie&&e&&(!i||!h[0].childNodes.length)){o.moveToElementEditablePosition(i?
h:j);o.select()}o.moveToElementEditablePosition(e&&!i?a:j)}if(!t.ie)if(a){x=new n(x.createElement("span"));x.html("&nbsp;");o.insertNode(x);x._4e_scrollIntoView();o.deleteContents()}else j._4e_scrollIntoView();o.select()}}function l(h){s.on(h.document,"keydown",function(o){if(o.keyCode===13)if(!o.shiftKey){h.execCommand("enterBlock");o.preventDefault()}})}l.enterBlock=m;r.EnterKey=l}();u.addPlugin(function(){u.addCommand("enterBlock",{exec:r.EnterKey.enterBlock});r.EnterKey(u)})});
KISSY.Editor.add("fakeobjects",function(u){var r=KISSY.Editor,w=KISSY,t=w.Node,v=r.NODE,B=r.Config.base+"theme/spacer.gif",n=r.HtmlParser;r=w.Editor;var s=(u=u.htmlDataProcessor)&&u.htmlFilter,f={elements:{$:function(c){var k=c.attributes;if((k=(k=(k=k&&k._ke_realelement)&&new n.Fragment.FromHtml(decodeURIComponent(k)))&&k.children[0])&&c.attributes._ke_resizable){var m=c.attributes.style;if(m){var l=/(?:^|\s)width\s*:\s*(\d+)/i.exec(m);c=l&&l[1];m=(l=/(?:^|\s)height\s*:\s*(\d+)/i.exec(m))&&l[1];
if(c)k.attributes.width=c;if(m)k.attributes.height=m}}return k}}};s&&s.addRules(f);u&&w.mix(u,{createFakeParserElement:function(c,k,m,l,h){var o;o=new n.BasicWriter;c.writeHtml(o);o=o.getHtml();var x=c.attributes.style;if(c.attributes.width)x="width:"+c.attributes.width+"px;"+x;if(c.attributes.height)x="height:"+c.attributes.height+"px;"+x;c={"class":k,src:B,_ke_realelement:encodeURIComponent(o),_ke_real_node_type:c.type,style:x,align:c.attributes.align||""};h&&delete h.width;h&&delete h.height;h&&
w.mix(c,h,false);if(m)c._ke_real_element_type=m;if(l)c._ke_resizable=l;return new n.Element("img",c)}});w.augment(r,{createFakeElement:function(c,k,m,l,h,o){var x=c.attr("style")||"";if(c.attr("width"))x="width:"+c.attr("width")+"px;"+x;if(c.attr("height"))x="height:"+c.attr("height")+"px;"+x;c={"class":k,src:B,_ke_realelement:encodeURIComponent(h||c._4e_outerHtml()),_ke_real_node_type:c[0].nodeType,align:c.attr("align")||"",style:x};o&&delete o.width;o&&delete o.height;o&&w.mix(c,o,false);if(m)c._ke_real_element_type=
m;if(l)c._ke_resizable=l;return new t("<img/>",c,this.document)},restoreRealElement:function(c){if(c.attr("_ke_real_node_type")!=v.NODE_ELEMENT)return null;c=decodeURIComponent(c.attr("_ke_realelement"));var k=new t("<div>",null,this.document);k.html(c);return k._4e_first(function(m){return m[0].nodeType==v.NODE_ELEMENT})._4e_remove()}})});KISSY.Editor.add("flash",function(u){u.addPlugin(function(){new KISSY.Editor.Flash(u)})});
KISSY.Editor.add("flashsupport",function(u){var r=KISSY.Editor,w=KISSY,t=w.UA,v=w.Event,B=r.ContextMenu,n=w.Node,s=r.BubbleView,f=r.TripleButton,c=r.SimpleOverlay,k=u.htmlDataProcessor,m="ke_flash",l=r.Utils.flash;u=k&&k.dataFilter;r.Flash||function(){function h(d){this.editor=d;this._init()}function o(d){return d._4e_name()==="img"&&!!d.hasClass(m)&&d}var x=/\.swf(?:$|\?)/i;h.isFlashEmbed=function(d){d=d.attributes;return d.type=="application/x-shockwave-flash"||x.test(d.src||"")};w.augment(h,{_config:function(){this._cls=
m;this._type="flash";this._title="Flash\u5c5e\u6027";this._bodyHtml="<table><tr><td colspan='2'><label>\u7f51\u5740\uff1a <input  data-verify='^https?://[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp://' class='ke-flash-url' style='width:280px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></td></tr><tr><td><label>\u5bbd\u5ea6\uff1a <input  data-verify='^(?!0)\\d+(.\\d+)?$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-flash-width' style='width:60px' /> \u50cf\u7d20 </label></td><td><label>\u9ad8\u5ea6\uff1a<input  data-verify='^(?!0)\\d+(.\\d+)?$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-flash-height' style='width:60px' /> \u50cf\u7d20 </label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-flash-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label>\u95f4\u8ddd\uff1a<input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-flash-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>";
this._footHtml="<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=a;this._flashRules=["img."+m]},_init:function(){this._config();var d=this.editor,e={},i=this._contextMenu;d._toolbars=d._toolbars||{};d._toolbars[this._type]=this;this.el=new f({container:d.toolBarDiv,contentCls:this._contentCls,title:this._tip});this.el.on("offClick",this.show,this);if(i)for(var p in i)(function(j){e[j]=
function(){i[j](d)}})(p);B.register(d.document,{rules:this._flashRules,width:"120px",funcs:e});s.attach({pluginName:this._type,pluginInstance:this});v.on(d.document,"dblclick",this._dbclick,this);r.Utils.lazyRun(this,"_prepareShow","_realShow");r.Utils.sourceDisable(d,this)},disable:function(){this.el.set("state",f.DISABLED)},enable:function(){this.el.set("state",f.OFF)},_getFlashUrl:function(d){return l.getUrl(d)},_updateTip:function(d,e){e=this._getFlashUrl(this.editor.restoreRealElement(e));d.html(e);
d.attr("href",e)},_dbclick:function(d){var e=new n(d.target);if(e._4e_name()==="img"&&e.hasClass(this._cls)){this.show(null,e);d.halt()}},_prepareShow:function(){var d=new c({title:this._title,width:this._config_dwidth||"350px",mask:true});d.body.html(this._bodyHtml);d.foot.html(this._footHtml);this.d=d;this._initD()},_realShow:function(){this._updateD();this.d.show()},_updateD:function(){var d=this.editor,e=this.selectedFlash;if(e){d=d.restoreRealElement(e);d.attr("width")&&this.dWidth.val(parseInt(d.attr("width")));
d.attr("height")&&this.dHeight.val(parseInt(d.attr("height")));this.dAlign.val(d.attr("align"));this.dUrl.val(this._getFlashUrl(d));this.dMargin.val(parseInt(d._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");this.dWidth.val("");this.dHeight.val("");this.dAlign.val("");this.dMargin.val("5")}},show:function(d,e){this.selectedFlash=e;this._prepareShow()},_initD:function(){var d=this,e=d.d;d.dHeight=e.el.one(".ke-flash-height");d.dWidth=e.el.one(".ke-flash-width");
d.dUrl=e.el.one(".ke-flash-url");d.dAlign=e.el.one(".ke-flash-align");d.dMargin=e.el.one(".ke-flash-margin");var i=e.el.one(".ke-flash-ok");e=e.el.one(".ke-flash-cancel");i.on("click",d._gen,d);e.on("click",function(){d.d.hide()})},_getDInfo:function(){return{url:this.dUrl.val(),attrs:{width:this.dWidth.val(),height:this.dHeight.val(),align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px"}}},_gen:function(){var d=this.editor,e=this._getDInfo(),i=e&&w.trim(e.url),p=e&&e.attrs;
if(r.Utils.verifyInputs(this.d.el.all("input"))&&e){e=l.createSWF(i,{attrs:p},d.document);i=e.el;p=d.createFakeElement?d.createFakeElement(i,this._cls,this._type,true,e.html,p):i;p=d.insertElement(p);this.selectedFlash&&d.getSelection().selectElement(p);this.d.hide()}}});r.Flash=h;h.registerBubble=function(d,e,i){s.register({pluginName:d,func:i,init:function(){var p=this,j=p.el;j.html(e+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var b=j.one(".ke-bubbleview-url"),g=j.one(".ke-bubbleview-change");j=j.one(".ke-bubbleview-remove");g._4e_unselectable();b._4e_unselectable();j._4e_unselectable();g.on("click",function(q){p._plugin.show(null,p._selectedEl);q.halt()});j.on("click",function(q){var y=p._plugin;if(t.webkit){var z=y.editor.getSelection().getRanges();z&&z[0]&&(z[0].collapse(true)||1)&&z[0].select()}p._selectedEl._4e_remove();p.hide();y.editor.notifySelectionChange();q.halt()});p.on("beforeVisibleChange",function(q){var y=
p._selectedEl;q.newVal&&y&&p._plugin._updateTip(b,y)})}})};h.registerBubble("flash","Flash \u7f51\u5740\uff1a ",o);h.checkFlash=o;var a={"Flash\u5c5e\u6027":function(d){var e=d.getSelection();e=e&&e.getStartElement();e=o(e);d=d._toolbars.flash;e&&d.show(null,e)}};h.CLS_FLASH=m;h.TYPE_FLASH="flash"}();u&&u.addRules({elements:{object:function(h){var o=h.attributes;if(!(o.classid&&String(o.classid).toLowerCase())){for(o=0;o<h.children.length;o++)if(h.children[o].name=="embed"){if(!r.Flash.isFlashEmbed(h.children[o]))return null;
return k.createFakeParserElement(h,m,"flash",true)}return null}return k.createFakeParserElement(h,m,"flash",true)},embed:function(h){if(!r.Flash.isFlashEmbed(h))return null;return k.createFakeParserElement(h,m,"flash",true)}}},5)});
KISSY.Editor.add("flashutils",function(){var u=KISSY,r=u.Editor,w=r.Utils.flash;if(!w){var t=u.DOM,v=u.Node,B=u.UA;w={getUrl:function(n){var s="",f=r.NODE;if(n._4e_name()=="object"){n=n[0].childNodes;for(var c=0;c<n.length;c++)if(n[c].nodeType==f.NODE_ELEMENT)if((t.attr(n[c],"name")||"").toLowerCase()=="movie")s=t.attr(n[c],"value");else if(t._4e_name(n[c])=="embed")s=t.attr(n[c],"src");else if(t._4e_name(n[c])=="object")s=t.attr(n[c],"data")}else if(n._4e_name()=="embed")s=n.attr("src");return s},
createSWF:function(n,s,f){var c=s.attrs;s=s.flashVars;var k="",m="";f=f||document;if(c)for(var l in c)k+=l+"='"+c[l]+"' ";if(s){for(var h in s)m+="&"+h+"="+encodeURIComponent(s[h]);m=m.substring(1)}n="<object "+k+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" <param name="quality" value="high" /><param name="movie" value="'+n+'" />'+(m?'<param name="flashVars" value="'+m+'"/>':"")+"<embed "+k+" "+(m?'FlashVars="'+m+'"':"")+' pluginspage="http://www.macromedia.com/go/getflashplayer"  quality="high"  src="'+
n+'"  type="application/x-shockwave-flash"/></object>';return{el:new v(n,null,f),html:n}},createSWFRuntime2:function(n,s,f){f=f||document;var c=(new v("<div style='width:0;height:0;overflow:hidden;'>",null,f)).appendTo(f.body);c=w.createSWF.apply(this,arguments).el.appendTo(c);B.ie||(c=c.one("object"));return c[0]},createSWFRuntime:function(n,s,f){var c=s.attrs,k=s.flashVars,m="",l="";f=f||document;c=c||{};c.id=c.id||u.guid("ke-runtimeflash-");for(var h in c)m+=h+"='"+c[h]+"' ";if(k){for(var o in k)l+=
"&"+o+"="+encodeURIComponent(k[o]);l=l.substring(1)}n=B.ie?"<object "+m+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" <param name="quality" value="high" /><param name="wmode" value="transparent"/> <param name="movie" value="'+n+'" />'+(l?'<param name="flashVars" value="'+l+'" />':"")+"</object>":"<object type='application/x-shockwave-flash' data='"+n+"' "+m+'><param name="wmode" value="transparent"/> '+(l?'<param name="flashVars" value="'+l+'"/>':"")+"</object>";(new v("<div style='"+(s.style?
s.style:"width:0;height:0;overflow:hidden;")+"'>",null,f)).appendTo(f.body).html(n);return f.getElementById(c.id)}};r.Utils.flash=w}});
KISSY.Editor.add("font",function(u){var r=KISSY.Editor,w=KISSY,t=r.Style,v=r.TripleButton,B=u.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],n={},s=[],f={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},c=u.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],k={},m=[],l={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},h;u.cfg.pluginConfig["font-size"]=B;u.cfg.pluginConfig["font-family"]=c;for(h=0;h<B.length;h++){var o=B[h];n[o]=new t(f,{size:o});s.push({name:o,value:o})}for(h=0;h<c.length;h++){B=c[h];k[B]=new t(l,{family:B});m.push({name:B,value:B,attrs:{style:"font-family:"+B}})}r.Font||function(){function x(e){x.superclass.constructor.call(this,e);this._init()}function a(e){a.superclass.constructor.call(this,
e);this._init()}x.ATTRS={title:{},html:{},styles:{},editor:{}};var d=r.Select;w.extend(x,w.Base,{_init:function(){var e=this.get("editor"),i=e.toolBarDiv;this.get("html");this.el=new d({container:i,doc:e.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);e.on("selectionChange",this._selectionChange,this);r.Utils.sourceDisable(e,this)},disable:function(){this.el.set("state",d.DISABLED)},enable:function(){this.el.set("state",
d.ENABLED)},_vChange:function(e){var i=this.get("editor"),p=e.newVal;e=e.preVal;var j=this.get("styles");i.focus();i.fire("save");if(p==e){j[p].remove(i.document);this.el.set("value","")}else j[p].apply(i.document);i.fire("save")},_selectionChange:function(e){this.get("editor");e=e.path.elements;for(var i=this.get("styles"),p=0,j;p<e.length;p++){j=e[p];for(var b in i)if(i[b].checkElementRemovable(j,true)){this.el.set("value",b);return}}this.el.reset("value")}});a.ATTRS={editor:{},text:{},contentCls:{},
title:{},style:{}};w.extend(a,w.Base,{_init:function(){var e=this.get("editor"),i=this.get("text");this.get("style");var p=this.get("title");this.el=new v({text:i,title:p,contentCls:this.get("contentCls"),container:e.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);e.on("selectionChange",this._selectionChange,this);r.Utils.sourceDisable(e,this)},disable:function(){this.el.set("state",v.DISABLED)},enable:function(){this.el.set("state",v.OFF)},_on:function(){var e=
this.get("editor");this.get("text");var i=this.get("style");this.get("title");e.fire("save");i.apply(e.document);e.fire("save");e.notifySelectionChange();e.focus()},_off:function(){var e=this.get("editor");this.get("text");var i=this.get("style");this.get("title");e.fire("save");i.remove(e.document);e.fire("save");e.notifySelectionChange();e.focus()},_selectionChange:function(e){this.get("editor");this.get("text");var i=this.get("style");this.get("title");i.checkActive(e.path)?this.el.set("state",
v.ON):this.el.set("state",v.OFF)}});x.SingleFont=a;r.Font=x}();u.addPlugin(function(){new r.Font({editor:u,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:n,html:s});new r.Font({editor:u,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",styles:k,html:m});new r.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:u,style:new t({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new r.Font.SingleFont({contentCls:"ke-toolbar-italic",
title:"\u659c\u4f53 ",editor:u,style:new t({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new r.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",editor:u,style:new t({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new r.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:u,style:new t({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},
{element:"s"}]})})})});
KISSY.Editor.add("format",function(u){var r=KISSY.Editor,w=KISSY,t=[],v={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},B={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},n={},s=r.Style;for(var f in v)if(v[f]){n[v[f]]=new s({element:v[f]});t.push({name:f,value:v[f],attrs:{style:"font-size:"+B[v[f]]}})}r.Format||function(){function c(m){c.superclass.constructor.call(this,m);
this._init()}c.ATTRS={editor:{}};var k=r.Select;w.extend(c,w.Base,{_init:function(){var m=this.get("editor");this.el=new k({container:m.toolBarDiv,value:"",doc:m.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);m.on("selectionChange",this._selectionChange,this);r.Utils.sourceDisable(m,this)},disable:function(){this.el.set("state",k.DISABLED)},enable:function(){this.el.set("state",k.ENABLED)},
_vChange:function(m){var l=this.get("editor"),h=m.newVal;m=m.preVal;l.fire("save");if(h!=m)n[h].apply(l.document);else{n.p.apply(l.document);this.el.set("value","p")}l.fire("save")},_selectionChange:function(m){this.get("editor");m=m.path;for(var l in n)if(n[l].checkActive(m)){this.el.set("value",l);return}this.el.reset("value")}});r.Format=c}();u.addPlugin(function(){new r.Format({editor:u,html:t,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function u(){this._={output:[]}}var r=KISSY.Editor,w=r.Utils;if(!r.HtmlParser.BasicWriter){KISSY.augment(u,{openTag:function(t){this._.output.push("<",t)},openTagClose:function(t,v){v?this._.output.push(" />"):this._.output.push(">")},attribute:function(t,v){if(typeof v=="string")v=w.htmlEncodeAttr(v);this._.output.push(" ",t,'="',v,'"')},closeTag:function(t){this._.output.push("</",t,">")},text:function(t){this._.output.push(t)},comment:function(t){this._.output.push("<!--",
t,"--\>")},write:function(t){this._.output.push(t)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(t){var v=this._.output.join("");t&&this.reset();return v}});r.HtmlParser.BasicWriter=u}});
KISSY.Editor.add("htmlparser-comment",function(){function u(t){this.value=t;this._={isBlockLike:false}}var r=KISSY.Editor,w=r.NODE;if(!r.HtmlParser.Comment){r.HtmlParser.Comment=u;u.prototype={constructor:u,type:w.NODE_COMMENT,writeHtml:function(t,v){var B=this.value;if(v){if(!(B=v.onComment(B,this)))return;if(typeof B!="string"){B.parent=this.parent;B.writeHtml(t,v);return}}t.comment(B)}}}});
KISSY.Editor.add("htmlparser-element",function(){function u(v,B){this.name=v;this.attributes=B||(B={});this.children=[];var n=B._ke_real_element_type||v;B=r.XHTML_DTD;n=!!(B.$nonBodyContent[n]||B.$block[n]||B.$listItem[n]||B.$tableContent[n]||B.$nonEditable[n]||n=="br");var s=!!B.$empty[v];this.isEmpty=s;this.isUnknown=!B[v];this._={isBlockLike:n,hasInlineStarted:s||!n}}var r=KISSY.Editor;if(!r.HtmlParser.Element){var w=r.NODE,t=function(v,B){v=v[0];B=B[0];return v<B?-1:v>B?1:0};KISSY.augment(u,{type:w.NODE_ELEMENT,
add:r.HtmlParser.Fragment.prototype.add,clone:function(){return new u(this.name,this.attributes)},writeHtml:function(v,B){var n=this.attributes,s=this,f=s.name,c,k,m,l;s.filterChildren=function(){if(!l){var x=new r.HtmlParser.BasicWriter;r.HtmlParser.Fragment.prototype.writeChildrenHtml.call(s,x,B);s.children=(new r.HtmlParser.Fragment.FromHtml(x.getHtml())).children;l=1}};if(B){for(;;){if(!(f=B.onElementName(f)))return;s.name=f;if(!(s=B.onElement(s)))return;s.parent=this.parent;if(s.name==f)break;
if(s.type!=w.NODE_ELEMENT){s.writeHtml(v,B);return}f=s.name;if(!f){this.writeChildrenHtml.call(s,v,l?null:B);return}}n=s.attributes}v.openTag(f,n);for(var h=[],o=0;o<2;o++)for(c in n){k=c;m=n[c];if(o==1)h.push([c,m]);else if(B){for(;;)if(k=B.onAttributeName(c))if(k!=c){delete n[c];c=k}else break;else{delete n[c];break}if(k)if((m=B.onAttribute(s,k,m))===false)delete n[k];else n[k]=m}}v.sortAttributes&&h.sort(t);n=h.length;for(o=0;o<n;o++){c=h[o];v.attribute(c[0],c[1])}v.openTagClose(f,s.isEmpty);if(!s.isEmpty){this.writeChildrenHtml.call(s,
v,l?null:B);v.closeTag(f)}},writeChildrenHtml:function(){r.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});r.HtmlParser.Element=u}});
KISSY.Editor.add("htmlparser-filter",function(){function u(f){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};f&&this.addRules(f,10)}function r(f,c){for(var k=0;f&&k<c.length;k++){var m=c[k];f=f.replace(m[0],m[1])}return f}function w(f,c,k){if(typeof c=="function")c=[c];var m,l;l=f.length;var h=c&&c.length;if(h){for(m=0;m<l&&f[m].pri<k;m++);for(l=h-1;l>=0;l--)if(h=c[l]){h.pri=k;f.splice(m,0,h)}}}function t(f,c,k){if(c)for(var m in c){var l=f[m];f[m]=v(l,c[m],
k);l||f.$length++}}function v(f,c,k){if(c){c.pri=k;if(f){if(f.splice)w(f,c,k);else{f=f.pri>k?[c,f]:[f,c];f.filter=B}return f}else return c.filter=c}}function B(f){for(var c=f.type||f instanceof n.HtmlParser.Fragment,k=0;k<this.length;k++){if(c)var m=f.type,l=f.name;var h=this[k].apply(window,arguments);if(h===false)return h;if(c){if(h&&(h.name!=l||h.type!=m))return h}else if(typeof h!="string")return h;h!=undefined&&(f=h)}return f}var n=KISSY.Editor,s=n.NODE;if(!n.HtmlParser.Filter){KISSY.augment(u,
{addRules:function(f,c){if(typeof c!="number")c=10;w(this._.elementNames,f.elementNames,c);w(this._.attributeNames,f.attributeNames,c);t(this._.elements,f.elements,c);t(this._.attributes,f.attributes,c);this._.text=v(this._.text,f.text,c)||this._.text;this._.comment=v(this._.comment,f.comment,c)||this._.comment;this._.root=v(this._.root,f.root,c)||this._.root},onElementName:function(f){return r(f,this._.elementNames)},onAttributeName:function(f){return r(f,this._.attributeNames)},onText:function(f){var c=
this._.text;return c?c.filter(f):f},onComment:function(f,c){var k=this._.comment;return k?k.filter(f,c):f},onFragment:function(f){var c=this._.root;return c?c.filter(f):f},onElement:function(f){for(var c=[this._.elements["^"],this._.elements[f.name],this._.elements.$],k,m=0;m<3;m++)if(k=c[m]){k=k.filter(f,this);if(k===false)return null;if(k&&k!=f)return this.onNode(k);if(f.parent&&!f.name)break}return f},onNode:function(f){var c=f.type;return c==s.NODE_ELEMENT?this.onElement(f):c==s.NODE_TEXT?new n.HtmlParser.Text(this.onText(f.value)):
null},onAttribute:function(f,c,k){if(c=this._.attributes[c]){f=c.filter(k,f,this);if(f===false)return false;if(typeof f!="undefined")return f}return k}});n.HtmlParser.Filter=u}});
KISSY.Editor.add("htmlparser-fragment",function(){function u(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var r=KISSY.Editor;if(!r.HtmlParser.Fragment){var w={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},t=KISSY,v=r.Utils,B=r.NODE,n=r.XHTML_DTD,s=v.mix({table:1,ul:1,ol:1,dl:1},n.table,n.ul,n.ol,n.dl),f=n.$list,c=n.$listItem;u.FromHtml=function(k,m){function l(g){var q;if(d.length>0)for(var y=0;y<d.length;y++){var z=d[y],C=z.name,H=
n[C],A=i.name&&n[i.name];if((!A||A[C])&&(!g||!H||H[g]||!n[g])){if(!q){h();q=1}z=z.clone();z.parent=i;i=z;d.splice(y,1);y--}}}function h(){for(;e.length;)i.add(e.shift())}function o(g,q,y){q=q||i||a;if(m&&!q.type){var z,C;if((z=g.attributes&&(C=g.attributes._ke_real_element_type)?C:g.name)&&!(z in n.$body)&&!(z in n.$nonBodyContent)){z=i;i=q;x.onTagOpen(m,{});q=i;if(y)i=z}}if(g._.isBlockLike&&g.name!="pre"){y=g.children.length;if((z=g.children[y-1])&&z.type==B.NODE_TEXT)if(C=v.rtrim(z.value))z.value=
C;else g.children.length=y-1}q.add(g);if(g.returnPoint){i=g.returnPoint;delete g.returnPoint}}var x=new r.HtmlParser,a=new u,d=[],e=[],i=a,p=false,j;x.onTagOpen=function(g,q,y){var z=new r.HtmlParser.Element(g,q);if(z.isUnknown&&y)z.isEmpty=true;if(n.$removeEmpty[g])d.push(z);else{if(g=="pre")p=true;else if(g=="br"&&p){i.add(new r.HtmlParser.Text("\n"));return}if(g=="br")e.push(z);else{var C=i.name,H=C&&(n[C]||(i._.isBlockLike?n.div:n.span));if(H&&!z.isUnknown&&!i.isUnknown&&!H[g]){H=false;var A;
if(g in f&&C in f){C=i.children;(C=C[C.length-1])&&C.name in c||o(C=new r.HtmlParser.Element("li"),i);j=i;A=C}else if(g==C)o(i,i.parent);else{if(s[C])j||(j=i);else{o(i,i.parent,true);w[C]||d.unshift(i)}H=true}i=A?A:i.returnPoint||i.parent;if(H){x.onTagOpen.apply(this,arguments);return}}l(g);h();z.parent=i;z.returnPoint=j;j=0;if(z.isEmpty)o(z);else i=z}}};x.onTagClose=function(g){for(var q=d.length-1;q>=0;q--)if(g==d[q].name){d.splice(q,1);return}for(var y=[],z=[],C=i;C.type&&C.name!=g;){C._.isBlockLike||
z.unshift(C);y.push(C);C=C.parent}if(C.type){for(q=0;q<y.length;q++){var H=y[q];o(H,H.parent)}i=C;if(i.name=="pre")p=false;C._.isBlockLike&&h();o(C,C.parent);if(C==i)i=i.parent;d=d.concat(z)}if(g=="body")m=false};x.onText=function(g){if(!i._.hasInlineStarted&&!p){g=v.ltrim(g);if(g.length===0)return}h();l();if(m&&(!i.type||i.name=="body")&&v.trim(g))this.onTagOpen(m,{});p||(g=g.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));i.add(new r.HtmlParser.Text(g))};x.onCDATA=function(){};x.onComment=function(g){i.add(new r.HtmlParser.Comment(g))};
x.parse(k);for(h();i.type;){k=i.parent;var b=i;if(m&&(!k.type||k.name=="body")&&!n.$body[b.name]){i=k;x.onTagOpen(m,{});k=i}k.add(b);i=k}return a};t.augment(u,{add:function(k){var m=this.children.length;if(m=m>0&&this.children[m-1]||null){if(k._.isBlockLike&&m.type==B.NODE_TEXT){m.value=v.rtrim(m.value);if(m.value.length===0){this.children.pop();this.add(k);return}}m.next=k}k.previous=m;k.parent=this;this.children.push(k);this._.hasInlineStarted=k.type==B.NODE_TEXT||k.type==B.NODE_ELEMENT&&!k._.isBlockLike},
writeHtml:function(k,m){var l;this.filterChildren=function(){var h=new r.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,h,m,true);h=h.getHtml();this.children=(new u.FromHtml(h)).children;l=1};!this.name&&m&&m.onFragment(this);this.writeChildrenHtml(k,l?null:m)},writeChildrenHtml:function(k,m){for(var l=0;l<this.children.length;l++)this.children[l].writeHtml(k,m)}});r.HtmlParser.Fragment=u}});
KISSY.Editor.add("htmlparser",function(){function u(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var r=KISSY.Editor;if(!r.HtmlParser){var w=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,t={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},v=r.XHTML_DTD;KISSY.augment(u,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var n,s,f=0,c;n=this._.htmlPartsRegex.exec(B);){s=n.index;if(s>f){f=B.substring(f,s);c?c.push(f):this.onText(f)}f=this._.htmlPartsRegex.lastIndex;if(s=n[1]){s=s.toLowerCase();if(c&&v.$cdata[s]){this.onCDATA(c.join(""));c=null}if(!c){this.onTagClose(s);continue}}if(c)c.push(n[0]);else if(s=n[3]){s=s.toLowerCase();var k={},m;n=n[4];var l=!!(n&&n.charAt(n.length-1)=="/");if(n)for(;m=w.exec(n);){var h=
m[1].toLowerCase();m=m[2]||m[3]||m[4]||"";k[h]=!m&&t[h]?h:m}this.onTagOpen(s,k,l);if(!c&&v.$cdata[s])c=[]}else if(s=n[2])this.onComment(s)}B.length>f&&this.onText(B.substring(f,B.length))}});r.HtmlParser=u}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function u(){u.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var t=r.XHTML_DTD;for(var v in w.mix({},t.$nonBodyContent,t.$block,t.$listItem,t.$tableContent))this.setRules(v,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!t[v]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var r=KISSY.Editor,w=r.Utils;if(!r.HtmlParser.HtmlWriter){KISSY.extend(u,r.HtmlParser.BasicWriter,{openTag:function(t){var v=this._.rules[t];if(this._.indent)this.indentation();else if(v&&v.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",t)},openTagClose:function(t,v){t=this._.rules[t];
if(v)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(t&&t.indent)this._.indentation+=this.indentationChars}t&&t.breakAfterOpen&&this.lineBreak()},attribute:function(t,v){if(typeof v=="string"){this.forceSimpleAmpersand&&(v=v.replace(/&amp;/g,"&"));v=w.htmlEncodeAttr(v)}this._.output.push(" ",t,'="',v,'"')},closeTag:function(t){var v=this._.rules[t];if(v&&v.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(v&&v.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",t,">");v&&v.breakAfterClose&&this.lineBreak()},text:function(t){if(this._.indent){this.indentation();t=w.ltrim(t)}this._.output.push(t)},comment:function(t){this._.indent&&this.indentation();this._.output.push("<!--",t,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(t,v){var B=this._.rules[t];if(B)w.mix(B,v);else this._.rules[t]=v}});r.HtmlParser.HtmlWriter=u}});KISSY.Editor.add("htmlparser-text",function(){function u(w){this.value=w;this._={isBlockLike:false}}var r=KISSY.Editor;if(!r.HtmlParser.Text){KISSY.augment(u,{type:r.NODE.NODE_TEXT,writeHtml:function(w,t){var v=this.value;t&&!(v=t.onText(v,this))||w.text(v)}});r.HtmlParser.Text=u}});
KISSY.Editor.add("htmldataprocessor",function(u){function r(j){if(/mso-list\s*:\s*Ignore/i.test(j.attributes&&j.attributes.style))return true;return n}function w(j,b){var g=new s.HtmlParser.Element("ke:listbullet"),q;if(j)if(j[2]){j=isNaN(j[1])?/^[a-z]+$/.test(j[1])?"lower-alpha":/^[A-Z]+$/.test(j[1])?"upper-alpha":"decimal":"decimal";q="ol"}else{j=/[l\u00B7\u2002]/.test(j[1])?"disc":/[\u006F\u00D8]/.test(j[1])?"circle":/[\u006E\u25C6]/.test(j[1])?"square":"disc";q="ul"}else{j="decimal";q="ol"}g.attributes=
{"ke:listtype":q,style:"list-style-type:"+j+";"};g.add(new s.HtmlParser.Text(b));return g}function t(j){var b=j.attributes,g;if((g=j.removeAnyChildWithName("ke:listbullet"))&&g.length&&(g=g[0])){j.name="ke:li";if(b.style)b.style=v([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(q){q=q.split(" ");q=q[3]||q[1]||q[0];q=parseInt(q,10);if(!a&&d&&q>d)a=q-d;b["ke:margin"]=d=q}]],n)(b.style,j)||"";g=g.attributes;j.addStyle(g.style);f.mix(b,g);return true}return false}function v(j,b){return function(g,
q){var y=[];g.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(z,C,H){C=C.toLowerCase();C=="font-family"&&(H=H.replace(/["']/g,""));for(var A,D,I,J=0;J<j.length;J++)if(j[J]){z=j[J][0];A=j[J][1];D=j[J][2];I=j[J][3];if(C.match(z)&&(!A||H.match(A))){C=I||C;b&&(D=D||H);if(typeof D=="function")D=D(H,q,C);if(D&&D.push){C=D[0];D=D[1]}typeof D=="string"&&y.push([C,D]);return}}!b&&y.push([C,H])});for(g=0;g<y.length;g++)y[g]=y[g].join(":");return y.length?y.join(";")+";":false}}
function B(j){j=j.children;for(var b,g,q,y,z,C,H,A=0;A<j.length;A++){b=j[A];if("ke:li"==b.name){b.name="li";g=b.attributes;q=b.attributes["ke:listtype"];y=parseInt(g["ke:indent"],10)||a&&Math.ceil(g["ke:margin"]/a)||1;g.style&&(g.style=v([["list-style-type",q=="ol"?"decimal":"disc"]],n)(g.style)||"");if(C){if(y>H){C=new s.HtmlParser.Element(q);C.add(b);z.add(C)}else{if(y<H){z=H-y;for(var D;z--&&(D=C.parent);)C=D.parent}C.add(b)}j.splice(A--,1)}else{C=new s.HtmlParser.Element(q);C.add(b);j[A]=C}z=
b;H=y}else C=null}a=0}var n=n,s=KISSY.Editor,f=KISSY,c=f.UA,k=s.NODE,m=s.HtmlParser,l=new m.Filter,h=new m.Filter,o=s.XHTML_DTD;if(!u.htmlDataProcessor){(function(){var j=s.HtmlParser.Fragment.prototype,b=s.HtmlParser.Element.prototype;j.onlyChild=b.onlyChild=function(){var g=this.children;return g.length==1&&g[0]||null};b.removeAnyChildWithName=function(g){for(var q=this.children,y=[],z,C=0;C<q.length;C++){z=q[C];if(z.name){if(z.name==g){y.push(z);q.splice(C--,1)}y=y.concat(z.removeAnyChildWithName(g))}}return y};
b.getAncestor=function(g){for(var q=this.parent;q&&!(q.name&&q.name.match(g));)q=q.parent;return q};j.firstChild=b.firstChild=function(g){for(var q,y=0;y<this.children.length;y++){q=this.children[y];if(g(q))return q;else if(q.name)if(q=q.firstChild(g))return q}return null};b.addStyle=function(g,q,y){var z="";if(typeof q=="string")z+=g+":"+q+";";else{if(typeof g=="object")for(var C in g){if(g.hasOwnProperty(C))z+=C+":"+g[C]+";"}else z+=g;y=q}if(!this.attributes)this.attributes={};g=this.attributes.style||
"";g=(y?[z,g]:[g,z]).join(";");this.attributes.style=g.replace(/^;|;(?=;)/,"")};o.parentOf=function(g){var q={};for(var y in this)if(y.indexOf("$")==-1&&this[y][g])q[y]=1;return q}})();var x=v([[/mso/i],[/font-size/i,"",function(j){for(var b=u.cfg.pluginConfig["font-size"],g=0;g<b.length;g++)if(j.toLowerCase()==b[g])return j;return false},"font-size"],[/font-family/i,"",function(j){for(var b=u.cfg.pluginConfig["font-family"],g=0;g<b.length;g++)if(j.toLowerCase()==b[g].toLowerCase())return j;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],n),a,d=0,e=o.parentOf("ol"),i={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(j){j.filterChildren();B(j)},elements:{font:function(j){delete j.name},p:function(j){j.filterChildren();if(t(j))return n},$:function(j){var b=j.name||"";b.indexOf(":")!=-1&&b.indexOf("ke")==-1&&delete j.name;var g=j.attributes.style;if(b=="span"&&(!g||!x(g)))delete j.name;
if(b in e){j.filterChildren();B(j)}},table:function(j){var b=j.attributes.border;if(!b||b=="0")j.attributes["class"]="ke_show_border"},td:function(j){if(c.ie){j=j.children;var b=new s.HtmlParser.Text("&nbsp;");if(j.length)j[j.length-1].type!=k.NODE_TEXT&&j.push(b);else j.push(b)}},span:function(j){if(!c.gecko&&r(j.parent))return false;if(!c.gecko&&r(j)){j=(j=j.firstChild(function(g){return g.value||g.name=="img"}))&&(j.value||"l.");var b=j.match(/^([^\s]+?)([.)]?)$/);return w(b,j)}}},comment:!c.ie?
function(j,b){var g=j.match(/<img.*?>/);if(j=j.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){g=(b=j[1]||g&&"l.")&&b.match(/>([^\s]+?)([.)]?)</);return w(g,b)}if(c.gecko&&g){g=s.HtmlParser.Fragment.FromHtml(g[0]).children[0];(b=(b=(b=b.previous)&&b.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&b[1])&&(g.attributes.src=b);return g}return false}:function(){return false},attributes:{"class":function(j){if(/^ke_/.test(j))return j;return false},style:function(j){j=x(j);if(!j)return false;
return j}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},p={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(j){var b=j.parent;if(b&&b.name=="object"){var g=b.attributes.width;b=b.attributes.height;g&&(j.attributes.width=g);b&&(j.attributes.height=b)}},param:function(j){j.children=[];j.isEmpty=true;return j},a:function(j){if(!(j.children.length||j.attributes.name))return false},td:function(j){for(var b=j.children,g=0;g<b.length;g++)if(b[g].name=="br"){b.splice(g,1);--g}if(!j.children.length){b=
new s.HtmlParser.Text("&nbsp;");j.children.push(b)}},span:function(j){if(!j.children.length)return false}},attributes:{style:function(j){if(!f.trim(j))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(c.ie)p.attributes.style=function(j){return j.toLowerCase()};l.addRules(p);h.addRules(i);u.htmlDataProcessor={htmlFilter:l,dataFilter:h,toHtml:function(j,b){var g=new m.HtmlWriter;m.Fragment.FromHtml(j,b).writeHtml(g,l);return g.getHtml(true)},toDataFormat:function(j,b){if(c.gecko)j=
j.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var g=new m.BasicWriter;j=m.Fragment.FromHtml(j,b);g.reset();j.writeHtml(g,h);return g.getHtml(true)}}}});
KISSY.Editor.add("image",function(u){var r=KISSY.Editor,w=KISSY,t=w.UA,v=w.Node,B=w.Event,n=r.BubbleView,s=r.SimpleOverlay;r.ImageInserter||function(){function f(l){f.superclass.constructor.call(this,l);this._init()}var c=function(l){return l._4e_name()==="img"&&!/(^|\s+)ke_/.test(l[0].className)&&l},k=r.TripleButton;f.ATTRS={editor:{}};var m={"\u56fe\u7247\u5c5e\u6027":function(l){var h=l.getSelection();h=h&&h.getStartElement();h=c(h);l=l._toolbars.image;h&&l.show(null,h)}};w.extend(f,w.Base,{_init:function(){var l=
this.get("editor"),h=l.toolBarDiv,o={};this.editor=l;this.el=new k({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",container:h});this.el.on("offClick",this.show,this);B.on(l.document,"dblclick",this._dblclick,this);r.Utils.lazyRun(this,"_prepare","_real");l._toolbars=l._toolbars||{};l._toolbars.image=this;if(m)for(var x in m)(function(a){o[a]=function(){m[a](l)}})(x);r.ContextMenu.register(l.document,{rules:[c],width:"120px",funcs:o});n.attach({pluginName:"image",pluginInstance:this});
r.Utils.sourceDisable(l,this)},disable:function(){this.el.set("state",k.DISABLED)},enable:function(){this.el.set("state",k.OFF)},_dblclick:function(l){var h=new v(l.target);if(c(h)){this.show(null,h);l.halt()}},_prepare:function(){var l=this;l.get("editor");l.d=new s({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var h=l.d;h.body.html("<table><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input  data-verify='^https?://[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp://' class='ke-img-url' style='width:230px' value='http://'/></label></td></tr><tr><td><label><span>\u9ad8\u5ea6\uff1a </span><input  data-verify='^\u81ea\u52a8|((?!0)\\d+(.\\d+)?)$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-img-height' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td><td><label><span>\u5bbd\u5ea6\uff1a </span><input  data-verify='^\u81ea\u52a8|((?!0)\\d+(.\\d+)?)$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-img-width' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td></tr><tr><td><label><span>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label><span>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-img-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>");
h.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");l.content=h.el;h=l.content;var o=h.one(".ke-img-cancel"),x=h.one(".ke-img-insert");l.imgUrl=h.one(".ke-img-url");l.imgHeight=h.one(".ke-img-height");l.imgWidth=h.one(".ke-img-width");l.imgAlign=h.one(".ke-img-align");l.imgMargin=h.one(".ke-img-margin");o.on("click",function(a){l.d.hide();a.halt()});x.on("click",function(){l._insert()})},_updateTip:function(l,h){l.html(h.attr("src"));
l.attr("href",h.attr("src"))},_real:function(){this.d.show()},_insert:function(){var l=this.imgUrl.val();if(r.Utils.verifyInputs(this.d.el.all("input"))){var h=parseInt(this.imgHeight.val()),o=this.get("editor"),x=parseInt(this.imgWidth.val()),a=this.imgAlign.val(),d=parseInt(this.imgMargin.val()),e="";if(h)e+="height:"+h+"px;";if(x)e+="width:"+x+"px;";if(a)e+="float:"+a+";";isNaN(d)||(e+="margin:"+d+"px;");if(e)e=" style='"+e+"' ";l=new v("<img "+e+"src='"+l+"' alt='' />",null,o.document);l=o.insertElement(l,
h||x?null:function(i){i.on("load",function(){i.detach();i.css({width:i.width()+"px",height:i.height()+"px"})})});this._selectedEl&&o.getSelection().selectElement(l);this.d.hide();o.notifySelectionChange()}},_updateD:function(l){if(this._selectedEl=l){this.imgUrl.val(l.attr("src"));this.imgHeight.val(l.height());this.imgWidth.val(l.width());this.imgAlign.val(l._4e_style("float"));this.imgMargin.val(parseInt(l._4e_style("margin"))||0)}else{this.imgUrl.val("http://");this.imgHeight.val("\u81ea\u52a8");
this.imgWidth.val("\u81ea\u52a8");this.imgAlign.val();this.imgMargin.val("5")}},show:function(l,h){this._prepare();this._updateD(h)}});r.ImageInserter=f;(function(l,h,o){n.register({pluginName:l,func:o,init:function(){var x=this,a=x.el;a.html(h+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');var d=a.one(".ke-bubbleview-url"),
e=a.one(".ke-bubbleview-change");a=a.one(".ke-bubbleview-remove");e._4e_unselectable();d._4e_unselectable();a._4e_unselectable();e.on("click",function(i){x._plugin.show(null,x._selectedEl);i.halt()});a.on("click",function(i){var p=x._plugin;if(t.webkit){var j=p.editor.getSelection().getRanges();j&&j[0]&&(j[0].collapse(true)||1)&&j[0].select()}x._selectedEl._4e_remove();x.hide();p.editor.notifySelectionChange();i.halt()});x.on("afterVisibleChange",function(i){var p=x._selectedEl;i.newVal&&p&&x._plugin._updateTip(d,
p)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",c)}();u.addPlugin(function(){new r.ImageInserter({editor:u})})});
KISSY.Editor.add("indent",function(u){var r=KISSY.Editor,w={ol:1,ul:1},t=KISSY,v=r.Walker,B=t.DOM,n=t.Node,s=t.UA,f=r.NODE;r.Indent||function(){function c(e){this.type=e;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function k(e){return e.type=CKEDITOR.NODE_ELEMENT&&e.is("li")}function m(e,i,p){var j=i.startContainer;for(e=i.endContainer;j&&j.parent()[0]!==p[0];)j=j.parent();for(;e&&e.parent()[0]!==p[0];)e=e.parent();if(j&&e){var b=j;j=[];for(var g=false;!g;){if(b[0]===
e[0])g=true;j.push(b);b=b.next()}if(!(j.length<1)){b=p._4e_parents(true);for(e=0;e<b.length;e++)if(w[b[e]._4e_name()]){p=b[e];break}b=this.type=="indent"?1:-1;e=j[0];g=j[j.length-1];j={};var q=r.ListUtils.listToArray(p,j),y=q[g._4e_getData("listarray_index")].indent;for(e=e._4e_getData("listarray_index");e<=g._4e_getData("listarray_index");e++){q[e].indent+=b;var z=q[e].parent;q[e].parent=new n(z[0].ownerDocument.createElement(z._4e_name()))}for(e=g._4e_getData("listarray_index")+1;e<q.length&&q[e].indent>
y;e++)q[e].indent+=b;g=r.ListUtils.arrayToList(q,j,null,"p",0);b=[];if(this.type=="outdent"){var C;if((C=p.parent())&&C._4e_name()=="li"){q=g.listNode.childNodes;var H;for(e=q.length-1;e>=0;e--)if((H=new n(q[e]))&&H._4e_name()=="li")b.push(H)}}if(g){B.insertBefore(g.listNode,p[0]);p._4e_remove()}if(b&&b.length)for(e=0;e<b.length;e++){for(H=p=b[e];(H=H.next())&&H._4e_name()in w;){s.ie&&!p._4e_first(function(A){return x(A)&&a(A)})&&p[0].appendChild(i.document.createTextNode("\u00a0"));p[0].appendChild(H[0])}B.insertAfter(p[0],
C[0])}for(e in j)j[e]._4e_clearMarkers(j,true)}}}function l(e,i){i=i.createIterator();i.enforceRealBlocks=true;i.enlargeBr=true;for(var p;p=i.getNextParagraph();)h.call(this,e,p)}function h(e,i){e=parseInt(i._4e_style(this.indentCssProperty),10);if(isNaN(e))e=0;e+=(this.type=="indent"?1:-1)*this.indentOffset;if(e<0)return false;e=Math.max(e,0);e=Math.ceil(e/this.indentOffset)*this.indentOffset;i.css(this.indentCssProperty,e?e+this.indentUnit:"");i[0].style.cssText===""&&i[0].removeAttribute("style");
return true}function o(e){o.superclass.constructor.call(this,e);e=this.get("editor").toolBarDiv;this.el=new d({container:e,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new c(this.get("type"));this._init()}var x=v.whitespaces(true),a=v.bookmark(false,true);t.augment(c,{exec:function(e){for(var i=e.getSelection(),p=i&&i.getRanges()[0],j=p.startContainer,b=p.endContainer,g=p.getCommonAncestor();g&&!(g[0].nodeType==f.NODE_ELEMENT&&w[g._4e_name()]);)g=g.parent();if(g&&
j[0].nodeType==f.NODE_ELEMENT&&j._4e_name()in w){j=new v(p);j.evaluator=k;p.startContainer=j.next()}if(g&&b[0].nodeType==f.NODE_ELEMENT&&b._4e_name()in w){j=new v(p);j.evaluator=k;p.endContainer=j.previous()}b=i.createBookmarks(true);if(g){for(j=g._4e_first();j&&j[0]&&j._4e_name()!="li";)j=j.next();var q=p.startContainer;(j[0]==q[0]||j._4e_contains(q))&&h.call(this,e,g)||m.call(this,e,p,g)}else l.call(this,e,p);i.selectBookmarks(b)}});var d=r.TripleButton;o.ATTRS={type:{},contentCls:{},editor:{}};
t.extend(o,t.Base,{_init:function(){var e=this.get("editor"),i=this.el;i.on("offClick",this.exec,this);this.get("type")=="outdent"?e.on("selectionChange",this._selectionChange,this):i.set("state",d.OFF);r.Utils.sourceDisable(e,this)},disable:function(){this.el.set("state",d.DISABLED)},enable:function(){this.el.set("state",d.OFF)},exec:function(){var e=this.get("editor"),i=this;e.fire("save");setTimeout(function(){i.indentCommand.exec(e);e.fire("save");e.notifySelectionChange()},10)},_selectionChange:function(e){this.get("editor");
this.get("type");var i=e.path,p=i.blockLimit;e=this.el;if(i.contains(w))e.set("state",d.OFF);else(i=i.block||p)&&i._4e_style(this.indentCommand.indentCssProperty)?e.set("state",d.OFF):e.set("state",d.DISABLED)}});r.Indent=o}();u.addPlugin(function(){u.addCommand("outdent",new r.Indent({editor:u,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));u.addCommand("indent",new r.Indent({editor:u,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",
type:"indent"}))})});
KISSY.Editor.add("justify",function(u){var r=KISSY.Editor,w=KISSY,t=r.TripleButton;r.Justify||function(){function v(n,s,f,c){this.editor=n;this.v=s;this.contentCls=c;this.title=f;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;w.augment(v,{_init:function(){var n=this.editor;this.el=new t({contentCls:this.contentCls,title:this.title,container:n.toolBarDiv});n.on("selectionChange",this._selectionChange,this);this.el.on("offClick",this._effect,this);r.Utils.sourceDisable(n,this)},disable:function(){this.el.set("state",
t.DISABLED)},enable:function(){this.el.set("state",t.OFF)},_effect:function(){var n=this.editor,s=n.getSelection(),f=this.el.get("state");if(s){var c=s.createBookmarks(),k=s.getRanges(),m,l;n.fire("save");for(var h=k.length-1;h>=0;h--){m=k[h].createIterator();for(m.enlargeBr=true;l=m.getNextParagraph();){l.removeAttr("align");f==t.OFF?l.css("text-align",this.v):l.css("text-align","")}}n.notifySelectionChange();s.selectBookmarks(c);n.fire("save")}},_selectionChange:function(n){var s=this.el;n=n.path;
if(n=n.block||n.blockLimit){n=n.css("text-align").replace(B,"");n==this.v||!n&&this.v=="left"?s.set("state",t.ON):s.set("state",t.OFF)}}});r.Justify=v}();u.addPlugin(function(){new r.Justify(u,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new r.Justify(u,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new r.Justify(u,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(u){var r=KISSY.Editor;r.Link||function(){function w(l){this.editor=l;this._init()}function t(l){return l._4e_ascendant(function(h){return h._4e_name()==="a"&&!!h.attr("href")},true)}var v=KISSY,B=r.TripleButton,n=r.Style,s=v.Node,f=r.Range,c=r.SimpleOverlay,k=r.BubbleView,m={element:"a",attributes:{href:"#(href)",target:"#(target)"}};w.init=function(){var l=new c({title:"\u94fe\u63a5\u5c5e\u6027",mask:true,width:"300px"});this.dialog=l;l.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input  data-verify='^https?://[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp://' class='ke-link-url' style='width:220px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
l.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");l.urlEl=l.body.one(".ke-link-url");l.targetEl=l.body.one(".ke-link-blank");var h=l.foot.one(".ke-link-cancel");l.foot.one(".ke-link-ok").on("click",function(o){l.link._link();o.halt()},this);h.on("click",function(o){l.hide();o.halt()},this);w.init=null};k.register({pluginName:"link",func:t,init:function(){var l=this,h=l.el;h.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var o=h.one(".ke-bubbleview-url"),x=h.one(".ke-bubbleview-change");h=h.one(".ke-bubbleview-remove");x._4e_unselectable();o._4e_unselectable();h._4e_unselectable();x.on("click",function(a){l._plugin.show();a.halt()});h.on("click",function(a){var d=l._plugin;d._removeLink(l._selectedEl);d.editor.notifySelectionChange();a.halt()});l.on("afterVisibleChange",function(){var a=l._selectedEl;if(a){o.html(a.attr("href"));o.attr("href",a.attr("href"))}})}});v.augment(w,{_init:function(){var l=this.editor;this.el=
new B({container:l.toolBarDiv,contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5 "});this.el.on("offClick",this.show,this);k.attach({pluginName:"link",pluginInstance:this});r.Utils.sourceDisable(l,this)},disable:function(){this.el.set("state",B.DISABLED)},enable:function(){this.el.set("state",B.OFF)},_removeLink:function(l){var h=this.editor,o={href:l.attr("href")};if(l._4e_hasAttribute("target"))o.target=l.attr("target");l=new n(m,o);h.fire("save");l.remove(h.document);h.fire("save")},
_getSelectedLink:function(){var l=this.editor.getSelection();if(l=l&&l.getStartElement())l=t(l);return l},_link:function(){var l,h=this.editor,o=w.dialog,x=o.urlEl.val(),a;if(r.Utils.verifyInputs(o.el.all("input"))){o.hide();if(a=this._getSelectedLink()){l=new f(h.document);l.selectNodeContents(a);h.getSelection().selectRanges([l]);this._removeLink(a)}a={href:x};a.target=o.targetEl[0].checked?"_blank":"_self";l=h.getSelection().getRanges()[0];if(l.collapsed){l=new s("<a href='"+x+"' target='"+a.target+
"'>"+x+"</a>",null,h.document);h.insertElement(l)}else{h.fire("save");l=new n(m,a);l.apply(h.document);h.fire("save")}h.notifySelectionChange()}},_prepare:function(){w.init&&w.init()},_real:function(){var l=w.dialog,h=this._getSelectedLink();l.link=this;if(h){l.urlEl.val(h.attr("href"));l.targetEl[0].checked=h.attr("target")=="_blank"}l.show()},show:function(){this._prepare()}});r.Utils.lazyRun(w.prototype,"_prepare","_real");r.Link=w}();u.addPlugin(function(){new r.Link(u)})});
KISSY.Editor.add("list",function(u){var r=KISSY.Editor,w={ol:1,ul:1},t=["ol","ul"],v=KISSY,B=r.RANGE,n=r.ElementPath,s=r.Walker,f=r.NODE,c=v.UA,k=v.Node,m=v.DOM;r.List||function(){function l(d){this.type=d}function h(d){h.superclass.constructor.call(this,d);d=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:d});this.listCommand=new l(this.get("type"));this.listCommand.state=this.get("status");this._init()}var o={listToArray:function(d,
e,i,p,j){if(!w[d._4e_name()])return[];p||(p=0);i||(i=[]);for(var b=0,g=d[0].childNodes.length;b<g;b++){var q=new k(d[0].childNodes[b]);if(q._4e_name()=="li"){var y={parent:d,indent:p,element:q,contents:[]};if(j)y.grandparent=j;else{y.grandparent=d.parent();if(y.grandparent&&y.grandparent._4e_name()=="li")y.grandparent=y.grandparent.parent()}e&&q._4e_setMarker(e,"listarray_index",i.length);i.push(y);for(var z=0,C=q[0].childNodes.length,H;z<C;z++){H=new k(q[0].childNodes[z]);H[0].nodeType==f.NODE_ELEMENT&&
w[H._4e_name()]?o.listToArray(H,e,i,p+1,y.grandparent):y.contents.push(H)}}}return i},arrayToList:function(d,e,i,p){i||(i=0);if(!d||d.length<i+1)return null;for(var j=d[i].parent[0].ownerDocument,b=j.createDocumentFragment(),g=null,q=i,y=Math.max(d[i].indent,0),z=null;;){var C=d[q];if(C.indent==y){if(!g||d[q].parent._4e_name()!=g._4e_name()){g=d[q].parent._4e_clone(false,true);b.appendChild(g[0])}z=g[0].appendChild(C.element._4e_clone(false,true)[0]);for(var H=0;H<C.contents.length;H++)z.appendChild(C.contents[H]._4e_clone(true,
true)[0]);q++}else if(C.indent==Math.max(y,0)+1){q=o.arrayToList(d,null,q,p);z.appendChild(q.listNode);q=q.nextIndex}else if(C.indent==-1&&!i&&C.grandparent){z=w[C.grandparent._4e_name()]?C.element._4e_clone(false,true)[0]:C.grandparent._4e_name()!="td"?j.createElement(p):j.createDocumentFragment();for(H=0;H<C.contents.length;H++)z.appendChild(C.contents[H]._4e_clone(true,true)[0]);if(z.nodeType==f.NODE_DOCUMENT_FRAGMENT&&q!=d.length-1){z.lastChild&&z.lastChild.nodeType==f.NODE_ELEMENT&&z.lastChild.getAttribute("type")==
"_moz"&&m._4e_remove(z.lastChild);m._4e_appendBogus(z)}if(z.nodeType==f.NODE_ELEMENT&&m._4e_name(z)==p&&z.firstChild){m._4e_trim(z);g=z.firstChild;if(g.nodeType==f.NODE_ELEMENT&&m._4e_isBlockBoundary(g)){g=j.createDocumentFragment();m._4e_moveChildren(z,g);z=g}}g=m._4e_name(z);if(!c.ie&&(g=="div"||g=="p"))m._4e_appendBogus(z);b.appendChild(z);g=null;q++}else return null;if(d.length<=q||Math.max(d[q].indent,0)<y)break}if(e)for(d=new k(b.firstChild);d&&d[0];){d[0].nodeType==f.NODE_ELEMENT&&d._4e_clearMarkers(e,
true);d=d._4e_nextSourceNode()}return{listNode:b,nextIndex:q}}},x=/^h[1-6]$/;l.prototype={changeListType:function(d,e,i,p){var j=o.listToArray(e.root,i),b=[];for(d=0;d<e.contents.length;d++){var g=e.contents[d];g=g._4e_ascendant("li",true);if(!(!g||!g[0]||g._4e_getData("list_item_processed"))){b.push(g);g._4e_setMarker(i,"list_item_processed",true)}}g=new k(e.root[0].ownerDocument.createElement(this.type));for(d=0;d<b.length;d++){var q=b[d]._4e_getData("listarray_index");j[q].parent=g}i=o.arrayToList(j,
i,null,"p");var y;j=i.listNode.childNodes.length;for(d=0;d<j&&(y=new k(i.listNode.childNodes[d]));d++)y._4e_name()==this.type&&p.push(y);m.insertBefore(i.listNode,e.root[0]);e.root._4e_remove()},createList:function(d,e,i){var p=e.contents;d=e.root[0].ownerDocument;var j=[];if(p.length==1&&p[0][0]===e.root[0]){var b=new k(d.createElement("div"));p[0][0].nodeType!=f.NODE_TEXT&&p[0]._4e_moveChildren(b);p[0][0].appendChild(b[0]);p[0]=b}e=e.contents[0].parent();for(b=0;b<p.length;b++)e=e._4e_commonAncestor(p[b].parent());
for(b=0;b<p.length;b++)for(var g=p[b],q;q=g.parent();){if(q[0]===e[0]){j.push(g);break}g=q}if(!(j.length<1)){p=new k(j[j.length-1][0].nextSibling);b=new k(d.createElement(this.type));for(i.push(b);j.length;){i=j.shift();g=new k(d.createElement("li"));if(x.test(i._4e_name()))g[0].appendChild(i[0]);else{i._4e_copyAttributes(g);i._4e_moveChildren(g);i._4e_remove()}b[0].appendChild(g[0]);c.ie||g._4e_appendBogus()}p[0]?m.insertBefore(b[0],p[0]):e[0].appendChild(b[0])}},removeList:function(d,e,i){function p(H){if((z=
new k(y[H?"firstChild":"lastChild"]))&&!(z[0].nodeType==f.NODE_ELEMENT&&z._4e_isBlockBoundary())&&(C=e.root[H?"_4e_previous":"_4e_next"](s.whitespaces(true)))&&!(z[0].nodeType==f.NODE_ELEMENT&&C._4e_isBlockBoundary({br:1})))m[H?"insertBefore":"insertAfter"](d.document.createElement("br"),z[0])}for(var j=o.listToArray(e.root,i),b=[],g=0;g<e.contents.length;g++){var q=e.contents[g];q=q._4e_ascendant("li",true);if(!(!q||q._4e_getData("list_item_processed"))){b.push(q);q._4e_setMarker(i,"list_item_processed",
true)}}q=null;for(g=0;g<b.length;g++){q=b[g]._4e_getData("listarray_index");j[q].indent=-1;q=q}for(g=q+1;g<j.length;g++)if(j[g].indent>Math.max(j[g-1].indent,0)){b=j[g-1].indent+1-j[g].indent;for(q=j[g].indent;j[g]&&j[g].indent>=q;){j[g].indent+=b;g++}g--}var y=o.arrayToList(j,i,null,"p").listNode,z,C;p(true);p();m.insertBefore(y,e.root);e.root._4e_remove()},exec:function(d){var e=d.getSelection(),i=e&&e.getRanges();if(!(!i||i.length<1)){for(var p=e.createBookmarks(true),j=[],b={};i.length>0;){var g=
i.shift(),q=g.getBoundaryNodes(),y=q.startNode,z=q.endNode;y[0].nodeType==f.NODE_ELEMENT&&y._4e_name()=="td"&&g.setStartAt(q.startNode,B.POSITION_AFTER_START);z[0].nodeType==f.NODE_ELEMENT&&z._4e_name()=="td"&&g.setEndAt(q.endNode,B.POSITION_BEFORE_END);g=g.createIterator();for(g.forceBrBreak=false;q=g.getNextParagraph();){y=new n(q);z=y.elements;var C=null,H=false,A=y.blockLimit,D;for(y=z.length-1;y>=0&&(D=z[y]);y--)if(w[D._4e_name()]&&A.contains(D)){A._4e_removeData("list_group_object");if(y=D._4e_getData("list_group_object"))y.contents.push(q);
else{y={root:D,contents:[q]};j.push(y);D._4e_setMarker(b,"list_group_object",y)}H=true;break}if(!H)if(A._4e_getData("list_group_object"))A._4e_getData("list_group_object").contents.push(q);else{y={root:A,contents:[q]};A._4e_setMarker(b,"list_group_object",y);j.push(y)}}}for(i=[];j.length>0;){y=j.shift();if(this.state=="off")w[y.root._4e_name()]?this.changeListType(d,y,b,i):this.createList(d,y,i);else this.state=="on"&&w[y.root._4e_name()]&&this.removeList(d,y,b)}for(y=0;y<i.length;y++){C=i[y];var I=
this;(d=function(J){var N=C[J?"_4e_previous":"_4e_next"](s.whitespaces(true));if(N&&N[0]&&N._4e_name()==I.type){N._4e_remove();N._4e_moveChildren(C,J?true:false)}})();d(true)}r.Utils.clearAllMarkers(b);e.selectBookmarks(p)}}};var a=r.TripleButton;h.ATTRS={editor:{},type:{},contentCls:{}};v.extend(h,v.Base,{_init:function(){var d=this,e=d.get("editor"),i=d.el;d=d;i.on("offClick",d._change,d);e.on("selectionChange",d._selectionChange,d);r.Utils.sourceDisable(e,d)},disable:function(){this.el.set("state",
a.DISABLED)},enable:function(){this.el.set("state",a.OFF)},_change:function(){var d=this.get("editor");this.get("type");var e=this.el;d.fire("save");this.listCommand.state=e.get("state");this.listCommand.exec(d);d.fire("save");d.notifySelectionChange()},_selectionChange:function(d){this.get("editor");var e=this.get("type"),i=d.path,p;d=this.el;var j=i.blockLimit;if(i=i.elements)for(var b=0;b<i.length&&(p=i[b])&&p[0]!==j[0];b++){var g=v.indexOf(i[b]._4e_name(),t);if(g!==-1)if(t[g]===e){d.set("state",
a.ON);return}else break}d.set("state",a.OFF)}});r.ListUtils=o;r.List=h}();u.addPlugin(function(){new r.List({editor:u,title:"\u9879\u76ee\u5217\u8868",contentCls:"ke-toolbar-ul",type:"ul"});new r.List({editor:u,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("localStorage",function(){function u(){t.fire("storeReady")}function r(){n=t.Utils.flash.createSWFRuntime(B,{attrs:{allowScriptAccess:"always",allowNetworking:"all",scale:"noScale"},flashVars:{allowedDomain:location.hostname,shareData:true,YUISwfId:w.guid(s),YUIBridgeCallback:v+".ready",browser:s,useCompression:true}})}var w=KISSY,t=w.Editor,v;v=t.STORE="localStorage";if(!t.storeReady){t.storeReady=function(f){t.on("storeReady",f)};t.on("storeReady",function(){t.storeReady=function(f){f()};
t.detach("storeReady")})}if(window[v])window[v]._ke||u();else{var B=t.Config.base+t.Utils.debugUrl("plugins/localStorage/swfstore.swf"),n,s="ke-localstorage-";window[v]={_ke:1,getItem:function(f){return n.getValueOf(f)},setItem:function(f,c){return n.setItem(f,c)},removeItem:function(f){return n.removeItem(f)},ready:function(f,c){if(c.type=="contentReady"){u();this.ready=function(){}}}};r()}});
KISSY.Editor.add("maximize",function(u){var r=KISSY.Editor,w=KISSY,t=w.UA,v=w.Node,B=w.Event,n=r.TripleButton,s=w.DOM,f;r.Maximize||function(){function c(k){this.editor=k;this._init()}c.init=function(){f=new v("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(f[0]);c.init=null};w.augment(c,{_init:function(){this.el=new n({container:this.editor.toolBarDiv,title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});this.el.on("offClick",this.maximize,
this);this.el.on("onClick",this.restore,this);r.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var k=this,m=k.editor;B.remove(window,"resize",k._maximize,k);this._saveEditorStatus();m.wrap.css({height:k.iframeHeight});(new v(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";m.editorWrap.css({position:"static",width:k.editorWrapWidth});f.css({left:"-99999px",top:"-99999px"});window.scrollTo(k.scrollLeft,k.scrollTop);k.el.set("state",n.OFF);
setTimeout(function(){k._restoreEditorStatus()},30);m.notifySelectionChange()},_saveSate:function(){var k=this.editor;this.iframeHeight=k.wrap._4e_style("height");this.editorWrapWidth=k.editorWrap._4e_style("width");this.scrollLeft=s.scrollLeft();this.scrollTop=s.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var k=this.editor;if(t.gecko&&k.iframeFocus)this.savedRanges=(k=k.getSelection())&&k.getRanges()},_restoreEditorStatus:function(){var k=this.editor,m=k.getSelection();if(t.gecko&&
k.iframeFocus){this.el.el[0].focus();k.focus();this.savedRanges&&m&&m.selectRanges(this.savedRanges)}if(k.iframeFocus&&m)(k=m.getStartElement())&&k[0]&&k._4e_scrollIntoView()},_maximize:function(){var k=this.editor,m=s.viewportHeight(),l=s.viewportWidth(),h=k.statusDiv?k.statusDiv.height():0,o=k.toolBarDiv.height();if(t.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new v(document.body)).css({width:0,height:0,overflow:"hidden"});k.editorWrap.css({position:"absolute",
zIndex:990,width:l+"px"});f.css({zIndex:985,height:m+"px",width:l+"px"});k.editorWrap.offset({left:0,top:0});f.css({left:0,top:0});k.wrap.css({height:m-h-o-14+"px"});k.notifySelectionChange()},_real:function(){var k=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",k._maximize,k);this.el.set("state",n.ON);setTimeout(function(){k._restoreEditorStatus()},30)},_prepare:function(){c.init&&c.init()},maximize:function(){this._prepare()}});r.Maximize=c}();
u.addPlugin(function(){new r.Maximize(u)})});
KISSY.Editor.add("music",function(u){function r(l){return l.indexOf(c)!=-1}var w=KISSY.Editor,t=KISSY,v=t.DOM,B=t.UA,n=t.Event,s=w.Flash,f="ke_music",c="niftyplayer.swf",k=u.htmlDataProcessor,m=k&&k.dataFilter;m&&m.addRules({elements:{object:function(l){var h=l.attributes;if(!(h.classid&&String(h.classid).toLowerCase())){for(h=0;h<l.children.length;h++)if(l.children[h].name=="embed"){if(!s.isFlashEmbed(l.children[h]))return null;if(r(l.children[h].attributes.src))return k.createFakeParserElement(l,f,
"music",true)}return null}for(h=0;h<l.children.length;h++){var o=l.children[h];if(o.name=="param"&&o.attributes.name=="movie")if(r(o.attributes.value))return k.createFakeParserElement(l,f,"music",true)}},embed:function(l){if(!s.isFlashEmbed(l))return null;if(r(l.attributes.src))return k.createFakeParserElement(l,f,"music",true)}}},4);w.MusicInserter||function(){function l(p){l.superclass.constructor.apply(this,arguments);p.cfg.disableObjectResizing||n.on(p.document.body,B.ie?"resizestart":"resize",
function(j){v.hasClass(j.target,f)&&j.preventDefault()})}function h(p){return p._4e_name()==="img"&&!!p.hasClass(f)&&p}function o(p){return p.replace(/^.+niftyplayer\.swf\?file=/,"")}var x=w.Config.base+"plugins/music/niftyplayer.swf?file=#(music)",a="<p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input  data-verify='^https?://[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp://' class='ke-music-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3'/></label></p><p style='margin:5px 0'><label>\u5bf9"+
w.Utils.duplicateStr("&nbsp;",8)+"\u9f50\uff1a <select class='ke-music-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+w.Utils.duplicateStr("&nbsp;",1)+"<label>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-music-margin' style='width:60px' value='5'/> \u50cf\u7d20</label><p>",d=/#\(music\)/g,e=["img."+f];
t.extend(l,s,{_config:function(){this._cls=f;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml=a;this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=i;this._flashRules=e},_initD:function(){var p=this,j=p.d;p.dUrl=j.el.one(".ke-music-url");p.dAlign=j.el.one(".ke-music-align");p.dMargin=j.el.one(".ke-music-margin");var b=
j.el.one(".ke-music-ok");j=j.el.one(".ke-music-cancel");b.on("click",p._gen,p);j.on("click",function(){p.d.hide()})},_getDInfo:function(){return{url:x.replace(d,this.dUrl.val()),attrs:{width:165,height:37,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}},_getFlashUrl:function(p){return o(l.superclass._getFlashUrl.call(this,p))},_updateD:function(){var p=this.editor,j=this.selectedFlash;if(j){p=p.restoreRealElement(j);this.dUrl.val(this._getFlashUrl(p));this.dAlign.val(j.attr("align"));
this.dMargin.val(parseInt(p._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3");this.dAlign.val("");this.dMargin.val("5")}}});s.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",h);w.MusicInserter=l;var i={"\u97f3\u4e50\u5c5e\u6027":function(p){var j=p.getSelection();j=(j=j&&j.getStartElement())&&h(j);p=p._toolbars.music;j&&p.show(null,j)}}}();u.addPlugin(function(){new w.MusicInserter(u)})});
KISSY.Editor.add("overlay",function(){function u(){u.superclass.constructor.apply(this,arguments);this._init()}var r=KISSY.Editor,w=KISSY,t=w.UA,v=r.focusManager,B=w.Node,n=w.Event,s=w.DOM,f,c,k,m={left:"-9999px",top:"-9999px"};if(!r.SimpleOverlay){u.init=function(){var l=document.body,h={width:"100%",height:s.docHeight()+"px",opacity:0.4};w.mix(h,m);f=(new B('<div class="ke-mask">&nbsp;</div>')).appendTo(l);f.css(h);if(t.ie&&t.ie==6){k=(new B("<iframe class='ke-dialog-iframe'></iframe>")).appendTo(l);
c=(new B("<iframe class='ke-mask'></iframe>")).appendTo(l);w.all([c[0],k[0]]).css(h)}u.init=null};u.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false},draggable:{value:true}};w.extend(u,w.Base,{_init:function(){var l=this;l._createEl();var h=l.el;l.on("afterVisibleChange",function(o){if(o=o.newVal){typeof o=="boolean"?l.center():h.offset(o);l.fire("show")}else{h.css(m);l.fire("hide")}});if(l.get("focusMgr")){l._initFocusNotice();l.on("afterVisibleChange",
l._editorFocusMg,l)}l.on("afterVisibleChange",function(o){o.newVal?l._register():l._unregister()});if(t.ie===6){l.on("show",function(){var o=h.width(),x=h.height();k.css({width:o+"px",height:x+"px"});k.css(h.offset())});l.on("hide",function(){k.css(m)})}if(l.get("mask")){l.on("show",function(){w.all([f[0],c&&c[0]]).css({left:"0px",top:"0px"})});l.on("hide",function(){w.all([f[0],c&&c[0]]).css(m)})}},_register:function(){n.on(document,"keydown",this._keydown,this);f&&f.on("click",this.hide,this)},
_keydown:function(l){if(l.keyCode==27){this.hide();l.halt()}},_unregister:function(){n.remove(document,"keydown",this._keydown,this);f&&f.detach("click",this.hide,this)},_createEl:function(){var l=this,h=l.get("el");if(!h){h=(new B("<div class='ke-dialog' style='width:@width@'><div class='ke-hd'><span class='ke-hd-title'>@title@</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>".replace(/@width@/,l.get("width")).replace(/@title@/,
l.get("title")))).appendTo(document.body);var o=h.one(".ke-hd"),x=w.guid("ke-overlay-head-");l.body=h.one(".ke-bd");l.foot=h.one(".ke-ft");l._close=h.one(".ke-close");l._title=o.one("h1");l._close.on("click",function(a){a.preventDefault();l.hide()});if(l.get("draggable")){o[0].id=x;o=new r.Drag({node:h,handlers:{id:o}});t.ie===6&&o.on("move",function(){k.offset(h.offset())})}}l.set("el",h);l.el=h;h.css(m)},center:function(){var l=this.el,h=l.width(),o=l.height(),x=s.viewportWidth(),a=s.viewportHeight();
h=(x-h)/2+s.scrollLeft();o=(a-o)/2+s.scrollTop();if(o-s.scrollTop()>200)o-=150;l.css({left:h+"px",top:o+"px"})},_prepareShow:function(){u.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;return this._focusEl=(new B("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.el)},_initFocusNotice:function(){var l=this,h=l._getFocusEl();h.on("focus",function(){l.fire("focus")});h.on("blur",function(){l.fire("blur")})},
_editorFocusMg:function(l){var h=this._focusEditor;if(l.newVal){h=this._focusEditor=v.currentInstance();t.webkit||this._getFocusEl()[0].focus();var o=this.el.one("input");if(o)setTimeout(function(){try{o[0].focus();o[0].select()}catch(x){}},0);else if(t.ie&&h)if(l=h.document.selection.createRange())if(l.item&&l.item(0).ownerDocument==h.document){h=document.body.createTextRange();h.moveToElementText(this.el._4e_first()[0]);h.collapse(true);h.select()}}else h&&h.focus()},_realShow:function(l){this.set("visible",
l||true)},show:function(l){this._prepareShow(l)},hide:function(){this.set("visible",false)}});r.Utils.lazyRun(u.prototype,"_prepareShow","_realShow");r.SimpleOverlay=u}});
KISSY.Editor.add("pagebreak",function(u){var r=KISSY,w=r.Editor,t=u.htmlDataProcessor,v=t&&t.dataFilter,B="ke_pagebreak",n="div";v&&v.addRules({elements:{div:function(s){var f=s.attributes;var c=(f=f&&f.style)&&s.children.length==1&&s.children[0];if((c=c&&c.name=="span"&&c.attributes.style)&&/page-break-after\s*:\s*always/i.test(f)&&/display\s*:\s*none/i.test(c))return t.createFakeParserElement(s,B,n)}}});w.PageBreak||function(){function s(m){var l=new c({container:m.toolBarDiv,title:"\u5206\u9875",
contentCls:"ke-toolbar-pagebreak"});l.on("offClick",function(){var h=new f(k,null,m.document);h=m.createFakeElement?m.createFakeElement(h,B,n,true,k):h;h=(new f("<div>",null,m.document)).append(h);m.insertElement(h)});this.el=l;w.Utils.sourceDisable(m,this)}var f=r.Node,c=w.TripleButton,k='<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>';r.augment(s,{disable:function(){this.el.set("state",c.DISABLED)},enable:function(){this.el.set("state",c.OFF)}});w.PageBreak=
s}();u.addPlugin(function(){new w.PageBreak(u)})});
KISSY.Editor.add("preview",function(u){var r=KISSY.Editor,w=KISSY,t=r.TripleButton;r.Preview||function(){function v(B){this.editor=B;this._init()}w.augment(v,{_init:function(){this.el=new t({container:this.editor.toolBarDiv,title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,n=640,s=420,f=80;try{var c=window.screen;n=Math.round(c.width*0.8);s=Math.round(c.height*0.7);f=Math.round(c.width*0.1)}catch(k){}B=B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,
"<body>\n"+B.getData()+"\n</body>");n=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+n+",height="+s+",left="+f);n.document.open();n.document.write(B);n.document.close();n.focus()}});r.Preview=v}();u.addPlugin(function(){new r.Preview(u)})});
KISSY.Editor.add("progressbar",function(){var u=KISSY;u.Editor.ProgressBar||function(){function r(){r.superclass.constructor.apply(this,arguments);this._init()}u.DOM.addStyleSheet(".ke-progressbar {border:1px solid #8F8F73;}.ke-progressbar-inner {background-color:#FF8C00;height:100%;}.ke-progressbar-title {width:50px;left:50%;position:absolute;}","ke_progressbar");r.ATTRS={width:{},height:{},progress:{}};u.extend(r,u.Base,{_init:function(){var w=new Node("<div class='ke-progressbar' style='width:"+
this.get("width")+";height:"+this.get("height")+";'>"),t=(new Node("<div class='ke-progressbar-inner'>")).appendTo(w),v=(new Node("<span class='ke-progressbar-title'>")).appendTo(w);this.el=w;this._title=v;this._p=t},_progressChange:function(w){w=w.newVal;this._p.css("width",w+"%");this._title.html(w+"%")}})}()});
KISSY.Editor.add("removeformat",function(u){function r(m){this.editor=m;this._init()}function w(m,l){for(var h=0;h<l.length;h++)m.removeAttr(l[h])}var t=KISSY.Editor,v=KISSY,B=t.RANGE,n=t.ElementPath,s=t.NODE,f=t.TripleButton,c="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",k="class,style,lang,width,height,align,hspace,valign".split(",");c=new RegExp("^(?:"+c.replace(/,/g,"|")+")$","i");v.augment(r,{_init:function(){var m=this.editor;this.el=new f({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:m.toolBarDiv});this.el.on("offClick",this._remove,this);t.Utils.sourceDisable(m,this)},disable:function(){this.el.set("state",f.DISABLED)},enable:function(){this.el.set("state",f.OFF)},_remove:function(){var m=this.editor,l=c;l.lastIndex=0;var h=m.getSelection().getRanges();m.fire("save");for(var o=0,x;x=h[o];o++)if(!x.collapsed){x.enlarge(B.ENLARGE_ELEMENT);var a=x.createBookmark(),d=a.startNode,e=a.endNode,i=function(p){for(var j=new n(p),b=j.elements,
g=1,q;q=b[g];g++){if(q._4e_equals(j.block)||q._4e_equals(j.blockLimit))break;l.test(q._4e_name())&&p._4e_breakParent(q)}};i(d);i(e);for(d=d._4e_nextSourceNode(true,s.NODE_ELEMENT);d;){if(d._4e_equals(e))break;i=d._4e_nextSourceNode(false,s.NODE_ELEMENT);d._4e_name()=="img"&&d.attr("_cke_realelement")||(l.test(d._4e_name())?d._4e_remove(true):w(d,k));d=i}x.moveToBookmark(a)}m.getSelection().selectRanges(h);m.fire("save")}});u.addPlugin(function(){new r(u)})});
KISSY.Editor.add("resize",function(u){var r=KISSY,w=r.Editor,t=r.Node;w.Resizer||function(){function v(n){this.editor=n;this._init()}var B=w.Draggable;r.augment(v,{_init:function(){var n=this.editor,s=n.statusDiv,f=new t("<div class='ke-resizer'></div>");f.appendTo(s);s=new B({node:f});var c=0,k=0,m=n.wrap,l=n.editorWrap;s.on("start",function(){c=m.height();k=l.width()});s.on("move",function(h){var o=h.pageX-this.startMousePos.left;m.height(c+(h.pageY-this.startMousePos.top));l.width(k+o)})}});w.Resizer=
v}();u.addPlugin(function(){new w.Resizer(u)})});
KISSY.Editor.add("select",function(){function u(n){u.superclass.constructor.call(this,n);this._init()}var r=KISSY,w=r.Node,t=r.Event,v=r.DOM,B=r.Editor;if(!B.Select){u.DISABLED=0;u.ENABLED=1;u.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{},state:{value:1}};r.extend(u,r.Base,{_init:function(){var n=this.get("container"),s=new w("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a></span>"),f=
this.get("title"),c=s.one(".ke-select-text");s.one(".ke-select-drop");c.html(f);c.css("width",this.get("width"));s._4e_unselectable();s.attr("title",f);s.appendTo(n);s.on("click",this._click,this);this.el=s;this.title=c;this._focusA=s.one("a.ke-select");B.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_valueChange:function(n){n=n.newVal;for(var s=this.get("title"),f=this.get("items"),c=0;c<f.length;c++){var k=
f[c];if(k.value==n){s=k.name;break}}this.title.html(s)},_itemsChange:function(n){n=n.newVal;var s=this._selectList;s.html("");if(n)for(var f=0;f<n.length;f++){var c=n[f];(new w("<a class='ke-select-menu-item' href='#' data-value='"+c.value+"'>"+c.name+"</a>",c.attrs)).appendTo(s)._4e_unselectable()}this.as=s.all("a")},_prepare:function(){var n=this,s=n.el,f=n._focusA,c=new w("<div class='ke-menu' onmousedown='return false;'></div>"),k=new B.SimpleOverlay({el:c,focusMgr:false}),m=n.get("items");n.menu=
k;n.get("title")&&(new w("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+n.get("title")+"</div>")).appendTo(c);n._selectList=(new w("<div>")).appendTo(c);n._itemsChange({newVal:m});n.get("popUpWidth")&&c.css("width",n.get("popUpWidth"));c.appendTo(document.body);k.on("show",function(){f.addClass("ke-select-active")});k.on("hide",function(){f.removeClass("ke-select-active")});t.on([document,n.get("doc")],"click",function(l){s._4e_contains(l.target)||k.hide()});c.on("click",
n._select,n);n.as=n._selectList.all("a");t.on(c[0],"mouseenter",function(){n.as.removeClass("ke-menu-selected")});n.on("afterItemsChange",n._itemsChange,n)},_stateChange:function(n){var s=this.el;n.newVal==1?s.removeClass("ke-select-disabled"):s.addClass("ke-select-disabled")},_select:function(n){n.halt();var s=this.menu,f=s.el;if(n=(new w(n.target))._4e_ascendant(function(m){return f._4e_contains(m)&&m._4e_name()=="a"},true)){var c=this.get("value"),k=n.attr("data-value");this.set("value",k);this.fire("click",
{newVal:k,preVal:c,name:n.html()});s.hide()}},_real:function(){var n=this.el.offset(),s=r.clone(n),f=this.menu.el.height(),c=this.menu.el.width();n.top+=this.el.height();if(n.top+f>v.scrollTop()+v.viewportHeight()){n=s;n.top-=f+12}n.left+=1;if(n.left+c>v.viewportWidth()-60)n.left=v.viewportWidth()-c-60;this.menu.show(n)},_click:function(n){n.preventDefault();n=this.el;var s=this.get("value");if(!n.hasClass("ke-select-disabled"))if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();
s&&this.menu&&this.as.each(function(f){f.attr("data-value")==s?f.addClass("ke-menu-selected"):f.removeClass("ke-menu-selected")})}}});B.Select=u}});
KISSY.Editor.add("smiley",function(u){var r=KISSY.Editor,w=KISSY,t=w.DOM,v=w.Event,B=w.Node,n=r.SimpleOverlay,s=r.TripleButton;r.Smiley||function(){function f(m){this.editor=m;this._init()}for(var c="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",k=0;k<=98;k++)c+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+k+".gif'></a>";c+="</div></div>";w.augment(f,{_init:function(){var m=this.editor;this.el=new s({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",
container:m.toolBarDiv});this.el.on("offClick",this._show,this);r.Utils.lazyRun(this,"_prepare","_real");r.Utils.sourceDisable(m,this)},disable:function(){this.el.set("state",s.DISABLED)},enable:function(){this.el.set("state",s.OFF)},_hidePanel:function(m){var l=this;t._4e_ascendant(m.target,function(h){return h[0]===l.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(m){m.halt();var l=this.editor;m=m.target;var h;if(t._4e_name(m)=="a"&&(h=t.attr(m,"data-icon"))){h=new B("<img alt='' src='"+
h+"'/>",null,l.document);l.insertElement(h);this.smileyWin.hide()}},_prepare:function(){var m=this.editor;this.smileyPanel=new B(c);this.smileyWin=new n({el:this.smileyPanel,focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);v.on(document,"click",this._hidePanel,this);v.on(m.document,"click",this._hidePanel,this)},_real:function(){var m=this.el.el.offset();m.top+=this.el.el.height()+5;if(m.left+this.smileyPanel.width()>t.viewportWidth()-
60)m.left=t.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(m)},_show:function(m){this._prepare(m)}});r.Smiley=f}();u.addPlugin(function(){new r.Smiley(u)})});
KISSY.Editor.add("sourcearea",function(u){var r=KISSY.Editor,w=KISSY,t=w.UA,v=r.TripleButton;r.SourceArea||function(){function B(n){this.editor=n;this._init()}w.augment(B,{_init:function(){var n=this.editor;this.el=new v({container:n.toolBarDiv,title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);n.textarea.on("mousedown",function(s){s.stopPropagation()})},_show:function(){var n=this.editor,s=this.el;n.textarea.val(n.getData());
n._showSource();s.set("state",v.ON)},_hide:function(){var n=this.editor,s=n.textarea,f=this.el;n._hideSource();n.setData(s.val());if(t.gecko&&n.iframeFocus){f.el[0].focus();n.focus()}f.set("state",v.OFF)}});r.SourceArea=B}();u.addPlugin(function(){new r.SourceArea(u)})});
KISSY.Editor.add("table",function(u,r){var w=KISSY.Editor,t=KISSY,v=t.Node,B=t.DOM,n=w.Walker,s=t.UA,f=w.NODE,c=w.TripleButton,k=w.SimpleOverlay,m=w.ContextMenu,l=["tr","th","td","tbody","table"],h=t.trim,o;o=(s.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var x=u.htmlDataProcessor,a=x&&x.dataFilter;x=x&&x.htmlFilter;a&&a.addRules({elements:{table:function(d){d=d.attributes;var e=d["class"],i=parseInt(d.border,10);if(!i||i<=0)d["class"]=(e||"")+" ke_show_border"}}});x&&x.addRules({elements:{table:function(d){d=d.attributes;var e=d["class"];if(e)d["class"]=t.trim(e.replace("ke_show_border","").replace(/\s{2}/," "))}}});w.TableUI||function(){function d(A){this.editor=A;this.selectedTable=
null;A._toolbars=A._toolbars||{};A._toolbars.table=this;this._init()}function e(A){return h(A).length!=0}function i(A){function D($){if(!(N.length>0))if($[0].nodeType==f.NODE_ELEMENT&&C.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var I=A.createBookmarks(),J=A.getRanges(),N=[],M={},Q=0;Q<J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new n(R);
var W;for(R.guard=D;W=R.next();)if((W=W.parent())&&C.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}w.Utils.clearAllMarkers(M);A.selectBookmarks(I);return N}function p(A){A=A.cells;for(var D=0;D<A.length;D++){A[D].innerHTML="";s.ie||(new v(A[D]))._4e_appendBogus()}}function j(A,D){if(A=A.getStartElement()._4e_ascendant("tr")){var I=A._4e_clone(true);I.insertBefore(A);p(D?I[0]:A[0])}}function b(A){if(A instanceof w.Selection){var D=i(A),I=D.length;
A=[];for(var J,N,M=0;M<I;M++){var Q=D[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);A[R]=Q;M==I-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new v(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=A.length;M>=0;M--)A[M]&&b(A[M]);return J}else if(A instanceof v){M=A._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():A._4e_remove()}return 0}function g(A,D){A=A.getStartElement();if(A=A._4e_ascendant("td",true)||A._4e_ascendant("th",true))for(var I=A._4e_ascendant("table"),J=A[0].cellIndex,
N=0;N<I[0].rows.length;N++){var M=I[0].rows[N];if(!(M.cells.length<J+1)){A=new v(M.cells[J].cloneNode(false));s.ie||A._4e_appendBogus();M=new v(M.cells[J]);D?A.insertBefore(M):A.insertAfter(M)}}}function q(A){var D=[],I=A[0]&&A[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=A.length;J<N;J++)D.push(A[J][0].cellIndex);D.sort();J=1;for(N=D.length;J<N;J++)if(D[J]-D[J-1]>1){M=D[J-1]+1;break}M||(M=D[0]>0?D[0]-1:D[D.length-1]+1);A=I[0].rows;J=0;for(N=A.length;J<N;J++)if(Q=A[J].cells[M])break;return Q?new v(Q):
I._4e_previous()}function y(A){if(A instanceof w.Selection){var D=i(A),I=q(D);for(A=D.length-1;A>=0;A--)D[A]&&y(D[A]);return I}else if(A instanceof v){D=A._4e_ascendant("table");if(!D)return null;I=A[0].cellIndex;for(A=D[0].rows.length-1;A>=0;A--){var J=new v(D[0].rows[A]);if(!I&&J[0].cells.length==1)b(J);else J[0].cells[I]&&J[0].removeChild(J[0].cells[I])}}return null}function z(A,D){var I=new w.Range(A[0].ownerDocument);if(!I.moveToElementEditablePosition(A,D?true:r)){I.selectNodeContents(A);I.collapse(D?
false:true)}I.select(true)}t.augment(d,{_init:function(){var A=this.editor,D={};this.el=new c({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:A.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in H)(function(J){D[J]=function(){A.fire("save");H[J](A);A.fire("save")}})(I);m.register(A.document,{rules:l,width:"120px",funcs:D});w.Utils.lazyRun(this,"_prepareTableShow","_realTableShow");w.Utils.sourceDisable(A,this)},disable:function(){this.el.set("state",c.DISABLED)},
enable:function(){this.el.set("state",c.OFF)},_tableInit:function(){var A=this,D=new k({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});D.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input  data-verify='^(?!0)\\d+(.\\d+)?$'  data-warning='\u884c\u6570\u8bf7\u8f93\u5165\u6b63\u6570'  value='2'  class='ke-table-rows ke-table-create-only'  size='6' /></label></td><td><label>\u5bbd\u5ea6\uff1a <input  data-verify='^(?!0)\\d+(.\\d+)?$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' value='200' class='ke-table-width' size='6'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input  data-verify='^(?!0)\\d+(.\\d+)?$'  data-warning='\u5217\u6570\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-table-cols ke-table-create-only' value='3' size='6'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input  data-verify='^((?!0)\\d+(.\\d+)?)?$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' value='' class='ke-table-height' size='6'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td></tr><tr><td><label>\u8fb9\u6846\uff1a <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u8fb9\u6846\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' value='1' class='ke-table-border' size='6'/></label> &nbsp;\u50cf\u7d20</select></td><td></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
D.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");var I=D.body;D.twidth=I.one(".ke-table-width");D.theight=I.one(".ke-table-height");D.tborder=I.one(".ke-table-border");D.tcaption=I.one(".ke-table-caption");D.talign=I.one(".ke-table-align");D.trows=I.one(".ke-table-rows");D.tcols=I.one(".ke-table-cols");D.thead=I.one(".ke-table-head");var J=D.foot.one(".ke-table-ok"),N=D.foot.one(".ke-table-cancel");D.twidthunit=I.one(".ke-table-width-unit");
A.tableDialog=D;J.on("click",A._tableOk,A);D.on("hide",function(){A.selectedTable=null});N.on("click",function(){D.hide()})},_tableOk:function(){var A=this.tableDialog,D=A.el.all("input");if(w.Utils.verifyInputs(D)){if(A.twidthunit.val()=="%")if(parseInt(A.twidth.val())>100){alert("\u5bbd\u5ea6\uff1a\u8bf7\u8f93\u51650-100\u4e4b\u95f4");return}this.selectedTable?this._modifyTable():this._genTable()}},_modifyTable:function(){var A=this.tableDialog,D=this.selectedTable,I=D.one("caption");e(A.talign.val())?
D.attr("align",h(A.talign.val())):D.removeAttr("align");e(A.tborder.val())?D.attr("border",h(A.tborder.val())):D.removeAttr("border");!e(A.tborder.val())||A.tborder.val()=="0"?D.addClass("ke_show_border"):D.removeClass("ke_show_border");e(A.twidth.val())?D.css("width",h(A.twidth.val())+A.twidthunit.val()):D.css("width","");e(A.theight.val())?D.css("height",h(A.theight.val())):D.css("height","");if(e(A.tcaption.val()))I&&I[0]?I.html(h(A.tcaption.val())):(new v("<caption><span>"+h(A.tcaption.val())+
"</span></caption>")).insertBefore(D[0].firstChild);else I&&I._4e_remove();A.hide()},_genTable:function(){var A=this.tableDialog,D="<table ",I,J=parseInt(A.tcols.val())||1,N=parseInt(A.trows.val())||1,M=s.ie?"":"<br/>",Q=this.editor;if(e(A.talign.val()))D+="align='"+t.trim(A.talign.val())+"' ";if(e(A.tborder.val()))D+="border='"+t.trim(A.tborder.val())+"' ";if(e(A.twidth.val())||e(A.theight.val())){D+="style='";if(e(A.twidth.val()))D+="width:"+t.trim(A.twidth.val())+A.twidthunit.val()+";";if(e(A.theight.val()))D+=
"height:"+t.trim(A.theight.val())+"px;";D+="' "}if(!e(A.tborder.val())||t.trim(A.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(e(A.tcaption.val()))D+="<caption><span>"+t.trim(A.tcaption.val())+"</span></caption>";if(A.thead.val()){D+="<thead>";D+="<tr>";for(I=0;I<J;I++)D+="<th>"+M+"</th>";D+="</tr>";D+="</thead>";N-=1}D+="<tbody>";for(var R=0;R<N;R++){D+="<tr>";for(I=0;I<J;I++)D+="<td>"+M+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new v(D,null,Q.document);Q.insertElement(D);A.hide()},
_fillTableDialog:function(){var A=this.tableDialog,D=this.selectedTable,I=D.one("caption");A.talign.val(D.attr("align")||"");A.tborder.val(D.attr("border")||"");var J=D._4e_style("width")||"";A.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?A.twidthunit.val("%"):A.twidthunit.val("px");A.theight.val((D._4e_style("height")||"").replace(/px|%/i,""));J="";if(I)J=I.text();A.tcaption.val(J);A.trows.val(D.one("tbody").children().length);A.tcols.val(D.one("tr").children().length);A.thead.val(D._4e_first(function(N){return N._4e_name()==
"thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var C=/^(?:td|th)$/,H={"\u8868\u683c\u5c5e\u6027":function(A){var D=A.getSelection();if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",
true)){A=A._toolbars.table;A.selectedTable=D;A._tableShow()}},"\u5220\u9664\u8868\u683c":function(A){var D=(A=A.getSelection())&&A.getStartElement();if(D=D&&D._4e_ascendant("table",true)){A.selectElement(D);var I=A.getRanges()[0];I.collapse();A.selectRanges([I]);A=D.parent();A[0].childNodes.length==1&&A._4e_name()!="body"&&A._4e_name()!="td"?A._4e_remove():D._4e_remove()}},"\u5220\u9664\u884c ":function(A){A=A.getSelection();z(b(A),r)},"\u5220\u9664\u5217 ":function(A){A=A.getSelection();(A=y(A))&&
z(A,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(A){A=A.getSelection();j(A,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(A){A=A.getSelection();j(A,r)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(A){A=A.getSelection();g(A,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(A){A=A.getSelection();g(A,r)}};w.TableUI=d}();u.addPlugin(function(){var d=u.document;new w.TableUI(u);var e=B.create("<style>",null,d);d.getElementsByTagName("head")[0].appendChild(e);if(e.styleSheet)e.styleSheet.cssText=
o;else e.appendChild(d.createTextNode(o))})});
KISSY.Editor.add("templates",function(u){var r=KISSY.Editor,w=KISSY,t=w.Node,v=r.TripleButton,B=r.SimpleOverlay;r.TplUI||function(){function n(s){this.editor=s;this._init()}w.augment(n,{_init:function(){var s=this.editor,f=new v({container:s.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"});f.on("offClick",this._show,this);r.Utils.lazyRun(this,"_prepare","_real");this.el=f;r.Utils.sourceDisable(s,this)},disable:function(){this.el.set("state",v.DISABLED)},enable:function(){this.el.set("state",
v.OFF)},_prepare:function(){for(var s=this.editor,f=s.cfg.pluginConfig.templates||[],c="<div class='ke-tpl'>",k=0;k<f.length;k++)c+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+f[k].demo+"</a>";c+="</div>";this._initDialogOk=true;var m=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});m.body.html(c);m.body.all(".ke-tpl-list").on("click",function(l){l.halt();l=(new t(l.target))._4e_index();l!=-1&&s.insertHtml(f[l].html);m.hide()});this.ui=m},_real:function(){this.ui.show()},
_show:function(){this._prepare()}});r.TplUI=n}();u.addPlugin(function(){new r.TplUI(u)})});
KISSY.Editor.add("undo",function(u){var r=KISSY,w=r.Editor,t=w.Utils.arrayCompare,v=r.UA,B=r.Event;w.UndoManager||function(){function n(h){var o=h._getRawData();h=o&&h.getSelection();this.contents=o;this.bookmarks=h&&h.createBookmarks2(true)}function s(h){this.history=[];this.index=-1;this.editor=h;this.bufferRunner=w.Utils.buffer(this.save,this,500);this._init()}function f(h,o,x,a){this.editor=h;this.title=x;this.text=o;this.contentCls=a;this._init()}r.augment(n,{equals:function(h){if(this.contents!=
h.contents)return false;var o=this.bookmarks;h=h.bookmarks;if(o||h){if(!o||!h||o.length!=h.length)return false;for(var x=0;x<o.length;x++){var a=o[x],d=h[x];if(a.startOffset!=d.startOffset||a.endOffset!=d.endOffset||!t(a.start,d.start)||!t(a.end,d.end))return false}}return true}});var c={16:1,17:1,18:1},k={37:1,38:1,39:1,40:1,33:1,34:1};r.augment(s,{_keyMonitor:function(){var h=this.editor;B.on(h.document,"keydown",function(o){var x=o.keyCode;if(!(x in k||x in c))if(x===90&&(o.ctrlKey||o.metaKey)){h.fire("restore",
{d:-1});o.halt()}else if(x===89&&(o.ctrlKey||o.metaKey)){h.fire("restore",{d:1});o.halt()}else h.fire("save",{buffer:1})})},_init:function(){var h=this,o=h.editor;o.on("save",function(x){x.buffer?h.bufferRunner():h.save()});o.on("restore",h.restore,h);h._keyMonitor()},save:function(){var h=this.history,o=this.index;h.length>o+1&&h.splice(o+1,h.length-o-1);var x=this.editor;o=h[h.length-1];var a=new n(x);if(!o||!o.equals(a)){h.length===30&&h.shift();h.push(a);this.index=o=h.length-1;x.fire("afterSave",
{history:h,index:o})}},restore:function(h){h=h.d;var o=this.history,x=this.editor,a=o[this.index+h];if(a){x._setRawData(a.contents);if(a.bookmarks)x.getSelection().selectBookmarks(a.bookmarks);else if(v.ie){a=x.document.body.createTextRange();a.collapse(true);a.select()}this.index+=h;x.fire("afterRestore",{history:o,index:this.index});x.notifySelectionChange()}}});var m=w.TripleButton,l={redo:1,undo:-1};r.augment(f,{_init:function(){var h=this,o=h.editor;h.el=new m({contentCls:h.contentCls,title:h.title,
container:o.toolBarDiv});var x=h.el;x.set("state",m.DISABLED);o.on("afterSave afterRestore",h._respond,h);x.on("offClick",function(){o.fire("restore",{d:l[h.text]})});w.Utils.sourceDisable(o,h)},disable:function(){this._saveState=this.el.get("state");this.el.set("state",m.DISABLED)},enable:function(){this.el.set("state",this._saveState)},_respond:function(h){this.updateUI(h.history,h.index)},updateUI:function(h,o){var x=this.el,a=this.text;if(a=="undo")o>0?x.set("state",m.OFF):x.set("state",m.DISABLED);
else if(a=="redo")o<h.length-1?x.set("state",m.OFF):x.set("state",m.DISABLED)}});w.UndoManager=s;w.RestoreUI=f}();u.addPlugin(function(){new w.UndoManager(u);new w.RestoreUI(u,"undo","\u64a4\u9500","ke-toolbar-undo");new w.RestoreUI(u,"redo","\u91cd\u505a","ke-toolbar-redo")})});
