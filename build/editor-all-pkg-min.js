KISSY.add("editor",function(w,u){function A(v,b){var c=this;if(!(c instanceof A))return new A(v,b);if(w.isString(v))v=w.one(v);v[0]||(v=new Node(v));c.cfg=b||{pluginConfig:{}};w.app(c,w.EventTarget);c.use=function(e){w.use.call(c,e,function(){c.on("dataReady",function(){c.setData(v.val())})},{order:true,global:A})};c.init(v);return u}function t(v){if(!x)return"build/"+v.replace(/\.(js|css)/i,"-min.$1");if(x==="dev")return v;return"build/"+v}w.app(A,w.EventTarget);A.Config.base=w.Config.base+"editor/";
var x=w.Config.debug,B={htmlparser:{attach:false,path:t("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},o=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],s=["clipboard",{name:"color"},{name:"elementpaths"},"enterkey","fakeobjects",{name:"flash",requires:["contextmenu","fakeobjects","overlay"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay"]},
"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize","music","preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo"],k=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",
requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],g=[{name:"button"},{name:"overlay"},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}],i,j,p,q,m;i=0;for(j=g.length;i<j;i++){q=p=g[i];m=u;if(!w.isString(p)){m=p.requires;q=p.name}B[q]={attach:false,requires:m,path:t("ui/"+q+".js"),csspath:p.useCss?t("ui/"+q+".css"):""}}i=0;for(j=
s.length;i<j;i++){q=p=s[i];m=["button"];if(!w.isString(p)){p.requires&&(m=m.concat(p.requires));q=p.name}B[q]={attach:false,requires:m,csspath:p.useCss?t("plugins/"+q+"/plugin.css"):u,path:t("plugins/"+q+"/plugin.js")}}i=0;for(j=k.length;i<j;i++){p=k[i];m=u;if(!w.isString(p)){m=p.requires;p=p.name}B[p]={attach:false,requires:m,path:t("plugins/htmldataprocessor/htmlparser/"+p.substring(11)+".js")}}A.add(B);B={};i=0;for(j=o.length;i<j;i++){p=o[i];B[p]={host:"editor",requires:i>0?o[i-1]:[]}}A.add(B);
w.Editor=A});
KISSY.Editor.add("utils",function(w){var u=KISSY,A=u.Node,t=u.DOM,x=u.Config.debug,B=u.UA;w.Utils={getFlashUrl:function(o){var s="",k=w.NODE;if(o._4e_name()=="object"){o=o[0].childNodes;for(var g=0;g<o.length;g++)if(o[g].nodeType==k.NODE_ELEMENT)if((t.attr(o[g],"name")||"").toLowerCase()=="movie")s=t.attr(o[g],"value");else if(t._4e_name(o[g])=="embed")s=t.attr(o[g],"src");else t._4e_name(o[g])=="object"&&t.attr(o[g],"data")}else if(o._4e_name()=="embed")s=o.attr("src");return s},debugUrl:function(o){if(!x)return"build/"+o.replace(/\.(js|css)/i,
"-min.$1");if(x==="dev")return o;return"build/"+o},lazyRun:function(o,s,k){var g=o[s],i=o[k];o[s]=function(){g.apply(this,arguments);o[s]=o[k];return i.apply(this,arguments)}},getXY:function(o,s,k,g){k=k.defaultView||k.parentWindow;o-=t.scrollLeft(k);s-=t.scrollTop(k);if(g)if(k!=(g.defaultView||g.parentWindow)&&k.frameElement){g=t._4e_getOffset(k.frameElement,g);o+=g.left;s+=g.top}return{left:o,top:s}},tryThese:function(){for(var o,s=0,k=arguments.length;s<k;s++){var g=arguments[s];try{o=g();break}catch(i){}}return o},
arrayCompare:function(o,s){if(!o&&!s)return true;if(!o||!s||o.length!=s.length)return false;for(var k=0;k<o.length;k++)if(o[k]!==s[k])return false;return true},getByAddress:function(o,s,k){o=o.documentElement;for(var g=0;o&&g<s.length;g++){var i=s[g];if(k)for(var j=-1,p=0;p<o.childNodes.length;p++){var q=o.childNodes[p];if(!(k===true&&q.nodeType==3&&q.previousSibling&&q.previousSibling.nodeType==3)){j++;if(j==i){o=q;break}}}else o=o.childNodes[i]}return o?new A(o):null},clearAllMarkers:function(o){for(var s in o)o[s]._4e_clearMarkers(o,
true)},htmlEncodeAttr:function(o){return o.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(o){return o.replace(/^\s+/,"")},rtrim:function(o){return o.replace(/\s+$/,"")},trim:function(o){return this.ltrim(this.rtrim(o))},mix:function(){for(var o={},s=0;s<arguments.length;s++)o=u.mix(o,arguments[s]);return o},isCustomDomain:function(){if(!B.ie)return false;var o=document.domain,s=window.location.hostname;return o!=s&&o!="["+s+"]"}}});
KISSY.Editor.add("focusmanager",function(w){function u(){this.iframeFocus=true;s=this}function A(){this.iframeFocus=false;s=null}var t=KISSY,x=t.DOM,B=t.Event;t={};var o={},s;t={refreshAll:function(){for(var k in o){var g=o[k];g.document.designMode="off";g.document.designMode="on"}},currentInstance:function(){return s},getInstance:function(k){return o[k]},add:function(k){var g=x._4e_getWin(k.document);B.on(g,"focus",u,k);B.on(g,"blur",A,k)},register:function(k){o[k._UUID]=k},remove:function(k){delete o[k._UUID];
var g=x._4e_getWin(k.document);B.remove(g,"focus",u,k);B.remove(g,"blur",A,k)}};w.focusManager=t});
KISSY.Editor.add("definition",function(w){function u(m){return g+"<html><head><title>kissy-editor</title><link href='"+w.Config.base+i+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(m?'<script id="ke_actscrpt" type="text/javascript">'+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+m+'");<\/script>':"")}var A=KISSY,t=A.UA,x=A.DOM,B=A.Node,o=A.Event,s=w.focusManager,k=w.Utils.tryThese,g="<!doctype html>",i=
w.Utils.debugUrl("assets/editor-iframe.css"),j=1,p="document.open();"+(w.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",q="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(t.ie?"javascript:void(function(){"+encodeURIComponent(p)+"}())":"")+'"  tabIndex="'+
(t.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";A.augment(w,{init:function(m){var v=this,b=new B(q.replace(/\$\(tabIndex\)/,m.attr("tabIndex")));b.on("mousedown",function(h){if(t.webkit){var d=x._4e_name(h.target);if(d=="select"||d=="option")return true}h.halt()});v.editorWrap=b;v._UUID=j++;s.register(v);v.wrap=b.one(".ke-textarea-wrap");v.iframe=v.wrap.one("iframe");v.toolBarDiv=b.one(".ke-editor-tools");v.textarea=
m;v.statusDiv=b.one(".ke-editor-status");v.toolBarDiv._4e_unselectable();v._commands={};v._plugins={};var c=m._4e_style("width"),e=m._4e_style("height");if(c){b.css("width",c);m.css("width","100%")}v.textarea.css("display","none");b.insertAfter(m);v.wrap[0].appendChild(m[0]);if(e){v.wrap.css("height",e);m.css("height","100%")}m=v.iframe;v.on("dataReady",function(){v.ready=true;w.fire("instanceCreated",{editor:v})});t.gecko?m.on("load",v._setUpIFrame,v):v._setUpIFrame()},addCommand:function(m,v){this._commands[m]=
v},execCommand:function(m){this.fire("save");this._commands[m].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(m){if(this.htmlDataProcessor)m=this.htmlDataProcessor.toDataFormat(m,"p");this.document.body.innerHTML=m},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(m){this.document.body.innerHTML=
m},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");t.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:u,getSelection:function(){var m=new w.Selection(this.document);return!m||m.isInvalid?null:m},focus:function(){var m=x._4e_getWin(this.document);t.webkit&&m&&m.parent&&m.parent.focus();m&&m.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){x._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function m(){h=e.document;v.document=h;b.detach();h.open("text/html","replace");h.write(c);h.close()}
var v=this,b=v.iframe,c=u(v._UUID),e=b[0].contentWindow,h;try{h=e.document}catch(d){b[0].src=b[0].src;if(t.ie&&t.ie<7){setTimeout(m,10);return}}m()},addPlugin:function(m){this.ready?m():this.on("dataReady",m)},_monitor:function(){var m=this;m._monitorId&&clearTimeout(m._monitorId);m._monitorId=setTimeout(function(){var v=m.getSelection();if(v&&!v.isInvalid){v=v.getStartElement();var b=new w.ElementPath(v);if(!m.previousPath||!m.previousPath.compare(b)){m.previousPath=b;m.fire("selectionChange",{selection:m,
path:b,element:v})}}},200)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(m,v){var b=this;b.focus();var c=m._4e_name(),e=w.XHTML_DTD,h=w.RANGE,d=w.NODE,l=e.$block[c],a=b.getSelection(),f=a.getRanges(),n,z,r,D,H;b.fire("save");for(var y=f.length-1;y>=0;y--){n=f[y];n.deleteContents();z=!y&&m||m._4e_clone(true);v&&v(z);if(l)for(;(D=n.getCommonAncestor(false,true))&&(H=e[D._4e_name()])&&!(H&&H[c]);)if(D._4e_name()in e.span)n.splitElement(D);else if(n.checkStartOfBlock()&&
n.checkEndOfBlock()){n.setStartBefore(D);n.collapse(true);D._4e_remove()}else n.splitBlock();n.insertNode(z);r||(r=z)}m=r._4e_nextSourceNode(true);H=w.XHTML_DTD;if(!H.$inline[z._4e_name()])if(m){if(m._4e_name()=="br"&&H[m.parent()._4e_name()].p){H=new B("<p>&nbsp;</p>",null,b.document);m[0].parentNode.replaceChild(H[0],m[0]);m=H}}else{H=new B("<p>&nbsp;</p>",null,b.document);H.insertAfter(r);m=H}n.moveToPosition(r,h.POSITION_AFTER_END);m&&m[0].nodeType==d.NODE_ELEMENT&&n.moveToElementEditablePosition(m);
a.selectRanges([n]);b.focus();z&&z._4e_scrollIntoView();setTimeout(function(){b.fire("save")},10)},insertHtml:function(m){var v=this;if(v.htmlDataProcessor)m=v.htmlDataProcessor.toDataFormat(m);if(t.webkit){m=x.create(m,null,this.document);m=m.nodeType==11?A.makeArray(m.childNodes):[m];for(var b=0;b<m.length;b++)v.insertElement(new B(m[b]))}else{v.focus();v.fire("save");b=v.getSelection();if(t.ie){b=b.getNative();b.type=="Control"&&b.clear();b.createRange().pasteHTML(m)}else v.document.execCommand("inserthtml",
false,m);v.focus();setTimeout(function(){v.fire("save")},10)}}});w._initIFrame=function(m){function v(r){k(function(){e.designMode="on";setTimeout(function(){e.designMode="off";d.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){e.designMode="off";x.attr(d,"contentEditable",false);x.attr(d,"contentEditable",true);!r&&v(1)})}var b=s.getInstance(m);m=b.textarea[0];var c=b.iframe[0].contentWindow,e=b.document,h=e.getElementById("ke_actscrpt");h.parentNode.removeChild(h);
var d=e.body;if(t.ie){d.hideFocus=true;d.disabled=true;d.contentEditable=true;d.removeAttribute("disabled")}else setTimeout(function(){if(t.gecko||t.opera)d.contentEditable=true;else if(t.webkit)d.parentNode.contentEditable=true;else e.designMode="on"},0);try{e.execCommand("enableObjectResizing",false,true)}catch(l){}try{e.execCommand("enableInlineTableEditing",false,true)}catch(a){}t.webkit&&o.on(e,"mousedown",function(r){r=new B(r.target);A.inArray(r._4e_name(),["img","hr","input","textarea","select"])&&
b.getSelection().selectElement(r)});if(t.webkit){o.on(e,"click",function(r){var D=new B(r.target);A.inArray(D._4e_name(),["input","select"])&&r.preventDefault()});o.on(e,"mouseup",function(r){var D=new B(r.target);A.inArray(D._4e_name(),["input","textarea"])&&r.preventDefault()})}if(t.gecko||t.ie||t.opera){var f;f=new B(x.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],m));f.on("focus",function(){b.focus()});b.on("destroy",function(){})}if(t.ie&&e.compatMode=="CSS1Compat"||
t.gecko||t.opera){var n=new B(e.documentElement);n.on("mousedown",function(r){if(r.target===n[0]){t.gecko&&v(false);f[0].focus()}})}o.on(c,"focus",function(){if(t.gecko)v(false);else t.opera&&d.focus();b.notifySelectionChange()});t.gecko&&o.on(b.document,"mousedown",function(){b.iframeFocus||v(false)});if(t.ie){o.on(e,"keydown",function(r){if(r.keyCode in{8:1,46:1}){var D=b.getSelection(),H=D.getSelectedElement();if(H){b.fire("save");var y=D.getRanges()[0].createBookmark();H._4e_remove();D.selectBookmarks([y]);
b.fire("save");r.preventDefault()}}});if(e.compatMode=="CSS1Compat"){var z={33:1,34:1};o.on(e,"keydown",function(r){r.keyCode in z&&setTimeout(function(){b.getSelection().scrollIntoView()},0)})}}setTimeout(function(){t.ie&&setTimeout(function(){if(e){d.runtimeStyle.marginBottom="0px";d.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.fire("dataReady")},10);s.add(b)};t.gecko&&function(){var m=document.body;if(m){var v=m.getAttribute("onpageshow");m.setAttribute("onpageshow",(v?v+";":
"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(w){w.XHTML_DTD=function(){var u=function(l){for(var a=arguments.length-1;a>0;)KISSY.mix(l,arguments[a--]);return l},A={isindex:1,fieldset:1},t={input:1,button:1,select:1,textarea:1,label:1},x=u({a:1},t),B=u({iframe:1},x),o={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},s={ins:1,del:1,script:1,style:1},k=u({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},s),g=u({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},k),i=u({p:1},g);t=u({iframe:1},g,t);g={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var j=u({a:1},t),p={tr:1},q={"#":1},m=u({param:1},g),v=u({form:1},A,B,o,i),b={li:1},c={base:1,link:1,meta:1,title:1},e=u(c,{style:1,script:1}),h={head:1,body:1},d={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:u({html:1},h,c),$block:d,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:j,$body:u({script:1,style:1},d),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:h,head:e,style:q,body:v,base:{},link:{},meta:{},title:q,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:v,td:v,br:{},th:v,center:v,kbd:j,button:u(i,o),basefont:{},h5:j,h4:j,samp:j,h6:j,ol:b,h1:j,h3:j,option:q,h2:j,form:u(A,B,o,i),select:{optgroup:1,option:1},font:j,ins:j,menu:b,abbr:j,label:j,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:j,script:q,tfoot:p,cite:j,li:v,input:{},iframe:v,strong:j,textarea:q,noframes:v,big:j,small:j,span:j,hr:{},dt:j,sub:j,optgroup:{option:1},param:{},bdo:j,"var":j,div:v,object:m,sup:j,dd:v,strike:j,area:{},dir:b,map:u({area:1,form:1,p:1},A,s,o),applet:m,dl:{dt:1,dd:1},del:j,isindex:{},fieldset:u({legend:1},g),thead:p,ul:b,acronym:j,b:j,a:t,blockquote:v,caption:j,i:j,u:j,tbody:p,s:j,address:u(B,i),tt:j,legend:j,q:j,pre:u(k,x),p:j,em:j,dfn:j}}()});
KISSY.Editor.add("dom",function(w){function u(b){return b.replace(/-(\w)/g,function(c,e){return e.toUpperCase()})}var A=KISSY,t=A.DOM,x=A.UA,B=A.Node,o=w.Utils,s={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};w.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};w.POSITION={};var k=w.NODE,g=w.POSITION;g.POSITION_IDENTICAL=0;g.POSITION_DISCONNECTED=
1;g.POSITION_FOLLOWING=2;g.POSITION_PRECEDING=4;g.POSITION_IS_CONTAINED=8;g.POSITION_CONTAINS=16;var i={},j={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},p={hr:1},q=function(b){return b[0]||b},m=function(b){if(!b[0])return new B(b);return b},v={_4e_equals:function(b,c){if(!b&&!c)return true;if(!b||!c)return false;b=q(b);c=q(c);return b===c},_4e_isBlockBoundary:function(b,
c){b=m(b);c=A.mix(A.mix({},p),c||{});return j[b.css("display")]||c[b._4e_name()]},_4e_getWin:function(b){return b&&"scrollTo"in b&&b.document?b:b&&b.nodeType===9?b.defaultView||b.parentWindow:false},_4e_index:function(b){b=q(b);for(var c=b.parentNode.childNodes,e=0;e<c.length;e++)if(c[e]===b)return e;return-1},_4e_first:function(b,c){b=q(b);if((b=(b=b.firstChild)&&new B(b))&&c&&!c(b))b=b._4e_next(c);return b},_4e_move:function(b,c,e){b._4e_remove();b=q(b);c=q(c);e?c.insertBefore(b,c.firstChild):c.appendChild(b)},
_4e_name:function(b){b=q(b);var c=b.nodeName.toLowerCase();if(x.ie)if((b=b.scopeName)&&b!="HTML")c=b.toLowerCase()+":"+c;return c},_4e_isIdentical:function(b,c){if(b._4e_name()!=c._4e_name())return false;var e=b[0].attributes,h=c[0].attributes,d=e.length,l=h.length;if(!x.ie&&d!=l)return false;for(var a=0;a<d;a++){var f=e[a];if((!x.ie||f.specified&&f.nodeName!="_ke_expando")&&f.nodeValue!=c.attr(f.nodeName))return false}if(x.ie)for(a=0;a<l;a++){f=h[a];if(f.specified&&f.nodeName!="_ke_expando"&&f.nodeValue!=
b.attr(f.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(b){b=q(b).childNodes;for(var c=0,e=b.length;c<e;c++){var h=b[c],d=h.nodeType;if(!(d==k.NODE_ELEMENT&&h.getAttribute("_ke_bookmark")))if(d==k.NODE_ELEMENT&&!v._4e_isEmptyInlineRemoveable(h)||d==k.NODE_TEXT&&A.trim(h.nodeValue))return false}return true},_4e_moveChildren:function(b,c,e){b=q(b);c=c[0]||c;if(b!=c)if(e)for(;e=b.lastChild;)c.insertBefore(b.removeChild(e),c.firstChild);else for(;e=b.firstChild;)c.appendChild(b.removeChild(e))},
_4e_mergeSiblings:function(){function b(c,e,h){if(e[0]&&e[0].nodeType==k.NODE_ELEMENT){for(var d=[];e.attr("_ke_bookmark")||e._4e_isEmptyInlineRemoveable();){d.push(e);e=h?new B(e[0].nextSibling):new B(e[0].previousSibling);if(!e[0]||e[0].nodeType!=k.NODE_ELEMENT)return}if(c._4e_isIdentical(e)){for(var l=h?c[0].lastChild:c[0].firstChild;d.length;)d.shift()._4e_move(c,!h);e._4e_moveChildren(c,!h);e._4e_remove();l[0]&&l[0].nodeType==k.NODE_ELEMENT&&l._4e_mergeSiblings()}}}return function(c){if(c[0])if(s[c._4e_name()]||
c._4e_name()=="a"){b(c,new B(c[0].nextSibling),true);b(c,new B(c[0].previousSibling))}}}(),_4e_unselectable:x.gecko?function(b){b=q(b);b.style.MozUserSelect="none"}:x.webkit?function(b){b=q(b);b.style.KhtmlUserSelect="none"}:function(b){b=q(b);if(x.ie||x.opera){var c,e=0;for(b.unselectable="on";c=b.all[e++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(b,c){b=q(b);var e,h=0;e=0;var d=b.ownerDocument.defaultView||
b.ownerDocument.parentWindow,l=b.ownerDocument,a=l.documentElement;c=c||l;if(b.getBoundingClientRect){if(b!==l.body&&a!==b){e=b.getBoundingClientRect();h=e.left+(c===l?t.scrollLeft(d):0);e=e.top+(c===l?t.scrollTop(d):0)}if(c)if(d!=(c.defaultView||c.parentWindow)&&d.frameElement){c=v._4e_getOffset(d.frameElement,c);h+=c.left;e+=c.top}}return{left:h,top:e}},_4e_getFrameDocument:function(b){return(b=q(b))&&b.contentWindow.document},_4e_splitText:function(b,c){b=q(b);var e=b.ownerDocument;if(!(!b||b.nodeType!=
k.NODE_TEXT)){if(x.ie&&c==b.nodeValue.length){e=e.createTextNode("");t.insertAfter(e,b);return e}b=new B(b.splitText(c));if(x.ie==8){e=e.createTextNode("");t.insertAfter(e,b[0]);e.parentNode.removeChild(e)}return b}},_4e_parents:function(b,c){b=m(b);var e=[];do e[c?"push":"unshift"](b);while(b=b.parent());return e},_4e_clone:function(b,c,e){b=q(b);b=b.cloneNode(c);if(!e){var h=function(d){if(d.nodeType==k.NODE_ELEMENT){d.removeAttribute("id",false);d.removeAttribute("_ke_expando",false);d=d.childNodes;
for(var l=0;l<d.length;l++)h(d[l])}};h(b)}return new B(b)},_4e_nextSourceNode:function(b,c,e,h){b=q(b);if(h&&!h.call){var d=h[0]||h;h=function(a){a=a[0]||a;return a!==d}}c=!c&&b.firstChild;var l=new B(b);if(!c){if(b.nodeType==k.NODE_ELEMENT&&h&&h(this,true)===false)return null;c=b.nextSibling}for(;!c&&(l=l.parent());){if(h&&h(l,true)===false)return null;c=l[0].nextSibling}if(!c)return null;c=new B(c);if(h&&h(c)===false)return null;if(e&&e!=c[0].nodeType)return c._4e_nextSourceNode(false,e,h);return c},
_4e_previousSourceNode:function(b,c,e,h){b=q(b);if(h&&!h.call){var d=h[0]||h;h=function(a){a=a[0]||a;return a!==d}}c=!c&&b.lastChild;var l=new B(b);if(!c){if(b.nodeType==k.NODE_ELEMENT&&h&&h(b,true)===false)return null;c=b.previousSibling}for(;!c&&(l=l.parent());){if(h&&h(l,true)===false)return null;c=l[0].previousSibling}if(!c)return null;c=new B(c);if(h&&h(c)===false)return null;if(e&&c[0].nodeType!=e)return c._4e_previousSourceNode(false,e,h);return c},_4e_contains:x.ie||x.webkit?function(b,c){b=
q(b);c=q(c);return c.nodeType!=k.NODE_ELEMENT?b.contains(c.parentNode):b!=c&&b.contains(c)}:function(b,c){b=q(b);c=q(c);return!!(b.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(b,c){if(b._4e_equals(c))return b;if(c[0].nodeType!=k.NODE_TEXT&&c._4e_contains(b))return c;b=b[0].nodeType==k.NODE_TEXT?b.parent():b;do if(b[0].nodeType!=k.NODE_TEXT&&b._4e_contains(c))return b;while(b=b.parent());return null},_4e_ascendant:function(b,c,e){b=q(b);if(!e)b=b.parentNode;if(c&&!A.isFunction(c)){var h=
c;c=function(d){return d._4e_name()==h}}for(;b&&b.nodeType!=9;){if(!c||c(new B(b))===true)return new B(b);b=b.parentNode}return null},_4e_hasAttribute:function(b,c){b=q(b);b=b.attributes.getNamedItem(c);return!!(b&&b.specified)},_4e_hasAttributes:x.ie?function(b){b=q(b);for(var c=b.attributes,e=0;e<c.length;e++){var h=c[e];switch(h.nodeName){case "class":if(b.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(h.specified)return true}}return false}:function(b){b=q(b);x.gecko&&
b.removeAttribute("_moz_dirty");b=b.attributes;return b.length>1||b.length==1&&b[0].nodeName!="_ke_expando"},_4e_position:function(b,c){var e=q(b),h=q(c);if(e.compareDocumentPosition)return e.compareDocumentPosition(h);if(e==h)return g.POSITION_IDENTICAL;if(e.nodeType==k.NODE_ELEMENT&&h.nodeType==k.NODE_ELEMENT){if(e.contains){if(e.contains(h))return g.POSITION_CONTAINS+g.POSITION_PRECEDING;if(h.contains(e))return g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING}if("sourceIndex"in e)return e.sourceIndex<
0||h.sourceIndex<0?g.POSITION_DISCONNECTED:e.sourceIndex<h.sourceIndex?g.POSITION_PRECEDING:g.POSITION_FOLLOWING}b=b._4e_address();c=c._4e_address();e=Math.min(b.length,c.length);for(h=0;h<=e-1;h++)if(b[h]!=c[h]){if(h<e)return b[h]<c[h]?g.POSITION_PRECEDING:g.POSITION_FOLLOWING;break}return b.length<c.length?g.POSITION_CONTAINS+g.POSITION_PRECEDING:g.POSITION_IS_CONTAINED+g.POSITION_FOLLOWING},_4e_address:function(b,c){b=q(b);var e=[],h=b.ownerDocument.documentElement;for(b=b;b&&b!=h;){var d=b.parentNode,
l=-1;if(d){for(var a=0;a<d.childNodes.length;a++){var f=d.childNodes[a];if(!(c&&f.nodeType==3&&f.previousSibling&&f.previousSibling.nodeType==3)){l++;if(f==b)break}}e.unshift(l)}b=d}return e},_4e_breakParent:function(b,c){var e=new w.Range(b[0].ownerDocument);e.setStartAfter(b);e.setEndAfter(c);c=e.extractContents();e.insertNode(b._4e_remove());b[0].parentNode.insertBefore(c,b[0].nextSibling)},_4e_style:function(b,c,e){if(e!==undefined)return b.css(c,e);b=b[0]||b;return b.style[u(c)]},_4e_remove:function(b,
c){var e=q(b),h=e.parentNode;if(h){if(c)for(;c=e.firstChild;)h.insertBefore(e.removeChild(c),e);h.removeChild(e)}return b},_4e_trim:function(b){t._4e_ltrim(b);t._4e_rtrim(b)},_4e_ltrim:function(b){b=q(b);for(var c;c=b.firstChild;){if(c.nodeType==k.NODE_TEXT){var e=o.ltrim(c.nodeValue),h=c.nodeValue.length;if(e){if(e.length<h){(new B(c))._4e_splitText(h-e.length);b.removeChild(b.firstChild)}}else{b.removeChild(c);continue}}break}},_4e_rtrim:function(b){b=q(b);for(var c;c=b.lastChild;){if(c.type==k.NODE_TEXT){var e=
o.rtrim(c.nodeValue),h=c.nodeValue.length;if(e){if(e.length<h){(new B(c))._4e_splitText(e.length);b.removeChild(b.lastChild)}}else{b.removeChild(c);continue}}break}if(!x.ie&&!x.opera)(c=b.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(b){b=q(b);for(var c=b.lastChild;c&&c.nodeType==k.NODE_TEXT&&!A.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==k.NODE_TEXT||t._4e_name(c)!=="br"){c=x.opera?b.ownerDocument.createTextNode(""):
b.ownerDocument.createElement("br");x.gecko&&c.setAttribute("type","_moz");b.appendChild(c)}},_4e_previous:function(b,c){b=q(b);var e;do e=(b=b.previousSibling)&&new B(b);while(e&&c&&!c(e));return e},_4e_last:function(b,c){if((b=(b=b[0].lastChild)&&new B(b))&&c&&!c(b))b=b._4e_previous(c);return b},_4e_next:function(b,c){b=q(b);var e;do e=(b=b.nextSibling)&&new B(b);while(e&&c&&!c(e));return e},_4e_outerHtml:function(b){b=q(b);if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,"");var c=b.ownerDocument.createElement("div");
c.appendChild(b.cloneNode(true));return c.innerHTML},_4e_setMarker:function(b,c,e,h){b[0]||(b=new B(b));var d=b._4e_getData("list_marker_id")||b._4e_setData("list_marker_id",A.guid())._4e_getData("list_marker_id"),l=b._4e_getData("list_marker_names")||b._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[d]=b;l[e]=1;return b._4e_setData(e,h)},_4e_clearMarkers:function(b,c,e){b=m(b);var h=b._4e_getData("list_marker_names"),d=b._4e_getData("list_marker_id");for(var l in h)b._4e_removeData(l);
b._4e_removeData("list_marker_names");if(e){b._4e_removeData("list_marker_id");delete c[d]}},_4e_setData:function(b,c,e){var h=t._4e_getUniqueId(b);(i[h]||(i[h]={}))[c]=e;return b},_4e_getData:function(b,c){b=q(b);return(b=(b=b.getAttribute("_ke_expando"))&&i[b])&&b[c]},_4e_removeData:function(b,c){b=q(b);var e=b.getAttribute("_ke_expando");var h=(e=e&&i[e])&&e[c];typeof h!="undefined"&&e&&delete e[c];A.isEmptyObject(e)&&t._4e_clearData(b);return h||null},_4e_clearData:function(b){b=q(b);var c=b.getAttribute("_ke_expando");
c&&delete i[c];c&&b.removeAttribute("_ke_expando")},_4e_getUniqueId:function(b){b=q(b);var c=b.getAttribute("_ke_expando");if(c)return c;c=A.guid();b.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(b,c,e){b=q(b);var h=b.attributes;e=e||{};for(var d=0;d<h.length;d++){var l=h[d],a=l.nodeName.toLowerCase(),f;if(!(a in e))if(a=="checked"&&(f=t.attr(b,a)))c.attr(a,f);else if(l.specified||x.ie&&l.nodeValue&&a=="value"){f=t.attr(b,a);if(f===null)f=l.nodeValue;c.attr(a,f)}}if(b.style.cssText!==
"")c[0].style.cssText=b.style.cssText},_4e_isEditable:function(b){b=t._4e_name(b);var c=w.XHTML_DTD;return(b=!c.$nonEditable[b]&&(c[b]||c.span))&&b["#"]},_4e_scrollIntoView:function(b){b=m(b);var c=b[0].ownerDocument,e=t.scrollLeft(c),h=t.scrollTop(c),d=b.offset(),l=d.left;d=d.top;if(t.viewportHeight(c)+h<d||d<h||t.viewportWidth(c)+e<l||l<e)b.scrollIntoView(c)},_4e_getElementsByTagName:function(b,c,e){b=q(b);if(!x.ie&&e)c=e+":"+c;e=[];b=b.getElementsByTagName(c);for(c=0;c<b.length;c++)e.push(new B(b[c]));
return e}};A.DOM._4e_inject=function(b){A.mix(t,b);for(var c in b)b.hasOwnProperty(c)&&function(e){B.prototype[e]=function(){var h=[].slice.call(arguments,0);h.unshift(this);return b[e].apply(null,h)}}(c)};A.DOM._4e_inject(v)});
KISSY.Editor.add("elementpath",function(w){function u(i){var j=null,p=null,q=[];for(i=i;i&&i[0];){if(i[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=i;var m=i._4e_name();if(o.ie&&i[0].scopeName!="HTML")m=i[0].scopeName.toLowerCase()+":"+m;if(!p){if(!j&&s[m])j=i;if(k[m])if(!j&&m=="div"&&!g(i))j=i;else p=i}q.push(i);if(m=="body")break}i=i.parent()}this.block=j;this.blockLimit=p;this.elements=q}var A=KISSY,t=A.DOM,x=w.XHTML_DTD,B=w.NODE,o=A.UA,s={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},k={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},g=function(i){i=i[0]||i;i=i.childNodes;for(var j=0,p=i.length;j<p;j++){var q=i[j];if(q.nodeType==B.NODE_ELEMENT&&x.$block[q.nodeName.toLowerCase()])return true}return false};u.prototype={compare:function(i){var j=this.elements;i=i&&i.elements;if(!i||j.length!=i.length)return false;for(var p=0;p<j.length;p++)if(!t._4e_equals(j[p],i[p]))return false;return true},contains:function(i){for(var j=
this.elements,p=0;p<j.length;p++)if(j[p]._4e_name()in i)return j[p];return null}};w.ElementPath=u});
KISSY.Editor.add("walker",function(w){function u(k,g){if(this._.end)return null;var i=this.range,j,p=this.guard,q=this.type,m=k?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;i.trim();if(i.collapsed){this.end();return null}}if(!k&&!this._.guardLTR){var v=i.endContainer,b=new s(v[0].childNodes[i.endOffset]);this._.guardLTR=function(d,l){return(!l||!o._4e_equals(v,d))&&(!b[0]||d[0]!==b[0])&&(d[0].nodeType!=B.NODE_ELEMENT||!l||d._4e_name()!="body")}}if(k&&!this._.guardRTL){var c=
i.startContainer,e=i.startOffset>0&&new s(c[0].childNodes[i.startOffset-1]);this._.guardRTL=function(d,l){return d&&d[0]&&(!l||c[0]!==d[0])&&(!e[0]||d[0]!==e[0])&&(d[0].nodeType!=B.NODE_ELEMENT||!l||d._4e_name()!="body")}}var h=k?this._.guardRTL:this._.guardLTR;j=p?function(d,l){if(h(d,l)===false)return false;return p(d,l)}:h;if(this.current)k=this.current[m](false,q,j);else if(k){k=i.endContainer;if(i.endOffset>0){k=new s(k[0].childNodes[i.endOffset-1]);if(j(k)===false)k=null}else k=j(k,true)===
false?null:k._4e_previousSourceNode(true,q,j)}else{k=i.startContainer;if((k=new s(k[0].childNodes[i.startOffset]))&&k[0]){if(j(k)===false)k=null}else k=j(i.startContainer,true)===false?null:i.startContainer._4e_nextSourceNode(true,q,j)}for(;k&&k[0]&&!this._.end;){this.current=k;if(!this.evaluator||this.evaluator(k)!==false){if(!g)return k}else if(g&&this.evaluator)return false;k=k[m](false,q,j)}this.end();return this.current=null}function A(k){for(var g,i=null;g=u.call(this,k);)i=g;return i}function t(k){this.range=
k;this._={}}var x=KISSY,B=w.NODE,o=x.DOM,s=x.Node;x.augment(t,{end:function(){this._.end=1},next:function(){return u.call(this)},previous:function(){return u.call(this,true)},checkForward:function(){return u.call(this,false,true)!==false},checkBackward:function(){return u.call(this,true,true)!==false},lastForward:function(){return A.call(this)},lastBackward:function(){return A.call(this,true)},reset:function(){delete this.current;this._={}}});t.blockBoundary=function(k){return function(g){g[0]||(g=
new s(g));return!(g[0].nodeType==B.NODE_ELEMENT&&g._4e_isBlockBoundary(k))}};t.listItemBoundary=function(){return this.blockBoundary({br:1})};t.bookmark=function(k,g){function i(j){return j&&j[0]&&j._4e_name()=="span"&&j.attr("_ke_bookmark")}return function(j){var p,q;p=j&&j[0]&&j[0].nodeType==B.NODE_TEXT&&(q=j.parent())&&i(q);p=k?p:p||i(j);return g^p}};t.whitespaces=function(k){return function(g){g=(g=g[0]||g)&&g.nodeType==B.NODE_TEXT&&!x.trim(g.nodeValue);return k^g}};t.invisible=function(k){var g=
t.whitespaces();return function(i){i=g(i)||i[0].nodeType==B.NODE_ELEMENT&&!i[0].offsetHeight;return k^i}};w.Walker=t});
KISSY.Editor.add("range",function(w){function u(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=a}function A(a){var f=a[0].nodeType!=k.NODE_TEXT&&a._4e_name()in v.$removeEmpty,n=!s.trim(a[0].nodeValue);a=!!a.parent().attr("_ke_bookmark");return f||n||a}function t(a){return!d(a)&&!l(a)}function x(a){var f=false,n=j.bookmark(true);return function(z){if(n(z))return true;if(z[0].nodeType==k.NODE_TEXT){if(s.trim(z[0].nodeValue).length)return false}else if(z[0].nodeType==
k.NODE_ELEMENT)if(!h[z._4e_name()])if(!a&&!m.ie&&z._4e_name()=="br"&&!f)f=true;else return false;return true}}function B(a,f){function n(z){return z&&z.nodeName=="span"&&z.getAttribute("_ke_bookmark")}return function(z){var r,D;r=z&&!z.nodeName&&(D=z.parentNode)&&n(D);r=a?r:r||n(z);return f^r}}function o(a){return function(f){f=(f=f[0]||f)&&f.nodeType==k.NODE_TEXT&&!s.trim(f.nodeValue);return a^f}}w.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var s=KISSY,k=w.NODE,g=w.RANGE,i=w.POSITION,j=w.Walker,p=s.DOM,q=w.Utils.getByAddress,m=s.UA,v=w.XHTML_DTD,b=w.ElementPath,c=s.Node,e={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};u.prototype.toString=function(){var a=[];a.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);a.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return a.join("<br/>")};s.augment(u,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&p._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var a=this.startContainer,f=this.startOffset;if(a[0].nodeType!=k.NODE_ELEMENT)if(f)f>=a[0].nodeValue.length&&this.setStartAfter(a);else this.setStartBefore(a);a=this.endContainer;f=this.endOffset;if(a[0].nodeType!=k.NODE_ELEMENT)if(f)f>=a[0].nodeValue.length&&
this.setEndAfter(a);else this.setEndBefore(a)},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,f=this.endContainer;a&&a._4e_name()=="span"&&a.attr("_ke_bookmark")&&this.setStartAt(a,g.POSITION_BEFORE_START);f&&f._4e_name()=="span"&&
f.attr("_ke_bookmark")&&this.setEndAt(f,g.POSITION_AFTER_END)},setStart:function(a,f){if(a[0].nodeType==k.NODE_ELEMENT&&e[a._4e_name()]){a=a.parent();f=a._4e_index()}this.startContainer=a;this.startOffset=f;if(!this.endContainer){this.endContainer=a;this.endOffset=f}this.updateCollapsed()},setEnd:function(a,f){if(a[0].nodeType==k.NODE_ELEMENT&&e[a._4e_name()]){a=a.parent();f=a._4e_index()+1}this.endContainer=a;this.endOffset=f;if(!this.startContainer){this.startContainer=a;this.startOffset=f}this.updateCollapsed()},
setStartAt:function(a,f){switch(f){case g.POSITION_AFTER_START:this.setStart(a,0);break;case g.POSITION_BEFORE_END:a[0].nodeType==k.NODE_TEXT?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setStartBefore(a);break;case g.POSITION_AFTER_END:this.setStartAfter(a)}this.updateCollapsed()},setEndAt:function(a,f){switch(f){case g.POSITION_AFTER_START:this.setEnd(a,0);break;case g.POSITION_BEFORE_END:a[0].nodeType==k.NODE_TEXT?this.setEnd(a,
a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setEndBefore(a);break;case g.POSITION_AFTER_END:this.setEndAfter(a)}this.updateCollapsed()},execContentsAction:function(a,f){var n=this.startContainer,z=this.endContainer,r=this.startOffset,D=this.endOffset,H,y;this.optimizeBookmark();if(z[0].nodeType==k.NODE_TEXT)z=z._4e_splitText(D);else if(z[0].childNodes.length>0)if(D>=z[0].childNodes.length){z=new c(z[0].appendChild(this.document.createTextNode("")));
y=true}else z=new c(z[0].childNodes[D]);if(n[0].nodeType==k.NODE_TEXT){n._4e_splitText(r);if(p._4e_equals(n,z))z=new c(n[0].nextSibling)}else if(r)if(r>=n[0].childNodes.length){H=new c(this.document.createTextNode(""));n[0].appendChild(H[0]);n=H;H=true}else n=new c(n[0].childNodes[r].previousSibling);else{H=new c(this.document.createTextNode(""));p.insertBefore(H[0],n[0].firstChild);n=H;H=true}r=n._4e_parents();D=z._4e_parents();var C,I,J;for(C=0;C<r.length;C++){I=r[C];J=D[C];if(I[0]!==J[0])break}for(var N=
f,M,Q,R,W=C;W<r.length;W++){M=r[W];if(N&&M[0]!==n[0])Q=N.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(D[W]&&M==D[W][0]||M==z[0])break;R=M.nextSibling;if(a==2)N.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);a==1&&N.appendChild(M)}M=R}if(Q)N=Q}N=f;for(f=C;f<D.length;f++){M=D[f];if(a>0&&M[0]!==z[0])Q=N.appendChild(M._4e_clone()[0]);if(!r[f]||M[0].parentNode!==r[f][0].parentNode)for(M=M[0].previousSibling;M;){if(r[f]&&M==r[f][0]||M===n[0])break;R=M.previousSibling;if(a==
2)N.insertBefore(M.cloneNode(true),N.firstChild);else{M.parentNode.removeChild(M);a==1&&N.insertBefore(M,N.firstChild)}M=R}if(Q)N=Q}if(a==2){J=this.startContainer[0];if(J.nodeType==k.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==k.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}J=this.endContainer[0];if(J.nodeType==k.NODE_TEXT&&J.nextSibling&&J.nextSibling.nodeType==k.NODE_TEXT){J.data+=J.nextSibling.data;J.parentNode.removeChild(J.nextSibling)}}else{if(I&&J&&(n[0].parentNode!=
I[0].parentNode||z[0].parentNode!=J[0].parentNode)){a=J._4e_index();H&&J[0].parentNode==n[0].parentNode&&a--;this.setStart(J.parent(),a)}this.collapse(true)}H&&n._4e_remove();y&&z[0].parentNode&&z._4e_remove()},collapse:function(a){if(a){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var a=new u(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;
a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=k.NODE_ELEMENT||a.endContainer[0].nodeType!=k.NODE_ELEMENT)return null;a=a.startContainer[0].childNodes[a.startOffset];for(var f=B(true,undefined),n=o(true),z=function(r){return n(r)&&f(r)};a&&z(a);)a=(new c(a))._4e_nextSourceNode()[0];return new c(a)},shrink:function(a,f){if(!this.collapsed){a=a||g.SHRINK_TEXT;
var n=this.clone(),z=this.startContainer,r=this.endContainer,D=this.startOffset,H=this.endOffset,y=1,C=1;if(z&&z[0].nodeType==k.NODE_TEXT)if(D)if(D>=z[0].nodeValue.length)n.setStartAfter(z);else{n.setStartBefore(z);y=0}else n.setStartBefore(z);if(r&&r[0].nodeType==k.NODE_TEXT)if(H)if(H>=r[0].nodeValue.length)n.setEndAfter(r);else{n.setEndAfter(r);C=0}else n.setEndBefore(r);n=new j(n);n.evaluator=function(J){J=J[0]||J;return J.nodeType==(a==g.SHRINK_ELEMENT?k.NODE_ELEMENT:k.NODE_TEXT)};var I;n.guard=
function(J,N){J=J[0]||J;if(a==g.SHRINK_ELEMENT&&J.nodeType==k.NODE_TEXT)return false;if(N&&J==I)return false;if(!N&&J.nodeType==k.NODE_ELEMENT)I=J;return true};if(y)(z=n[a==g.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(z,f?g.POSITION_AFTER_START:g.POSITION_BEFORE_START);if(C){n.reset();(n=n[a==g.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,f?g.POSITION_BEFORE_END:g.POSITION_AFTER_END)}return!!(y||C)}},getTouchedStartNode:function(){var a=this.startContainer;if(this.collapsed||
a[0].nodeType!=k.NODE_ELEMENT)return a;return a.childNodes[this.startOffset]||a},createBookmark2:function(a){var f=this.startContainer,n=this.endContainer,z=this.startOffset,r=this.endOffset,D,H;if(!f||!n)return{start:0,end:0};if(a){if(f[0].nodeType==k.NODE_ELEMENT)if((D=new c(f[0].childNodes[z]))&&D[0]&&D[0].nodeType==k.NODE_TEXT&&z>0&&D[0].previousSibling.nodeType==k.NODE_TEXT){f=D;z=0}for(;f[0].nodeType==k.NODE_TEXT&&(H=f._4e_previous())&&H[0].nodeType==k.NODE_TEXT;){f=H;z+=H[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==
k.NODE_ELEMENT)if((D=new c(n[0].childNodes[r]))&&D[0]&&D[0].nodeType==k.NODE_TEXT&&r>0&&D[0].previousSibling.nodeType==k.NODE_TEXT){n=D;r=0}for(;n[0].nodeType==k.NODE_TEXT&&(H=n._4e_previous())&&H[0].nodeType==k.NODE_TEXT;){n=H;r+=H[0].nodeValue.length}}}return{start:f._4e_address(a),end:this.collapsed?null:n._4e_address(a),startOffset:z,endOffset:r,normalized:a,is2:true}},createBookmark:function(a){var f,n,z,r;f=new c("<span></span>",null,this.document);f.attr("_ke_bookmark",1);f.css("display","none");
f.html("&nbsp;");if(a){z=s.guid("ke_bm_");f.attr("id",z+"S")}if(!this.collapsed){n=f._4e_clone();n.html("&nbsp;");a&&n.attr("id",z+"E");r=this.clone();r.collapse();r.insertNode(n)}r=this.clone();r.collapse(true);r.insertNode(f);if(n){this.setStartAfter(f);this.setEndBefore(n)}else this.moveToPosition(f,g.POSITION_AFTER_END);return{startNode:a?z+"S":f,endNode:a?z+"E":n,serializable:a}},moveToPosition:function(a,f){this.setStartAt(a,f);this.collapse(true)},trim:function(a,f){var n=this.startContainer,
z=this.startOffset,r=this.collapsed;if((!a||r)&&n[0]&&n[0].nodeType==k.NODE_TEXT){if(z)if(z>=n[0].nodeValue.length){z=n._4e_index()+1;n=n.parent()}else{a=n._4e_splitText(z);z=n._4e_index()+1;n=n.parent();if(p._4e_equals(this.startContainer,this.endContainer))this.setEnd(a,this.endOffset-this.startOffset);else if(p._4e_equals(n,this.endContainer))this.endOffset+=1}else{z=n._4e_index();n=n.parent()}this.setStart(n,z);if(r){this.collapse(true);return}}n=this.endContainer;z=this.endOffset;if(!(f||r)&&
n[0]&&n[0].nodeType==k.NODE_TEXT){if(z){z>=n.nodeValue.length||n._4e_splitText(z);z=n._4e_index()+1}else z=n._4e_index();n=n.parent();this.setEnd(n,z)}},insertNode:function(a){this.optimizeBookmark();this.trim(false,true);var f=this.startContainer,n=f[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);n?p.insertBefore(a[0]||a,n):f[0].appendChild(a[0]||a);p._4e_equals(a.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){if(a.is2){var f=
q(this.document,a.start,a.normalized),n=a.startOffset,z=a.end&&q(this.document,a.end,a.normalized);a=a.endOffset;this.setStart(f,n);z?this.setEnd(z,a):this.collapse(true)}else{f=(n=a.serializable)?s.one("#"+a.startNode,this.document):a.startNode;a=n?s.one("#"+a.endNode,this.document):a.endNode;this.setStartBefore(f);f._4e_remove();if(a&&a[0]){this.setEndBefore(a);a._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(a,f){var n=this.startContainer,z=this.endContainer;a=p._4e_equals(n,
z)?a&&n[0].nodeType==k.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(z);return f&&a[0].nodeType==k.NODE_TEXT?a.parent():a},enlarge:function(a){switch(a){case g.ENLARGE_ELEMENT:if(this.collapsed)return;a=this.getCommonAncestor();var f=new c(this.document.body),n,z,r,D,H,y=false,C,I;C=this.startContainer;I=this.startOffset;if(C[0].nodeType==k.NODE_TEXT){if(I){C=!s.trim(C[0].nodeValue.substring(0,I)).length&&C;y=!!C}if(C)if(!(D=C[0].previousSibling))r=
C.parent()}else{if(I)D=C[0].childNodes[I-1]||C[0].lastChild;D||(r=C)}for(;r||D;){if(r&&!D){if(!H&&p._4e_equals(r,a))H=true;if(!f._4e_contains(r))break;if(!y||r.css("display")!="inline"){y=false;if(H)n=r;else this.setStartBefore(r)}D=r[0].previousSibling}for(;D;){C=false;if(D.nodeType==k.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/[\s\ufeff]$/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(y&&v.$removeEmpty[D.nodeName.toLowerCase()]){I=p.text(D);if(/[^\s\ufeff]/.test(I))D=
null;else for(var J=D.all||D.getElementsByTagName("*"),N=0,M;M=J[N++];)if(!v.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}if(D)C=!!I.length}else D=null;if(C)if(y)if(H)n=r;else r&&this.setStartBefore(r);else y=true;if(D){C=D.previousSibling;if(!r&&!C){r=new c(D);D=null;break}D=C}else r=null}if(r)r=r.parent()}C=this.endContainer;I=this.endOffset;r=D=null;H=y=false;if(C[0].nodeType==k.NODE_TEXT){C=!s.trim(C[0].nodeValue.substring(I)).length&&C;y=!(C&&C[0].nodeValue.length);if(C)if(!(D=C[0].nextSibling))r=
C.parent()}else(D=C[0].childNodes[I])||(r=C);for(;r||D;){if(r&&!D){if(!H&&p._4e_equals(r,a))H=true;if(!f._4e_contains(r))break;if(!y||r.css("display")!="inline"){y=false;if(H)z=r;else r&&this.setEndAfter(r)}D=r[0].nextSibling}for(;D;){C=false;if(D.nodeType==k.NODE_TEXT){I=D.nodeValue;if(/[^\s\ufeff]/.test(I))D=null;C=/^[\s\ufeff]/.test(I)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(y&&v.$removeEmpty[D.nodeName.toLowerCase()]){I=p.text(D);if(/[^\s\ufeff]/.test(I))D=null;else{J=D.all||
D.getElementsByTagName("*");for(N=0;M=J[N++];)if(!v.$removeEmpty[M.nodeName.toLowerCase()]){D=null;break}}if(D)C=!!I.length}else D=null;if(C)if(y)if(H)z=r;else this.setEndAfter(r);if(D){C=D.nextSibling;if(!r&&!C){r=new c(D);D=null;break}D=C}else r=null}if(r)r=r.parent()}if(n&&z){a=n._4e_contains(z)?z:n;this.setStartBefore(a);this.setEndAfter(a)}break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:r=new u(this.document);f=new c(this.document.body);r.setStartAt(f,g.POSITION_AFTER_START);
r.setEnd(this.startContainer,this.startOffset);r=new j(r);var Q,R,W=j.blockBoundary(a==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),$=function(aa){var E=W(aa);E||(Q=aa);return E};n=function(aa){var E=$(aa);if(!E&&aa[0]&&aa._4e_name()=="br")R=aa;return E};r.guard=$;r=r.lastBackward();Q=Q||f;this.setStartAt(Q,Q._4e_name()!="br"&&(!r&&this.checkStartOfBlock()||r&&Q._4e_contains(r))?g.POSITION_AFTER_START:g.POSITION_AFTER_END);r=this.clone();r.collapse();r.setEndAt(f,g.POSITION_BEFORE_END);r=new j(r);r.guard=
a==g.ENLARGE_LIST_ITEM_CONTENTS?n:$;Q=null;r=r.lastForward();Q=Q||f;this.setEndAt(Q,!r&&this.checkEndOfBlock()||r&&Q._4e_contains(r)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START);R&&this.setEndAfter(R)}},checkStartOfBlock:function(){var a=this.startContainer,f=this.startOffset;if(f&&a[0].nodeType==k.NODE_TEXT)if(s.trim(a[0].nodeValue.substring(0,f)).length)return false;this.trim();a=new b(this.startContainer);f=this.clone();f.collapse(true);f.setStartAt(a.block||a.blockLimit,g.POSITION_AFTER_START);
a=new j(f);a.evaluator=x(true);return a.checkBackward()},checkEndOfBlock:function(){var a=this.endContainer,f=this.endOffset;if(a[0].nodeType==k.NODE_TEXT)if(s.trim(a[0].nodeValue.substring(f)).length)return false;this.trim();a=new b(this.endContainer);f=this.clone();f.collapse(false);f.setEndAt(a.block||a.blockLimit,g.POSITION_BEFORE_END);a=new j(f);a.evaluator=x(false);return a.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var a=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,a);return a},checkBoundaryOfElement:function(a,f){var n=this.clone();n[f==g.START?"setStartAt":"setEndAt"](a,f==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);a=new j(n);a.evaluator=A;return a[f==g.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,f=this.endContainer,n=this.startOffset,z=this.endOffset,r;if(a[0].nodeType==k.NODE_ELEMENT){r=a[0].childNodes.length;if(r>
n)a=new c(a[0].childNodes[n]);else if(r<1)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=new c(a);a=a._4e_nextSourceNode()||a}}if(f[0].nodeType==k.NODE_ELEMENT){r=f[0].childNodes.length;if(r>z)f=(new c(f[0].childNodes[z]))._4e_previousSourceNode(true);else if(r<1)f=f._4e_previousSourceNode();else{for(f=f[0];f.lastChild;)f=f.lastChild;f=new c(f)}}if(a._4e_position(f)&i.POSITION_FOLLOWING)a=f;return{startNode:a,endNode:f}},fixBlock:function(a,f){var n=this.createBookmark();
f=new c(this.document.createElement(f));this.collapse(a);this.enlarge(g.ENLARGE_BLOCK_CONTENTS);f[0].appendChild(this.extractContents());f._4e_trim();m.ie||f._4e_appendBogus();this.insertNode(f);this.moveToBookmark(n);return f},splitBlock:function(a){var f=new b(this.startContainer),n=new b(this.endContainer),z=f.block,r=n.block,D=null;if(f.blockLimit[0]!==n.blockLimit[0])return null;if(a!="br"){if(!z){z=this.fixBlock(true,a);r=(new b(this.endContainer)).block}r||(r=this.fixBlock(false,a))}a=z&&this.checkStartOfBlock();
f=r&&this.checkEndOfBlock();this.deleteContents();if(z&&p._4e_equals(z,r))if(f){D=new b(this.startContainer);this.moveToPosition(r,g.POSITION_AFTER_END);r=null}else if(a){D=new b(this.startContainer);this.moveToPosition(z,g.POSITION_BEFORE_START);z=null}else{r=this.splitElement(z);!m.ie&&!s.inArray(z._4e_name(),["ul","ol"])&&z._4e_appendBogus()}return{previousBlock:z,nextBlock:r,wasStartOfBlock:a,wasEndOfBlock:f,elementPath:D}},splitElement:function(a){if(!this.collapsed)return null;this.setEndAt(a,
g.POSITION_BEFORE_END);var f=this.extractContents(),n=a._4e_clone(false);n[0].appendChild(f);n.insertAfter(a);this.moveToPosition(a,g.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(a,f){var n,z=w.XHTML_DTD;if(z.$empty[a._4e_name()])return false;for(;a&&a[0].nodeType==k.NODE_ELEMENT;){if(n=a._4e_isEditable())this.moveToPosition(a,f?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(z.$inline[a._4e_name()]){this.moveToPosition(a,f?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);
return true}if((a=z.$empty[a._4e_name()]?a[f?"_4e_previous":"_4e_next"](t):a[f?"_4e_last":"_4e_first"](t))&&a[0].nodeType==k.NODE_TEXT){this.moveToPosition(a,f?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return true}}return n},selectNodeContents:function(a){this.setStart(a,0);this.setEnd(a,a[0].nodeType==k.NODE_TEXT?a[0].nodeValue.length:a[0].childNodes.length)}});var h={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},d=new j.whitespaces,l=new j.bookmark;w.Range=u});
KISSY.Editor.add("domiterator",function(w){function u(q){if(!(arguments.length<1)){this.range=q;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var A=KISSY,t=A.UA,x=w.Walker,B=w.Range,o=w.RANGE,s=w.NODE,k=w.ElementPath,g=A.Node,i=A.DOM,j=/^[\r\n\t ]*$/,p=x.bookmark();A.augment(u,{getNextParagraph:function(q){var m,v,b,c,e;if(!this._.lastNode){v=this.range.clone();v.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:o.ENLARGE_BLOCK_CONTENTS);
var h=new x(v),d=x.bookmark(true,true);h.evaluator=d;this._.nextNode=h.next();h=new x(v);h.evaluator=d;h=h.previous();this._.lastNode=h._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==s.NODE_TEXT&&!A.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){d=new B(v.document);d.moveToPosition(this._.lastNode,o.POSITION_AFTER_END);if(d.checkEndOfBlock()){d=new k(d.endContainer);this._.lastNode=(d.block||d.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new g(v.document.createTextNode(""));i.insertAfter(this._.lastNode[0],h[0])}v=null}d=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;d;){var l=false,a=d[0].nodeType!=s.NODE_ELEMENT,f=false;if(a){if(d[0].nodeType==s.NODE_TEXT)if(j.test(d[0].nodeValue))a=false}else{var n=d._4e_name();if(d._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(n=="br")a=true;else if(!v&&!d[0].childNodes.length&&n!="hr"){m=d;b=d._4e_equals(h);break}if(v){v.setEndAt(d,o.POSITION_BEFORE_START);
if(n!="br")this._.nextNode=d}l=true}else{if(d[0].firstChild){if(!v){v=new B(this.range.document);v.setStartAt(d,o.POSITION_BEFORE_START)}d=new g(d[0].firstChild);continue}a=true}}if(a&&!v){v=new B(this.range.document);v.setStartAt(d,o.POSITION_BEFORE_START)}b=(!l||a)&&d._4e_equals(h);if(v&&!l)for(;!d[0].nextSibling&&!b;){n=d.parent();if(n._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=true;b||n._4e_equals(h);break}d=n;a=true;b=d._4e_equals(h);f=true}a&&v.setEndAt(d,o.POSITION_AFTER_END);d=d._4e_nextSourceNode(f,
null,h);b=!d;if((l||b)&&v){a=v.getBoundaryNodes();l=new k(v.startContainer);if(a.startNode.parent()._4e_equals(l.blockLimit)&&p(a.startNode)&&p(a.endNode)){v=null;this._.nextNode=null}else break}if(b)break}if(!m){if(!v){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}l=new k(v.startContainer);d=l.blockLimit;a={div:1,th:1,td:1};m=l.block;if((!m||!m[0])&&!this.enforceRealBlocks&&a[d._4e_name()]&&v.checkStartOfBlock()&&v.checkEndOfBlock())m=d;else if(!m||this.enforceRealBlocks&&
m._4e_name()=="li"){m=new g(this.range.document.createElement(q||"p"));m[0].appendChild(v.extractContents());m._4e_trim();v.insertNode(m);c=e=true}else if(m._4e_name()!="li"){if(!v.checkStartOfBlock()||!v.checkEndOfBlock()){m=m._4e_clone(false);m[0].appendChild(v.extractContents());m._4e_trim();e=v.splitBlock();c=!e.wasStartOfBlock;e=!e.wasEndOfBlock;v.insertNode(m)}}else if(!b)this._.nextNode=m._4e_equals(h)?null:v.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,h)}if(c){v=new g(m[0].previousSibling);
if(v[0]&&v[0].nodeType==s.NODE_ELEMENT)if(v._4e_name()=="br")v._4e_remove();else v[0].lastChild&&v[0].lastChild.nodeName.toLowerCase()=="br"&&i._4e_remove(v[0].lastChild)}if(e){v=x.bookmark(false,true);c=new g(m[0].lastChild);if(c[0]&&c[0].nodeType==s.NODE_ELEMENT&&c._4e_name()=="br")if(t.ie||c._4e_previous(v)||c._4e_next(v))c._4e_remove()}if(!this._.nextNode)this._.nextNode=b||m._4e_equals(h)?null:m._4e_nextSourceNode(true,null,h);return m}});B.prototype.createIterator=function(){return new u(this)}});
KISSY.Editor.add("selection",function(w){function u(h){this.document=h;this._={cache:{}};if(B.ie){var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!=h||d.parentElement&&d.parentElement().ownerDocument!=h)this.isInvalid=true}}function A(h){h=new u(h);return!h||h.isInvalid?null:h}function t(h){var d=h.document,l=new g(d.body),a=new g(d.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)a.on("click",function(D){o._4e_name(D.target)==="html"&&h.getSelection().getRanges()[0].select()});
var f,n;l.on("focusin",function(D){if(D.target.nodeName.toUpperCase()=="BODY")if(f){try{f.select()}catch(H){}f=null}});l.on("focus",function(){n=true;r()});l.on("beforedeactivate",function(D){D.relatedTarget||(n=false)});B.ie<8&&s.on(o._4e_getWin(d),"blur",function(){d.selection.empty()});l.on("mousedown",z);l.on("mouseup",function(){n=true;setTimeout(function(){r(true)},0)});l.on("keydown",z);l.on("keyup",function(){n=true;r()});s.on(d,"selectionchange",r);var z=function(){n=false},r=function(D){if(n){var H=
h.document,y=h.getSelection(),C=y&&y.getNative();if(D&&C&&C.type=="None")if(!H.queryCommandEnabled("InsertImage")){setTimeout(function(){r(true)},50);return}var I;if(!(C&&C.type=="Text"&&(I=C.createRange().parentElement().nodeName.toLowerCase())&&I in{input:1,textarea:1})){f=C&&y.getRanges()[0];h._monitor()}}}}else{s.on(d,"mouseup",h._monitor,h);s.on(d,"keyup",h._monitor,h)}}w.SELECTION={};var x=KISSY,B=x.UA,o=x.DOM,s=x.Event,k=w.Utils.tryThese,g=x.Node,i=w.SELECTION,j=w.RANGE,p=w.NODE,q=w.Walker,
m=w.Range;i.SELECTION_NONE=1;i.SELECTION_TEXT=2;i.SELECTION_ELEMENT=3;var v={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};x.augment(u,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=o._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var h=this._.cache;if(h.type)return h.type;
var d=i.SELECTION_NONE;try{var l=this.getNative(),a=l.type;if(a=="Text")d=i.SELECTION_TEXT;if(a=="Control")d=i.SELECTION_ELEMENT;if(l.createRange().parentElement)d=i.SELECTION_TEXT}catch(f){}return h.type=d}:function(){var h=this._.cache;if(h.type)return h.type;var d=i.SELECTION_TEXT,l=this.getNative();if(l){if(l.rangeCount==1){l=l.getRangeAt(0);var a=l.startContainer;if(a==l.endContainer&&a.nodeType==p.NODE_ELEMENT&&l.endOffset-l.startOffset===1&&v[a.childNodes[l.startOffset].nodeName.toLowerCase()])d=
i.SELECTION_ELEMENT}}else d=i.SELECTION_NONE;return h.type=d},getRanges:B.ie?function(){var h=function(d,l){d=d.duplicate();d.collapse(l);l=d.parentElement();for(var a=l.childNodes,f,n=0;n<a.length;n++){var z=a[n];if(z.nodeType==p.NODE_ELEMENT){f=d.duplicate();f.moveToElementText(z);z=f.compareEndPoints("StartToStart",d);var r=f.compareEndPoints("EndToStart",d);f.collapse();if(z>0)break;else if(!z||r==1&&z==-1)return{container:l,offset:n};else if(!r)return{container:l,offset:n+1};f=null}}if(!f){f=
d.duplicate();f.moveToElementText(l);f.collapse(false)}f.setEndPoint("StartToStart",d);d=f.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;d>0;)d-=a[--n].nodeValue.length}catch(D){d=0}return d===0?{container:l,offset:n}:{container:a[n],offset:-d}};return function(){var d=this._.cache;if(d.ranges)return d.ranges;var l=this.getNative(),a=l&&l.createRange(),f=this.getType();if(!l)return[];if(f==i.SELECTION_TEXT){l=new m(this.document);f=h(a,true);l.setStart(new g(f.container),f.offset);f=h(a);l.setEnd(new g(f.container),
f.offset);return d.ranges=[l]}else if(f==i.SELECTION_ELEMENT){d=this._.cache.ranges=[];for(f=0;f<a.length;f++){var n=a.item(f),z=n.parentNode,r=0;for(l=new m(this.document);r<z.childNodes.length&&z.childNodes[r]!=n;r++);l.setStart(new g(z),r);l.setEnd(new g(z),r+1);d.push(l)}return d}return d.ranges=[]}}():function(){var h=this._.cache;if(h.ranges)return h.ranges;var d=[],l=this.getNative();if(!l)return[];for(var a=0;a<l.rangeCount;a++){var f=l.getRangeAt(a),n=new m(this.document);n.setStart(new g(f.startContainer),
f.startOffset);n.setEnd(new g(f.endContainer),f.endOffset);d.push(n)}return h.ranges=d},getStartElement:function(){var h=this._.cache;if(h.startElement!==undefined)return h.startElement;var d,l=this.getNative();switch(this.getType()){case i.SELECTION_ELEMENT:return this.getSelectedElement();case i.SELECTION_TEXT:var a=this.getRanges()[0];if(a)if(!a.collapsed){for(a.optimize();;){d=a.startContainer;if(a.startOffset==(d[0].nodeType===p.NODE_ELEMENT?d[0].childNodes.length:d[0].nodeValue.length)&&!d._4e_isBlockBoundary())a.setStartAfter(d);
else break}d=a.startContainer;if(d[0].nodeType!=p.NODE_ELEMENT)return d.parent();d=new g(d[0].childNodes[a.startOffset]);if(!d[0]||d[0].nodeType!=p.NODE_ELEMENT)return a.startContainer;for(a=d[0].firstChild;a&&a.nodeType==p.NODE_ELEMENT;){d=new g(a);a=a.firstChild}return d}if(B.ie){a=l.createRange();a.collapse(true);d=a.parentElement()}else if((d=l.anchorNode)&&d.nodeType!=p.NODE_ELEMENT)d=d.parentNode}return h.startElement=d?new g(d):null},getSelectedElement:function(){var h=this._.cache;if(h.selectedElement!==
undefined)return h.selectedElement;var d=this,l=k(function(){return d.getNative().createRange().item(0)},function(){for(var a=d.getRanges()[0],f,n,z=2;z&&!((f=a.getEnclosedNode())&&f[0].nodeType==p.NODE_ELEMENT&&v[f._4e_name()]&&(n=f));z--)a.shrink(j.SHRINK_ELEMENT);return n[0]});return h.selectedElement=l?new g(l):null},reset:function(){this._.cache={}},selectElement:function(h){var d;if(B.ie)try{d=this.document.body.createControlRange();d.addElement(h[0]);d.select()}catch(l){d=this.document.body.createTextRange();
d.moveToElementText(h[0]);d.select()}finally{}else{d=this.document.createRange();d.selectNode(h[0]);h=this.getNative();h.removeAllRanges();h.addRange(d)}this.reset()},selectRanges:function(h){if(B.ie)h[0]&&h[0].select();else{var d=this.getNative();if(!d)return;d.removeAllRanges();for(var l=0;l<h.length;l++){var a=h[l],f=this.document.createRange(),n=a.startContainer;a.collapsed&&B.gecko&&B.gecko<1.09&&n[0].nodeType==p.NODE_ELEMENT&&!n[0].childNodes.length&&n[0].appendChild(this.document.createTextNode(""));
f.setStart(n[0],a.startOffset);f.setEnd(a.endContainer[0],a.endOffset);d.addRange(f)}}this.reset()},createBookmarks2:function(h){for(var d=[],l=this.getRanges(),a=0;a<l.length;a++)d.push(l[a].createBookmark2(h));return d},createBookmarks:function(h){for(var d=[],l=this.getRanges(),a=l.length,f=this.document,n,z=0;z<a;z++){d.push(n=l[z].createBookmark(h,true));var r=(h=n.serializable)?x.one("#"+n.startNode,f):n.startNode;n=h?x.one("#"+n.endNode,f):n.endNode;for(var D=z+1;D<a;D++){var H=l[D],y=H.startContainer,
C=H.endContainer;o._4e_equals(y,r.parent())&&H.startOffset++;o._4e_equals(y,n.parent())&&H.startOffset++;o._4e_equals(C,r.parent())&&H.endOffset++;o._4e_equals(C,n.parent())&&H.endOffset++}}return d},selectBookmarks:function(h){for(var d=[],l=0;l<h.length;l++){var a=new m(this.document);a.moveToBookmark(h[l]);d.push(a)}this.selectRanges(d);return this},getCommonAncestor:function(){var h=this.getRanges();return h[0].startContainer._4e_commonAncestor(h[h.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
w.Selection=u;var b={table:1,tbody:1,tr:1},c=q.whitespaces(true),e=/\ufeff|\u00a0/;m.prototype.select=B.ie?function(h){var d=this.collapsed,l,a;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var f=this.startContainer[0].childNodes[this.startOffset];if(f.nodeType==p.NODE_ELEMENT){(new u(this.document)).selectElement(new g(f));return}}if(this.startContainer[0].nodeType==p.NODE_ELEMENT&&this.startContainer._4e_name()in b||this.endContainer[0].nodeType==p.NODE_ELEMENT&&
this.endContainer._4e_name()in b)this.shrink(p.NODE_ELEMENT,true);var n=this.createBookmark();f=n.startNode;var z;if(!d)z=n.endNode;n=this.document.body.createTextRange();n.moveToElementText(f[0]);n.moveStart("character",1);if(z){h=this.document.body.createTextRange();h.moveToElementText(z[0]);n.setEndPoint("EndToEnd",h);n.moveEnd("character",-1)}else{for(l=f[0].nextSibling;l&&!c(l);)l=l.nextSibling;l=!(l&&l.nodeValue&&l.nodeValue.match(e))&&(h||!f[0].previousSibling||f[0].previousSibling&&o._4e_name(f[0].previousSibling)==
"br");a=this.document.createElement("span");a.innerHTML="&#65279;";a=new g(a);o.insertBefore(a[0],f[0]);l&&o.insertBefore(this.document.createTextNode("\ufeff"),f[0])}this.setStartBefore(f);f._4e_remove();if(d){if(l){n.moveStart("character",-1);n.select();this.document.selection.clear()}else n.select();if(a){this.moveToPosition(a,j.POSITION_BEFORE_START);a._4e_remove()}}else{this.setEndBefore(z);z._4e_remove();n.select()}}:function(){var h=this.startContainer;this.collapsed&&h[0].nodeType==p.NODE_ELEMENT&&
!h[0].childNodes.length&&h[0].appendChild(this.document.createTextNode(""));var d=this.document.createRange();d.setStart(h[0],this.startOffset);try{d.setEnd(this.endContainer[0],this.endOffset)}catch(l){if(l.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);d.setEnd(this.endContainer[0],this.endOffset)}else throw l;}h=A(this.document).getNative();h.removeAllRanges();h.addRange(d)};w.on("instanceCreated",function(h){t(h.editor)})});
KISSY.Editor.add("styles",function(w){function u(E,F){for(var G in E)E[G]=E[G].replace(aa,function(L,K){return F[K]})}function A(E,F){if(F){E=z.clone(E);u(E.attributes,F);u(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||R[F]?D.STYLE_BLOCK:W[F]?D.STYLE_OBJECT:D.STYLE_INLINE;this._={definition:E}}function t(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new y(E);for(var G=E.getRanges(),L=0;L<G.length;L++)F.call(this,G[L]);E.selectRanges(G)}function x(E,
F){var G=E.element;if(G=="*")G="span";F=new N(F.createElement(G));return B(F,E)}function B(E,F){var G=F._.definition;F=G.attributes;G=A.getStyleText(G);if(F)for(var L in F)E.attr(L,F[L]);if(G)E[0].style.cssText=G;return E}function o(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var L,K=E.document;L=G.getNextParagraph();){var O=x(this,K);i(L,O)}E.moveToBookmark(F)}function s(E,F,G){var L="",K="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(O,P,S){P&&(L=P);S&&(K=S);return""});return L+E.replace(F,G)+K}function k(E,F){var G=E.html();G=s(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new N(E.firstChild);F._4e_remove()}else F.html(G);return F}function g(E){var F=[];s(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,L,K){return L+"</pre>"+K+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,L){F.push(L)});return F}function i(E,F){var G=F._4e_name=="pre",L=E._4e_name=="pre",K=!G&&L;if(G&&!L)F=k(E,F);else if(K)F=p(g(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&j(F)}function j(E){var F;if((F=E._4e_previousSourceNode(true,C.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=s(F.html(),/\n$/,"")+"\n\n"+s(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function p(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),L=0;L<E.length;L++){var K=E[L];K=K.replace(/(\r\n|\r)/g,"\n");K=s(K,/^[ \t]*\n/,"");K=s(K,/\n$/,"");K=s(K,/^[ \t]+|[ \t]+$/g,function(P,S){return P.length==1?"&nbsp;":S?" "+(new Array(P.length)).join("&nbsp;"):(new Array(P.length)).join("&nbsp;")+" "});K=K.replace(/\n/g,"<br>");K=K.replace(/[ \t]{2,}/g,function(P){return(new Array(P.length)).join("&nbsp;")+" "});var O=F._4e_clone();O.html(K);G.appendChild(O[0])}return G}
function q(E){var F=E.document;if(E.collapsed){F=x(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,L=this._.definition,K,O=w.XHTML_DTD[G]||(K=true,w.XHTML_DTD.span),P=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var S=E.createBookmark(),da=S.startNode;S=S.endNode;for(var U=da,X;U&&U[0];){var T=false;if(r._4e_equals(U,S)){U=null;T=true}else{var V=U[0].nodeType,ba=V==C.NODE_ELEMENT?U._4e_name():null;if(ba&&U.attr("_ke_bookmark")){U=U._4e_nextSourceNode(true);
continue}if(!ba||O[ba]&&(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(U))){var ca=U.parent();if(ca&&ca[0]&&((w.XHTML_DTD[ca._4e_name()]||w.XHTML_DTD.span)[G]||K)&&(!L.parentRule||L.parentRule(ca))){if(!X&&(!ba||!w.XHTML_DTD.$removeEmpty[ba]||(U._4e_position(S)|I.POSITION_PRECEDING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_PRECEDING+I.POSITION_IDENTICAL+
I.POSITION_IS_CONTAINED)){X=new J(F);X.setStartBefore(U)}if(V==C.NODE_TEXT||V==C.NODE_ELEMENT&&!U[0].childNodes.length){V=U;for(var Y;!V[0].nextSibling&&(Y=V.parent(),O[Y._4e_name()])&&(Y._4e_position(da)|I.POSITION_FOLLOWING|I.POSITION_IDENTICAL|I.POSITION_IS_CONTAINED)==I.POSITION_FOLLOWING+I.POSITION_IDENTICAL+I.POSITION_IS_CONTAINED&&(!L.childRule||L.childRule(Y));)V=Y;X.setEndAfter(V);V[0].nextSibling||(T=true)}}else T=true}else T=true;U=U._4e_nextSourceNode()}if(T&&X&&!X.collapsed){T=x(this,
F);for(V=X.getCommonAncestor();T&&V&&T[0]&&V[0];){if(V._4e_name()==G){for(var Z in L.attributes)T.attr(Z)==V.attr(Z)&&T[0].removeAttribute(Z);for(var ea in L.styles)T._4e_style(ea)==V._4e_style(ea)&&T._4e_style(ea,"");if(!T._4e_hasAttributes()){T=null;break}}V=V.parent()}if(T){T[0].appendChild(X.extractContents());a(this,T);X.insertNode(T);T._4e_mergeSiblings();M.ie||T[0].normalize()}X=null}}da._4e_remove();S._4e_remove();E.moveToBookmark(P);E.shrink(H.SHRINK_TEXT)}}function m(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var L=new Q(G.parent()),K,O=0,P;O<L.elements.length&&(P=L.elements[O]);O++){if(P==L.block||P==L.blockLimit)break;if(this.checkElementRemovable(P)){var S=E.checkBoundaryOfElement(P,H.END),da=!S&&E.checkBoundaryOfElement(P,H.START);if(da||S){K=P;K.match=da?"start":"end"}else{P._4e_mergeSiblings();P._4e_name()==this.element?d(this,P):f(P,h(this)[P._4e_name()])}}}if(K&&K[0]){P=G;for(O=0;;O++){S=L.elements[O];if(r._4e_equals(S,K))break;else if(S.match)continue;
else S=S._4e_clone();S[0].appendChild(P[0]);P=S}r[K.match=="start"?"insertBefore":"insertAfter"](P[0],K[0])}}else{var U=F.endNode,X=this;L=function(){for(var T=new Q(G.parent()),V=new Q(U.parent()),ba=null,ca=null,Y=0;Y<T.elements.length;Y++){var Z=T.elements[Y];if(Z==T.block||Z==T.blockLimit)break;if(X.checkElementRemovable(Z))ba=Z}for(Y=0;Y<V.elements.length;Y++){Z=V.elements[Y];if(Z==V.block||Z==V.blockLimit)break;if(X.checkElementRemovable(Z))ca=Z}ca&&U._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
L();for(K=new N(G[0].nextSibling);K[0]!==U[0];){O=K._4e_nextSourceNode();if(K[0]&&K[0].nodeType==C.NODE_ELEMENT&&this.checkElementRemovable(K)){K._4e_name()==this.element?d(this,K):f(K,h(this)[K._4e_name()]);if(O[0].nodeType==C.NODE_ELEMENT&&O._4e_contains(G)){L();O=new N(G[0].nextSibling)}}K=O}}E.moveToBookmark(F)}function v(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,L,K){F[L]=K});return F}function b(E,F){typeof E=="string"&&(E=v(E));typeof F==
"string"&&(F=v(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function c(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function e(E){var F=E._AC;if(F)return F;F={};var G=0,L=E.attributes;if(L)for(var K in L){G++;F[K]=L[K]}if(L=A.getStyleText(E)){F.style||G++;F.style=L}F._length=G;return E._AC=
F}function h(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){z.isArray(G)||(G=[G]);for(var L=0;L<G.length;L++){var K=G[L],O,P;if(typeof K=="string")O=K.toLowerCase();else{O=K.element?K.element.toLowerCase():E.element;P=K.attributes}K=F[O]||(F[O]={});if(P){K=K.attributes=K.attributes||[];for(var S in P)K.push([S.toLowerCase(),P[S]])}}}return F}function d(E,F){var G=E._.definition,L=z.mix(z.mix({},G.attributes),h(E)[F._4e_name()]);G=G.styles;var K=z.isEmptyObject(L)&&
z.isEmptyObject(G);for(var O in L)if(!((O=="class"||E._.definition.fullMatch)&&F.attr(O)!=l(O,L[O]))){K=K||!!F._4e_hasAttribute(O);F.removeAttr(O)}for(var P in G)if(!(E._.definition.fullMatch&&F._4e_style(P)!=l(P,G[P],true))){K=K||!!F._4e_style(P);F._4e_style(P,"")}K&&n(F)}function l(E,F,G){var L=new N("<span></span>");L[G?"_4e_style":"attr"](E,F);return L[G?"_4e_style":"attr"](E)}function a(E,F){for(var G=h(E),L=F.all(E.element),K=L.length;--K>=0;)d(E,new N(L[K]));for(var O in G)if(O!=E.element){L=
F.all(O);for(K=L.length-1;K>=0;K--){var P=new N(L[K]);f(P,G[O])}}}function f(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var L=F[G][0],K;if(K=E.attr(L)){var O=F[G][1];if(O===null||O.test&&O.test(K)||typeof O=="string"&&K==O)E[0].removeAttribute(L)}}n(E)}function n(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==C.NODE_ELEMENT&&r._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==C.NODE_ELEMENT&&r._4e_mergeSiblings(G)}}}var z=KISSY,r=z.DOM,
D=w.STYLE={},H=w.RANGE,y=w.Selection,C=w.NODE,I=w.POSITION,J=w.Range,N=z.Node,M=z.UA,Q=w.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},W={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},$=/\s*(?:;\s*|$)/,aa=/#\((.+?)\)/g;D.STYLE_BLOCK=1;D.STYLE_INLINE=2;D.STYLE_OBJECT=3;A.prototype={apply:function(E){t.call(this,E,false)},remove:function(E){t.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==D.STYLE_INLINE?
q:this.type==D.STYLE_BLOCK?o:this.type==D.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==D.STYLE_INLINE?m:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=e(G);if(G._length){for(var L in G)if(L!="_length"){var K=E.attr(L)||"";if(L=="style"?b(G[L],c(K,false)):G[L]==K){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
h(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){L=G[F][0];if(L=E.attr(L)){K=G[F][1];if(K===null||typeof K=="string"&&L==K||K.test&&K.test(L))return true}}}return false},checkActive:function(E){switch(this.type){case D.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case D.STYLE_OBJECT:case D.STYLE_INLINE:for(var F=E.elements,G=0,L;G<F.length;G++){L=F[G];if(!(this.type==D.STYLE_INLINE&&(r._4e_equals(L,E.block)||r._4e_equals(L,E.blockLimit))))if(!(this.type==
D.STYLE_OBJECT&&!(L._4e_name()in W)))if(this.checkElementRemovable(L,true))return true}}return false}};A.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",L="";if(G.length)G=G.replace($,";");for(var K in F){var O=F[K],P=(K+":"+O).replace($,";");if(O=="inherit")L+=P;else G+=P}if(G.length)G=c(G);G+=L;return E._ST=G};w.Style=A});
KISSY.Editor.add("bubbleview",function(){function w(s){w.superclass.constructor.apply(this,arguments);s.init&&s.init.call(this)}function u(s){s=o[s];if(!s.bubble)s.bubble=new w(s.cfg);return s.bubble}var A=KISSY.Editor,t=KISSY,x=t.Event,B=t.Node,o={};w.attach=function(s){var k=s.pluginInstance,g=s.pluginName;s=k.editor;var i=o[g].cfg.func,j=o[g].bubble;s.on("selectionChange",function(p){p=p.path;var q=p.elements;if(p&&q)if(p=p.lastElement)if(p=i(p)){j=u(g);j._selectedEl=p;j._plugin=k;j.show()}else if(j){j._selectedEl=
j._plugin=null;j.hide()}});x.on(s.document,"scroll",function(){j&&j.hide()});x.on(document,"click",function(){j&&j.hide()})};w.register=function(s){o[s.pluginName]={cfg:s}};w.ATTRS={focusMgr:{value:false}};t.extend(w,A.SimpleOverlay,{_initEl:function(){var s=new B('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>');s.appendTo(document.body);this.el=s;this.set("el",s)},show:function(){var s=this._selectedEl,k=s._4e_getOffset(document);k.top+=s.height()+5;w.superclass.show.call(this,
k)}});A.BubbleView=w});
KISSY.Editor.add("button",function(){function w(x){w.superclass.constructor.call(this,x);this._init()}var u=KISSY.Editor,A=KISSY,t=A.Node;w.ON="on";w.OFF="off";w.DISABLED="disabled";w.ON_CLASS="ke-triplebutton-on";w.OFF_CLASS="ke-triplebutton-off";w.DISABLED_CLASS="ke-triplebutton-disabled";w.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};A.extend(w,A.Base,{_init:function(){var x=this.get("container")[0]||this.get("container");this.el=new t("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");this.el._4e_unselectable();
this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));x.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var x=this.get("cls");x&&this.el.addClass(x)},_stateChange:function(x){this["_"+x.newVal]();
this._attachCls()},_action:function(x){this.fire(this.get("state")+"Click",x);this.fire("click",x);x.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});u.TripleButton=w});
KISSY.Editor.add("contextmenu",function(){function w(g){this.cfg=t.clone(g);A.Utils.lazyRun(this,"_prepareShow","_realShow")}function u(g,i){for(var j=0;j<i.length;j++)if(B.test(g,i[j]))return true;return false}var A=KISSY.Editor,t=KISSY,x=t.Node,B=t.DOM,o=t.Event,s=[];w.register=function(g,i){var j=new w(i);s.push({doc:g,rules:i.rules,instance:j});if(!g.ke_contextmenu){g.ke_contextmenu=1;o.on(g,"mousedown",w.hide);o.on(g,"contextmenu",function(p){w.hide.call(this);for(var q=new x(p.target);q;){var m=
false;if(q._4e_name()=="body")break;for(var v=0;v<s.length;v++){var b=s[v].instance,c=s[v].rules;if(g===s[v].doc&&u(q[0],c)){p.preventDefault();m=true;setTimeout(function(){b.show(A.Utils.getXY(p.pageX,p.pageY,g,document))},30);break}}if(m)break;q=q.parent()}})}return j};w.hide=function(){for(var g=0;g<s.length;g++){var i=s[g].instance;this===s[g].doc&&i.hide()}};var k=A.SimpleOverlay;t.augment(w,{_init:function(){var g=this,i=g.cfg,j=i.funcs;g.elDom=new x("<div class='ke-menu' onmousedown='return false;'></div>");
var p=g.elDom;p.css("width",i.width);document.body.appendChild(p[0]);g.el=new k({el:p});for(var q in j){i=new x("<a href='#'>"+q+"</a>");p[0].appendChild(i[0]);(function(m,v){m._4e_unselectable();m.on("click",function(b){g.hide();b.halt();setTimeout(v,30)})})(i,j[q])}},hide:function(){this.el&&this.el.hide()},_realShow:function(g){this.el.show(g)},_prepareShow:function(){this._init()},show:function(g){this._prepareShow(g)}});A.ContextMenu=w});
KISSY.Editor.add("overlay",function(){function w(){var i=this;w.superclass.constructor.apply(i,arguments);i._init();if(A.UA.ie===6){i.on("show",function(){var j=i.get("el"),p=parseInt(j.css("width"));j=j[0].offsetHeight;g&&g.css({width:p+"px",height:j+"px"});g&&g.offset(i.get("el").offset())});i.on("hide",function(){g&&g.offset({left:-999,top:-999})})}if(i.get("mask")){i.on("show",function(){s&&s.css({left:"0px",top:"0px"});k&&k.css({left:"0px",top:"0px"})});i.on("hide",function(){s&&s.css({left:"-9999px",
top:"-9999px"});k&&k.css({left:"-9999px",top:"-9999px"})})}i.hide()}var u=KISSY.Editor,A=KISSY,t=A.UA,x=u.focusManager,B=A.Node,o=A.DOM,s,k,g;w.init=function(){var i=document.body;s=new B('<div class="ke-mask">&nbsp;</div>');s.css({left:"-9999px",top:"-9999px"});s.css({width:"100%",height:o.docHeight()+"px",opacity:0.4});s.appendTo(i);if(t.ie&&t.ie==6){g=new B("<iframe class='ke-dialog-iframe'></iframe>");g.appendTo(i);k=new B("<iframe class='ke-mask'></iframe>");k.css({left:"-9999px",top:"-9999px"});
k.css({width:"100%",height:o.docHeight()+"px",opacity:0.4});k.appendTo(i)}w.init=null};w.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false}};A.extend(w,A.Base,{_init:function(){var i=this;i._initEl();var j=i.get("el");i.on("afterVisibleChange",function(p){if(p=p.newVal){typeof p=="boolean"?i.center():j.offset(p);i.fire("show")}else{j.css({left:"-9999px",top:"-9999px"});i.fire("hide")}});if(i.get("focusMgr")){i._initFocusNotice();i.on("beforeVisibleChange",
i._editorFocusMg,i)}j.css({left:"-9999px",top:"-9999px"})},_initEl:function(){var i=this,j=i.get("el");if(j)i.el=j;else{j=new B("<div class='ke-dialog' style='width:"+i.get("width")+"'><div class='ke-hd'><span class='ke-hd-title'>"+i.get("title")+"</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>");document.body.appendChild(j[0]);i.set("el",j);i.el=j;i.body=j.one(".ke-bd");i.foot=j.one(".ke-ft");i._close=j.one(".ke-close");
i._title=j.one(".ke-hd-title").one("h1");i._close.on("click",function(p){p.preventDefault();i.hide()})}},center:function(){var i=this.get("el"),j=parseInt(i.css("width")),p=i[0].offsetHeight,q=o.viewportWidth(),m=o.viewportHeight();j=(q-j)/2+o.scrollLeft();p=(m-p)/2+o.scrollTop();if(p-o.scrollTop()>200)p-=150;i.css({left:j+"px",top:p+"px"})},_prepareShow:function(){w.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;this._focusEl=new B("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>");
this._focusEl.appendTo(this.el);return this._focusEl},_initFocusNotice:function(){var i=this,j=i._getFocusEl();j.on("focus",function(){i.fire("focus")});j.on("blur",function(){i.fire("blur")})},_editorFocusMg:function(i){var j=this._focusEditor;if(i.newVal){j=this._focusEditor=x.currentInstance();this._getFocusEl()[0].focus();var p=this.el.one("input");if(p)setTimeout(function(){try{p[0].focus();p[0].select()}catch(q){}},0);else if(t.ie&&j)if(i=j.document.selection.createRange())if(i.item&&i.item(0).ownerDocument==
j.document){j=document.body.createTextRange();j.moveToElementText(this.el._4e_first()[0]);j.collapse(true);j.select()}}else j&&j.focus()},_realShow:function(i){this.get("el");this.set("visible",i||true)},show:function(i){this._prepareShow(i)},hide:function(){this.get("el");this.set("visible",false)}});u.Utils.lazyRun(w.prototype,"_prepareShow","_realShow");u.SimpleOverlay=w});
KISSY.Editor.add("select",function(){function w(o){w.superclass.constructor.call(this,o);this._init()}var u=KISSY,A=u.Node,t=u.Event,x=u.DOM,B=u.Editor;w.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};u.extend(w,u.Base,{_init:function(){var o=this.get("container"),s=new A("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a></span>"),k=this.get("title"),g=s.one(".ke-select-text");s.one(".ke-select-drop");
g.html(k);g.css("width",this.get("width"));s._4e_unselectable();s.attr("title",k);s.appendTo(o);s.on("click",this._click,this);this.el=s;this.title=g;this._focusA=s.one("a.ke-select");B.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(o){o=o.newVal;for(var s=this.get("title"),k=this.get("items"),g=0;g<k.length;g++){var i=k[g];if(i.value==o){s=i.name;break}}this.title.html(s)},_prepare:function(){var o=this.el,s=this._focusA,k=new A("<div class='ke-menu' onmousedown='return false;'></div>"),
g=new B.SimpleOverlay({el:k,focusMgr:false}),i=this.get("items");this.get("title")&&(new A("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+this.get("title")+"</div>")).appendTo(k);for(var j=0;j<i.length;j++){var p=i[j];p=new A("<a class='ke-select-menu-item' href='#' data-value='"+p.value+"'>"+p.name+"</a>",p.attrs);p._4e_unselectable();p.appendTo(k)}this.get("popUpWidth")&&k.css("width",this.get("popUpWidth"));k.appendTo(document.body);this.menu=g;g.on("show",function(){s.addClass("ke-select-active")});
g.on("hide",function(){s.removeClass("ke-select-active")});t.on([document,this.get("doc")],"click",function(m){o._4e_contains(m.target)||g.hide()});k.on("click",this._select,this);var q=this.as=k.all("a");t.on(k[0],"mouseenter",function(){q.removeClass("ke-menu-selected")})},_select:function(o){o.halt();var s=this.menu,k=s.el;if(o=(new A(o.target))._4e_ascendant(function(j){return k._4e_contains(j)&&j._4e_name()=="a"},true)){var g=this.get("value"),i=o.attr("data-value");this.set("value",i);this.fire("click",
{newVal:i,preVal:g,name:o.html()});s.hide()}},_real:function(){var o=this.el.offset();o.top+=this.el.height();o.left+=1;if(o.left+this.menu.el.width()>x.viewportWidth()-60)o.left=x.viewportWidth()-this.menu.el.width()-60;this.menu.show(o)},_click:function(o){o.preventDefault();var s=this.get("value");if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();s&&this.menu&&this.as.each(function(k){k.attr("data-value")==s?k.addClass("ke-menu-selected"):k.removeClass("ke-menu-selected")})}}});
B.Select=w});
KISSY.Editor.add("clipboard",function(w){var u=KISSY.Editor,A=KISSY,t=A.Node,x=A.UA,B=u.Range,o=u.RANGE,s=A.Event;u.Paste||function(){function k(g){this.editor=g;this._init()}A.augment(k,{_init:function(){var g=this.editor;x.ie?s.on(g.document,"keydown",this._paste,this):s.on(g.document,"paste",this._paste,this)},_paste:function(g){if(!(g.type==="keydown"&&!(g.keyCode===86&&(g.ctrlKey||g.metaKey)))){var i=this.editor;g=i.document;var j=i.getSelection(),p=new B(g),q=new t(x.webkit?"<body></body>":"<div></div>",
null,g);x.webkit&&q[0].appendChild(g.createTextNode("\u00a0"));g.body.appendChild(q[0]);q.css({position:"absolute",top:j.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});q.css("left","-1000px");var m=j.createBookmarks();p.setStartAt(q,o.POSITION_AFTER_START);p.setEndAt(q,o.POSITION_BEFORE_END);p.select(true);setTimeout(function(){q._4e_remove();var v;q=x.webkit&&(v=q._4e_first())&&v[0]&&v.hasClass("Apple-style-span")?v:q;j.selectBookmarks(m);i.insertHtml(q.html())},
0)}}});u.Paste=k}();w.addPlugin(function(){new u.Paste(w)})});
KISSY.Editor.add("color",function(w){function u(d){return("0"+d).slice(d.length-1,d.length+1)}function A(d){d=x.trim(d);if(d.charAt(0)=="#")d=d.substring(1);d=d.replace(/\s+/g,"");var l="";if(/^[0-9a-f]{3,3}$/i.test(d))l=d.replace(/[0-9a-f]/ig,function(f){return f+f});else{var a=d.match(i);if(a&&a[0])for(d=1;d<4;d++)l+=u(parseInt(a[d]).toString(16));else l=d}return"#"+l.toLowerCase()}for(var t=KISSY.Editor,x=KISSY,B=x.Node,o=x.Event,s=t.SimpleOverlay,k=t.Style,g=x.DOM,i=/^rgb\((\d+),(\d+),(\d+)\)$/i,
j="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),p={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},q={element:"span",styles:{"background-color":"#(color)"}},m="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
v={},b={},c=0;c<5;c++){m+="<tr>";for(var e=0;e<8;e++){var h=A(j[8*c+e]);m+="<td>";m+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+h+"'></span></a>";m+="</td>";v[h]=new k(q,{color:h});b[h]=new k(p,{color:h})}m+="</tr>"}v.inherit=new k(q,{color:"inherit"});b.inherit=new k(p,{color:"inherit"});m+="</table></div>";t.ColorSupport||function(){function d(a){d.superclass.constructor.call(this,a);this._init()}var l=t.TripleButton;d.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};x.extend(d,x.Base,{_init:function(){var a=this.get("editor").toolBarDiv;a=new l({container:a,title:this.get("title"),contentCls:this.get("contentCls")});a.on("offClick",this._showColors,this);this.el=a;t.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(a){var f=this;g._4e_ascendant(a.target,function(n){return n[0]===f.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(a){a.halt();var f=this.get("editor");a=a.target;if(g._4e_name(a)=="span"||g._4e_name(a)=="a"){a=new B(a);
if(a._4e_name()=="a")a=a.one("span");var n=this.get("styles");f.fire("save");a._4e_style("background-color")?n[A(a._4e_style("background-color"))].apply(f.document):n.inherit.remove(f.document);f.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(m);this.colorWin=new s({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);o.on(document,"click",this._hidePanel,this);o.on(w.document,
"click",this._hidePanel,this)},_real:function(){var a=this.el.el.offset();a.top+=this.el.el.height()+5;if(a.left+this.colorPanel.width()>g.viewportWidth()-60)a.left=g.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(a)},_showColors:function(a){this._prepare(a)}});t.ColorSupport=d}();w.addPlugin(function(){new t.ColorSupport({editor:w,styles:v,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new t.ColorSupport({editor:w,styles:b,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("elementpaths",function(w){var u=KISSY.Editor,A=KISSY,t=A.Node,x=A.DOM;u.ElementPaths||function(){function B(o){this.cfg=o;this._cache=[];this._init()}A.augment(B,{_init:function(){var o=this.cfg.editor;this.holder=new t("<div>");this.holder.appendTo(o.statusDiv);o.on("selectionChange",this._selectionChange,this)},_selectionChange:function(o){var s=this.cfg.editor,k=this.holder;k=k[0]||k;o=o.path.elements;var g,i;g=this._cache;for(i=0;i<g.length;i++){g[i].detach("click");g[i]._4e_remove()}this._cache=
[];for(i=0;i<o.length;i++){g=o[i];var j=new t("<a href='#' class='elementpath'>"+(g.attr("_ke_real_element_type")||g._4e_name())+"</a>");this._cache.push(j);(function(p){j.on("click",function(q){q.halt();s.focus();setTimeout(function(){s.getSelection().selectElement(p)},50)})})(g);k.firstChild?x.insertBefore(j[0],k.firstChild):k.appendChild(j[0])}}});u.ElementPaths=B}();w.addPlugin(function(){new u.ElementPaths({editor:w})})});
KISSY.Editor.add("enterkey",function(w){var u=KISSY.Editor,A=KISSY,t=A.UA,x=/^h[1-6]$/,B=u.XHTML_DTD,o=A.Node,s=A.Event,k=u.Walker,g=u.ElementPath;u.enterBlock||function(){function i(q){q=q.getSelection().getRanges();for(var m=q.length-1;m>0;m--)q[m].deleteContents();return q[0]}function j(q){var m=i(q),v=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var b=(new g(m.startContainer)).block;if(b&&(b._4e_name()=="li"||b.parent()._4e_name()=="li")){q.execCommand("outdent");return}}var c=m.splitBlock("p");
if(c){q=c.previousBlock;b=c.nextBlock;var e=c.wasStartOfBlock,h=c.wasEndOfBlock,d;if(b){d=b.parent();if(d._4e_name()=="li"){b._4e_breakParent(d);b._4e_move(b._4e_next(),true)}}else if(q&&(d=q.parent())&&d._4e_name()=="li"){q._4e_breakParent(d);m.moveToElementEditablePosition(q._4e_next());q._4e_move(q._4e_previous())}if(!e&&!h){if(b._4e_name()=="li"&&(d=b._4e_first(k.invisible(true)))&&A.inArray(d._4e_name(),["ul","ol"]))(t.ie?new o(v.createTextNode("\u00a0")):new o(v.createElement("br"))).insertBefore(d);
b&&m.moveToElementEditablePosition(b)}else{var l;if(q){if(q._4e_name()=="li"||!x.test(q._4e_name()))l=q._4e_clone()}else if(b)l=b._4e_clone();l||(l=new o("p",null,v));if(d=c.elementPath){c=0;for(var a=d.elements.length;c<a;c++){var f=d.elements[c];if(f._4e_equals(d.block)||f._4e_equals(d.blockLimit))break;if(B.$removeEmpty[f._4e_name()]){f=f._4e_clone();l._4e_moveChildren(f);l.append(f)}}}t.ie||l._4e_appendBogus();m.insertNode(l);if(t.ie&&e&&(!h||!q[0].childNodes.length)){m.moveToElementEditablePosition(h?
q:l);m.select()}m.moveToElementEditablePosition(e&&!h?b:l)}if(!t.ie)if(b){v=new o(v.createElement("span"));v.html("&nbsp;");m.insertNode(v);v._4e_scrollIntoView();m.deleteContents()}else l._4e_scrollIntoView();m.select()}}function p(q){s.on(q.document,"keydown",function(m){if(m.keyCode===13)if(!m.shiftKey){q.execCommand("enterBlock");m.preventDefault()}})}p.enterBlock=j;u.EnterKey=p}();w.addPlugin(function(){w.addCommand("enterBlock",{exec:u.EnterKey.enterBlock});u.EnterKey(w)})});
KISSY.Editor.add("fakeobjects",function(w){var u=KISSY.Editor,A=KISSY,t=A.Node,x=u.NODE,B=u.HtmlParser,o=A.Editor,s=(w=w.htmlDataProcessor)&&w.htmlFilter,k={elements:{$:function(g){var i=g.attributes;if((i=(i=(i=i&&i._ke_realelement)&&new B.Fragment.FromHtml(decodeURIComponent(i)))&&i.children[0])&&g.attributes._ke_resizable){var j=g.attributes.style;if(j){var p=/(?:^|\s)width\s*:\s*(\d+)/i.exec(j);g=p&&p[1];j=(p=/(?:^|\s)height\s*:\s*(\d+)/i.exec(j))&&p[1];if(g)i.attributes.width=g;if(j)i.attributes.height=
j}}return i}}};s&&s.addRules(k);w&&A.mix(w,{createFakeParserElement:function(g,i,j,p){var q;q=new B.BasicWriter;g.writeHtml(q);q=q.getHtml();var m=g.attributes.style;if(g.attributes.width)m="width:"+g.attributes.width+"px;"+m;if(g.attributes.height)m="height:"+g.attributes.height+"px;"+m;g={"class":i,src:u.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(q),_ke_real_node_type:g.type,style:m,align:g.attributes.align||""};if(j)g._ke_real_element_type=j;if(p)g._ke_resizable=p;return new B.Element("img",
g)}});A.augment(o,{createFakeElement:function(g,i,j,p,q){var m=g.attr("style")||"";if(g.attr("width"))m="width:"+g.attr("width")+"px;"+m;if(g.attr("height"))m="height:"+g.attr("height")+"px;"+m;g={"class":i,src:u.Config.base+"assets/spacer.gif",_ke_realelement:encodeURIComponent(q||g._4e_outerHtml()),_ke_real_node_type:g[0].nodeType,align:g.attr("align")||"",style:m};if(j)g._ke_real_element_type=j;if(p)g._ke_resizable=p;return new t("<img/>",g,this.document)},restoreRealElement:function(g){if(g.attr("_ke_real_node_type")!=
x.NODE_ELEMENT)return null;g=decodeURIComponent(g.attr("_ke_realelement"));var i=new t("<div>",null,this.document);i.html(g);return i._4e_first(function(j){return j[0].nodeType==x.NODE_ELEMENT})._4e_remove()}})});
KISSY.Editor.add("flash",function(w){var u=KISSY.Editor,A=KISSY,t=A.Event,x=u.ContextMenu,B=A.Node,o=u.BubbleView,s=u.TripleButton,k=u.SimpleOverlay,g=w.htmlDataProcessor,i="ke_flash",j=u.Utils.getFlashUrl,p=g&&g.dataFilter,q=["img."+i];u.Flash||function(){function m(e){this.editor=e;this._init()}function v(e){return e._4e_ascendant(function(h){return h._4e_name()==="img"&&!!h.hasClass(i)},true)}var b=/\.swf(?:$|\?)/i;m.isFlashEmbed=function(e){e=e.attributes;return e.type=="application/x-shockwave-flash"||
b.test(e.src||"")};A.augment(m,{_config:function(){var e=this.editor;e._toolbars=e._toolbars||{};e._toolbars.flash=this;this._cls=i;this._type="flash";this._title="Flash\u5c5e\u6027";this._bodyHtml="<div><p><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' /></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:110px' /></label></p>";
this._footHtml="<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=c;this._flashRules=q},_init:function(){var e=this,h=e.editor,d={};e._config();e.el=new s({container:h.toolBarDiv,contentCls:e._contentCls,title:e._tip});e.el.on("click",e.show,this);for(var l in c)(function(a){d[a]=function(){h.fire("save");e._contextMenu[a](h);h.fire("save")}})(l);x.register(h.document,
{rules:e._flashRules,width:"120px",funcs:d});o.attach({pluginName:e._type,pluginInstance:e});t.on(h.document,"dblclick",e._dbclick,e);u.Utils.lazyRun(this,"_prepareShow","_realShow")},_getFlashUrl:function(e){return j(e)},_updateTip:function(e,h){h=this.editor.restoreRealElement(h);e.html(this._getFlashUrl(h));e.attr("href",this._getFlashUrl(h))},_dbclick:function(e){var h=new B(e.target);if(h._4e_name()==="img"&&h.hasClass(this._cls)){this.selectedFlash=h;this.show();e.halt()}},_prepareShow:function(){var e=
this;e.d=new k({title:e._title,width:"350px",mask:true});e.d.on("hide",function(){e.selectedFlash=null});e.d.body.html(e._bodyHtml);e.d.foot.html(e._footHtml);e._initD()},_realShow:function(){this.d.show()},_updateD:function(){var e=this.editor,h=this.selectedFlash;if(h){e=e.restoreRealElement(h);e.attr("width")&&this.dWidth.val(parseInt(e.attr("width")));e.attr("height")&&this.dHeight.val(parseInt(e.attr("height")));this.dUrl.val(j(e))}else{this.dUrl.val("");this.dWidth.val("");this.dHeight.val("")}},
show:function(){this._prepareShow();this._updateD()},_initD:function(){var e=this,h=e.d;e.dHeight=h.el.one(".ke-flash-height");e.dWidth=h.el.one(".ke-flash-width");e.dUrl=h.el.one(".ke-flash-url");var d=h.el.one(".ke-flash-ok");h=h.el.one(".ke-flash-cancel");d.on("click",e._gen,e);h.on("click",function(){e.d.hide()})},_getDURl:function(){return this.dUrl.val()},_getDWidth:function(){return this.dWidth.val()},_getDHeight:function(){return this.dHeight.val()},_gen:function(){var e=this.editor,h=this._getDURl(),
d=this._getDWidth(),l=this._getDHeight();h="<object "+(d?" width='"+d+"' ":" ")+(l?" height='"+l+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+h+'" /><embed '+(d?" width='"+d+"' ":" ")+(l?" height='"+l+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+h+'"  type="application/x-shockwave-flash"/></object>';
d=new B(h,null,e.document);h=e.createFakeElement?e.createFakeElement(d,this._cls,this._type,true,h):d;e.insertElement(h);this.selectedFlash&&e.getSelection().selectElement(h);this.d.hide()}});u.Flash=m;m.registerBubble=function(e,h,d){o.register({pluginName:e,func:d,init:function(){var l=this,a=l.el;a.html(h+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var f=a.one(".ke-bubbleview-url"),n=a.one(".ke-bubbleview-change");a=a.one(".ke-bubbleview-remove");n._4e_unselectable();f._4e_unselectable();a._4e_unselectable();n.on("click",function(z){l._plugin.selectedFlash=l._selectedEl;l._plugin.show();z.halt()});a.on("click",function(z){var r=l._plugin;l._selectedEl._4e_remove();r.editor.notifySelectionChange();z.halt()});l.on("afterVisibleChange",function(z){var r=l._selectedEl;z.newVal&&r&&l._plugin._updateTip(f,r)})}})};m.registerBubble("flash","Flash \u7f51\u5740\uff1a ",
v);var c={"\u7f16\u8f91Flash":function(e){var h=e.getSelection();h=h&&h.getStartElement();h=v(h);e=e._toolbars.flash;e.selectedFlash=h;e.show()}}}();p&&p.addRules({elements:{object:function(m){var v=m.attributes,b;b=v.classid&&String(v.classid).toLowerCase();v=i;if(!b){for(b=0;b<m.children.length;b++)if(m.children[b].name=="embed"){if(!u.Flash.isFlashEmbed(m.children[b]))return null;return g.createFakeParserElement(m,v,"flash",true)}return null}return g.createFakeParserElement(m,v,"flash",true)},
embed:function(m){if(!u.Flash.isFlashEmbed(m))return null;return g.createFakeParserElement(m,i,"flash",true)}}},5);w.addPlugin(function(){new u.Flash(w)})});
KISSY.Editor.add("font",function(w){var u=KISSY.Editor,A=KISSY,t=u.Style,x=u.TripleButton,B=w.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],o={},s=[],k={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},g=w.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],i={},j=[],p={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},q;w.cfg.pluginConfig["font-size"]=B;w.cfg.pluginConfig["font-family"]=g;for(q=0;q<B.length;q++){var m=B[q];o[m]=new t(k,{size:m});s.push({name:m,value:m})}for(q=0;q<g.length;q++){B=g[q];i[B]=new t(p,{family:B});j.push({name:B,value:B,attrs:{style:"font-family:"+B}})}u.Font||function(){function v(c){v.superclass.constructor.call(this,c);this._init()}function b(c){b.superclass.constructor.call(this,
c);this._init()}v.ATTRS={title:{},html:{},styles:{},editor:{}};A.extend(v,A.Base,{_init:function(){var c=this.get("editor"),e=c.toolBarDiv;this.get("html");this.el=new u.Select({container:e,doc:c.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);c.on("selectionChange",this._selectionChange,this)},_vChange:function(c){var e=this.get("editor"),h=c.newVal;c=c.preVal;var d=this.get("styles");e.focus();
e.fire("save");if(h==c){d[h].remove(e.document);this.el.set("value","")}else d[h].apply(e.document);e.fire("save")},_selectionChange:function(c){this.get("editor");c=c.path.elements;for(var e=this.get("styles"),h=0,d;h<c.length;h++){d=c[h];for(var l in e)if(e[l].checkElementRemovable(d,true)){this.el.set("value",l);return}}this.el.reset("value")}});b.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};A.extend(b,A.Base,{_init:function(){var c=this.get("editor"),e=this.get("text");this.get("style");
var h=this.get("title");this.el=new x({text:e,title:h,contentCls:this.get("contentCls"),container:c.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);c.on("selectionChange",this._selectionChange,this)},_on:function(){var c=this.get("editor");this.get("text");var e=this.get("style");this.get("title");c.fire("save");e.apply(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_off:function(){var c=this.get("editor");this.get("text");var e=this.get("style");
this.get("title");c.fire("save");e.remove(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_selectionChange:function(c){this.get("editor");this.get("text");var e=this.get("style");this.get("title");e.checkActive(c.path)?this.el.set("state",x.ON):this.el.set("state",x.OFF)}});v.SingleFont=b;u.Font=v}();w.addPlugin(function(){new u.Font({editor:w,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:o,html:s});new u.Font({editor:w,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:i,html:j});new u.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:w,style:new t({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new u.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:w,style:new t({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new u.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:w,style:new t({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new u.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:w,style:new t({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(w){var u=KISSY.Editor,A=KISSY,t=[],x={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},B={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},o={},s=u.Style;for(var k in x)if(x[k]){o[x[k]]=new s({element:x[k]});t.push({name:k,value:x[k],attrs:{style:"font-size:"+B[x[k]]}})}u.Format||function(){function g(i){g.superclass.constructor.call(this,
i);this._init()}g.ATTRS={editor:{}};A.extend(g,A.Base,{_init:function(){var i=this.get("editor");this.el=new u.Select({container:i.toolBarDiv,value:"",doc:i.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);i.on("selectionChange",this._selectionChange,this)},_vChange:function(i){var j=this.get("editor"),p=i.newVal;i=i.preVal;j.fire("save");if(p!=i)o[p].apply(j.document);else{o.p.apply(j.document);
this.el.set("value","p")}j.fire("save")},_selectionChange:function(i){this.get("editor");i=i.path;for(var j in o)if(o[j].checkActive(i)){this.el.set("value",j);return}this.el.reset("value")}});u.Format=g}();w.addPlugin(function(){new u.Format({editor:w,html:t,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function w(){this._={output:[]}}var u=KISSY.Editor,A=u.Utils;if(!u.HtmlParser.BasicWriter){KISSY.augment(w,{openTag:function(t){this._.output.push("<",t)},openTagClose:function(t,x){x?this._.output.push(" />"):this._.output.push(">")},attribute:function(t,x){if(typeof x=="string")x=A.htmlEncodeAttr(x);this._.output.push(" ",t,'="',x,'"')},closeTag:function(t){this._.output.push("</",t,">")},text:function(t){this._.output.push(t)},comment:function(t){this._.output.push("<!--",
t,"--\>")},write:function(t){this._.output.push(t)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(t){var x=this._.output.join("");t&&this.reset();return x}});u.HtmlParser.BasicWriter=w}});
KISSY.Editor.add("htmlparser-comment",function(){function w(t){this.value=t;this._={isBlockLike:false}}var u=KISSY.Editor,A=u.NODE;if(!u.HtmlParser.Comment){u.HtmlParser.Comment=w;w.prototype={constructor:w,type:A.NODE_COMMENT,writeHtml:function(t,x){var B=this.value;if(x){if(!(B=x.onComment(B,this)))return;if(typeof B!="string"){B.parent=this.parent;B.writeHtml(t,x);return}}t.comment(B)}}}});
KISSY.Editor.add("htmlparser-element",function(){function w(x,B){this.name=x;this.attributes=B||(B={});this.children=[];var o=B._ke_real_element_type||x;B=u.XHTML_DTD;o=!!(B.$nonBodyContent[o]||B.$block[o]||B.$listItem[o]||B.$tableContent[o]||B.$nonEditable[o]||o=="br");var s=!!B.$empty[x];this.isEmpty=s;this.isUnknown=!B[x];this._={isBlockLike:o,hasInlineStarted:s||!o}}var u=KISSY.Editor;if(!u.HtmlParser.Element){var A=u.NODE,t=function(x,B){x=x[0];B=B[0];return x<B?-1:x>B?1:0};KISSY.augment(w,{type:A.NODE_ELEMENT,
add:u.HtmlParser.Fragment.prototype.add,clone:function(){return new w(this.name,this.attributes)},writeHtml:function(x,B){var o=this.attributes,s=this,k=s.name,g,i,j,p;s.filterChildren=function(){if(!p){var v=new u.HtmlParser.BasicWriter;u.HtmlParser.Fragment.prototype.writeChildrenHtml.call(s,v,B);s.children=(new u.HtmlParser.Fragment.FromHtml(v.getHtml())).children;p=1}};if(B){for(;;){if(!(k=B.onElementName(k)))return;s.name=k;if(!(s=B.onElement(s)))return;s.parent=this.parent;if(s.name==k)break;
if(s.type!=A.NODE_ELEMENT){s.writeHtml(x,B);return}k=s.name;if(!k){this.writeChildrenHtml.call(s,x,p?null:B);return}}o=s.attributes}x.openTag(k,o);for(var q=[],m=0;m<2;m++)for(g in o){i=g;j=o[g];if(m==1)q.push([g,j]);else if(B){for(;;)if(i=B.onAttributeName(g))if(i!=g){delete o[g];g=i}else break;else{delete o[g];break}if(i)if((j=B.onAttribute(s,i,j))===false)delete o[i];else o[i]=j}}x.sortAttributes&&q.sort(t);o=q.length;for(m=0;m<o;m++){g=q[m];x.attribute(g[0],g[1])}x.openTagClose(k,s.isEmpty);if(!s.isEmpty){this.writeChildrenHtml.call(s,
x,p?null:B);x.closeTag(k)}},writeChildrenHtml:function(){u.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});u.HtmlParser.Element=w}});
KISSY.Editor.add("htmlparser-filter",function(){function w(k){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};k&&this.addRules(k,10)}function u(k,g){for(var i=0;k&&i<g.length;i++){var j=g[i];k=k.replace(j[0],j[1])}return k}function A(k,g,i){if(typeof g=="function")g=[g];var j,p;p=k.length;var q=g&&g.length;if(q){for(j=0;j<p&&k[j].pri<i;j++);for(p=q-1;p>=0;p--)if(q=g[p]){q.pri=i;k.splice(j,0,q)}}}function t(k,g,i){if(g)for(var j in g){var p=k[j];k[j]=x(p,g[j],
i);p||k.$length++}}function x(k,g,i){if(g){g.pri=i;if(k){if(k.splice)A(k,g,i);else{k=k.pri>i?[g,k]:[k,g];k.filter=B}return k}else return g.filter=g}}function B(k){for(var g=k.type||k instanceof o.HtmlParser.Fragment,i=0;i<this.length;i++){if(g)var j=k.type,p=k.name;var q=this[i].apply(window,arguments);if(q===false)return q;if(g){if(q&&(q.name!=p||q.type!=j))return q}else if(typeof q!="string")return q;q!=undefined&&(k=q)}return k}var o=KISSY.Editor,s=o.NODE;if(!o.HtmlParser.Filter){KISSY.augment(w,
{addRules:function(k,g){if(typeof g!="number")g=10;A(this._.elementNames,k.elementNames,g);A(this._.attributeNames,k.attributeNames,g);t(this._.elements,k.elements,g);t(this._.attributes,k.attributes,g);this._.text=x(this._.text,k.text,g)||this._.text;this._.comment=x(this._.comment,k.comment,g)||this._.comment;this._.root=x(this._.root,k.root,g)||this._.root},onElementName:function(k){return u(k,this._.elementNames)},onAttributeName:function(k){return u(k,this._.attributeNames)},onText:function(k){var g=
this._.text;return g?g.filter(k):k},onComment:function(k,g){var i=this._.comment;return i?i.filter(k,g):k},onFragment:function(k){var g=this._.root;return g?g.filter(k):k},onElement:function(k){for(var g=[this._.elements["^"],this._.elements[k.name],this._.elements.$],i,j=0;j<3;j++)if(i=g[j]){i=i.filter(k,this);if(i===false)return null;if(i&&i!=k)return this.onNode(i);if(k.parent&&!k.name)break}return k},onNode:function(k){var g=k.type;return g==s.NODE_ELEMENT?this.onElement(k):g==s.NODE_TEXT?new o.HtmlParser.Text(this.onText(k.value)):
null},onAttribute:function(k,g,i){if(g=this._.attributes[g]){k=g.filter(i,k,this);if(k===false)return false;if(typeof k!="undefined")return k}return i}});o.HtmlParser.Filter=w}});
KISSY.Editor.add("htmlparser-fragment",function(){function w(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var u=KISSY.Editor;if(!u.HtmlParser.Fragment){var A={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},t=KISSY,x=u.Utils,B=u.NODE,o=u.XHTML_DTD,s=x.mix({table:1,ul:1,ol:1,dl:1},o.table,o.ul,o.ol,o.dl),k=o.$list,g=o.$listItem;w.FromHtml=function(i,j){function p(f){var n;if(c.length>0)for(var z=0;z<c.length;z++){var r=c[z],D=r.name,H=
o[D],y=h.name&&o[h.name];if((!y||y[D])&&(!f||!H||H[f]||!o[f])){if(!n){q();n=1}r=r.clone();r.parent=h;h=r;c.splice(z,1);z--}}}function q(){for(;e.length;)h.add(e.shift())}function m(f,n,z){n=n||h||b;if(j&&!n.type){var r,D;if((r=f.attributes&&(D=f.attributes._ke_real_element_type)?D:f.name)&&!(r in o.$body)&&!(r in o.$nonBodyContent)){r=h;h=n;v.onTagOpen(j,{});n=h;if(z)h=r}}if(f._.isBlockLike&&f.name!="pre"){z=f.children.length;if((r=f.children[z-1])&&r.type==B.NODE_TEXT)if(D=x.rtrim(r.value))r.value=
D;else f.children.length=z-1}n.add(f);if(f.returnPoint){h=f.returnPoint;delete f.returnPoint}}var v=new u.HtmlParser,b=new w,c=[],e=[],h=b,d=false,l;v.onTagOpen=function(f,n,z){var r=new u.HtmlParser.Element(f,n);if(r.isUnknown&&z)r.isEmpty=true;if(o.$removeEmpty[f])c.push(r);else{if(f=="pre")d=true;else if(f=="br"&&d){h.add(new u.HtmlParser.Text("\n"));return}if(f=="br")e.push(r);else{var D=h.name,H=D&&(o[D]||(h._.isBlockLike?o.div:o.span));if(H&&!r.isUnknown&&!h.isUnknown&&!H[f]){H=false;var y;
if(f in k&&D in k){D=h.children;(D=D[D.length-1])&&D.name in g||m(D=new u.HtmlParser.Element("li"),h);l=h;y=D}else if(f==D)m(h,h.parent);else{if(s[D])l||(l=h);else{m(h,h.parent,true);A[D]||c.unshift(h)}H=true}h=y?y:h.returnPoint||h.parent;if(H){v.onTagOpen.apply(this,arguments);return}}p(f);q();r.parent=h;r.returnPoint=l;l=0;if(r.isEmpty)m(r);else h=r}}};v.onTagClose=function(f){for(var n=c.length-1;n>=0;n--)if(f==c[n].name){c.splice(n,1);return}for(var z=[],r=[],D=h;D.type&&D.name!=f;){D._.isBlockLike||
r.unshift(D);z.push(D);D=D.parent}if(D.type){for(n=0;n<z.length;n++){var H=z[n];m(H,H.parent)}h=D;if(h.name=="pre")d=false;D._.isBlockLike&&q();m(D,D.parent);if(D==h)h=h.parent;c=c.concat(r)}if(f=="body")j=false};v.onText=function(f){if(!h._.hasInlineStarted&&!d){f=x.ltrim(f);if(f.length===0)return}q();p();if(j&&(!h.type||h.name=="body")&&x.trim(f))this.onTagOpen(j,{});d||(f=f.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));h.add(new u.HtmlParser.Text(f))};v.onCDATA=function(){};v.onComment=function(f){h.add(new u.HtmlParser.Comment(f))};
v.parse(i);for(q();h.type;){i=h.parent;var a=h;if(j&&(!i.type||i.name=="body")&&!o.$body[a.name]){h=i;v.onTagOpen(j,{});i=h}i.add(a);h=i}return b};t.augment(w,{add:function(i){var j=this.children.length;if(j=j>0&&this.children[j-1]||null){if(i._.isBlockLike&&j.type==B.NODE_TEXT){j.value=x.rtrim(j.value);if(j.value.length===0){this.children.pop();this.add(i);return}}j.next=i}i.previous=j;i.parent=this;this.children.push(i);this._.hasInlineStarted=i.type==B.NODE_TEXT||i.type==B.NODE_ELEMENT&&!i._.isBlockLike},
writeHtml:function(i,j){var p;this.filterChildren=function(){var q=new u.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,q,j,true);q=q.getHtml();this.children=(new w.FromHtml(q)).children;p=1};!this.name&&j&&j.onFragment(this);this.writeChildrenHtml(i,p?null:j)},writeChildrenHtml:function(i,j){for(var p=0;p<this.children.length;p++)this.children[p].writeHtml(i,j)}});u.HtmlParser.Fragment=w}});
KISSY.Editor.add("htmlparser",function(){function w(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var u=KISSY.Editor;if(!u.HtmlParser){var A=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,t={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},x=u.XHTML_DTD;KISSY.augment(w,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var o,s,k=0,g;o=this._.htmlPartsRegex.exec(B);){s=o.index;if(s>k){k=B.substring(k,s);g?g.push(k):this.onText(k)}k=this._.htmlPartsRegex.lastIndex;if(s=o[1]){s=s.toLowerCase();if(g&&x.$cdata[s]){this.onCDATA(g.join(""));g=null}if(!g){this.onTagClose(s);continue}}if(g)g.push(o[0]);else if(s=o[3]){s=s.toLowerCase();var i={},j;o=o[4];var p=!!(o&&o.charAt(o.length-1)=="/");if(o)for(;j=A.exec(o);){var q=
j[1].toLowerCase();j=j[2]||j[3]||j[4]||"";i[q]=!j&&t[q]?q:j}this.onTagOpen(s,i,p);if(!g&&x.$cdata[s])g=[]}else if(s=o[2])this.onComment(s)}B.length>k&&this.onText(B.substring(k,B.length))}});u.HtmlParser=w}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function w(){w.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var t=u.XHTML_DTD;for(var x in A.mix({},t.$nonBodyContent,t.$block,t.$listItem,t.$tableContent))this.setRules(x,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!t[x]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var u=KISSY.Editor,A=u.Utils;if(!u.HtmlParser.HtmlWriter){KISSY.extend(w,u.HtmlParser.BasicWriter,{openTag:function(t){var x=this._.rules[t];if(this._.indent)this.indentation();else if(x&&x.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",t)},openTagClose:function(t,x){t=this._.rules[t];
if(x)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(t&&t.indent)this._.indentation+=this.indentationChars}t&&t.breakAfterOpen&&this.lineBreak()},attribute:function(t,x){if(typeof x=="string"){this.forceSimpleAmpersand&&(x=x.replace(/&amp;/g,"&"));x=A.htmlEncodeAttr(x)}this._.output.push(" ",t,'="',x,'"')},closeTag:function(t){var x=this._.rules[t];if(x&&x.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(x&&x.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",t,">");x&&x.breakAfterClose&&this.lineBreak()},text:function(t){if(this._.indent){this.indentation();t=A.ltrim(t)}this._.output.push(t)},comment:function(t){this._.indent&&this.indentation();this._.output.push("<!--",t,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(t,x){var B=this._.rules[t];if(B)A.mix(B,x);else this._.rules[t]=x}});u.HtmlParser.HtmlWriter=w}});KISSY.Editor.add("htmlparser-text",function(){function w(A){this.value=A;this._={isBlockLike:false}}var u=KISSY.Editor;if(!u.HtmlParser.Text){KISSY.augment(w,{type:u.NODE.NODE_TEXT,writeHtml:function(A,t){var x=this.value;t&&!(x=t.onText(x,this))||A.text(x)}});u.HtmlParser.Text=w}});
KISSY.Editor.add("htmldataprocessor",function(w){function u(d){if(/mso-list\s*:\s*Ignore/i.test(d.attributes&&d.attributes.style))return true;return o}function A(d,l){var a=new s.HtmlParser.Element("ke:listbullet"),f;if(d)if(d[2]){d=isNaN(d[1])?/^[a-z]+$/.test(d[1])?"lower-alpha":/^[A-Z]+$/.test(d[1])?"upper-alpha":"decimal":"decimal";f="ol"}else{d=/[l\u00B7\u2002]/.test(d[1])?"disc":/[\u006F\u00D8]/.test(d[1])?"circle":/[\u006E\u25C6]/.test(d[1])?"square":"disc";f="ul"}else{d="decimal";f="ol"}a.attributes=
{"ke:listtype":f,style:"list-style-type:"+d+";"};a.add(new s.HtmlParser.Text(l));return a}function t(d){var l=d.attributes,a;if((a=d.removeAnyChildWithName("ke:listbullet"))&&a.length&&(a=a[0])){d.name="ke:li";if(l.style)l.style=x([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(f){f=f.split(" ");f=f[3]||f[1]||f[0];f=parseInt(f,10);if(!v&&b&&f>b)v=f-b;l["ke:margin"]=b=f}]],o)(l.style,d)||"";a=a.attributes;d.addStyle(a.style);k.mix(l,a);return true}return false}function x(d,l){return function(a,
f){var n=[];a.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(z,r,D){r=r.toLowerCase();r=="font-family"&&(D=D.replace(/["']/g,""));for(var H,y,C,I=0;I<d.length;I++)if(d[I]){z=d[I][0];H=d[I][1];y=d[I][2];C=d[I][3];if(r.match(z)&&(!H||D.match(H))){r=C||r;l&&(y=y||D);if(typeof y=="function")y=y(D,f,r);if(y&&y.push){r=y[0];y=y[1]}typeof y=="string"&&n.push([r,y]);return}}!l&&n.push([r,D])});for(a=0;a<n.length;a++)n[a]=n[a].join(":");return n.length?n.join(";")+";":false}}
function B(d){d=d.children;for(var l,a,f,n,z,r,D,H=0;H<d.length;H++){l=d[H];if("ke:li"==l.name){l.name="li";a=l.attributes;f=l.attributes["ke:listtype"];n=parseInt(a["ke:indent"],10)||v&&Math.ceil(a["ke:margin"]/v)||1;a.style&&(a.style=x([["list-style-type",f=="ol"?"decimal":"disc"]],o)(a.style)||"");if(r){if(n>D){r=new s.HtmlParser.Element(f);r.add(l);z.add(r)}else{if(n<D){z=D-n;for(var y;z--&&(y=r.parent);)r=y.parent}r.add(l)}d.splice(H--,1)}else{r=new s.HtmlParser.Element(f);r.add(l);d[H]=r}z=
l;D=n}else r=null}v=0}var o=o,s=KISSY.Editor,k=KISSY,g=k.UA,i=s.HtmlParser,j=new i.Filter,p=new i.Filter,q=s.XHTML_DTD;if(!w.htmlDataProcessor){(function(){var d=s.HtmlParser.Fragment.prototype,l=s.HtmlParser.Element.prototype;d.onlyChild=l.onlyChild=function(){var a=this.children;return a.length==1&&a[0]||null};l.removeAnyChildWithName=function(a){for(var f=this.children,n=[],z,r=0;r<f.length;r++){z=f[r];if(z.name){if(z.name==a){n.push(z);f.splice(r--,1)}n=n.concat(z.removeAnyChildWithName(a))}}return n};
l.getAncestor=function(a){for(var f=this.parent;f&&!(f.name&&f.name.match(a));)f=f.parent;return f};d.firstChild=l.firstChild=function(a){for(var f,n=0;n<this.children.length;n++){f=this.children[n];if(a(f))return f;else if(f.name)if(f=f.firstChild(a))return f}return null};l.addStyle=function(a,f,n){var z="";if(typeof f=="string")z+=a+":"+f+";";else{if(typeof a=="object")for(var r in a){if(a.hasOwnProperty(r))z+=r+":"+a[r]+";"}else z+=a;n=f}if(!this.attributes)this.attributes={};a=this.attributes.style||
"";a=(n?[z,a]:[a,z]).join(";");this.attributes.style=a.replace(/^;|;(?=;)/,"")};q.parentOf=function(a){var f={};for(var n in this)if(n.indexOf("$")==-1&&this[n][a])f[n]=1;return f}})();var m=x([[/mso/i],[/font-size/i,"",function(d){for(var l=w.cfg.pluginConfig["font-size"],a=0;a<l.length;a++)if(d.toLowerCase()==l[a])return d;return false},"font-size"],[/font-family/i,"",function(d){for(var l=w.cfg.pluginConfig["font-family"],a=0;a<l.length;a++)if(d.toLowerCase()==l[a].toLowerCase())return d;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],o),v,b=0,c=q.parentOf("ol"),e={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(d){d.filterChildren();B(d)},elements:{font:function(d){delete d.name},p:function(d){d.filterChildren();if(t(d))return o},$:function(d){var l=d.name||"";l.indexOf(":")!=-1&&l.indexOf("ke")==-1&&delete d.name;var a=d.attributes.style;if(l=="span"&&(!a||!m(a)))delete d.name;
if(l in c){d.filterChildren();B(d)}},table:function(d){var l=d.attributes.border;if(!l||l=="0")d.attributes["class"]="ke_show_border"},span:function(d){if(!g.gecko&&u(d.parent))return false;if(!g.gecko&&u(d)){d=(d=d.firstChild(function(a){return a.value||a.name=="img"}))&&(d.value||"l.");var l=d.match(/^([^\s]+?)([.)]?)$/);return A(l,d)}}},comment:!g.ie?function(d,l){var a=d.match(/<img.*?>/);if(d=d.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){a=(l=d[1]||a&&"l.")&&l.match(/>([^\s]+?)([.)]?)</);
return A(a,l)}if(g.gecko&&a){a=s.HtmlParser.Fragment.FromHtml(a[0]).children[0];(l=(l=(l=l.previous)&&l.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&l[1])&&(a.attributes.src=l);return a}return false}:function(){return false},attributes:{"class":function(d){if(/^ke_/.test(d))return d;return false},style:function(d){d=m(d);if(!d)return false;return d}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},h={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(d){var l=d.parent;
if(l&&l.name=="object"){var a=l.attributes.width;l=l.attributes.height;a&&(d.attributes.width=a);l&&(d.attributes.height=l)}},param:function(d){d.children=[];d.isEmpty=true;return d},a:function(d){if(!(d.children.length||d.attributes.name))return false},span:function(d){if(!d.children.length)return false}},attributes:{style:function(d){if(!k.trim(d))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(g.ie)h.attributes.style=function(d){return d.toLowerCase()};j.addRules(h);p.addRules(e);
w.htmlDataProcessor={htmlFilter:j,dataFilter:p,toHtml:function(d,l){var a=new i.HtmlWriter;i.Fragment.FromHtml(d,l).writeHtml(a,j);return a.getHtml(true)},toDataFormat:function(d,l){if(g.gecko)d=d.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var a=new i.BasicWriter;d=i.Fragment.FromHtml(d,l);a.reset();d.writeHtml(a,p);return a.getHtml(true)}}}});
KISSY.Editor.add("image",function(w){var u=KISSY.Editor,A=KISSY,t=A.Node,x=A.DOM,B=A.Event,o=u.SimpleOverlay;u.ImageInserter||function(){function s(g){s.superclass.constructor.call(this,g);this._init()}var k=u.TripleButton;s.ATTRS={editor:{}};A.extend(s,A.Base,{_init:function(){var g=this.get("editor").toolBarDiv;this.el=new k({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",container:g});this.el.on("offClick",this.show,this);u.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){var g=
this,i=g.get("editor");g.d=new o({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var j=g.d;j.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></p></div>");j.foot.html("<button class='ke-img-insert'>\u63d2\u5165</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");g.content=j.el;j=g.content;var p=j.one(".ke-img-cancel"),q=j.one(".ke-img-insert");
g.imgUrl=j.one(".ke-img-url");p.on("click",function(m){g.d.hide();m.halt()});B.on(document,"click",g.hide,g);B.on(i.document,"click",g.hide,g);q.on("click",function(){g._insert()})},hide:function(g){var i=this;x._4e_ascendant(g.target,function(j){return j[0]===i.content[0]||j[0]===i.el.el[0]},true)||this.d.hide()},_real:function(){this.d.show()},_insert:function(){var g=this.get("editor"),i=this.imgUrl.val();if(i){i=new t("<img src='"+i+"' alt='' />",null,g.document);g.insertElement(i,function(j){j.on("load",
function(){j.detach();j.css({width:j.width()+"px",height:j.height()+"px"})})});this.d.hide()}},show:function(){this._prepare()}});u.ImageInserter=s}();w.addPlugin(function(){new u.ImageInserter({editor:w})})});
KISSY.Editor.add("indent",function(w){var u=KISSY.Editor,A={ol:1,ul:1},t=KISSY,x=u.Walker,B=t.DOM,o=t.Node,s=t.UA,k=u.NODE;u.Indent||function(){function g(e){this.type=e;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function i(e){return e.type=CKEDITOR.NODE_ELEMENT&&e.is("li")}function j(e,h,d){var l=h.startContainer;for(e=h.endContainer;l&&l.parent()[0]!==d[0];)l=l.parent();for(;e&&e.parent()[0]!==d[0];)e=e.parent();if(l&&e){var a=l;l=[];for(var f=false;!f;){if(a[0]===
e[0])f=true;l.push(a);a=a.next()}if(!(l.length<1)){a=d._4e_parents(true);for(e=0;e<a.length;e++)if(A[a[e]._4e_name()]){d=a[e];break}a=this.type=="indent"?1:-1;e=l[0];f=l[l.length-1];l={};var n=u.ListUtils.listToArray(d,l),z=n[f._4e_getData("listarray_index")].indent;for(e=e._4e_getData("listarray_index");e<=f._4e_getData("listarray_index");e++){n[e].indent+=a;var r=n[e].parent;n[e].parent=new o(r[0].ownerDocument.createElement(r._4e_name()))}for(e=f._4e_getData("listarray_index")+1;e<n.length&&n[e].indent>
z;e++)n[e].indent+=a;f=u.ListUtils.arrayToList(n,l,null,"p",0);a=[];if(this.type=="outdent"){var D;if((D=d.parent())&&D._4e_name()=="li"){n=f.listNode.childNodes;var H;for(e=n.length-1;e>=0;e--)if((H=new o(n[e]))&&H._4e_name()=="li")a.push(H)}}if(f){B.insertBefore(f.listNode,d[0]);d._4e_remove()}if(a&&a.length)for(e=0;e<a.length;e++){for(H=d=a[e];(H=H.next())&&H._4e_name()in A;){s.ie&&!d._4e_first(function(y){return v(y)&&b(y)})&&d[0].appendChild(h.document.createTextNode("\u00a0"));d[0].appendChild(H[0])}B.insertAfter(d[0],
D[0])}for(e in l)l[e]._4e_clearMarkers(l,true)}}}function p(e,h){h=h.createIterator();h.enforceRealBlocks=true;h.enlargeBr=true;for(var d;d=h.getNextParagraph();)q.call(this,e,d)}function q(e,h){e=parseInt(h._4e_style(this.indentCssProperty),10);if(isNaN(e))e=0;e+=(this.type=="indent"?1:-1)*this.indentOffset;if(e<0)return false;e=Math.max(e,0);e=Math.ceil(e/this.indentOffset)*this.indentOffset;h.css(this.indentCssProperty,e?e+this.indentUnit:"");h[0].style.cssText===""&&h[0].removeAttribute("style");
return true}function m(e){m.superclass.constructor.call(this,e);e=this.get("editor").toolBarDiv;this.el=new c({container:e,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new g(this.get("type"));this._init()}var v=x.whitespaces(true),b=x.bookmark(false,true);t.augment(g,{exec:function(e){for(var h=e.getSelection(),d=h&&h.getRanges()[0],l=d.startContainer,a=d.endContainer,f=d.getCommonAncestor();f&&!(f[0].nodeType==k.NODE_ELEMENT&&A[f._4e_name()]);)f=f.parent();if(f&&
l[0].nodeType==k.NODE_ELEMENT&&l._4e_name()in A){l=new x(d);l.evaluator=i;d.startContainer=l.next()}if(f&&a[0].nodeType==k.NODE_ELEMENT&&a._4e_name()in A){l=new x(d);l.evaluator=i;d.endContainer=l.previous()}a=h.createBookmarks(true);if(f){for(l=f._4e_first();l&&l[0]&&l._4e_name()!="li";)l=l.next();var n=d.startContainer;(l[0]==n[0]||l._4e_contains(n))&&q.call(this,e,f)||j.call(this,e,d,f)}else p.call(this,e,d);h.selectBookmarks(a)}});var c=u.TripleButton;m.ATTRS={type:{},contentCls:{},editor:{}};
t.extend(m,t.Base,{_init:function(){var e=this.get("editor"),h=this.el;h.on("offClick",this.exec,this);this.get("type")=="outdent"?e.on("selectionChange",this._selectionChange,this):h.set("state",c.OFF)},exec:function(){var e=this.get("editor"),h=this;e.fire("save");setTimeout(function(){h.indentCommand.exec(e);e.fire("save");e.notifySelectionChange()},10)},_selectionChange:function(e){this.get("editor");this.get("type");var h=e.path,d=h.blockLimit;e=this.el;if(h.contains(A))e.set("state",c.OFF);
else(h=h.block||d)&&h._4e_style(this.indentCommand.indentCssProperty)?e.set("state",c.OFF):e.set("state",c.DISABLED)}});u.Indent=m}();w.addPlugin(function(){w.addCommand("outdent",new u.Indent({editor:w,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));w.addCommand("indent",new u.Indent({editor:w,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(w){var u=KISSY.Editor,A=KISSY,t=u.TripleButton;u.Justify||function(){function x(o,s,k,g){this.editor=o;this.v=s;this.contentCls=g;this.title=k;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;A.augment(x,{_init:function(){var o=this.editor;this.el=new t({contentCls:this.contentCls,title:this.title,container:o.toolBarDiv});o.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var o=this.editor,s=o.getSelection(),
k=this.el.get("state");if(s){var g=s.createBookmarks(),i=s.getRanges(),j,p;o.fire("save");for(var q=i.length-1;q>=0;q--){j=i[q].createIterator();for(j.enlargeBr=true;p=j.getNextParagraph();){p.removeAttr("align");k==t.OFF?p.css("text-align",this.v):p.css("text-align","")}}o.notifySelectionChange();s.selectBookmarks(g);o.fire("save")}},_selectionChange:function(o){var s=this.el;o=o.path;if(o=o.block||o.blockLimit){o=o.css("text-align").replace(B,"");o==this.v||!o&&this.v=="left"?s.set("state",t.ON):
s.set("state",t.OFF)}}});u.Justify=x}();w.addPlugin(function(){new u.Justify(w,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new u.Justify(w,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new u.Justify(w,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(w){var u=KISSY.Editor;u.Link||function(){function A(p){this.editor=p;this._init()}function t(p){return p._4e_ascendant(function(q){return q._4e_name()==="a"&&!!q.attr("href")},true)}var x=KISSY,B=u.TripleButton,o=u.Style,s=x.Node,k=u.Range,g=u.SimpleOverlay,i=u.BubbleView,j={element:"a",attributes:{href:"#(href)",target:"#(target)"}};A.init=function(){var p=new g({title:"\u4fee\u6539\u94fe\u63a5",mask:true,width:"300px"});this.dialog=p;p.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input class='ke-link-url' style='width:230px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
p.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");p.urlEl=p.body.one(".ke-link-url");p.targetEl=p.body.one(".ke-link-blank");var q=p.foot.one(".ke-link-cancel");p.foot.one(".ke-link-ok").on("click",function(m){p.link._link();m.halt()},this);q.on("click",function(m){p.hide();m.halt()},this);A.init=null};i.register({pluginName:"link",func:t,init:function(){var p=this,q=p.el;q.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var m=q.one(".ke-bubbleview-url"),v=q.one(".ke-bubbleview-change");q=q.one(".ke-bubbleview-remove");v._4e_unselectable();m._4e_unselectable();q._4e_unselectable();v.on("click",function(b){p._plugin.show();b.halt()});q.on("click",function(b){p._plugin._removeLink(p._selectedEl);b.halt()});p.on("afterVisibleChange",function(){var b=p._selectedEl;if(b){m.html(b.attr("href"));m.attr("href",b.attr("href"))}})}});x.augment(A,{_init:function(){this.el=new B({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-link",
title:"\u7f16\u8f91\u8d85\u94fe\u63a5 "});this.el.on("click",this.show,this);i.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(p){var q=this.editor,m={href:p.attr("href")};if(p._4e_hasAttribute("target"))m.target=p.attr("target");p=new o(j,m);q.fire("save");p.remove(q.document);q.fire("save");q.notifySelectionChange()},_getSelectedLink:function(){var p=this.editor.getSelection();if(p=p&&p.getStartElement())p=t(p);return p},_link:function(){var p,q=this.editor,m=A.dialog,v=m.urlEl.val(),
b;if(x.trim(v)){m.hide();if(b=this._getSelectedLink()){p=new k(q.document);p.selectNodeContents(b);q.getSelection().selectRanges([p]);this._removeLink(b)}b={href:v};b.target=m.targetEl[0].checked?"_blank":"_self";p=q.getSelection().getRanges()[0];if(p.collapsed){p=new s("<a href='"+v+"' target='"+b.target+"'>"+v+"</a>",null,q.document);q.insertElement(p)}else{q.fire("save");p=new o(j,b);p.apply(q.document);q.fire("save")}q.notifySelectionChange()}},_prepare:function(){A.init&&A.init()},_real:function(){var p=
A.dialog,q=this._getSelectedLink();p.link=this;if(q){p.urlEl.val(q.attr("href"));p.targetEl[0].checked=q.attr("target")=="_blank"}p.show()},show:function(){this._prepare()}});u.Utils.lazyRun(A.prototype,"_prepare","_real");u.Link=A}();w.addPlugin(function(){new u.Link(w)})});
KISSY.Editor.add("list",function(w){var u=KISSY.Editor,A={ol:1,ul:1},t=["ol","ul"],x=KISSY,B=u.RANGE,o=u.ElementPath,s=u.Walker,k=u.NODE,g=x.UA,i=x.Node,j=x.DOM;u.List||function(){function p(c){this.type=c}function q(c){q.superclass.constructor.call(this,c);c=this.get("editor").toolBarDiv;this.el=new b({contentCls:this.get("contentCls"),title:this.get("title"),container:c});this.listCommand=new p(this.get("type"));this.listCommand.state=this.get("status");this._init()}var m={listToArray:function(c,
e,h,d,l){if(!A[c._4e_name()])return[];d||(d=0);h||(h=[]);for(var a=0,f=c[0].childNodes.length;a<f;a++){var n=new i(c[0].childNodes[a]);if(n._4e_name()=="li"){var z={parent:c,indent:d,element:n,contents:[]};if(l)z.grandparent=l;else{z.grandparent=c.parent();if(z.grandparent&&z.grandparent._4e_name()=="li")z.grandparent=z.grandparent.parent()}e&&n._4e_setMarker(e,"listarray_index",h.length);h.push(z);for(var r=0,D=n[0].childNodes.length,H;r<D;r++){H=new i(n[0].childNodes[r]);H[0].nodeType==k.NODE_ELEMENT&&
A[H._4e_name()]?m.listToArray(H,e,h,d+1,z.grandparent):z.contents.push(H)}}}return h},arrayToList:function(c,e,h,d){h||(h=0);if(!c||c.length<h+1)return null;for(var l=c[h].parent[0].ownerDocument,a=l.createDocumentFragment(),f=null,n=h,z=Math.max(c[h].indent,0),r=null;;){var D=c[n];if(D.indent==z){if(!f||c[n].parent._4e_name()!=f._4e_name()){f=c[n].parent._4e_clone(false,true);a.appendChild(f[0])}r=f[0].appendChild(D.element._4e_clone(false,true)[0]);for(var H=0;H<D.contents.length;H++)r.appendChild(D.contents[H]._4e_clone(true,
true)[0]);n++}else if(D.indent==Math.max(z,0)+1){n=m.arrayToList(c,null,n,d);r.appendChild(n.listNode);n=n.nextIndex}else if(D.indent==-1&&!h&&D.grandparent){r=A[D.grandparent._4e_name()]?D.element._4e_clone(false,true)[0]:D.grandparent._4e_name()!="td"?l.createElement(d):l.createDocumentFragment();for(H=0;H<D.contents.length;H++)r.appendChild(D.contents[H]._4e_clone(true,true)[0]);if(r.nodeType==k.NODE_DOCUMENT_FRAGMENT&&n!=c.length-1){r.lastChild&&r.lastChild.nodeType==k.NODE_ELEMENT&&r.lastChild.getAttribute("type")==
"_moz"&&j._4e_remove(r.lastChild);j._4e_appendBogus(r)}if(r.nodeType==k.NODE_ELEMENT&&j._4e_name(r)==d&&r.firstChild){j._4e_trim(r);f=r.firstChild;if(f.nodeType==k.NODE_ELEMENT&&j._4e_isBlockBoundary(f)){f=l.createDocumentFragment();j._4e_moveChildren(r,f);r=f}}f=j._4e_name(r);if(!g.ie&&(f=="div"||f=="p"))j._4e_appendBogus(r);a.appendChild(r);f=null;n++}else return null;if(c.length<=n||Math.max(c[n].indent,0)<z)break}if(e)for(c=new i(a.firstChild);c&&c[0];){c[0].nodeType==k.NODE_ELEMENT&&c._4e_clearMarkers(e,
true);c=c._4e_nextSourceNode()}return{listNode:a,nextIndex:n}}},v=/^h[1-6]$/;p.prototype={changeListType:function(c,e,h,d){var l=m.listToArray(e.root,h),a=[];for(c=0;c<e.contents.length;c++){var f=e.contents[c];f=f._4e_ascendant("li",true);if(!(!f||!f[0]||f._4e_getData("list_item_processed"))){a.push(f);f._4e_setMarker(h,"list_item_processed",true)}}f=new i(e.root[0].ownerDocument.createElement(this.type));for(c=0;c<a.length;c++){var n=a[c]._4e_getData("listarray_index");l[n].parent=f}h=m.arrayToList(l,
h,null,"p");var z;l=h.listNode.childNodes.length;for(c=0;c<l&&(z=new i(h.listNode.childNodes[c]));c++)z._4e_name()==this.type&&d.push(z);j.insertBefore(h.listNode,e.root[0]);e.root._4e_remove()},createList:function(c,e,h){var d=e.contents;c=e.root[0].ownerDocument;var l=[];if(d.length==1&&d[0][0]===e.root[0]){var a=new i(c.createElement("div"));d[0][0].nodeType!=k.NODE_TEXT&&d[0]._4e_moveChildren(a);d[0][0].appendChild(a[0]);d[0]=a}e=e.contents[0].parent();for(a=0;a<d.length;a++)e=e._4e_commonAncestor(d[a].parent());
for(a=0;a<d.length;a++)for(var f=d[a],n;n=f.parent();){if(n[0]===e[0]){l.push(f);break}f=n}if(!(l.length<1)){d=new i(l[l.length-1][0].nextSibling);a=new i(c.createElement(this.type));for(h.push(a);l.length;){h=l.shift();f=new i(c.createElement("li"));if(v.test(h._4e_name()))f[0].appendChild(h[0]);else{h._4e_copyAttributes(f);h._4e_moveChildren(f);h._4e_remove()}a[0].appendChild(f[0]);g.ie||f._4e_appendBogus()}d[0]?j.insertBefore(a[0],d[0]):e[0].appendChild(a[0])}},removeList:function(c,e,h){function d(H){if((r=
new i(z[H?"firstChild":"lastChild"]))&&!(r[0].nodeType==k.NODE_ELEMENT&&r._4e_isBlockBoundary())&&(D=e.root[H?"_4e_previous":"_4e_next"](s.whitespaces(true)))&&!(r[0].nodeType==k.NODE_ELEMENT&&D._4e_isBlockBoundary({br:1})))j[H?"insertBefore":"insertAfter"](c.document.createElement("br"),r[0])}for(var l=m.listToArray(e.root,h),a=[],f=0;f<e.contents.length;f++){var n=e.contents[f];n=n._4e_ascendant("li",true);if(!(!n||n._4e_getData("list_item_processed"))){a.push(n);n._4e_setMarker(h,"list_item_processed",
true)}}n=null;for(f=0;f<a.length;f++){n=a[f]._4e_getData("listarray_index");l[n].indent=-1;n=n}for(f=n+1;f<l.length;f++)if(l[f].indent>Math.max(l[f-1].indent,0)){a=l[f-1].indent+1-l[f].indent;for(n=l[f].indent;l[f]&&l[f].indent>=n;){l[f].indent+=a;f++}f--}var z=m.arrayToList(l,h,null,"p").listNode,r,D;d(true);d();j.insertBefore(z,e.root);e.root._4e_remove()},exec:function(c){var e=c.getSelection(),h=e&&e.getRanges();if(!(!h||h.length<1)){for(var d=e.createBookmarks(true),l=[],a={};h.length>0;){var f=
h.shift(),n=f.getBoundaryNodes(),z=n.startNode,r=n.endNode;z[0].nodeType==k.NODE_ELEMENT&&z._4e_name()=="td"&&f.setStartAt(n.startNode,B.POSITION_AFTER_START);r[0].nodeType==k.NODE_ELEMENT&&r._4e_name()=="td"&&f.setEndAt(n.endNode,B.POSITION_BEFORE_END);f=f.createIterator();for(f.forceBrBreak=false;n=f.getNextParagraph();){z=new o(n);r=z.elements;var D=null,H=false,y=z.blockLimit,C;for(z=r.length-1;z>=0&&(C=r[z]);z--)if(A[C._4e_name()]&&y.contains(C)){y._4e_removeData("list_group_object");if(z=C._4e_getData("list_group_object"))z.contents.push(n);
else{z={root:C,contents:[n]};l.push(z);C._4e_setMarker(a,"list_group_object",z)}H=true;break}if(!H)if(y._4e_getData("list_group_object"))y._4e_getData("list_group_object").contents.push(n);else{z={root:y,contents:[n]};y._4e_setMarker(a,"list_group_object",z);l.push(z)}}}for(h=[];l.length>0;){z=l.shift();if(this.state=="off")A[z.root._4e_name()]?this.changeListType(c,z,a,h):this.createList(c,z,h);else this.state=="on"&&A[z.root._4e_name()]&&this.removeList(c,z,a)}for(z=0;z<h.length;z++){D=h[z];var I=
this;(c=function(J){var N=D[J?"_4e_previous":"_4e_next"](s.whitespaces(true));if(N&&N[0]&&N._4e_name()==I.type){N._4e_remove();N._4e_moveChildren(D,J?true:false)}})();c(true)}u.Utils.clearAllMarkers(a);e.selectBookmarks(d)}}};var b=u.TripleButton;q.ATTRS={editor:{},type:{},contentCls:{}};x.extend(q,x.Base,{_init:function(){var c=this,e=c.get("editor"),h=c.el;c=c;h.on("click",c._change,c);e.on("selectionChange",c._selectionChange,c)},_change:function(){var c=this.get("editor");this.get("type");var e=
this.el;c.fire("save");this.listCommand.state=e.get("state");this.listCommand.exec(c);c.fire("save");c.notifySelectionChange()},_selectionChange:function(c){this.get("editor");var e=this.get("type"),h=c.path,d;c=this.el;var l=h.blockLimit;if(h=h.elements)for(var a=0;a<h.length&&(d=h[a])&&d[0]!==l[0];a++){var f=x.indexOf(h[a]._4e_name(),t);if(f!==-1)if(t[f]===e){c.set("state",b.ON);return}else break}c.set("state",b.OFF)}});u.ListUtils=m;u.List=q}();w.addPlugin(function(){new u.List({editor:w,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new u.List({editor:w,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("maximize",function(w){var u=KISSY.Editor,A=KISSY,t=A.UA,x=A.Node,B=A.Event,o=u.TripleButton,s=A.DOM,k;u.Maximize||function(){function g(i){this.editor=i;this._init()}g.init=function(){k=new x("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(k[0]);g.init=null};A.augment(g,{_init:function(){this.el=new o({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);u.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var i=this,j=i.editor;B.remove(window,"resize",i._maximize,i);this._saveEditorStatus();j.wrap.css({height:i.iframeHeight});(new x(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";j.editorWrap.css({position:"static",width:i.editorWrapWidth});k.css({left:"-99999px",top:"-99999px"});window.scrollTo(i.scrollLeft,
i.scrollTop);i.el.set("state",o.OFF);setTimeout(function(){i._restoreEditorStatus()},30);j.notifySelectionChange()},_saveSate:function(){var i=this.editor;this.iframeHeight=i.wrap._4e_style("height");this.editorWrapWidth=i.editorWrap._4e_style("width");this.scrollLeft=s.scrollLeft();this.scrollTop=s.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var i=this.editor;if(t.gecko&&i.iframeFocus)this.savedRanges=(i=i.getSelection())&&i.getRanges()},_restoreEditorStatus:function(){var i=this.editor,
j=i.getSelection();if(t.gecko&&i.iframeFocus){this.el.el[0].focus();i.focus();this.savedRanges&&j&&j.selectRanges(this.savedRanges)}if(i.iframeFocus&&j)(i=j.getStartElement())&&i[0]&&i._4e_scrollIntoView()},_maximize:function(){var i=this.editor,j=s.viewportHeight(),p=s.viewportWidth(),q=i.statusDiv?i.statusDiv.height():0,m=i.toolBarDiv.height();if(t.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new x(document.body)).css({width:0,height:0,overflow:"hidden"});
i.editorWrap.css({position:"absolute",zIndex:990,width:p+"px"});k.css({zIndex:985,height:j+"px",width:p+"px"});i.editorWrap.offset({left:0,top:0});k.css({left:0,top:0});i.wrap.css({height:j-q-m-14+"px"});i.notifySelectionChange()},_real:function(){var i=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",i._maximize,i);this.el.set("state",o.ON);setTimeout(function(){i._restoreEditorStatus()},30)},_prepare:function(){g.init&&g.init()},maximize:function(){this._prepare()}});
u.Maximize=g}();w.addPlugin(function(){new u.Maximize(w)})});
KISSY.Editor.add("music",function(w){function u(i){return i.indexOf(s)!=-1}var A=KISSY.Editor,t=KISSY,x=A.Flash,B=w.htmlDataProcessor,o="ke_music",s="niftyplayer.swf",k=A.Utils.getFlashUrl,g=B&&B.dataFilter;g&&g.addRules({elements:{object:function(i){var j=i.attributes,p="ke_flash",q="flash";if(!(j.classid&&String(j.classid).toLowerCase())){for(j=0;j<i.children.length;j++)if(i.children[j].name=="embed"){if(!x.isFlashEmbed(i.children[j]))return null;if(u(i.children[j].attributes.src)){p=o;q="music"}return B.createFakeParserElement(i,
p,q,true)}return null}for(j=0;j<i.children.length;j++){var m=i.children[j];if(m.name=="param"&&m.attributes.name=="movie")if(u(m.attributes.value)){p=o;q="music";break}}return B.createFakeParserElement(i,p,q,true)},embed:function(i){if(!x.isFlashEmbed(i))return null;var j="ke_flash",p="flash";if(u(i.attributes.src)){j=o;p="music"}return B.createFakeParserElement(i,j,p,true)}}},4);A.MusicInserter||function(){function i(){i.superclass.constructor.apply(this,arguments)}function j(c){return c._4e_ascendant(function(e){return e._4e_name()===
"img"&&!!e.hasClass(o)},true)}function p(c){return c.replace(/^.+niftyplayer\.swf\?file=/,"")}var q=A.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"',m=/#\(music\)/g,v=["img."+o];t.extend(i,x,{_config:function(){var c=this.editor;c._toolbars=c._toolbars||{};c._toolbars.music=this;this._cls=o;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='http://'/></label></p></div>";
this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=b;this._flashRules=v},_initD:function(){var c=this,e=c.d;c.dUrl=e.el.one(".ke-music-url");var h=e.el.one(".ke-music-ok");e=e.el.one(".ke-music-cancel");h.on("click",c._gen,c);e.on("click",function(){c.d.hide()})},_getDWidth:function(){return"165"},_getDURl:function(){return q.replace(m,this.dUrl.val())},
_getDHeight:function(){return"37"},_getFlashUrl:function(c){return p(k(c))},_updateD:function(){var c=this.editor,e=this.selectedFlash;e?this.dUrl.val(this._getFlashUrl(c.restoreRealElement(e))):this.dUrl.val("")}});x.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",j);A.MusicInserter=i;var b={"\u7f16\u8f91\u97f3\u4e50":function(c){var e=c.getSelection();e=(e=e&&e.getStartElement())&&j(e);c=c._toolbars.music;if(e){c.selectedFlash=e;c.show()}}}}();w.addPlugin(function(){new A.MusicInserter(w)})});
KISSY.Editor.add("preview",function(w){var u=KISSY.Editor,A=KISSY,t=u.TripleButton;u.Preview||function(){function x(B){this.editor=B;this._init()}A.augment(x,{_init:function(){this.el=new t({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,o=640,s=420,k=80;try{var g=window.screen;o=Math.round(g.width*0.8);s=Math.round(g.height*0.7);k=Math.round(g.width*0.1)}catch(i){}B=
B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+B.getData()+"\n</body>");o=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+o+",height="+s+",left="+k);o.document.open();o.document.write(B);o.document.close()}});u.Preview=x}();w.addPlugin(function(){new u.Preview(w)})});
KISSY.Editor.add("removeformat",function(w){function u(j){this.editor=j;this._init()}function A(j,p){for(var q=0;q<p.length;q++)j.removeAttr(p[q])}var t=KISSY.Editor,x=KISSY,B=t.RANGE,o=t.ElementPath,s=t.NODE,k=t.TripleButton,g="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",i="class,style,lang,width,height,align,hspace,valign".split(",");g=new RegExp("^(?:"+g.replace(/,/g,"|")+")$","i");x.augment(u,{_init:function(){this.el=new k({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var j=this.editor,p=g;p.lastIndex=0;var q=j.getSelection().getRanges();j.fire("save");for(var m=0,v;v=q[m];m++)if(!v.collapsed){v.enlarge(B.ENLARGE_ELEMENT);var b=v.createBookmark(),c=b.startNode,e=b.endNode,h=function(d){for(var l=new o(d),a=l.elements,f=1,n;n=a[f];f++){if(n._4e_equals(l.block)||n._4e_equals(l.blockLimit))break;p.test(n._4e_name())&&d._4e_breakParent(n)}};
h(c);h(e);for(c=c._4e_nextSourceNode(true,s.NODE_ELEMENT);c;){if(c._4e_equals(e))break;h=c._4e_nextSourceNode(false,s.NODE_ELEMENT);c._4e_name()=="img"&&c.attr("_cke_realelement")||(p.test(c._4e_name())?c._4e_remove(true):A(c,i));c=h}v.moveToBookmark(b)}j.getSelection().selectRanges(q);j.fire("save")}});w.addPlugin(function(){new u(w)})});
KISSY.Editor.add("smiley",function(w){var u=KISSY.Editor,A=KISSY,t=A.DOM,x=A.Event,B=A.Node,o=u.SimpleOverlay,s=u.TripleButton;u.Smiley||function(){function k(j){this.editor=j;this._init()}for(var g="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",i=0;i<=98;i++)g+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+i+".gif'></a>";g+="</div></div>";A.augment(k,{_init:function(){this.el=new s({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);u.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(j){var p=this;t._4e_ascendant(j.target,function(q){return q[0]===p.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(j){j.halt();var p=this.editor;j=j.target;var q;if(t._4e_name(j)=="a"&&(q=t.attr(j,"data-icon"))){q=new B("<img src='"+q+"'/>",null,p.document);p.insertElement(q);this.smileyWin.hide()}},_prepare:function(){var j=this.editor;this.smileyPanel=new B(g);this.smileyWin=new o({el:this.smileyPanel,
focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);x.on(document,"click",this._hidePanel,this);x.on(j.document,"click",this._hidePanel,this)},_real:function(){var j=this.el.el.offset();j.top+=this.el.el.height()+5;if(j.left+this.smileyPanel.width()>t.viewportWidth()-60)j.left=t.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(j)},_show:function(j){this._prepare(j)}});u.Smiley=k}();w.addPlugin(function(){new u.Smiley(w)})});
KISSY.Editor.add("sourcearea",function(w){var u=KISSY.Editor,A=KISSY,t=A.UA,x=u.TripleButton;u.SourceArea||function(){function B(o){this.editor=o;this._init()}A.augment(B,{_init:function(){var o=this.editor;this.el=new x({container:o.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);o.textarea.on("mousedown",function(s){s.stopPropagation()})},_show:function(){var o=this.editor,s=
this.el;o.textarea.val(o.getData());o._showSource();s.set("state",x.ON)},_hide:function(){var o=this.editor,s=o.textarea,k=this.el;o._hideSource();o.setData(s.val());if(t.gecko&&o.iframeFocus){k.el[0].focus();o.focus()}k.set("state",x.OFF)}});u.SourceArea=B}();w.addPlugin(function(){new u.SourceArea(w)})});
KISSY.Editor.add("table",function(w,u){var A=KISSY.Editor,t=KISSY,x=t.Node,B=t.DOM,o=A.Walker,s=t.UA,k=A.NODE,g=A.TripleButton,i=A.SimpleOverlay,j=A.ContextMenu,p=["tr","th","td","tbody","table"],q=t.trim,m;m=(s.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var v=w.htmlDataProcessor,b=v&&v.dataFilter;v=v&&v.htmlFilter;b&&b.addRules({elements:{table:function(c){c=c.attributes;var e=c["class"],h=parseInt(c.border,10);if(!h||h<=0)c["class"]=(e||"")+" ke_show_border"}}});v&&v.addRules({elements:{table:function(c){c=c.attributes;var e=c["class"];if(e)c["class"]=t.trim(e.replace("ke_show_border","").replace(/\s{2}/," "))}}});A.TableUI||function(){function c(y){this.editor=y;this.selectedTable=
null;y._toolbars=y._toolbars||{};y._toolbars.table=this;this._init()}function e(y){return q(y).length!=0}function h(y){function C($){if(!(N.length>0))if($[0].nodeType==k.NODE_ELEMENT&&D.test($._4e_name())&&!$._4e_getData("selected_cell")){$._4e_setMarker(M,"selected_cell",true);N.push($)}}for(var I=y.createBookmarks(),J=y.getRanges(),N=[],M={},Q=0;Q<J.length;Q++){var R=J[Q];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&N.push(R)}else{R=new o(R);
var W;for(R.guard=C;W=R.next();)if((W=W.parent())&&D.test(W._4e_name())&&!W._4e_getData("selected_cell")){W._4e_setMarker(M,"selected_cell",true);N.push(W)}}}A.Utils.clearAllMarkers(M);y.selectBookmarks(I);return N}function d(y){y=y.cells;for(var C=0;C<y.length;C++){y[C].innerHTML="";s.ie||(new x(y[C]))._4e_appendBogus()}}function l(y,C){if(y=y.getStartElement()._4e_ascendant("tr")){var I=y._4e_clone(true);I.insertBefore(y);d(C?I[0]:y[0])}}function a(y){if(y instanceof A.Selection){var C=h(y),I=C.length;
y=[];for(var J,N,M=0;M<I;M++){var Q=C[M].parent(),R=Q[0].rowIndex;!M&&(J=R-1);y[R]=Q;M==I-1&&(N=R+1)}M=Q._4e_ascendant("table");J=new x(N<M[0].rows.length&&M[0].rows[N]||J>0&&M[0].rows[J]||M[0].parentNode);for(M=y.length;M>=0;M--)y[M]&&a(y[M]);return J}else if(y instanceof x){M=y._4e_ascendant("table");M[0].rows.length==1?M._4e_remove():y._4e_remove()}return 0}function f(y,C){y=y.getStartElement();if(y=y._4e_ascendant("td",true)||y._4e_ascendant("th",true))for(var I=y._4e_ascendant("table"),J=y[0].cellIndex,
N=0;N<I[0].rows.length;N++){var M=I[0].rows[N];if(!(M.cells.length<J+1)){y=new x(M.cells[J].cloneNode(false));s.ie||y._4e_appendBogus();M=new x(M.cells[J]);C?y.insertBefore(M):y.insertAfter(M)}}}function n(y){var C=[],I=y[0]&&y[0]._4e_ascendant("table"),J,N,M,Q;J=0;for(N=y.length;J<N;J++)C.push(y[J][0].cellIndex);C.sort();J=1;for(N=C.length;J<N;J++)if(C[J]-C[J-1]>1){M=C[J-1]+1;break}M||(M=C[0]>0?C[0]-1:C[C.length-1]+1);y=I[0].rows;J=0;for(N=y.length;J<N;J++)if(Q=y[J].cells[M])break;return Q?new x(Q):
I._4e_previous()}function z(y){if(y instanceof A.Selection){var C=h(y),I=n(C);for(y=C.length-1;y>=0;y--)C[y]&&z(C[y]);return I}else if(y instanceof x){C=y._4e_ascendant("table");if(!C)return null;I=y[0].cellIndex;for(y=C[0].rows.length-1;y>=0;y--){var J=new x(C[0].rows[y]);if(!I&&J[0].cells.length==1)a(J);else J[0].cells[I]&&J[0].removeChild(J[0].cells[I])}}return null}function r(y,C){var I=new A.Range(y[0].ownerDocument);if(!I.moveToElementEditablePosition(y,C?true:u)){I.selectNodeContents(y);I.collapse(C?
false:true)}I.select(true)}t.augment(c,{_init:function(){var y=this.editor,C={};this.el=new g({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:y.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in H)(function(J){C[J]=function(){y.fire("save");H[J](y);y.fire("save")}})(I);j.register(y.document,{rules:p,width:"120px",funcs:C});A.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var y=this,C=new i({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});
C.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='8'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='8'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='8'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input value='1' class='ke-table-cellspacing' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td><td><label>\u8fb9\u8ddd\uff1a <input value='1' class='ke-table-cellpadding' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td></td><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='8'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
C.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");C.twidth=C.body.one(".ke-table-width");C.theight=C.body.one(".ke-table-height");C.tcellspacing=C.body.one(".ke-table-cellspacing");C.tcellpadding=C.body.one(".ke-table-cellpadding");C.tborder=C.body.one(".ke-table-border");C.tcaption=C.body.one(".ke-table-caption");C.talign=C.body.one(".ke-table-align");C.trows=C.body.one(".ke-table-rows");C.tcols=C.body.one(".ke-table-cols");C.thead=
C.body.one(".ke-table-head");var I=C.foot.one(".ke-table-ok"),J=C.foot.one(".ke-table-cancel");C.twidthunit=C.body.one(".ke-table-width-unit");y.tableDialog=C;I.on("click",y._tableOk,y);C.on("hide",function(){y.selectedTable=null});J.on("click",function(){C.hide()})},_tableOk:function(){this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var y=this.tableDialog,C=this.selectedTable,I=C.one("caption");e(y.talign.val())&&C.attr("align",q(y.talign.val()));e(y.tcellspacing.val())&&
C.attr("cellspacing",q(y.tcellspacing.val()));e(y.tcellpadding.val())&&C.attr("cellpadding",q(y.tcellpadding.val()));e(y.tborder.val())&&C.attr("border",q(y.tborder.val()));!e(y.tborder.val())||y.tborder.val()=="0"?C.addClass("ke_show_border"):C.removeClass("ke_show_border");e(y.twidth.val())&&C.css("width",q(y.twidth.val())+y.twidthunit.val());e(y.theight.val())&&C.css("height",q(y.theight.val()));if(e(y.tcaption.val()))I&&I[0]?I.html(q(y.tcaption.val())):(new x("<caption><span>"+q(y.tcaption.val())+
"</span></caption>")).insertBefore(C[0].firstChild);else I&&I._4e_remove();y.hide()},_genTable:function(){var y=this.tableDialog,C="<table ",I,J=parseInt(y.tcols.val())||1,N=parseInt(y.trows.val())||1,M=s.ie?"&nbsp;":"<br/>",Q=this.editor;if(t.trim(y.talign.val()).length!=0)C+="align='"+t.trim(y.talign.val())+"' ";if(t.trim(y.tcellspacing.val()).length!=0)C+="cellspacing='"+t.trim(y.tcellspacing.val())+"' ";if(t.trim(y.tcellpadding.val()).length!=0)C+="cellpadding='"+t.trim(y.tcellpadding.val())+
"' ";if(t.trim(y.tborder.val()).length!=0)C+="border='"+t.trim(y.tborder.val())+"' ";if(t.trim(y.twidth.val()).length!=0||t.trim(y.theight.val()).length!=0){C+="style='";if(t.trim(y.twidth.val()).length!=0)C+="width:"+t.trim(y.twidth.val())+y.twidthunit.val()+";";if(t.trim(y.theight.val()).length!=0)C+="height:"+t.trim(y.theight.val())+"px;";C+="' "}if(t.trim(y.tborder.val()).length==0||t.trim(y.tborder.val())=="0")C+="class='ke_show_border' ";C+=">";if(t.trim(y.tcaption.val()))C+="<caption><span>"+
t.trim(y.tcaption.val())+"</span></caption>";if(y.thead.val()){C+="<thead>";C+="<tr>";for(I=0;I<J;I++)C+="<th>"+M+"</th>";C+="</tr>";C+="</thead>";N-=1}C+="<tbody>";for(var R=0;R<N;R++){C+="<tr>";for(I=0;I<J;I++)C+="<td>"+M+"</td>";C+="</tr>"}C+="</tbody>";C+="</table>";C=new x(C,null,Q.document);Q.insertElement(C);y.hide()},_fillTableDialog:function(){var y=this.tableDialog,C=this.selectedTable,I=C.one("caption");y.talign.val(C.attr("align")||"");y.tcellspacing.val(C.attr("cellspacing")||"");y.tcellpadding.val(C.attr("cellpadding")||
"");y.tborder.val(C.attr("border")|"");var J=C._4e_style("width")||"";y.twidth.val(J.replace(/px|%/i,""));J.indexOf("%")!=-1?y.twidthunit.val("%"):y.twidthunit.val("px");y.theight.val((C._4e_style("height")||"").replace(/px|%/i,""));J="";if(I)J=I.text();y.tcaption.val(J);y.trows.val(C.one("tbody").children().length);y.tcols.val(C.one("tr").children().length);y.thead.val(C._4e_first(function(N){return N._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();
this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var D=/^(?:td|th)$/,H={"\u8868\u683c\u5c5e\u6027":function(y){var C=y.getSelection();if(C=(C=C&&C.getStartElement())&&C._4e_ascendant("table",true)){y=y._toolbars.table;y.selectedTable=C;y._tableShow()}},"\u5220\u9664\u8868\u683c":function(y){var C=
(y=y.getSelection())&&y.getStartElement();if(C=C&&C._4e_ascendant("table",true)){y.selectElement(C);var I=y.getRanges()[0];I.collapse();y.selectRanges([I]);y=C.parent();y[0].childNodes.length==1&&y._4e_name()!="body"?y._4e_remove():C._4e_remove()}},"\u5220\u9664\u884c ":function(y){y=y.getSelection();r(a(y),u)},"\u5220\u9664\u5217 ":function(y){y=y.getSelection();(y=z(y))&&r(y,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(y){y=y.getSelection();l(y,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(y){y=
y.getSelection();l(y,u)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(y){y=y.getSelection();f(y,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(y){y=y.getSelection();f(y,u)}};A.TableUI=c}();w.addPlugin(function(){var c=w.document;new A.TableUI(w);var e=B.create("<style>",null,c);c.getElementsByTagName("head")[0].appendChild(e);if(e.styleSheet)e.styleSheet.cssText=m;else e.appendChild(c.createTextNode(m))})});
KISSY.Editor.add("templates",function(w){var u=KISSY.Editor,A=KISSY,t=A.Node,x=u.TripleButton,B=u.SimpleOverlay;u.TplUI||function(){function o(s){this.editor=s;this._init()}A.augment(o,{_init:function(){(new x({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);u.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var s=this.editor,k=s.cfg.pluginConfig.templates,g="<div class='ke-tpl'>",i=0;i<k.length;i++)g+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
k[i].demo+"</a>";g+="</div>";this._initDialogOk=true;var j=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});j.body.html(g);j.body.all(".ke-tpl-list").on("click",function(p){p.halt();p=(new t(p.target))._4e_index();p!=-1&&s.insertHtml(k[p].html);j.hide()});this.ui=j},_real:function(){this.ui.show()},_show:function(){this._prepare()}});u.TplUI=o}();w.addPlugin(function(){new u.TplUI(w)})});
KISSY.Editor.add("undo",function(w){var u=KISSY.Editor,A=KISSY,t=u.Utils.arrayCompare,x=A.UA,B=A.Event;u.UndoManager||function(){function o(m){var v=m._getRawData();m=v&&m.getSelection();this.contents=v;this.bookmarks=m&&m.createBookmarks2(true)}function s(m,v,b){this.s=m;this.fn=v;this.scope=b||window;this.bufferTimer=null}function k(m){this.history=[];this.index=0;this.editor=m;this.bufferTimer=new s(500,this.save,this);this._init()}function g(m,v,b,c){this.editor=m;this.title=b;this.text=v;this.contentCls=
c;this._init()}A.augment(o,{equals:function(m){if(this.contents!=m.contents)return false;var v=this.bookmarks;m=m.bookmarks;if(v||m){if(!v||!m||v.length!=m.length)return false;for(var b=0;b<v.length;b++){var c=v[b],e=m[b];if(c.startOffset!=e.startOffset||c.endOffset!=e.endOffset||!t(c.start,e.start)||!t(c.end,e.end))return false}}return true}});A.augment(s,{run:function(){if(this.bufferTimer){clearTimeout(this.bufferTimer);this.bufferTimer=null}var m=this;this.bufferTimer=setTimeout(function(){m.fn.call(m.scope)},
this.s)}});var i={16:1,17:1,18:1},j={37:1,38:1,39:1,40:1};A.augment(k,{_keyMonitor:function(){var m=this.editor;B.on(m.document,"keydown",function(v){var b=v.keyCode;if(!(b in j||b in i))if(b===90&&(v.ctrlKey||v.metaKey)){m.fire("restore",{d:-1});v.halt()}else if(b===89&&(v.ctrlKey||v.metaKey)){m.fire("restore",{d:1});v.halt()}else m.fire("save",{buffer:1})})},_init:function(){var m=this,v=m.editor;v.on("save",function(b){b.buffer?m.bufferTimer.run():m.save()});v.on("restore",this.restore,this);m._keyMonitor()},
save:function(){this.history.length>this.index+1&&this.history.splice(this.index+1,this.history.length-this.index-1);var m=this.editor,v=this.history.length>0?this.history[this.history.length-1]:null,b=new o(this.editor);if(!v||!v.equals(b)){this.history.length===30&&this.history.shift();this.history.push(b);this.index=this.history.length-1;m.fire("afterSave",{history:this.history,index:this.index})}},restore:function(m){m=m.d;var v=this.editor,b=this.history.length>0?this.history[this.index+m]:null;
if(b){v._setRawData(b.contents);if(b.bookmarks)this.editor.getSelection().selectBookmarks(b.bookmarks);else if(x.ie){b=this.editor.document.body.createTextRange();b.collapse(true);b.select()}this.index+=m;v.fire("afterRestore",{history:this.history,index:this.index});v.notifySelectionChange()}}});var p=u.TripleButton,q={redo:1,undo:-1};A.augment(g,{_init:function(){var m=this,v=m.editor;m.el=new p({contentCls:m.contentCls,title:m.title,container:v.toolBarDiv});this.el.set("state",p.DISABLED);v.on("afterSave",
this._respond,this);v.on("afterRestore",this._respond,this);m.el.on("offClick",function(){v.fire("restore",{d:q[m.text]})})},_respond:function(m){this.updateUI(m.history,m.index)},updateUI:function(m,v){if(this.text=="undo")v>0&&m.length>0?this.el.set("state",p.OFF):this.el.set("state",p.DISABLED);else if(this.text=="redo")v<m.length-1?this.el.set("state",p.OFF):this.el.set("state",p.DISABLED)}});u.UndoManager=k;u.RestoreUI=g}();w.addPlugin(function(){new u.UndoManager(w);new u.RestoreUI(w,"undo",
"\u64a4\u9500","ke-toolbar-undo");new u.RestoreUI(w,"redo","\u91cd\u505a","ke-toolbar-redo")})});
