KISSY.add("editor",function(u,s){function x(m,w){var a=this;if(!(a instanceof x))return new x(m,w);if(u.isString(m))m=u.one(m);m=v._4e_wrap(m);w=w||{};w.pluginConfig=w.pluginConfig||{};a.cfg=w;u.app(a,u.EventTarget);a.use=function(c){if(u.isString(c))c=c.split(",");var e=c;c=[];c=u.indexOf("separator",e);var h=c!=-1;c=e.splice(0,h?c+1:e.length);h&&c.pop();c.length!=0?u.use.call(a,c.join(","),function(){h&&a.addPlugin(function(){x.Utils.addSeparator(a.toolBarDiv)});a.use(e)},{order:true,global:x}):
a.on("dataReady",function(){a.setData(m.val());a.fire("save")});return a};a.init(m);return s}function r(m){if(!B)return m.replace(/\.(js|css)/i,"-min.$1");if(B==="dev")return"../src/"+m;return m}var v=u.DOM;u.app(x,u.EventTarget);x.Config.base=u.Config.base+"editor/";var B=u.Config.debug,n={htmlparser:{attach:false,path:r("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},t=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],g=["flashutils",
"clipboard",{name:"color"},{name:"elementpaths"},"enterkey",{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["flashutils","contextmenu","fakeobjects","overlay","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview"]},"indent","justify",{name:"link",requires:["bubbleview"]},
"list","maximize",{name:"music",requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],d=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",
requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],k,o,l,i;k=0;for(o=g.length;k<o;k++){l=g[k];if(u.isString(l))l=g[k]={name:l};l.requires=l.requires||[];l.requires=l.requires.concat(["button"])}g=[{name:"localStorage",requires:["flashutils"]},{name:"button"},{name:"dd"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",
requires:["overlay"]}].concat(g);k=0;for(o=g.length;k<o;k++){l=g[k];i=l.name;n[i]={attach:false,requires:l.requires,csspath:l.useCss?r("plugins/"+i+"/plugin.css"):s,path:r("plugins/"+i+"/plugin.js")}}k=0;for(o=d.length;k<o;k++){l=d[k];g=s;if(!u.isString(l)){g=l.requires;l=l.name}n[l]={attach:false,requires:g,path:r("plugins/htmldataprocessor/htmlparser/"+l.substring(11)+".js")}}k=0;for(o=t.length;k<o;k++){l=t[k];n[l]={host:"editor",requires:k>0?t[k-1]:[]}}x.add(n);u.Editor=x});
KISSY.Editor.add("utils",function(u){var s=KISSY,x=s.Node,r=s.DOM,v=s.Config.debug,B=s.UA;u.Utils={debugUrl:function(n){if(!v)return n.replace(/\.(js|css)/i,"-min.$1");if(v==="dev")return"../src/"+n;return n},lazyRun:function(n,t,g){var d=n[t],k=n[g];n[t]=function(){d.apply(this,arguments);n[t]=n[g];return k.apply(this,arguments)}},getXY:function(n,t,g,d){g=g.defaultView||g.parentWindow;n-=r.scrollLeft(g);t-=r.scrollTop(g);if(d)if(g!=(d.defaultView||d.parentWindow)&&g.frameElement){d=r._4e_getOffset(g.frameElement,
d);n+=d.left;t+=d.top}return{left:n,top:t}},tryThese:function(){for(var n,t=0,g=arguments.length;t<g;t++){var d=arguments[t];try{n=d();break}catch(k){}}return n},arrayCompare:function(n,t){if(!n&&!t)return true;if(!n||!t||n.length!=t.length)return false;for(var g=0;g<n.length;g++)if(n[g]!==t[g])return false;return true},getByAddress:function(n,t,g){n=n.documentElement;for(var d=0;n&&d<t.length;d++){var k=t[d];if(g)for(var o=-1,l=0;l<n.childNodes.length;l++){var i=n.childNodes[l];if(!(g===true&&i.nodeType==
3&&i.previousSibling&&i.previousSibling.nodeType==3)){o++;if(o==k){n=i;break}}}else n=n.childNodes[k]}return n?new x(n):null},clearAllMarkers:function(n){for(var t in n)n[t]._4e_clearMarkers(n,true)},htmlEncodeAttr:function(n){return n.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(n){return n.replace(/^\s+/,"")},rtrim:function(n){return n.replace(/\s+$/,"")},trim:function(n){return this.ltrim(this.rtrim(n))},mix:function(){for(var n={},t=0;t<arguments.length;t++)n=
s.mix(n,arguments[t]);return n},isCustomDomain:function(){if(!B.ie)return false;var n=document.domain,t=window.location.hostname;return n!=t&&n!="["+t+"]"},addSeparator:function(n){(new s.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(n)},duplicateStr:function(n,t){return(new Array(t+1)).join(n)},throttle:function(n,t,g){g=g||150;if(g===-1)return function(){n.apply(t,arguments)};var d=(new Date).getTime();return function(){var k=(new Date).getTime();if(k-d>g){d=k;n.apply(t,arguments)}}},
buffer:function(n,t,g){g=g||0;var d=null;return function(){d&&clearTimeout(d);var k=arguments;d=setTimeout(function(){return n.apply(t,k)},g)}},isNumber:function(n){return/^\d+(.\d+)?$/.test(s.trim(n))}}});
KISSY.Editor.add("focusmanager",function(u){function s(){this.iframeFocus=true;t=this}function x(){this.iframeFocus=false;t=null}var r=KISSY,v=r.DOM,B=r.Event;r={};var n={},t;r={refreshAll:function(){for(var g in n){var d=n[g];d.document.designMode="off";d.document.designMode="on"}},currentInstance:function(){return t},getInstance:function(g){return n[g]},add:function(g){var d=v._4e_getWin(g.document);B.on(d,"focus",s,g);B.on(d,"blur",x,g)},register:function(g){n[g._UUID]=g},remove:function(g){delete n[g._UUID];
var d=v._4e_getWin(g.document);B.remove(d,"focus",s,g);B.remove(d,"blur",x,g)}};u.focusManager=r});
KISSY.Editor.add("definition",function(u){function s(m){return d+"<html><head><title>kissy-editor</title><link href='"+u.Config.base+k+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(m?'<script id="ke_actscrpt" type="text/javascript">'+(u.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+m+'");<\/script>':"")}var x=KISSY,r=x.UA,v=x.DOM,B=x.Node,n=x.Event,t=u.focusManager,g=u.Utils.tryThese,d="<!doctype html>",k=
u.Utils.debugUrl("theme/editor-iframe.css"),o=1,l="document.open();"+(u.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",i="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(r.ie?"javascript:void(function(){"+encodeURIComponent(l)+"}())":"")+'"  tabIndex="'+
(r.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";x.augment(u,{init:function(m){var w=this,a=new B(i.replace(/\$\(tabIndex\)/,m.attr("tabIndex")));a.on("mousedown",function(h){if(r.webkit){var p=v._4e_name(h.target);if(p=="select"||p=="option")return true}h.halt()});w.editorWrap=a;w._UUID=o++;t.register(w);w.wrap=a.one(".ke-textarea-wrap");w.iframe=w.wrap.one("iframe");w.toolBarDiv=a.one(".ke-editor-tools");w.textarea=
m;w.statusDiv=a.one(".ke-editor-status");w.toolBarDiv._4e_unselectable();w._commands={};w._plugins={};var c=m._4e_style("width"),e=m._4e_style("height");if(c){a.css("width",c);m.css("width","100%")}w.textarea.css("display","none");a.insertAfter(m);w.wrap[0].appendChild(m[0]);if(e){w.wrap.css("height",e);m.css("height","100%")}m=w.iframe;w.on("dataReady",function(){w.ready=true;u.fire("instanceCreated",{editor:w})});r.gecko?m.on("load",w._setUpIFrame,w):w._setUpIFrame()},addCommand:function(m,w){this._commands[m]=
w},execCommand:function(m){this.fire("save");this._commands[m].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(m){if(this.htmlDataProcessor)m=this.htmlDataProcessor.toDataFormat(m,"p");this.document.body.innerHTML=m},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(m){this.document.body.innerHTML=
m},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");r.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:s,getSelection:function(){var m=new u.Selection(this.document);return!m||m.isInvalid?null:m},focus:function(){var m=v._4e_getWin(this.document);r.webkit&&m&&m.parent&&m.parent.focus();m&&m.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){v._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function m(){h=e.document;w.document=h;a.detach();h.open("text/html","replace");h.write(c);h.close()}
var w=this,a=w.iframe,c=s(w._UUID),e=a[0].contentWindow,h;try{h=e.document}catch(p){a[0].src=a[0].src;if(r.ie&&r.ie<7){setTimeout(m,10);return}}m()},addPlugin:function(m){this.ready?m():this.on("dataReady",m)},_monitor:function(){var m=this;m._monitorId&&clearTimeout(m._monitorId);m._monitorId=setTimeout(function(){var w=m.getSelection();if(w&&!w.isInvalid){w=w.getStartElement();var a=new u.ElementPath(w);if(!m.previousPath||!m.previousPath.compare(a)){m.previousPath=a;m.fire("selectionChange",{selection:m,
path:a,element:w})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(m,w){var a=this;a.focus();var c=m._4e_name(),e=u.XHTML_DTD,h=u.RANGE,p=u.NODE,j=e.$block[c],b=a.getSelection(),f=b.getRanges(),q,y,A,C,H;a.fire("save");for(var O=f.length-1;O>=0;O--){q=f[O];q.deleteContents();y=!O&&m||m._4e_clone(true);w&&w(y);if(j)for(;(C=q.getCommonAncestor(false,true))&&(H=e[C._4e_name()])&&!(H&&H[c]);)if(C._4e_name()in e.span)q.splitElement(C);else if(q.checkStartOfBlock()&&
q.checkEndOfBlock()){q.setStartBefore(C);q.collapse(true);C._4e_remove()}else q.splitBlock();q.insertNode(y);A||(A=y)}m=A._4e_nextSourceNode(true);w=a.document;H=u.XHTML_DTD;if(H.$inline[y._4e_name()]){m=new B(w.createTextNode(" "));m.insertAfter(A)}else if(m){if(m._4e_name()=="br"&&H[m.parent()._4e_name()].p){H=new B("<p>&nbsp;</p>",null,w);m[0].parentNode.replaceChild(H[0],m[0]);m=H}}else{H=new B("<p>&nbsp;</p>",null,w);H.insertAfter(A);m=H}q.moveToPosition(A,h.POSITION_AFTER_END);m&&m[0].nodeType==
p.NODE_ELEMENT&&q.moveToElementEditablePosition(m);b.selectRanges([q]);a.focus();y&&y._4e_scrollIntoView();setTimeout(function(){a.fire("save")},10);return y},insertHtml:function(m){var w=this;if(w.htmlDataProcessor)m=w.htmlDataProcessor.toDataFormat(m);if(r.webkit){m=v.create(m,null,this.document);m=m.nodeType==11?x.makeArray(m.childNodes):[m];for(var a=0;a<m.length;a++)w.insertElement(new B(m[a]))}else{w.focus();w.fire("save");a=w.getSelection();if(r.ie){a=a.getNative();a.type=="Control"&&a.clear();
a.createRange().pasteHTML(m)}else w.document.execCommand("inserthtml",false,m);w.focus();setTimeout(function(){w.fire("save")},10)}}});u._initIFrame=function(m){function w(y){g(function(){e.designMode="on";setTimeout(function(){e.designMode="off";j.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){e.designMode="off";v.attr(j,"contentEditable",false);v.attr(j,"contentEditable",true);!y&&w(1)})}var a=t.getInstance(m);m=a.textarea[0];var c=a.iframe[0].contentWindow,e=a.document,
h=a.cfg,p=e.getElementById("ke_actscrpt");p.parentNode.removeChild(p);var j=e.body;if(r.ie){j.hideFocus=true;j.disabled=true;j.contentEditable=true;j.removeAttribute("disabled")}else setTimeout(function(){if(r.gecko||r.opera)j.contentEditable=true;else if(r.webkit)j.parentNode.contentEditable=true;else e.designMode="on"},0);if(r.webkit){n.on(e,"click",function(y){var A=new B(y.target);x.inArray(A._4e_name(),["input","select"])&&y.preventDefault()});n.on(e,"mouseup",function(y){var A=new B(y.target);
x.inArray(A._4e_name(),["input","textarea"])&&y.preventDefault()})}if(r.gecko||r.ie||r.opera){var b;b=new B(v.insertAfter((new B('<span style="position:absolute; left:-10000"></span>'))[0],m));b.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(r.ie&&e.compatMode=="CSS1Compat"||r.gecko||r.opera){var f=new B(e.documentElement);f.on("mousedown",function(y){if(y.target===f[0]){r.gecko&&w(false);b[0].focus()}})}n.on(c,"focus",function(){if(r.gecko)w(false);else r.opera&&j.focus();a.notifySelectionChange()});
r.gecko&&n.on(a.document,"mousedown",function(){a.iframeFocus||w(false)});if(r.ie){n.on(e,"keydown",function(y){if(y.keyCode in{8:1,46:1}){var A=a.getSelection(),C=A.getSelectedElement();if(C){a.fire("save");var H=A.getRanges()[0].createBookmark();C._4e_remove();A.selectBookmarks([H]);a.fire("save");y.preventDefault()}}});if(e.compatMode=="CSS1Compat"){var q={33:1,34:1};n.on(e,"keydown",function(y){y.keyCode in q&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){r.ie&&
setTimeout(function(){if(e){j.runtimeStyle.marginBottom="0px";j.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady");var y=h.disableObjectResizing,A=h.disableInlineTableEditing;if(y||A)try{e.execCommand("enableObjectResizing",false,!y);e.execCommand("enableInlineTableEditing",false,!A)}catch(C){n.on(j,r.ie?"resizestart":"resize",function(H){if(y||v._4e_name(H.target)==="table"&&A)H.preventDefault()})}},10);r.webkit&&n.on(e,"mousedown",function(y){y=new B(y.target);x.inArray(y._4e_name(),
["img","hr","input","textarea","select"])&&a.getSelection().selectElement(y)});t.add(a)};r.gecko&&function(){var m=document.body;if(m){var w=m.getAttribute("onpageshow");m.setAttribute("onpageshow",(w?w+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(u){u.XHTML_DTD=function(){var s=function(j){for(var b=arguments.length-1;b>0;)KISSY.mix(j,arguments[b--]);return j},x={isindex:1,fieldset:1},r={input:1,button:1,select:1,textarea:1,label:1},v=s({a:1},r),B=s({iframe:1},v),n={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},t={ins:1,del:1,script:1,style:1},g=s({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},t),d=s({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},g),k=s({p:1},d);r=s({iframe:1},d,r);d={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var o=s({a:1},r),l={tr:1},i={"#":1},m=s({param:1},d),w=s({form:1},x,B,n,k),a={li:1},c={base:1,link:1,meta:1,title:1},e=s(c,{style:1,script:1}),h={head:1,body:1},p={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:s({html:1},h,c),$block:p,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:o,$body:s({script:1,style:1},p),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:h,head:e,style:i,body:w,base:{},link:{},meta:{},title:i,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:w,td:w,br:{},th:w,center:w,kbd:o,button:s(k,n),basefont:{},h5:o,h4:o,samp:o,h6:o,ol:a,h1:o,h3:o,option:i,h2:o,form:s(x,B,n,k),select:{optgroup:1,option:1},font:o,ins:o,menu:a,abbr:o,label:o,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:o,script:i,tfoot:l,cite:o,li:w,input:{},iframe:w,strong:o,textarea:i,noframes:w,big:o,small:o,span:o,hr:{},dt:o,sub:o,optgroup:{option:1},param:{},bdo:o,"var":o,div:w,object:m,sup:o,dd:w,strike:o,area:{},dir:a,map:s({area:1,form:1,p:1},x,t,n),applet:m,dl:{dt:1,dd:1},del:o,isindex:{},fieldset:s({legend:1},d),thead:l,ul:a,acronym:o,b:o,a:r,blockquote:w,caption:o,i:o,u:o,tbody:l,s:o,address:s(B,k),tt:o,legend:o,q:o,pre:s(g,v),p:o,em:o,dfn:o}}()});
KISSY.Editor.add("dom",function(u){function s(a){return a.replace(/-(\w)/g,function(c,e){return e.toUpperCase()})}var x=KISSY,r=x.DOM,v=x.UA,B=x.Node,n=u.Utils,t={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};u.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};u.POSITION={};var g=u.NODE,d=u.POSITION;d.POSITION_IDENTICAL=0;d.POSITION_DISCONNECTED=
1;d.POSITION_FOLLOWING=2;d.POSITION_PRECEDING=4;d.POSITION_IS_CONTAINED=8;d.POSITION_CONTAINS=16;var k={},o={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},l={hr:1},i=function(a){return a[0]||a},m=function(a){if(a&&!a[0])return new B(a);return a},w={_4e_wrap:m,_4e_equals:function(a,c){if(!a&&!c)return true;if(!a||!c)return false;a=i(a);c=i(c);return a===c},_4e_isBlockBoundary:function(a,
c){a=m(a);c=x.mix(x.mix({},l),c||{});return o[a.css("display")]||c[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=i(a);for(var c=a.parentNode.childNodes,e=0;e<c.length;e++)if(c[e]===a)return e;return-1},_4e_first:function(a,c){a=i(a);if((a=(a=a.firstChild)&&new B(a))&&c&&!c(a))a=a._4e_next(c);return a},_4e_move:function(a,c,e){a._4e_remove();a=i(a);c=i(c);e?c.insertBefore(a,c.firstChild):c.appendChild(a)},
_4e_name:function(a){a=i(a);var c=a.nodeName.toLowerCase();if(v.ie)if((a=a.scopeName)&&a!="HTML")c=a.toLowerCase()+":"+c;return c},_4e_isIdentical:function(a,c){if(a._4e_name()!=c._4e_name())return false;var e=a[0].attributes,h=c[0].attributes,p=e.length,j=h.length;if(!v.ie&&p!=j)return false;for(var b=0;b<p;b++){var f=e[b];if((!v.ie||f.specified&&f.nodeName!="_ke_expando")&&f.nodeValue!=c.attr(f.nodeName))return false}if(v.ie)for(b=0;b<j;b++){f=h[b];if(f.specified&&f.nodeName!="_ke_expando"&&f.nodeValue!=
a.attr(f.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=i(a).childNodes;for(var c=0,e=a.length;c<e;c++){var h=a[c],p=h.nodeType;if(!(p==g.NODE_ELEMENT&&h.getAttribute("_ke_bookmark")))if(p==g.NODE_ELEMENT&&!w._4e_isEmptyInlineRemoveable(h)||p==g.NODE_TEXT&&x.trim(h.nodeValue))return false}return true},_4e_moveChildren:function(a,c,e){a=i(a);c=c[0]||c;if(a!=c)if(e)for(;e=a.lastChild;)c.insertBefore(a.removeChild(e),c.firstChild);else for(;e=a.firstChild;)c.appendChild(a.removeChild(e))},
_4e_mergeSiblings:function(){function a(c,e,h){if(e[0]&&e[0].nodeType==g.NODE_ELEMENT){for(var p=[];e.attr("_ke_bookmark")||e._4e_isEmptyInlineRemoveable();){p.push(e);e=h?new B(e[0].nextSibling):new B(e[0].previousSibling);if(!e[0]||e[0].nodeType!=g.NODE_ELEMENT)return}if(c._4e_isIdentical(e)){for(var j=h?c[0].lastChild:c[0].firstChild;p.length;)p.shift()._4e_move(c,!h);e._4e_moveChildren(c,!h);e._4e_remove();j[0]&&j[0].nodeType==g.NODE_ELEMENT&&j._4e_mergeSiblings()}}}return function(c){if(c[0])if(t[c._4e_name()]||
c._4e_name()=="a"){a(c,new B(c[0].nextSibling),true);a(c,new B(c[0].previousSibling))}}}(),_4e_unselectable:v.gecko?function(a){a=i(a);a.style.MozUserSelect="none"}:v.webkit?function(a){a=i(a);a.style.KhtmlUserSelect="none"}:function(a){a=i(a);if(v.ie||v.opera){var c,e=0;for(a.unselectable="on";c=a.all[e++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(a,c){a=i(a);var e,h=0;e=0;var p=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,j=a.ownerDocument,b=j.documentElement;c=c||j;if(a.getBoundingClientRect){if(a!==j.body&&b!==a){e=a.getBoundingClientRect();h=e.left+(c===j?r.scrollLeft(p):0);e=e.top+(c===j?r.scrollTop(p):0)}if(c)if(p!=(c.defaultView||c.parentWindow)&&p.frameElement){c=w._4e_getOffset(p.frameElement,c);h+=c.left;e+=c.top}}return{left:h,top:e}},_4e_getFrameDocument:function(a){return(a=i(a))&&a.contentWindow.document},_4e_splitText:function(a,c){a=i(a);var e=a.ownerDocument;if(!(!a||a.nodeType!=
g.NODE_TEXT)){if(v.ie&&c==a.nodeValue.length){e=e.createTextNode("");r.insertAfter(e,a);return e}a=new B(a.splitText(c));if(v.ie==8){e=e.createTextNode("");r.insertAfter(e,a[0]);e.parentNode.removeChild(e)}return a}},_4e_parents:function(a,c){a=m(a);var e=[];do e[c?"push":"unshift"](a);while(a=a.parent());return e},_4e_clone:function(a,c,e){a=i(a);a=a.cloneNode(c);if(!e){var h=function(p){if(p.nodeType==g.NODE_ELEMENT){p.removeAttribute("id",false);p.removeAttribute("_ke_expando",false);p=p.childNodes;
for(var j=0;j<p.length;j++)h(p[j])}};h(a)}return new B(a)},_4e_nextSourceNode:function(a,c,e,h){a=i(a);if(h&&!h.call){var p=h[0]||h;h=function(b){b=b[0]||b;return b!==p}}c=!c&&a.firstChild;var j=new B(a);if(!c){if(a.nodeType==g.NODE_ELEMENT&&h&&h(a,true)===false)return null;c=a.nextSibling}for(;!c&&(j=j.parent());){if(h&&h(j,true)===false)return null;c=j[0].nextSibling}if(!c)return null;c=r._4e_wrap(c);if(h&&h(c)===false)return null;if(e&&e!=c[0].nodeType)return c._4e_nextSourceNode(false,e,h);return c},
_4e_previousSourceNode:function(a,c,e,h){a=i(a);if(h&&!h.call){var p=h[0]||h;h=function(b){b=b[0]||b;return b!==p}}c=!c&&a.lastChild;var j=new B(a);if(!c){if(a.nodeType==g.NODE_ELEMENT&&h&&h(a,true)===false)return null;c=a.previousSibling}for(;!c&&(j=j.parent());){if(h&&h(j,true)===false)return null;c=j[0].previousSibling}if(!c)return null;c=r._4e_wrap(c);if(h&&h(c)===false)return null;if(e&&c[0].nodeType!=e)return c._4e_previousSourceNode(false,e,h);return c},_4e_contains:v.ie||v.webkit?function(a,
c){a=i(a);c=i(c);return c.nodeType!=g.NODE_ELEMENT?a.contains(c.parentNode):a!=c&&a.contains(c)}:function(a,c){a=i(a);c=i(c);return!!(a.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(a,c){if(a._4e_equals(c))return a;if(c[0].nodeType!=g.NODE_TEXT&&c._4e_contains(a))return c;a=a[0].nodeType==g.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=g.NODE_TEXT&&a._4e_contains(c))return a;while(a=a.parent());return null},_4e_ascendant:function(a,c,e){a=i(a);if(!e)a=a.parentNode;if(c&&!x.isFunction(c)){var h=
c;c=function(p){return p._4e_name()==h}}for(;a&&a.nodeType!=9;){if(!c||c(new B(a))===true)return new B(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,c){a=i(a);a=a.attributes.getNamedItem(c);return!!(a&&a.specified)},_4e_hasAttributes:v.ie?function(a){a=i(a);for(var c=a.attributes,e=0;e<c.length;e++){var h=c[e];switch(h.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(h.specified)return true}}return false}:function(a){a=i(a);v.gecko&&
a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,c){var e=i(a),h=i(c);if(e.compareDocumentPosition)return e.compareDocumentPosition(h);if(e==h)return d.POSITION_IDENTICAL;if(e.nodeType==g.NODE_ELEMENT&&h.nodeType==g.NODE_ELEMENT){if(e.contains){if(e.contains(h))return d.POSITION_CONTAINS+d.POSITION_PRECEDING;if(h.contains(e))return d.POSITION_IS_CONTAINED+d.POSITION_FOLLOWING}if("sourceIndex"in e)return e.sourceIndex<
0||h.sourceIndex<0?d.POSITION_DISCONNECTED:e.sourceIndex<h.sourceIndex?d.POSITION_PRECEDING:d.POSITION_FOLLOWING}a=a._4e_address();c=c._4e_address();e=Math.min(a.length,c.length);for(h=0;h<=e-1;h++)if(a[h]!=c[h]){if(h<e)return a[h]<c[h]?d.POSITION_PRECEDING:d.POSITION_FOLLOWING;break}return a.length<c.length?d.POSITION_CONTAINS+d.POSITION_PRECEDING:d.POSITION_IS_CONTAINED+d.POSITION_FOLLOWING},_4e_address:function(a,c){a=i(a);var e=[],h=a.ownerDocument.documentElement;for(a=a;a&&a!=h;){var p=a.parentNode,
j=-1;if(p){for(var b=0;b<p.childNodes.length;b++){var f=p.childNodes[b];if(!(c&&f.nodeType==3&&f.previousSibling&&f.previousSibling.nodeType==3)){j++;if(f==a)break}}e.unshift(j)}a=p}return e},_4e_breakParent:function(a,c){var e=new u.Range(a[0].ownerDocument);e.setStartAfter(a);e.setEndAfter(c);c=e.extractContents();e.insertNode(a._4e_remove());a[0].parentNode.insertBefore(c,a[0].nextSibling)},_4e_style:function(a,c,e){if(e!==undefined)return a.css(c,e);a=a[0]||a;return a.style[s(c)]},_4e_remove:function(a,
c){var e=i(a),h=e.parentNode;if(h){if(c)for(;c=e.firstChild;)h.insertBefore(e.removeChild(c),e);h.removeChild(e)}return a},_4e_trim:function(a){r._4e_ltrim(a);r._4e_rtrim(a)},_4e_ltrim:function(a){a=i(a);for(var c;c=a.firstChild;){if(c.nodeType==g.NODE_TEXT){var e=n.ltrim(c.nodeValue),h=c.nodeValue.length;if(e){if(e.length<h){(new B(c))._4e_splitText(h-e.length);a.removeChild(a.firstChild)}}else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){a=i(a);for(var c;c=a.lastChild;){if(c.type==g.NODE_TEXT){var e=
n.rtrim(c.nodeValue),h=c.nodeValue.length;if(e){if(e.length<h){(new B(c))._4e_splitText(e.length);a.removeChild(a.lastChild)}}else{a.removeChild(c);continue}}break}if(!v.ie&&!v.opera)(c=a.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(a){a=i(a);for(var c=a.lastChild;c&&c.nodeType==g.NODE_TEXT&&!x.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==g.NODE_TEXT||r._4e_name(c)!=="br"){c=v.opera?a.ownerDocument.createTextNode(""):
a.ownerDocument.createElement("br");v.gecko&&c.setAttribute("type","_moz");a.appendChild(c)}},_4e_previous:function(a,c){a=i(a);var e;do e=(a=a.previousSibling)&&new B(a);while(e&&c&&!c(e));return e},_4e_last:function(a,c){a=r._4e_wrap(a);if((a=(a=a[0].lastChild)&&new B(a))&&c&&!c(a))a=a._4e_previous(c);return a},_4e_next:function(a,c){a=i(a);var e;do e=(a=a.nextSibling)&&new B(a);while(e&&c&&!c(e));return e},_4e_outerHtml:function(a){a=i(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");
var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(true));return c.innerHTML},_4e_setMarker:function(a,c,e,h){a=r._4e_wrap(a);var p=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",x.guid())._4e_getData("list_marker_id"),j=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[p]=a;j[e]=1;return a._4e_setData(e,h)},_4e_clearMarkers:function(a,c,e){a=m(a);var h=a._4e_getData("list_marker_names"),p=a._4e_getData("list_marker_id");
for(var j in h)a._4e_removeData(j);a._4e_removeData("list_marker_names");if(e){a._4e_removeData("list_marker_id");delete c[p]}},_4e_setData:function(a,c,e){var h=r._4e_getUniqueId(a);(k[h]||(k[h]={}))[c]=e;return a},_4e_getData:function(a,c){a=i(a);return(a=(a=a.getAttribute("_ke_expando"))&&k[a])&&a[c]},_4e_removeData:function(a,c){a=i(a);var e=a.getAttribute("_ke_expando");var h=(e=e&&k[e])&&e[c];typeof h!="undefined"&&e&&delete e[c];x.isEmptyObject(e)&&r._4e_clearData(a);return h||null},_4e_clearData:function(a){a=
i(a);var c=a.getAttribute("_ke_expando");c&&delete k[c];c&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=i(a);var c=a.getAttribute("_ke_expando");if(c)return c;c=x.guid();a.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(a,c,e){a=i(a);var h=a.attributes;e=e||{};for(var p=0;p<h.length;p++){var j=h[p],b=j.nodeName.toLowerCase(),f;if(!(b in e))if(b=="checked"&&(f=r.attr(a,b)))c.attr(b,f);else if(j.specified||v.ie&&j.nodeValue&&b=="value"){f=r.attr(a,b);if(f===null)f=
j.nodeValue;c.attr(b,f)}}if(a.style.cssText!=="")c[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=r._4e_name(a);var c=u.XHTML_DTD;return(a=!c.$nonEditable[a]&&(c[a]||c.span))&&a["#"]},_4e_scrollIntoView:function(a){a=m(a);var c=a[0].ownerDocument,e=r.scrollLeft(c),h=r.scrollTop(c),p=a.offset(),j=p.left;p=p.top;if(r.viewportHeight(c)+h<p||p<h||r.viewportWidth(c)+e<j||j<e)a.scrollIntoView(c)},_4e_getElementsByTagName:function(a,c,e){a=i(a);if(!v.ie&&e)c=e+":"+c;e=[];a=a.getElementsByTagName(c);
for(c=0;c<a.length;c++)e.push(new B(a[c]));return e}};x.DOM._4e_inject=function(a){x.mix(r,a);for(var c in a)a.hasOwnProperty(c)&&function(e){B.prototype[e]=function(){var h=[].slice.call(arguments,0);h.unshift(this);return a[e].apply(null,h)}}(c)};x.DOM._4e_inject(w)});
KISSY.Editor.add("elementpath",function(u){function s(k){var o=null,l=null,i=[];for(k=k;k&&k[0];){if(k[0].nodeType==B.NODE_ELEMENT){if(!this.lastElement)this.lastElement=k;var m=k._4e_name();if(n.ie&&k[0].scopeName!="HTML")m=k[0].scopeName.toLowerCase()+":"+m;if(!l){if(!o&&t[m])o=k;if(g[m])if(!o&&m=="div"&&!d(k))o=k;else l=k}i.push(k);if(m=="body")break}k=k.parent()}this.block=o;this.blockLimit=l;this.elements=i}var x=KISSY,r=x.DOM,v=u.XHTML_DTD,B=u.NODE,n=x.UA,t={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},g={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},d=function(k){k=k[0]||k;k=k.childNodes;for(var o=0,l=k.length;o<l;o++){var i=k[o];if(i.nodeType==B.NODE_ELEMENT&&v.$block[i.nodeName.toLowerCase()])return true}return false};s.prototype={compare:function(k){var o=this.elements;k=k&&k.elements;if(!k||o.length!=k.length)return false;for(var l=0;l<o.length;l++)if(!r._4e_equals(o[l],k[l]))return false;return true},contains:function(k){for(var o=
this.elements,l=0;l<o.length;l++)if(o[l]._4e_name()in k)return o[l];return null}};u.ElementPath=s});
KISSY.Editor.add("walker",function(u){function s(g,d){if(this._.end)return null;var k=this.range,o,l=this.guard,i=this.type,m=g?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;k.trim();if(k.collapsed){this.end();return null}}if(!g&&!this._.guardLTR){var w=k.endContainer,a=new t(w[0].childNodes[k.endOffset]);this._.guardLTR=function(p,j){return(p=n._4e_wrap(p))&&p[0]&&(!j||!n._4e_equals(w,p))&&(!a[0]||!p._4e_equals(a))&&(p[0].nodeType!=B.NODE_ELEMENT||!j||p._4e_name()!=
"body")}}if(g&&!this._.guardRTL){var c=k.startContainer,e=k.startOffset>0&&new t(c[0].childNodes[k.startOffset-1]);this._.guardRTL=function(p,j){return(p=n._4e_wrap(p))&&p[0]&&(!j||!p._4e_equals(c))&&(!e[0]||!p._4e_equals(e))&&(p[0].nodeType!=B.NODE_ELEMENT||!j||p._4e_name()!="body")}}var h=g?this._.guardRTL:this._.guardLTR;o=l?function(p,j){if(h(p,j)===false)return false;return l(p,j)}:h;if(this.current)g=this.current[m](false,i,o);else if(g){g=k.endContainer;if(k.endOffset>0){g=new t(g[0].childNodes[k.endOffset-
1]);if(o(g)===false)g=null}else g=o(g,true)===false?null:g._4e_previousSourceNode(true,i,o)}else{g=k.startContainer;if((g=new t(g[0].childNodes[k.startOffset]))&&g[0]){if(o(g)===false)g=null}else g=o(k.startContainer,true)===false?null:k.startContainer._4e_nextSourceNode(true,i,o)}for(;g&&g[0]&&!this._.end;){this.current=g;if(!this.evaluator||this.evaluator(g)!==false){if(!d)return g}else if(d&&this.evaluator)return false;g=g[m](false,i,o)}this.end();return this.current=null}function x(g){for(var d,
k=null;d=s.call(this,g);)k=d;return k}function r(g){this.range=g;this._={}}var v=KISSY,B=u.NODE,n=v.DOM,t=v.Node;v.augment(r,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,true)},checkForward:function(){return s.call(this,false,true)!==false},checkBackward:function(){return s.call(this,true,true)!==false},lastForward:function(){return x.call(this)},lastBackward:function(){return x.call(this,true)},reset:function(){delete this.current;this._=
{}}});r.blockBoundary=function(g){return function(d){d=n._4e_wrap(d);return!(d&&d[0].nodeType==B.NODE_ELEMENT&&d._4e_isBlockBoundary(g))}};r.listItemBoundary=function(){return this.blockBoundary({br:1})};r.bookmark=function(g,d){function k(o){return o&&o[0]&&o._4e_name()=="span"&&o.attr("_ke_bookmark")}return function(o){var l,i;l=o&&o[0]&&o[0].nodeType==B.NODE_TEXT&&(i=o.parent())&&k(i);l=g?l:l||k(o);return d^l}};r.whitespaces=function(g){return function(d){d=(d=d[0]||d)&&d.nodeType==B.NODE_TEXT&&
!v.trim(d.nodeValue);return g^d}};r.invisible=function(g){var d=r.whitespaces();return function(k){k=d(k)||k[0].nodeType==B.NODE_ELEMENT&&!k[0].offsetHeight;return g^k}};u.Walker=r});
KISSY.Editor.add("range",function(u){function s(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function x(b){var f=b[0].nodeType!=g.NODE_TEXT&&b._4e_name()in w.$removeEmpty,q=!t.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return f||q||b}function r(b){return!p(b)&&!j(b)}function v(b){var f=false,q=o.bookmark(true);return function(y){if(q(y))return true;if(y[0].nodeType==g.NODE_TEXT){if(t.trim(y[0].nodeValue).length)return false}else if(y[0].nodeType==
g.NODE_ELEMENT)if(!h[y._4e_name()])if(!b&&!m.ie&&y._4e_name()=="br"&&!f)f=true;else return false;return true}}function B(b,f){function q(y){return y&&y.nodeName=="span"&&y.getAttribute("_ke_bookmark")}return function(y){var A,C;A=y&&!y.nodeName&&(C=y.parentNode)&&q(C);A=b?A:A||q(y);return f^A}}function n(b){return function(f){f=(f=f[0]||f)&&f.nodeType==g.NODE_TEXT&&!t.trim(f.nodeValue);return b^f}}u.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var t=KISSY,g=u.NODE,d=u.RANGE,k=u.POSITION,o=u.Walker,l=t.DOM,i=u.Utils.getByAddress,m=t.UA,w=u.XHTML_DTD,a=u.ElementPath,c=t.Node,e={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};s.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};t.augment(s,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&l._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,f=this.startOffset;if(b[0].nodeType!=g.NODE_ELEMENT)if(f)f>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;f=this.endOffset;if(b[0].nodeType!=g.NODE_ELEMENT)if(f)f>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,f=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,d.POSITION_BEFORE_START);f&&f._4e_name()=="span"&&
f.attr("_ke_bookmark")&&this.setEndAt(f,d.POSITION_AFTER_END)},setStart:function(b,f){if(b[0].nodeType==g.NODE_ELEMENT&&e[b._4e_name()]){b=b.parent();f=b._4e_index()}this.startContainer=b;this.startOffset=f;if(!this.endContainer){this.endContainer=b;this.endOffset=f}this.updateCollapsed()},setEnd:function(b,f){if(b[0].nodeType==g.NODE_ELEMENT&&e[b._4e_name()]){b=b.parent();f=b._4e_index()+1}this.endContainer=b;this.endOffset=f;if(!this.startContainer){this.startContainer=b;this.startOffset=f}this.updateCollapsed()},
setStartAt:function(b,f){switch(f){case d.POSITION_AFTER_START:this.setStart(b,0);break;case d.POSITION_BEFORE_END:b[0].nodeType==g.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setStartBefore(b);break;case d.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,f){switch(f){case d.POSITION_AFTER_START:this.setEnd(b,0);break;case d.POSITION_BEFORE_END:b[0].nodeType==g.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setEndBefore(b);break;case d.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,f){var q=this.startContainer,y=this.endContainer,A=this.startOffset,C=this.endOffset,H,O;this.optimizeBookmark();if(y[0].nodeType==g.NODE_TEXT)y=y._4e_splitText(C);else if(y[0].childNodes.length>0)if(C>=y[0].childNodes.length){y=new c(y[0].appendChild(this.document.createTextNode("")));
O=true}else y=new c(y[0].childNodes[C]);if(q[0].nodeType==g.NODE_TEXT){q._4e_splitText(A);if(l._4e_equals(q,y))y=new c(q[0].nextSibling)}else if(A)if(A>=q[0].childNodes.length){H=new c(this.document.createTextNode(""));q[0].appendChild(H[0]);q=H;H=true}else q=new c(q[0].childNodes[A].previousSibling);else{H=new c(this.document.createTextNode(""));l.insertBefore(H[0],q[0].firstChild);q=H;H=true}A=q._4e_parents();C=y._4e_parents();var z,D,I;for(z=0;z<A.length;z++){D=A[z];I=C[z];if(D[0]!==I[0])break}for(var L=
f,M,N,S,R=z;R<A.length;R++){M=A[R];if(L&&M[0]!==q[0])N=L.appendChild(M._4e_clone()[0]);for(M=M[0].nextSibling;M;){if(C[R]&&M==C[R][0]||M==y[0])break;S=M.nextSibling;if(b==2)L.appendChild(M.cloneNode(true));else{M.parentNode.removeChild(M);b==1&&L.appendChild(M)}M=S}if(N)L=N}L=f;for(f=z;f<C.length;f++){M=C[f];if(b>0&&M[0]!==y[0])N=L.appendChild(M._4e_clone()[0]);if(!A[f]||M[0].parentNode!==A[f][0].parentNode)for(M=M[0].previousSibling;M;){if(A[f]&&M==A[f][0]||M===q[0])break;S=M.previousSibling;if(b==
2)L.insertBefore(M.cloneNode(true),L.firstChild);else{M.parentNode.removeChild(M);b==1&&L.insertBefore(M,L.firstChild)}M=S}if(N)L=N}if(b==2){I=this.startContainer[0];if(I.nodeType==g.NODE_TEXT&&I.nextSibling&&I.nextSibling.nodeType==g.NODE_TEXT){I.data+=I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}I=this.endContainer[0];if(I.nodeType==g.NODE_TEXT&&I.nextSibling&&I.nextSibling.nodeType==g.NODE_TEXT){I.data+=I.nextSibling.data;I.parentNode.removeChild(I.nextSibling)}}else{if(D&&I&&(q[0].parentNode!=
D[0].parentNode||y[0].parentNode!=I[0].parentNode)){b=I._4e_index();H&&I[0].parentNode==q[0].parentNode&&b--;this.setStart(I.parent(),b)}this.collapse(true)}H&&q._4e_remove();O&&y[0].parentNode&&y._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new s(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=g.NODE_ELEMENT||b.endContainer[0].nodeType!=g.NODE_ELEMENT)return null;var f=new u.Walker(b),q=B(true,undefined),y=n(true);b.evaluator=function(A){return y(A)&&q(A)};b=f.next();f.reset();f=f.previous();return b&&b._4e_equals(f)?b:null},shrink:function(b,f){if(!this.collapsed){b=b||d.SHRINK_TEXT;var q=this.clone(),
y=this.startContainer,A=this.endContainer,C=this.startOffset,H=this.endOffset,O=1,z=1;if(y&&y[0].nodeType==g.NODE_TEXT)if(C)if(C>=y[0].nodeValue.length)q.setStartAfter(y);else{q.setStartBefore(y);O=0}else q.setStartBefore(y);if(A&&A[0].nodeType==g.NODE_TEXT)if(H)if(H>=A[0].nodeValue.length)q.setEndAfter(A);else{q.setEndAfter(A);z=0}else q.setEndBefore(A);q=new o(q);q.evaluator=function(I){I=I[0]||I;return I.nodeType==(b==d.SHRINK_ELEMENT?g.NODE_ELEMENT:g.NODE_TEXT)};var D;q.guard=function(I,L){I=
I[0]||I;if(b==d.SHRINK_ELEMENT&&I.nodeType==g.NODE_TEXT)return false;if(L&&I==D)return false;if(!L&&I.nodeType==g.NODE_ELEMENT)D=I;return true};if(O)(y=q[b==d.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(y,f?d.POSITION_AFTER_START:d.POSITION_BEFORE_START);if(z){q.reset();(q=q[b==d.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(q,f?d.POSITION_BEFORE_END:d.POSITION_AFTER_END)}return!!(O||z)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||b[0].nodeType!=
g.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var f=this.startContainer,q=this.endContainer,y=this.startOffset,A=this.endOffset,C,H;if(!f||!q)return{start:0,end:0};if(b){if(f[0].nodeType==g.NODE_ELEMENT)if((C=new c(f[0].childNodes[y]))&&C[0]&&C[0].nodeType==g.NODE_TEXT&&y>0&&C[0].previousSibling.nodeType==g.NODE_TEXT){f=C;y=0}for(;f[0].nodeType==g.NODE_TEXT&&(H=f._4e_previous())&&H[0].nodeType==g.NODE_TEXT;){f=H;y+=H[0].nodeValue.length}if(!this.collapsed){if(q[0].nodeType==
g.NODE_ELEMENT)if((C=new c(q[0].childNodes[A]))&&C[0]&&C[0].nodeType==g.NODE_TEXT&&A>0&&C[0].previousSibling.nodeType==g.NODE_TEXT){q=C;A=0}for(;q[0].nodeType==g.NODE_TEXT&&(H=q._4e_previous())&&H[0].nodeType==g.NODE_TEXT;){q=H;A+=H[0].nodeValue.length}}}return{start:f._4e_address(b),end:this.collapsed?null:q._4e_address(b),startOffset:y,endOffset:A,normalized:b,is2:true}},createBookmark:function(b){var f,q,y,A;f=new c("<span></span>",null,this.document);f.attr("_ke_bookmark",1);f.css("display","none");
f.html("&nbsp;");if(b){y=t.guid("ke_bm_");f.attr("id",y+"S")}if(!this.collapsed){q=f._4e_clone();q.html("&nbsp;");b&&q.attr("id",y+"E");A=this.clone();A.collapse();A.insertNode(q)}A=this.clone();A.collapse(true);A.insertNode(f);if(q){this.setStartAfter(f);this.setEndBefore(q)}else this.moveToPosition(f,d.POSITION_AFTER_END);return{startNode:b?y+"S":f,endNode:b?y+"E":q,serializable:b}},moveToPosition:function(b,f){this.setStartAt(b,f);this.collapse(true)},trim:function(b,f){var q=this.startContainer,
y=this.startOffset,A=this.collapsed;if((!b||A)&&q[0]&&q[0].nodeType==g.NODE_TEXT){if(y)if(y>=q[0].nodeValue.length){y=q._4e_index()+1;q=q.parent()}else{b=q._4e_splitText(y);y=q._4e_index()+1;q=q.parent();if(l._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(l._4e_equals(q,this.endContainer))this.endOffset+=1}else{y=q._4e_index();q=q.parent()}this.setStart(q,y);if(A){this.collapse(true);return}}q=this.endContainer;y=this.endOffset;if(!(f||A)&&
q[0]&&q[0].nodeType==g.NODE_TEXT){if(y){y>=q.nodeValue.length||q._4e_splitText(y);y=q._4e_index()+1}else y=q._4e_index();q=q.parent();this.setEnd(q,y)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var f=this.startContainer,q=f[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);q?l.insertBefore(b[0]||b,q):f[0].appendChild(b[0]||b);l._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var f=
i(this.document,b.start,b.normalized),q=b.startOffset,y=b.end&&i(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(f,q);y?this.setEnd(y,b):this.collapse(true)}else{f=(q=b.serializable)?t.one("#"+b.startNode,this.document):b.startNode;b=q?t.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(f);f._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,f){var q=this.startContainer,y=this.endContainer;b=l._4e_equals(q,
y)?b&&q[0].nodeType==g.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(q[0].childNodes[this.startOffset]):q:q._4e_commonAncestor(y);return f&&b[0].nodeType==g.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case d.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var f=new c(this.document.body),q,y,A,C,H,O=false,z,D;z=this.startContainer;D=this.startOffset;if(z[0].nodeType==g.NODE_TEXT){if(D){z=!t.trim(z[0].nodeValue.substring(0,D)).length&&z;O=!!z}if(z)if(!(C=z[0].previousSibling))A=
z.parent()}else{if(D)C=z[0].childNodes[D-1]||z[0].lastChild;C||(A=z)}for(;A||C;){if(A&&!C){if(!H&&l._4e_equals(A,b))H=true;if(!f._4e_contains(A))break;if(!O||A.css("display")!="inline"){O=false;if(H)q=A;else this.setStartBefore(A)}C=A[0].previousSibling}for(;C;){z=false;if(C.nodeType==g.NODE_TEXT){D=C.nodeValue;if(/[^\s\ufeff]/.test(D))C=null;z=/[\s\ufeff]$/.test(D)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(O&&w.$removeEmpty[C.nodeName.toLowerCase()]){D=l.text(C);if(/[^\s\ufeff]/.test(D))C=
null;else for(var I=C.all||C.getElementsByTagName("*"),L=0,M;M=I[L++];)if(!w.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}if(C)z=!!D.length}else C=null;if(z)if(O)if(H)q=A;else A&&this.setStartBefore(A);else O=true;if(C){z=C.previousSibling;if(!A&&!z){A=new c(C);C=null;break}C=z}else A=null}if(A)A=A.parent()}z=this.endContainer;D=this.endOffset;A=C=null;H=O=false;if(z[0].nodeType==g.NODE_TEXT){z=!t.trim(z[0].nodeValue.substring(D)).length&&z;O=!(z&&z[0].nodeValue.length);if(z)if(!(C=z[0].nextSibling))A=
z.parent()}else(C=z[0].childNodes[D])||(A=z);for(;A||C;){if(A&&!C){if(!H&&l._4e_equals(A,b))H=true;if(!f._4e_contains(A))break;if(!O||A.css("display")!="inline"){O=false;if(H)y=A;else A&&this.setEndAfter(A)}C=A[0].nextSibling}for(;C;){z=false;if(C.nodeType==g.NODE_TEXT){D=C.nodeValue;if(/[^\s\ufeff]/.test(D))C=null;z=/^[\s\ufeff]/.test(D)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(O&&w.$removeEmpty[C.nodeName.toLowerCase()]){D=l.text(C);if(/[^\s\ufeff]/.test(D))C=null;else{I=C.all||
C.getElementsByTagName("*");for(L=0;M=I[L++];)if(!w.$removeEmpty[M.nodeName.toLowerCase()]){C=null;break}}if(C)z=!!D.length}else C=null;if(z)if(O)if(H)y=A;else this.setEndAfter(A);if(C){z=C.nextSibling;if(!A&&!z){A=new c(C);C=null;break}C=z}else A=null}if(A)A=A.parent()}if(q&&y){b=q._4e_contains(y)?y:q;this.setStartBefore(b);this.setEndAfter(b)}break;case d.ENLARGE_BLOCK_CONTENTS:case d.ENLARGE_LIST_ITEM_CONTENTS:A=new s(this.document);f=new c(this.document.body);A.setStartAt(f,d.POSITION_AFTER_START);
A.setEnd(this.startContainer,this.startOffset);A=new o(A);var N,S,R=o.blockBoundary(b==d.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),Y=function(X){var E=R(X);E||(N=X);return E};q=function(X){var E=Y(X);if(!E&&X[0]&&X._4e_name()=="br")S=X;return E};A.guard=Y;A=A.lastBackward();N=N||f;this.setStartAt(N,N._4e_name()!="br"&&(!A&&this.checkStartOfBlock()||A&&N._4e_contains(A))?d.POSITION_AFTER_START:d.POSITION_AFTER_END);A=this.clone();A.collapse();A.setEndAt(f,d.POSITION_BEFORE_END);A=new o(A);A.guard=b==
d.ENLARGE_LIST_ITEM_CONTENTS?q:Y;N=null;A=A.lastForward();N=N||f;this.setEndAt(N,!A&&this.checkEndOfBlock()||A&&N._4e_contains(A)?d.POSITION_BEFORE_END:d.POSITION_BEFORE_START);S&&this.setEndAfter(S)}},checkStartOfBlock:function(){var b=this.startContainer,f=this.startOffset;if(f&&b[0].nodeType==g.NODE_TEXT)if(t.trim(b[0].nodeValue.substring(0,f)).length)return false;this.trim();b=new a(this.startContainer);f=this.clone();f.collapse(true);f.setStartAt(b.block||b.blockLimit,d.POSITION_AFTER_START);
b=new o(f);b.evaluator=v(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,f=this.endOffset;if(b[0].nodeType==g.NODE_TEXT)if(t.trim(b[0].nodeValue.substring(f)).length)return false;this.trim();b=new a(this.endContainer);f=this.clone();f.collapse(false);f.setEndAt(b.block||b.blockLimit,d.POSITION_BEFORE_END);b=new o(f);b.evaluator=v(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,f){var q=this.clone();q[f==d.START?"setStartAt":"setEndAt"](b,f==d.START?d.POSITION_AFTER_START:d.POSITION_BEFORE_END);b=new o(q);b.evaluator=x;return b[f==d.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,f=this.endContainer,q=this.startOffset,y=this.endOffset,A;if(b[0].nodeType==g.NODE_ELEMENT){A=b[0].childNodes.length;if(A>
q)b=new c(b[0].childNodes[q]);else if(A<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new c(b);b=b._4e_nextSourceNode()||b}}if(f[0].nodeType==g.NODE_ELEMENT){A=f[0].childNodes.length;if(A>y)f=(new c(f[0].childNodes[y]))._4e_previousSourceNode(true);else if(A<1)f=f._4e_previousSourceNode();else{for(f=f[0];f.lastChild;)f=f.lastChild;f=new c(f)}}if(b._4e_position(f)&k.POSITION_FOLLOWING)b=f;return{startNode:b,endNode:f}},fixBlock:function(b,f){var q=this.createBookmark();
f=new c(this.document.createElement(f));this.collapse(b);this.enlarge(d.ENLARGE_BLOCK_CONTENTS);f[0].appendChild(this.extractContents());f._4e_trim();m.ie||f._4e_appendBogus();this.insertNode(f);this.moveToBookmark(q);return f},splitBlock:function(b){var f=new a(this.startContainer),q=new a(this.endContainer),y=f.block,A=q.block,C=null;if(f.blockLimit[0]!==q.blockLimit[0])return null;if(b!="br"){if(!y){y=this.fixBlock(true,b);A=(new a(this.endContainer)).block}A||(A=this.fixBlock(false,b))}b=y&&this.checkStartOfBlock();
f=A&&this.checkEndOfBlock();this.deleteContents();if(y&&l._4e_equals(y,A))if(f){C=new a(this.startContainer);this.moveToPosition(A,d.POSITION_AFTER_END);A=null}else if(b){C=new a(this.startContainer);this.moveToPosition(y,d.POSITION_BEFORE_START);y=null}else{A=this.splitElement(y);!m.ie&&!t.inArray(y._4e_name(),["ul","ol"])&&y._4e_appendBogus()}return{previousBlock:y,nextBlock:A,wasStartOfBlock:b,wasEndOfBlock:f,elementPath:C}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
d.POSITION_BEFORE_END);var f=this.extractContents(),q=b._4e_clone(false);q[0].appendChild(f);q.insertAfter(b);this.moveToPosition(b,d.POSITION_AFTER_END);return q},moveToElementEditablePosition:function(b,f){var q,y=u.XHTML_DTD;if(y.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==g.NODE_ELEMENT;){if(q=b._4e_isEditable())this.moveToPosition(b,f?d.POSITION_BEFORE_END:d.POSITION_AFTER_START);else if(y.$inline[b._4e_name()]){this.moveToPosition(b,f?d.POSITION_AFTER_END:d.POSITION_BEFORE_START);
return true}if((b=y.$empty[b._4e_name()]?b[f?"_4e_previous":"_4e_next"](r):b[f?"_4e_last":"_4e_first"](r))&&b[0].nodeType==g.NODE_TEXT){this.moveToPosition(b,f?d.POSITION_AFTER_END:d.POSITION_BEFORE_START);return true}}return q},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==g.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var h={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},p=new o.whitespaces,j=new o.bookmark;u.Range=s});
KISSY.Editor.add("domiterator",function(u){function s(i){if(!(arguments.length<1)){this.range=i;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var x=KISSY,r=x.UA,v=u.Walker,B=u.Range,n=u.RANGE,t=u.NODE,g=u.ElementPath,d=x.Node,k=x.DOM,o=/^[\r\n\t ]*$/,l=v.bookmark();x.augment(s,{getNextParagraph:function(i){var m,w,a,c,e;if(!this._.lastNode){w=this.range.clone();w.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var h=new v(w),p=v.bookmark(true,true);h.evaluator=p;this._.nextNode=h.next();h=new v(w);h.evaluator=p;h=h.previous();this._.lastNode=h._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==t.NODE_TEXT&&!x.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){p=new B(w.document);p.moveToPosition(this._.lastNode,n.POSITION_AFTER_END);if(p.checkEndOfBlock()){p=new g(p.endContainer);this._.lastNode=(p.block||p.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new d(w.document.createTextNode(""));k.insertAfter(this._.lastNode[0],h[0])}w=null}p=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;p;){var j=false,b=p[0].nodeType!=t.NODE_ELEMENT,f=false;if(b){if(p[0].nodeType==t.NODE_TEXT)if(o.test(p[0].nodeValue))b=false}else{var q=p._4e_name();if(p._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(q=="br")b=true;else if(!w&&!p[0].childNodes.length&&q!="hr"){m=p;a=p._4e_equals(h);break}if(w){w.setEndAt(p,n.POSITION_BEFORE_START);
if(q!="br")this._.nextNode=p}j=true}else{if(p[0].firstChild){if(!w){w=new B(this.range.document);w.setStartAt(p,n.POSITION_BEFORE_START)}p=new d(p[0].firstChild);continue}b=true}}if(b&&!w){w=new B(this.range.document);w.setStartAt(p,n.POSITION_BEFORE_START)}a=(!j||b)&&p._4e_equals(h);if(w&&!j)for(;!p[0].nextSibling&&!a;){q=p.parent();if(q._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){j=true;a||q._4e_equals(h);break}p=q;b=true;a=p._4e_equals(h);f=true}b&&w.setEndAt(p,n.POSITION_AFTER_END);p=p._4e_nextSourceNode(f,
null,h);a=!p;if((j||a)&&w){b=w.getBoundaryNodes();j=new g(w.startContainer);if(b.startNode.parent()._4e_equals(j.blockLimit)&&l(b.startNode)&&l(b.endNode)){w=null;this._.nextNode=null}else break}if(a)break}if(!m){if(!w){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}j=new g(w.startContainer);p=j.blockLimit;b={div:1,th:1,td:1};m=j.block;if((!m||!m[0])&&!this.enforceRealBlocks&&b[p._4e_name()]&&w.checkStartOfBlock()&&w.checkEndOfBlock())m=p;else if(!m||this.enforceRealBlocks&&
m._4e_name()=="li"){m=new d(this.range.document.createElement(i||"p"));m[0].appendChild(w.extractContents());m._4e_trim();w.insertNode(m);c=e=true}else if(m._4e_name()!="li"){if(!w.checkStartOfBlock()||!w.checkEndOfBlock()){m=m._4e_clone(false);m[0].appendChild(w.extractContents());m._4e_trim();e=w.splitBlock();c=!e.wasStartOfBlock;e=!e.wasEndOfBlock;w.insertNode(m)}}else if(!a)this._.nextNode=m._4e_equals(h)?null:w.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,h)}if(c){w=new d(m[0].previousSibling);
if(w[0]&&w[0].nodeType==t.NODE_ELEMENT)if(w._4e_name()=="br")w._4e_remove();else w[0].lastChild&&w[0].lastChild.nodeName.toLowerCase()=="br"&&k._4e_remove(w[0].lastChild)}if(e){w=v.bookmark(false,true);c=new d(m[0].lastChild);if(c[0]&&c[0].nodeType==t.NODE_ELEMENT&&c._4e_name()=="br")if(r.ie||c._4e_previous(w)||c._4e_next(w))c._4e_remove()}if(!this._.nextNode)this._.nextNode=a||m._4e_equals(h)?null:m._4e_nextSourceNode(true,null,h);return m}});B.prototype.createIterator=function(){return new s(this)}});
KISSY.Editor.add("selection",function(u){function s(e){this.document=e;this._={cache:{}};if(B.ie){var h=this.getNative().createRange();if(!h||h.item&&h.item(0).ownerDocument!=e||h.parentElement&&h.parentElement().ownerDocument!=e)this.isInvalid=true}}function x(e){e=new s(e);return!e||e.isInvalid?null:e}function r(e){var h=e.document,p=new g(h.body),j=new g(h.documentElement);if(B.ie){if(B.ie<8||document.documentMode==7)j.on("click",function(A){n._4e_name(A.target)==="html"&&e.getSelection().getRanges()[0].select()});
var b,f;p.on("focusin",function(A){if(A.target.nodeName.toUpperCase()=="BODY")if(b){try{b.select()}catch(C){}b=null}});p.on("focus",function(){f=true;y()});p.on("beforedeactivate",function(A){A.relatedTarget||(f=false)});B.ie<8&&t.on(n._4e_getWin(h),"blur",function(){h.selection.empty()});p.on("mousedown",q);p.on("mouseup",function(){f=true;setTimeout(function(){y(true)},0)});p.on("keydown",q);p.on("keyup",function(){f=true;y()});t.on(h,"selectionchange",y);var q=function(){f=false},y=function(A){if(f){var C=
e.document,H=e.getSelection(),O=H.getType(),z=H&&H.getNative();if(A&&z&&O==d.SELECTION_NONE)if(!C.queryCommandEnabled("InsertImage")){setTimeout(function(){y(true)},50);return}var D;if(!(z&&O==d.SELECTION_TEXT&&(D=n._4e_name(z.createRange().parentElement()))&&D in{input:1,textarea:1})){b=z&&H.getRanges()[0];e._monitor()}}}}else{t.on(h,"mouseup",e._monitor,e);t.on(h,"keyup",e._monitor,e)}}u.SELECTION={};var v=KISSY,B=v.UA,n=v.DOM,t=v.Event,g=v.Node,d=u.SELECTION,k=u.RANGE,o=u.NODE,l=u.Walker,i=u.Range;
d.SELECTION_NONE=1;d.SELECTION_TEXT=2;d.SELECTION_ELEMENT=3;var m={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};v.augment(s,{getNative:B.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=n._4e_getWin(this.document).getSelection())},getType:B.ie?function(){var e=this._.cache;if(e.type)return e.type;
var h=d.SELECTION_NONE;try{var p=this.getNative(),j=p.type;if(j=="Text")h=d.SELECTION_TEXT;if(j=="Control")h=d.SELECTION_ELEMENT;if(p.createRange().parentElement)h=d.SELECTION_TEXT}catch(b){}return e.type=h}:function(){var e=this._.cache;if(e.type)return e.type;var h=d.SELECTION_TEXT,p=this.getNative();if(p){if(p.rangeCount==1){p=p.getRangeAt(0);var j=p.startContainer;if(j==p.endContainer&&j.nodeType==o.NODE_ELEMENT&&p.endOffset-p.startOffset===1&&m[j.childNodes[p.startOffset].nodeName.toLowerCase()])h=
d.SELECTION_ELEMENT}}else h=d.SELECTION_NONE;return e.type=h},getRanges:B.ie?function(){var e=function(h,p){h=h.duplicate();h.collapse(p);p=h.parentElement();for(var j=p.childNodes,b,f=0;f<j.length;f++){var q=j[f];if(q.nodeType==o.NODE_ELEMENT){b=h.duplicate();b.moveToElementText(q);q=b.compareEndPoints("StartToStart",h);var y=b.compareEndPoints("EndToStart",h);b.collapse();if(q>0)break;else if(!q||y==1&&q==-1)return{container:p,offset:f};else if(!y)return{container:p,offset:f+1};b=null}}if(!b){b=
h.duplicate();b.moveToElementText(p);b.collapse(false)}b.setEndPoint("StartToStart",h);h=b.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;h>0;)h-=j[--f].nodeValue.length}catch(A){h=0}return h===0?{container:p,offset:f}:{container:j[f],offset:-h}};return function(){var h=this._.cache;if(h.ranges)return h.ranges;var p=this.getNative(),j=p&&p.createRange(),b=this.getType();if(!p)return[];if(b==d.SELECTION_TEXT){p=new i(this.document);b=e(j,true);p.setStart(new g(b.container),b.offset);b=e(j);p.setEnd(new g(b.container),
b.offset);return h.ranges=[p]}else if(b==d.SELECTION_ELEMENT){h=this._.cache.ranges=[];for(b=0;b<j.length;b++){var f=j.item(b),q=f.parentNode,y=0;for(p=new i(this.document);y<q.childNodes.length&&q.childNodes[y]!=f;y++);p.setStart(new g(q),y);p.setEnd(new g(q),y+1);h.push(p)}return h}return h.ranges=[]}}():function(){var e=this._.cache;if(e.ranges)return e.ranges;var h=[],p=this.getNative();if(!p)return[];for(var j=0;j<p.rangeCount;j++){var b=p.getRangeAt(j),f=new i(this.document);f.setStart(new g(b.startContainer),
b.startOffset);f.setEnd(new g(b.endContainer),b.endOffset);h.push(f)}return e.ranges=h},getStartElement:function(){var e=this._.cache;if(e.startElement!==undefined)return e.startElement;var h,p=this.getNative();switch(this.getType()){case d.SELECTION_ELEMENT:return this.getSelectedElement();case d.SELECTION_TEXT:var j=this.getRanges()[0];if(j)if(!j.collapsed){for(j.optimize();;){h=j.startContainer;if(j.startOffset==(h[0].nodeType===o.NODE_ELEMENT?h[0].childNodes.length:h[0].nodeValue.length)&&!h._4e_isBlockBoundary())j.setStartAfter(h);
else break}h=j.startContainer;if(h[0].nodeType!=o.NODE_ELEMENT)return h.parent();h=new g(h[0].childNodes[j.startOffset]);if(!h[0]||h[0].nodeType!=o.NODE_ELEMENT)return j.startContainer;for(j=h[0].firstChild;j&&j.nodeType==o.NODE_ELEMENT;){h=new g(j);j=j.firstChild}return h}if(B.ie){j=p.createRange();j.collapse(true);h=j.parentElement()}else if((h=p.anchorNode)&&h.nodeType!=o.NODE_ELEMENT)h=h.parentNode}return e.startElement=h?n._4e_wrap(h):null},getSelectedElement:function(){var e=this._.cache;if(e.selectedElement!==
undefined)return e.selectedElement;var h=this,p;if(B.ie){p=h.getNative().createRange();p=p.item&&p.item(0)}p||(p=function(){for(var j=h.getRanges()[0],b,f,q=2;q&&!((b=j.getEnclosedNode())&&b[0].nodeType==o.NODE_ELEMENT&&m[b._4e_name()]&&(f=b));q--)j.shrink(k.SHRINK_ELEMENT);return f&&f[0]}());return e.selectedElement=n._4e_wrap(p)},reset:function(){this._.cache={}},selectElement:function(e){var h;if(B.ie)try{h=this.document.body.createControlRange();h.addElement(e[0]);h.select()}catch(p){h=this.document.body.createTextRange();
h.moveToElementText(e[0]);h.select()}finally{}else{h=this.document.createRange();h.selectNode(e[0]);e=this.getNative();e.removeAllRanges();e.addRange(h)}this.reset()},selectRanges:function(e){if(B.ie)e[0]&&e[0].select();else{var h=this.getNative();if(!h)return;h.removeAllRanges();for(var p=0;p<e.length;p++){var j=e[p],b=this.document.createRange(),f=j.startContainer;j.collapsed&&B.gecko&&B.gecko<1.09&&f[0].nodeType==o.NODE_ELEMENT&&!f[0].childNodes.length&&f[0].appendChild(this.document.createTextNode(""));
b.setStart(f[0],j.startOffset);b.setEnd(j.endContainer[0],j.endOffset);h.addRange(b)}}this.reset()},createBookmarks2:function(e){for(var h=[],p=this.getRanges(),j=0;j<p.length;j++)h.push(p[j].createBookmark2(e));return h},createBookmarks:function(e){for(var h=[],p=this.getRanges(),j=p.length,b=this.document,f,q=0;q<j;q++){h.push(f=p[q].createBookmark(e,true));var y=(e=f.serializable)?v.one("#"+f.startNode,b):f.startNode;f=e?v.one("#"+f.endNode,b):f.endNode;for(var A=q+1;A<j;A++){var C=p[A],H=C.startContainer,
O=C.endContainer;n._4e_equals(H,y.parent())&&C.startOffset++;n._4e_equals(H,f.parent())&&C.startOffset++;n._4e_equals(O,y.parent())&&C.endOffset++;n._4e_equals(O,f.parent())&&C.endOffset++}}return h},selectBookmarks:function(e){for(var h=[],p=0;p<e.length;p++){var j=new i(this.document);j.moveToBookmark(e[p]);h.push(j)}this.selectRanges(h);return this},getCommonAncestor:function(){var e=this.getRanges();return e[0].startContainer._4e_commonAncestor(e[e.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
u.Selection=s;var w={table:1,tbody:1,tr:1},a=l.whitespaces(true),c=/\ufeff|\u00a0/;i.prototype.select=B.ie?function(e){var h=this.collapsed,p,j;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var b=this.startContainer[0].childNodes[this.startOffset];if(b.nodeType==o.NODE_ELEMENT){(new s(this.document)).selectElement(new g(b));return}}if(this.startContainer[0].nodeType==o.NODE_ELEMENT&&this.startContainer._4e_name()in w||this.endContainer[0].nodeType==o.NODE_ELEMENT&&
this.endContainer._4e_name()in w)this.shrink(o.NODE_ELEMENT,true);var f=this.createBookmark();b=f.startNode;var q;if(!h)q=f.endNode;f=this.document.body.createTextRange();f.moveToElementText(b[0]);f.moveStart("character",1);if(q){e=this.document.body.createTextRange();e.moveToElementText(q[0]);f.setEndPoint("EndToEnd",e);f.moveEnd("character",-1)}else{for(p=b[0].nextSibling;p&&!a(p);)p=p.nextSibling;p=!(p&&p.nodeValue&&p.nodeValue.match(c))&&(e||!b[0].previousSibling||b[0].previousSibling&&n._4e_name(b[0].previousSibling)==
"br");j=this.document.createElement("span");j.innerHTML="&#65279;";j=new g(j);n.insertBefore(j[0],b[0]);p&&n.insertBefore(this.document.createTextNode("\ufeff"),b[0])}this.setStartBefore(b);b._4e_remove();if(h){if(p){f.moveStart("character",-1);f.select();this.document.selection.clear()}else f.select();if(j){this.moveToPosition(j,k.POSITION_BEFORE_START);j._4e_remove()}}else{this.setEndBefore(q);q._4e_remove();f.select()}}:function(){var e=this.startContainer;this.collapsed&&e[0].nodeType==o.NODE_ELEMENT&&
!e[0].childNodes.length&&e[0].appendChild(this.document.createTextNode(""));var h=this.document.createRange();h.setStart(e[0],this.startOffset);try{h.setEnd(this.endContainer[0],this.endOffset)}catch(p){if(p.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);h.setEnd(this.endContainer[0],this.endOffset)}else throw p;}e=x(this.document).getNative();e.removeAllRanges();e.addRange(h)};u.on("instanceCreated",function(e){r(e.editor)})});
KISSY.Editor.add("styles",function(u){function s(E,F){for(var G in E)E[G]=E[G].replace(X,function(K,J){return F[J]})}function x(E,F){if(F){E=y.clone(E);s(E.attributes,F);s(E.styles,F)}F=this.element=(E.element||"*").toLowerCase();this.type=F=="#"||S[F]?C.STYLE_BLOCK:R[F]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:E}}function r(E,F){F=F?this.removeFromRange:this.applyToRange;E.body.focus();E=new O(E);for(var G=E.getRanges(),K=0;K<G.length;K++)F.call(this,G[K]);E.selectRanges(G)}function v(E,
F){var G=E.element;if(G=="*")G="span";F=new L(F.createElement(G));return B(F,E)}function B(E,F){var G=F._.definition;F=G.attributes;G=x.getStyleText(G);if(F)for(var K in F)E.attr(K,F[K]);if(G)E[0].style.cssText=G;return E}function n(E){var F=E.createBookmark(true),G=E.createIterator();G.enforceRealBlocks=true;G.enlargeBr=true;for(var K,J=E.document;K=G.getNextParagraph();){var P=v(this,J);k(K,P)}E.moveToBookmark(F)}function t(E,F,G){var K="",J="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(P,Q,T){Q&&(K=Q);T&&(J=T);return""});return K+E.replace(F,G)+J}function g(E,F){var G=E.html();G=t(G,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");G=G.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");G=G.replace(/([ \t\n\r]+|&nbsp;)/g," ");G=G.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){E=E[0].ownerDocument.createElement("div");E.appendChild(F[0]);F[0].outerHTML="<pre>"+G+"</pre>";F=new L(E.firstChild);F._4e_remove()}else F.html(G);return F}function d(E){var F=[];t(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(G,K,J){return K+"</pre>"+J+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(G,K){F.push(K)});return F}function k(E,F){var G=F._4e_name=="pre",K=E._4e_name=="pre",J=!G&&K;if(G&&!K)F=g(E,F);else if(J)F=l(d(E),F);else E._4e_moveChildren(F);E[0].parentNode.replaceChild(F[0],E[0]);G&&o(F)}function o(E){var F;if((F=E._4e_previousSourceNode(true,z.NODE_ELEMENT))&&F._4e_name()=="pre"){var G=t(F.html(),/\n$/,"")+"\n\n"+t(E.html(),/^\n/,"");if(M.ie)E[0].outerHTML="<pre>"+G+"</pre>";else E.html(G);
F._4e_remove()}}function l(E,F){for(var G=F[0].ownerDocument.createDocumentFragment(),K=0;K<E.length;K++){var J=E[K];J=J.replace(/(\r\n|\r)/g,"\n");J=t(J,/^[ \t]*\n/,"");J=t(J,/\n$/,"");J=t(J,/^[ \t]+|[ \t]+$/g,function(Q,T){return Q.length==1?"&nbsp;":T?" "+(new Array(Q.length)).join("&nbsp;"):(new Array(Q.length)).join("&nbsp;")+" "});J=J.replace(/\n/g,"<br>");J=J.replace(/[ \t]{2,}/g,function(Q){return(new Array(Q.length)).join("&nbsp;")+" "});var P=F._4e_clone();P.html(J);G.appendChild(P[0])}return G}
function i(E){var F=E.document;if(E.collapsed){F=v(this,F);E.insertNode(F);E.moveToPosition(F,H.POSITION_BEFORE_END)}else{var G=this.element,K=this._.definition,J,P=u.XHTML_DTD[G]||(J=true,u.XHTML_DTD.span),Q=E.createBookmark();E.enlarge(H.ENLARGE_ELEMENT);E.trim();var T=E.createBookmark(),da=T.startNode;T=T.endNode;for(var V=da,Z;V&&V[0];){var U=false;if(A._4e_equals(V,T)){V=null;U=true}else{var W=V[0].nodeType,ba=W==z.NODE_ELEMENT?V._4e_name():null;if(ba&&V.attr("_ke_bookmark")){V=V._4e_nextSourceNode(true);
continue}if(!ba||P[ba]&&(V._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule(V))){var ca=V.parent();if(ca&&ca[0]&&((u.XHTML_DTD[ca._4e_name()]||u.XHTML_DTD.span)[G]||J)&&(!K.parentRule||K.parentRule(ca))){if(!Z&&(!ba||!u.XHTML_DTD.$removeEmpty[ba]||(V._4e_position(T)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+
D.POSITION_IS_CONTAINED)){Z=new I(F);Z.setStartBefore(V)}if(W==z.NODE_TEXT||W==z.NODE_ELEMENT&&!V[0].childNodes.length){W=V;for(var $;!W[0].nextSibling&&($=W.parent(),P[$._4e_name()])&&($._4e_position(da)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!K.childRule||K.childRule($));)W=$;Z.setEndAfter(W);W[0].nextSibling||(U=true)}}else U=true}else U=true;V=V._4e_nextSourceNode()}if(U&&Z&&!Z.collapsed){U=v(this,
F);for(W=Z.getCommonAncestor();U&&W&&U[0]&&W[0];){if(W._4e_name()==G){for(var aa in K.attributes)U.attr(aa)==W.attr(aa)&&U[0].removeAttribute(aa);for(var ea in K.styles)U._4e_style(ea)==W._4e_style(ea)&&U._4e_style(ea,"");if(!U._4e_hasAttributes()){U=null;break}}W=W.parent()}if(U){U[0].appendChild(Z.extractContents());b(this,U);Z.insertNode(U);U._4e_mergeSiblings();M.ie||U[0].normalize()}Z=null}}da._4e_remove();T._4e_remove();E.moveToBookmark(Q);E.shrink(H.SHRINK_TEXT)}}function m(E){E.enlarge(H.ENLARGE_ELEMENT);
var F=E.createBookmark(),G=F.startNode;if(E.collapsed){for(var K=new N(G.parent()),J,P=0,Q;P<K.elements.length&&(Q=K.elements[P]);P++){if(Q==K.block||Q==K.blockLimit)break;if(this.checkElementRemovable(Q)){var T=E.checkBoundaryOfElement(Q,H.END),da=!T&&E.checkBoundaryOfElement(Q,H.START);if(da||T){J=Q;J.match=da?"start":"end"}else{Q._4e_mergeSiblings();Q._4e_name()==this.element?p(this,Q):f(Q,h(this)[Q._4e_name()])}}}if(J&&J[0]){Q=G;for(P=0;;P++){T=K.elements[P];if(A._4e_equals(T,J))break;else if(T.match)continue;
else T=T._4e_clone();T[0].appendChild(Q[0]);Q=T}A[J.match=="start"?"insertBefore":"insertAfter"](Q[0],J[0])}}else{var V=F.endNode,Z=this;K=function(){for(var U=new N(G.parent()),W=new N(V.parent()),ba=null,ca=null,$=0;$<U.elements.length;$++){var aa=U.elements[$];if(aa==U.block||aa==U.blockLimit)break;if(Z.checkElementRemovable(aa))ba=aa}for($=0;$<W.elements.length;$++){aa=W.elements[$];if(aa==W.block||aa==W.blockLimit)break;if(Z.checkElementRemovable(aa))ca=aa}ca&&V._4e_breakParent(ca);ba&&G._4e_breakParent(ba)};
K();for(J=new L(G[0].nextSibling);J[0]!==V[0];){P=J._4e_nextSourceNode();if(J[0]&&J[0].nodeType==z.NODE_ELEMENT&&this.checkElementRemovable(J)){J._4e_name()==this.element?p(this,J):f(J,h(this)[J._4e_name()]);if(P[0].nodeType==z.NODE_ELEMENT&&P._4e_contains(G)){K();P=new L(G[0].nextSibling)}}J=P}}E.moveToBookmark(F)}function w(E){var F={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,K,J){F[K]=J});return F}function a(E,F){typeof E=="string"&&(E=w(E));typeof F==
"string"&&(F=w(F));for(var G in E)if(!(G in F&&(F[G]==E[G]||E[G]=="inherit"||F[G]=="inherit")))return false;return true}function c(E,F){if(F!==false){F=document.createElement("span");F.style.cssText=E;E=F.style.cssText||""}else E=E;return E.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function e(E){var F=E._AC;if(F)return F;F={};var G=0,K=E.attributes;if(K)for(var J in K){G++;F[J]=K[J]}if(K=x.getStyleText(E)){F.style||G++;F.style=K}F._length=G;return E._AC=
F}function h(E){if(E._.overrides)return E._.overrides;var F=E._.overrides={},G=E._.definition.overrides;if(G){y.isArray(G)||(G=[G]);for(var K=0;K<G.length;K++){var J=G[K],P,Q;if(typeof J=="string")P=J.toLowerCase();else{P=J.element?J.element.toLowerCase():E.element;Q=J.attributes}J=F[P]||(F[P]={});if(Q){J=J.attributes=J.attributes||[];for(var T in Q)J.push([T.toLowerCase(),Q[T]])}}}return F}function p(E,F){var G=E._.definition,K=y.mix(y.mix({},G.attributes),h(E)[F._4e_name()]);G=G.styles;var J=y.isEmptyObject(K)&&
y.isEmptyObject(G);for(var P in K)if(!((P=="class"||E._.definition.fullMatch)&&F.attr(P)!=j(P,K[P]))){J=J||!!F._4e_hasAttribute(P);F.removeAttr(P)}for(var Q in G)if(!(E._.definition.fullMatch&&F._4e_style(Q)!=j(Q,G[Q],true))){J=J||!!F._4e_style(Q);F._4e_style(Q,"")}J&&q(F)}function j(E,F,G){var K=new L("<span></span>");K[G?"_4e_style":"attr"](E,F);return K[G?"_4e_style":"attr"](E)}function b(E,F){for(var G=h(E),K=F.all(E.element),J=K.length;--J>=0;)p(E,new L(K[J]));for(var P in G)if(P!=E.element){K=
F.all(P);for(J=K.length-1;J>=0;J--){var Q=new L(K[J]);f(Q,G[P])}}}function f(E,F){if(F=F&&F.attributes)for(var G=0;G<F.length;G++){var K=F[G][0],J;if(J=E.attr(K)){var P=F[G][1];if(P===null||P.test&&P.test(J)||typeof P=="string"&&J==P)E[0].removeAttribute(K)}}q(E)}function q(E){if(!E._4e_hasAttributes()){var F=E[0].firstChild,G=E[0].lastChild;E._4e_remove(true);if(F){F.nodeType==z.NODE_ELEMENT&&A._4e_mergeSiblings(F);G&&!F===G&&G.nodeType==z.NODE_ELEMENT&&A._4e_mergeSiblings(G)}}}var y=KISSY,A=y.DOM,
C=u.STYLE={},H=u.RANGE,O=u.Selection,z=u.NODE,D=u.POSITION,I=u.Range,L=y.Node,M=y.UA,N=u.ElementPath,S={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},R={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Y=/\s*(?:;\s*|$)/,X=/#\((.+?)\)/g;C.STYLE_BLOCK=1;C.STYLE_INLINE=2;C.STYLE_OBJECT=3;x.prototype={apply:function(E){r.call(this,E,false)},remove:function(E){r.call(this,E,true)},applyToRange:function(E){return(this.applyToRange=this.type==C.STYLE_INLINE?
i:this.type==C.STYLE_BLOCK?n:this.type==C.STYLE_OBJECT?null:null).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==C.STYLE_INLINE?m:null).call(this,E)},applyToObject:function(E){B(E,this)},checkElementRemovable:function(E,F){if(!E)return false;var G=this._.definition;if(E._4e_name()==this.element){if(!F&&!E._4e_hasAttributes())return true;G=e(G);if(G._length){for(var K in G)if(K!="_length"){var J=E.attr(K)||"";if(K=="style"?a(G[K],c(J,false)):G[K]==J){if(!F)return true}else if(F)return false}if(F)return true}else return true}if(G=
h(this)[E._4e_name()]){if(!(G=G.attributes))return true;for(F=0;F<G.length;F++){K=G[F][0];if(K=E.attr(K)){J=G[F][1];if(J===null||typeof J=="string"&&K==J||J.test&&J.test(K))return true}}}return false},checkActive:function(E){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,true);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var F=E.elements,G=0,K;G<F.length;G++){K=F[G];if(!(this.type==C.STYLE_INLINE&&(A._4e_equals(K,E.block)||A._4e_equals(K,E.blockLimit))))if(!(this.type==
C.STYLE_OBJECT&&!(K._4e_name()in R)))if(this.checkElementRemovable(K,true))return true}}return false}};x.getStyleText=function(E){var F=E._ST;if(F)return F;F=E.styles;var G=E.attributes&&E.attributes.style||"",K="";if(G.length)G=G.replace(Y,";");for(var J in F){var P=F[J],Q=(J+":"+P).replace(Y,";");if(P=="inherit")K+=Q;else G+=Q}if(G.length)G=c(G);G+=K;return E._ST=G};u.Style=x});
KISSY.Editor.add("bubbleview",function(){function u(g){u.superclass.constructor.apply(this,arguments);g.init&&g.init.call(this)}function s(g){g=t[g];if(!g.bubble)g.bubble=new u(g.cfg);return g.bubble}var x=KISSY.Editor,r=KISSY,v=r.Event,B=r.DOM,n=r.Node;if(!x.BubbleView){var t={};u.attach=function(g){var d=g.pluginInstance,k=g.pluginName;g=d.editor;var o=t[k];if(o){var l=o.cfg.func,i=t[k].bubble;g.on("selectionChange",function(m){m=m.path;var w=m.elements;if(m&&w)if(m=m.lastElement)if(m=l(m)){i=s(k);
i._selectedEl=m;i._plugin=d;i.show()}else if(i){i._selectedEl=i._plugin=null;i.hide()}});v.on(B._4e_getWin(g.document),"scroll blur",function(){i&&i.hide()});v.on(document,"click",function(){i&&i.hide()})}};u.register=function(g){t[g.pluginName]={cfg:g}};u.ATTRS={focusMgr:{value:false},draggable:{value:false}};r.extend(u,x.SimpleOverlay,{_createEl:function(){var g=(new n('<div class="ke-bubbleview-bubble" onmousedown="return false;"></div>')).appendTo(document.body);this.el=g;this.set("el",g)},show:function(){var g=
this._selectedEl,d=g._4e_getOffset(document);d.top+=g.height()+5;u.superclass.show.call(this,d)}});x.BubbleView=u}});
KISSY.Editor.add("button",function(){function u(v){u.superclass.constructor.call(this,v);this._init()}var s=KISSY.Editor,x=KISSY,r=x.Node;if(!s.TripleButton){u.ON="on";u.OFF="off";u.DISABLED="disabled";u.ON_CLASS="ke-triplebutton-on";u.OFF_CLASS="ke-triplebutton-off";u.DISABLED_CLASS="ke-triplebutton-disabled";u.ATTRS={state:{value:"off"},container:{},text:{},contentCls:{},cls:{}};x.extend(u,x.Base,{_init:function(){var v=this.get("container")[0]||this.get("container");this.el=new r("<a class='ke-triplebutton ke-triplebutton-off' href='#' role=\"button\"></a>");
this.el._4e_unselectable();this._attachCls();if(this.get("text"))this.el.html(this.get("text"));else if(this.get("contentCls")){this.el.html("<span class='ke-toolbar-item "+this.get("contentCls")+"'></span>");this.el.one("span")._4e_unselectable()}this.get("title")&&this.el.attr("title",this.get("title"));v.appendChild(this.el[0]);this.el.on("click",this._action,this);this.on("afterStateChange",this._stateChange,this)},_attachCls:function(){var v=this.get("cls");v&&this.el.addClass(v)},_stateChange:function(v){this["_"+
v.newVal]();this._attachCls()},_action:function(v){this.fire(this.get("state")+"Click",v);this.fire("click",v);v.preventDefault()},_on:function(){this.el[0].className="ke-triplebutton ke-triplebutton-on"},_off:function(){this.el[0].className="ke-triplebutton ke-triplebutton-off"},_disabled:function(){this.el[0].className="ke-triplebutton ke-triplebutton-disabled"}});s.TripleButton=u}});
KISSY.Editor.add("clipboard",function(u){var s=KISSY.Editor,x=KISSY,r=x.Node,v=x.UA,B=s.Range,n=s.RANGE,t=x.Event;s.Paste||function(){function g(d){this.editor=d;this._init()}x.augment(g,{_init:function(){var d=this.editor;v.ie?t.on(d.document,"keydown",this._paste,this):t.on(d.document,"paste",this._paste,this)},_paste:function(d){if(!(d.type==="keydown"&&!(d.keyCode===86&&(d.ctrlKey||d.metaKey)))){var k=this,o=k.editor,l=o.document;if(k._running)d.halt();else{var i=o.getSelection();d=new B(l);var m=
new r(v.webkit?"<body></body>":"<div></div>",null,l);v.webkit&&m[0].appendChild(l.createTextNode("\u00a0"));l.body.appendChild(m[0]);m.css({position:"absolute",top:i.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});m.css("left","-1000px");var w=i.createBookmarks();d.setStartAt(m,n.POSITION_AFTER_START);d.setEndAt(m,n.POSITION_BEFORE_END);d.select(true);k._running=true;setTimeout(function(){m._4e_remove();var a;m=v.webkit&&(a=m._4e_first())&&a.hasClass("Apple-style-span")?
a:m;i.selectBookmarks(w);o.insertHtml(m.html());k._running=false},0)}}}});s.Paste=g}();u.addPlugin(function(){new s.Paste(u)})});
KISSY.Editor.add("color",function(u){function s(p){return("0"+p).slice(p.length-1,p.length+1)}function x(p){p=v.trim(p);if(p.charAt(0)=="#")p=p.substring(1);p=p.replace(/\s+/g,"");var j="";if(/^[0-9a-f]{3,3}$/i.test(p))j=p.replace(/[0-9a-f]/ig,function(f){return f+f});else{var b=p.match(k);if(b&&b[0])for(p=1;p<4;p++)j+=s(parseInt(b[p]).toString(16));else j=p}return"#"+j.toLowerCase()}for(var r=KISSY.Editor,v=KISSY,B=v.Node,n=v.Event,t=r.SimpleOverlay,g=r.Style,d=v.DOM,k=/^rgb\((\d+),(\d+),(\d+)\)$/i,
o="000,800000,8B4513,2F4F4F,008080,000080,4B0082,696969,B22222,A52A2A,DAA520,006400,40E0D0,0000CD,800080,808080,F00,FF8C00,FFD700,008000,0FF,00F,EE82EE,A9A9A9,FFA07A,FFA500,FFFF00,00FF00,AFEEEE,ADD8E6,DDA0DD,D3D3D3,FFF0F5,FAEBD7,FFFFE0,F0FFF0,F0FFFF,F0F8FF,E6E6FA,FFF".split(/,/),l={element:"span",styles:{color:"#(color)"},overrides:[{element:"font",attributes:{color:null}}]},i={element:"span",styles:{"background-color":"#(color)"}},m="<div class='ke-popup-wrap ke-color-wrap'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\"><span>\u6e05\u9664</span></a><table>",
w={},a={},c=0;c<5;c++){m+="<tr>";for(var e=0;e<8;e++){var h=x(o[8*c+e]);m+="<td>";m+="<a href='javascript:void(0);' class='ke-color-a'><span style='background-color:"+h+"'></span></a>";m+="</td>";w[h]=new g(i,{color:h});a[h]=new g(l,{color:h})}m+="</tr>"}w.inherit=new g(i,{color:"inherit"});a.inherit=new g(l,{color:"inherit"});m+="</table></div>";r.ColorSupport||function(){function p(b){p.superclass.constructor.call(this,b);this._init()}var j=r.TripleButton;p.ATTRS={editor:{},styles:{},contentCls:{},
text:{}};v.extend(p,v.Base,{_init:function(){var b=this.get("editor").toolBarDiv;b=new j({container:b,title:this.get("title"),contentCls:this.get("contentCls")});b.on("offClick",this._showColors,this);this.el=b;r.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(b){var f=this;d._4e_ascendant(b.target,function(q){return q[0]===f.el.el[0]},true)||this.colorWin.hide()},_selectColor:function(b){b.halt();var f=this.get("editor");b=b.target;if(d._4e_name(b)=="span"||d._4e_name(b)=="a"){b=new B(b);
if(b._4e_name()=="a")b=b.one("span");var q=this.get("styles");f.fire("save");b._4e_style("background-color")?q[x(b._4e_style("background-color"))].apply(f.document):q.inherit.remove(f.document);f.fire("save");this.colorWin.hide()}},_prepare:function(){this.colorPanel=new B(m);this.colorWin=new t({el:this.colorPanel,mask:false,focusMgr:false});document.body.appendChild(this.colorPanel[0]);this.colorPanel.on("click",this._selectColor,this);n.on(document,"click",this._hidePanel,this);n.on(u.document,
"click",this._hidePanel,this)},_real:function(){var b=this.el.el.offset();b.top+=this.el.el.height()+5;if(b.left+this.colorPanel.width()>d.viewportWidth()-60)b.left=d.viewportWidth()-this.colorPanel.width()-60;this.colorWin.show(b)},_showColors:function(b){this._prepare(b)}});r.ColorSupport=p}();u.addPlugin(function(){new r.ColorSupport({editor:u,styles:w,title:"\u80cc\u666f\u989c\u8272",contentCls:"ke-toolbar-bgcolor",text:"bgcolor"});new r.ColorSupport({editor:u,styles:a,title:"\u6587\u672c\u989c\u8272",
contentCls:"ke-toolbar-color",text:"color"})})});
KISSY.Editor.add("contextmenu",function(){function u(d){this.cfg=r.clone(d);x.Utils.lazyRun(this,"_prepareShow","_realShow")}function s(d,k){for(var o=0;o<k.length;o++){var l=k[o];if(r.isFunction(l)){if(l(new v(d)))return true}else if(B.test(d,l))return true}return false}var x=KISSY.Editor,r=KISSY,v=r.Node,B=r.DOM,n=r.Event;if(!x.ContextMenu){var t=[];u.register=function(d,k){var o=new u(k);t.push({doc:d,rules:k.rules||[],instance:o});if(!d.ke_contextmenu){d.ke_contextmenu=1;n.on(d,"mousedown",u.hide);
n.on(d,"contextmenu",function(l){u.hide.call(this);for(var i=new v(l.target);i;){var m=false;if(i._4e_name()=="body")break;for(var w=0;w<t.length;w++){var a=t[w].instance,c=t[w].rules;if(d===t[w].doc&&s(i[0],c)){l.preventDefault();m=true;setTimeout(function(){a.show(x.Utils.getXY(l.pageX,l.pageY,d,document))},30);break}}if(m)break;i=i.parent()}})}return o};u.hide=function(){for(var d=0;d<t.length;d++){var k=t[d].instance;this===t[d].doc&&k.hide()}};var g=x.SimpleOverlay;r.augment(u,{_init:function(){var d=
this,k=d.cfg,o=k.funcs;d.elDom=new v("<div class='ke-menu' onmousedown='return false;'></div>");var l=d.elDom;l.css("width",k.width);document.body.appendChild(l[0]);d.el=new g({el:l});for(var i in o){k=new v("<a href='#'>"+i+"</a>");l[0].appendChild(k[0]);(function(m,w){m._4e_unselectable();m.on("click",function(a){d.hide();a.halt();setTimeout(w,30)})})(k,o[i])}},hide:function(){this.el&&this.el.hide()},_realShow:function(d){this.el.show(d)},_prepareShow:function(){this._init()},show:function(d){this._prepareShow(d)}});
x.ContextMenu=u}});
KISSY.Editor.add("dd",function(){function u(){u.superclass.constructor.apply(this,arguments);this._init()}function s(){s.superclass.constructor.apply(this,arguments);this._init()}function x(){x.superclass.constructor.apply(this,arguments)}var r=KISSY,v=r.Editor,B=r.Event,n=r.DOM,t=r.Node;if(!v.DD){v.DD={};u.ATTRS={timeThred:{},activeDrag:{},drags:{value:{}}};r.extend(u,r.Base,{_init:function(){v.Utils.lazyRun(this,"_prepare","_real")},reg:function(d){var k=this.get("drags");if(!d[0].id)d[0].id=r.guid("drag-");
k[d[0].id]=d;this._prepare()},_move:function(d){var k=this.get("activeDrag");k&&k._move(d)},_start:function(d){this.set("activeDrag",d);this._pg.css({display:"",height:n.docHeight()})},_end:function(d){var k=this.get("activeDrag");if(k){k._end(d);this.set("activeDrag",null);this._pg.css({display:"none"})}},_prepare:function(){this._pg=(new t("<div style='background-color:red;position:absolute;left:0;width:100%;top:0;z-index:9999;'></div>")).appendTo(document.body);this._pg.css("opacity",0);B.on(document,
"mousemove",v.Utils.throttle(this._move,this,10));B.on(document,"mouseup",this._end,this)},_real:function(){}});v.DD.DDM=new u;var g=v.DD.DDM;s.ATTRS={node:{},handlers:{value:{}}};r.extend(s,r.Base,{_init:function(){var d=this.get("node"),k=this.get("handlers");g.reg(d);if(r.isEmptyObject(k))k[d[0].id]=d;for(var o in k)if(k.hasOwnProperty(o)){var l=k[o],i=l.css("cursor");if(!i||i==="auto")l.css("cursor","move");l._4e_unselectable()}d.on("mousedown",this._handleMouseDown,this);d.on("mouseup",function(){g._end()})},
_check:function(d){var k=this.get("handlers");for(var o in k)if(k.hasOwnProperty(o))if(k[o]._4e_equals(d))return true;return false},_handleMouseDown:function(d){if(this._check(new t(d.target))){d.halt();g._start(this);var k=this.get("node"),o=d.pageX;d=d.pageY;k=k.offset();this.startMousePos={left:o,top:d};this.startNodePos=k;this._diff={left:o-k.left,top:d-k.top};this.fire("start")}},_move:function(d){this.fire("move",d)},_end:function(){}});r.extend(x,s,{_init:function(){x.superclass._init.apply(this,
arguments);var d=this.get("node"),k=this;k.on("move",function(o){d.offset({left:o.pageX-k._diff.left,top:o.pageY-k._diff.top})})}});v.Draggable=s;v.Drag=x}});
KISSY.Editor.add("draft",function(u){var s=KISSY,x=s.Editor;x.Draft||function(){function r(d,k,o){for(d+="";d.length<k;)d=o+d;return d}function v(d){if(s.isNumber(d))d=new Date(d);return d instanceof Date?[d.getFullYear(),"-",r(d.getMonth()-1,2,"0"),"-",r(d.getDay(),2,"0")," ",r(d.getHours(),2,"0"),":",r(d.getMinutes(),2,"0"),":",r(d.getSeconds(),2,"0")].join(""):d}function B(d){this.editor=d;this._init()}var n=s.Node,t=s.JSON,g=window[x.STORE];s.augment(B,{_init:function(){var d=this,k=d.editor,
o=k.statusDiv;o=(new n("<div style='position:absolute;right:30px;bottom:0;width:600px'><span style=' vertical-align:middle;'>\u5185\u5bb9\u6b63\u6587\u6bcf5\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(o);d.timeTip=(new n("<span style=' vertical-align:middle;margin:0 10px;'>")).appendTo(o);k=new x.Select({container:o,doc:k.document,width:"100px",popUpWidth:"220px",title:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"});o=new x.TripleButton({text:"\u7acb\u5373\u4fdd\u5b58",
title:"\u7acb\u5373\u4fdd\u5b58",container:o});var l=g.getItem("ke-draft-save"),i=[];d.versions=k;if(l)i=s.isString(l)?t.parse(decodeURIComponent(l)):l;d.drafts=i;d.sync();o.on("click",function(){d.save(false)});setInterval(function(){d.save(true)},3E5);k.on("click",d.recover,d)},sync:function(){var d=this.timeTip,k=this.versions,o=this.drafts;o.length>5&&o.splice(0,o.length-5);for(var l=[],i,m=0;m<o.length;m++){i=o[m];i=(i.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e\uff1a"+v(i.date);
l.push({name:i,value:m})}k.set("items",l.reverse());d.html(i);g.setItem("ke-draft-save",encodeURIComponent(t.stringify(o)))},save:function(d){var k=this.drafts,o=u._getRawData();if(k[k.length-1]&&o==k[k.length-1].content)k.length-=1;this.drafts=k.concat({content:o,date:(new Date).getTime(),auto:d});this.sync()},recover:function(d){var k=this.editor,o=this.drafts;d=d.newVal;this.versions.reset("value");if(confirm("\u786e\u8ba4\u6062\u590d "+v(o[d].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")){k.fire("save");
k._setRawData(o[d].content);k.fire("save")}}});x.Draft=B}();u.addPlugin(function(){x.storeReady(function(){new x.Draft(u)})})});
KISSY.Editor.add("elementpaths",function(u){var s=KISSY.Editor,x=KISSY,r=x.Node,v=x.DOM;s.ElementPaths||function(){function B(n){this.cfg=n;this._cache=[];this._init()}x.augment(B,{_init:function(){var n=this.cfg.editor;this.holder=new r("<span>");this.holder.appendTo(n.statusDiv);n.on("selectionChange",this._selectionChange,this)},_selectionChange:function(n){var t=this.cfg.editor,g=this.holder;g=g[0]||g;n=n.path.elements;var d,k;d=this._cache;for(k=0;k<d.length;k++){d[k].detach("click");d[k]._4e_remove()}this._cache=
[];for(k=0;k<n.length;k++){d=n[k];var o=new r("<a href='#' class='elementpath'>"+(d.attr("_ke_real_element_type")||d._4e_name())+"</a>");this._cache.push(o);(function(l){o.on("click",function(i){i.halt();t.focus();setTimeout(function(){t.getSelection().selectElement(l)},50)})})(d);g.firstChild?v.insertBefore(o[0],g.firstChild):g.appendChild(o[0])}}});s.ElementPaths=B}();u.addPlugin(function(){new s.ElementPaths({editor:u})})});
KISSY.Editor.add("enterkey",function(u){var s=KISSY.Editor,x=KISSY,r=x.UA,v=/^h[1-6]$/,B=s.XHTML_DTD,n=x.Node,t=x.Event,g=s.Walker,d=s.ElementPath;s.enterBlock||function(){function k(i){i=i.getSelection().getRanges();for(var m=i.length-1;m>0;m--)i[m].deleteContents();return i[0]}function o(i){var m=k(i),w=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var a=(new d(m.startContainer)).block;if(a&&(a._4e_name()=="li"||a.parent()._4e_name()=="li")){i.execCommand("outdent");return}}var c=m.splitBlock("p");
if(c){i=c.previousBlock;a=c.nextBlock;var e=c.wasStartOfBlock,h=c.wasEndOfBlock,p;if(a){p=a.parent();if(p._4e_name()=="li"){a._4e_breakParent(p);a._4e_move(a._4e_next(),true)}}else if(i&&(p=i.parent())&&p._4e_name()=="li"){i._4e_breakParent(p);m.moveToElementEditablePosition(i._4e_next());i._4e_move(i._4e_previous())}if(!e&&!h){if(a._4e_name()=="li"&&(p=a._4e_first(g.invisible(true)))&&x.inArray(p._4e_name(),["ul","ol"]))(r.ie?new n(w.createTextNode("\u00a0")):new n(w.createElement("br"))).insertBefore(p);
a&&m.moveToElementEditablePosition(a)}else{var j;if(i){if(i._4e_name()=="li"||!v.test(i._4e_name()))j=i._4e_clone()}else if(a)j=a._4e_clone();j||(j=new n("p",null,w));if(p=c.elementPath){c=0;for(var b=p.elements.length;c<b;c++){var f=p.elements[c];if(f._4e_equals(p.block)||f._4e_equals(p.blockLimit))break;if(B.$removeEmpty[f._4e_name()]){f=f._4e_clone();j._4e_moveChildren(f);j.append(f)}}}r.ie||j._4e_appendBogus();m.insertNode(j);if(r.ie&&e&&(!h||!i[0].childNodes.length)){m.moveToElementEditablePosition(h?
i:j);m.select()}m.moveToElementEditablePosition(e&&!h?a:j)}if(!r.ie)if(a){w=new n(w.createElement("span"));w.html("&nbsp;");m.insertNode(w);w._4e_scrollIntoView();m.deleteContents()}else j._4e_scrollIntoView();m.select()}}function l(i){t.on(i.document,"keydown",function(m){if(m.keyCode===13)if(!m.shiftKey){i.execCommand("enterBlock");m.preventDefault()}})}l.enterBlock=o;s.EnterKey=l}();u.addPlugin(function(){u.addCommand("enterBlock",{exec:s.EnterKey.enterBlock});s.EnterKey(u)})});
KISSY.Editor.add("fakeobjects",function(u){var s=KISSY.Editor,x=KISSY,r=x.Node,v=s.NODE,B=s.Config.base+"theme/spacer.gif",n=s.HtmlParser;s=x.Editor;var t=(u=u.htmlDataProcessor)&&u.htmlFilter,g={elements:{$:function(d){var k=d.attributes;if((k=(k=(k=k&&k._ke_realelement)&&new n.Fragment.FromHtml(decodeURIComponent(k)))&&k.children[0])&&d.attributes._ke_resizable){var o=d.attributes.style;if(o){var l=/(?:^|\s)width\s*:\s*(\d+)/i.exec(o);d=l&&l[1];o=(l=/(?:^|\s)height\s*:\s*(\d+)/i.exec(o))&&l[1];
if(d)k.attributes.width=d;if(o)k.attributes.height=o}}return k}}};t&&t.addRules(g);u&&x.mix(u,{createFakeParserElement:function(d,k,o,l,i){var m;m=new n.BasicWriter;d.writeHtml(m);m=m.getHtml();var w=d.attributes.style;if(d.attributes.width)w="width:"+d.attributes.width+"px;"+w;if(d.attributes.height)w="height:"+d.attributes.height+"px;"+w;d={"class":k,src:B,_ke_realelement:encodeURIComponent(m),_ke_real_node_type:d.type,style:w,align:d.attributes.align||""};i&&delete i.width;i&&delete i.height;i&&
x.mix(d,i,false);if(o)d._ke_real_element_type=o;if(l)d._ke_resizable=l;return new n.Element("img",d)}});x.augment(s,{createFakeElement:function(d,k,o,l,i,m){var w=d.attr("style")||"";if(d.attr("width"))w="width:"+d.attr("width")+"px;"+w;if(d.attr("height"))w="height:"+d.attr("height")+"px;"+w;d={"class":k,src:B,_ke_realelement:encodeURIComponent(i||d._4e_outerHtml()),_ke_real_node_type:d[0].nodeType,align:d.attr("align")||"",style:w};m&&delete m.width;m&&delete m.height;m&&x.mix(d,m,false);if(o)d._ke_real_element_type=
o;if(l)d._ke_resizable=l;return new r("<img/>",d,this.document)},restoreRealElement:function(d){if(d.attr("_ke_real_node_type")!=v.NODE_ELEMENT)return null;d=decodeURIComponent(d.attr("_ke_realelement"));var k=new r("<div>",null,this.document);k.html(d);return k._4e_first(function(o){return o[0].nodeType==v.NODE_ELEMENT})._4e_remove()}})});KISSY.Editor.add("flash",function(u){u.addPlugin(function(){new KISSY.Editor.Flash(u)})});
KISSY.Editor.add("flashsupport",function(u){var s=KISSY.Editor,x=KISSY,r=x.UA,v=x.Event,B=s.ContextMenu,n=x.Node,t=s.BubbleView,g=s.TripleButton,d=s.SimpleOverlay,k=u.htmlDataProcessor,o="ke_flash",l=s.Utils.flash;u=k&&k.dataFilter;s.Flash||function(){function i(c){this.editor=c;this._init()}function m(c){return c._4e_name()==="img"&&!!c.hasClass(o)&&c}var w=/\.swf(?:$|\?)/i;i.isFlashEmbed=function(c){c=c.attributes;return c.type=="application/x-shockwave-flash"||w.test(c.src||"")};x.augment(i,{_config:function(){this._cls=
o;this._type="flash";this._title="Flash\u5c5e\u6027";this._bodyHtml="<table><tr><td colspan='2'><label>\u5730\u5740\uff1a <input class='ke-flash-url' style='width:280px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></td></tr><tr><td><label>\u5bbd\u5ea6\uff1a <input class='ke-flash-width' style='width:60px' /> \u50cf\u7d20 </label></td><td><label>\u9ad8\u5ea6\uff1a<input class='ke-flash-height' style='width:60px' /> \u50cf\u7d20 </label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-flash-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label>\u95f4\u8ddd\uff1a<input class='ke-flash-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>";
this._footHtml="<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=a;this._flashRules=["img."+o]},_init:function(){this._config();var c=this.editor,e={},h=this._contextMenu;c._toolbars=c._toolbars||{};c._toolbars[this._type]=this;this.el=new g({container:c.toolBarDiv,contentCls:this._contentCls,title:this._tip});this.el.on("click",this.show,this);if(h)for(var p in h)(function(j){e[j]=
function(){h[j](c)}})(p);B.register(c.document,{rules:this._flashRules,width:"120px",funcs:e});t.attach({pluginName:this._type,pluginInstance:this});v.on(c.document,"dblclick",this._dbclick,this);s.Utils.lazyRun(this,"_prepareShow","_realShow")},_getFlashUrl:function(c){return l.getUrl(c)},_updateTip:function(c,e){e=this._getFlashUrl(this.editor.restoreRealElement(e));c.html(e);c.attr("href",e)},_dbclick:function(c){var e=new n(c.target);if(e._4e_name()==="img"&&e.hasClass(this._cls)){this.show(null,
e);c.halt()}},_prepareShow:function(){var c=new d({title:this._title,width:this._config_dwidth||"350px",mask:true});c.body.html(this._bodyHtml);c.foot.html(this._footHtml);this.d=c;this._initD()},_realShow:function(){this._updateD();this.d.show()},_updateD:function(){var c=this.editor,e=this.selectedFlash;if(e){c=c.restoreRealElement(e);c.attr("width")&&this.dWidth.val(parseInt(c.attr("width")));c.attr("height")&&this.dHeight.val(parseInt(c.attr("height")));this.dAlign.val(c.attr("align"));this.dUrl.val(this._getFlashUrl(c));
this.dMargin.val(parseInt(c._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");this.dWidth.val("");this.dHeight.val("");this.dAlign.val("");this.dMargin.val("5")}},show:function(c,e){this.selectedFlash=e;this._prepareShow()},_initD:function(){var c=this,e=c.d;c.dHeight=e.el.one(".ke-flash-height");c.dWidth=e.el.one(".ke-flash-width");c.dUrl=e.el.one(".ke-flash-url");c.dAlign=e.el.one(".ke-flash-align");c.dMargin=e.el.one(".ke-flash-margin");var h=e.el.one(".ke-flash-ok");
e=e.el.one(".ke-flash-cancel");h.on("click",c._gen,c);e.on("click",function(){c.d.hide()})},_getDInfo:function(){return{url:this.dUrl.val(),attrs:{width:this.dWidth.val(),height:this.dHeight.val(),align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px"}}},_gen:function(){var c=this.editor,e=this._getDInfo(),h=e&&x.trim(e.url);e=e&&e.attrs;if(h){h=l.createSWF(h,{attrs:e},c.document);var p=h.el;e=c.createFakeElement?c.createFakeElement(p,this._cls,this._type,true,h.html,e):p;
e=c.insertElement(e);this.selectedFlash&&c.getSelection().selectElement(e);this.d.hide()}}});s.Flash=i;i.registerBubble=function(c,e,h){t.register({pluginName:c,func:h,init:function(){var p=this,j=p.el;j.html(e+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');var b=j.one(".ke-bubbleview-url"),f=j.one(".ke-bubbleview-change");
j=j.one(".ke-bubbleview-remove");f._4e_unselectable();b._4e_unselectable();j._4e_unselectable();f.on("click",function(q){p._plugin.show(null,p._selectedEl);q.halt()});j.on("click",function(q){var y=p._plugin;if(r.webkit){var A=y.editor.getSelection().getRanges();A&&A[0]&&(A[0].collapse(true)||1)&&A[0].select()}p._selectedEl._4e_remove();p.hide();y.editor.notifySelectionChange();q.halt()});p.on("beforeVisibleChange",function(q){var y=p._selectedEl;q.newVal&&y&&p._plugin._updateTip(b,y)})}})};i.registerBubble("flash",
"Flash \u7f51\u5740\uff1a ",m);i.checkFlash=m;var a={"Flash\u5c5e\u6027":function(c){var e=c.getSelection();e=e&&e.getStartElement();e=m(e);c=c._toolbars.flash;e&&c.show(null,e)}};i.CLS_FLASH=o;i.TYPE_FLASH="flash"}();u&&u.addRules({elements:{object:function(i){var m=i.attributes;if(!(m.classid&&String(m.classid).toLowerCase())){for(m=0;m<i.children.length;m++)if(i.children[m].name=="embed"){if(!s.Flash.isFlashEmbed(i.children[m]))return null;return k.createFakeParserElement(i,o,"flash",true)}return null}return k.createFakeParserElement(i,
o,"flash",true)},embed:function(i){if(!s.Flash.isFlashEmbed(i))return null;return k.createFakeParserElement(i,o,"flash",true)}}},5)});
KISSY.Editor.add("flashutils",function(){var u=KISSY,s=u.Editor,x=s.Utils.flash;if(!x){var r=u.DOM,v=u.Node,B=u.UA;x={getUrl:function(n){var t="",g=s.NODE;if(n._4e_name()=="object"){n=n[0].childNodes;for(var d=0;d<n.length;d++)if(n[d].nodeType==g.NODE_ELEMENT)if((r.attr(n[d],"name")||"").toLowerCase()=="movie")t=r.attr(n[d],"value");else if(r._4e_name(n[d])=="embed")t=r.attr(n[d],"src");else if(r._4e_name(n[d])=="object")t=r.attr(n[d],"data")}else if(n._4e_name()=="embed")t=n.attr("src");return t},
createSWF:function(n,t,g){var d=t.attrs;t=t.flashVars;var k="",o="";g=g||document;if(d)for(var l in d)k+=l+"='"+d[l]+"' ";if(t){for(var i in t)o+="&"+i+"="+encodeURIComponent(t[i]);o=o.substring(1)}n="<object "+k+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" <param name="quality" value="high" /><param name="movie" value="'+n+'" />'+(o?'<param name="flashVars" value="'+o+'"/>':"")+"<embed "+k+" "+(o?'FlashVars="'+o+'"':"")+' pluginspage="http://www.macromedia.com/go/getflashplayer"  quality="high"  src="'+
n+'"  type="application/x-shockwave-flash"/></object>';return{el:new v(n,null,g),html:n}},createSWFRuntime2:function(n,t,g){g=g||document;var d=(new v("<div style='width:0;height:0;overflow:hidden;'>",null,g)).appendTo(g.body);d=x.createSWF.apply(this,arguments).el.appendTo(d);B.ie||(d=d.one("object"));return d[0]},createSWFRuntime:function(n,t,g){var d=t.attrs,k=t.flashVars,o="",l="";g=g||document;d=d||{};d.id=d.id||u.guid("ke-runtimeflash-");for(var i in d)o+=i+"='"+d[i]+"' ";if(k){for(var m in k)l+=
"&"+m+"="+encodeURIComponent(k[m]);l=l.substring(1)}n=B.ie?"<object "+o+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" <param name="quality" value="high" /><param name="wmode" value="transparent"/> <param name="movie" value="'+n+'" />'+(l?'<param name="flashVars" value="'+l+'" />':"")+"</object>":"<object type='application/x-shockwave-flash' data='"+n+"' "+o+'><param name="wmode" value="transparent"/> '+(l?'<param name="flashVars" value="'+l+'"/>':"")+"</object>";(new v("<div style='"+(t.style?
t.style:"width:0;height:0;overflow:hidden;")+"'>",null,g)).appendTo(g.body).html(n);return g.getElementById(d.id)}};s.Utils.flash=x}});
KISSY.Editor.add("font",function(u){var s=KISSY.Editor,x=KISSY,r=s.Style,v=s.TripleButton,B=u.cfg.pluginConfig["font-size"]||["8px","10px","12px","14px","18px","24px","36px","48px","60px","72px","84px","96px","108px"],n={},t=[],g={element:"span",styles:{"font-size":"#(size)"},overrides:[{element:"font",attributes:{size:null}}]},d=u.cfg.pluginConfig["font-family"]||["\u5b8b\u4f53","\u9ed1\u4f53","\u96b6\u4e66","\u6977\u4f53_GB2312","\u5fae\u8f6f\u96c5\u9ed1","Georgia","Times New Roman","Impact","Courier New",
"Arial","Verdana","Tahoma"],k={},o=[],l={element:"span",styles:{"font-family":"#(family)"},overrides:[{element:"font",attributes:{face:null}}]},i;u.cfg.pluginConfig["font-size"]=B;u.cfg.pluginConfig["font-family"]=d;for(i=0;i<B.length;i++){var m=B[i];n[m]=new r(g,{size:m});t.push({name:m,value:m})}for(i=0;i<d.length;i++){B=d[i];k[B]=new r(l,{family:B});o.push({name:B,value:B,attrs:{style:"font-family:"+B}})}s.Font||function(){function w(c){w.superclass.constructor.call(this,c);this._init()}function a(c){a.superclass.constructor.call(this,
c);this._init()}w.ATTRS={title:{},html:{},styles:{},editor:{}};x.extend(w,x.Base,{_init:function(){var c=this.get("editor"),e=c.toolBarDiv;this.get("html");this.el=new s.Select({container:e,doc:c.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);c.on("selectionChange",this._selectionChange,this)},_vChange:function(c){var e=this.get("editor"),h=c.newVal;c=c.preVal;var p=this.get("styles");e.focus();
e.fire("save");if(h==c){p[h].remove(e.document);this.el.set("value","")}else p[h].apply(e.document);e.fire("save")},_selectionChange:function(c){this.get("editor");c=c.path.elements;for(var e=this.get("styles"),h=0,p;h<c.length;h++){p=c[h];for(var j in e)if(e[j].checkElementRemovable(p,true)){this.el.set("value",j);return}}this.el.reset("value")}});a.ATTRS={editor:{},text:{},contentCls:{},title:{},style:{}};x.extend(a,x.Base,{_init:function(){var c=this.get("editor"),e=this.get("text");this.get("style");
var h=this.get("title");this.el=new v({text:e,title:h,contentCls:this.get("contentCls"),container:c.toolBarDiv});this.el.on("offClick",this._on,this);this.el.on("onClick",this._off,this);c.on("selectionChange",this._selectionChange,this)},_on:function(){var c=this.get("editor");this.get("text");var e=this.get("style");this.get("title");c.fire("save");e.apply(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_off:function(){var c=this.get("editor");this.get("text");var e=this.get("style");
this.get("title");c.fire("save");e.remove(c.document);c.fire("save");c.notifySelectionChange();c.focus()},_selectionChange:function(c){this.get("editor");this.get("text");var e=this.get("style");this.get("title");e.checkActive(c.path)?this.el.set("state",v.ON):this.el.set("state",v.OFF)}});w.SingleFont=a;s.Font=w}();u.addPlugin(function(){new s.Font({editor:u,title:"\u5927\u5c0f",width:"30px",popUpWidth:"55px",styles:n,html:t});new s.Font({editor:u,title:"\u5b57\u4f53",width:"110px",popUpWidth:"130px",
styles:k,html:o});new s.Font.SingleFont({contentCls:"ke-toolbar-bold",title:"\u7c97\u4f53 ",editor:u,style:new r({element:"strong",overrides:[{element:"b"},{element:"span",attributes:{style:"font-weight: bold;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-italic",title:"\u659c\u4f53 ",editor:u,style:new r({element:"em",overrides:[{element:"i"},{element:"span",attributes:{style:"font-style: italic;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-underline",title:"\u4e0b\u5212\u7ebf ",
editor:u,style:new r({element:"u",overrides:[{element:"span",attributes:{style:"text-decoration: underline;"}}]})});new s.Font.SingleFont({contentCls:"ke-toolbar-strikeThrough",title:"\u5220\u9664\u7ebf ",editor:u,style:new r({element:"del",overrides:[{element:"span",attributes:{style:"text-decoration: line-through;"}},{element:"s"}]})})})});
KISSY.Editor.add("format",function(u){var s=KISSY.Editor,x=KISSY,r=[],v={"\u666e\u901a\u6587\u672c":"p","\u6807\u98981":"h1","\u6807\u98982":"h2","\u6807\u98983":"h3","\u6807\u98984":"h4","\u6807\u98985":"h5","\u6807\u98986":"h6"},B={p:"1em",h1:"2em",h2:"1.5em",h3:"1.17em",h4:"1em",h5:"0.83em",h6:"0.67em"},n={},t=s.Style;for(var g in v)if(v[g]){n[v[g]]=new t({element:v[g]});r.push({name:g,value:v[g],attrs:{style:"font-size:"+B[v[g]]}})}s.Format||function(){function d(k){d.superclass.constructor.call(this,
k);this._init()}d.ATTRS={editor:{}};x.extend(d,x.Base,{_init:function(){var k=this.get("editor");this.el=new s.Select({container:k.toolBarDiv,value:"",doc:k.document,width:this.get("width"),popUpWidth:this.get("popUpWidth"),title:this.get("title"),items:this.get("html")});this.el.on("click",this._vChange,this);k.on("selectionChange",this._selectionChange,this)},_vChange:function(k){var o=this.get("editor"),l=k.newVal;k=k.preVal;o.fire("save");if(l!=k)n[l].apply(o.document);else{n.p.apply(o.document);
this.el.set("value","p")}o.fire("save")},_selectionChange:function(k){this.get("editor");k=k.path;for(var o in n)if(n[o].checkActive(k)){this.el.set("value",o);return}this.el.reset("value")}});s.Format=d}();u.addPlugin(function(){new s.Format({editor:u,html:r,title:"\u6807\u9898",width:"100px",popUpWidth:"120px"})})});
KISSY.Editor.add("htmlparser-basicwriter",function(){function u(){this._={output:[]}}var s=KISSY.Editor,x=s.Utils;if(!s.HtmlParser.BasicWriter){KISSY.augment(u,{openTag:function(r){this._.output.push("<",r)},openTagClose:function(r,v){v?this._.output.push(" />"):this._.output.push(">")},attribute:function(r,v){if(typeof v=="string")v=x.htmlEncodeAttr(v);this._.output.push(" ",r,'="',v,'"')},closeTag:function(r){this._.output.push("</",r,">")},text:function(r){this._.output.push(r)},comment:function(r){this._.output.push("<!--",
r,"--\>")},write:function(r){this._.output.push(r)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(r){var v=this._.output.join("");r&&this.reset();return v}});s.HtmlParser.BasicWriter=u}});
KISSY.Editor.add("htmlparser-comment",function(){function u(r){this.value=r;this._={isBlockLike:false}}var s=KISSY.Editor,x=s.NODE;if(!s.HtmlParser.Comment){s.HtmlParser.Comment=u;u.prototype={constructor:u,type:x.NODE_COMMENT,writeHtml:function(r,v){var B=this.value;if(v){if(!(B=v.onComment(B,this)))return;if(typeof B!="string"){B.parent=this.parent;B.writeHtml(r,v);return}}r.comment(B)}}}});
KISSY.Editor.add("htmlparser-element",function(){function u(v,B){this.name=v;this.attributes=B||(B={});this.children=[];var n=B._ke_real_element_type||v;B=s.XHTML_DTD;n=!!(B.$nonBodyContent[n]||B.$block[n]||B.$listItem[n]||B.$tableContent[n]||B.$nonEditable[n]||n=="br");var t=!!B.$empty[v];this.isEmpty=t;this.isUnknown=!B[v];this._={isBlockLike:n,hasInlineStarted:t||!n}}var s=KISSY.Editor;if(!s.HtmlParser.Element){var x=s.NODE,r=function(v,B){v=v[0];B=B[0];return v<B?-1:v>B?1:0};KISSY.augment(u,{type:x.NODE_ELEMENT,
add:s.HtmlParser.Fragment.prototype.add,clone:function(){return new u(this.name,this.attributes)},writeHtml:function(v,B){var n=this.attributes,t=this,g=t.name,d,k,o,l;t.filterChildren=function(){if(!l){var w=new s.HtmlParser.BasicWriter;s.HtmlParser.Fragment.prototype.writeChildrenHtml.call(t,w,B);t.children=(new s.HtmlParser.Fragment.FromHtml(w.getHtml())).children;l=1}};if(B){for(;;){if(!(g=B.onElementName(g)))return;t.name=g;if(!(t=B.onElement(t)))return;t.parent=this.parent;if(t.name==g)break;
if(t.type!=x.NODE_ELEMENT){t.writeHtml(v,B);return}g=t.name;if(!g){this.writeChildrenHtml.call(t,v,l?null:B);return}}n=t.attributes}v.openTag(g,n);for(var i=[],m=0;m<2;m++)for(d in n){k=d;o=n[d];if(m==1)i.push([d,o]);else if(B){for(;;)if(k=B.onAttributeName(d))if(k!=d){delete n[d];d=k}else break;else{delete n[d];break}if(k)if((o=B.onAttribute(t,k,o))===false)delete n[k];else n[k]=o}}v.sortAttributes&&i.sort(r);n=i.length;for(m=0;m<n;m++){d=i[m];v.attribute(d[0],d[1])}v.openTagClose(g,t.isEmpty);if(!t.isEmpty){this.writeChildrenHtml.call(t,
v,l?null:B);v.closeTag(g)}},writeChildrenHtml:function(){s.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});s.HtmlParser.Element=u}});
KISSY.Editor.add("htmlparser-filter",function(){function u(g){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};g&&this.addRules(g,10)}function s(g,d){for(var k=0;g&&k<d.length;k++){var o=d[k];g=g.replace(o[0],o[1])}return g}function x(g,d,k){if(typeof d=="function")d=[d];var o,l;l=g.length;var i=d&&d.length;if(i){for(o=0;o<l&&g[o].pri<k;o++);for(l=i-1;l>=0;l--)if(i=d[l]){i.pri=k;g.splice(o,0,i)}}}function r(g,d,k){if(d)for(var o in d){var l=g[o];g[o]=v(l,d[o],
k);l||g.$length++}}function v(g,d,k){if(d){d.pri=k;if(g){if(g.splice)x(g,d,k);else{g=g.pri>k?[d,g]:[g,d];g.filter=B}return g}else return d.filter=d}}function B(g){for(var d=g.type||g instanceof n.HtmlParser.Fragment,k=0;k<this.length;k++){if(d)var o=g.type,l=g.name;var i=this[k].apply(window,arguments);if(i===false)return i;if(d){if(i&&(i.name!=l||i.type!=o))return i}else if(typeof i!="string")return i;i!=undefined&&(g=i)}return g}var n=KISSY.Editor,t=n.NODE;if(!n.HtmlParser.Filter){KISSY.augment(u,
{addRules:function(g,d){if(typeof d!="number")d=10;x(this._.elementNames,g.elementNames,d);x(this._.attributeNames,g.attributeNames,d);r(this._.elements,g.elements,d);r(this._.attributes,g.attributes,d);this._.text=v(this._.text,g.text,d)||this._.text;this._.comment=v(this._.comment,g.comment,d)||this._.comment;this._.root=v(this._.root,g.root,d)||this._.root},onElementName:function(g){return s(g,this._.elementNames)},onAttributeName:function(g){return s(g,this._.attributeNames)},onText:function(g){var d=
this._.text;return d?d.filter(g):g},onComment:function(g,d){var k=this._.comment;return k?k.filter(g,d):g},onFragment:function(g){var d=this._.root;return d?d.filter(g):g},onElement:function(g){for(var d=[this._.elements["^"],this._.elements[g.name],this._.elements.$],k,o=0;o<3;o++)if(k=d[o]){k=k.filter(g,this);if(k===false)return null;if(k&&k!=g)return this.onNode(k);if(g.parent&&!g.name)break}return g},onNode:function(g){var d=g.type;return d==t.NODE_ELEMENT?this.onElement(g):d==t.NODE_TEXT?new n.HtmlParser.Text(this.onText(g.value)):
null},onAttribute:function(g,d,k){if(d=this._.attributes[d]){g=d.filter(k,g,this);if(g===false)return false;if(typeof g!="undefined")return g}return k}});n.HtmlParser.Filter=u}});
KISSY.Editor.add("htmlparser-fragment",function(){function u(){this.children=[];this.parent=null;this._={isBlockLike:true,hasInlineStarted:false}}var s=KISSY.Editor;if(!s.HtmlParser.Fragment){var x={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},r=KISSY,v=s.Utils,B=s.NODE,n=s.XHTML_DTD,t=v.mix({table:1,ul:1,ol:1,dl:1},n.table,n.ul,n.ol,n.dl),g=n.$list,d=n.$listItem;u.FromHtml=function(k,o){function l(f){var q;if(c.length>0)for(var y=0;y<c.length;y++){var A=c[y],C=A.name,H=
n[C],O=h.name&&n[h.name];if((!O||O[C])&&(!f||!H||H[f]||!n[f])){if(!q){i();q=1}A=A.clone();A.parent=h;h=A;c.splice(y,1);y--}}}function i(){for(;e.length;)h.add(e.shift())}function m(f,q,y){q=q||h||a;if(o&&!q.type){var A,C;if((A=f.attributes&&(C=f.attributes._ke_real_element_type)?C:f.name)&&!(A in n.$body)&&!(A in n.$nonBodyContent)){A=h;h=q;w.onTagOpen(o,{});q=h;if(y)h=A}}if(f._.isBlockLike&&f.name!="pre"){y=f.children.length;if((A=f.children[y-1])&&A.type==B.NODE_TEXT)if(C=v.rtrim(A.value))A.value=
C;else f.children.length=y-1}q.add(f);if(f.returnPoint){h=f.returnPoint;delete f.returnPoint}}var w=new s.HtmlParser,a=new u,c=[],e=[],h=a,p=false,j;w.onTagOpen=function(f,q,y){var A=new s.HtmlParser.Element(f,q);if(A.isUnknown&&y)A.isEmpty=true;if(n.$removeEmpty[f])c.push(A);else{if(f=="pre")p=true;else if(f=="br"&&p){h.add(new s.HtmlParser.Text("\n"));return}if(f=="br")e.push(A);else{var C=h.name,H=C&&(n[C]||(h._.isBlockLike?n.div:n.span));if(H&&!A.isUnknown&&!h.isUnknown&&!H[f]){H=false;var O;
if(f in g&&C in g){C=h.children;(C=C[C.length-1])&&C.name in d||m(C=new s.HtmlParser.Element("li"),h);j=h;O=C}else if(f==C)m(h,h.parent);else{if(t[C])j||(j=h);else{m(h,h.parent,true);x[C]||c.unshift(h)}H=true}h=O?O:h.returnPoint||h.parent;if(H){w.onTagOpen.apply(this,arguments);return}}l(f);i();A.parent=h;A.returnPoint=j;j=0;if(A.isEmpty)m(A);else h=A}}};w.onTagClose=function(f){for(var q=c.length-1;q>=0;q--)if(f==c[q].name){c.splice(q,1);return}for(var y=[],A=[],C=h;C.type&&C.name!=f;){C._.isBlockLike||
A.unshift(C);y.push(C);C=C.parent}if(C.type){for(q=0;q<y.length;q++){var H=y[q];m(H,H.parent)}h=C;if(h.name=="pre")p=false;C._.isBlockLike&&i();m(C,C.parent);if(C==h)h=h.parent;c=c.concat(A)}if(f=="body")o=false};w.onText=function(f){if(!h._.hasInlineStarted&&!p){f=v.ltrim(f);if(f.length===0)return}i();l();if(o&&(!h.type||h.name=="body")&&v.trim(f))this.onTagOpen(o,{});p||(f=f.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));h.add(new s.HtmlParser.Text(f))};w.onCDATA=function(){};w.onComment=function(f){h.add(new s.HtmlParser.Comment(f))};
w.parse(k);for(i();h.type;){k=h.parent;var b=h;if(o&&(!k.type||k.name=="body")&&!n.$body[b.name]){h=k;w.onTagOpen(o,{});k=h}k.add(b);h=k}return a};r.augment(u,{add:function(k){var o=this.children.length;if(o=o>0&&this.children[o-1]||null){if(k._.isBlockLike&&o.type==B.NODE_TEXT){o.value=v.rtrim(o.value);if(o.value.length===0){this.children.pop();this.add(k);return}}o.next=k}k.previous=o;k.parent=this;this.children.push(k);this._.hasInlineStarted=k.type==B.NODE_TEXT||k.type==B.NODE_ELEMENT&&!k._.isBlockLike},
writeHtml:function(k,o){var l;this.filterChildren=function(){var i=new s.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,i,o,true);i=i.getHtml();this.children=(new u.FromHtml(i)).children;l=1};!this.name&&o&&o.onFragment(this);this.writeChildrenHtml(k,l?null:o)},writeChildrenHtml:function(k,o){for(var l=0;l<this.children.length;l++)this.children[l].writeHtml(k,o)}});s.HtmlParser.Fragment=u}});
KISSY.Editor.add("htmlparser",function(){function u(){this._={htmlPartsRegex:new RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var s=KISSY.Editor;if(!s.HtmlParser){var x=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,r={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},v=s.XHTML_DTD;KISSY.augment(u,{onTagOpen:function(){},
onTagClose:function(){},onText:function(){},onCDATA:function(){},onComment:function(){},parse:function(B){for(var n,t,g=0,d;n=this._.htmlPartsRegex.exec(B);){t=n.index;if(t>g){g=B.substring(g,t);d?d.push(g):this.onText(g)}g=this._.htmlPartsRegex.lastIndex;if(t=n[1]){t=t.toLowerCase();if(d&&v.$cdata[t]){this.onCDATA(d.join(""));d=null}if(!d){this.onTagClose(t);continue}}if(d)d.push(n[0]);else if(t=n[3]){t=t.toLowerCase();var k={},o;n=n[4];var l=!!(n&&n.charAt(n.length-1)=="/");if(n)for(;o=x.exec(n);){var i=
o[1].toLowerCase();o=o[2]||o[3]||o[4]||"";k[i]=!o&&r[i]?i:o}this.onTagOpen(t,k,l);if(!d&&v.$cdata[t])d=[]}else if(t=n[2])this.onComment(t)}B.length>g&&this.onText(B.substring(g,B.length))}});s.HtmlParser=u}});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function u(){u.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=false;this.sortAttributes=true;this._.indent=false;this._.indentation="";this._.rules={};var r=s.XHTML_DTD;for(var v in x.mix({},r.$nonBodyContent,r.$block,r.$listItem,r.$tableContent))this.setRules(v,{indent:true,breakBeforeOpen:true,breakAfterOpen:true,breakBeforeClose:!r[v]["#"],breakAfterClose:true});
this.setRules("br",{breakAfterOpen:true});this.setRules("title",{indent:false,breakAfterOpen:false});this.setRules("style",{indent:false,breakBeforeClose:true});this.setRules("pre",{indent:false})}var s=KISSY.Editor,x=s.Utils;if(!s.HtmlParser.HtmlWriter){KISSY.extend(u,s.HtmlParser.BasicWriter,{openTag:function(r){var v=this._.rules[r];if(this._.indent)this.indentation();else if(v&&v.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",r)},openTagClose:function(r,v){r=this._.rules[r];
if(v)this._.output.push(this.selfClosingEnd);else{this._.output.push(">");if(r&&r.indent)this._.indentation+=this.indentationChars}r&&r.breakAfterOpen&&this.lineBreak()},attribute:function(r,v){if(typeof v=="string"){this.forceSimpleAmpersand&&(v=v.replace(/&amp;/g,"&"));v=x.htmlEncodeAttr(v)}this._.output.push(" ",r,'="',v,'"')},closeTag:function(r){var v=this._.rules[r];if(v&&v.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();
else if(v&&v.breakBeforeClose){this.lineBreak();this.indentation()}this._.output.push("</",r,">");v&&v.breakAfterClose&&this.lineBreak()},text:function(r){if(this._.indent){this.indentation();r=x.ltrim(r)}this._.output.push(r)},comment:function(r){this._.indent&&this.indentation();this._.output.push("<!--",r,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=true},indentation:function(){this._.output.push(this._.indentation);this._.indent=false},
setRules:function(r,v){var B=this._.rules[r];if(B)x.mix(B,v);else this._.rules[r]=v}});s.HtmlParser.HtmlWriter=u}});KISSY.Editor.add("htmlparser-text",function(){function u(x){this.value=x;this._={isBlockLike:false}}var s=KISSY.Editor;if(!s.HtmlParser.Text){KISSY.augment(u,{type:s.NODE.NODE_TEXT,writeHtml:function(x,r){var v=this.value;r&&!(v=r.onText(v,this))||x.text(v)}});s.HtmlParser.Text=u}});
KISSY.Editor.add("htmldataprocessor",function(u){function s(j){if(/mso-list\s*:\s*Ignore/i.test(j.attributes&&j.attributes.style))return true;return n}function x(j,b){var f=new t.HtmlParser.Element("ke:listbullet"),q;if(j)if(j[2]){j=isNaN(j[1])?/^[a-z]+$/.test(j[1])?"lower-alpha":/^[A-Z]+$/.test(j[1])?"upper-alpha":"decimal":"decimal";q="ol"}else{j=/[l\u00B7\u2002]/.test(j[1])?"disc":/[\u006F\u00D8]/.test(j[1])?"circle":/[\u006E\u25C6]/.test(j[1])?"square":"disc";q="ul"}else{j="decimal";q="ol"}f.attributes=
{"ke:listtype":q,style:"list-style-type:"+j+";"};f.add(new t.HtmlParser.Text(b));return f}function r(j){var b=j.attributes,f;if((f=j.removeAnyChildWithName("ke:listbullet"))&&f.length&&(f=f[0])){j.name="ke:li";if(b.style)b.style=v([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(q){q=q.split(" ");q=q[3]||q[1]||q[0];q=parseInt(q,10);if(!a&&c&&q>c)a=q-c;b["ke:margin"]=c=q}]],n)(b.style,j)||"";f=f.attributes;j.addStyle(f.style);g.mix(b,f);return true}return false}function v(j,b){return function(f,
q){var y=[];f.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(A,C,H){C=C.toLowerCase();C=="font-family"&&(H=H.replace(/["']/g,""));for(var O,z,D,I=0;I<j.length;I++)if(j[I]){A=j[I][0];O=j[I][1];z=j[I][2];D=j[I][3];if(C.match(A)&&(!O||H.match(O))){C=D||C;b&&(z=z||H);if(typeof z=="function")z=z(H,q,C);if(z&&z.push){C=z[0];z=z[1]}typeof z=="string"&&y.push([C,z]);return}}!b&&y.push([C,H])});for(f=0;f<y.length;f++)y[f]=y[f].join(":");return y.length?y.join(";")+";":false}}
function B(j){j=j.children;for(var b,f,q,y,A,C,H,O=0;O<j.length;O++){b=j[O];if("ke:li"==b.name){b.name="li";f=b.attributes;q=b.attributes["ke:listtype"];y=parseInt(f["ke:indent"],10)||a&&Math.ceil(f["ke:margin"]/a)||1;f.style&&(f.style=v([["list-style-type",q=="ol"?"decimal":"disc"]],n)(f.style)||"");if(C){if(y>H){C=new t.HtmlParser.Element(q);C.add(b);A.add(C)}else{if(y<H){A=H-y;for(var z;A--&&(z=C.parent);)C=z.parent}C.add(b)}j.splice(O--,1)}else{C=new t.HtmlParser.Element(q);C.add(b);j[O]=C}A=
b;H=y}else C=null}a=0}var n=n,t=KISSY.Editor,g=KISSY,d=g.UA,k=t.NODE,o=t.HtmlParser,l=new o.Filter,i=new o.Filter,m=t.XHTML_DTD;if(!u.htmlDataProcessor){(function(){var j=t.HtmlParser.Fragment.prototype,b=t.HtmlParser.Element.prototype;j.onlyChild=b.onlyChild=function(){var f=this.children;return f.length==1&&f[0]||null};b.removeAnyChildWithName=function(f){for(var q=this.children,y=[],A,C=0;C<q.length;C++){A=q[C];if(A.name){if(A.name==f){y.push(A);q.splice(C--,1)}y=y.concat(A.removeAnyChildWithName(f))}}return y};
b.getAncestor=function(f){for(var q=this.parent;q&&!(q.name&&q.name.match(f));)q=q.parent;return q};j.firstChild=b.firstChild=function(f){for(var q,y=0;y<this.children.length;y++){q=this.children[y];if(f(q))return q;else if(q.name)if(q=q.firstChild(f))return q}return null};b.addStyle=function(f,q,y){var A="";if(typeof q=="string")A+=f+":"+q+";";else{if(typeof f=="object")for(var C in f){if(f.hasOwnProperty(C))A+=C+":"+f[C]+";"}else A+=f;y=q}if(!this.attributes)this.attributes={};f=this.attributes.style||
"";f=(y?[A,f]:[f,A]).join(";");this.attributes.style=f.replace(/^;|;(?=;)/,"")};m.parentOf=function(f){var q={};for(var y in this)if(y.indexOf("$")==-1&&this[y][f])q[y]=1;return q}})();var w=v([[/mso/i],[/font-size/i,"",function(j){for(var b=u.cfg.pluginConfig["font-size"],f=0;f<b.length;f++)if(j.toLowerCase()==b[f])return j;return false},"font-size"],[/font-family/i,"",function(j){for(var b=u.cfg.pluginConfig["font-family"],f=0;f<b.length;f++)if(j.toLowerCase()==b[f].toLowerCase())return j;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],n),a,c=0,e=m.parentOf("ol"),h={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(j){j.filterChildren();B(j)},elements:{font:function(j){delete j.name},p:function(j){j.filterChildren();if(r(j))return n},$:function(j){var b=j.name||"";b.indexOf(":")!=-1&&b.indexOf("ke")==-1&&delete j.name;var f=j.attributes.style;if(b=="span"&&(!f||!w(f)))delete j.name;
if(b in e){j.filterChildren();B(j)}},table:function(j){var b=j.attributes.border;if(!b||b=="0")j.attributes["class"]="ke_show_border"},td:function(j){if(d.ie){j=j.children;var b=new t.HtmlParser.Text("&nbsp;");if(j.length)j[j.length-1].type!=k.NODE_TEXT&&j.push(b);else j.push(b)}},span:function(j){if(!d.gecko&&s(j.parent))return false;if(!d.gecko&&s(j)){j=(j=j.firstChild(function(f){return f.value||f.name=="img"}))&&(j.value||"l.");var b=j.match(/^([^\s]+?)([.)]?)$/);return x(b,j)}}},comment:!d.ie?
function(j,b){var f=j.match(/<img.*?>/);if(j=j.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){f=(b=j[1]||f&&"l.")&&b.match(/>([^\s]+?)([.)]?)</);return x(f,b)}if(d.gecko&&f){f=t.HtmlParser.Fragment.FromHtml(f[0]).children[0];(b=(b=(b=b.previous)&&b.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&b[1])&&(f.attributes.src=b);return f}return false}:function(){return false},attributes:{"class":function(j){if(/^ke_/.test(j))return j;return false},style:function(j){j=w(j);if(!j)return false;
return j}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},p={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(j){var b=j.parent;if(b&&b.name=="object"){var f=b.attributes.width;b=b.attributes.height;f&&(j.attributes.width=f);b&&(j.attributes.height=b)}},param:function(j){j.children=[];j.isEmpty=true;return j},a:function(j){if(!(j.children.length||j.attributes.name))return false},td:function(j){for(var b=j.children,f=0;f<b.length;f++)if(b[f].name=="br"){b.splice(f,1);--f}if(!j.children.length){b=
new t.HtmlParser.Text("&nbsp;");j.children.push(b)}},span:function(j){if(!j.children.length)return false}},attributes:{style:function(j){if(!g.trim(j))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(d.ie)p.attributes.style=function(j){return j.toLowerCase()};l.addRules(p);i.addRules(h);u.htmlDataProcessor={htmlFilter:l,dataFilter:i,toHtml:function(j,b){var f=new o.HtmlWriter;o.Fragment.FromHtml(j,b).writeHtml(f,l);return f.getHtml(true)},toDataFormat:function(j,b){if(d.gecko)j=
j.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var f=new o.BasicWriter;j=o.Fragment.FromHtml(j,b);f.reset();j.writeHtml(f,i);return f.getHtml(true)}}}});
KISSY.Editor.add("image",function(u){var s=KISSY.Editor,x=KISSY,r=x.UA,v=x.Node,B=x.Event,n=s.BubbleView,t=s.SimpleOverlay;s.ImageInserter||function(){function g(l){g.superclass.constructor.call(this,l);this._init()}var d=function(l){return l._4e_name()==="img"&&!/(^|\s+)ke_/.test(l[0].className)&&l},k=s.TripleButton;g.ATTRS={editor:{}};var o={"\u56fe\u7247\u5c5e\u6027":function(l){var i=l.getSelection();i=i&&i.getStartElement();i=d(i);l=l._toolbars.image;i&&l.show(null,i)}};x.extend(g,x.Base,{_init:function(){var l=
this.get("editor"),i=l.toolBarDiv,m={};this.editor=l;this.el=new k({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",container:i});this.el.on("offClick",this.show,this);B.on(l.document,"dblclick",this._dblclick,this);s.Utils.lazyRun(this,"_prepare","_real");l._toolbars=l._toolbars||{};l._toolbars.image=this;if(o)for(var w in o)(function(a){m[a]=function(){o[a](l)}})(w);s.ContextMenu.register(l.document,{rules:[d],width:"120px",funcs:m});n.attach({pluginName:"image",pluginInstance:this})},
_dblclick:function(l){var i=new v(l.target);if(d(i)){this.show(null,i);l.halt()}},_prepare:function(){var l=this;l.get("editor");l.d=new t({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var i=l.d;i.body.html("<table><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></td></tr><tr><td><label><span>\u9ad8\u5ea6\uff1a </span><input class='ke-img-height' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td><td><label><span>\u5bbd\u5ea6\uff1a </span><input class='ke-img-width' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td></tr><tr><td><label><span>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label><span>\u95f4\u8ddd\uff1a </span> <input class='ke-img-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>");
i.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");l.content=i.el;i=l.content;var m=i.one(".ke-img-cancel"),w=i.one(".ke-img-insert");l.imgUrl=i.one(".ke-img-url");l.imgHeight=i.one(".ke-img-height");l.imgWidth=i.one(".ke-img-width");l.imgAlign=i.one(".ke-img-align");l.imgMargin=i.one(".ke-img-margin");m.on("click",function(a){l.d.hide();a.halt()});w.on("click",function(){l._insert()})},_updateTip:function(l,i){l.html(i.attr("src"));
l.attr("href",i.attr("src"))},_real:function(){this.d.show()},_insert:function(){var l=this.imgUrl.val();if(l){var i=parseInt(this.imgHeight.val()),m=this.get("editor"),w=parseInt(this.imgWidth.val()),a=this.imgAlign.val(),c=parseInt(this.imgMargin.val()),e="";if(i)e+="height:"+i+"px;";if(w)e+="width:"+w+"px;";if(a)e+="float:"+a+";";isNaN(c)||(e+="margin:"+c+"px;");if(e)e=" style='"+e+"' ";l=new v("<img "+e+"src='"+l+"' alt='' />",null,m.document);l=m.insertElement(l,i||w?null:function(h){h.on("load",
function(){h.detach();h.css({width:h.width()+"px",height:h.height()+"px"})})});this._selectedEl&&m.getSelection().selectElement(l);this.d.hide();m.notifySelectionChange()}},_updateD:function(l){if(this._selectedEl=l){this.imgUrl.val(l.attr("src"));this.imgHeight.val(l.height());this.imgWidth.val(l.width());this.imgAlign.val(l._4e_style("float"));this.imgMargin.val(parseInt(l._4e_style("margin"))||0)}else{this.imgUrl.val("http://");this.imgHeight.val("\u81ea\u52a8");this.imgWidth.val("\u81ea\u52a8");
this.imgAlign.val();this.imgMargin.val("5")}},show:function(l,i){this._prepare();this._updateD(i)}});s.ImageInserter=g;(function(l,i,m){n.register({pluginName:l,func:m,init:function(){var w=this,a=w.el;a.html(i+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');var c=a.one(".ke-bubbleview-url"),e=a.one(".ke-bubbleview-change");
a=a.one(".ke-bubbleview-remove");e._4e_unselectable();c._4e_unselectable();a._4e_unselectable();e.on("click",function(h){w._plugin.show(null,w._selectedEl);h.halt()});a.on("click",function(h){var p=w._plugin;if(r.webkit){var j=p.editor.getSelection().getRanges();j&&j[0]&&(j[0].collapse(true)||1)&&j[0].select()}w._selectedEl._4e_remove();w.hide();p.editor.notifySelectionChange();h.halt()});w.on("afterVisibleChange",function(h){var p=w._selectedEl;h.newVal&&p&&w._plugin._updateTip(c,p)})}})})("image",
"\u56fe\u7247\u7f51\u5740\uff1a ",d)}();u.addPlugin(function(){new s.ImageInserter({editor:u})})});
KISSY.Editor.add("indent",function(u){var s=KISSY.Editor,x={ol:1,ul:1},r=KISSY,v=s.Walker,B=r.DOM,n=r.Node,t=r.UA,g=s.NODE;s.Indent||function(){function d(e){this.type=e;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function k(e){return e.type=CKEDITOR.NODE_ELEMENT&&e.is("li")}function o(e,h,p){var j=h.startContainer;for(e=h.endContainer;j&&j.parent()[0]!==p[0];)j=j.parent();for(;e&&e.parent()[0]!==p[0];)e=e.parent();if(j&&e){var b=j;j=[];for(var f=false;!f;){if(b[0]===
e[0])f=true;j.push(b);b=b.next()}if(!(j.length<1)){b=p._4e_parents(true);for(e=0;e<b.length;e++)if(x[b[e]._4e_name()]){p=b[e];break}b=this.type=="indent"?1:-1;e=j[0];f=j[j.length-1];j={};var q=s.ListUtils.listToArray(p,j),y=q[f._4e_getData("listarray_index")].indent;for(e=e._4e_getData("listarray_index");e<=f._4e_getData("listarray_index");e++){q[e].indent+=b;var A=q[e].parent;q[e].parent=new n(A[0].ownerDocument.createElement(A._4e_name()))}for(e=f._4e_getData("listarray_index")+1;e<q.length&&q[e].indent>
y;e++)q[e].indent+=b;f=s.ListUtils.arrayToList(q,j,null,"p",0);b=[];if(this.type=="outdent"){var C;if((C=p.parent())&&C._4e_name()=="li"){q=f.listNode.childNodes;var H;for(e=q.length-1;e>=0;e--)if((H=new n(q[e]))&&H._4e_name()=="li")b.push(H)}}if(f){B.insertBefore(f.listNode,p[0]);p._4e_remove()}if(b&&b.length)for(e=0;e<b.length;e++){for(H=p=b[e];(H=H.next())&&H._4e_name()in x;){t.ie&&!p._4e_first(function(O){return w(O)&&a(O)})&&p[0].appendChild(h.document.createTextNode("\u00a0"));p[0].appendChild(H[0])}B.insertAfter(p[0],
C[0])}for(e in j)j[e]._4e_clearMarkers(j,true)}}}function l(e,h){h=h.createIterator();h.enforceRealBlocks=true;h.enlargeBr=true;for(var p;p=h.getNextParagraph();)i.call(this,e,p)}function i(e,h){e=parseInt(h._4e_style(this.indentCssProperty),10);if(isNaN(e))e=0;e+=(this.type=="indent"?1:-1)*this.indentOffset;if(e<0)return false;e=Math.max(e,0);e=Math.ceil(e/this.indentOffset)*this.indentOffset;h.css(this.indentCssProperty,e?e+this.indentUnit:"");h[0].style.cssText===""&&h[0].removeAttribute("style");
return true}function m(e){m.superclass.constructor.call(this,e);e=this.get("editor").toolBarDiv;this.el=new c({container:e,contentCls:this.get("contentCls"),title:this.get("title")});this.indentCommand=new d(this.get("type"));this._init()}var w=v.whitespaces(true),a=v.bookmark(false,true);r.augment(d,{exec:function(e){for(var h=e.getSelection(),p=h&&h.getRanges()[0],j=p.startContainer,b=p.endContainer,f=p.getCommonAncestor();f&&!(f[0].nodeType==g.NODE_ELEMENT&&x[f._4e_name()]);)f=f.parent();if(f&&
j[0].nodeType==g.NODE_ELEMENT&&j._4e_name()in x){j=new v(p);j.evaluator=k;p.startContainer=j.next()}if(f&&b[0].nodeType==g.NODE_ELEMENT&&b._4e_name()in x){j=new v(p);j.evaluator=k;p.endContainer=j.previous()}b=h.createBookmarks(true);if(f){for(j=f._4e_first();j&&j[0]&&j._4e_name()!="li";)j=j.next();var q=p.startContainer;(j[0]==q[0]||j._4e_contains(q))&&i.call(this,e,f)||o.call(this,e,p,f)}else l.call(this,e,p);h.selectBookmarks(b)}});var c=s.TripleButton;m.ATTRS={type:{},contentCls:{},editor:{}};
r.extend(m,r.Base,{_init:function(){var e=this.get("editor"),h=this.el;h.on("offClick",this.exec,this);this.get("type")=="outdent"?e.on("selectionChange",this._selectionChange,this):h.set("state",c.OFF)},exec:function(){var e=this.get("editor"),h=this;e.fire("save");setTimeout(function(){h.indentCommand.exec(e);e.fire("save");e.notifySelectionChange()},10)},_selectionChange:function(e){this.get("editor");this.get("type");var h=e.path,p=h.blockLimit;e=this.el;if(h.contains(x))e.set("state",c.OFF);
else(h=h.block||p)&&h._4e_style(this.indentCommand.indentCssProperty)?e.set("state",c.OFF):e.set("state",c.DISABLED)}});s.Indent=m}();u.addPlugin(function(){u.addCommand("outdent",new s.Indent({editor:u,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));u.addCommand("indent",new s.Indent({editor:u,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
KISSY.Editor.add("justify",function(u){var s=KISSY.Editor,x=KISSY,r=s.TripleButton;s.Justify||function(){function v(n,t,g,d){this.editor=n;this.v=t;this.contentCls=d;this.title=g;this._init()}var B=/(-moz-|-webkit-|start|auto)/i;x.augment(v,{_init:function(){var n=this.editor;this.el=new r({contentCls:this.contentCls,title:this.title,container:n.toolBarDiv});n.on("selectionChange",this._selectionChange,this);this.el.on("click",this._effect,this)},_effect:function(){var n=this.editor,t=n.getSelection(),
g=this.el.get("state");if(t){var d=t.createBookmarks(),k=t.getRanges(),o,l;n.fire("save");for(var i=k.length-1;i>=0;i--){o=k[i].createIterator();for(o.enlargeBr=true;l=o.getNextParagraph();){l.removeAttr("align");g==r.OFF?l.css("text-align",this.v):l.css("text-align","")}}n.notifySelectionChange();t.selectBookmarks(d);n.fire("save")}},_selectionChange:function(n){var t=this.el;n=n.path;if(n=n.block||n.blockLimit){n=n.css("text-align").replace(B,"");n==this.v||!n&&this.v=="left"?t.set("state",r.ON):
t.set("state",r.OFF)}}});s.Justify=v}();u.addPlugin(function(){new s.Justify(u,"left","\u5de6\u5bf9\u9f50 ","ke-toolbar-alignleft");new s.Justify(u,"center","\u5c45\u4e2d\u5bf9\u9f50 ","ke-toolbar-aligncenter");new s.Justify(u,"right","\u53f3\u5bf9\u9f50 ","ke-toolbar-alignright")})});
KISSY.Editor.add("link",function(u){var s=KISSY.Editor;s.Link||function(){function x(l){this.editor=l;this._init()}function r(l){return l._4e_ascendant(function(i){return i._4e_name()==="a"&&!!i.attr("href")},true)}var v=KISSY,B=s.TripleButton,n=s.Style,t=v.Node,g=s.Range,d=s.SimpleOverlay,k=s.BubbleView,o={element:"a",attributes:{href:"#(href)",target:"#(target)"}};x.init=function(){var l=new d({title:"\u94fe\u63a5\u5c5e\u6027",mask:true,width:"300px"});this.dialog=l;l.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u7f51\u5740\uff1a </span><input class='ke-link-url' style='width:220px' value='http://'/></label></p><p style='margin-top: 5px;padding-left:45px'><label><input class='ke-link-blank' type='checkbox'/> &nbsp; \u5728\u65b0\u7a97\u53e3\u6253\u5f00\u94fe\u63a5</label></p></div>");
l.foot.html("<button class='ke-link-ok'>\u786e\u5b9a</button> <button class='ke-link-cancel'>\u53d6\u6d88</button>");l.urlEl=l.body.one(".ke-link-url");l.targetEl=l.body.one(".ke-link-blank");var i=l.foot.one(".ke-link-cancel");l.foot.one(".ke-link-ok").on("click",function(m){l.link._link();m.halt()},this);i.on("click",function(m){l.hide();m.halt()},this);x.init=null};k.register({pluginName:"link",func:r,init:function(){var l=this,i=l.el;i.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');
var m=i.one(".ke-bubbleview-url"),w=i.one(".ke-bubbleview-change");i=i.one(".ke-bubbleview-remove");w._4e_unselectable();m._4e_unselectable();i._4e_unselectable();w.on("click",function(a){l._plugin.show();a.halt()});i.on("click",function(a){var c=l._plugin;c._removeLink(l._selectedEl);c.editor.notifySelectionChange();a.halt()});l.on("afterVisibleChange",function(){var a=l._selectedEl;if(a){m.html(a.attr("href"));m.attr("href",a.attr("href"))}})}});v.augment(x,{_init:function(){this.el=new B({container:this.editor.toolBarDiv,
contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5 "});this.el.on("click",this.show,this);k.attach({pluginName:"link",pluginInstance:this})},_removeLink:function(l){var i=this.editor,m={href:l.attr("href")};if(l._4e_hasAttribute("target"))m.target=l.attr("target");l=new n(o,m);i.fire("save");l.remove(i.document);i.fire("save")},_getSelectedLink:function(){var l=this.editor.getSelection();if(l=l&&l.getStartElement())l=r(l);return l},_link:function(){var l,i=this.editor,m=x.dialog,w=m.urlEl.val(),
a;if(v.trim(w)){m.hide();if(a=this._getSelectedLink()){l=new g(i.document);l.selectNodeContents(a);i.getSelection().selectRanges([l]);this._removeLink(a)}a={href:w};a.target=m.targetEl[0].checked?"_blank":"_self";l=i.getSelection().getRanges()[0];if(l.collapsed){l=new t("<a href='"+w+"' target='"+a.target+"'>"+w+"</a>",null,i.document);i.insertElement(l)}else{i.fire("save");l=new n(o,a);l.apply(i.document);i.fire("save")}i.notifySelectionChange()}},_prepare:function(){x.init&&x.init()},_real:function(){var l=
x.dialog,i=this._getSelectedLink();l.link=this;if(i){l.urlEl.val(i.attr("href"));l.targetEl[0].checked=i.attr("target")=="_blank"}l.show()},show:function(){this._prepare()}});s.Utils.lazyRun(x.prototype,"_prepare","_real");s.Link=x}();u.addPlugin(function(){new s.Link(u)})});
KISSY.Editor.add("list",function(u){var s=KISSY.Editor,x={ol:1,ul:1},r=["ol","ul"],v=KISSY,B=s.RANGE,n=s.ElementPath,t=s.Walker,g=s.NODE,d=v.UA,k=v.Node,o=v.DOM;s.List||function(){function l(c){this.type=c}function i(c){i.superclass.constructor.call(this,c);c=this.get("editor").toolBarDiv;this.el=new a({contentCls:this.get("contentCls"),title:this.get("title"),container:c});this.listCommand=new l(this.get("type"));this.listCommand.state=this.get("status");this._init()}var m={listToArray:function(c,
e,h,p,j){if(!x[c._4e_name()])return[];p||(p=0);h||(h=[]);for(var b=0,f=c[0].childNodes.length;b<f;b++){var q=new k(c[0].childNodes[b]);if(q._4e_name()=="li"){var y={parent:c,indent:p,element:q,contents:[]};if(j)y.grandparent=j;else{y.grandparent=c.parent();if(y.grandparent&&y.grandparent._4e_name()=="li")y.grandparent=y.grandparent.parent()}e&&q._4e_setMarker(e,"listarray_index",h.length);h.push(y);for(var A=0,C=q[0].childNodes.length,H;A<C;A++){H=new k(q[0].childNodes[A]);H[0].nodeType==g.NODE_ELEMENT&&
x[H._4e_name()]?m.listToArray(H,e,h,p+1,y.grandparent):y.contents.push(H)}}}return h},arrayToList:function(c,e,h,p){h||(h=0);if(!c||c.length<h+1)return null;for(var j=c[h].parent[0].ownerDocument,b=j.createDocumentFragment(),f=null,q=h,y=Math.max(c[h].indent,0),A=null;;){var C=c[q];if(C.indent==y){if(!f||c[q].parent._4e_name()!=f._4e_name()){f=c[q].parent._4e_clone(false,true);b.appendChild(f[0])}A=f[0].appendChild(C.element._4e_clone(false,true)[0]);for(var H=0;H<C.contents.length;H++)A.appendChild(C.contents[H]._4e_clone(true,
true)[0]);q++}else if(C.indent==Math.max(y,0)+1){q=m.arrayToList(c,null,q,p);A.appendChild(q.listNode);q=q.nextIndex}else if(C.indent==-1&&!h&&C.grandparent){A=x[C.grandparent._4e_name()]?C.element._4e_clone(false,true)[0]:C.grandparent._4e_name()!="td"?j.createElement(p):j.createDocumentFragment();for(H=0;H<C.contents.length;H++)A.appendChild(C.contents[H]._4e_clone(true,true)[0]);if(A.nodeType==g.NODE_DOCUMENT_FRAGMENT&&q!=c.length-1){A.lastChild&&A.lastChild.nodeType==g.NODE_ELEMENT&&A.lastChild.getAttribute("type")==
"_moz"&&o._4e_remove(A.lastChild);o._4e_appendBogus(A)}if(A.nodeType==g.NODE_ELEMENT&&o._4e_name(A)==p&&A.firstChild){o._4e_trim(A);f=A.firstChild;if(f.nodeType==g.NODE_ELEMENT&&o._4e_isBlockBoundary(f)){f=j.createDocumentFragment();o._4e_moveChildren(A,f);A=f}}f=o._4e_name(A);if(!d.ie&&(f=="div"||f=="p"))o._4e_appendBogus(A);b.appendChild(A);f=null;q++}else return null;if(c.length<=q||Math.max(c[q].indent,0)<y)break}if(e)for(c=new k(b.firstChild);c&&c[0];){c[0].nodeType==g.NODE_ELEMENT&&c._4e_clearMarkers(e,
true);c=c._4e_nextSourceNode()}return{listNode:b,nextIndex:q}}},w=/^h[1-6]$/;l.prototype={changeListType:function(c,e,h,p){var j=m.listToArray(e.root,h),b=[];for(c=0;c<e.contents.length;c++){var f=e.contents[c];f=f._4e_ascendant("li",true);if(!(!f||!f[0]||f._4e_getData("list_item_processed"))){b.push(f);f._4e_setMarker(h,"list_item_processed",true)}}f=new k(e.root[0].ownerDocument.createElement(this.type));for(c=0;c<b.length;c++){var q=b[c]._4e_getData("listarray_index");j[q].parent=f}h=m.arrayToList(j,
h,null,"p");var y;j=h.listNode.childNodes.length;for(c=0;c<j&&(y=new k(h.listNode.childNodes[c]));c++)y._4e_name()==this.type&&p.push(y);o.insertBefore(h.listNode,e.root[0]);e.root._4e_remove()},createList:function(c,e,h){var p=e.contents;c=e.root[0].ownerDocument;var j=[];if(p.length==1&&p[0][0]===e.root[0]){var b=new k(c.createElement("div"));p[0][0].nodeType!=g.NODE_TEXT&&p[0]._4e_moveChildren(b);p[0][0].appendChild(b[0]);p[0]=b}e=e.contents[0].parent();for(b=0;b<p.length;b++)e=e._4e_commonAncestor(p[b].parent());
for(b=0;b<p.length;b++)for(var f=p[b],q;q=f.parent();){if(q[0]===e[0]){j.push(f);break}f=q}if(!(j.length<1)){p=new k(j[j.length-1][0].nextSibling);b=new k(c.createElement(this.type));for(h.push(b);j.length;){h=j.shift();f=new k(c.createElement("li"));if(w.test(h._4e_name()))f[0].appendChild(h[0]);else{h._4e_copyAttributes(f);h._4e_moveChildren(f);h._4e_remove()}b[0].appendChild(f[0]);d.ie||f._4e_appendBogus()}p[0]?o.insertBefore(b[0],p[0]):e[0].appendChild(b[0])}},removeList:function(c,e,h){function p(H){if((A=
new k(y[H?"firstChild":"lastChild"]))&&!(A[0].nodeType==g.NODE_ELEMENT&&A._4e_isBlockBoundary())&&(C=e.root[H?"_4e_previous":"_4e_next"](t.whitespaces(true)))&&!(A[0].nodeType==g.NODE_ELEMENT&&C._4e_isBlockBoundary({br:1})))o[H?"insertBefore":"insertAfter"](c.document.createElement("br"),A[0])}for(var j=m.listToArray(e.root,h),b=[],f=0;f<e.contents.length;f++){var q=e.contents[f];q=q._4e_ascendant("li",true);if(!(!q||q._4e_getData("list_item_processed"))){b.push(q);q._4e_setMarker(h,"list_item_processed",
true)}}q=null;for(f=0;f<b.length;f++){q=b[f]._4e_getData("listarray_index");j[q].indent=-1;q=q}for(f=q+1;f<j.length;f++)if(j[f].indent>Math.max(j[f-1].indent,0)){b=j[f-1].indent+1-j[f].indent;for(q=j[f].indent;j[f]&&j[f].indent>=q;){j[f].indent+=b;f++}f--}var y=m.arrayToList(j,h,null,"p").listNode,A,C;p(true);p();o.insertBefore(y,e.root);e.root._4e_remove()},exec:function(c){var e=c.getSelection(),h=e&&e.getRanges();if(!(!h||h.length<1)){for(var p=e.createBookmarks(true),j=[],b={};h.length>0;){var f=
h.shift(),q=f.getBoundaryNodes(),y=q.startNode,A=q.endNode;y[0].nodeType==g.NODE_ELEMENT&&y._4e_name()=="td"&&f.setStartAt(q.startNode,B.POSITION_AFTER_START);A[0].nodeType==g.NODE_ELEMENT&&A._4e_name()=="td"&&f.setEndAt(q.endNode,B.POSITION_BEFORE_END);f=f.createIterator();for(f.forceBrBreak=false;q=f.getNextParagraph();){y=new n(q);A=y.elements;var C=null,H=false,O=y.blockLimit,z;for(y=A.length-1;y>=0&&(z=A[y]);y--)if(x[z._4e_name()]&&O.contains(z)){O._4e_removeData("list_group_object");if(y=z._4e_getData("list_group_object"))y.contents.push(q);
else{y={root:z,contents:[q]};j.push(y);z._4e_setMarker(b,"list_group_object",y)}H=true;break}if(!H)if(O._4e_getData("list_group_object"))O._4e_getData("list_group_object").contents.push(q);else{y={root:O,contents:[q]};O._4e_setMarker(b,"list_group_object",y);j.push(y)}}}for(h=[];j.length>0;){y=j.shift();if(this.state=="off")x[y.root._4e_name()]?this.changeListType(c,y,b,h):this.createList(c,y,h);else this.state=="on"&&x[y.root._4e_name()]&&this.removeList(c,y,b)}for(y=0;y<h.length;y++){C=h[y];var D=
this;(c=function(I){var L=C[I?"_4e_previous":"_4e_next"](t.whitespaces(true));if(L&&L[0]&&L._4e_name()==D.type){L._4e_remove();L._4e_moveChildren(C,I?true:false)}})();c(true)}s.Utils.clearAllMarkers(b);e.selectBookmarks(p)}}};var a=s.TripleButton;i.ATTRS={editor:{},type:{},contentCls:{}};v.extend(i,v.Base,{_init:function(){var c=this,e=c.get("editor"),h=c.el;c=c;h.on("click",c._change,c);e.on("selectionChange",c._selectionChange,c)},_change:function(){var c=this.get("editor");this.get("type");var e=
this.el;c.fire("save");this.listCommand.state=e.get("state");this.listCommand.exec(c);c.fire("save");c.notifySelectionChange()},_selectionChange:function(c){this.get("editor");var e=this.get("type"),h=c.path,p;c=this.el;var j=h.blockLimit;if(h=h.elements)for(var b=0;b<h.length&&(p=h[b])&&p[0]!==j[0];b++){var f=v.indexOf(h[b]._4e_name(),r);if(f!==-1)if(r[f]===e){c.set("state",a.ON);return}else break}c.set("state",a.OFF)}});s.ListUtils=m;s.List=i}();u.addPlugin(function(){new s.List({editor:u,title:"\u9879\u76ee\u5217\u8868",
contentCls:"ke-toolbar-ul",type:"ul"});new s.List({editor:u,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
KISSY.Editor.add("localStorage",function(){function u(){r.fire("storeReady")}function s(){n=r.Utils.flash.createSWFRuntime(B,{attrs:{allowScriptAccess:"always",allowNetworking:"all",scale:"noScale"},flashVars:{allowedDomain:location.hostname,shareData:true,YUISwfId:x.guid(t),YUIBridgeCallback:v+".ready",browser:t,useCompression:true}})}var x=KISSY,r=x.Editor,v;v=r.STORE="localStorage";if(!r.storeReady){r.storeReady=function(g){r.on("storeReady",g)};r.on("storeReady",function(){r.storeReady=function(g){g()};
r.detach("storeReady")})}if(window[v])window[v]._ke||u();else{var B=r.Config.base+r.Utils.debugUrl("plugins/localStorage/swfstore.swf"),n,t="ke-localstorage-";window[v]={_ke:1,getItem:function(g){return n.getValueOf(g)},setItem:function(g,d){return n.setItem(g,d)},removeItem:function(g){return n.removeItem(g)},ready:function(g,d){if(d.type=="contentReady"){u();this.ready=function(){}}}};s()}});
KISSY.Editor.add("maximize",function(u){var s=KISSY.Editor,x=KISSY,r=x.UA,v=x.Node,B=x.Event,n=s.TripleButton,t=x.DOM,g;s.Maximize||function(){function d(k){this.editor=k;this._init()}d.init=function(){g=new v("<iframe style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'></iframe>");document.body.appendChild(g[0]);d.init=null};x.augment(d,{_init:function(){this.el=new n({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u5168\u5c4f",contentCls:"ke-toolbar-maximize"});
this.el.on("offClick",this.maximize,this);this.el.on("onClick",this.restore,this);s.Utils.lazyRun(this,"_prepare","_real")},restore:function(){var k=this,o=k.editor;B.remove(window,"resize",k._maximize,k);this._saveEditorStatus();o.wrap.css({height:k.iframeHeight});(new v(document.body)).css({width:"",height:"",overflow:""});document.documentElement.style.overflow="";o.editorWrap.css({position:"static",width:k.editorWrapWidth});g.css({left:"-99999px",top:"-99999px"});window.scrollTo(k.scrollLeft,
k.scrollTop);k.el.set("state",n.OFF);setTimeout(function(){k._restoreEditorStatus()},30);o.notifySelectionChange()},_saveSate:function(){var k=this.editor;this.iframeHeight=k.wrap._4e_style("height");this.editorWrapWidth=k.editorWrap._4e_style("width");this.scrollLeft=t.scrollLeft();this.scrollTop=t.scrollTop();window.scrollTo(0,0)},_saveEditorStatus:function(){var k=this.editor;if(r.gecko&&k.iframeFocus)this.savedRanges=(k=k.getSelection())&&k.getRanges()},_restoreEditorStatus:function(){var k=this.editor,
o=k.getSelection();if(r.gecko&&k.iframeFocus){this.el.el[0].focus();k.focus();this.savedRanges&&o&&o.selectRanges(this.savedRanges)}if(k.iframeFocus&&o)(k=o.getStartElement())&&k[0]&&k._4e_scrollIntoView()},_maximize:function(){var k=this.editor,o=t.viewportHeight(),l=t.viewportWidth(),i=k.statusDiv?k.statusDiv.height():0,m=k.toolBarDiv.height();if(r.ie){document.documentElement.style.overflow="hidden";document.body.style.overflow="hidden"}else(new v(document.body)).css({width:0,height:0,overflow:"hidden"});
k.editorWrap.css({position:"absolute",zIndex:990,width:l+"px"});g.css({zIndex:985,height:o+"px",width:l+"px"});k.editorWrap.offset({left:0,top:0});g.css({left:0,top:0});k.wrap.css({height:o-i-m-14+"px"});k.notifySelectionChange()},_real:function(){var k=this;this._saveEditorStatus();this._saveSate();this._maximize();this._maximize();B.on(window,"resize",k._maximize,k);this.el.set("state",n.ON);setTimeout(function(){k._restoreEditorStatus()},30)},_prepare:function(){d.init&&d.init()},maximize:function(){this._prepare()}});
s.Maximize=d}();u.addPlugin(function(){new s.Maximize(u)})});
KISSY.Editor.add("music",function(u){function s(l){return l.indexOf(d)!=-1}var x=KISSY.Editor,r=KISSY,v=r.DOM,B=r.UA,n=r.Event,t=x.Flash,g="ke_music",d="niftyplayer.swf",k=u.htmlDataProcessor,o=k&&k.dataFilter;o&&o.addRules({elements:{object:function(l){var i=l.attributes;if(!(i.classid&&String(i.classid).toLowerCase())){for(i=0;i<l.children.length;i++)if(l.children[i].name=="embed"){if(!t.isFlashEmbed(l.children[i]))return null;if(s(l.children[i].attributes.src))return k.createFakeParserElement(l,g,
"music",true)}return null}for(i=0;i<l.children.length;i++){var m=l.children[i];if(m.name=="param"&&m.attributes.name=="movie")if(s(m.attributes.value))return k.createFakeParserElement(l,g,"music",true)}},embed:function(l){if(!t.isFlashEmbed(l))return null;if(s(l.attributes.src))return k.createFakeParserElement(l,g,"music",true)}}},4);x.MusicInserter||function(){function l(p){l.superclass.constructor.apply(this,arguments);p.cfg.disableObjectResizing||n.on(p.document.body,B.ie?"resizestart":"resize",
function(j){v.hasClass(j.target,g)&&j.preventDefault()})}function i(p){return p._4e_name()==="img"&&!!p.hasClass(g)&&p}function m(p){return p.replace(/^.+niftyplayer\.swf\?file=/,"")}var w=x.Config.base+"plugins/music/niftyplayer.swf?file=#(music)",a="<p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3'/></label></p><p style='margin:5px 0'><label>\u5bf9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u9f50\uff1a <select class='ke-music-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
x.Utils.duplicateStr("&nbsp;",1)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-music-margin' style='width:60px' value='5'/> \u50cf\u7d20</label><p>",c=/#\(music\)/g,e=["img."+g];r.extend(l,t,{_config:function(){this._cls=g;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml=a;this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=
h;this._flashRules=e},_initD:function(){var p=this,j=p.d;p.dUrl=j.el.one(".ke-music-url");p.dAlign=j.el.one(".ke-music-align");p.dMargin=j.el.one(".ke-music-margin");var b=j.el.one(".ke-music-ok");j=j.el.one(".ke-music-cancel");b.on("click",p._gen,p);j.on("click",function(){p.d.hide()})},_getDInfo:function(){return{url:w.replace(c,this.dUrl.val()),attrs:{width:165,height:37,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}},_getFlashUrl:function(p){return m(l.superclass._getFlashUrl.call(this,
p))},_updateD:function(){var p=this.editor,j=this.selectedFlash;if(j){p=p.restoreRealElement(j);this.dUrl.val(this._getFlashUrl(p));this.dAlign.val(j.attr("align"));this.dMargin.val(parseInt(p._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3");this.dAlign.val("");this.dMargin.val("5")}}});t.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",i);x.MusicInserter=l;var h={"\u97f3\u4e50\u5c5e\u6027":function(p){var j=p.getSelection();j=(j=j&&j.getStartElement())&&
i(j);p=p._toolbars.music;j&&p.show(null,j)}}}();u.addPlugin(function(){new x.MusicInserter(u)})});
KISSY.Editor.add("overlay",function(){function u(){u.superclass.constructor.apply(this,arguments);this._init()}var s=KISSY.Editor,x=KISSY,r=x.UA,v=s.focusManager,B=x.Node,n=x.Event,t=x.DOM,g,d,k,o={left:"-9999px",top:"-9999px"};if(!s.SimpleOverlay){u.init=function(){var l=document.body,i={width:"100%",height:t.docHeight()+"px",opacity:0.4};x.mix(i,o);g=(new B('<div class="ke-mask">&nbsp;</div>')).appendTo(l);g.css(i);if(r.ie&&r.ie==6){k=(new B("<iframe class='ke-dialog-iframe'></iframe>")).appendTo(l);
d=(new B("<iframe class='ke-mask'></iframe>")).appendTo(l);x.all([d[0],k[0]]).css(i)}u.init=null};u.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false},draggable:{value:true}};x.extend(u,x.Base,{_init:function(){var l=this;l._createEl();var i=l.el;l.on("afterVisibleChange",function(m){if(m=m.newVal){typeof m=="boolean"?l.center():i.offset(m);l.fire("show")}else{i.css(o);l.fire("hide")}});if(l.get("focusMgr")){l._initFocusNotice();l.on("afterVisibleChange",
l._editorFocusMg,l)}l.on("afterVisibleChange",function(m){m.newVal?l._register():l._unregister()});if(r.ie===6){l.on("show",function(){var m=i.width(),w=i.height();k.css({width:m+"px",height:w+"px"});k.css(i.offset())});l.on("hide",function(){k.css(o)})}if(l.get("mask")){l.on("show",function(){x.all([g[0],d&&d[0]]).css({left:"0px",top:"0px"})});l.on("hide",function(){x.all([g[0],d&&d[0]]).css(o)})}},_register:function(){n.on(document,"keydown",this._keydown,this);g&&g.on("click",this.hide,this)},
_keydown:function(l){if(l.keyCode==27){this.hide();l.halt()}},_unregister:function(){n.remove(document,"keydown",this._keydown,this);g&&g.detach("click",this.hide,this)},_createEl:function(){var l=this,i=l.get("el");if(!i){i=(new B("<div class='ke-dialog' style='width:@width@'><div class='ke-hd'><span class='ke-hd-title'>@title@</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>".replace(/@width@/,l.get("width")).replace(/@title@/,
l.get("title")))).appendTo(document.body);var m=i.one(".ke-hd"),w=x.guid("ke-overlay-head-");l.body=i.one(".ke-bd");l.foot=i.one(".ke-ft");l._close=i.one(".ke-close");l._title=m.one("h1");l._close.on("click",function(a){a.preventDefault();l.hide()});if(l.get("draggable")){m[0].id=w;m=new s.Drag({node:i,handlers:{id:m}});r.ie===6&&m.on("move",function(){k.offset(i.offset())})}}l.set("el",i);l.el=i;i.css(o)},center:function(){var l=this.el,i=l.width(),m=l.height(),w=t.viewportWidth(),a=t.viewportHeight();
i=(w-i)/2+t.scrollLeft();m=(a-m)/2+t.scrollTop();if(m-t.scrollTop()>200)m-=150;l.css({left:i+"px",top:m+"px"})},_prepareShow:function(){u.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;return this._focusEl=(new B("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.el)},_initFocusNotice:function(){var l=this,i=l._getFocusEl();i.on("focus",function(){l.fire("focus")});i.on("blur",function(){l.fire("blur")})},
_editorFocusMg:function(l){var i=this._focusEditor;if(l.newVal){i=this._focusEditor=v.currentInstance();r.webkit||this._getFocusEl()[0].focus();var m=this.el.one("input");if(m)setTimeout(function(){try{m[0].focus();m[0].select()}catch(w){}},0);else if(r.ie&&i)if(l=i.document.selection.createRange())if(l.item&&l.item(0).ownerDocument==i.document){i=document.body.createTextRange();i.moveToElementText(this.el._4e_first()[0]);i.collapse(true);i.select()}}else i&&i.focus()},_realShow:function(l){this.set("visible",
l||true)},show:function(l){this._prepareShow(l)},hide:function(){this.set("visible",false)}});s.Utils.lazyRun(u.prototype,"_prepareShow","_realShow");s.SimpleOverlay=u}});
KISSY.Editor.add("preview",function(u){var s=KISSY.Editor,x=KISSY,r=s.TripleButton;s.Preview||function(){function v(B){this.editor=B;this._init()}x.augment(v,{_init:function(){this.el=new r({container:this.editor.toolBarDiv,cls:"ke-tool-editor-source",title:"\u9884\u89c8",contentCls:"ke-toolbar-preview"});this.el.on("offClick",this._show,this)},_show:function(){var B=this.editor,n=640,t=420,g=80;try{var d=window.screen;n=Math.round(d.width*0.8);t=Math.round(d.height*0.7);g=Math.round(d.width*0.1)}catch(k){}B=
B._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/,"<body>\n"+B.getData()+"\n</body>");n=window.open("",null,"toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width="+n+",height="+t+",left="+g);n.document.open();n.document.write(B);n.document.close();n.focus()}});s.Preview=v}();u.addPlugin(function(){new s.Preview(u)})});
KISSY.Editor.add("progressbar",function(){var u=KISSY;u.Editor.ProgressBar||function(){function s(){s.superclass.constructor.apply(this,arguments);this._init()}u.DOM.addStyleSheet(".ke-progressbar {border:1px solid #8F8F73;}.ke-progressbar-inner {background-color:#FF8C00;height:100%;}.ke-progressbar-title {width:50px;left:50%;position:absolute;}","ke_progressbar");s.ATTRS={width:{},height:{},progress:{}};u.extend(s,u.Base,{_init:function(){var x=new Node("<div class='ke-progressbar' style='width:"+
this.get("width")+";height:"+this.get("height")+";'>"),r=(new Node("<div class='ke-progressbar-inner'>")).appendTo(x),v=(new Node("<span class='ke-progressbar-title'>")).appendTo(x);this.el=x;this._title=v;this._p=r},_progressChange:function(x){x=x.newVal;this._p.css("width",x+"%");this._title.html(x+"%")}})}()});
KISSY.Editor.add("removeformat",function(u){function s(o){this.editor=o;this._init()}function x(o,l){for(var i=0;i<l.length;i++)o.removeAttr(l[i])}var r=KISSY.Editor,v=KISSY,B=r.RANGE,n=r.ElementPath,t=r.NODE,g=r.TripleButton,d="b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s",k="class,style,lang,width,height,align,hspace,valign".split(",");d=new RegExp("^(?:"+d.replace(/,/g,"|")+")$","i");v.augment(s,{_init:function(){this.el=new g({title:"\u6e05\u9664\u683c\u5f0f",
contentCls:"ke-toolbar-removeformat",container:this.editor.toolBarDiv});this.el.on("offClick",this._remove,this)},_remove:function(){var o=this.editor,l=d;l.lastIndex=0;var i=o.getSelection().getRanges();o.fire("save");for(var m=0,w;w=i[m];m++)if(!w.collapsed){w.enlarge(B.ENLARGE_ELEMENT);var a=w.createBookmark(),c=a.startNode,e=a.endNode,h=function(p){for(var j=new n(p),b=j.elements,f=1,q;q=b[f];f++){if(q._4e_equals(j.block)||q._4e_equals(j.blockLimit))break;l.test(q._4e_name())&&p._4e_breakParent(q)}};
h(c);h(e);for(c=c._4e_nextSourceNode(true,t.NODE_ELEMENT);c;){if(c._4e_equals(e))break;h=c._4e_nextSourceNode(false,t.NODE_ELEMENT);c._4e_name()=="img"&&c.attr("_cke_realelement")||(l.test(c._4e_name())?c._4e_remove(true):x(c,k));c=h}w.moveToBookmark(a)}o.getSelection().selectRanges(i);o.fire("save")}});u.addPlugin(function(){new s(u)})});
KISSY.Editor.add("resize",function(u){var s=KISSY,x=s.Editor,r=s.Node;x.Resizer||function(){function v(n){this.editor=n;this._init()}var B=x.Draggable;s.augment(v,{_init:function(){var n=this.editor,t=n.statusDiv,g=new r("<div class='ke-resizer'></div>");g.appendTo(t);t=new B({node:g});var d=0,k=0,o=n.wrap,l=n.editorWrap;t.on("start",function(){d=o.height();k=l.width()});t.on("move",function(i){var m=i.pageX-this.startMousePos.left;o.height(d+(i.pageY-this.startMousePos.top));l.width(k+m)})}});x.Resizer=
v}();u.addPlugin(function(){new x.Resizer(u)})});
KISSY.Editor.add("select",function(){function u(n){u.superclass.constructor.call(this,n);this._init()}var s=KISSY,x=s.Node,r=s.Event,v=s.DOM,B=s.Editor;if(!B.Select){u.ATTRS={container:{},doc:{},value:{},width:{},title:{},items:{}};s.extend(u,s.Base,{_init:function(){var n=this.get("container"),t=new x("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'></span><span class='ke-select-drop'></span></a></span>"),g=this.get("title"),d=t.one(".ke-select-text");
t.one(".ke-select-drop");d.html(g);d.css("width",this.get("width"));t._4e_unselectable();t.attr("title",g);t.appendTo(n);t.on("click",this._click,this);this.el=t;this.title=d;this._focusA=t.one("a.ke-select");B.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this)},_valueChange:function(n){n=n.newVal;for(var t=this.get("title"),g=this.get("items"),d=0;d<g.length;d++){var k=g[d];if(k.value==n){t=k.name;break}}this.title.html(t)},_itemsChange:function(n){n=n.newVal;
var t=this._selectList;t.html("");if(n)for(var g=0;g<n.length;g++){var d=n[g];(new x("<a class='ke-select-menu-item' href='#' data-value='"+d.value+"'>"+d.name+"</a>",d.attrs)).appendTo(t)._4e_unselectable()}this.as=t.all("a")},_prepare:function(){var n=this,t=n.el,g=n._focusA,d=new x("<div class='ke-menu' onmousedown='return false;'></div>"),k=new B.SimpleOverlay({el:d,focusMgr:false}),o=n.get("items");n.menu=k;n.get("title")&&(new x("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+
n.get("title")+"</div>")).appendTo(d);n._selectList=(new x("<div>")).appendTo(d);n._itemsChange({newVal:o});n.get("popUpWidth")&&d.css("width",n.get("popUpWidth"));d.appendTo(document.body);k.on("show",function(){g.addClass("ke-select-active")});k.on("hide",function(){g.removeClass("ke-select-active")});r.on([document,n.get("doc")],"click",function(l){t._4e_contains(l.target)||k.hide()});d.on("click",n._select,n);n.as=n._selectList.all("a");r.on(d[0],"mouseenter",function(){n.as.removeClass("ke-menu-selected")});
n.on("afterItemsChange",n._itemsChange,n)},_select:function(n){n.halt();var t=this.menu,g=t.el;if(n=(new x(n.target))._4e_ascendant(function(o){return g._4e_contains(o)&&o._4e_name()=="a"},true)){var d=this.get("value"),k=n.attr("data-value");this.set("value",k);this.fire("click",{newVal:k,preVal:d,name:n.html()});t.hide()}},_real:function(){var n=this.el.offset();n.top+=this.el.height();n.left+=1;if(n.left+this.menu.el.width()>v.viewportWidth()-60)n.left=v.viewportWidth()-this.menu.el.width()-60;
this.menu.show(n)},_click:function(n){n.preventDefault();var t=this.get("value");if(this._focusA.hasClass("ke-select-active"))this.menu.hide();else{this._prepare();t&&this.menu&&this.as.each(function(g){g.attr("data-value")==t?g.addClass("ke-menu-selected"):g.removeClass("ke-menu-selected")})}}});B.Select=u}});
KISSY.Editor.add("smiley",function(u){var s=KISSY.Editor,x=KISSY,r=x.DOM,v=x.Event,B=x.Node,n=s.SimpleOverlay,t=s.TripleButton;s.Smiley||function(){function g(o){this.editor=o;this._init()}for(var d="<div class='ke-popup-wrap'><div class='ke-smiley-sprite'>",k=0;k<=98;k++)d+="<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/"+k+".gif'></a>";d+="</div></div>";x.augment(g,{_init:function(){this.el=new t({contentCls:"ke-toolbar-smiley",title:"\u63d2\u5165\u8868\u60c5",container:this.editor.toolBarDiv});
this.el.on("offClick",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_hidePanel:function(o){var l=this;r._4e_ascendant(o.target,function(i){return i[0]===l.el.el[0]})||this.smileyWin.hide()},_selectSmiley:function(o){o.halt();var l=this.editor;o=o.target;var i;if(r._4e_name(o)=="a"&&(i=r.attr(o,"data-icon"))){i=new B("<img alt='' src='"+i+"'/>",null,l.document);l.insertElement(i);this.smileyWin.hide()}},_prepare:function(){var o=this.editor;this.smileyPanel=new B(d);this.smileyWin=new n({el:this.smileyPanel,
focusMgr:false,mask:false});document.body.appendChild(this.smileyPanel[0]);this.smileyPanel.on("click",this._selectSmiley,this);v.on(document,"click",this._hidePanel,this);v.on(o.document,"click",this._hidePanel,this)},_real:function(){var o=this.el.el.offset();o.top+=this.el.el.height()+5;if(o.left+this.smileyPanel.width()>r.viewportWidth()-60)o.left=r.viewportWidth()-this.smileyPanel.width()-60;this.smileyWin.show(o)},_show:function(o){this._prepare(o)}});s.Smiley=g}();u.addPlugin(function(){new s.Smiley(u)})});
KISSY.Editor.add("sourcearea",function(u){var s=KISSY.Editor,x=KISSY,r=x.UA,v=s.TripleButton;s.SourceArea||function(){function B(n){this.editor=n;this._init()}x.augment(B,{_init:function(){var n=this.editor;this.el=new v({container:n.toolBarDiv,cls:"ke-tool-editor-source",title:"\u6e90\u7801",contentCls:"ke-toolbar-source"});this.el.on("offClick",this._show,this);this.el.on("onClick",this._hide,this);n.textarea.on("mousedown",function(t){t.stopPropagation()})},_show:function(){var n=this.editor,t=
this.el;n.textarea.val(n.getData());n._showSource();t.set("state",v.ON)},_hide:function(){var n=this.editor,t=n.textarea,g=this.el;n._hideSource();n.setData(t.val());if(r.gecko&&n.iframeFocus){g.el[0].focus();n.focus()}g.set("state",v.OFF)}});s.SourceArea=B}();u.addPlugin(function(){new s.SourceArea(u)})});
KISSY.Editor.add("table",function(u,s){var x=KISSY.Editor,r=KISSY,v=r.Node,B=r.DOM,n=x.Walker,t=r.UA,g=x.NODE,d=x.TripleButton,k=x.SimpleOverlay,o=x.Utils.isNumber,l=x.ContextMenu,i=["tr","th","td","tbody","table"],m=r.trim,w;w=(t.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var a=u.htmlDataProcessor,c=a&&a.dataFilter;a=a&&a.htmlFilter;c&&c.addRules({elements:{table:function(e){e=e.attributes;var h=e["class"],p=parseInt(e.border,10);if(!p||p<=0)e["class"]=(h||"")+" ke_show_border"}}});a&&a.addRules({elements:{table:function(e){e=e.attributes;var h=e["class"];if(h)e["class"]=r.trim(h.replace("ke_show_border","").replace(/\s{2}/," "))}}});x.TableUI||function(){function e(z){this.editor=z;this.selectedTable=
null;z._toolbars=z._toolbars||{};z._toolbars.table=this;this._init()}function h(z){return m(z).length!=0}function p(z){function D(X){if(!(M.length>0))if(X[0].nodeType==g.NODE_ELEMENT&&H.test(X._4e_name())&&!X._4e_getData("selected_cell")){X._4e_setMarker(N,"selected_cell",true);M.push(X)}}for(var I=z.createBookmarks(),L=z.getRanges(),M=[],N={},S=0;S<L.length;S++){var R=L[S];if(R.collapsed){R=R.getCommonAncestor();(R=R._4e_ascendant("td",true)||R._4e_ascendant("th",true))&&M.push(R)}else{R=new n(R);
var Y;for(R.guard=D;Y=R.next();)if((Y=Y.parent())&&H.test(Y._4e_name())&&!Y._4e_getData("selected_cell")){Y._4e_setMarker(N,"selected_cell",true);M.push(Y)}}}x.Utils.clearAllMarkers(N);z.selectBookmarks(I);return M}function j(z){z=z.cells;for(var D=0;D<z.length;D++){z[D].innerHTML="";t.ie||(new v(z[D]))._4e_appendBogus()}}function b(z,D){if(z=z.getStartElement()._4e_ascendant("tr")){var I=z._4e_clone(true);I.insertBefore(z);j(D?I[0]:z[0])}}function f(z){if(z instanceof x.Selection){var D=p(z),I=D.length;
z=[];for(var L,M,N=0;N<I;N++){var S=D[N].parent(),R=S[0].rowIndex;!N&&(L=R-1);z[R]=S;N==I-1&&(M=R+1)}N=S._4e_ascendant("table");L=new v(M<N[0].rows.length&&N[0].rows[M]||L>0&&N[0].rows[L]||N[0].parentNode);for(N=z.length;N>=0;N--)z[N]&&f(z[N]);return L}else if(z instanceof v){N=z._4e_ascendant("table");N[0].rows.length==1?N._4e_remove():z._4e_remove()}return 0}function q(z,D){z=z.getStartElement();if(z=z._4e_ascendant("td",true)||z._4e_ascendant("th",true))for(var I=z._4e_ascendant("table"),L=z[0].cellIndex,
M=0;M<I[0].rows.length;M++){var N=I[0].rows[M];if(!(N.cells.length<L+1)){z=new v(N.cells[L].cloneNode(false));t.ie||z._4e_appendBogus();N=new v(N.cells[L]);D?z.insertBefore(N):z.insertAfter(N)}}}function y(z){var D=[],I=z[0]&&z[0]._4e_ascendant("table"),L,M,N,S;L=0;for(M=z.length;L<M;L++)D.push(z[L][0].cellIndex);D.sort();L=1;for(M=D.length;L<M;L++)if(D[L]-D[L-1]>1){N=D[L-1]+1;break}N||(N=D[0]>0?D[0]-1:D[D.length-1]+1);z=I[0].rows;L=0;for(M=z.length;L<M;L++)if(S=z[L].cells[N])break;return S?new v(S):
I._4e_previous()}function A(z){if(z instanceof x.Selection){var D=p(z),I=y(D);for(z=D.length-1;z>=0;z--)D[z]&&A(D[z]);return I}else if(z instanceof v){D=z._4e_ascendant("table");if(!D)return null;I=z[0].cellIndex;for(z=D[0].rows.length-1;z>=0;z--){var L=new v(D[0].rows[z]);if(!I&&L[0].cells.length==1)f(L);else L[0].cells[I]&&L[0].removeChild(L[0].cells[I])}}return null}function C(z,D){var I=new x.Range(z[0].ownerDocument);if(!I.moveToElementEditablePosition(z,D?true:s)){I.selectNodeContents(z);I.collapse(D?
false:true)}I.select(true)}r.augment(e,{_init:function(){var z=this.editor,D={};this.el=new d({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:z.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var I in O)(function(L){D[L]=function(){z.fire("save");O[L](z);z.fire("save")}})(I);l.register(z.document,{rules:i,width:"120px",funcs:D});x.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var z=this,D=new k({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});
D.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='6'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='6'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='6'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='6'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td></tr><tr><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='6'/></label> &nbsp;\u50cf\u7d20</select></td><td></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
D.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");var I=D.body;D.twidth=I.one(".ke-table-width");D.theight=I.one(".ke-table-height");D.tborder=I.one(".ke-table-border");D.tcaption=I.one(".ke-table-caption");D.talign=I.one(".ke-table-align");D.trows=I.one(".ke-table-rows");D.tcols=I.one(".ke-table-cols");D.thead=I.one(".ke-table-head");var L=D.foot.one(".ke-table-ok"),M=D.foot.one(".ke-table-cancel");D.twidthunit=I.one(".ke-table-width-unit");
z.tableDialog=D;L.on("click",z._tableOk,z);D.on("hide",function(){z.selectedTable=null});M.on("click",function(){D.hide()})},_tableOk:function(){for(var z=this.tableDialog,D=z.el.all("input"),I=0;I<D.length;I++){var L=new v(D[I]),M=L.val(),N=L.parent("label").text();if(!L._4e_equals(z.tcaption)){if(r.trim(M)&&!o(M)||!L._4e_equals(z.tborder)&&parseInt(M)<=0){alert(N+"\u8bf7\u8f93\u5165\u6b63\u6570");return}if(L._4e_equals(z.twidth)&&z.twidthunit.val()=="%")if(parseInt(M)>100){alert(N+"\u8bf7\u8f93\u51650-100\u4e4b\u95f4");
return}}}this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var z=this.tableDialog,D=this.selectedTable,I=D.one("caption");h(z.talign.val())?D.attr("align",m(z.talign.val())):D.removeAttr("align");h(z.tborder.val())?D.attr("border",m(z.tborder.val())):D.removeAttr("border");!h(z.tborder.val())||z.tborder.val()=="0"?D.addClass("ke_show_border"):D.removeClass("ke_show_border");h(z.twidth.val())?D.css("width",m(z.twidth.val())+z.twidthunit.val()):D.css("width","");h(z.theight.val())?
D.css("height",m(z.theight.val())):D.css("height","");if(h(z.tcaption.val()))I&&I[0]?I.html(m(z.tcaption.val())):(new v("<caption><span>"+m(z.tcaption.val())+"</span></caption>")).insertBefore(D[0].firstChild);else I&&I._4e_remove();z.hide()},_genTable:function(){var z=this.tableDialog,D="<table ",I,L=parseInt(z.tcols.val())||1,M=parseInt(z.trows.val())||1,N=t.ie?"":"<br/>",S=this.editor;if(h(z.talign.val()))D+="align='"+r.trim(z.talign.val())+"' ";if(h(z.tborder.val()))D+="border='"+r.trim(z.tborder.val())+
"' ";if(h(z.twidth.val())||h(z.theight.val())){D+="style='";if(h(z.twidth.val()))D+="width:"+r.trim(z.twidth.val())+z.twidthunit.val()+";";if(h(z.theight.val()))D+="height:"+r.trim(z.theight.val())+"px;";D+="' "}if(!h(z.tborder.val())||r.trim(z.tborder.val())=="0")D+="class='ke_show_border' ";D+=">";if(h(z.tcaption.val()))D+="<caption><span>"+r.trim(z.tcaption.val())+"</span></caption>";if(z.thead.val()){D+="<thead>";D+="<tr>";for(I=0;I<L;I++)D+="<th>"+N+"</th>";D+="</tr>";D+="</thead>";M-=1}D+="<tbody>";
for(var R=0;R<M;R++){D+="<tr>";for(I=0;I<L;I++)D+="<td>"+N+"</td>";D+="</tr>"}D+="</tbody>";D+="</table>";D=new v(D,null,S.document);S.insertElement(D);z.hide()},_fillTableDialog:function(){var z=this.tableDialog,D=this.selectedTable,I=D.one("caption");z.talign.val(D.attr("align")||"");z.tborder.val(D.attr("border")||"");var L=D._4e_style("width")||"";z.twidth.val(L.replace(/px|%/i,""));L.indexOf("%")!=-1?z.twidthunit.val("%"):z.twidthunit.val("px");z.theight.val((D._4e_style("height")||"").replace(/px|%/i,
""));L="";if(I)L=I.text();z.tcaption.val(L);z.trows.val(D.one("tbody").children().length);z.tcols.val(D.one("tr").children().length);z.thead.val(D._4e_first(function(M){return M._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},
_tableShow:function(){this._prepareTableShow()}});var H=/^(?:td|th)$/,O={"\u8868\u683c\u5c5e\u6027":function(z){var D=z.getSelection();if(D=(D=D&&D.getStartElement())&&D._4e_ascendant("table",true)){z=z._toolbars.table;z.selectedTable=D;z._tableShow()}},"\u5220\u9664\u8868\u683c":function(z){var D=(z=z.getSelection())&&z.getStartElement();if(D=D&&D._4e_ascendant("table",true)){z.selectElement(D);var I=z.getRanges()[0];I.collapse();z.selectRanges([I]);z=D.parent();z[0].childNodes.length==1&&z._4e_name()!=
"body"&&z._4e_name()!="td"?z._4e_remove():D._4e_remove()}},"\u5220\u9664\u884c ":function(z){z=z.getSelection();C(f(z),s)},"\u5220\u9664\u5217 ":function(z){z=z.getSelection();(z=A(z))&&C(z,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(z){z=z.getSelection();b(z,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(z){z=z.getSelection();b(z,s)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(z){z=z.getSelection();q(z,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(z){z=z.getSelection();
q(z,s)}};x.TableUI=e}();u.addPlugin(function(){var e=u.document;new x.TableUI(u);var h=B.create("<style>",null,e);e.getElementsByTagName("head")[0].appendChild(h);if(h.styleSheet)h.styleSheet.cssText=w;else h.appendChild(e.createTextNode(w))})});
KISSY.Editor.add("templates",function(u){var s=KISSY.Editor,x=KISSY,r=x.Node,v=s.TripleButton,B=s.SimpleOverlay;s.TplUI||function(){function n(t){this.editor=t;this._init()}x.augment(n,{_init:function(){(new v({container:this.editor.toolBarDiv,contentCls:"ke-toolbar-template",title:"\u6a21\u677f"})).on("click",this._show,this);s.Utils.lazyRun(this,"_prepare","_real")},_prepare:function(){for(var t=this.editor,g=t.cfg.pluginConfig.templates||[],d="<div class='ke-tpl'>",k=0;k<g.length;k++)d+="<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>"+
g[k].demo+"</a>";d+="</div>";this._initDialogOk=true;var o=new B({mask:true,title:"\u5185\u5bb9\u6a21\u677f"});o.body.html(d);o.body.all(".ke-tpl-list").on("click",function(l){l.halt();l=(new r(l.target))._4e_index();l!=-1&&t.insertHtml(g[l].html);o.hide()});this.ui=o},_real:function(){this.ui.show()},_show:function(){this._prepare()}});s.TplUI=n}();u.addPlugin(function(){new s.TplUI(u)})});
KISSY.Editor.add("undo",function(u){var s=KISSY,x=s.Editor,r=x.Utils.arrayCompare,v=s.UA,B=s.Event;x.UndoManager||function(){function n(i){var m=i._getRawData();i=m&&i.getSelection();this.contents=m;this.bookmarks=i&&i.createBookmarks2(true)}function t(i){this.history=[];this.index=-1;this.editor=i;this.bufferRunner=x.Utils.buffer(this.save,this,500);this._init()}function g(i,m,w,a){this.editor=i;this.title=w;this.text=m;this.contentCls=a;this._init()}s.augment(n,{equals:function(i){if(this.contents!=
i.contents)return false;var m=this.bookmarks;i=i.bookmarks;if(m||i){if(!m||!i||m.length!=i.length)return false;for(var w=0;w<m.length;w++){var a=m[w],c=i[w];if(a.startOffset!=c.startOffset||a.endOffset!=c.endOffset||!r(a.start,c.start)||!r(a.end,c.end))return false}}return true}});var d={16:1,17:1,18:1},k={37:1,38:1,39:1,40:1,33:1,34:1};s.augment(t,{_keyMonitor:function(){var i=this.editor;B.on(i.document,"keydown",function(m){var w=m.keyCode;if(!(w in k||w in d))if(w===90&&(m.ctrlKey||m.metaKey)){i.fire("restore",
{d:-1});m.halt()}else if(w===89&&(m.ctrlKey||m.metaKey)){i.fire("restore",{d:1});m.halt()}else i.fire("save",{buffer:1})})},_init:function(){var i=this,m=i.editor;m.on("save",function(w){w.buffer?i.bufferRunner():i.save()});m.on("restore",i.restore,i);i._keyMonitor()},save:function(){var i=this.history,m=this.index;i.length>m+1&&i.splice(m+1,i.length-m-1);var w=this.editor;m=i[i.length-1];var a=new n(w);if(!m||!m.equals(a)){i.length===30&&i.shift();i.push(a);this.index=m=i.length-1;w.fire("afterSave",
{history:i,index:m})}},restore:function(i){i=i.d;var m=this.history,w=this.editor,a=m[this.index+i];if(a){w._setRawData(a.contents);if(a.bookmarks)w.getSelection().selectBookmarks(a.bookmarks);else if(v.ie){a=w.document.body.createTextRange();a.collapse(true);a.select()}this.index+=i;w.fire("afterRestore",{history:m,index:this.index});w.notifySelectionChange()}}});var o=x.TripleButton,l={redo:1,undo:-1};s.augment(g,{_init:function(){var i=this,m=i.editor;i.el=new o({contentCls:i.contentCls,title:i.title,
container:m.toolBarDiv});var w=i.el;w.set("state",o.DISABLED);m.on("afterSave afterRestore",i._respond,i);w.on("offClick",function(){m.fire("restore",{d:l[i.text]})})},_respond:function(i){this.updateUI(i.history,i.index)},updateUI:function(i,m){var w=this.el,a=this.text;if(a=="undo")m>0?w.set("state",o.OFF):w.set("state",o.DISABLED);else if(a=="redo")m<i.length-1?w.set("state",o.OFF):w.set("state",o.DISABLED)}});x.UndoManager=t;x.RestoreUI=g}();u.addPlugin(function(){new x.UndoManager(u);new x.RestoreUI(u,
"undo","\u64a4\u9500","ke-toolbar-undo");new x.RestoreUI(u,"redo","\u91cd\u505a","ke-toolbar-redo")})});
