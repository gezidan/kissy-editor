KISSY.Editor.add("contextmenu",function(){function g(a){this.cfg=i.clone(a);j.Utils.lazyRun(this,"_prepareShow","_realShow")}function o(a,b){for(var d=0;d<b.length;d++){var c=b[d];if(i.isFunction(c)){if(c(new l(a)))return true}else if(p.test(a,c))return true}return false}var j=KISSY.Editor,i=KISSY,l=i.Node,p=i.DOM,n=i.Event;if(!j.ContextMenu){var e=[];g.register=function(a,b){var d=new g(b);e.push({doc:a,rules:b.rules||[],instance:d});if(!a.ke_contextmenu){a.ke_contextmenu=1;n.on(a,"mousedown",g.hide);
n.on(a,"contextmenu",function(c){g.hide.call(this);for(var f=new l(c.target);f;){var k=false;if(f._4e_name()=="body")break;for(var h=0;h<e.length;h++){var m=e[h].instance,q=e[h].rules;if(a===e[h].doc&&o(f[0],q)){c.preventDefault();k=true;setTimeout(function(){m.show(j.Utils.getXY(c.pageX,c.pageY,a,document))},30);break}}if(k)break;f=f.parent()}})}return d};g.hide=function(){for(var a=0;a<e.length;a++){var b=e[a].instance;this===e[a].doc&&b.hide()}};var r=j.SimpleOverlay;i.augment(g,{_init:function(){var a=
this,b=a.cfg,d=b.funcs;a.elDom=new l("<div class='ke-menu' onmousedown='return false;'></div>");var c=a.elDom;c.css("width",b.width);document.body.appendChild(c[0]);a.el=new r({el:c});for(var f in d){b=new l("<a href='#'>"+f+"</a>");c[0].appendChild(b[0]);(function(k,h){k._4e_unselectable();k.on("click",function(m){a.hide();m.halt();setTimeout(h,30)})})(b,d[f])}},hide:function(){this.el&&this.el.hide()},_realShow:function(a){this.el.show(a)},_prepareShow:function(){this._init()},show:function(a){this._prepareShow(a)}});
j.ContextMenu=g}});
