KISSY.add("editor",function(y,H){function I(x,p){var o=this;if(!(o instanceof I))return new I(x,p);if(y.isString(x))x=y.one(x);x[0]||(x=new Node(x));p=p||{};p.pluginConfig=p.pluginConfig||{};o.cfg=p;y.app(o,y.EventTarget);o.use=function(a){if(y.isString(a))a=a.split(",");var c=a;a=[];a=y.indexOf("separator",c);var h=a!=-1;a=c.splice(0,h?a+1:c.length);h&&a.pop();a.length!=0?y.use.call(o,a.join(","),function(){h&&o.addPlugin(function(){I.Utils.addSeparator(o.toolBarDiv)});o.use(c)},{order:true,global:I}):
o.on("dataReady",function(){o.setData(x.val());o.fire("save")});return o};o.init(x);return H}function A(x){if(!E)return x.replace(/\.(js|css)/i,"-min.$1");if(E==="dev")return"../src/"+x;return x}y.app(I,y.EventTarget);I.Config.base=y.Config.base+"editor/";var E=y.Config.debug,C={htmlparser:{attach:false,path:A("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},u=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],w=["flashutils",
"clipboard",{name:"color"},{name:"elementpaths"},"enterkey",{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["flashutils","contextmenu","fakeobjects","overlay","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview"]},"indent","justify",{name:"link",requires:["bubbleview"]},
"list","maximize",{name:"music",requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],j=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",
requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],i,v,s,D;i=0;for(v=w.length;i<v;i++){s=w[i];if(y.isString(s))s=w[i]={name:s};s.requires=s.requires||[];s.requires=s.requires.concat(["button"])}w=[{name:"localStorage",requires:["flashutils"]},{name:"button"},{name:"dd"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",
requires:["overlay"]}].concat(w);i=0;for(v=w.length;i<v;i++){s=w[i];D=s.name;C[D]={attach:false,requires:s.requires,csspath:s.useCss?A("plugins/"+D+"/plugin.css"):H,path:A("plugins/"+D+"/plugin.js")}}i=0;for(v=j.length;i<v;i++){s=j[i];w=H;if(!y.isString(s)){w=s.requires;s=s.name}C[s]={attach:false,requires:w,path:A("plugins/htmldataprocessor/htmlparser/"+s.substring(11)+".js")}}i=0;for(v=u.length;i<v;i++){s=u[i];C[s]={host:"editor",requires:i>0?u[i-1]:[]}}I.add(C);y.Editor=I});
KISSY.Editor.add("utils",function(y){var H=KISSY,I=H.Node,A=H.DOM,E=H.Config.debug,C=H.UA;y.Utils={debugUrl:function(u){if(!E)return u.replace(/\.(js|css)/i,"-min.$1");if(E==="dev")return"../src/"+u;return u},lazyRun:function(u,w,j){var i=u[w],v=u[j];u[w]=function(){i.apply(this,arguments);u[w]=u[j];return v.apply(this,arguments)}},getXY:function(u,w,j,i){j=j.defaultView||j.parentWindow;u-=A.scrollLeft(j);w-=A.scrollTop(j);if(i)if(j!=(i.defaultView||i.parentWindow)&&j.frameElement){i=A._4e_getOffset(j.frameElement,
i);u+=i.left;w+=i.top}return{left:u,top:w}},tryThese:function(){for(var u,w=0,j=arguments.length;w<j;w++){var i=arguments[w];try{u=i();break}catch(v){}}return u},arrayCompare:function(u,w){if(!u&&!w)return true;if(!u||!w||u.length!=w.length)return false;for(var j=0;j<u.length;j++)if(u[j]!==w[j])return false;return true},getByAddress:function(u,w,j){u=u.documentElement;for(var i=0;u&&i<w.length;i++){var v=w[i];if(j)for(var s=-1,D=0;D<u.childNodes.length;D++){var x=u.childNodes[D];if(!(j===true&&x.nodeType==
3&&x.previousSibling&&x.previousSibling.nodeType==3)){s++;if(s==v){u=x;break}}}else u=u.childNodes[v]}return u?new I(u):null},clearAllMarkers:function(u){for(var w in u)u[w]._4e_clearMarkers(u,true)},htmlEncodeAttr:function(u){return u.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(u){return u.replace(/^\s+/,"")},rtrim:function(u){return u.replace(/\s+$/,"")},trim:function(u){return this.ltrim(this.rtrim(u))},mix:function(){for(var u={},w=0;w<arguments.length;w++)u=
H.mix(u,arguments[w]);return u},isCustomDomain:function(){if(!C.ie)return false;var u=document.domain,w=window.location.hostname;return u!=w&&u!="["+w+"]"},addSeparator:function(u){(new H.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(u)},duplicateStr:function(u,w){return(new Array(w+1)).join(u)},throttle:function(u,w,j){j=j||150;if(j===-1)return function(){u.apply(w,arguments)};var i=(new Date).getTime();return function(){var v=(new Date).getTime();if(v-i>j){i=v;u.apply(w,arguments)}}},
buffer:function(u,w,j){j=j||0;var i=null;return function(){i&&clearTimeout(i);var v=arguments;i=setTimeout(function(){return u.apply(w,v)},j)}},isNumber:function(u){return/^\d+(.\d+)?$/.test(H.trim(u))}}});
KISSY.Editor.add("focusmanager",function(y){function H(){this.iframeFocus=true;w=this}function I(){this.iframeFocus=false;w=null}var A=KISSY,E=A.DOM,C=A.Event;A={};var u={},w;A={refreshAll:function(){for(var j in u){var i=u[j];i.document.designMode="off";i.document.designMode="on"}},currentInstance:function(){return w},getInstance:function(j){return u[j]},add:function(j){var i=E._4e_getWin(j.document);C.on(i,"focus",H,j);C.on(i,"blur",I,j)},register:function(j){u[j._UUID]=j},remove:function(j){delete u[j._UUID];
var i=E._4e_getWin(j.document);C.remove(i,"focus",H,j);C.remove(i,"blur",I,j)}};y.focusManager=A});
KISSY.Editor.add("definition",function(y){function H(p){return i+"<html><head><title>kissy-editor</title><link href='"+y.Config.base+v+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(p?'<script id="ke_actscrpt" type="text/javascript">'+(y.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+p+'");<\/script>':"")}var I=KISSY,A=I.UA,E=I.DOM,C=I.Node,u=I.Event,w=y.focusManager,j=y.Utils.tryThese,i="<!doctype html>",v=
y.Utils.debugUrl("theme/editor-iframe.css"),s=1,D="document.open();"+(y.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",x="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(A.ie?"javascript:void(function(){"+encodeURIComponent(D)+"}())":"")+'"  tabIndex="'+
(A.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";I.augment(y,{init:function(p){var o=this,a=new C(x.replace(/\$\(tabIndex\)/,p.attr("tabIndex")));a.on("mousedown",function(f){if(A.webkit){var e=E._4e_name(f.target);if(e=="select"||e=="option")return true}f.halt()});o.editorWrap=a;o._UUID=s++;w.register(o);o.wrap=a.one(".ke-textarea-wrap");o.iframe=o.wrap.one("iframe");o.toolBarDiv=a.one(".ke-editor-tools");o.textarea=
p;o.statusDiv=a.one(".ke-editor-status");o.toolBarDiv._4e_unselectable();o._commands={};o._plugins={};var c=p._4e_style("width"),h=p._4e_style("height");if(c){a.css("width",c);p.css("width","100%")}o.textarea.css("display","none");a.insertAfter(p);o.wrap[0].appendChild(p[0]);if(h){o.wrap.css("height",h);p.css("height","100%")}p=o.iframe;o.on("dataReady",function(){o.ready=true;y.fire("instanceCreated",{editor:o})});A.gecko?p.on("load",o._setUpIFrame,o):o._setUpIFrame()},addCommand:function(p,o){this._commands[p]=
o},execCommand:function(p){this.fire("save");this._commands[p].exec(this);this.fire("save")},getData:function(){if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(this.document.body.innerHTML,"p");return this.document.body.innerHTML},setData:function(p){if(this.htmlDataProcessor)p=this.htmlDataProcessor.toDataFormat(p,"p");this.document.body.innerHTML=p},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(p){this.document.body.innerHTML=
p},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.toolBarDiv.children().css("visibility","");this.statusDiv.children().css("visibility","")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");this.toolBarDiv.children().css("visibility","hidden");this.toolBarDiv.all(".ke-tool-editor-source").css("visibility","");this.statusDiv.children().css("visibility","hidden");A.ie<8&&this.textarea.css("height",this.wrap.css("height"))},
_prepareIFrameHtml:H,getSelection:function(){var p=new y.Selection(this.document);return!p||p.isInvalid?null:p},focus:function(){var p=E._4e_getWin(this.document);A.webkit&&p&&p.parent&&p.parent.focus();p&&p.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){E._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function p(){f=h.document;o.document=f;a.detach();f.open("text/html","replace");f.write(c);f.close()}
var o=this,a=o.iframe,c=H(o._UUID),h=a[0].contentWindow,f;try{f=h.document}catch(e){a[0].src=a[0].src;if(A.ie&&A.ie<7){setTimeout(p,10);return}}p()},addPlugin:function(p){this.ready?p():this.on("dataReady",p)},_monitor:function(){var p=this;p._monitorId&&clearTimeout(p._monitorId);p._monitorId=setTimeout(function(){var o=p.getSelection();if(o&&!o.isInvalid){o=o.getStartElement();var a=new y.ElementPath(o);if(!p.previousPath||!p.previousPath.compare(a)){p.previousPath=a;p.fire("selectionChange",{selection:p,
path:a,element:o})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(p,o){var a=this;a.focus();var c=p._4e_name(),h=y.XHTML_DTD,f=y.RANGE,e=y.NODE,m=h.$block[c],b=a.getSelection(),d=b.getRanges(),g,k,l,t,F;a.fire("save");for(var O=d.length-1;O>=0;O--){g=d[O];g.deleteContents();k=!O&&p||p._4e_clone(true);o&&o(k);if(m)for(;(t=g.getCommonAncestor(false,true))&&(F=h[t._4e_name()])&&!(F&&F[c]);)if(t._4e_name()in h.span)g.splitElement(t);else if(g.checkStartOfBlock()&&
g.checkEndOfBlock()){g.setStartBefore(t);g.collapse(true);t._4e_remove()}else g.splitBlock();g.insertNode(k);l||(l=k)}p=l._4e_nextSourceNode(true);o=a.document;F=y.XHTML_DTD;if(F.$inline[k._4e_name()]){p=new C(o.createTextNode(" "));p.insertAfter(l)}else if(p){if(p._4e_name()=="br"&&F[p.parent()._4e_name()].p){F=new C("<p>&nbsp;</p>",null,o);p[0].parentNode.replaceChild(F[0],p[0]);p=F}}else{F=new C("<p>&nbsp;</p>",null,o);F.insertAfter(l);p=F}g.moveToPosition(l,f.POSITION_AFTER_END);p&&p[0].nodeType==
e.NODE_ELEMENT&&g.moveToElementEditablePosition(p);b.selectRanges([g]);a.focus();k&&k._4e_scrollIntoView();setTimeout(function(){a.fire("save")},10);return k},insertHtml:function(p){var o=this;if(o.htmlDataProcessor)p=o.htmlDataProcessor.toDataFormat(p);if(A.webkit){p=E.create(p,null,this.document);p=p.nodeType==11?I.makeArray(p.childNodes):[p];for(var a=0;a<p.length;a++)o.insertElement(new C(p[a]))}else{o.focus();o.fire("save");a=o.getSelection();if(A.ie){a=a.getNative();a.type=="Control"&&a.clear();
a.createRange().pasteHTML(p)}else o.document.execCommand("inserthtml",false,p);o.focus();setTimeout(function(){o.fire("save")},10)}}});y._initIFrame=function(p){function o(k){j(function(){h.designMode="on";setTimeout(function(){h.designMode="off";m.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){h.designMode="off";E.attr(m,"contentEditable",false);E.attr(m,"contentEditable",true);!k&&o(1)})}var a=w.getInstance(p);p=a.textarea[0];var c=a.iframe[0].contentWindow,h=a.document,
f=a.cfg,e=h.getElementById("ke_actscrpt");e.parentNode.removeChild(e);var m=h.body;if(A.ie){m.hideFocus=true;m.disabled=true;m.contentEditable=true;m.removeAttribute("disabled")}else setTimeout(function(){if(A.gecko||A.opera)m.contentEditable=true;else if(A.webkit)m.parentNode.contentEditable=true;else h.designMode="on"},0);if(A.webkit){u.on(h,"click",function(k){var l=new C(k.target);I.inArray(l._4e_name(),["input","select"])&&k.preventDefault()});u.on(h,"mouseup",function(k){var l=new C(k.target);
I.inArray(l._4e_name(),["input","textarea"])&&k.preventDefault()})}if(A.gecko||A.ie||A.opera){var b;b=new C(E.insertAfter((new C('<span style="position:absolute; left:-10000"></span>'))[0],p));b.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(A.ie&&h.compatMode=="CSS1Compat"||A.gecko||A.opera){var d=new C(h.documentElement);d.on("mousedown",function(k){if(k.target===d[0]){A.gecko&&o(false);b[0].focus()}})}u.on(c,"focus",function(){if(A.gecko)o(false);else A.opera&&m.focus();a.notifySelectionChange()});
A.gecko&&u.on(a.document,"mousedown",function(){a.iframeFocus||o(false)});if(A.ie){u.on(h,"keydown",function(k){if(k.keyCode in{8:1,46:1}){var l=a.getSelection(),t=l.getSelectedElement();if(t){a.fire("save");var F=l.getRanges()[0].createBookmark();t._4e_remove();l.selectBookmarks([F]);a.fire("save");k.preventDefault()}}});if(h.compatMode=="CSS1Compat"){var g={33:1,34:1};u.on(h,"keydown",function(k){k.keyCode in g&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){A.ie&&
setTimeout(function(){if(h){m.runtimeStyle.marginBottom="0px";m.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady");var k=f.disableObjectResizing,l=f.disableInlineTableEditing;if(k||l)try{h.execCommand("enableObjectResizing",false,!k);h.execCommand("enableInlineTableEditing",false,!l)}catch(t){u.on(m,A.ie?"resizestart":"resize",function(F){if(k||E._4e_name(F.target)==="table"&&l)F.preventDefault()})}},10);A.webkit&&u.on(h,"mousedown",function(k){k=new C(k.target);I.inArray(k._4e_name(),
["img","hr","input","textarea","select"])&&a.getSelection().selectElement(k)});w.add(a)};A.gecko&&function(){var p=document.body;if(p){var o=p.getAttribute("onpageshow");p.setAttribute("onpageshow",(o?o+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(y){y.XHTML_DTD=function(){var H=function(m){for(var b=arguments.length-1;b>0;)KISSY.mix(m,arguments[b--]);return m},I={isindex:1,fieldset:1},A={input:1,button:1,select:1,textarea:1,label:1},E=H({a:1},A),C=H({iframe:1},E),u={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},w={ins:1,del:1,script:1,style:1},j=H({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},w),i=H({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},j),v=H({p:1},i);A=H({iframe:1},i,A);i={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var s=H({a:1},A),D={tr:1},x={"#":1},p=H({param:1},i),o=H({form:1},I,C,u,v),a={li:1},c={base:1,link:1,meta:1,title:1},h=H(c,{style:1,script:1}),f={head:1,body:1},e={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:H({html:1},f,c),$block:e,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:s,$body:H({script:1,style:1},e),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:f,head:h,style:x,body:o,base:{},link:{},meta:{},title:x,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:o,td:o,br:{},th:o,center:o,kbd:s,button:H(v,u),basefont:{},h5:s,h4:s,samp:s,h6:s,ol:a,h1:s,h3:s,option:x,h2:s,form:H(I,C,u,v),select:{optgroup:1,option:1},font:s,ins:s,menu:a,abbr:s,label:s,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:s,script:x,tfoot:D,cite:s,li:o,input:{},iframe:o,strong:s,textarea:x,noframes:o,big:s,small:s,span:s,hr:{},dt:s,sub:s,optgroup:{option:1},param:{},bdo:s,"var":s,div:o,object:p,sup:s,dd:o,strike:s,area:{},dir:a,map:H({area:1,form:1,p:1},I,w,u),applet:p,dl:{dt:1,dd:1},del:s,isindex:{},fieldset:H({legend:1},i),thead:D,ul:a,acronym:s,b:s,a:A,blockquote:o,caption:s,i:s,u:s,tbody:D,s:s,address:H(C,v),tt:s,legend:s,q:s,pre:H(j,E),p:s,em:s,dfn:s}}()});
KISSY.Editor.add("dom",function(y){function H(a){return a.replace(/-(\w)/g,function(c,h){return h.toUpperCase()})}var I=KISSY,A=I.DOM,E=I.UA,C=I.Node,u=y.Utils,w={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};y.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};y.POSITION={};var j=y.NODE,i=y.POSITION;i.POSITION_IDENTICAL=0;i.POSITION_DISCONNECTED=
1;i.POSITION_FOLLOWING=2;i.POSITION_PRECEDING=4;i.POSITION_IS_CONTAINED=8;i.POSITION_CONTAINS=16;var v={},s={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},D={hr:1},x=function(a){return a[0]||a},p=function(a){if(!a[0])return new C(a);return a},o={_4e_equals:function(a,c){if(!a&&!c)return true;if(!a||!c)return false;a=x(a);c=x(c);return a===c},_4e_isBlockBoundary:function(a,
c){a=p(a);c=I.mix(I.mix({},D),c||{});return s[a.css("display")]||c[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=x(a);for(var c=a.parentNode.childNodes,h=0;h<c.length;h++)if(c[h]===a)return h;return-1},_4e_first:function(a,c){a=x(a);if((a=(a=a.firstChild)&&new C(a))&&c&&!c(a))a=a._4e_next(c);return a},_4e_move:function(a,c,h){a._4e_remove();a=x(a);c=x(c);h?c.insertBefore(a,c.firstChild):c.appendChild(a)},
_4e_name:function(a){a=x(a);var c=a.nodeName.toLowerCase();if(E.ie)if((a=a.scopeName)&&a!="HTML")c=a.toLowerCase()+":"+c;return c},_4e_isIdentical:function(a,c){if(a._4e_name()!=c._4e_name())return false;var h=a[0].attributes,f=c[0].attributes,e=h.length,m=f.length;if(!E.ie&&e!=m)return false;for(var b=0;b<e;b++){var d=h[b];if((!E.ie||d.specified&&d.nodeName!="_ke_expando")&&d.nodeValue!=c.attr(d.nodeName))return false}if(E.ie)for(b=0;b<m;b++){d=f[b];if(d.specified&&d.nodeName!="_ke_expando"&&d.nodeValue!=
a.attr(d.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=x(a).childNodes;for(var c=0,h=a.length;c<h;c++){var f=a[c],e=f.nodeType;if(!(e==j.NODE_ELEMENT&&f.getAttribute("_ke_bookmark")))if(e==j.NODE_ELEMENT&&!o._4e_isEmptyInlineRemoveable(f)||e==j.NODE_TEXT&&I.trim(f.nodeValue))return false}return true},_4e_moveChildren:function(a,c,h){a=x(a);c=c[0]||c;if(a!=c)if(h)for(;h=a.lastChild;)c.insertBefore(a.removeChild(h),c.firstChild);else for(;h=a.firstChild;)c.appendChild(a.removeChild(h))},
_4e_mergeSiblings:function(){function a(c,h,f){if(h[0]&&h[0].nodeType==j.NODE_ELEMENT){for(var e=[];h.attr("_ke_bookmark")||h._4e_isEmptyInlineRemoveable();){e.push(h);h=f?new C(h[0].nextSibling):new C(h[0].previousSibling);if(!h[0]||h[0].nodeType!=j.NODE_ELEMENT)return}if(c._4e_isIdentical(h)){for(var m=f?c[0].lastChild:c[0].firstChild;e.length;)e.shift()._4e_move(c,!f);h._4e_moveChildren(c,!f);h._4e_remove();m[0]&&m[0].nodeType==j.NODE_ELEMENT&&m._4e_mergeSiblings()}}}return function(c){if(c[0])if(w[c._4e_name()]||
c._4e_name()=="a"){a(c,new C(c[0].nextSibling),true);a(c,new C(c[0].previousSibling))}}}(),_4e_unselectable:E.gecko?function(a){a=x(a);a.style.MozUserSelect="none"}:E.webkit?function(a){a=x(a);a.style.KhtmlUserSelect="none"}:function(a){a=x(a);if(E.ie||E.opera){var c,h=0;for(a.unselectable="on";c=a.all[h++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(a,c){a=x(a);var h,f=0;h=0;var e=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,m=a.ownerDocument,b=m.documentElement;c=c||m;if(a.getBoundingClientRect){if(a!==m.body&&b!==a){h=a.getBoundingClientRect();f=h.left+(c===m?A.scrollLeft(e):0);h=h.top+(c===m?A.scrollTop(e):0)}if(c)if(e!=(c.defaultView||c.parentWindow)&&e.frameElement){c=o._4e_getOffset(e.frameElement,c);f+=c.left;h+=c.top}}return{left:f,top:h}},_4e_getFrameDocument:function(a){return(a=x(a))&&a.contentWindow.document},_4e_splitText:function(a,c){a=x(a);var h=a.ownerDocument;if(!(!a||a.nodeType!=
j.NODE_TEXT)){if(E.ie&&c==a.nodeValue.length){h=h.createTextNode("");A.insertAfter(h,a);return h}a=new C(a.splitText(c));if(E.ie==8){h=h.createTextNode("");A.insertAfter(h,a[0]);h.parentNode.removeChild(h)}return a}},_4e_parents:function(a,c){a=p(a);var h=[];do h[c?"push":"unshift"](a);while(a=a.parent());return h},_4e_clone:function(a,c,h){a=x(a);a=a.cloneNode(c);if(!h){var f=function(e){if(e.nodeType==j.NODE_ELEMENT){e.removeAttribute("id",false);e.removeAttribute("_ke_expando",false);e=e.childNodes;
for(var m=0;m<e.length;m++)f(e[m])}};f(a)}return new C(a)},_4e_nextSourceNode:function(a,c,h,f){a=x(a);if(f&&!f.call){var e=f[0]||f;f=function(b){b=b[0]||b;return b!==e}}c=!c&&a.firstChild;var m=new C(a);if(!c){if(a.nodeType==j.NODE_ELEMENT&&f&&f(this,true)===false)return null;c=a.nextSibling}for(;!c&&(m=m.parent());){if(f&&f(m,true)===false)return null;c=m[0].nextSibling}if(!c)return null;c=new C(c);if(f&&f(c)===false)return null;if(h&&h!=c[0].nodeType)return c._4e_nextSourceNode(false,h,f);return c},
_4e_previousSourceNode:function(a,c,h,f){a=x(a);if(f&&!f.call){var e=f[0]||f;f=function(b){b=b[0]||b;return b!==e}}c=!c&&a.lastChild;var m=new C(a);if(!c){if(a.nodeType==j.NODE_ELEMENT&&f&&f(a,true)===false)return null;c=a.previousSibling}for(;!c&&(m=m.parent());){if(f&&f(m,true)===false)return null;c=m[0].previousSibling}if(!c)return null;c=new C(c);if(f&&f(c)===false)return null;if(h&&c[0].nodeType!=h)return c._4e_previousSourceNode(false,h,f);return c},_4e_contains:E.ie||E.webkit?function(a,c){a=
x(a);c=x(c);return c.nodeType!=j.NODE_ELEMENT?a.contains(c.parentNode):a!=c&&a.contains(c)}:function(a,c){a=x(a);c=x(c);return!!(a.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(a,c){if(a._4e_equals(c))return a;if(c[0].nodeType!=j.NODE_TEXT&&c._4e_contains(a))return c;a=a[0].nodeType==j.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=j.NODE_TEXT&&a._4e_contains(c))return a;while(a=a.parent());return null},_4e_ascendant:function(a,c,h){a=x(a);if(!h)a=a.parentNode;if(c&&!I.isFunction(c)){var f=
c;c=function(e){return e._4e_name()==f}}for(;a&&a.nodeType!=9;){if(!c||c(new C(a))===true)return new C(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,c){a=x(a);a=a.attributes.getNamedItem(c);return!!(a&&a.specified)},_4e_hasAttributes:E.ie?function(a){a=x(a);for(var c=a.attributes,h=0;h<c.length;h++){var f=c[h];switch(f.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(f.specified)return true}}return false}:function(a){a=x(a);E.gecko&&
a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,c){var h=x(a),f=x(c);if(h.compareDocumentPosition)return h.compareDocumentPosition(f);if(h==f)return i.POSITION_IDENTICAL;if(h.nodeType==j.NODE_ELEMENT&&f.nodeType==j.NODE_ELEMENT){if(h.contains){if(h.contains(f))return i.POSITION_CONTAINS+i.POSITION_PRECEDING;if(f.contains(h))return i.POSITION_IS_CONTAINED+i.POSITION_FOLLOWING}if("sourceIndex"in h)return h.sourceIndex<
0||f.sourceIndex<0?i.POSITION_DISCONNECTED:h.sourceIndex<f.sourceIndex?i.POSITION_PRECEDING:i.POSITION_FOLLOWING}a=a._4e_address();c=c._4e_address();h=Math.min(a.length,c.length);for(f=0;f<=h-1;f++)if(a[f]!=c[f]){if(f<h)return a[f]<c[f]?i.POSITION_PRECEDING:i.POSITION_FOLLOWING;break}return a.length<c.length?i.POSITION_CONTAINS+i.POSITION_PRECEDING:i.POSITION_IS_CONTAINED+i.POSITION_FOLLOWING},_4e_address:function(a,c){a=x(a);var h=[],f=a.ownerDocument.documentElement;for(a=a;a&&a!=f;){var e=a.parentNode,
m=-1;if(e){for(var b=0;b<e.childNodes.length;b++){var d=e.childNodes[b];if(!(c&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){m++;if(d==a)break}}h.unshift(m)}a=e}return h},_4e_breakParent:function(a,c){var h=new y.Range(a[0].ownerDocument);h.setStartAfter(a);h.setEndAfter(c);c=h.extractContents();h.insertNode(a._4e_remove());a[0].parentNode.insertBefore(c,a[0].nextSibling)},_4e_style:function(a,c,h){if(h!==undefined)return a.css(c,h);a=a[0]||a;return a.style[H(c)]},_4e_remove:function(a,
c){var h=x(a),f=h.parentNode;if(f){if(c)for(;c=h.firstChild;)f.insertBefore(h.removeChild(c),h);f.removeChild(h)}return a},_4e_trim:function(a){A._4e_ltrim(a);A._4e_rtrim(a)},_4e_ltrim:function(a){a=x(a);for(var c;c=a.firstChild;){if(c.nodeType==j.NODE_TEXT){var h=u.ltrim(c.nodeValue),f=c.nodeValue.length;if(h){if(h.length<f){(new C(c))._4e_splitText(f-h.length);a.removeChild(a.firstChild)}}else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){a=x(a);for(var c;c=a.lastChild;){if(c.type==j.NODE_TEXT){var h=
u.rtrim(c.nodeValue),f=c.nodeValue.length;if(h){if(h.length<f){(new C(c))._4e_splitText(h.length);a.removeChild(a.lastChild)}}else{a.removeChild(c);continue}}break}if(!E.ie&&!E.opera)(c=a.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(a){a=x(a);for(var c=a.lastChild;c&&c.nodeType==j.NODE_TEXT&&!I.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==j.NODE_TEXT||A._4e_name(c)!=="br"){c=E.opera?a.ownerDocument.createTextNode(""):
a.ownerDocument.createElement("br");E.gecko&&c.setAttribute("type","_moz");a.appendChild(c)}},_4e_previous:function(a,c){a=x(a);var h;do h=(a=a.previousSibling)&&new C(a);while(h&&c&&!c(h));return h},_4e_last:function(a,c){if((a=(a=a[0].lastChild)&&new C(a))&&c&&!c(a))a=a._4e_previous(c);return a},_4e_next:function(a,c){a=x(a);var h;do h=(a=a.nextSibling)&&new C(a);while(h&&c&&!c(h));return h},_4e_outerHtml:function(a){a=x(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var c=a.ownerDocument.createElement("div");
c.appendChild(a.cloneNode(true));return c.innerHTML},_4e_setMarker:function(a,c,h,f){a[0]||(a=new C(a));var e=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",I.guid())._4e_getData("list_marker_id"),m=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[e]=a;m[h]=1;return a._4e_setData(h,f)},_4e_clearMarkers:function(a,c,h){a=p(a);var f=a._4e_getData("list_marker_names"),e=a._4e_getData("list_marker_id");for(var m in f)a._4e_removeData(m);
a._4e_removeData("list_marker_names");if(h){a._4e_removeData("list_marker_id");delete c[e]}},_4e_setData:function(a,c,h){var f=A._4e_getUniqueId(a);(v[f]||(v[f]={}))[c]=h;return a},_4e_getData:function(a,c){a=x(a);return(a=(a=a.getAttribute("_ke_expando"))&&v[a])&&a[c]},_4e_removeData:function(a,c){a=x(a);var h=a.getAttribute("_ke_expando");var f=(h=h&&v[h])&&h[c];typeof f!="undefined"&&h&&delete h[c];I.isEmptyObject(h)&&A._4e_clearData(a);return f||null},_4e_clearData:function(a){a=x(a);var c=a.getAttribute("_ke_expando");
c&&delete v[c];c&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=x(a);var c=a.getAttribute("_ke_expando");if(c)return c;c=I.guid();a.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(a,c,h){a=x(a);var f=a.attributes;h=h||{};for(var e=0;e<f.length;e++){var m=f[e],b=m.nodeName.toLowerCase(),d;if(!(b in h))if(b=="checked"&&(d=A.attr(a,b)))c.attr(b,d);else if(m.specified||E.ie&&m.nodeValue&&b=="value"){d=A.attr(a,b);if(d===null)d=m.nodeValue;c.attr(b,d)}}if(a.style.cssText!==
"")c[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=A._4e_name(a);var c=y.XHTML_DTD;return(a=!c.$nonEditable[a]&&(c[a]||c.span))&&a["#"]},_4e_scrollIntoView:function(a){a=p(a);var c=a[0].ownerDocument,h=A.scrollLeft(c),f=A.scrollTop(c),e=a.offset(),m=e.left;e=e.top;if(A.viewportHeight(c)+f<e||e<f||A.viewportWidth(c)+h<m||m<h)a.scrollIntoView(c)},_4e_getElementsByTagName:function(a,c,h){a=x(a);if(!E.ie&&h)c=h+":"+c;h=[];a=a.getElementsByTagName(c);for(c=0;c<a.length;c++)h.push(new C(a[c]));
return h}};I.DOM._4e_inject=function(a){I.mix(A,a);for(var c in a)a.hasOwnProperty(c)&&function(h){C.prototype[h]=function(){var f=[].slice.call(arguments,0);f.unshift(this);return a[h].apply(null,f)}}(c)};I.DOM._4e_inject(o)});
KISSY.Editor.add("elementpath",function(y){function H(v){var s=null,D=null,x=[];for(v=v;v&&v[0];){if(v[0].nodeType==C.NODE_ELEMENT){if(!this.lastElement)this.lastElement=v;var p=v._4e_name();if(u.ie&&v[0].scopeName!="HTML")p=v[0].scopeName.toLowerCase()+":"+p;if(!D){if(!s&&w[p])s=v;if(j[p])if(!s&&p=="div"&&!i(v))s=v;else D=v}x.push(v);if(p=="body")break}v=v.parent()}this.block=s;this.blockLimit=D;this.elements=x}var I=KISSY,A=I.DOM,E=y.XHTML_DTD,C=y.NODE,u=I.UA,w={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},i=function(v){v=v[0]||v;v=v.childNodes;for(var s=0,D=v.length;s<D;s++){var x=v[s];if(x.nodeType==C.NODE_ELEMENT&&E.$block[x.nodeName.toLowerCase()])return true}return false};H.prototype={compare:function(v){var s=this.elements;v=v&&v.elements;if(!v||s.length!=v.length)return false;for(var D=0;D<s.length;D++)if(!A._4e_equals(s[D],v[D]))return false;return true},contains:function(v){for(var s=
this.elements,D=0;D<s.length;D++)if(s[D]._4e_name()in v)return s[D];return null}};y.ElementPath=H});
KISSY.Editor.add("walker",function(y){function H(j,i){if(this._.end)return null;var v=this.range,s,D=this.guard,x=this.type,p=j?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;v.trim();if(v.collapsed){this.end();return null}}if(!j&&!this._.guardLTR){var o=v.endContainer,a=new w(o[0].childNodes[v.endOffset]);this._.guardLTR=function(e,m){return(!m||!u._4e_equals(o,e))&&(!a[0]||e[0]!==a[0])&&(e[0].nodeType!=C.NODE_ELEMENT||!m||e._4e_name()!="body")}}if(j&&!this._.guardRTL){var c=
v.startContainer,h=v.startOffset>0&&new w(c[0].childNodes[v.startOffset-1]);this._.guardRTL=function(e,m){return e&&e[0]&&(!m||c[0]!==e[0])&&(!h[0]||e[0]!==h[0])&&(e[0].nodeType!=C.NODE_ELEMENT||!m||e._4e_name()!="body")}}var f=j?this._.guardRTL:this._.guardLTR;s=D?function(e,m){if(f(e,m)===false)return false;return D(e,m)}:f;if(this.current)j=this.current[p](false,x,s);else if(j){j=v.endContainer;if(v.endOffset>0){j=new w(j[0].childNodes[v.endOffset-1]);if(s(j)===false)j=null}else j=s(j,true)===
false?null:j._4e_previousSourceNode(true,x,s)}else{j=v.startContainer;if((j=new w(j[0].childNodes[v.startOffset]))&&j[0]){if(s(j)===false)j=null}else j=s(v.startContainer,true)===false?null:v.startContainer._4e_nextSourceNode(true,x,s)}for(;j&&j[0]&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j)!==false){if(!i)return j}else if(i&&this.evaluator)return false;j=j[p](false,x,s)}this.end();return this.current=null}function I(j){for(var i,v=null;i=H.call(this,j);)v=i;return v}function A(j){this.range=
j;this._={}}var E=KISSY,C=y.NODE,u=E.DOM,w=E.Node;E.augment(A,{end:function(){this._.end=1},next:function(){return H.call(this)},previous:function(){return H.call(this,true)},checkForward:function(){return H.call(this,false,true)!==false},checkBackward:function(){return H.call(this,true,true)!==false},lastForward:function(){return I.call(this)},lastBackward:function(){return I.call(this,true)},reset:function(){delete this.current;this._={}}});A.blockBoundary=function(j){return function(i){i[0]||(i=
new w(i));return!(i[0].nodeType==C.NODE_ELEMENT&&i._4e_isBlockBoundary(j))}};A.listItemBoundary=function(){return this.blockBoundary({br:1})};A.bookmark=function(j,i){function v(s){return s&&s[0]&&s._4e_name()=="span"&&s.attr("_ke_bookmark")}return function(s){var D,x;D=s&&s[0]&&s[0].nodeType==C.NODE_TEXT&&(x=s.parent())&&v(x);D=j?D:D||v(s);return i^D}};A.whitespaces=function(j){return function(i){i=(i=i[0]||i)&&i.nodeType==C.NODE_TEXT&&!E.trim(i.nodeValue);return j^i}};A.invisible=function(j){var i=
A.whitespaces();return function(v){v=i(v)||v[0].nodeType==C.NODE_ELEMENT&&!v[0].offsetHeight;return j^v}};y.Walker=A});
KISSY.Editor.add("range",function(y){function H(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function I(b){var d=b[0].nodeType!=j.NODE_TEXT&&b._4e_name()in o.$removeEmpty,g=!w.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return d||g||b}function A(b){return!e(b)&&!m(b)}function E(b){var d=false,g=s.bookmark(true);return function(k){if(g(k))return true;if(k[0].nodeType==j.NODE_TEXT){if(w.trim(k[0].nodeValue).length)return false}else if(k[0].nodeType==
j.NODE_ELEMENT)if(!f[k._4e_name()])if(!b&&!p.ie&&k._4e_name()=="br"&&!d)d=true;else return false;return true}}function C(b,d){function g(k){return k&&k.nodeName=="span"&&k.getAttribute("_ke_bookmark")}return function(k){var l,t;l=k&&!k.nodeName&&(t=k.parentNode)&&g(t);l=b?l:l||g(k);return d^l}}function u(b){return function(d){d=(d=d[0]||d)&&d.nodeType==j.NODE_TEXT&&!w.trim(d.nodeValue);return b^d}}y.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var w=KISSY,j=y.NODE,i=y.RANGE,v=y.POSITION,s=y.Walker,D=w.DOM,x=y.Utils.getByAddress,p=w.UA,o=y.XHTML_DTD,a=y.ElementPath,c=w.Node,h={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};H.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};w.augment(H,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&D._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,d=this.startOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;d=this.endOffset;if(b[0].nodeType!=j.NODE_ELEMENT)if(d)d>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,d=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,i.POSITION_BEFORE_START);d&&d._4e_name()=="span"&&
d.attr("_ke_bookmark")&&this.setEndAt(d,i.POSITION_AFTER_END)},setStart:function(b,d){if(b[0].nodeType==j.NODE_ELEMENT&&h[b._4e_name()]){b=b.parent();d=b._4e_index()}this.startContainer=b;this.startOffset=d;if(!this.endContainer){this.endContainer=b;this.endOffset=d}this.updateCollapsed()},setEnd:function(b,d){if(b[0].nodeType==j.NODE_ELEMENT&&h[b._4e_name()]){b=b.parent();d=b._4e_index()+1}this.endContainer=b;this.endOffset=d;if(!this.startContainer){this.startContainer=b;this.startOffset=d}this.updateCollapsed()},
setStartAt:function(b,d){switch(d){case i.POSITION_AFTER_START:this.setStart(b,0);break;case i.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setStartBefore(b);break;case i.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,d){switch(d){case i.POSITION_AFTER_START:this.setEnd(b,0);break;case i.POSITION_BEFORE_END:b[0].nodeType==j.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setEndBefore(b);break;case i.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,d){var g=this.startContainer,k=this.endContainer,l=this.startOffset,t=this.endOffset,F,O;this.optimizeBookmark();if(k[0].nodeType==j.NODE_TEXT)k=k._4e_splitText(t);else if(k[0].childNodes.length>0)if(t>=k[0].childNodes.length){k=new c(k[0].appendChild(this.document.createTextNode("")));
O=true}else k=new c(k[0].childNodes[t]);if(g[0].nodeType==j.NODE_TEXT){g._4e_splitText(l);if(D._4e_equals(g,k))k=new c(g[0].nextSibling)}else if(l)if(l>=g[0].childNodes.length){F=new c(this.document.createTextNode(""));g[0].appendChild(F[0]);g=F;F=true}else g=new c(g[0].childNodes[l].previousSibling);else{F=new c(this.document.createTextNode(""));D.insertBefore(F[0],g[0].firstChild);g=F;F=true}l=g._4e_parents();t=k._4e_parents();var G,J,K;for(G=0;G<l.length;G++){J=l[G];K=t[G];if(J[0]!==K[0])break}for(var P=
d,N,S,Y,Z=G;Z<l.length;Z++){N=l[Z];if(P&&N[0]!==g[0])S=P.appendChild(N._4e_clone()[0]);for(N=N[0].nextSibling;N;){if(t[Z]&&N==t[Z][0]||N==k[0])break;Y=N.nextSibling;if(b==2)P.appendChild(N.cloneNode(true));else{N.parentNode.removeChild(N);b==1&&P.appendChild(N)}N=Y}if(S)P=S}P=d;for(d=G;d<t.length;d++){N=t[d];if(b>0&&N[0]!==k[0])S=P.appendChild(N._4e_clone()[0]);if(!l[d]||N[0].parentNode!==l[d][0].parentNode)for(N=N[0].previousSibling;N;){if(l[d]&&N==l[d][0]||N===g[0])break;Y=N.previousSibling;if(b==
2)P.insertBefore(N.cloneNode(true),P.firstChild);else{N.parentNode.removeChild(N);b==1&&P.insertBefore(N,P.firstChild)}N=Y}if(S)P=S}if(b==2){K=this.startContainer[0];if(K.nodeType==j.NODE_TEXT&&K.nextSibling&&K.nextSibling.nodeType==j.NODE_TEXT){K.data+=K.nextSibling.data;K.parentNode.removeChild(K.nextSibling)}K=this.endContainer[0];if(K.nodeType==j.NODE_TEXT&&K.nextSibling&&K.nextSibling.nodeType==j.NODE_TEXT){K.data+=K.nextSibling.data;K.parentNode.removeChild(K.nextSibling)}}else{if(J&&K&&(g[0].parentNode!=
J[0].parentNode||k[0].parentNode!=K[0].parentNode)){b=K._4e_index();F&&K[0].parentNode==g[0].parentNode&&b--;this.setStart(K.parent(),b)}this.collapse(true)}F&&g._4e_remove();O&&k[0].parentNode&&k._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new H(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=j.NODE_ELEMENT||b.endContainer[0].nodeType!=j.NODE_ELEMENT)return null;b=b.startContainer[0].childNodes[b.startOffset];for(var d=C(true,undefined),g=u(true),k=function(l){return g(l)&&d(l)};b&&k(b);)b=(new c(b))._4e_nextSourceNode()[0];return new c(b)},shrink:function(b,d){if(!this.collapsed){b=b||i.SHRINK_TEXT;
var g=this.clone(),k=this.startContainer,l=this.endContainer,t=this.startOffset,F=this.endOffset,O=1,G=1;if(k&&k[0].nodeType==j.NODE_TEXT)if(t)if(t>=k[0].nodeValue.length)g.setStartAfter(k);else{g.setStartBefore(k);O=0}else g.setStartBefore(k);if(l&&l[0].nodeType==j.NODE_TEXT)if(F)if(F>=l[0].nodeValue.length)g.setEndAfter(l);else{g.setEndAfter(l);G=0}else g.setEndBefore(l);g=new s(g);g.evaluator=function(K){K=K[0]||K;return K.nodeType==(b==i.SHRINK_ELEMENT?j.NODE_ELEMENT:j.NODE_TEXT)};var J;g.guard=
function(K,P){K=K[0]||K;if(b==i.SHRINK_ELEMENT&&K.nodeType==j.NODE_TEXT)return false;if(P&&K==J)return false;if(!P&&K.nodeType==j.NODE_ELEMENT)J=K;return true};if(O)(k=g[b==i.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(k,d?i.POSITION_AFTER_START:i.POSITION_BEFORE_START);if(G){g.reset();(g=g[b==i.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(g,d?i.POSITION_BEFORE_END:i.POSITION_AFTER_END)}return!!(O||G)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||
b[0].nodeType!=j.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var d=this.startContainer,g=this.endContainer,k=this.startOffset,l=this.endOffset,t,F;if(!d||!g)return{start:0,end:0};if(b){if(d[0].nodeType==j.NODE_ELEMENT)if((t=new c(d[0].childNodes[k]))&&t[0]&&t[0].nodeType==j.NODE_TEXT&&k>0&&t[0].previousSibling.nodeType==j.NODE_TEXT){d=t;k=0}for(;d[0].nodeType==j.NODE_TEXT&&(F=d._4e_previous())&&F[0].nodeType==j.NODE_TEXT;){d=F;k+=F[0].nodeValue.length}if(!this.collapsed){if(g[0].nodeType==
j.NODE_ELEMENT)if((t=new c(g[0].childNodes[l]))&&t[0]&&t[0].nodeType==j.NODE_TEXT&&l>0&&t[0].previousSibling.nodeType==j.NODE_TEXT){g=t;l=0}for(;g[0].nodeType==j.NODE_TEXT&&(F=g._4e_previous())&&F[0].nodeType==j.NODE_TEXT;){g=F;l+=F[0].nodeValue.length}}}return{start:d._4e_address(b),end:this.collapsed?null:g._4e_address(b),startOffset:k,endOffset:l,normalized:b,is2:true}},createBookmark:function(b){var d,g,k,l;d=new c("<span></span>",null,this.document);d.attr("_ke_bookmark",1);d.css("display","none");
d.html("&nbsp;");if(b){k=w.guid("ke_bm_");d.attr("id",k+"S")}if(!this.collapsed){g=d._4e_clone();g.html("&nbsp;");b&&g.attr("id",k+"E");l=this.clone();l.collapse();l.insertNode(g)}l=this.clone();l.collapse(true);l.insertNode(d);if(g){this.setStartAfter(d);this.setEndBefore(g)}else this.moveToPosition(d,i.POSITION_AFTER_END);return{startNode:b?k+"S":d,endNode:b?k+"E":g,serializable:b}},moveToPosition:function(b,d){this.setStartAt(b,d);this.collapse(true)},trim:function(b,d){var g=this.startContainer,
k=this.startOffset,l=this.collapsed;if((!b||l)&&g[0]&&g[0].nodeType==j.NODE_TEXT){if(k)if(k>=g[0].nodeValue.length){k=g._4e_index()+1;g=g.parent()}else{b=g._4e_splitText(k);k=g._4e_index()+1;g=g.parent();if(D._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(D._4e_equals(g,this.endContainer))this.endOffset+=1}else{k=g._4e_index();g=g.parent()}this.setStart(g,k);if(l){this.collapse(true);return}}g=this.endContainer;k=this.endOffset;if(!(d||l)&&
g[0]&&g[0].nodeType==j.NODE_TEXT){if(k){k>=g.nodeValue.length||g._4e_splitText(k);k=g._4e_index()+1}else k=g._4e_index();g=g.parent();this.setEnd(g,k)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var d=this.startContainer,g=d[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);g?D.insertBefore(b[0]||b,g):d[0].appendChild(b[0]||b);D._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var d=
x(this.document,b.start,b.normalized),g=b.startOffset,k=b.end&&x(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(d,g);k?this.setEnd(k,b):this.collapse(true)}else{d=(g=b.serializable)?w.one("#"+b.startNode,this.document):b.startNode;b=g?w.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(d);d._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,d){var g=this.startContainer,k=this.endContainer;b=D._4e_equals(g,
k)?b&&g[0].nodeType==j.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(g[0].childNodes[this.startOffset]):g:g._4e_commonAncestor(k);return d&&b[0].nodeType==j.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case i.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var d=new c(this.document.body),g,k,l,t,F,O=false,G,J;G=this.startContainer;J=this.startOffset;if(G[0].nodeType==j.NODE_TEXT){if(J){G=!w.trim(G[0].nodeValue.substring(0,J)).length&&G;O=!!G}if(G)if(!(t=G[0].previousSibling))l=
G.parent()}else{if(J)t=G[0].childNodes[J-1]||G[0].lastChild;t||(l=G)}for(;l||t;){if(l&&!t){if(!F&&D._4e_equals(l,b))F=true;if(!d._4e_contains(l))break;if(!O||l.css("display")!="inline"){O=false;if(F)g=l;else this.setStartBefore(l)}t=l[0].previousSibling}for(;t;){G=false;if(t.nodeType==j.NODE_TEXT){J=t.nodeValue;if(/[^\s\ufeff]/.test(J))t=null;G=/[\s\ufeff]$/.test(J)}else if(t.offsetWidth>0&&!t.getAttribute("_ke_bookmark"))if(O&&o.$removeEmpty[t.nodeName.toLowerCase()]){J=D.text(t);if(/[^\s\ufeff]/.test(J))t=
null;else for(var K=t.all||t.getElementsByTagName("*"),P=0,N;N=K[P++];)if(!o.$removeEmpty[N.nodeName.toLowerCase()]){t=null;break}if(t)G=!!J.length}else t=null;if(G)if(O)if(F)g=l;else l&&this.setStartBefore(l);else O=true;if(t){G=t.previousSibling;if(!l&&!G){l=new c(t);t=null;break}t=G}else l=null}if(l)l=l.parent()}G=this.endContainer;J=this.endOffset;l=t=null;F=O=false;if(G[0].nodeType==j.NODE_TEXT){G=!w.trim(G[0].nodeValue.substring(J)).length&&G;O=!(G&&G[0].nodeValue.length);if(G)if(!(t=G[0].nextSibling))l=
G.parent()}else(t=G[0].childNodes[J])||(l=G);for(;l||t;){if(l&&!t){if(!F&&D._4e_equals(l,b))F=true;if(!d._4e_contains(l))break;if(!O||l.css("display")!="inline"){O=false;if(F)k=l;else l&&this.setEndAfter(l)}t=l[0].nextSibling}for(;t;){G=false;if(t.nodeType==j.NODE_TEXT){J=t.nodeValue;if(/[^\s\ufeff]/.test(J))t=null;G=/^[\s\ufeff]/.test(J)}else if(t.offsetWidth>0&&!t.getAttribute("_ke_bookmark"))if(O&&o.$removeEmpty[t.nodeName.toLowerCase()]){J=D.text(t);if(/[^\s\ufeff]/.test(J))t=null;else{K=t.all||
t.getElementsByTagName("*");for(P=0;N=K[P++];)if(!o.$removeEmpty[N.nodeName.toLowerCase()]){t=null;break}}if(t)G=!!J.length}else t=null;if(G)if(O)if(F)k=l;else this.setEndAfter(l);if(t){G=t.nextSibling;if(!l&&!G){l=new c(t);t=null;break}t=G}else l=null}if(l)l=l.parent()}if(g&&k){b=g._4e_contains(k)?k:g;this.setStartBefore(b);this.setEndAfter(b)}break;case i.ENLARGE_BLOCK_CONTENTS:case i.ENLARGE_LIST_ITEM_CONTENTS:l=new H(this.document);d=new c(this.document.body);l.setStartAt(d,i.POSITION_AFTER_START);
l.setEnd(this.startContainer,this.startOffset);l=new s(l);var S,Y,Z=s.blockBoundary(b==i.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),ca=function($){var n=Z($);n||(S=$);return n};g=function($){var n=ca($);if(!n&&$[0]&&$._4e_name()=="br")Y=$;return n};l.guard=ca;l=l.lastBackward();S=S||d;this.setStartAt(S,S._4e_name()!="br"&&(!l&&this.checkStartOfBlock()||l&&S._4e_contains(l))?i.POSITION_AFTER_START:i.POSITION_AFTER_END);l=this.clone();l.collapse();l.setEndAt(d,i.POSITION_BEFORE_END);l=new s(l);l.guard=
b==i.ENLARGE_LIST_ITEM_CONTENTS?g:ca;S=null;l=l.lastForward();S=S||d;this.setEndAt(S,!l&&this.checkEndOfBlock()||l&&S._4e_contains(l)?i.POSITION_BEFORE_END:i.POSITION_BEFORE_START);Y&&this.setEndAfter(Y)}},checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&b[0].nodeType==j.NODE_TEXT)if(w.trim(b[0].nodeValue.substring(0,d)).length)return false;this.trim();b=new a(this.startContainer);d=this.clone();d.collapse(true);d.setStartAt(b.block||b.blockLimit,i.POSITION_AFTER_START);
b=new s(d);b.evaluator=E(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==j.NODE_TEXT)if(w.trim(b[0].nodeValue.substring(d)).length)return false;this.trim();b=new a(this.endContainer);d=this.clone();d.collapse(false);d.setEndAt(b.block||b.blockLimit,i.POSITION_BEFORE_END);b=new s(d);b.evaluator=E(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,d){var g=this.clone();g[d==i.START?"setStartAt":"setEndAt"](b,d==i.START?i.POSITION_AFTER_START:i.POSITION_BEFORE_END);b=new s(g);b.evaluator=I;return b[d==i.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,d=this.endContainer,g=this.startOffset,k=this.endOffset,l;if(b[0].nodeType==j.NODE_ELEMENT){l=b[0].childNodes.length;if(l>
g)b=new c(b[0].childNodes[g]);else if(l<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new c(b);b=b._4e_nextSourceNode()||b}}if(d[0].nodeType==j.NODE_ELEMENT){l=d[0].childNodes.length;if(l>k)d=(new c(d[0].childNodes[k]))._4e_previousSourceNode(true);else if(l<1)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=new c(d)}}if(b._4e_position(d)&v.POSITION_FOLLOWING)b=d;return{startNode:b,endNode:d}},fixBlock:function(b,d){var g=this.createBookmark();
d=new c(this.document.createElement(d));this.collapse(b);this.enlarge(i.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();p.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(g);return d},splitBlock:function(b){var d=new a(this.startContainer),g=new a(this.endContainer),k=d.block,l=g.block,t=null;if(d.blockLimit[0]!==g.blockLimit[0])return null;if(b!="br"){if(!k){k=this.fixBlock(true,b);l=(new a(this.endContainer)).block}l||(l=this.fixBlock(false,b))}b=k&&this.checkStartOfBlock();
d=l&&this.checkEndOfBlock();this.deleteContents();if(k&&D._4e_equals(k,l))if(d){t=new a(this.startContainer);this.moveToPosition(l,i.POSITION_AFTER_END);l=null}else if(b){t=new a(this.startContainer);this.moveToPosition(k,i.POSITION_BEFORE_START);k=null}else{l=this.splitElement(k);!p.ie&&!w.inArray(k._4e_name(),["ul","ol"])&&k._4e_appendBogus()}return{previousBlock:k,nextBlock:l,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:t}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
i.POSITION_BEFORE_END);var d=this.extractContents(),g=b._4e_clone(false);g[0].appendChild(d);g.insertAfter(b);this.moveToPosition(b,i.POSITION_AFTER_END);return g},moveToElementEditablePosition:function(b,d){var g,k=y.XHTML_DTD;if(k.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==j.NODE_ELEMENT;){if(g=b._4e_isEditable())this.moveToPosition(b,d?i.POSITION_BEFORE_END:i.POSITION_AFTER_START);else if(k.$inline[b._4e_name()]){this.moveToPosition(b,d?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);
return true}if((b=k.$empty[b._4e_name()]?b[d?"_4e_previous":"_4e_next"](A):b[d?"_4e_last":"_4e_first"](A))&&b[0].nodeType==j.NODE_TEXT){this.moveToPosition(b,d?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);return true}}return g},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==j.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var f={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},e=new s.whitespaces,m=new s.bookmark;y.Range=H});
KISSY.Editor.add("domiterator",function(y){function H(x){if(!(arguments.length<1)){this.range=x;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var I=KISSY,A=I.UA,E=y.Walker,C=y.Range,u=y.RANGE,w=y.NODE,j=y.ElementPath,i=I.Node,v=I.DOM,s=/^[\r\n\t ]*$/,D=E.bookmark();I.augment(H,{getNextParagraph:function(x){var p,o,a,c,h;if(!this._.lastNode){o=this.range.clone();o.enlarge(this.forceBrBreak||!this.enlargeBr?u.ENLARGE_LIST_ITEM_CONTENTS:u.ENLARGE_BLOCK_CONTENTS);
var f=new E(o),e=E.bookmark(true,true);f.evaluator=e;this._.nextNode=f.next();f=new E(o);f.evaluator=e;f=f.previous();this._.lastNode=f._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==w.NODE_TEXT&&!I.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){e=new C(o.document);e.moveToPosition(this._.lastNode,u.POSITION_AFTER_END);if(e.checkEndOfBlock()){e=new j(e.endContainer);this._.lastNode=(e.block||e.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new i(o.document.createTextNode(""));v.insertAfter(this._.lastNode[0],f[0])}o=null}e=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;e;){var m=false,b=e[0].nodeType!=w.NODE_ELEMENT,d=false;if(b){if(e[0].nodeType==w.NODE_TEXT)if(s.test(e[0].nodeValue))b=false}else{var g=e._4e_name();if(e._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(g=="br")b=true;else if(!o&&!e[0].childNodes.length&&g!="hr"){p=e;a=e._4e_equals(f);break}if(o){o.setEndAt(e,u.POSITION_BEFORE_START);
if(g!="br")this._.nextNode=e}m=true}else{if(e[0].firstChild){if(!o){o=new C(this.range.document);o.setStartAt(e,u.POSITION_BEFORE_START)}e=new i(e[0].firstChild);continue}b=true}}if(b&&!o){o=new C(this.range.document);o.setStartAt(e,u.POSITION_BEFORE_START)}a=(!m||b)&&e._4e_equals(f);if(o&&!m)for(;!e[0].nextSibling&&!a;){g=e.parent();if(g._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){m=true;a||g._4e_equals(f);break}e=g;b=true;a=e._4e_equals(f);d=true}b&&o.setEndAt(e,u.POSITION_AFTER_END);e=e._4e_nextSourceNode(d,
null,f);a=!e;if((m||a)&&o){b=o.getBoundaryNodes();m=new j(o.startContainer);if(b.startNode.parent()._4e_equals(m.blockLimit)&&D(b.startNode)&&D(b.endNode)){o=null;this._.nextNode=null}else break}if(a)break}if(!p){if(!o){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}m=new j(o.startContainer);e=m.blockLimit;b={div:1,th:1,td:1};p=m.block;if((!p||!p[0])&&!this.enforceRealBlocks&&b[e._4e_name()]&&o.checkStartOfBlock()&&o.checkEndOfBlock())p=e;else if(!p||this.enforceRealBlocks&&
p._4e_name()=="li"){p=new i(this.range.document.createElement(x||"p"));p[0].appendChild(o.extractContents());p._4e_trim();o.insertNode(p);c=h=true}else if(p._4e_name()!="li"){if(!o.checkStartOfBlock()||!o.checkEndOfBlock()){p=p._4e_clone(false);p[0].appendChild(o.extractContents());p._4e_trim();h=o.splitBlock();c=!h.wasStartOfBlock;h=!h.wasEndOfBlock;o.insertNode(p)}}else if(!a)this._.nextNode=p._4e_equals(f)?null:o.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,f)}if(c){o=new i(p[0].previousSibling);
if(o[0]&&o[0].nodeType==w.NODE_ELEMENT)if(o._4e_name()=="br")o._4e_remove();else o[0].lastChild&&o[0].lastChild.nodeName.toLowerCase()=="br"&&v._4e_remove(o[0].lastChild)}if(h){o=E.bookmark(false,true);c=new i(p[0].lastChild);if(c[0]&&c[0].nodeType==w.NODE_ELEMENT&&c._4e_name()=="br")if(A.ie||c._4e_previous(o)||c._4e_next(o))c._4e_remove()}if(!this._.nextNode)this._.nextNode=a||p._4e_equals(f)?null:p._4e_nextSourceNode(true,null,f);return p}});C.prototype.createIterator=function(){return new H(this)}});
KISSY.Editor.add("selection",function(y){function H(f){this.document=f;this._={cache:{}};if(C.ie){var e=this.getNative().createRange();if(!e||e.item&&e.item(0).ownerDocument!=f||e.parentElement&&e.parentElement().ownerDocument!=f)this.isInvalid=true}}function I(f){f=new H(f);return!f||f.isInvalid?null:f}function A(f){var e=f.document,m=new i(e.body),b=new i(e.documentElement);if(C.ie){if(C.ie<8||document.documentMode==7)b.on("click",function(t){u._4e_name(t.target)==="html"&&f.getSelection().getRanges()[0].select()});
var d,g;m.on("focusin",function(t){if(t.target.nodeName.toUpperCase()=="BODY")if(d){try{d.select()}catch(F){}d=null}});m.on("focus",function(){g=true;l()});m.on("beforedeactivate",function(t){t.relatedTarget||(g=false)});C.ie<8&&w.on(u._4e_getWin(e),"blur",function(){e.selection.empty()});m.on("mousedown",k);m.on("mouseup",function(){g=true;setTimeout(function(){l(true)},0)});m.on("keydown",k);m.on("keyup",function(){g=true;l()});w.on(e,"selectionchange",l);var k=function(){g=false},l=function(t){if(g){var F=
f.document,O=f.getSelection(),G=O.getType(),J=O&&O.getNative();if(t&&J&&G==v.SELECTION_NONE)if(!F.queryCommandEnabled("InsertImage")){setTimeout(function(){l(true)},50);return}var K;if(!(J&&G==v.SELECTION_TEXT&&(K=u._4e_name(J.createRange().parentElement()))&&K in{input:1,textarea:1})){d=J&&O.getRanges()[0];f._monitor()}}}}else{w.on(e,"mouseup",f._monitor,f);w.on(e,"keyup",f._monitor,f)}}y.SELECTION={};var E=KISSY,C=E.UA,u=E.DOM,w=E.Event,j=y.Utils.tryThese,i=E.Node,v=y.SELECTION,s=y.RANGE,D=y.NODE,
x=y.Walker,p=y.Range;v.SELECTION_NONE=1;v.SELECTION_TEXT=2;v.SELECTION_ELEMENT=3;var o={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};E.augment(H,{getNative:C.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=u._4e_getWin(this.document).getSelection())},getType:C.ie?function(){var f=this._.cache;
if(f.type)return f.type;var e=v.SELECTION_NONE;try{var m=this.getNative(),b=m.type;if(b=="Text")e=v.SELECTION_TEXT;if(b=="Control")e=v.SELECTION_ELEMENT;if(m.createRange().parentElement)e=v.SELECTION_TEXT}catch(d){}return f.type=e}:function(){var f=this._.cache;if(f.type)return f.type;var e=v.SELECTION_TEXT,m=this.getNative();if(m){if(m.rangeCount==1){m=m.getRangeAt(0);var b=m.startContainer;if(b==m.endContainer&&b.nodeType==D.NODE_ELEMENT&&m.endOffset-m.startOffset===1&&o[b.childNodes[m.startOffset].nodeName.toLowerCase()])e=
v.SELECTION_ELEMENT}}else e=v.SELECTION_NONE;return f.type=e},getRanges:C.ie?function(){var f=function(e,m){e=e.duplicate();e.collapse(m);m=e.parentElement();for(var b=m.childNodes,d,g=0;g<b.length;g++){var k=b[g];if(k.nodeType==D.NODE_ELEMENT){d=e.duplicate();d.moveToElementText(k);k=d.compareEndPoints("StartToStart",e);var l=d.compareEndPoints("EndToStart",e);d.collapse();if(k>0)break;else if(!k||l==1&&k==-1)return{container:m,offset:g};else if(!l)return{container:m,offset:g+1};d=null}}if(!d){d=
e.duplicate();d.moveToElementText(m);d.collapse(false)}d.setEndPoint("StartToStart",e);e=d.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;e>0;)e-=b[--g].nodeValue.length}catch(t){e=0}return e===0?{container:m,offset:g}:{container:b[g],offset:-e}};return function(){var e=this._.cache;if(e.ranges)return e.ranges;var m=this.getNative(),b=m&&m.createRange(),d=this.getType();if(!m)return[];if(d==v.SELECTION_TEXT){m=new p(this.document);d=f(b,true);m.setStart(new i(d.container),d.offset);d=f(b);m.setEnd(new i(d.container),
d.offset);return e.ranges=[m]}else if(d==v.SELECTION_ELEMENT){e=this._.cache.ranges=[];for(d=0;d<b.length;d++){var g=b.item(d),k=g.parentNode,l=0;for(m=new p(this.document);l<k.childNodes.length&&k.childNodes[l]!=g;l++);m.setStart(new i(k),l);m.setEnd(new i(k),l+1);e.push(m)}return e}return e.ranges=[]}}():function(){var f=this._.cache;if(f.ranges)return f.ranges;var e=[],m=this.getNative();if(!m)return[];for(var b=0;b<m.rangeCount;b++){var d=m.getRangeAt(b),g=new p(this.document);g.setStart(new i(d.startContainer),
d.startOffset);g.setEnd(new i(d.endContainer),d.endOffset);e.push(g)}return f.ranges=e},getStartElement:function(){var f=this._.cache;if(f.startElement!==undefined)return f.startElement;var e,m=this.getNative();switch(this.getType()){case v.SELECTION_ELEMENT:return this.getSelectedElement();case v.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();;){e=b.startContainer;if(b.startOffset==(e[0].nodeType===D.NODE_ELEMENT?e[0].childNodes.length:e[0].nodeValue.length)&&!e._4e_isBlockBoundary())b.setStartAfter(e);
else break}e=b.startContainer;if(e[0].nodeType!=D.NODE_ELEMENT)return e.parent();e=new i(e[0].childNodes[b.startOffset]);if(!e[0]||e[0].nodeType!=D.NODE_ELEMENT)return b.startContainer;for(b=e[0].firstChild;b&&b.nodeType==D.NODE_ELEMENT;){e=new i(b);b=b.firstChild}return e}if(C.ie){b=m.createRange();b.collapse(true);e=b.parentElement()}else if((e=m.anchorNode)&&e.nodeType!=D.NODE_ELEMENT)e=e.parentNode}return f.startElement=e?new i(e):null},getSelectedElement:function(){var f=this._.cache;if(f.selectedElement!==
undefined)return f.selectedElement;var e=this,m=j(function(){return e.getNative().createRange().item(0)},function(){for(var b=e.getRanges()[0],d,g,k=2;k&&!((d=b.getEnclosedNode())&&d[0].nodeType==D.NODE_ELEMENT&&o[d._4e_name()]&&(g=d));k--)b.shrink(s.SHRINK_ELEMENT);return g[0]});return f.selectedElement=m?new i(m):null},reset:function(){this._.cache={}},selectElement:function(f){var e;if(C.ie)try{e=this.document.body.createControlRange();e.addElement(f[0]);e.select()}catch(m){e=this.document.body.createTextRange();
e.moveToElementText(f[0]);e.select()}finally{}else{e=this.document.createRange();e.selectNode(f[0]);f=this.getNative();f.removeAllRanges();f.addRange(e)}this.reset()},selectRanges:function(f){if(C.ie)f[0]&&f[0].select();else{var e=this.getNative();if(!e)return;e.removeAllRanges();for(var m=0;m<f.length;m++){var b=f[m],d=this.document.createRange(),g=b.startContainer;b.collapsed&&C.gecko&&C.gecko<1.09&&g[0].nodeType==D.NODE_ELEMENT&&!g[0].childNodes.length&&g[0].appendChild(this.document.createTextNode(""));
d.setStart(g[0],b.startOffset);d.setEnd(b.endContainer[0],b.endOffset);e.addRange(d)}}this.reset()},createBookmarks2:function(f){for(var e=[],m=this.getRanges(),b=0;b<m.length;b++)e.push(m[b].createBookmark2(f));return e},createBookmarks:function(f){for(var e=[],m=this.getRanges(),b=m.length,d=this.document,g,k=0;k<b;k++){e.push(g=m[k].createBookmark(f,true));var l=(f=g.serializable)?E.one("#"+g.startNode,d):g.startNode;g=f?E.one("#"+g.endNode,d):g.endNode;for(var t=k+1;t<b;t++){var F=m[t],O=F.startContainer,
G=F.endContainer;u._4e_equals(O,l.parent())&&F.startOffset++;u._4e_equals(O,g.parent())&&F.startOffset++;u._4e_equals(G,l.parent())&&F.endOffset++;u._4e_equals(G,g.parent())&&F.endOffset++}}return e},selectBookmarks:function(f){for(var e=[],m=0;m<f.length;m++){var b=new p(this.document);b.moveToBookmark(f[m]);e.push(b)}this.selectRanges(e);return this},getCommonAncestor:function(){var f=this.getRanges();return f[0].startContainer._4e_commonAncestor(f[f.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
y.Selection=H;var a={table:1,tbody:1,tr:1},c=x.whitespaces(true),h=/\ufeff|\u00a0/;p.prototype.select=C.ie?function(f){var e=this.collapsed,m,b;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var d=this.startContainer[0].childNodes[this.startOffset];if(d.nodeType==D.NODE_ELEMENT){(new H(this.document)).selectElement(new i(d));return}}if(this.startContainer[0].nodeType==D.NODE_ELEMENT&&this.startContainer._4e_name()in a||this.endContainer[0].nodeType==D.NODE_ELEMENT&&
this.endContainer._4e_name()in a)this.shrink(D.NODE_ELEMENT,true);var g=this.createBookmark();d=g.startNode;var k;if(!e)k=g.endNode;g=this.document.body.createTextRange();g.moveToElementText(d[0]);g.moveStart("character",1);if(k){f=this.document.body.createTextRange();f.moveToElementText(k[0]);g.setEndPoint("EndToEnd",f);g.moveEnd("character",-1)}else{for(m=d[0].nextSibling;m&&!c(m);)m=m.nextSibling;m=!(m&&m.nodeValue&&m.nodeValue.match(h))&&(f||!d[0].previousSibling||d[0].previousSibling&&u._4e_name(d[0].previousSibling)==
"br");b=this.document.createElement("span");b.innerHTML="&#65279;";b=new i(b);u.insertBefore(b[0],d[0]);m&&u.insertBefore(this.document.createTextNode("\ufeff"),d[0])}this.setStartBefore(d);d._4e_remove();if(e){if(m){g.moveStart("character",-1);g.select();this.document.selection.clear()}else g.select();if(b){this.moveToPosition(b,s.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(k);k._4e_remove();g.select()}}:function(){var f=this.startContainer;this.collapsed&&f[0].nodeType==D.NODE_ELEMENT&&
!f[0].childNodes.length&&f[0].appendChild(this.document.createTextNode(""));var e=this.document.createRange();e.setStart(f[0],this.startOffset);try{e.setEnd(this.endContainer[0],this.endOffset)}catch(m){if(m.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);e.setEnd(this.endContainer[0],this.endOffset)}else throw m;}f=I(this.document).getNative();f.removeAllRanges();f.addRange(e)};y.on("instanceCreated",function(f){A(f.editor)})});
KISSY.Editor.add("styles",function(y){function H(n,q){for(var r in n)n[r]=n[r].replace($,function(B,z){return q[z]})}function I(n,q){if(q){n=k.clone(n);H(n.attributes,q);H(n.styles,q)}q=this.element=(n.element||"*").toLowerCase();this.type=q=="#"||Y[q]?t.STYLE_BLOCK:Z[q]?t.STYLE_OBJECT:t.STYLE_INLINE;this._={definition:n}}function A(n,q){q=q?this.removeFromRange:this.applyToRange;n.body.focus();n=new O(n);for(var r=n.getRanges(),B=0;B<r.length;B++)q.call(this,r[B]);n.selectRanges(r)}function E(n,
q){var r=n.element;if(r=="*")r="span";q=new P(q.createElement(r));return C(q,n)}function C(n,q){var r=q._.definition;q=r.attributes;r=I.getStyleText(r);if(q)for(var B in q)n.attr(B,q[B]);if(r)n[0].style.cssText=r;return n}function u(n){var q=n.createBookmark(true),r=n.createIterator();r.enforceRealBlocks=true;r.enlargeBr=true;for(var B,z=n.document;B=r.getNextParagraph();){var L=E(this,z);v(B,L)}n.moveToBookmark(q)}function w(n,q,r){var B="",z="";n=n.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(L,M,Q){M&&(B=M);Q&&(z=Q);return""});return B+n.replace(q,r)+z}function j(n,q){var r=n.html();r=w(r,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");r=r.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");r=r.replace(/([ \t\n\r]+|&nbsp;)/g," ");r=r.replace(/<br\b[^>]*>/gi,"\n");if(N.ie){n=n[0].ownerDocument.createElement("div");n.appendChild(q[0]);q[0].outerHTML="<pre>"+r+"</pre>";q=new P(n.firstChild);q._4e_remove()}else q.html(r);return q}function i(n){var q=[];w(n._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(r,B,z){return B+"</pre>"+z+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(r,B){q.push(B)});return q}function v(n,q){var r=q._4e_name=="pre",B=n._4e_name=="pre",z=!r&&B;if(r&&!B)q=j(n,q);else if(z)q=D(i(n),q);else n._4e_moveChildren(q);n[0].parentNode.replaceChild(q[0],n[0]);r&&s(q)}function s(n){var q;if((q=n._4e_previousSourceNode(true,G.NODE_ELEMENT))&&q._4e_name()=="pre"){var r=w(q.html(),/\n$/,"")+"\n\n"+w(n.html(),/^\n/,"");if(N.ie)n[0].outerHTML="<pre>"+r+"</pre>";else n.html(r);
q._4e_remove()}}function D(n,q){for(var r=q[0].ownerDocument.createDocumentFragment(),B=0;B<n.length;B++){var z=n[B];z=z.replace(/(\r\n|\r)/g,"\n");z=w(z,/^[ \t]*\n/,"");z=w(z,/\n$/,"");z=w(z,/^[ \t]+|[ \t]+$/g,function(M,Q){return M.length==1?"&nbsp;":Q?" "+(new Array(M.length)).join("&nbsp;"):(new Array(M.length)).join("&nbsp;")+" "});z=z.replace(/\n/g,"<br>");z=z.replace(/[ \t]{2,}/g,function(M){return(new Array(M.length)).join("&nbsp;")+" "});var L=q._4e_clone();L.html(z);r.appendChild(L[0])}return r}
function x(n){var q=n.document;if(n.collapsed){q=E(this,q);n.insertNode(q);n.moveToPosition(q,F.POSITION_BEFORE_END)}else{var r=this.element,B=this._.definition,z,L=y.XHTML_DTD[r]||(z=true,y.XHTML_DTD.span),M=n.createBookmark();n.enlarge(F.ENLARGE_ELEMENT);n.trim();var Q=n.createBookmark(),da=Q.startNode;Q=Q.endNode;for(var T=da,V;T&&T[0];){var R=false;if(l._4e_equals(T,Q)){T=null;R=true}else{var U=T[0].nodeType,aa=U==G.NODE_ELEMENT?T._4e_name():null;if(aa&&T.attr("_ke_bookmark")){T=T._4e_nextSourceNode(true);
continue}if(!aa||L[aa]&&(T._4e_position(Q)|J.POSITION_PRECEDING|J.POSITION_IDENTICAL|J.POSITION_IS_CONTAINED)==J.POSITION_PRECEDING+J.POSITION_IDENTICAL+J.POSITION_IS_CONTAINED&&(!B.childRule||B.childRule(T))){var ba=T.parent();if(ba&&ba[0]&&((y.XHTML_DTD[ba._4e_name()]||y.XHTML_DTD.span)[r]||z)&&(!B.parentRule||B.parentRule(ba))){if(!V&&(!aa||!y.XHTML_DTD.$removeEmpty[aa]||(T._4e_position(Q)|J.POSITION_PRECEDING|J.POSITION_IDENTICAL|J.POSITION_IS_CONTAINED)==J.POSITION_PRECEDING+J.POSITION_IDENTICAL+
J.POSITION_IS_CONTAINED)){V=new K(q);V.setStartBefore(T)}if(U==G.NODE_TEXT||U==G.NODE_ELEMENT&&!T[0].childNodes.length){U=T;for(var W;!U[0].nextSibling&&(W=U.parent(),L[W._4e_name()])&&(W._4e_position(da)|J.POSITION_FOLLOWING|J.POSITION_IDENTICAL|J.POSITION_IS_CONTAINED)==J.POSITION_FOLLOWING+J.POSITION_IDENTICAL+J.POSITION_IS_CONTAINED&&(!B.childRule||B.childRule(W));)U=W;V.setEndAfter(U);U[0].nextSibling||(R=true)}}else R=true}else R=true;T=T._4e_nextSourceNode()}if(R&&V&&!V.collapsed){R=E(this,
q);for(U=V.getCommonAncestor();R&&U&&R[0]&&U[0];){if(U._4e_name()==r){for(var X in B.attributes)R.attr(X)==U.attr(X)&&R[0].removeAttribute(X);for(var ea in B.styles)R._4e_style(ea)==U._4e_style(ea)&&R._4e_style(ea,"");if(!R._4e_hasAttributes()){R=null;break}}U=U.parent()}if(R){R[0].appendChild(V.extractContents());b(this,R);V.insertNode(R);R._4e_mergeSiblings();N.ie||R[0].normalize()}V=null}}da._4e_remove();Q._4e_remove();n.moveToBookmark(M);n.shrink(F.SHRINK_TEXT)}}function p(n){n.enlarge(F.ENLARGE_ELEMENT);
var q=n.createBookmark(),r=q.startNode;if(n.collapsed){for(var B=new S(r.parent()),z,L=0,M;L<B.elements.length&&(M=B.elements[L]);L++){if(M==B.block||M==B.blockLimit)break;if(this.checkElementRemovable(M)){var Q=n.checkBoundaryOfElement(M,F.END),da=!Q&&n.checkBoundaryOfElement(M,F.START);if(da||Q){z=M;z.match=da?"start":"end"}else{M._4e_mergeSiblings();M._4e_name()==this.element?e(this,M):d(M,f(this)[M._4e_name()])}}}if(z&&z[0]){M=r;for(L=0;;L++){Q=B.elements[L];if(l._4e_equals(Q,z))break;else if(Q.match)continue;
else Q=Q._4e_clone();Q[0].appendChild(M[0]);M=Q}l[z.match=="start"?"insertBefore":"insertAfter"](M[0],z[0])}}else{var T=q.endNode,V=this;B=function(){for(var R=new S(r.parent()),U=new S(T.parent()),aa=null,ba=null,W=0;W<R.elements.length;W++){var X=R.elements[W];if(X==R.block||X==R.blockLimit)break;if(V.checkElementRemovable(X))aa=X}for(W=0;W<U.elements.length;W++){X=U.elements[W];if(X==U.block||X==U.blockLimit)break;if(V.checkElementRemovable(X))ba=X}ba&&T._4e_breakParent(ba);aa&&r._4e_breakParent(aa)};
B();for(z=new P(r[0].nextSibling);z[0]!==T[0];){L=z._4e_nextSourceNode();if(z[0]&&z[0].nodeType==G.NODE_ELEMENT&&this.checkElementRemovable(z)){z._4e_name()==this.element?e(this,z):d(z,f(this)[z._4e_name()]);if(L[0].nodeType==G.NODE_ELEMENT&&L._4e_contains(r)){B();L=new P(r[0].nextSibling)}}z=L}}n.moveToBookmark(q)}function o(n){var q={};n.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(r,B,z){q[B]=z});return q}function a(n,q){typeof n=="string"&&(n=o(n));typeof q==
"string"&&(q=o(q));for(var r in n)if(!(r in q&&(q[r]==n[r]||n[r]=="inherit"||q[r]=="inherit")))return false;return true}function c(n,q){if(q!==false){q=document.createElement("span");q.style.cssText=n;n=q.style.cssText||""}else n=n;return n.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function h(n){var q=n._AC;if(q)return q;q={};var r=0,B=n.attributes;if(B)for(var z in B){r++;q[z]=B[z]}if(B=I.getStyleText(n)){q.style||r++;q.style=B}q._length=r;return n._AC=
q}function f(n){if(n._.overrides)return n._.overrides;var q=n._.overrides={},r=n._.definition.overrides;if(r){k.isArray(r)||(r=[r]);for(var B=0;B<r.length;B++){var z=r[B],L,M;if(typeof z=="string")L=z.toLowerCase();else{L=z.element?z.element.toLowerCase():n.element;M=z.attributes}z=q[L]||(q[L]={});if(M){z=z.attributes=z.attributes||[];for(var Q in M)z.push([Q.toLowerCase(),M[Q]])}}}return q}function e(n,q){var r=n._.definition,B=k.mix(k.mix({},r.attributes),f(n)[q._4e_name()]);r=r.styles;var z=k.isEmptyObject(B)&&
k.isEmptyObject(r);for(var L in B)if(!((L=="class"||n._.definition.fullMatch)&&q.attr(L)!=m(L,B[L]))){z=z||!!q._4e_hasAttribute(L);q.removeAttr(L)}for(var M in r)if(!(n._.definition.fullMatch&&q._4e_style(M)!=m(M,r[M],true))){z=z||!!q._4e_style(M);q._4e_style(M,"")}z&&g(q)}function m(n,q,r){var B=new P("<span></span>");B[r?"_4e_style":"attr"](n,q);return B[r?"_4e_style":"attr"](n)}function b(n,q){for(var r=f(n),B=q.all(n.element),z=B.length;--z>=0;)e(n,new P(B[z]));for(var L in r)if(L!=n.element){B=
q.all(L);for(z=B.length-1;z>=0;z--){var M=new P(B[z]);d(M,r[L])}}}function d(n,q){if(q=q&&q.attributes)for(var r=0;r<q.length;r++){var B=q[r][0],z;if(z=n.attr(B)){var L=q[r][1];if(L===null||L.test&&L.test(z)||typeof L=="string"&&z==L)n[0].removeAttribute(B)}}g(n)}function g(n){if(!n._4e_hasAttributes()){var q=n[0].firstChild,r=n[0].lastChild;n._4e_remove(true);if(q){q.nodeType==G.NODE_ELEMENT&&l._4e_mergeSiblings(q);r&&!q===r&&r.nodeType==G.NODE_ELEMENT&&l._4e_mergeSiblings(r)}}}var k=KISSY,l=k.DOM,
t=y.STYLE={},F=y.RANGE,O=y.Selection,G=y.NODE,J=y.POSITION,K=y.Range,P=k.Node,N=k.UA,S=y.ElementPath,Y={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},Z={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},ca=/\s*(?:;\s*|$)/,$=/#\((.+?)\)/g;t.STYLE_BLOCK=1;t.STYLE_INLINE=2;t.STYLE_OBJECT=3;I.prototype={apply:function(n){A.call(this,n,false)},remove:function(n){A.call(this,n,true)},applyToRange:function(n){return(this.applyToRange=this.type==t.STYLE_INLINE?
x:this.type==t.STYLE_BLOCK?u:this.type==t.STYLE_OBJECT?null:null).call(this,n)},removeFromRange:function(n){return(this.removeFromRange=this.type==t.STYLE_INLINE?p:null).call(this,n)},applyToObject:function(n){C(n,this)},checkElementRemovable:function(n,q){if(!n)return false;var r=this._.definition;if(n._4e_name()==this.element){if(!q&&!n._4e_hasAttributes())return true;r=h(r);if(r._length){for(var B in r)if(B!="_length"){var z=n.attr(B)||"";if(B=="style"?a(r[B],c(z,false)):r[B]==z){if(!q)return true}else if(q)return false}if(q)return true}else return true}if(r=
f(this)[n._4e_name()]){if(!(r=r.attributes))return true;for(q=0;q<r.length;q++){B=r[q][0];if(B=n.attr(B)){z=r[q][1];if(z===null||typeof z=="string"&&B==z||z.test&&z.test(B))return true}}}return false},checkActive:function(n){switch(this.type){case t.STYLE_BLOCK:return this.checkElementRemovable(n.block||n.blockLimit,true);case t.STYLE_OBJECT:case t.STYLE_INLINE:for(var q=n.elements,r=0,B;r<q.length;r++){B=q[r];if(!(this.type==t.STYLE_INLINE&&(l._4e_equals(B,n.block)||l._4e_equals(B,n.blockLimit))))if(!(this.type==
t.STYLE_OBJECT&&!(B._4e_name()in Z)))if(this.checkElementRemovable(B,true))return true}}return false}};I.getStyleText=function(n){var q=n._ST;if(q)return q;q=n.styles;var r=n.attributes&&n.attributes.style||"",B="";if(r.length)r=r.replace(ca,";");for(var z in q){var L=q[z],M=(z+":"+L).replace(ca,";");if(L=="inherit")B+=M;else r+=M}if(r.length)r=c(r);r+=B;return n._ST=r};y.Style=I});
