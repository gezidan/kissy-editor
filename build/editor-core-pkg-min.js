KISSY.add("editor",function(x,G){function H(m,p){var a=this;if(!(a instanceof H))return new H(m,p);if(x.isString(m))m=x.one(m);m=E._4e_wrap(m);p=p||{};p.pluginConfig=p.pluginConfig||{};a.cfg=p;x.app(a,x.EventTarget);a.use=function(c){if(x.isString(c))c=c.split(",");var d=c;c=[];c=x.indexOf("separator",d);var e=c!=-1;c=d.splice(0,e?c+1:d.length);e&&c.pop();c.length!=0?x.use.call(a,c.join(","),function(){e&&a.addPlugin(function(){H.Utils.addSeparator(a.toolBarDiv)});a.use(d)},{order:true,global:H}):
a.on("dataReady",function(){a.setData(m.val());a.fire("save")});return a};a.init(m);return G}function y(m){if(!C)return m.replace(/\.(js|css)/i,"-min.$1");if(C==="dev")return"../src/"+m;return m}var E=x.DOM;x.app(H,x.EventTarget);H.Config.base=x.Config.base+"editor/";var C=x.Config.debug,r={htmlparser:{attach:false,path:y("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},w=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],h=["flashutils",
"clipboard",{name:"color"},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["flashutils","contextmenu","fakeobjects","overlay","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview"]},"indent",
"justify",{name:"link",requires:["bubbleview"]},"list","maximize",{name:"music",requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],j=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},
{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],v,t,D,B;v=0;for(t=h.length;v<t;v++){D=h[v];if(x.isString(D))D=h[v]={name:D};D.requires=D.requires||[];D.requires=D.requires.concat(["button"])}h=[{name:"localStorage",requires:["flashutils"]},{name:"button"},{name:"dd"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},
{name:"select",requires:["overlay"]}].concat(h);v=0;for(t=h.length;v<t;v++){D=h[v];B=D.name;r[B]={attach:false,requires:D.requires,csspath:D.useCss?y("plugins/"+B+"/plugin.css"):G,path:y("plugins/"+B+"/plugin.js")}}v=0;for(t=j.length;v<t;v++){D=j[v];h=G;if(!x.isString(D)){h=D.requires;D=D.name}r[D]={attach:false,requires:h,path:y("plugins/htmldataprocessor/htmlparser/"+D.substring(11)+".js")}}v=0;for(t=w.length;v<t;v++){D=w[v];r[D]={host:"editor",requires:v>0?w[v-1]:[]}}H.add(r);x.Editor=H});
KISSY.Editor.add("utils",function(x){var G=KISSY,H=G.Node,y=G.DOM,E=G.Config.debug,C=G.UA;x.Utils={debugUrl:function(r){if(!E)return r.replace(/\.(js|css)/i,"-min.$1");if(E==="dev")return"../src/"+r;return r},lazyRun:function(r,w,h){var j=r[w],v=r[h];r[w]=function(){j.apply(this,arguments);r[w]=r[h];return v.apply(this,arguments)}},getXY:function(r,w,h,j){h=h.defaultView||h.parentWindow;r-=y.scrollLeft(h);w-=y.scrollTop(h);if(j)if(h!=(j.defaultView||j.parentWindow)&&h.frameElement){j=y._4e_getOffset(h.frameElement,
j);r+=j.left;w+=j.top}return{left:r,top:w}},tryThese:function(){for(var r,w=0,h=arguments.length;w<h;w++){var j=arguments[w];try{r=j();break}catch(v){}}return r},arrayCompare:function(r,w){if(!r&&!w)return true;if(!r||!w||r.length!=w.length)return false;for(var h=0;h<r.length;h++)if(r[h]!==w[h])return false;return true},getByAddress:function(r,w,h){r=r.documentElement;for(var j=0;r&&j<w.length;j++){var v=w[j];if(h)for(var t=-1,D=0;D<r.childNodes.length;D++){var B=r.childNodes[D];if(!(h===true&&B.nodeType==
3&&B.previousSibling&&B.previousSibling.nodeType==3)){t++;if(t==v){r=B;break}}}else r=r.childNodes[v]}return r?new H(r):null},clearAllMarkers:function(r){for(var w in r)r[w]._4e_clearMarkers(r,true)},htmlEncodeAttr:function(r){return r.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(r){return r.replace(/^\s+/,"")},rtrim:function(r){return r.replace(/\s+$/,"")},trim:function(r){return this.ltrim(this.rtrim(r))},mix:function(){for(var r={},w=0;w<arguments.length;w++)r=
G.mix(r,arguments[w]);return r},isCustomDomain:function(){if(!C.ie)return false;var r=document.domain,w=window.location.hostname;return r!=w&&r!="["+w+"]"},addSeparator:function(r){(new G.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(r)},duplicateStr:function(r,w){return(new Array(w+1)).join(r)},throttle:function(r,w,h){h=h||150;if(h===-1)return function(){r.apply(w,arguments)};var j=(new Date).getTime();return function(){var v=(new Date).getTime();if(v-j>h){j=v;r.apply(w,arguments)}}},
buffer:function(r,w,h){h=h||0;var j=null;return function(){j&&clearTimeout(j);var v=arguments;j=setTimeout(function(){return r.apply(w,v)},h)}},isNumber:function(r){return/^\d+(.\d+)?$/.test(G.trim(r))},verifyInputs:function(r){for(var w=0;w<r.length;w++){var h=y._4e_wrap(r[w]),j=G.trim(h.val()),v=h.attr("data-verify");h=h.attr("data-warning");if(v&&!(new RegExp(v)).test(j)){alert(h);return}}return true},sourceDisable:function(r,w){r.on("sourcemode",w.disable,w);r.on("wysiwygmode",w.enable,w)}}});
KISSY.Editor.add("focusmanager",function(x){function G(){this.iframeFocus=true;w=this}function H(){this.iframeFocus=false;w=null}var y=KISSY,E=y.DOM,C=y.Event;y={};var r={},w;y={refreshAll:function(){for(var h in r){var j=r[h];j.document.designMode="off";j.document.designMode="on"}},currentInstance:function(){return w},getInstance:function(h){return r[h]},add:function(h){var j=E._4e_getWin(h.document);C.on(j,"focus",G,h);C.on(j,"blur",H,h)},register:function(h){r[h._UUID]=h},remove:function(h){delete r[h._UUID];
var j=E._4e_getWin(h.document);C.remove(j,"focus",G,h);C.remove(j,"blur",H,h)}};x.focusManager=y});
KISSY.Editor.add("definition",function(x){function G(m){return j+"<html><head><title>kissy-editor</title><link href='"+x.Config.base+v+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(m?'<script id="ke_actscrpt" type="text/javascript">'+(x.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+m+'");<\/script>':"")}var H=KISSY,y=H.UA,E=H.DOM,C=H.Node,r=H.Event,w=x.focusManager,h=x.Utils.tryThese,j="<!doctype html>",v=
x.Utils.debugUrl("theme/editor-iframe.css"),t=1,D="document.open();"+(x.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",B="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(y.ie?"javascript:void(function(){"+encodeURIComponent(D)+"}())":"")+'"  tabIndex="'+
(y.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";x.SOURCE_MODE=0;x.WYSIWYG_MODE=1;H.augment(x,{init:function(m){var p=this,a=new C(B.replace(/\$\(tabIndex\)/,m.attr("tabIndex")));a.on("mousedown",function(e){if(y.webkit){var g=E._4e_name(e.target);if(g=="select"||g=="option")return true}e.halt()});p.editorWrap=a;p._UUID=t++;w.register(p);p.wrap=a.one(".ke-textarea-wrap");p.iframe=p.wrap.one("iframe");p.toolBarDiv=
a.one(".ke-editor-tools");p.textarea=m;p.statusDiv=a.one(".ke-editor-status");p.toolBarDiv._4e_unselectable();p._commands={};var c=m._4e_style("width"),d=m._4e_style("height");if(c){a.css("width",c);m.css("width","100%")}p.textarea.css("display","none");a.insertAfter(m);p.wrap[0].appendChild(m[0]);if(d){p.wrap.css("height",d);m.css("height","100%")}m=p.iframe;p.on("dataReady",function(){p.ready=true;x.fire("instanceCreated",{editor:p})});y.gecko?m.on("load",p._setUpIFrame,p):p._setUpIFrame()},addCommand:function(m,
p){this._commands[m]=p},execCommand:function(m){this.fire("save");this._commands[m].exec(this);this.fire("save")},getMode:function(){return this.textarea.css("display")=="none"?x.WYSIWYG_MODE:x.SOURCE_MODE},getData:function(){var m;m=this.getMode()==x.WYSIWYG_MODE?this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(m,"p");return m},setData:function(m){if(this.htmlDataProcessor)m=this.htmlDataProcessor.toDataFormat(m,"p");this.document.body.innerHTML=
m;if(this.getMode()==x.WYSIWYG_MODE)this.document.body.innerHTML=m;else this.textarea.val(m)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(m){this.document.body.innerHTML=m},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.fire("wysiwygmode")},_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");y.ie<8&&this.textarea.css("height",this.wrap.css("height"));
this.fire("sourcemode")},_prepareIFrameHtml:G,getSelection:function(){var m=new x.Selection(this.document);return!m||m.isInvalid?null:m},focus:function(){var m=E._4e_getWin(this.document);y.webkit&&m&&m.parent&&m.parent.focus();m&&m.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){E._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function m(){e=d.document;p.document=e;a.detach();e.open("text/html","replace");
e.write(c);e.close()}var p=this,a=p.iframe,c=G(p._UUID),d=a[0].contentWindow,e;try{e=d.document}catch(g){a[0].src=a[0].src;if(y.ie&&y.ie<7){setTimeout(m,10);return}}m()},addPlugin:function(m){this.ready?m():this.on("dataReady",m)},_monitor:function(){var m=this;m._monitorId&&clearTimeout(m._monitorId);m._monitorId=setTimeout(function(){var p=m.getSelection();if(p&&!p.isInvalid){p=p.getStartElement();var a=new x.ElementPath(p);if(!m.previousPath||!m.previousPath.compare(a)){m.previousPath=a;m.fire("selectionChange",
{selection:m,path:a,element:p})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(m,p){var a=this;a.focus();var c=m._4e_name(),d=x.XHTML_DTD,e=x.RANGE,g=x.NODE,o=d.$block[c],b=a.getSelection(),f=b.getRanges(),i,l,k,u,F;a.fire("save");for(var O=f.length-1;O>=0;O--){i=f[O];i.deleteContents();l=!O&&m||m._4e_clone(true);p&&p(l);if(o)for(;(u=i.getCommonAncestor(false,true))&&(F=d[u._4e_name()])&&!(F&&F[c]);)if(u._4e_name()in d.span)i.splitElement(u);
else if(i.checkStartOfBlock()&&i.checkEndOfBlock()){i.setStartBefore(u);i.collapse(true);u._4e_remove()}else i.splitBlock();i.insertNode(l);k||(k=l)}m=k._4e_nextSourceNode(true);p=a.document;F=x.XHTML_DTD;if(F.$inline[l._4e_name()]){m=new C(p.createTextNode(" "));m.insertAfter(k)}else if(m){if(m._4e_name()=="br"&&F[m.parent()._4e_name()].p){F=new C("<p>&nbsp;</p>",null,p);m[0].parentNode.replaceChild(F[0],m[0]);m=F}}else{F=new C("<p>&nbsp;</p>",null,p);F.insertAfter(k);m=F}i.moveToPosition(k,e.POSITION_AFTER_END);
m&&m[0].nodeType==g.NODE_ELEMENT&&i.moveToElementEditablePosition(m);b.selectRanges([i]);a.focus();l&&l._4e_scrollIntoView();setTimeout(function(){a.fire("save")},10);return l},insertHtml:function(m){var p=this;if(p.htmlDataProcessor)m=p.htmlDataProcessor.toDataFormat(m);if(y.webkit){m=E.create(m,null,this.document);m=m.nodeType==11?H.makeArray(m.childNodes):[m];for(var a=0;a<m.length;a++)p.insertElement(new C(m[a]))}else{p.focus();p.fire("save");a=p.getSelection();if(y.ie){a=a.getNative();a.type==
"Control"&&a.clear();a.createRange().pasteHTML(m)}else p.document.execCommand("inserthtml",false,m);p.focus();setTimeout(function(){p.fire("save")},10)}}});x._initIFrame=function(m){function p(l){h(function(){d.designMode="on";setTimeout(function(){d.designMode="off";o.focus();if(!arguments.callee.retry)arguments.callee.retry=true},10)},function(){d.designMode="off";E.attr(o,"contentEditable",false);E.attr(o,"contentEditable",true);!l&&p(1)})}var a=w.getInstance(m);m=a.textarea[0];var c=a.iframe[0].contentWindow,
d=a.document,e=a.cfg,g=d.getElementById("ke_actscrpt");g.parentNode.removeChild(g);var o=d.body;if(y.ie){o.hideFocus=true;o.disabled=true;o.contentEditable=true;o.removeAttribute("disabled")}else setTimeout(function(){if(y.gecko||y.opera)o.contentEditable=true;else if(y.webkit)o.parentNode.contentEditable=true;else d.designMode="on"},0);if(y.webkit){r.on(d,"click",function(l){var k=new C(l.target);H.inArray(k._4e_name(),["input","select"])&&l.preventDefault()});r.on(d,"mouseup",function(l){var k=
new C(l.target);H.inArray(k._4e_name(),["input","textarea"])&&l.preventDefault()})}if(y.gecko||y.ie||y.opera){var b;b=new C(E.insertAfter((new C('<span style="position:absolute; left:-10000"></span>'))[0],m));b.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(y.ie&&d.compatMode=="CSS1Compat"||y.gecko||y.opera){var f=new C(d.documentElement);f.on("mousedown",function(l){if(l.target===f[0]){y.gecko&&p(false);b[0].focus()}})}r.on(c,"focus",function(){if(y.gecko)p(false);else y.opera&&
o.focus();a.notifySelectionChange()});y.gecko&&r.on(a.document,"mousedown",function(){a.iframeFocus||p(false)});if(y.ie){r.on(d,"keydown",function(l){if(l.keyCode in{8:1,46:1}){var k=a.getSelection(),u=k.getSelectedElement();if(u){a.fire("save");var F=k.getRanges()[0].createBookmark();u._4e_remove();k.selectBookmarks([F]);a.fire("save");l.preventDefault()}}});if(d.compatMode=="CSS1Compat"){var i={33:1,34:1};r.on(d,"keydown",function(l){l.keyCode in i&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}}setTimeout(function(){y.ie&&setTimeout(function(){if(d){o.runtimeStyle.marginBottom="0px";o.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady");var l=e.disableObjectResizing,k=e.disableInlineTableEditing;if(l||k)try{d.execCommand("enableObjectResizing",false,!l);d.execCommand("enableInlineTableEditing",false,!k)}catch(u){r.on(o,y.ie?"resizestart":"resize",function(F){if(l||E._4e_name(F.target)==="table"&&k)F.preventDefault()})}},10);y.webkit&&r.on(d,"mousedown",
function(l){l=new C(l.target);H.inArray(l._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(l)});w.add(a)};y.gecko&&function(){var m=document.body;if(m){var p=m.getAttribute("onpageshow");m.setAttribute("onpageshow",(p?p+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(x){x.XHTML_DTD=function(){var G=function(o){for(var b=arguments.length-1;b>0;)KISSY.mix(o,arguments[b--]);return o},H={isindex:1,fieldset:1},y={input:1,button:1,select:1,textarea:1,label:1},E=G({a:1},y),C=G({iframe:1},E),r={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},w={ins:1,del:1,script:1,style:1},h=G({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},w),j=G({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},h),v=G({p:1},j);y=G({iframe:1},j,y);j={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var t=G({a:1},y),D={tr:1},B={"#":1},m=G({param:1},j),p=G({form:1},H,C,r,v),a={li:1},c={base:1,link:1,meta:1,title:1},d=G(c,{style:1,script:1}),e={head:1,body:1},g={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:G({html:1},e,c),$block:g,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:t,$body:G({script:1,style:1},g),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:e,head:d,style:B,body:p,base:{},link:{},meta:{},title:B,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:p,td:p,br:{},th:p,center:p,kbd:t,button:G(v,r),basefont:{},h5:t,h4:t,samp:t,h6:t,ol:a,h1:t,h3:t,option:B,h2:t,form:G(H,C,r,v),select:{optgroup:1,option:1},font:t,ins:t,menu:a,abbr:t,label:t,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:t,script:B,tfoot:D,cite:t,li:p,input:{},iframe:p,strong:t,textarea:B,noframes:p,big:t,small:t,span:t,hr:{},dt:t,sub:t,optgroup:{option:1},param:{},bdo:t,"var":t,div:p,object:m,sup:t,dd:p,strike:t,area:{},dir:a,map:G({area:1,form:1,p:1},H,w,r),applet:m,dl:{dt:1,dd:1},del:t,isindex:{},fieldset:G({legend:1},j),thead:D,ul:a,acronym:t,b:t,a:y,blockquote:p,caption:t,i:t,u:t,tbody:D,s:t,address:G(C,v),tt:t,legend:t,q:t,pre:G(h,E),p:t,em:t,dfn:t}}()});
KISSY.Editor.add("dom",function(x){function G(a){return a.replace(/-(\w)/g,function(c,d){return d.toUpperCase()})}var H=KISSY,y=H.DOM,E=H.UA,C=H.Node,r=x.Utils,w={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};x.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};x.POSITION={};var h=x.NODE,j=x.POSITION;j.POSITION_IDENTICAL=0;j.POSITION_DISCONNECTED=
1;j.POSITION_FOLLOWING=2;j.POSITION_PRECEDING=4;j.POSITION_IS_CONTAINED=8;j.POSITION_CONTAINS=16;var v={},t={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},D={hr:1},B=function(a){return a[0]||a},m=function(a){if(a&&!a[0])return new C(a);return a},p={_4e_wrap:m,_4e_equals:function(a,c){if(!a&&!c)return true;if(!a||!c)return false;a=B(a);c=B(c);return a===c},_4e_isBlockBoundary:function(a,
c){a=m(a);c=H.mix(H.mix({},D),c||{});return t[a.css("display")]||c[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=B(a);for(var c=a.parentNode.childNodes,d=0;d<c.length;d++)if(c[d]===a)return d;return-1},_4e_first:function(a,c){a=B(a);if((a=(a=a.firstChild)&&new C(a))&&c&&!c(a))a=a._4e_next(c);return a},_4e_move:function(a,c,d){a._4e_remove();a=B(a);c=B(c);d?c.insertBefore(a,c.firstChild):c.appendChild(a)},
_4e_name:function(a){a=B(a);var c=a.nodeName.toLowerCase();if(E.ie)if((a=a.scopeName)&&a!="HTML")c=a.toLowerCase()+":"+c;return c},_4e_isIdentical:function(a,c){if(a._4e_name()!=c._4e_name())return false;var d=a[0].attributes,e=c[0].attributes,g=d.length,o=e.length;if(!E.ie&&g!=o)return false;for(var b=0;b<g;b++){var f=d[b];if((!E.ie||f.specified&&f.nodeName!="_ke_expando")&&f.nodeValue!=c.attr(f.nodeName))return false}if(E.ie)for(b=0;b<o;b++){f=e[b];if(f.specified&&f.nodeName!="_ke_expando"&&f.nodeValue!=
a.attr(f.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=B(a).childNodes;for(var c=0,d=a.length;c<d;c++){var e=a[c],g=e.nodeType;if(!(g==h.NODE_ELEMENT&&e.getAttribute("_ke_bookmark")))if(g==h.NODE_ELEMENT&&!p._4e_isEmptyInlineRemoveable(e)||g==h.NODE_TEXT&&H.trim(e.nodeValue))return false}return true},_4e_moveChildren:function(a,c,d){a=B(a);c=c[0]||c;if(a!=c)if(d)for(;d=a.lastChild;)c.insertBefore(a.removeChild(d),c.firstChild);else for(;d=a.firstChild;)c.appendChild(a.removeChild(d))},
_4e_mergeSiblings:function(){function a(c,d,e){if(d[0]&&d[0].nodeType==h.NODE_ELEMENT){for(var g=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){g.push(d);d=e?new C(d[0].nextSibling):new C(d[0].previousSibling);if(!d[0]||d[0].nodeType!=h.NODE_ELEMENT)return}if(c._4e_isIdentical(d)){for(var o=e?c[0].lastChild:c[0].firstChild;g.length;)g.shift()._4e_move(c,!e);d._4e_moveChildren(c,!e);d._4e_remove();o[0]&&o[0].nodeType==h.NODE_ELEMENT&&o._4e_mergeSiblings()}}}return function(c){if(c[0])if(w[c._4e_name()]||
c._4e_name()=="a"){a(c,new C(c[0].nextSibling),true);a(c,new C(c[0].previousSibling))}}}(),_4e_unselectable:E.gecko?function(a){a=B(a);a.style.MozUserSelect="none"}:E.webkit?function(a){a=B(a);a.style.KhtmlUserSelect="none"}:function(a){a=B(a);if(E.ie||E.opera){var c,d=0;for(a.unselectable="on";c=a.all[d++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(a,c){a=B(a);var d,e=0;d=0;var g=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,o=a.ownerDocument,b=o.documentElement;c=c||o;if(a.getBoundingClientRect){if(a!==o.body&&b!==a){d=a.getBoundingClientRect();e=d.left+(c===o?y.scrollLeft(g):0);d=d.top+(c===o?y.scrollTop(g):0)}if(c)if(g!=(c.defaultView||c.parentWindow)&&g.frameElement){c=p._4e_getOffset(g.frameElement,c);e+=c.left;d+=c.top}}return{left:e,top:d}},_4e_getFrameDocument:function(a){return(a=B(a))&&a.contentWindow.document},_4e_splitText:function(a,c){a=B(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=
h.NODE_TEXT)){if(E.ie&&c==a.nodeValue.length){d=d.createTextNode("");y.insertAfter(d,a);return d}a=new C(a.splitText(c));if(E.ie==8){d=d.createTextNode("");y.insertAfter(d,a[0]);d.parentNode.removeChild(d)}return a}},_4e_parents:function(a,c){a=m(a);var d=[];do d[c?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,c,d){a=B(a);a=a.cloneNode(c);if(!d){var e=function(g){if(g.nodeType==h.NODE_ELEMENT){g.removeAttribute("id",false);g.removeAttribute("_ke_expando",false);g=g.childNodes;
for(var o=0;o<g.length;o++)e(g[o])}};e(a)}return new C(a)},_4e_nextSourceNode:function(a,c,d,e){a=B(a);if(e&&!e.call){var g=e[0]||e;e=function(b){b=b[0]||b;return b!==g}}c=!c&&a.firstChild;var o=new C(a);if(!c){if(a.nodeType==h.NODE_ELEMENT&&e&&e(a,true)===false)return null;c=a.nextSibling}for(;!c&&(o=o.parent());){if(e&&e(o,true)===false)return null;c=o[0].nextSibling}if(!c)return null;c=y._4e_wrap(c);if(e&&e(c)===false)return null;if(d&&d!=c[0].nodeType)return c._4e_nextSourceNode(false,d,e);return c},
_4e_previousSourceNode:function(a,c,d,e){a=B(a);if(e&&!e.call){var g=e[0]||e;e=function(b){b=b[0]||b;return b!==g}}c=!c&&a.lastChild;var o=new C(a);if(!c){if(a.nodeType==h.NODE_ELEMENT&&e&&e(a,true)===false)return null;c=a.previousSibling}for(;!c&&(o=o.parent());){if(e&&e(o,true)===false)return null;c=o[0].previousSibling}if(!c)return null;c=y._4e_wrap(c);if(e&&e(c)===false)return null;if(d&&c[0].nodeType!=d)return c._4e_previousSourceNode(false,d,e);return c},_4e_contains:E.ie||E.webkit?function(a,
c){a=B(a);c=B(c);return c.nodeType!=h.NODE_ELEMENT?a.contains(c.parentNode):a!=c&&a.contains(c)}:function(a,c){a=B(a);c=B(c);return!!(a.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(a,c){if(a._4e_equals(c))return a;if(c[0].nodeType!=h.NODE_TEXT&&c._4e_contains(a))return c;a=a[0].nodeType==h.NODE_TEXT?a.parent():a;do if(a[0].nodeType!=h.NODE_TEXT&&a._4e_contains(c))return a;while(a=a.parent());return null},_4e_ascendant:function(a,c,d){a=B(a);if(!d)a=a.parentNode;if(c&&!H.isFunction(c)){var e=
c;c=function(g){return g._4e_name()==e}}for(;a&&a.nodeType!=9;){if(!c||c(new C(a))===true)return new C(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,c){a=B(a);a=a.attributes.getNamedItem(c);return!!(a&&a.specified)},_4e_hasAttributes:E.ie?function(a){a=B(a);for(var c=a.attributes,d=0;d<c.length;d++){var e=c[d];switch(e.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(e.specified)return true}}return false}:function(a){a=B(a);E.gecko&&
a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,c){var d=B(a),e=B(c);if(d.compareDocumentPosition)return d.compareDocumentPosition(e);if(d==e)return j.POSITION_IDENTICAL;if(d.nodeType==h.NODE_ELEMENT&&e.nodeType==h.NODE_ELEMENT){if(d.contains){if(d.contains(e))return j.POSITION_CONTAINS+j.POSITION_PRECEDING;if(e.contains(d))return j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING}if("sourceIndex"in d)return d.sourceIndex<
0||e.sourceIndex<0?j.POSITION_DISCONNECTED:d.sourceIndex<e.sourceIndex?j.POSITION_PRECEDING:j.POSITION_FOLLOWING}a=a._4e_address();c=c._4e_address();d=Math.min(a.length,c.length);for(e=0;e<=d-1;e++)if(a[e]!=c[e]){if(e<d)return a[e]<c[e]?j.POSITION_PRECEDING:j.POSITION_FOLLOWING;break}return a.length<c.length?j.POSITION_CONTAINS+j.POSITION_PRECEDING:j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING},_4e_address:function(a,c){a=B(a);var d=[],e=a.ownerDocument.documentElement;for(a=a;a&&a!=e;){var g=a.parentNode,
o=-1;if(g){for(var b=0;b<g.childNodes.length;b++){var f=g.childNodes[b];if(!(c&&f.nodeType==3&&f.previousSibling&&f.previousSibling.nodeType==3)){o++;if(f==a)break}}d.unshift(o)}a=g}return d},_4e_breakParent:function(a,c){var d=new x.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(c);c=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(c,a[0].nextSibling)},_4e_style:function(a,c,d){if(d!==undefined)return a.css(c,d);a=a[0]||a;return a.style[G(c)]},_4e_remove:function(a,
c){var d=B(a),e=d.parentNode;if(e){if(c)for(;c=d.firstChild;)e.insertBefore(d.removeChild(c),d);e.removeChild(d)}return a},_4e_trim:function(a){y._4e_ltrim(a);y._4e_rtrim(a)},_4e_ltrim:function(a){a=B(a);for(var c;c=a.firstChild;){if(c.nodeType==h.NODE_TEXT){var d=r.ltrim(c.nodeValue),e=c.nodeValue.length;if(d){if(d.length<e){(new C(c))._4e_splitText(e-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){a=B(a);for(var c;c=a.lastChild;){if(c.type==h.NODE_TEXT){var d=
r.rtrim(c.nodeValue),e=c.nodeValue.length;if(d){if(d.length<e){(new C(c))._4e_splitText(d.length);a.removeChild(a.lastChild)}}else{a.removeChild(c);continue}}break}if(!E.ie&&!E.opera)(c=a.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(a){a=B(a);for(var c=a.lastChild;c&&c.nodeType==h.NODE_TEXT&&!H.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==h.NODE_TEXT||y._4e_name(c)!=="br"){c=E.opera?a.ownerDocument.createTextNode(""):
a.ownerDocument.createElement("br");E.gecko&&c.setAttribute("type","_moz");a.appendChild(c)}},_4e_previous:function(a,c){a=B(a);var d;do d=(a=a.previousSibling)&&new C(a);while(d&&c&&!c(d));return d},_4e_last:function(a,c){a=y._4e_wrap(a);if((a=(a=a[0].lastChild)&&new C(a))&&c&&!c(a))a=a._4e_previous(c);return a},_4e_next:function(a,c){a=B(a);var d;do d=(a=a.nextSibling)&&new C(a);while(d&&c&&!c(d));return d},_4e_outerHtml:function(a){a=B(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");
var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(true));return c.innerHTML},_4e_setMarker:function(a,c,d,e){a=y._4e_wrap(a);var g=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",H.guid())._4e_getData("list_marker_id"),o=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[g]=a;o[d]=1;return a._4e_setData(d,e)},_4e_clearMarkers:function(a,c,d){a=m(a);var e=a._4e_getData("list_marker_names"),g=a._4e_getData("list_marker_id");
for(var o in e)a._4e_removeData(o);a._4e_removeData("list_marker_names");if(d){a._4e_removeData("list_marker_id");delete c[g]}},_4e_setData:function(a,c,d){var e=y._4e_getUniqueId(a);(v[e]||(v[e]={}))[c]=d;return a},_4e_getData:function(a,c){a=B(a);return(a=(a=a.getAttribute("_ke_expando"))&&v[a])&&a[c]},_4e_removeData:function(a,c){a=B(a);var d=a.getAttribute("_ke_expando");var e=(d=d&&v[d])&&d[c];typeof e!="undefined"&&d&&delete d[c];H.isEmptyObject(d)&&y._4e_clearData(a);return e||null},_4e_clearData:function(a){a=
B(a);var c=a.getAttribute("_ke_expando");c&&delete v[c];c&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=B(a);var c=a.getAttribute("_ke_expando");if(c)return c;c=H.guid();a.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(a,c,d){a=B(a);var e=a.attributes;d=d||{};for(var g=0;g<e.length;g++){var o=e[g],b=o.nodeName.toLowerCase(),f;if(!(b in d))if(b=="checked"&&(f=y.attr(a,b)))c.attr(b,f);else if(o.specified||E.ie&&o.nodeValue&&b=="value"){f=y.attr(a,b);if(f===null)f=
o.nodeValue;c.attr(b,f)}}if(a.style.cssText!=="")c[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=y._4e_name(a);var c=x.XHTML_DTD;return(a=!c.$nonEditable[a]&&(c[a]||c.span))&&a["#"]},_4e_scrollIntoView:function(a){a=m(a);var c=a[0].ownerDocument,d=y.scrollLeft(c),e=y.scrollTop(c),g=a.offset(),o=g.left;g=g.top;if(y.viewportHeight(c)+e<g||g<e||y.viewportWidth(c)+d<o||o<d)a.scrollIntoView(c)},_4e_getElementsByTagName:function(a,c,d){a=B(a);if(!E.ie&&d)c=d+":"+c;d=[];a=a.getElementsByTagName(c);
for(c=0;c<a.length;c++)d.push(new C(a[c]));return d}};H.DOM._4e_inject=function(a){H.mix(y,a);for(var c in a)a.hasOwnProperty(c)&&function(d){C.prototype[d]=function(){var e=[].slice.call(arguments,0);e.unshift(this);return a[d].apply(null,e)}}(c)};H.DOM._4e_inject(p)});
KISSY.Editor.add("elementpath",function(x){function G(v){var t=null,D=null,B=[];for(v=v;v&&v[0];){if(v[0].nodeType==C.NODE_ELEMENT){if(!this.lastElement)this.lastElement=v;var m=v._4e_name();if(r.ie&&v[0].scopeName!="HTML")m=v[0].scopeName.toLowerCase()+":"+m;if(!D){if(!t&&w[m])t=v;if(h[m])if(!t&&m=="div"&&!j(v))t=v;else D=v}B.push(v);if(m=="body")break}v=v.parent()}this.block=t;this.blockLimit=D;this.elements=B}var H=KISSY,y=H.DOM,E=x.XHTML_DTD,C=x.NODE,r=H.UA,w={address:1,blockquote:1,dl:1,h1:1,
h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},h={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1},j=function(v){v=v[0]||v;v=v.childNodes;for(var t=0,D=v.length;t<D;t++){var B=v[t];if(B.nodeType==C.NODE_ELEMENT&&E.$block[B.nodeName.toLowerCase()])return true}return false};G.prototype={compare:function(v){var t=this.elements;v=v&&v.elements;if(!v||t.length!=v.length)return false;for(var D=0;D<t.length;D++)if(!y._4e_equals(t[D],v[D]))return false;return true},contains:function(v){for(var t=
this.elements,D=0;D<t.length;D++)if(t[D]._4e_name()in v)return t[D];return null}};x.ElementPath=G});
KISSY.Editor.add("walker",function(x){function G(h,j){if(this._.end)return null;var v=this.range,t,D=this.guard,B=this.type,m=h?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;v.trim();if(v.collapsed){this.end();return null}}if(!h&&!this._.guardLTR){var p=v.endContainer,a=new w(p[0].childNodes[v.endOffset]);this._.guardLTR=function(g,o){return(g=r._4e_wrap(g))&&g[0]&&(!o||!r._4e_equals(p,g))&&(!a[0]||!g._4e_equals(a))&&(g[0].nodeType!=C.NODE_ELEMENT||!o||g._4e_name()!=
"body")}}if(h&&!this._.guardRTL){var c=v.startContainer,d=v.startOffset>0&&new w(c[0].childNodes[v.startOffset-1]);this._.guardRTL=function(g,o){return(g=r._4e_wrap(g))&&g[0]&&(!o||!g._4e_equals(c))&&(!d[0]||!g._4e_equals(d))&&(g[0].nodeType!=C.NODE_ELEMENT||!o||g._4e_name()!="body")}}var e=h?this._.guardRTL:this._.guardLTR;t=D?function(g,o){if(e(g,o)===false)return false;return D(g,o)}:e;if(this.current)h=this.current[m](false,B,t);else if(h){h=v.endContainer;if(v.endOffset>0){h=new w(h[0].childNodes[v.endOffset-
1]);if(t(h)===false)h=null}else h=t(h,true)===false?null:h._4e_previousSourceNode(true,B,t)}else{h=v.startContainer;if((h=new w(h[0].childNodes[v.startOffset]))&&h[0]){if(t(h)===false)h=null}else h=t(v.startContainer,true)===false?null:v.startContainer._4e_nextSourceNode(true,B,t)}for(;h&&h[0]&&!this._.end;){this.current=h;if(!this.evaluator||this.evaluator(h)!==false){if(!j)return h}else if(j&&this.evaluator)return false;h=h[m](false,B,t)}this.end();return this.current=null}function H(h){for(var j,
v=null;j=G.call(this,h);)v=j;return v}function y(h){this.range=h;this._={}}var E=KISSY,C=x.NODE,r=E.DOM,w=E.Node;E.augment(y,{end:function(){this._.end=1},next:function(){return G.call(this)},previous:function(){return G.call(this,true)},checkForward:function(){return G.call(this,false,true)!==false},checkBackward:function(){return G.call(this,true,true)!==false},lastForward:function(){return H.call(this)},lastBackward:function(){return H.call(this,true)},reset:function(){delete this.current;this._=
{}}});y.blockBoundary=function(h){return function(j){j=r._4e_wrap(j);return!(j&&j[0].nodeType==C.NODE_ELEMENT&&j._4e_isBlockBoundary(h))}};y.listItemBoundary=function(){return this.blockBoundary({br:1})};y.bookmark=function(h,j){function v(t){return t&&t[0]&&t._4e_name()=="span"&&t.attr("_ke_bookmark")}return function(t){var D,B;D=t&&t[0]&&t[0].nodeType==C.NODE_TEXT&&(B=t.parent())&&v(B);D=h?D:D||v(t);return j^D}};y.whitespaces=function(h){return function(j){j=(j=j[0]||j)&&j.nodeType==C.NODE_TEXT&&
!E.trim(j.nodeValue);return h^j}};y.invisible=function(h){var j=y.whitespaces();return function(v){v=j(v)||v[0].nodeType==C.NODE_ELEMENT&&!v[0].offsetHeight;return h^v}};x.Walker=y});
KISSY.Editor.add("range",function(x){function G(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function H(b){var f=b[0].nodeType!=h.NODE_TEXT&&b._4e_name()in p.$removeEmpty,i=!w.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return f||i||b}function y(b){return!g(b)&&!o(b)}function E(b){var f=false,i=t.bookmark(true);return function(l){if(i(l))return true;if(l[0].nodeType==h.NODE_TEXT){if(w.trim(l[0].nodeValue).length)return false}else if(l[0].nodeType==
h.NODE_ELEMENT)if(!e[l._4e_name()])if(!b&&!m.ie&&l._4e_name()=="br"&&!f)f=true;else return false;return true}}function C(b,f){function i(l){return l&&l.nodeName=="span"&&l.getAttribute("_ke_bookmark")}return function(l){var k,u;k=l&&!l.nodeName&&(u=l.parentNode)&&i(u);k=b?k:k||i(l);return f^k}}function r(b){return function(f){f=(f=f[0]||f)&&f.nodeType==h.NODE_TEXT&&!w.trim(f.nodeValue);return b^f}}x.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var w=KISSY,h=x.NODE,j=x.RANGE,v=x.POSITION,t=x.Walker,D=w.DOM,B=x.Utils.getByAddress,m=w.UA,p=x.XHTML_DTD,a=x.ElementPath,c=w.Node,d={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};G.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};w.augment(G,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&D._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,f=this.startOffset;if(b[0].nodeType!=h.NODE_ELEMENT)if(f)f>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;f=this.endOffset;if(b[0].nodeType!=h.NODE_ELEMENT)if(f)f>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,f=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,j.POSITION_BEFORE_START);f&&f._4e_name()=="span"&&
f.attr("_ke_bookmark")&&this.setEndAt(f,j.POSITION_AFTER_END)},setStart:function(b,f){if(b[0].nodeType==h.NODE_ELEMENT&&d[b._4e_name()]){b=b.parent();f=b._4e_index()}this.startContainer=b;this.startOffset=f;if(!this.endContainer){this.endContainer=b;this.endOffset=f}this.updateCollapsed()},setEnd:function(b,f){if(b[0].nodeType==h.NODE_ELEMENT&&d[b._4e_name()]){b=b.parent();f=b._4e_index()+1}this.endContainer=b;this.endOffset=f;if(!this.startContainer){this.startContainer=b;this.startOffset=f}this.updateCollapsed()},
setStartAt:function(b,f){switch(f){case j.POSITION_AFTER_START:this.setStart(b,0);break;case j.POSITION_BEFORE_END:b[0].nodeType==h.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setStartBefore(b);break;case j.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,f){switch(f){case j.POSITION_AFTER_START:this.setEnd(b,0);break;case j.POSITION_BEFORE_END:b[0].nodeType==h.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setEndBefore(b);break;case j.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,f){var i=this.startContainer,l=this.endContainer,k=this.startOffset,u=this.endOffset,F,O;this.optimizeBookmark();if(l[0].nodeType==h.NODE_TEXT)l=l._4e_splitText(u);else if(l[0].childNodes.length>0)if(u>=l[0].childNodes.length){l=new c(l[0].appendChild(this.document.createTextNode("")));
O=true}else l=new c(l[0].childNodes[u]);if(i[0].nodeType==h.NODE_TEXT){i._4e_splitText(k);if(D._4e_equals(i,l))l=new c(i[0].nextSibling)}else if(k)if(k>=i[0].childNodes.length){F=new c(this.document.createTextNode(""));i[0].appendChild(F[0]);i=F;F=true}else i=new c(i[0].childNodes[k].previousSibling);else{F=new c(this.document.createTextNode(""));D.insertBefore(F[0],i[0].firstChild);i=F;F=true}k=i._4e_parents();u=l._4e_parents();var I,J,M;for(I=0;I<k.length;I++){J=k[I];M=u[I];if(J[0]!==M[0])break}for(var P=
f,N,S,Y,Z=I;Z<k.length;Z++){N=k[Z];if(P&&N[0]!==i[0])S=P.appendChild(N._4e_clone()[0]);for(N=N[0].nextSibling;N;){if(u[Z]&&N==u[Z][0]||N==l[0])break;Y=N.nextSibling;if(b==2)P.appendChild(N.cloneNode(true));else{N.parentNode.removeChild(N);b==1&&P.appendChild(N)}N=Y}if(S)P=S}P=f;for(f=I;f<u.length;f++){N=u[f];if(b>0&&N[0]!==l[0])S=P.appendChild(N._4e_clone()[0]);if(!k[f]||N[0].parentNode!==k[f][0].parentNode)for(N=N[0].previousSibling;N;){if(k[f]&&N==k[f][0]||N===i[0])break;Y=N.previousSibling;if(b==
2)P.insertBefore(N.cloneNode(true),P.firstChild);else{N.parentNode.removeChild(N);b==1&&P.insertBefore(N,P.firstChild)}N=Y}if(S)P=S}if(b==2){M=this.startContainer[0];if(M.nodeType==h.NODE_TEXT&&M.nextSibling&&M.nextSibling.nodeType==h.NODE_TEXT){M.data+=M.nextSibling.data;M.parentNode.removeChild(M.nextSibling)}M=this.endContainer[0];if(M.nodeType==h.NODE_TEXT&&M.nextSibling&&M.nextSibling.nodeType==h.NODE_TEXT){M.data+=M.nextSibling.data;M.parentNode.removeChild(M.nextSibling)}}else{if(J&&M&&(i[0].parentNode!=
J[0].parentNode||l[0].parentNode!=M[0].parentNode)){b=M._4e_index();F&&M[0].parentNode==i[0].parentNode&&b--;this.setStart(M.parent(),b)}this.collapse(true)}F&&i._4e_remove();O&&l[0].parentNode&&l._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new G(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=h.NODE_ELEMENT||b.endContainer[0].nodeType!=h.NODE_ELEMENT)return null;var f=new x.Walker(b),i=C(true,undefined),l=r(true);b.evaluator=function(k){return l(k)&&i(k)};b=f.next();f.reset();f=f.previous();return b&&b._4e_equals(f)?b:null},shrink:function(b,f){if(!this.collapsed){b=b||j.SHRINK_TEXT;var i=this.clone(),
l=this.startContainer,k=this.endContainer,u=this.startOffset,F=this.endOffset,O=1,I=1;if(l&&l[0].nodeType==h.NODE_TEXT)if(u)if(u>=l[0].nodeValue.length)i.setStartAfter(l);else{i.setStartBefore(l);O=0}else i.setStartBefore(l);if(k&&k[0].nodeType==h.NODE_TEXT)if(F)if(F>=k[0].nodeValue.length)i.setEndAfter(k);else{i.setEndAfter(k);I=0}else i.setEndBefore(k);i=new t(i);i.evaluator=function(M){M=M[0]||M;return M.nodeType==(b==j.SHRINK_ELEMENT?h.NODE_ELEMENT:h.NODE_TEXT)};var J;i.guard=function(M,P){M=
M[0]||M;if(b==j.SHRINK_ELEMENT&&M.nodeType==h.NODE_TEXT)return false;if(P&&M==J)return false;if(!P&&M.nodeType==h.NODE_ELEMENT)J=M;return true};if(O)(l=i[b==j.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(l,f?j.POSITION_AFTER_START:j.POSITION_BEFORE_START);if(I){i.reset();(i=i[b==j.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(i,f?j.POSITION_BEFORE_END:j.POSITION_AFTER_END)}return!!(O||I)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||b[0].nodeType!=
h.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var f=this.startContainer,i=this.endContainer,l=this.startOffset,k=this.endOffset,u,F;if(!f||!i)return{start:0,end:0};if(b){if(f[0].nodeType==h.NODE_ELEMENT)if((u=new c(f[0].childNodes[l]))&&u[0]&&u[0].nodeType==h.NODE_TEXT&&l>0&&u[0].previousSibling.nodeType==h.NODE_TEXT){f=u;l=0}for(;f[0].nodeType==h.NODE_TEXT&&(F=f._4e_previous())&&F[0].nodeType==h.NODE_TEXT;){f=F;l+=F[0].nodeValue.length}if(!this.collapsed){if(i[0].nodeType==
h.NODE_ELEMENT)if((u=new c(i[0].childNodes[k]))&&u[0]&&u[0].nodeType==h.NODE_TEXT&&k>0&&u[0].previousSibling.nodeType==h.NODE_TEXT){i=u;k=0}for(;i[0].nodeType==h.NODE_TEXT&&(F=i._4e_previous())&&F[0].nodeType==h.NODE_TEXT;){i=F;k+=F[0].nodeValue.length}}}return{start:f._4e_address(b),end:this.collapsed?null:i._4e_address(b),startOffset:l,endOffset:k,normalized:b,is2:true}},createBookmark:function(b){var f,i,l,k;f=new c("<span></span>",null,this.document);f.attr("_ke_bookmark",1);f.css("display","none");
f.html("&nbsp;");if(b){l=w.guid("ke_bm_");f.attr("id",l+"S")}if(!this.collapsed){i=f._4e_clone();i.html("&nbsp;");b&&i.attr("id",l+"E");k=this.clone();k.collapse();k.insertNode(i)}k=this.clone();k.collapse(true);k.insertNode(f);if(i){this.setStartAfter(f);this.setEndBefore(i)}else this.moveToPosition(f,j.POSITION_AFTER_END);return{startNode:b?l+"S":f,endNode:b?l+"E":i,serializable:b}},moveToPosition:function(b,f){this.setStartAt(b,f);this.collapse(true)},trim:function(b,f){var i=this.startContainer,
l=this.startOffset,k=this.collapsed;if((!b||k)&&i[0]&&i[0].nodeType==h.NODE_TEXT){if(l)if(l>=i[0].nodeValue.length){l=i._4e_index()+1;i=i.parent()}else{b=i._4e_splitText(l);l=i._4e_index()+1;i=i.parent();if(D._4e_equals(this.startContainer,this.endContainer))this.setEnd(b,this.endOffset-this.startOffset);else if(D._4e_equals(i,this.endContainer))this.endOffset+=1}else{l=i._4e_index();i=i.parent()}this.setStart(i,l);if(k){this.collapse(true);return}}i=this.endContainer;l=this.endOffset;if(!(f||k)&&
i[0]&&i[0].nodeType==h.NODE_TEXT){if(l){l>=i.nodeValue.length||i._4e_splitText(l);l=i._4e_index()+1}else l=i._4e_index();i=i.parent();this.setEnd(i,l)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var f=this.startContainer,i=f[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);i?D.insertBefore(b[0]||b,i):f[0].appendChild(b[0]||b);D._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var f=
B(this.document,b.start,b.normalized),i=b.startOffset,l=b.end&&B(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(f,i);l?this.setEnd(l,b):this.collapse(true)}else{f=(i=b.serializable)?w.one("#"+b.startNode,this.document):b.startNode;b=i?w.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(f);f._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,f){var i=this.startContainer,l=this.endContainer;b=D._4e_equals(i,
l)?b&&i[0].nodeType==h.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(i[0].childNodes[this.startOffset]):i:i._4e_commonAncestor(l);return f&&b[0].nodeType==h.NODE_TEXT?b.parent():b},enlarge:function(b){switch(b){case j.ENLARGE_ELEMENT:if(this.collapsed)return;b=this.getCommonAncestor();var f=new c(this.document.body),i,l,k,u,F,O=false,I,J;I=this.startContainer;J=this.startOffset;if(I[0].nodeType==h.NODE_TEXT){if(J){I=!w.trim(I[0].nodeValue.substring(0,J)).length&&I;O=!!I}if(I)if(!(u=I[0].previousSibling))k=
I.parent()}else{if(J)u=I[0].childNodes[J-1]||I[0].lastChild;u||(k=I)}for(;k||u;){if(k&&!u){if(!F&&D._4e_equals(k,b))F=true;if(!f._4e_contains(k))break;if(!O||k.css("display")!="inline"){O=false;if(F)i=k;else this.setStartBefore(k)}u=k[0].previousSibling}for(;u;){I=false;if(u.nodeType==h.NODE_TEXT){J=u.nodeValue;if(/[^\s\ufeff]/.test(J))u=null;I=/[\s\ufeff]$/.test(J)}else if(u.offsetWidth>0&&!u.getAttribute("_ke_bookmark"))if(O&&p.$removeEmpty[u.nodeName.toLowerCase()]){J=D.text(u);if(/[^\s\ufeff]/.test(J))u=
null;else for(var M=u.all||u.getElementsByTagName("*"),P=0,N;N=M[P++];)if(!p.$removeEmpty[N.nodeName.toLowerCase()]){u=null;break}if(u)I=!!J.length}else u=null;if(I)if(O)if(F)i=k;else k&&this.setStartBefore(k);else O=true;if(u){I=u.previousSibling;if(!k&&!I){k=new c(u);u=null;break}u=I}else k=null}if(k)k=k.parent()}I=this.endContainer;J=this.endOffset;k=u=null;F=O=false;if(I[0].nodeType==h.NODE_TEXT){I=!w.trim(I[0].nodeValue.substring(J)).length&&I;O=!(I&&I[0].nodeValue.length);if(I)if(!(u=I[0].nextSibling))k=
I.parent()}else(u=I[0].childNodes[J])||(k=I);for(;k||u;){if(k&&!u){if(!F&&D._4e_equals(k,b))F=true;if(!f._4e_contains(k))break;if(!O||k.css("display")!="inline"){O=false;if(F)l=k;else k&&this.setEndAfter(k)}u=k[0].nextSibling}for(;u;){I=false;if(u.nodeType==h.NODE_TEXT){J=u.nodeValue;if(/[^\s\ufeff]/.test(J))u=null;I=/^[\s\ufeff]/.test(J)}else if(u.offsetWidth>0&&!u.getAttribute("_ke_bookmark"))if(O&&p.$removeEmpty[u.nodeName.toLowerCase()]){J=D.text(u);if(/[^\s\ufeff]/.test(J))u=null;else{M=u.all||
u.getElementsByTagName("*");for(P=0;N=M[P++];)if(!p.$removeEmpty[N.nodeName.toLowerCase()]){u=null;break}}if(u)I=!!J.length}else u=null;if(I)if(O)if(F)l=k;else this.setEndAfter(k);if(u){I=u.nextSibling;if(!k&&!I){k=new c(u);u=null;break}u=I}else k=null}if(k)k=k.parent()}if(i&&l){b=i._4e_contains(l)?l:i;this.setStartBefore(b);this.setEndAfter(b)}break;case j.ENLARGE_BLOCK_CONTENTS:case j.ENLARGE_LIST_ITEM_CONTENTS:k=new G(this.document);f=new c(this.document.body);k.setStartAt(f,j.POSITION_AFTER_START);
k.setEnd(this.startContainer,this.startOffset);k=new t(k);var S,Y,Z=t.blockBoundary(b==j.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),ca=function($){var n=Z($);n||(S=$);return n};i=function($){var n=ca($);if(!n&&$[0]&&$._4e_name()=="br")Y=$;return n};k.guard=ca;k=k.lastBackward();S=S||f;this.setStartAt(S,S._4e_name()!="br"&&(!k&&this.checkStartOfBlock()||k&&S._4e_contains(k))?j.POSITION_AFTER_START:j.POSITION_AFTER_END);k=this.clone();k.collapse();k.setEndAt(f,j.POSITION_BEFORE_END);k=new t(k);k.guard=
b==j.ENLARGE_LIST_ITEM_CONTENTS?i:ca;S=null;k=k.lastForward();S=S||f;this.setEndAt(S,!k&&this.checkEndOfBlock()||k&&S._4e_contains(k)?j.POSITION_BEFORE_END:j.POSITION_BEFORE_START);Y&&this.setEndAfter(Y)}},checkStartOfBlock:function(){var b=this.startContainer,f=this.startOffset;if(f&&b[0].nodeType==h.NODE_TEXT)if(w.trim(b[0].nodeValue.substring(0,f)).length)return false;this.trim();b=new a(this.startContainer);f=this.clone();f.collapse(true);f.setStartAt(b.block||b.blockLimit,j.POSITION_AFTER_START);
b=new t(f);b.evaluator=E(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,f=this.endOffset;if(b[0].nodeType==h.NODE_TEXT)if(w.trim(b[0].nodeValue.substring(f)).length)return false;this.trim();b=new a(this.endContainer);f=this.clone();f.collapse(false);f.setEndAt(b.block||b.blockLimit,j.POSITION_BEFORE_END);b=new t(f);b.evaluator=E(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,f){var i=this.clone();i[f==j.START?"setStartAt":"setEndAt"](b,f==j.START?j.POSITION_AFTER_START:j.POSITION_BEFORE_END);b=new t(i);b.evaluator=H;return b[f==j.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,f=this.endContainer,i=this.startOffset,l=this.endOffset,k;if(b[0].nodeType==h.NODE_ELEMENT){k=b[0].childNodes.length;if(k>
i)b=new c(b[0].childNodes[i]);else if(k<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new c(b);b=b._4e_nextSourceNode()||b}}if(f[0].nodeType==h.NODE_ELEMENT){k=f[0].childNodes.length;if(k>l)f=(new c(f[0].childNodes[l]))._4e_previousSourceNode(true);else if(k<1)f=f._4e_previousSourceNode();else{for(f=f[0];f.lastChild;)f=f.lastChild;f=new c(f)}}if(b._4e_position(f)&v.POSITION_FOLLOWING)b=f;return{startNode:b,endNode:f}},fixBlock:function(b,f){var i=this.createBookmark();
f=new c(this.document.createElement(f));this.collapse(b);this.enlarge(j.ENLARGE_BLOCK_CONTENTS);f[0].appendChild(this.extractContents());f._4e_trim();m.ie||f._4e_appendBogus();this.insertNode(f);this.moveToBookmark(i);return f},splitBlock:function(b){var f=new a(this.startContainer),i=new a(this.endContainer),l=f.block,k=i.block,u=null;if(f.blockLimit[0]!==i.blockLimit[0])return null;if(b!="br"){if(!l){l=this.fixBlock(true,b);k=(new a(this.endContainer)).block}k||(k=this.fixBlock(false,b))}b=l&&this.checkStartOfBlock();
f=k&&this.checkEndOfBlock();this.deleteContents();if(l&&D._4e_equals(l,k))if(f){u=new a(this.startContainer);this.moveToPosition(k,j.POSITION_AFTER_END);k=null}else if(b){u=new a(this.startContainer);this.moveToPosition(l,j.POSITION_BEFORE_START);l=null}else{k=this.splitElement(l);!m.ie&&!w.inArray(l._4e_name(),["ul","ol"])&&l._4e_appendBogus()}return{previousBlock:l,nextBlock:k,wasStartOfBlock:b,wasEndOfBlock:f,elementPath:u}},splitElement:function(b){if(!this.collapsed)return null;this.setEndAt(b,
j.POSITION_BEFORE_END);var f=this.extractContents(),i=b._4e_clone(false);i[0].appendChild(f);i.insertAfter(b);this.moveToPosition(b,j.POSITION_AFTER_END);return i},moveToElementEditablePosition:function(b,f){var i,l=x.XHTML_DTD;if(l.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==h.NODE_ELEMENT;){if(i=b._4e_isEditable())this.moveToPosition(b,f?j.POSITION_BEFORE_END:j.POSITION_AFTER_START);else if(l.$inline[b._4e_name()]){this.moveToPosition(b,f?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);
return true}if((b=l.$empty[b._4e_name()]?b[f?"_4e_previous":"_4e_next"](y):b[f?"_4e_last":"_4e_first"](y))&&b[0].nodeType==h.NODE_TEXT){this.moveToPosition(b,f?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);return true}}return i},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==h.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var e={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},g=new t.whitespaces,o=new t.bookmark;x.Range=G});
KISSY.Editor.add("domiterator",function(x){function G(B){if(!(arguments.length<1)){this.range=B;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var H=KISSY,y=H.UA,E=x.Walker,C=x.Range,r=x.RANGE,w=x.NODE,h=x.ElementPath,j=H.Node,v=H.DOM,t=/^[\r\n\t ]*$/,D=E.bookmark();H.augment(G,{getNextParagraph:function(B){var m,p,a,c,d;if(!this._.lastNode){p=this.range.clone();p.enlarge(this.forceBrBreak||!this.enlargeBr?r.ENLARGE_LIST_ITEM_CONTENTS:r.ENLARGE_BLOCK_CONTENTS);
var e=new E(p),g=E.bookmark(true,true);e.evaluator=g;this._.nextNode=e.next();e=new E(p);e.evaluator=g;e=e.previous();this._.lastNode=e._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==w.NODE_TEXT&&!H.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){g=new C(p.document);g.moveToPosition(this._.lastNode,r.POSITION_AFTER_END);if(g.checkEndOfBlock()){g=new h(g.endContainer);this._.lastNode=(g.block||g.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new j(p.document.createTextNode(""));v.insertAfter(this._.lastNode[0],e[0])}p=null}g=this._.nextNode;e=this._.lastNode;for(this._.nextNode=null;g;){var o=false,b=g[0].nodeType!=w.NODE_ELEMENT,f=false;if(b){if(g[0].nodeType==w.NODE_TEXT)if(t.test(g[0].nodeValue))b=false}else{var i=g._4e_name();if(g._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(i=="br")b=true;else if(!p&&!g[0].childNodes.length&&i!="hr"){m=g;a=g._4e_equals(e);break}if(p){p.setEndAt(g,r.POSITION_BEFORE_START);
if(i!="br")this._.nextNode=g}o=true}else{if(g[0].firstChild){if(!p){p=new C(this.range.document);p.setStartAt(g,r.POSITION_BEFORE_START)}g=new j(g[0].firstChild);continue}b=true}}if(b&&!p){p=new C(this.range.document);p.setStartAt(g,r.POSITION_BEFORE_START)}a=(!o||b)&&g._4e_equals(e);if(p&&!o)for(;!g[0].nextSibling&&!a;){i=g.parent();if(i._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){o=true;a||i._4e_equals(e);break}g=i;b=true;a=g._4e_equals(e);f=true}b&&p.setEndAt(g,r.POSITION_AFTER_END);g=g._4e_nextSourceNode(f,
null,e);a=!g;if((o||a)&&p){b=p.getBoundaryNodes();o=new h(p.startContainer);if(b.startNode.parent()._4e_equals(o.blockLimit)&&D(b.startNode)&&D(b.endNode)){p=null;this._.nextNode=null}else break}if(a)break}if(!m){if(!p){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}o=new h(p.startContainer);g=o.blockLimit;b={div:1,th:1,td:1};m=o.block;if((!m||!m[0])&&!this.enforceRealBlocks&&b[g._4e_name()]&&p.checkStartOfBlock()&&p.checkEndOfBlock())m=g;else if(!m||this.enforceRealBlocks&&
m._4e_name()=="li"){m=new j(this.range.document.createElement(B||"p"));m[0].appendChild(p.extractContents());m._4e_trim();p.insertNode(m);c=d=true}else if(m._4e_name()!="li"){if(!p.checkStartOfBlock()||!p.checkEndOfBlock()){m=m._4e_clone(false);m[0].appendChild(p.extractContents());m._4e_trim();d=p.splitBlock();c=!d.wasStartOfBlock;d=!d.wasEndOfBlock;p.insertNode(m)}}else if(!a)this._.nextNode=m._4e_equals(e)?null:p.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,e)}if(c){p=new j(m[0].previousSibling);
if(p[0]&&p[0].nodeType==w.NODE_ELEMENT)if(p._4e_name()=="br")p._4e_remove();else p[0].lastChild&&p[0].lastChild.nodeName.toLowerCase()=="br"&&v._4e_remove(p[0].lastChild)}if(d){p=E.bookmark(false,true);c=new j(m[0].lastChild);if(c[0]&&c[0].nodeType==w.NODE_ELEMENT&&c._4e_name()=="br")if(y.ie||c._4e_previous(p)||c._4e_next(p))c._4e_remove()}if(!this._.nextNode)this._.nextNode=a||m._4e_equals(e)?null:m._4e_nextSourceNode(true,null,e);return m}});C.prototype.createIterator=function(){return new G(this)}});
KISSY.Editor.add("selection",function(x){function G(d){this.document=d;this._={cache:{}};if(C.ie){var e=this.getNative().createRange();if(!e||e.item&&e.item(0).ownerDocument!=d||e.parentElement&&e.parentElement().ownerDocument!=d)this.isInvalid=true}}function H(d){d=new G(d);return!d||d.isInvalid?null:d}function y(d){var e=d.document,g=new h(e.body),o=new h(e.documentElement);if(C.ie){if(C.ie<8||document.documentMode==7)o.on("click",function(k){r._4e_name(k.target)==="html"&&d.getSelection().getRanges()[0].select()});
var b,f;g.on("focusin",function(k){if(k.target.nodeName.toUpperCase()=="BODY")if(b){try{b.select()}catch(u){}b=null}});g.on("focus",function(){f=true;l()});g.on("beforedeactivate",function(k){k.relatedTarget||(f=false)});C.ie<8&&w.on(r._4e_getWin(e),"blur",function(){e.selection.empty()});g.on("mousedown",i);g.on("mouseup",function(){f=true;setTimeout(function(){l(true)},0)});g.on("keydown",i);g.on("keyup",function(){f=true;l()});w.on(e,"selectionchange",l);var i=function(){f=false},l=function(k){if(f){var u=
d.document,F=d.getSelection(),O=F&&F.getType(),I=F&&F.getNative();if(k&&I&&O==j.SELECTION_NONE)if(!u.queryCommandEnabled("InsertImage")){setTimeout(function(){l(true)},50);return}var J;if(!(I&&O==j.SELECTION_TEXT&&(J=r._4e_name(I.createRange().parentElement()))&&J in{input:1,textarea:1})){b=I&&F.getRanges()[0];d._monitor()}}}}else{w.on(e,"mouseup",d._monitor,d);w.on(e,"keyup",d._monitor,d)}}x.SELECTION={};var E=KISSY,C=E.UA,r=E.DOM,w=E.Event,h=E.Node,j=x.SELECTION,v=x.RANGE,t=x.NODE,D=x.Walker,B=
x.Range;j.SELECTION_NONE=1;j.SELECTION_TEXT=2;j.SELECTION_ELEMENT=3;var m={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};E.augment(G,{getNative:C.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=r._4e_getWin(this.document).getSelection())},getType:C.ie?function(){var d=this._.cache;if(d.type)return d.type;
var e=j.SELECTION_NONE;try{var g=this.getNative(),o=g.type;if(o=="Text")e=j.SELECTION_TEXT;if(o=="Control")e=j.SELECTION_ELEMENT;if(g.createRange().parentElement)e=j.SELECTION_TEXT}catch(b){}return d.type=e}:function(){var d=this._.cache;if(d.type)return d.type;var e=j.SELECTION_TEXT,g=this.getNative();if(g){if(g.rangeCount==1){g=g.getRangeAt(0);var o=g.startContainer;if(o==g.endContainer&&o.nodeType==t.NODE_ELEMENT&&g.endOffset-g.startOffset===1&&m[o.childNodes[g.startOffset].nodeName.toLowerCase()])e=
j.SELECTION_ELEMENT}}else e=j.SELECTION_NONE;return d.type=e},getRanges:C.ie?function(){var d=function(e,g){e=e.duplicate();e.collapse(g);g=e.parentElement();for(var o=g.childNodes,b,f=0;f<o.length;f++){var i=o[f];if(i.nodeType==t.NODE_ELEMENT){b=e.duplicate();b.moveToElementText(i);i=b.compareEndPoints("StartToStart",e);var l=b.compareEndPoints("EndToStart",e);b.collapse();if(i>0)break;else if(!i||l==1&&i==-1)return{container:g,offset:f};else if(!l)return{container:g,offset:f+1};b=null}}if(!b){b=
e.duplicate();b.moveToElementText(g);b.collapse(false)}b.setEndPoint("StartToStart",e);e=b.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;e>0;)e-=o[--f].nodeValue.length}catch(k){e=0}return e===0?{container:g,offset:f}:{container:o[f],offset:-e}};return function(){var e=this._.cache;if(e.ranges)return e.ranges;var g=this.getNative(),o=g&&g.createRange(),b=this.getType();if(!g)return[];if(b==j.SELECTION_TEXT){g=new B(this.document);b=d(o,true);g.setStart(new h(b.container),b.offset);b=d(o);g.setEnd(new h(b.container),
b.offset);return e.ranges=[g]}else if(b==j.SELECTION_ELEMENT){e=this._.cache.ranges=[];for(b=0;b<o.length;b++){var f=o.item(b),i=f.parentNode,l=0;for(g=new B(this.document);l<i.childNodes.length&&i.childNodes[l]!=f;l++);g.setStart(new h(i),l);g.setEnd(new h(i),l+1);e.push(g)}return e}return e.ranges=[]}}():function(){var d=this._.cache;if(d.ranges)return d.ranges;var e=[],g=this.getNative();if(!g)return[];for(var o=0;o<g.rangeCount;o++){var b=g.getRangeAt(o),f=new B(this.document);f.setStart(new h(b.startContainer),
b.startOffset);f.setEnd(new h(b.endContainer),b.endOffset);e.push(f)}return d.ranges=e},getStartElement:function(){var d=this._.cache;if(d.startElement!==undefined)return d.startElement;var e,g=this.getNative();switch(this.getType()){case j.SELECTION_ELEMENT:return this.getSelectedElement();case j.SELECTION_TEXT:var o=this.getRanges()[0];if(o)if(!o.collapsed){for(o.optimize();;){e=o.startContainer;if(o.startOffset==(e[0].nodeType===t.NODE_ELEMENT?e[0].childNodes.length:e[0].nodeValue.length)&&!e._4e_isBlockBoundary())o.setStartAfter(e);
else break}e=o.startContainer;if(e[0].nodeType!=t.NODE_ELEMENT)return e.parent();e=new h(e[0].childNodes[o.startOffset]);if(!e[0]||e[0].nodeType!=t.NODE_ELEMENT)return o.startContainer;for(o=e[0].firstChild;o&&o.nodeType==t.NODE_ELEMENT;){e=new h(o);o=o.firstChild}return e}if(C.ie){o=g.createRange();o.collapse(true);e=o.parentElement()}else if((e=g.anchorNode)&&e.nodeType!=t.NODE_ELEMENT)e=e.parentNode}return d.startElement=e?r._4e_wrap(e):null},getSelectedElement:function(){var d=this._.cache;if(d.selectedElement!==
undefined)return d.selectedElement;var e=this,g;if(C.ie){g=e.getNative().createRange();g=g.item&&g.item(0)}g||(g=function(){for(var o=e.getRanges()[0],b,f,i=2;i&&!((b=o.getEnclosedNode())&&b[0].nodeType==t.NODE_ELEMENT&&m[b._4e_name()]&&(f=b));i--)o.shrink(v.SHRINK_ELEMENT);return f&&f[0]}());return d.selectedElement=r._4e_wrap(g)},reset:function(){this._.cache={}},selectElement:function(d){var e;if(C.ie)try{e=this.document.body.createControlRange();e.addElement(d[0]);e.select()}catch(g){e=this.document.body.createTextRange();
e.moveToElementText(d[0]);e.select()}finally{}else{e=this.document.createRange();e.selectNode(d[0]);d=this.getNative();d.removeAllRanges();d.addRange(e)}this.reset()},selectRanges:function(d){if(C.ie)d[0]&&d[0].select();else{var e=this.getNative();if(!e)return;e.removeAllRanges();for(var g=0;g<d.length;g++){var o=d[g],b=this.document.createRange(),f=o.startContainer;o.collapsed&&C.gecko&&C.gecko<1.09&&f[0].nodeType==t.NODE_ELEMENT&&!f[0].childNodes.length&&f[0].appendChild(this.document.createTextNode(""));
b.setStart(f[0],o.startOffset);b.setEnd(o.endContainer[0],o.endOffset);e.addRange(b)}}this.reset()},createBookmarks2:function(d){for(var e=[],g=this.getRanges(),o=0;o<g.length;o++)e.push(g[o].createBookmark2(d));return e},createBookmarks:function(d){for(var e=[],g=this.getRanges(),o=g.length,b=this.document,f,i=0;i<o;i++){e.push(f=g[i].createBookmark(d,true));var l=(d=f.serializable)?E.one("#"+f.startNode,b):f.startNode;f=d?E.one("#"+f.endNode,b):f.endNode;for(var k=i+1;k<o;k++){var u=g[k],F=u.startContainer,
O=u.endContainer;r._4e_equals(F,l.parent())&&u.startOffset++;r._4e_equals(F,f.parent())&&u.startOffset++;r._4e_equals(O,l.parent())&&u.endOffset++;r._4e_equals(O,f.parent())&&u.endOffset++}}return e},selectBookmarks:function(d){for(var e=[],g=0;g<d.length;g++){var o=new B(this.document);o.moveToBookmark(d[g]);e.push(o)}this.selectRanges(e);return this},getCommonAncestor:function(){var d=this.getRanges();return d[0].startContainer._4e_commonAncestor(d[d.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
x.Selection=G;var p={table:1,tbody:1,tr:1},a=D.whitespaces(true),c=/\ufeff|\u00a0/;B.prototype.select=C.ie?function(d){var e=this.collapsed,g,o;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var b=this.startContainer[0].childNodes[this.startOffset];if(b.nodeType==t.NODE_ELEMENT){(new G(this.document)).selectElement(new h(b));return}}if(this.startContainer[0].nodeType==t.NODE_ELEMENT&&this.startContainer._4e_name()in p||this.endContainer[0].nodeType==t.NODE_ELEMENT&&
this.endContainer._4e_name()in p)this.shrink(t.NODE_ELEMENT,true);var f=this.createBookmark();b=f.startNode;var i;if(!e)i=f.endNode;f=this.document.body.createTextRange();f.moveToElementText(b[0]);f.moveStart("character",1);if(i){d=this.document.body.createTextRange();d.moveToElementText(i[0]);f.setEndPoint("EndToEnd",d);f.moveEnd("character",-1)}else{for(g=b[0].nextSibling;g&&!a(g);)g=g.nextSibling;g=!(g&&g.nodeValue&&g.nodeValue.match(c))&&(d||!b[0].previousSibling||b[0].previousSibling&&r._4e_name(b[0].previousSibling)==
"br");o=this.document.createElement("span");o.innerHTML="&#65279;";o=new h(o);r.insertBefore(o[0],b[0]);g&&r.insertBefore(this.document.createTextNode("\ufeff"),b[0])}this.setStartBefore(b);b._4e_remove();if(e){if(g){f.moveStart("character",-1);f.select();this.document.selection.clear()}else f.select();if(o){this.moveToPosition(o,v.POSITION_BEFORE_START);o._4e_remove()}}else{this.setEndBefore(i);i._4e_remove();f.select()}}:function(){var d=this.startContainer;this.collapsed&&d[0].nodeType==t.NODE_ELEMENT&&
!d[0].childNodes.length&&d[0].appendChild(this.document.createTextNode(""));var e=this.document.createRange();e.setStart(d[0],this.startOffset);try{e.setEnd(this.endContainer[0],this.endOffset)}catch(g){if(g.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);e.setEnd(this.endContainer[0],this.endOffset)}else throw g;}d=H(this.document).getNative();d.removeAllRanges();d.addRange(e)};x.on("instanceCreated",function(d){y(d.editor)})});
KISSY.Editor.add("styles",function(x){function G(n,q){for(var s in n)n[s]=n[s].replace($,function(A,z){return q[z]})}function H(n,q){if(q){n=l.clone(n);G(n.attributes,q);G(n.styles,q)}q=this.element=(n.element||"*").toLowerCase();this.type=q=="#"||Y[q]?u.STYLE_BLOCK:Z[q]?u.STYLE_OBJECT:u.STYLE_INLINE;this._={definition:n}}function y(n,q){q=q?this.removeFromRange:this.applyToRange;n.body.focus();n=new O(n);for(var s=n.getRanges(),A=0;A<s.length;A++)q.call(this,s[A]);n.selectRanges(s)}function E(n,
q){var s=n.element;if(s=="*")s="span";q=new P(q.createElement(s));return C(q,n)}function C(n,q){var s=q._.definition;q=s.attributes;s=H.getStyleText(s);if(q)for(var A in q)n.attr(A,q[A]);if(s)n[0].style.cssText=s;return n}function r(n){var q=n.createBookmark(true),s=n.createIterator();s.enforceRealBlocks=true;s.enlargeBr=true;for(var A,z=n.document;A=s.getNextParagraph();){var K=E(this,z);v(A,K)}n.moveToBookmark(q)}function w(n,q,s){var A="",z="";n=n.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,
function(K,L,Q){L&&(A=L);Q&&(z=Q);return""});return A+n.replace(q,s)+z}function h(n,q){var s=n.html();s=w(s,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");s=s.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");s=s.replace(/([ \t\n\r]+|&nbsp;)/g," ");s=s.replace(/<br\b[^>]*>/gi,"\n");if(N.ie){n=n[0].ownerDocument.createElement("div");n.appendChild(q[0]);q[0].outerHTML="<pre>"+s+"</pre>";q=new P(n.firstChild);q._4e_remove()}else q.html(s);return q}function j(n){var q=[];w(n._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(s,A,z){return A+"</pre>"+z+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(s,A){q.push(A)});return q}function v(n,q){var s=q._4e_name=="pre",A=n._4e_name=="pre",z=!s&&A;if(s&&!A)q=h(n,q);else if(z)q=D(j(n),q);else n._4e_moveChildren(q);n[0].parentNode.replaceChild(q[0],n[0]);s&&t(q)}function t(n){var q;if((q=n._4e_previousSourceNode(true,I.NODE_ELEMENT))&&q._4e_name()=="pre"){var s=w(q.html(),/\n$/,"")+"\n\n"+w(n.html(),/^\n/,"");if(N.ie)n[0].outerHTML="<pre>"+s+"</pre>";else n.html(s);
q._4e_remove()}}function D(n,q){for(var s=q[0].ownerDocument.createDocumentFragment(),A=0;A<n.length;A++){var z=n[A];z=z.replace(/(\r\n|\r)/g,"\n");z=w(z,/^[ \t]*\n/,"");z=w(z,/\n$/,"");z=w(z,/^[ \t]+|[ \t]+$/g,function(L,Q){return L.length==1?"&nbsp;":Q?" "+(new Array(L.length)).join("&nbsp;"):(new Array(L.length)).join("&nbsp;")+" "});z=z.replace(/\n/g,"<br>");z=z.replace(/[ \t]{2,}/g,function(L){return(new Array(L.length)).join("&nbsp;")+" "});var K=q._4e_clone();K.html(z);s.appendChild(K[0])}return s}
function B(n){var q=n.document;if(n.collapsed){q=E(this,q);n.insertNode(q);n.moveToPosition(q,F.POSITION_BEFORE_END)}else{var s=this.element,A=this._.definition,z,K=x.XHTML_DTD[s]||(z=true,x.XHTML_DTD.span),L=n.createBookmark();n.enlarge(F.ENLARGE_ELEMENT);n.trim();var Q=n.createBookmark(),da=Q.startNode;Q=Q.endNode;for(var T=da,V;T&&T[0];){var R=false;if(k._4e_equals(T,Q)){T=null;R=true}else{var U=T[0].nodeType,aa=U==I.NODE_ELEMENT?T._4e_name():null;if(aa&&T.attr("_ke_bookmark")){T=T._4e_nextSourceNode(true);
continue}if(!aa||K[aa]&&(T._4e_position(Q)|J.POSITION_PRECEDING|J.POSITION_IDENTICAL|J.POSITION_IS_CONTAINED)==J.POSITION_PRECEDING+J.POSITION_IDENTICAL+J.POSITION_IS_CONTAINED&&(!A.childRule||A.childRule(T))){var ba=T.parent();if(ba&&ba[0]&&((x.XHTML_DTD[ba._4e_name()]||x.XHTML_DTD.span)[s]||z)&&(!A.parentRule||A.parentRule(ba))){if(!V&&(!aa||!x.XHTML_DTD.$removeEmpty[aa]||(T._4e_position(Q)|J.POSITION_PRECEDING|J.POSITION_IDENTICAL|J.POSITION_IS_CONTAINED)==J.POSITION_PRECEDING+J.POSITION_IDENTICAL+
J.POSITION_IS_CONTAINED)){V=new M(q);V.setStartBefore(T)}if(U==I.NODE_TEXT||U==I.NODE_ELEMENT&&!T[0].childNodes.length){U=T;for(var W;!U[0].nextSibling&&(W=U.parent(),K[W._4e_name()])&&(W._4e_position(da)|J.POSITION_FOLLOWING|J.POSITION_IDENTICAL|J.POSITION_IS_CONTAINED)==J.POSITION_FOLLOWING+J.POSITION_IDENTICAL+J.POSITION_IS_CONTAINED&&(!A.childRule||A.childRule(W));)U=W;V.setEndAfter(U);U[0].nextSibling||(R=true)}}else R=true}else R=true;T=T._4e_nextSourceNode()}if(R&&V&&!V.collapsed){R=E(this,
q);for(U=V.getCommonAncestor();R&&U&&R[0]&&U[0];){if(U._4e_name()==s){for(var X in A.attributes)R.attr(X)==U.attr(X)&&R[0].removeAttribute(X);for(var ea in A.styles)R._4e_style(ea)==U._4e_style(ea)&&R._4e_style(ea,"");if(!R._4e_hasAttributes()){R=null;break}}U=U.parent()}if(R){R[0].appendChild(V.extractContents());b(this,R);V.insertNode(R);R._4e_mergeSiblings();N.ie||R[0].normalize()}V=null}}da._4e_remove();Q._4e_remove();n.moveToBookmark(L);n.shrink(F.SHRINK_TEXT)}}function m(n){n.enlarge(F.ENLARGE_ELEMENT);
var q=n.createBookmark(),s=q.startNode;if(n.collapsed){for(var A=new S(s.parent()),z,K=0,L;K<A.elements.length&&(L=A.elements[K]);K++){if(L==A.block||L==A.blockLimit)break;if(this.checkElementRemovable(L)){var Q=n.checkBoundaryOfElement(L,F.END),da=!Q&&n.checkBoundaryOfElement(L,F.START);if(da||Q){z=L;z.match=da?"start":"end"}else{L._4e_mergeSiblings();L._4e_name()==this.element?g(this,L):f(L,e(this)[L._4e_name()])}}}if(z&&z[0]){L=s;for(K=0;;K++){Q=A.elements[K];if(k._4e_equals(Q,z))break;else if(Q.match)continue;
else Q=Q._4e_clone();Q[0].appendChild(L[0]);L=Q}k[z.match=="start"?"insertBefore":"insertAfter"](L[0],z[0])}}else{var T=q.endNode,V=this;A=function(){for(var R=new S(s.parent()),U=new S(T.parent()),aa=null,ba=null,W=0;W<R.elements.length;W++){var X=R.elements[W];if(X==R.block||X==R.blockLimit)break;if(V.checkElementRemovable(X))aa=X}for(W=0;W<U.elements.length;W++){X=U.elements[W];if(X==U.block||X==U.blockLimit)break;if(V.checkElementRemovable(X))ba=X}ba&&T._4e_breakParent(ba);aa&&s._4e_breakParent(aa)};
A();for(z=new P(s[0].nextSibling);z[0]!==T[0];){K=z._4e_nextSourceNode();if(z[0]&&z[0].nodeType==I.NODE_ELEMENT&&this.checkElementRemovable(z)){z._4e_name()==this.element?g(this,z):f(z,e(this)[z._4e_name()]);if(K[0].nodeType==I.NODE_ELEMENT&&K._4e_contains(s)){A();K=new P(s[0].nextSibling)}}z=K}}n.moveToBookmark(q)}function p(n){var q={};n.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(s,A,z){q[A]=z});return q}function a(n,q){typeof n=="string"&&(n=p(n));typeof q==
"string"&&(q=p(q));for(var s in n)if(!(s in q&&(q[s]==n[s]||n[s]=="inherit"||q[s]=="inherit")))return false;return true}function c(n,q){if(q!==false){q=document.createElement("span");q.style.cssText=n;n=q.style.cssText||""}else n=n;return n.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function d(n){var q=n._AC;if(q)return q;q={};var s=0,A=n.attributes;if(A)for(var z in A){s++;q[z]=A[z]}if(A=H.getStyleText(n)){q.style||s++;q.style=A}q._length=s;return n._AC=
q}function e(n){if(n._.overrides)return n._.overrides;var q=n._.overrides={},s=n._.definition.overrides;if(s){l.isArray(s)||(s=[s]);for(var A=0;A<s.length;A++){var z=s[A],K,L;if(typeof z=="string")K=z.toLowerCase();else{K=z.element?z.element.toLowerCase():n.element;L=z.attributes}z=q[K]||(q[K]={});if(L){z=z.attributes=z.attributes||[];for(var Q in L)z.push([Q.toLowerCase(),L[Q]])}}}return q}function g(n,q){var s=n._.definition,A=l.mix(l.mix({},s.attributes),e(n)[q._4e_name()]);s=s.styles;var z=l.isEmptyObject(A)&&
l.isEmptyObject(s);for(var K in A)if(!((K=="class"||n._.definition.fullMatch)&&q.attr(K)!=o(K,A[K]))){z=z||!!q._4e_hasAttribute(K);q.removeAttr(K)}for(var L in s)if(!(n._.definition.fullMatch&&q._4e_style(L)!=o(L,s[L],true))){z=z||!!q._4e_style(L);q._4e_style(L,"")}z&&i(q)}function o(n,q,s){var A=new P("<span></span>");A[s?"_4e_style":"attr"](n,q);return A[s?"_4e_style":"attr"](n)}function b(n,q){for(var s=e(n),A=q.all(n.element),z=A.length;--z>=0;)g(n,new P(A[z]));for(var K in s)if(K!=n.element){A=
q.all(K);for(z=A.length-1;z>=0;z--){var L=new P(A[z]);f(L,s[K])}}}function f(n,q){if(q=q&&q.attributes)for(var s=0;s<q.length;s++){var A=q[s][0],z;if(z=n.attr(A)){var K=q[s][1];if(K===null||K.test&&K.test(z)||typeof K=="string"&&z==K)n[0].removeAttribute(A)}}i(n)}function i(n){if(!n._4e_hasAttributes()){var q=n[0].firstChild,s=n[0].lastChild;n._4e_remove(true);if(q){q.nodeType==I.NODE_ELEMENT&&k._4e_mergeSiblings(q);s&&!q===s&&s.nodeType==I.NODE_ELEMENT&&k._4e_mergeSiblings(s)}}}var l=KISSY,k=l.DOM,
u=x.STYLE={},F=x.RANGE,O=x.Selection,I=x.NODE,J=x.POSITION,M=x.Range,P=l.Node,N=l.UA,S=x.ElementPath,Y={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},Z={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},ca=/\s*(?:;\s*|$)/,$=/#\((.+?)\)/g;u.STYLE_BLOCK=1;u.STYLE_INLINE=2;u.STYLE_OBJECT=3;H.prototype={apply:function(n){y.call(this,n,false)},remove:function(n){y.call(this,n,true)},applyToRange:function(n){return(this.applyToRange=this.type==u.STYLE_INLINE?
B:this.type==u.STYLE_BLOCK?r:this.type==u.STYLE_OBJECT?null:null).call(this,n)},removeFromRange:function(n){return(this.removeFromRange=this.type==u.STYLE_INLINE?m:null).call(this,n)},applyToObject:function(n){C(n,this)},checkElementRemovable:function(n,q){if(!n)return false;var s=this._.definition;if(n._4e_name()==this.element){if(!q&&!n._4e_hasAttributes())return true;s=d(s);if(s._length){for(var A in s)if(A!="_length"){var z=n.attr(A)||"";if(A=="style"?a(s[A],c(z,false)):s[A]==z){if(!q)return true}else if(q)return false}if(q)return true}else return true}if(s=
e(this)[n._4e_name()]){if(!(s=s.attributes))return true;for(q=0;q<s.length;q++){A=s[q][0];if(A=n.attr(A)){z=s[q][1];if(z===null||typeof z=="string"&&A==z||z.test&&z.test(A))return true}}}return false},checkActive:function(n){switch(this.type){case u.STYLE_BLOCK:return this.checkElementRemovable(n.block||n.blockLimit,true);case u.STYLE_OBJECT:case u.STYLE_INLINE:for(var q=n.elements,s=0,A;s<q.length;s++){A=q[s];if(!(this.type==u.STYLE_INLINE&&(k._4e_equals(A,n.block)||k._4e_equals(A,n.blockLimit))))if(!(this.type==
u.STYLE_OBJECT&&!(A._4e_name()in Z)))if(this.checkElementRemovable(A,true))return true}}return false}};H.getStyleText=function(n){var q=n._ST;if(q)return q;q=n.styles;var s=n.attributes&&n.attributes.style||"",A="";if(s.length)s=s.replace(ca,";");for(var z in q){var K=q[z],L=(z+":"+K).replace(ca,";");if(K=="inherit")A+=L;else s+=L}if(s.length)s=c(s);s+=A;return n._ST=s};x.Style=H});
