/*
 Constructor for kissy editor and module dependency definition
 thanks to CKSource's intelligent work on CKEditor
 @author: yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.0
 @buildtime: 2010-11-19 15:41:38
*/
KISSY.add("editor",function(r,A){function D(i,a){function b(p){for(var m=D.Env.mods,l=0;l<p.length;l++){for(var w=p[l],J=u,v=0;v<l;v++)if(w==p[v]){J=z;break}v=m[w];if(J&&v){J=r.clone(v);w=w+"_"+l;J.name=w;p[l]=w;m[w]||(m[w]=J)}}}var d=this;if(!(d instanceof D))return new D(i,a);if(r.isString(i))i=r.one(i);i=x._4e_wrap(i);a=a||{};a.pluginConfig=a.pluginConfig||{};d.cfg=a;a.pluginConfig=a.pluginConfig;d.cfg=a;r.app(d,r.EventTarget);var j=["htmldataprocessor","enterkey","clipboard"],y=u;d.use=function(p,
m){p=p.split(",");b(p);if(!y)for(var l=0;l<j.length;l++){var w=j[l];r.inArray(w,p)||p.unshift(w)}r.use.call(d,p.join(","),function(){d.ready(function(){m&&m.call(d);if(!y){d.setData(i.val());if(a.focus)d.focus();else{var J=d.getSelection();J&&J.removeAllRanges()}d.fire("save");y=z}})},{order:z,global:D});return d};d.use=d.use;d.init(i);return d}function H(i){var a=r.Config.debug;i=a?a==="dev"?"../src/"+i:i:i.replace(/\.(js|css)/i,"-min.$1");i+=i.indexOf("?")!=-1?"&":"?";i+="t="+encodeURIComponent("2010-11-19 15:41:38");
return i}var x=r.DOM,z=true,u=false;r.app(D,r.EventTarget);D.Config.base=r.Config.base+"editor/";var s=["separator","sourcearea/support","tabs","flashbridge","flashutils","clipboard",{name:"colorsupport",requires:["overlay"]},{name:"colorsupport/dialog"},{name:"forecolor",requires:["colorsupport"]},{name:"bgcolor",requires:["colorsupport"]},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},
{name:"flash",requires:["flash/support"]},{name:"flash/dialog"},{name:"flash/support",requires:["flashutils","contextmenu","fakeobjects","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor"},{name:"image",requires:["contextmenu","bubbleview"]},{name:"image/dialog",requires:["tabs"]},"indent","justify",{name:"link",requires:["bubbleview"]},{name:"link/dialog"},"list","maximize",{name:"music",requires:["flash/support"]},{name:"music/dialog",requires:["flash/dialog"]},
"preview","removeformat",{name:"smiley"},{name:"sourcearea",requires:["sourcearea/support"]},{name:"table",requires:["contextmenu"]},{name:"table/dialog"},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],o,e,h,f,k={};o=0;for(e=s.length;o<e;o++){h=s[o];if(r.isString(h))h=s[o]={name:h+"",requires:null};f=h.requires||[];var B=["button"];h.name.indexOf("/dialog")!=-1&&B.push("overlay");h.requires=f.concat(B)}s=[{name:"localStorage",requires:["flashutils","flashbridge"]},
{name:"button"},{name:"dd"},{name:"progressbar"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(s);o=0;for(e=s.length;o<e;o++){h=s[o];f=h.name;k[f]={attach:u,charset:"utf-8",requires:h.requires,csspath:h.useCss?H("plugins/"+f+"/plugin.css"):A,path:H("plugins/"+f+"/plugin.js")}}D.add(k);r.Editor=D;r.Editor=D});
KISSY.Editor.add("utils",function(r){var A=null,D=KISSY,H=D.Node,x=D.DOM,z=D.UA,u=D.Event,s;s=z.ie?document.documentMode||z.ie:void 0;var o={debugUrl:function(e){var h=D.Config.debug;e=h?h==="dev"?"../src/"+e:e:e.replace(/\.(js|css)/i,"-min.$1");e+=e.indexOf("?")!=-1?"&":"?";e+="t="+encodeURIComponent("2010-11-19 15:41:38");return e},lazyRun:function(e,h,f){var k=e[h],B=e[f];e[h]=function(){k.apply(this,arguments);e[h]=e[f];return B.apply(this,arguments)}},getXY:function(e,h,f,k){f=f.defaultView||
f.parentWindow;e-=x.scrollLeft(f);h-=x.scrollTop(f);if(k)if(f!=(k.defaultView||k.parentWindow)&&f.frameElement){k=x._4e_getOffset(f.frameElement,k);e+=k.left;h+=k.top}return{left:e,top:h}},tryThese:function(){for(var e,h=0,f=arguments.length;h<f;h++){var k=arguments[h];try{e=k();break}catch(B){}}return e},arrayCompare:function(e,h){if(!e&&!h)return true;if(!e||!h||e.length!=h.length)return false;for(var f=0;f<e.length;f++)if(e[f]!==h[f])return false;return true},getByAddress:function(e,h,f){e=e.documentElement;
for(var k=0;e&&k<h.length;k++){var B=h[k];if(f)for(var i=-1,a=0;a<e.childNodes.length;a++){var b=e.childNodes[a];if(!(f===true&&b.nodeType==3&&b.previousSibling&&b.previousSibling.nodeType==3)){i++;if(i==B){e=b;break}}}else e=e.childNodes[B]}return e?new H(e):A},clearAllMarkers:function(e){for(var h in e)e[h]._4e_clearMarkers(e,true)},htmlEncodeAttr:function(e){return e.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(e){return e.replace(/^\s+/,"")},rtrim:function(e){return e.replace(/\s+$/,
"")},trim:function(e){return this.ltrim(this.rtrim(e))},mix:function(){for(var e={},h=0;h<arguments.length;h++)e=D.mix(e,arguments[h]);return e},isCustomDomain:function(){if(!z.ie)return false;var e=document.domain,h=window.location.hostname;return e!=h&&e!="["+h+"]"},duplicateStr:function(e,h){return Array(h+1).join(e)},throttle:function(e,h,f){f=f||150;if(f===-1)return function(){e.apply(h,arguments)};var k=(new Date).getTime();return function(){var B=(new Date).getTime();if(B-k>f){k=B;e.apply(h,
arguments)}}},buffer:function(e,h,f){f=f||0;var k=A;return function(){k&&clearTimeout(k);var B=arguments;k=setTimeout(function(){return e.apply(h,B)},f)}},isNumber:function(e){return/^\d+(.\d+)?$/.test(D.trim(e))},verifyInputs:function(e){for(var h=0;h<e.length;h++){var f=x._4e_wrap(e[h]),k=D.trim(f.val()),B=f.attr("data-verify");f=f.attr("data-warning");if(B&&!RegExp(B).test(k)){alert(f);return false}}return true},sourceDisable:function(e,h){e.on("sourcemode",h.disable,h);e.on("wysiwygmode",h.enable,
h)},resetInput:function(e){var h=e.attr("placeholder");if(h&&!z.webkit){e.addClass("ke-input-tip");e.val(h)}else z.webkit&&e.val("")},valInput:function(e,h){e.removeClass("ke-input-tip");e.val(h)},placeholder:function(e,h){e.attr("placeholder",h);if(!z.webkit){e.on("blur",function(){if(!D.trim(e.val())){e.addClass("ke-input-tip");e.val(h)}});e.on("focus",function(){e.removeClass("ke-input-tip");D.trim(e.val())==h&&e.val("")})}},clean:function(e){e=e[0]||e;for(var h=D.makeArray(e.childNodes),f=0;f<
h.length;f++){var k=h[f];k.nodeType==r.NODE.NODE_TEXT&&!D.trim(k.nodeValue)&&e.removeChild(k)}},htmlEncode:function(e){return!e?e:String(e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(e){return!e?e:String(e).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(e,h){return e.toLowerCase()==h.toLowerCase()},normParams:function(e){e=D.clone(e);for(var h in e)if(e.hasOwnProperty(h)){var f=
e[h];if(D.isFunction(f))e[h]=f()}return e},doFormUpload:function(e,h,f){function k(){var y={responseText:"",responseXML:A};y.argument=e?e.argument:A;try{var p;if((p=z.ie?i.contentWindow.document:i.contentDocument||window.frames[B].document)&&p.body)y.responseText=p.body.innerHTML;y.responseXML=p&&p.XMLDocument?p.XMLDocument:p}catch(m){D.log(m)}u.remove(i,"load",k);e.callback&&e.callback(y);setTimeout(function(){x._4e_remove(i)},100)}var B=D.guid("form-upload-"),i=document.createElement("iframe");
i.id=B;i.name=B;i.className="ke-hidden";var a="document.open();"+(o.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(z.ie)i.src=z.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";D.log("doFormUpload : "+i.src);document.body.appendChild(i);if(z.ie)document.frames[B].name=B;a=x._4e_unwrap(e.form);var b={target:a.target,method:a.method,encoding:a.encoding,enctype:a.enctype,action:a.action};a.target=B;a.method="POST";a.enctype=a.encoding="multipart/form-data";
if(f)a.action=f;var d;if(h){d=[];h=r.Utils.normParams(h);for(var j in h)if(h.hasOwnProperty(j)){f=document.createElement("input");f.type="hidden";f.name=j;f.value=h[j];a.appendChild(f);d.push(f)}}u.on(i,"load",k);a.submit();a.target=b.target;a.method=b.method;a.enctype=b.enctype;a.encoding=b.encoding;a.action=b.action;if(d){h=0;for(j=d.length;h<j;h++)x._4e_remove(d[h])}return i},extern:function(e,h){for(var f in h)e[f]=h[f]},map:function(e,h){for(var f=0;f<e.length;f++)e[f]=h(e[f]);return e},ieEngine:s,
preventFocus:function(e){z.ie?e._4e_unselectable():e.attr("onmousedown","return false;")}};r.Utils=o;r.Utils=o;o.extern(o,{debugUrl:o.debugUrl,lazyRun:o.lazyRun,getXY:o.getXY,tryThese:o.tryThese,arrayCompare:o.arrayCompare,getByAddress:o.getByAddress,clearAllMarkers:o.clearAllMarkers,htmlEncodeAttr:o.htmlEncodeAttr,ltrim:o.ltrim,rtrim:o.rtrim,trim:o.trim,mix:o.mix,isCustomDomain:o.isCustomDomain,duplicateStr:o.duplicateStr,buffer:o.buffer,isNumber:o.isNumber,verifyInputs:o.verifyInputs,sourceDisable:o.sourceDisable,
resetInput:o.resetInput,placeholder:o.placeholder,clean:o.clean,htmlEncode:o.htmlEncode,htmlDecode:o.htmlDecode,equalsIgnoreCase:o.equalsIgnoreCase,normParams:o.normParams,throttle:o.throttle,doFormUpload:o.doFormUpload,map:o.map})});
KISSY.Editor.add("focusmanager",function(r){function A(){this.iframeFocus=e;s=this;H.log(this._UUID+" focus")}function D(){this.iframeFocus=h;s=f;H.log(this._UUID+" blur")}var H=KISSY,x=H.DOM,z=H.Event,u={},s,o={refreshAll:function(){for(var k in u){var B=u[k];B.document.designMode="off";B.document.designMode="on"}},currentInstance:function(){return s},getInstance:function(k){return u[k]},add:function(k){var B=x._4e_getWin(k.document);z.on(B,"focus",A,k);z.on(B,"blur",D,k)},register:function(k){u[k._UUID]=
k},remove:function(k){delete u[k._UUID];var B=x._4e_getWin(k.document);z.remove(B,"focus",A,k);z.remove(B,"blur",D,k)}},e=true,h=false,f=null;r.focusManager=o;r.focusManager=o;r.getInstances=function(){return u};r.getInstances=r.getInstances});
KISSY.Editor.add("definition",function(r){var A=true,D=false,H=r.Utils,x=document,z=KISSY,u=z.UA,s=z.DOM,o=z.Node,e=z.Event,h=r.focusManager,f=H.tryThese,k=H.debugUrl("theme/editor-iframe.css"),B=1,i="document.open();"+(H.isCustomDomain()?'document.domain="'+x.domain+'";':"")+"document.close();",a="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(u.ie?"javascript:void(function(){"+encodeURIComponent(i)+"}())":"")+'"  tabIndex="'+(u.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";r.SOURCE_MODE=0;r.WYSIWYG_MODE=1;r.SOURCE_MODE=r.SOURCE_MODE;r.WYSIWYG_MODE=r.WYSIWYG_MODE;z.augment(r,{init:function(b){if(u.ie)s.addClass(x.body,"ie"+u.ie);else if(u.gecko)s.addClass(x.body,"gecko");else u.webkit&&s.addClass(x.body,"webkit");var d=this,j=new o(a.replace(/\$\(tabIndex\)/,
b.attr("tabIndex")));d.editorWrap=j;d._UUID=B++;h.register(d);d.wrap=j.one(".ke-textarea-wrap");d.wrap=d.wrap;d.iframe=d.wrap.one("iframe");d.iframe=d.iframe;d.toolBarDiv=j.one(".ke-editor-tools");d.toolBarDiv=d.toolBarDiv;d.textarea=b;d.textarea=d.textarea;d.statusDiv=j.one(".ke-editor-status");d.statusDiv=d.statusDiv;H.preventFocus(d.toolBarDiv);d._commands={};d._dialogs={};var y=b._4e_style("width"),p=b._4e_style("height");if(y){j.css("width",y);b.css("width","100%")}d.textarea.css("display","none");
j.insertAfter(b);d.wrap[0].appendChild(b[0]);if(p){d.wrap.css("height",p);b.css("height","100%")}j=d.iframe;d.on("dataReady",function(){d._ready=A;r.fire("instanceCreated",{editor:d})});u.gecko?j.on("load",d._setUpIFrame,d):d._setUpIFrame();d.cfg.attachForm&&b[0].form&&d._attachForm()},_attachForm:function(){(new o(this.textarea[0].form)).on("submit",this.sync,this)},useDialog:function(b,d){var j=this,y=r.Overlay;y.loading();j.use(b,function(){var p=j.getDialog(b);d(p);y.unloading()})},addDialog:function(b,
d){this._dialogs[b]=d},getDialog:function(b){return this._dialogs[b]},addPlugin:function(b){this.ready(b)},addCommand:function(b,d){this._commands[b]=d},hasCommand:function(b){return this._commands[b]},execCommand:function(b){var d=this._commands[b],j=z.makeArray(arguments);j.shift();j.unshift(this);return d.exec.apply(d,j)},getMode:function(){return this.textarea.css("display")=="none"?r.WYSIWYG_MODE:r.SOURCE_MODE},getData:function(b){var d;d=this.getMode()==r.WYSIWYG_MODE?this.document.body.innerHTML:
this.textarea.val();if(this.htmlDataProcessor)d=b?this.htmlDataProcessor.toHtml(d,"p"):this.htmlDataProcessor.toServer(d,"p");d=z.trim(d);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(d))d="";return d},setData:function(b){var d=b;if(this.htmlDataProcessor)d=this.htmlDataProcessor.toDataFormat(b,"p");this.document.body.innerHTML=d;this.getMode()!=r.WYSIWYG_MODE&&this.textarea.val(b)},sync:function(){this.textarea.val(this.getData())},baseZIndex:function(b){b=b||0;return b+(this.cfg.baseZIndex||0)},_getRawData:function(){return this.document.body.innerHTML},
_setRawData:function(b){this.document.body.innerHTML=b},_prepareIFrameHtml:function(b){var d=this.cfg,j=d.customLink,y="";if(j)for(var p=0;p<j.length;p++)y+='<link href="'+j[p]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+r.Config.base+k+"' rel='stylesheet'/><style>"+(d.customStyle||"")+"</style>"+y+"</head><body class='ke-editor'>&nbsp;"+(b?'<script id="ke_actscript" type="text/javascript">'+(H.isCustomDomain()?'document.domain="'+x.domain+'";':"")+
'window.parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':"")+"</body></html>"},getSelection:function(){return r.Selection.getSelection(this.document)},focus:function(){var b=this.document,d=s._4e_getWin(b);u.webkit&&d&&d.parent&&d.parent.focus();d&&d.focus();b&&b.body.focus();this.notifySelectionChange()},blur:function(){s._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(b){var d=this.cfg,j=this.document;d.customStyle=d.customStyle||"";d.customStyle+=
"\n"+b;d=j.createElement("style");j.getElementsByTagName("head")[0].appendChild(d);if(d.styleSheet)d.styleSheet.cssText=b;else d.appendChild(j.createTextNode(b))},addCustomLink:function(b){var d=this.cfg,j=this.document;d.customLink=d.customLink||[];d.customLink.push(b);d=j.createElement("link");d.rel="stylesheet";j.getElementsByTagName("head")[0].appendChild(d);d.href=b},removeCustomLink:function(b){for(var d=this.cfg,j=z.makeArray(this.document.getElementsByTagName("link")),y=0;y<j.length;y++)j[y].href==
b&&s._4e_remove(j[y]);d.customLink=d.customLink||[];d=d.customLink;b=z.indexOf(b,d);b!=-1&&d.splice(b,1)},_setUpIFrame:function(){function b(){m=p.document;d.document=m;j.detach();m.open("text/html","replace");m.write(y);m.close()}var d=this,j=d.iframe,y=d._prepareIFrameHtml(d._UUID),p=j[0].contentWindow,m;try{m=p.document}catch(l){j[0].src=j[0].src;if(u.ie<7){setTimeout(b,10);return}}b()},ready:function(b){this._ready?b():this.on("dataReady",b)},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId);
b._monitorId=setTimeout(function(){var d=b.getSelection();if(d&&!d.isInvalid){var j=d.getStartElement(),y=new r.ElementPath(j);if(!b.previousPath||!b.previousPath.compare(y)){b.previousPath=y;b.fire("selectionChange",{selection:d,path:y,element:j})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(b,d){var j=this;j.focus();var y=b._4e_name(),p=r.XHTML_DTD,m=r.RANGE,l=r.NODE,w=p.$block[y],J=j.getSelection(),v=J&&J.getRanges(),c,g,q,t,n;if(!v||
v.length==0){var C=arguments,P=C.callee;setTimeout(function(){P.apply(j,C)},30)}else{j.fire("save");for(var M=v.length-1;M>=0;M--){c=v[M];c.deleteContents();g=!M&&b||b._4e_clone(A);d&&d(g);if(w)for(;(t=c.getCommonAncestor(D,A))&&(n=p[t._4e_name()])&&!(n&&n[y]);)if(t._4e_name()in p.span)c.splitElement(t);else if(c.checkStartOfBlock()&&c.checkEndOfBlock()){c.setStartBefore(t);c.collapse(A);t._4e_remove()}else c.splitBlock();c.insertNode(g);q||(q=g)}if(q){y=q._4e_nextSourceNode(A);p=j.document;n=r.XHTML_DTD;
if(n.$inline[g._4e_name()]){y=new o(p.createTextNode(" "));y.insertAfter(q)}else if(y){if(y._4e_name()=="br"&&n[y.parent()._4e_name()].p){n=new o("<p>&nbsp;</p>",null,p);y[0].parentNode.replaceChild(n[0],y[0]);y=n}}else{n=new o("<p>&nbsp;</p>",null,p);n.insertAfter(q);y=n}c.moveToPosition(q,m.POSITION_AFTER_END);y&&y[0].nodeType==l.NODE_ELEMENT&&c.moveToElementEditablePosition(y);J.selectRanges([c]);j.focus();g&&g._4e_scrollIntoView();setTimeout(function(){j.fire("save")},10);return g}}},insertHtml:function(b){var d=
this;if(d.htmlDataProcessor)b=d.htmlDataProcessor.toDataFormat(b);if(u.webkit){var j=s.create(b,null,this.document);j=j.nodeType==11?z.makeArray(j.childNodes):[j];for(var y=0;y<j.length;y++)d.insertElement(new o(j[y]))}else{d.focus();y=(j=d.getSelection())&&j.getRanges();if(!y||y.length==0){var p=arguments,m=p.callee;setTimeout(function(){m.apply(d,p)},30)}else{d.fire("save");if(u.ie){j=j.getNative();j.type=="Control"&&j.clear();j.createRange().pasteHTML(b)}else d.document.execCommand("inserthtml",
D,b);d.focus();setTimeout(function(){d.fire("save")},10)}}}});r._initIFrame=function(b){function d(g){f(function(){p.designMode="on";setTimeout(function(){p.designMode="off";w.focus();if(!arguments.callee.retry)arguments.callee.retry=A},50)},function(){p.designMode="off";s.attr(w,"contentEditable",D);s.attr(w,"contentEditable",A);!g&&d(1)})}var j=h.getInstance(b);b=j.textarea[0];var y=j.iframe[0].contentWindow,p=j.document,m=j.cfg,l=p.getElementById("ke_actscript");s._4e_remove(l);var w=p.body;if(u.ie){w.hideFocus=
A;w.disabled=A;w.contentEditable=A;w.removeAttribute("disabled")}else setTimeout(function(){if(u.gecko||u.opera)w.contentEditable=A;else if(u.webkit)w.parentNode.contentEditable=A;else p.designMode="on"},0);if(u.webkit){e.on(p,"click",function(g){var q=new o(g.target);z.inArray(q._4e_name(),["input","select"])&&g.preventDefault()});e.on(p,"mouseup",function(g){var q=new o(g.target);z.inArray(q._4e_name(),["input","textarea"])&&g.preventDefault()})}if(u.gecko||u.ie||u.opera){var J;J=new o(s.insertAfter((new o('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],
b));J.on("focus",function(){j.focus()});j.activateGecko=function(){u.gecko&&j.iframeFocus&&J[0].focus()};j.on("destroy",function(){})}if(u.ie&&p.compatMode=="CSS1Compat"||u.gecko||u.opera){var v=new o(p.documentElement);v.on("mousedown",function(g){if(g.target==v[0]){u.gecko&&d(D);J[0].focus()}})}e.on(y,"focus",function(){if(u.gecko)d(D);else u.opera&&w.focus();j.notifySelectionChange()});u.gecko&&e.on(j.document,"mousedown",function(){j.iframeFocus||d(D)});if(u.ie){e.on(p,"keydown",function(g){if(g.keyCode in
{8:1,46:1}){var q=j.getSelection(),t=q.getSelectedElement();if(t){j.fire("save");var n=q.getRanges()[0].createBookmark();t._4e_remove();q.selectBookmarks([n]);j.fire("save");g.preventDefault()}}});if(p.compatMode=="CSS1Compat"){var c={33:1,34:1};e.on(p,"keydown",function(g){g.keyCode in c&&setTimeout(function(){j.getSelection().scrollIntoView()},0)})}}setTimeout(function(){u.ie&&setTimeout(function(){if(p){w.runtimeStyle.marginBottom="0px";w.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){j.fire("dataReady");
var g=m.disableObjectResizing,q=m.disableInlineTableEditing;if(g||q)try{p.execCommand("enableObjectResizing",D,!g);p.execCommand("enableInlineTableEditing",D,!q)}catch(t){e.on(w,u.ie?"resizestart":"resize",function(n){if(g||s._4e_name(n.target)==="table"&&q)n.preventDefault()})}},10);u.webkit&&e.on(p,"mousedown",function(g){g=new o(g.target);z.inArray(g._4e_name(),["img","hr","input","textarea","select"])&&j.getSelection().selectElement(g)});u.gecko&&e.on(p,"dragstart",function(g){var q=new o(g.target);
q._4e_name()==="img"&&/ke_/.test(q[0].className)&&g.preventDefault()});h.add(j)};i=r.prototype;H.extern(i,{setData:i.setData,getData:i.getData,insertElement:i.insertElement,insertHtml:i.insertHtml,ready:i.ready,addCustomStyle:i.addCustomStyle,addCommand:i.addCommand,hasCommand:i.hasCommand,execCommand:i.execCommand,addPlugin:i.addPlugin,useDialog:i.useDialog,addDialog:i.addDialog,getDialog:i.getDialog,getMode:i.getMode,sync:i.sync,baseZIndex:i.baseZIndex,getSelection:i.getSelection,focus:i.focus,
blur:i.blur,notifySelectionChange:i.notifySelectionChange})});KISSY.Editor.add("zindex",function(){var r=KISSY.Editor;if(!r.zIndexManager){r.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};r.baseZIndex=function(A){var D=A,H=r.getInstances(),x;for(x in H){if(!H.hasOwnProperty(x))return;D=Math.max(D,H[x].baseZIndex(A))}return D};r.baseZIndex=r.baseZIndex;r.zIndexManager=r.zIndexManager}});
KISSY.Editor.add("dtd",function(r){r.XHTML_DTD=function(){function A(m){for(var l=arguments.length-1;l>0;)KISSY.mix(m,arguments[l--]);return m}var D={isindex:1,fieldset:1},H={input:1,button:1,select:1,textarea:1,label:1},x=A({a:1},H),z=A({iframe:1},x),u={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},s={ins:1,del:1,script:1,style:1},o=A({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},s),e=A({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},o),h=A({p:1},e);H=A({iframe:1},e,H);e={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var f=A({a:1},H),k={tr:1},B={"#":1},i=A({param:1},e),a=A({form:1},D,z,u,h),b={li:1},d={base:1,link:1,meta:1,title:1},j=A(d,{style:1,script:1}),y={head:1,body:1},p={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:A({html:1},y,d),$block:p,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:f,$body:A({script:1,style:1},p),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:y,head:j,style:B,body:a,base:{},link:{},meta:{},title:B,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:f,button:A(h,u),basefont:{},h5:f,h4:f,samp:f,h6:f,ol:b,h1:f,h3:f,option:B,h2:f,form:A(D,z,u,h),select:{optgroup:1,option:1},font:f,ins:f,menu:b,abbr:f,label:f,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:f,script:B,tfoot:k,cite:f,li:a,input:{},iframe:a,strong:f,textarea:B,noframes:a,big:f,small:f,span:f,hr:{},dt:f,sub:f,optgroup:{option:1},param:{},bdo:f,"var":f,div:a,object:i,sup:f,dd:a,strike:f,area:{},dir:b,map:A({area:1,form:1,p:1},D,s,u),applet:i,dl:{dt:1,dd:1},del:f,isindex:{},fieldset:A({legend:1},e),thead:k,ul:b,acronym:f,b:f,a:H,blockquote:a,caption:f,i:f,u:f,tbody:k,s:f,address:A(z,h),tt:f,legend:f,q:f,pre:A(o,x),p:f,em:f,dfn:f}}();r.XHTML_DTD=
r.XHTML_DTD});
KISSY.Editor.add("dom",function(r){function A(a){return a.replace(/-(\w)/g,function(b,d){return d.toUpperCase()})}var D=KISSY,H=D.DOM,x=D.UA,z=D.Node,u=r.Utils,s={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};r.NODE=r.NODE;r.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};r.POSITION=r.POSITION;var o=r.NODE,e=r.POSITION,h={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},f={hr:1},k=function(a){return a[0]||a},B=function(a){if(a&&!a[0])return new z(a);return a},i={_4e_wrap:B,_4e_unwrap:k,_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=k(a);b=k(b);
return a===b},_4e_isBlockBoundary:function(a,b){a=B(a);var d=D.mix(D.mix({},f),b||{});return h[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=k(a);for(var b=a.parentNode.childNodes,d=0;d<b.length;d++)if(b[d]===a)return d;return-1},_4e_first:function(a,b){a=k(a);var d=a.firstChild;if((d=d&&new z(d))&&b&&!b(d))d=d._4e_next(b);return d},_4e_move:function(a,b,d){a=k(a);H._4e_remove(a);
b=k(b);d?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_name:function(a){a=k(a);var b=a.nodeName.toLowerCase();if(x.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var d=a[0].attributes,j=b[0].attributes,y=d.length,p=j.length;if(y!=p)return false;for(var m=0;m<y;m++){var l=d[m],w=l.name;if(l.specified&&a.attr(w)!=b.attr(w))return false}if(u.ieEngine<8)for(m=0;m<p;m++){l=j[m];w=l.name;if(l.specified&&
a.attr(w)!=b.attr(w))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=k(a).childNodes;for(var b=0,d=a.length;b<d;b++){var j=a[b],y=j.nodeType;if(!(y==o.NODE_ELEMENT&&j.getAttribute("_ke_bookmark")))if(y==o.NODE_ELEMENT&&!i._4e_isEmptyInlineRemoveable(j)||y==o.NODE_TEXT&&D.trim(j.nodeValue))return false}return true},_4e_moveChildren:function(a,b,d){a=k(a);b=b[0]||b;if(a!=b)if(d)for(;d=a.lastChild;)b.insertBefore(a.removeChild(d),b.firstChild);else for(;d=a.firstChild;)b.appendChild(a.removeChild(d))},
_4e_mergeSiblings:function(){function a(b,d,j){if(d[0]&&d[0].nodeType==o.NODE_ELEMENT){for(var y=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){y.push(d);d=j?new z(d[0].nextSibling):new z(d[0].previousSibling);if(!d[0]||d[0].nodeType!=o.NODE_ELEMENT)return}if(b._4e_isIdentical(d)){for(var p=j?b[0].lastChild:b[0].firstChild;y.length;)y.shift()._4e_move(b,!j);d._4e_moveChildren(b,!j);d._4e_remove();p[0]&&p[0].nodeType==o.NODE_ELEMENT&&p._4e_mergeSiblings()}}}return function(b){if(b[0])if(s[b._4e_name()]||
b._4e_name()=="a"){a(b,new z(b[0].nextSibling),true);a(b,new z(b[0].previousSibling))}}}(),_4e_unselectable:x.gecko?function(a){a=k(a);a.style.MozUserSelect="none"}:x.webkit?function(a){a=k(a);a.style.KhtmlUserSelect="none"}:function(a){a=k(a);if(x.ie||x.opera){var b=0;a.unselectable="on";for(var d=a.getElementsByTagName("*");a=d[b++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.unselectable="on"}}},_4e_getOffset:function(a,b){a=k(a);var d,
j=0;d=0;var y=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,p=a.ownerDocument,m=p.documentElement;b=b||p;if(a.getBoundingClientRect){if(a!==p.body&&m!==a){d=a.getBoundingClientRect();j=d.left+(b===p?H.scrollLeft(y):0);d=d.top+(b===p?H.scrollTop(y):0)}if(b)if(y!=(b.defaultView||b.parentWindow)&&y.frameElement){y=i._4e_getOffset(y.frameElement,b);j+=y.left;d+=y.top}}return{left:j,top:d}},_4e_getFrameDocument:function(a){return(a=k(a))&&a.contentWindow.document},_4e_splitText:function(a,
b){a=k(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=o.NODE_TEXT)){if(x.ie&&b==a.nodeValue.length){var j=d.createTextNode("");H.insertAfter(j,a);return new z(j)}j=new z(a.splitText(b));if(d.documentMode){d=d.createTextNode("");H.insertAfter(d,j[0]);H._4e_remove(d)}return j}},_4e_parents:function(a,b){a=B(a);var d=[];do d[b?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,b,d){a=k(a);a=a.cloneNode(b);if(!d){var j=function(y){if(y.nodeType==o.NODE_ELEMENT){y.removeAttribute("id");
y=y.childNodes;for(var p=0;p<y.length;p++)j(y[p])}};j(a)}return new z(a)},_4e_nextSourceNode:function(a,b,d,j){a=k(a);if(j&&!j.call){var y=j[0]||j;j=function(m){m=m[0]||m;return m!==y}}b=!b&&a.firstChild;var p=new z(a);if(!b){if(a.nodeType==o.NODE_ELEMENT&&j&&j(a,true)===false)return null;b=a.nextSibling}for(;!b&&(p=p.parent());){if(j&&j(p,true)===false)return null;b=p[0].nextSibling}if(!b)return null;b=H._4e_wrap(b);if(j&&j(b)===false)return null;if(d&&d!=b[0].nodeType)return b._4e_nextSourceNode(false,
d,j);return b},_4e_previousSourceNode:function(a,b,d,j){a=k(a);if(j&&!j.call){var y=j[0]||j;j=function(m){m=m[0]||m;return m!==y}}b=!b&&a.lastChild;var p=new z(a);if(!b){if(a.nodeType==o.NODE_ELEMENT&&j&&j(a,true)===false)return null;b=a.previousSibling}for(;!b&&(p=p.parent());){if(j&&j(p,true)===false)return null;b=p[0].previousSibling}if(!b)return null;b=H._4e_wrap(b);if(j&&j(b)===false)return null;if(d&&b[0].nodeType!=d)return b._4e_previousSourceNode(false,d,j);return b},_4e_commonAncestor:function(a,
b){if(a._4e_equals(b))return a;if(b[0].nodeType!=o.NODE_TEXT&&b.contains(a))return b;var d=a[0].nodeType==o.NODE_TEXT?a.parent():a;do if(d[0].nodeType!=o.NODE_TEXT&&d.contains(b))return d;while(d=d.parent());return null},_4e_ascendant:function(a,b,d){a=k(a);if(!d)a=a.parentNode;if(b&&!D.isFunction(b)){var j=b;b=function(y){return y._4e_name()==j}}for(;a&&a.nodeType!=9;){if(!b||b(new z(a))===true)return new z(a);a=a.parentNode}return null},_4e_hasAttribute:u.ieEngine<9?function(a,b){a=k(a);var d=a.attributes[b];
return!!(d&&d.specified)}:function(a,b){a=k(a);return a.hasAttribute(b)},_4e_hasAttributes:u.ieEngine<9?function(a){a=k(a);for(var b=a.attributes,d=0;d<b.length;d++){var j=b[d];switch(j.name){case "class":if(a.getAttribute("class"))return true;break;default:if(j.specified)return true}}return false}:function(a){a=k(a);x.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,b){var d=k(a),j=k(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(j);if(d==
j)return e.POSITION_IDENTICAL;if(d.nodeType==o.NODE_ELEMENT&&j.nodeType==o.NODE_ELEMENT){if(d.contains){if(d.contains(j))return e.POSITION_CONTAINS+e.POSITION_PRECEDING;if(j.contains(d))return e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING}if("sourceIndex"in d)return d.sourceIndex<0||j.sourceIndex<0?e.POSITION_DISCONNECTED:d.sourceIndex<j.sourceIndex?e.POSITION_PRECEDING:e.POSITION_FOLLOWING}d=a._4e_address();j=b._4e_address();for(var y=Math.min(d.length,j.length),p=0;p<=y-1;p++)if(d[p]!=j[p]){if(p<
y)return d[p]<j[p]?e.POSITION_PRECEDING:e.POSITION_FOLLOWING;break}return d.length<j.length?e.POSITION_CONTAINS+e.POSITION_PRECEDING:e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING},_4e_address:function(a,b){a=k(a);for(var d=[],j=a.ownerDocument.documentElement,y=a;y&&y!=j;){var p=y.parentNode,m=-1;if(p){for(var l=0;l<p.childNodes.length;l++){var w=p.childNodes[l];if(!(b&&w.nodeType==3&&w.previousSibling&&w.previousSibling.nodeType==3)){m++;if(w==y)break}}d.unshift(m)}y=p}return d},_4e_breakParent:function(a,
b){var d=new r.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);var j=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(j,a[0].nextSibling)},_4e_style:function(a,b,d){a=B(a);if(d!==undefined)return a.css(b,d);a=k(a);return a.style[A(b)]},_4e_remove:function(a,b){var d=k(a),j=d.parentNode;if(j){if(b)for(var y;y=d.firstChild;)j.insertBefore(d.removeChild(y),d);j.removeChild(d)}return a},_4e_trim:function(a){H._4e_ltrim(a);H._4e_rtrim(a)},_4e_ltrim:function(a){a=
k(a);for(var b;b=a.firstChild;){if(b.nodeType==o.NODE_TEXT){var d=u.ltrim(b.nodeValue),j=b.nodeValue.length;if(d){if(d.length<j){(new z(b))._4e_splitText(j-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=k(a);for(var b;b=a.lastChild;){if(b.type==o.NODE_TEXT){var d=u.rtrim(b.nodeValue),j=b.nodeValue.length;if(d){if(d.length<j){(new z(b))._4e_splitText(d.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!x.ie&&!x.opera)(b=
a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=k(a);for(var b=a.lastChild;b&&b.nodeType==o.NODE_TEXT&&!D.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==o.NODE_TEXT||H._4e_name(b)!=="br"){b=x.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");x.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){var d=k(a),j;do j=(d=d.previousSibling)&&new z(d);while(j&&b&&!b(j));
return j},_4e_last:function(a,b){a=H._4e_wrap(a);var d=a[0].lastChild;if((d=d&&new z(d))&&b&&!b(d))d=d._4e_previous(b);return d},_4e_next:function(a,b){var d=k(a),j;do j=(d=d.nextSibling)&&new z(d);while(j&&b&&!b(j));return j},_4e_outerHtml:function(a){a=k(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,d,j){a=H._4e_wrap(a);var y=a.data("list_marker_id")||a.data("list_marker_id",
D.guid()).data("list_marker_id"),p=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[y]=a;p[d]=1;return a.data(d,j)},_4e_clearMarkers:function(a,b,d){a=B(a);var j=a.data("list_marker_names"),y=a.data("list_marker_id"),p;for(p in j)a.removeData(p);a.removeData("list_marker_names");if(d){a.removeData("list_marker_id");delete b[y]}},_4e_copyAttributes:function(a,b,d){a=k(a);b=B(b);var j=a.attributes;d=d||{};for(var y=0;y<j.length;y++){var p=j[y],m=p.name.toLowerCase(),
l;if(!(m in d))if(m=="checked"&&(l=H.attr(a,m)))b.attr(m,l);else if(p.specified||x.ie&&p.value&&m=="value"){l=H.attr(a,m);if(l===null)l=p.nodeValue;b.attr(m,l)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=H._4e_name(a);var b=r.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=B(a);var b=a[0].ownerDocument,d=H.scrollLeft(b),j=H.scrollTop(b),y=a.offset(),p=y.left;y=y.top;if(H.viewportHeight(b)+j<y||y<j||H.viewportWidth(b)+
d<p||p<d)a.scrollIntoView(b)},_4e_getElementsByTagName:function(a,b,d){a=k(a);if(!x.ie&&d)b=d+":"+b;d=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)d.push(new z(a[b]));return d}};D.DOM._4e_inject=function(a){D.mix(H,a);for(var b in a)a.hasOwnProperty(b)&&function(d){z.prototype[d]=function(){var j=[].slice.call(arguments,0);j.unshift(this);return a[d].apply(null,j)}}(b)};u.extern(i,{_4e_wrap:i._4e_wrap,_4e_unwrap:i._4e_unwrap,_4e_equals:i._4e_equals,_4e_isBlockBoundary:i._4e_isBlockBoundary,
_4e_getWin:i._4e_getWin,_4e_index:i._4e_index,_4e_first:i._4e_first,_4e_move:i._4e_move,_4e_name:i._4e_name,_4e_isIdentical:i._4e_isIdentical,_4e_isEmptyInlineRemoveable:i._4e_isEmptyInlineRemoveable,_4e_moveChildren:i._4e_moveChildren,_4e_mergeSiblings:i._4e_mergeSiblings,_4e_unselectable:i._4e_unselectable,_4e_getOffset:i._4e_getOffset,_4e_getFrameDocument:i._4e_getFrameDocument,_4e_splitText:i._4e_splitText,_4e_parents:i._4e_parents,_4e_clone:i._4e_clone,_4e_nextSourceNode:i._4e_nextSourceNode,
_4e_previousSourceNode:i._4e_previousSourceNode,_4e_commonAncestor:i._4e_commonAncestor,_4e_ascendant:i._4e_ascendant,_4e_hasAttribute:i._4e_hasAttribute,_4e_hasAttributes:i._4e_hasAttributes,_4e_position:i._4e_position,_4e_address:i._4e_address,_4e_breakParent:i._4e_breakParent,_4e_style:i._4e_style,_4e_remove:i._4e_remove,_4e_trim:i._4e_trim,_4e_ltrim:i._4e_ltrim,_4e_rtrim:i._4e_rtrim,_4e_appendBogus:i._4e_appendBogus,_4e_last:i._4e_last,_4e_previous:i._4e_previous,_4e_next:i._4e_next,_4e_outerHtml:i._4e_outerHtml,
_4e_setMarker:i._4e_setMarker,_4e_clearMarkers:i._4e_clearMarkers,_4e_getUniqueId:i._4e_getUniqueId,_4e_copyAttributes:i._4e_copyAttributes,_4e_isEditable:i._4e_isEditable,_4e_scrollIntoView:i._4e_scrollIntoView,_4e_getElementsByTagName:i._4e_getElementsByTagName});H._4e_inject(i)});
KISSY.Editor.add("elementpath",function(r){function A(e){var h=z,f=z,k=[];for(e=e;e&&e[0];){if(e[0].nodeType==x.NODE_ELEMENT){if(!this.lastElement)this.lastElement=e;var B=e._4e_name();if(!f){if(!h&&u[B])h=e;if(s[B]){var i;if(i=!h){if(i=B=="div"){a:{i=e;i=i[0]||i;i=i.childNodes;for(var a=0,b=i.length;a<b;a++){var d=i[a];if(d.nodeType==x.NODE_ELEMENT&&H.$block[d.nodeName.toLowerCase()]){i=true;break a}}i=false}i=!i}i=i}if(i)h=e;else f=e}}k.push(e);if(B=="body")break}e=e.parent()}this.block=this.block=
h;this.blockLimit=this.blockLimit=f;this.elements=this.elements=k}var D=KISSY.DOM,H=r.XHTML_DTD,x=r.NODE,z=null,u={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},s={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};A.prototype={compare:function(e){var h=this.elements;e=e&&e.elements;if(!e||h.length!=e.length)return false;for(var f=0;f<h.length;f++)if(!D._4e_equals(h[f],e[f]))return false;return true},contains:function(e){for(var h=this.elements,f=0;f<
h.length;f++)if(h[f]._4e_name()in e)return h[f];return z}};r.ElementPath=r.ElementPath=A;var o=A.prototype;r.Utils.extern(o,{compare:o.compare,contains:o.contains})});
KISSY.Editor.add("walker",function(r){function A(k,B){if(this._.end)return u;var i,a=this.range,b,d=this.guard,j=this.type,y=k?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;a.trim();if(a.collapsed){this.end();return u}}if(!k&&!this._.guardLTR){var p=a.endContainer,m=new h(p[0].childNodes[a.endOffset]);this._.guardLTR=function(v,c){return(v=e._4e_wrap(v))&&v[0]&&(!c||!e._4e_equals(p,v))&&(!m[0]||!v._4e_equals(m))&&(v[0].nodeType!=o.NODE_ELEMENT||!c||v._4e_name()!="body")}}if(k&&
!this._.guardRTL){var l=a.startContainer,w=a.startOffset>0&&new h(l[0].childNodes[a.startOffset-1]);this._.guardRTL=function(v,c){return(v=e._4e_wrap(v))&&v[0]&&(!c||!v._4e_equals(l))&&(!w[0]||!v._4e_equals(w))&&(v[0].nodeType!=o.NODE_ELEMENT||!c||v._4e_name()!="body")}}var J=k?this._.guardRTL:this._.guardLTR;b=d?function(v,c){if(J(v,c)===z)return z;return d(v,c)}:J;if(this.current)i=this.current[y](z,j,b);else if(k){i=a.endContainer;if(a.endOffset>0){i=new h(i[0].childNodes[a.endOffset-1]);if(b(i)===
z)i=u}else i=b(i,x)===z?u:i._4e_previousSourceNode(x,j,b)}else{i=a.startContainer;if((i=new h(i[0].childNodes[a.startOffset]))&&i[0]){if(b(i)===z)i=u}else i=b(a.startContainer,x)===z?u:a.startContainer._4e_nextSourceNode(x,j,b)}for(;i&&i[0]&&!this._.end;){this.current=i;if(!this.evaluator||this.evaluator(i)!==z){if(!B)return i}else if(B&&this.evaluator)return z;i=i[y](z,j,b)}this.end();return this.current=u}function D(k){for(var B,i=u;B=A.call(this,k);)i=B;return i}function H(k){this.range=k;this._=
{}}var x=true,z=false,u=null,s=KISSY,o=r.NODE,e=s.DOM,h=s.Node;s.augment(H,{end:function(){this._.end=1},next:function(){return A.call(this)},previous:function(){return A.call(this,x)},checkForward:function(){return A.call(this,z,x)!==z},checkBackward:function(){return A.call(this,x,x)!==z},lastForward:function(){return D.call(this)},lastBackward:function(){return D.call(this,x)},reset:function(){delete this.current;this._={}}});H.blockBoundary=function(k){return function(B){B=e._4e_wrap(B);return!(B&&
B[0].nodeType==o.NODE_ELEMENT&&B._4e_isBlockBoundary(k))}};H.listItemBoundary=function(){return this.blockBoundary({br:1})};H.bookmark=function(k,B){function i(a){return a&&a[0]&&a._4e_name()=="span"&&a.attr("_ke_bookmark")}return function(a){var b,d;b=a&&a[0]&&a[0].nodeType==o.NODE_TEXT&&(d=a.parent())&&i(d);b=k?b:b||i(a);return B^b}};H.whitespaces=function(k){return function(B){B=(B=B[0]||B)&&B.nodeType==o.NODE_TEXT&&!s.trim(B.nodeValue);return k^B}};H.invisible=function(k){var B=H.whitespaces();
return function(i){i=B(i)||i[0].nodeType==o.NODE_ELEMENT&&!i[0].offsetHeight;return k^i}};r.Walker=H;r.Walker=H;var f=H.prototype;r.Utils.extern(f,{end:f.end,next:f.next,previous:f.previous,checkForward:f.checkForward,checkBackward:f.checkBackward,lastForward:f.lastForward,lastBackward:f.lastBackward,reset:f.reset});r.Utils.extern(H,{blockBoundary:H.blockBoundary,listItemBoundary:H.listItemBoundary,bookmark:H.bookmark,whitespaces:H.whitespaces,invisible:H.invisible})});
KISSY.Editor.add("range",function(r){function A(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=e;this.collapsed=s;this.document=c}function D(c){var g=c[0].nodeType!=f.NODE_TEXT&&c._4e_name()in j.$removeEmpty,q=!h.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return g||q||c}function H(c){return!w(c)&&!J(c)}function x(c){var g=o,q=i.bookmark(s);return function(t){if(q(t))return s;if(t[0].nodeType==f.NODE_TEXT){if(h.trim(t[0].nodeValue).length)return o}else if(t[0].nodeType==
f.NODE_ELEMENT)if(!l[t._4e_name()])if(!c&&!d.ie&&t._4e_name()=="br"&&!g)g=s;else return o;return s}}function z(c,g){function q(t){return t&&t.nodeName=="span"&&t.getAttribute("_ke_bookmark")}return function(t){var n,C;n=t&&!t.nodeName&&(C=t.parentNode)&&q(C);n=c?n:n||q(t);return g^n}}function u(c){return function(g){g=(g=g[0]||g)&&g.nodeType==f.NODE_TEXT&&!h.trim(g.nodeValue);return c^g}}r.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};r.RANGE=r.RANGE;var s=true,o=false,e=null,h=KISSY,f=r.NODE,k=r.RANGE,B=r.POSITION,i=r.Walker,a=h.DOM,b=r.Utils.getByAddress,d=h.UA,j=r.XHTML_DTD,y=r.ElementPath,p=h.Node,m={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};A.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return c.join("<br/>")};h.augment(A,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,g=this.startOffset;if(c[0].nodeType!=f.NODE_ELEMENT)if(g)g>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;g=this.endOffset;if(c[0].nodeType!=f.NODE_ELEMENT)if(g)g>=
c[0].nodeValue.length&&this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,g=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,k.POSITION_BEFORE_START);
g&&g._4e_name()=="span"&&g.attr("_ke_bookmark")&&this.setEndAt(g,k.POSITION_AFTER_END)},setStart:function(c,g){if(c[0].nodeType==f.NODE_ELEMENT&&m[c._4e_name()]){c=c.parent();g=c._4e_index()}this.startContainer=c;this.startOffset=g;if(!this.endContainer){this.endContainer=c;this.endOffset=g}this.updateCollapsed()},setEnd:function(c,g){if(c[0].nodeType==f.NODE_ELEMENT&&m[c._4e_name()]){c=c.parent();g=c._4e_index()+1}this.endContainer=c;this.endOffset=g;if(!this.startContainer){this.startContainer=
c;this.startOffset=g}this.updateCollapsed()},setStartAt:function(c,g){switch(g){case k.POSITION_AFTER_START:this.setStart(c,0);break;case k.POSITION_BEFORE_END:c[0].nodeType==f.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case k.POSITION_BEFORE_START:this.setStartBefore(c);break;case k.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,g){switch(g){case k.POSITION_AFTER_START:this.setEnd(c,0);break;case k.POSITION_BEFORE_END:c[0].nodeType==
f.NODE_TEXT?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case k.POSITION_BEFORE_START:this.setEndBefore(c);break;case k.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,g){var q=this.startContainer,t=this.endContainer,n=this.startOffset,C=this.endOffset,P,M=this.document,O;this.optimizeBookmark();if(t[0].nodeType==f.NODE_TEXT)t=t._4e_splitText(C);else if(t[0].childNodes.length>0)if(C>=t[0].childNodes.length){t=new p(t[0].appendChild(M.createTextNode("")));
O=s}else t=new p(t[0].childNodes[C]);if(q[0].nodeType==f.NODE_TEXT){q._4e_splitText(n);if(q._4e_equals(t))t=new p(q[0].nextSibling)}else if(n)if(n>=q[0].childNodes.length){P=new p(M.createTextNode(""));q.append(P);q=P;P=s}else q=new p(q[0].childNodes[n].previousSibling);else{P=new p(M.createTextNode(""));q.prepend(P);q=P;P=s}n=q._4e_parents();C=t._4e_parents();var Q,U,S;for(Q=0;Q<n.length;Q++){U=n[Q];S=C[Q];if(!U._4e_equals(S))break}M=g;for(var T,V,E,K=Q;K<n.length;K++){T=n[K];V=M&&!T._4e_equals(q)?
M.appendChild(T._4e_clone()[0]):null;for(T=T[0].nextSibling;T;){if(a._4e_equals(C[K],T)||a._4e_equals(t,T))break;E=T.nextSibling;if(c==2)M.appendChild(T.cloneNode(s));else{a._4e_remove(T);c==1&&M.appendChild(T)}T=E}if(V)M=V}M=g;for(Q=Q;Q<C.length;Q++){T=C[Q];V=M&&c>0&&!T._4e_equals(t)?M.appendChild(T._4e_clone()[0]):null;if(!n[Q]||!T.parent()._4e_equals(n[Q].parent()))for(T=T[0].previousSibling;T;){if(a._4e_equals(n[Q],T)||a._4e_equals(q,T))break;E=T.previousSibling;if(c==2)M.insertBefore(T.cloneNode(s),
M.firstChild);else{a._4e_remove(T);c==1&&M.insertBefore(T,M.firstChild)}T=E}if(V)M=V}if(c==2){S=this.startContainer[0];if(S.nodeType==f.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==f.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}S=this.endContainer[0];if(S.nodeType==f.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==f.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}}else{if(U&&S&&(!q.parent()._4e_equals(U.parent())||!t.parent()._4e_equals(S.parent()))){U=
S._4e_index();P&&S.parent()._4e_equals(q.parent())&&U--;this.setStart(S.parent(),U)}this.collapse(s)}P&&q._4e_remove();O&&t[0].parentNode&&t._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=s},clone:function(){var c=new A(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;c.endContainer=this.endContainer;c.endOffset=
this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=f.NODE_ELEMENT||c.endContainer[0].nodeType!=f.NODE_ELEMENT)return e;var g=new r.Walker(c),q=z(s,undefined),t=u(s);c.evaluator=function(n){return t(n)&&q(n)};c=g.next();g.reset();g=g.previous();return c&&c._4e_equals(g)?c:e},shrink:function(c,g){if(!this.collapsed){c=c||k.SHRINK_TEXT;var q=this.clone(),t=this.startContainer,n=this.endContainer,C=this.startOffset,
P=this.endOffset,M=1,O=1;if(t&&t[0].nodeType==f.NODE_TEXT)if(C)if(C>=t[0].nodeValue.length)q.setStartAfter(t);else{q.setStartBefore(t);M=0}else q.setStartBefore(t);if(n&&n[0].nodeType==f.NODE_TEXT)if(P)if(P>=n[0].nodeValue.length)q.setEndAfter(n);else{q.setEndAfter(n);O=0}else q.setEndBefore(n);q=new i(q);q.evaluator=function(U){U=U[0]||U;return U.nodeType==(c==k.SHRINK_ELEMENT?f.NODE_ELEMENT:f.NODE_TEXT)};var Q;q.guard=function(U,S){U=U[0]||U;if(c==k.SHRINK_ELEMENT&&U.nodeType==f.NODE_TEXT)return o;
if(S&&U==Q)return o;if(!S&&U.nodeType==f.NODE_ELEMENT)Q=U;return s};if(M)(t=q[c==k.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(t,g?k.POSITION_AFTER_START:k.POSITION_BEFORE_START);if(O){q.reset();(q=q[c==k.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(q,g?k.POSITION_BEFORE_END:k.POSITION_AFTER_END)}return!!(M||O)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||c[0].nodeType!=f.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var g=
this.startContainer,q=this.endContainer,t=this.startOffset,n=this.endOffset,C,P;if(!g||!q)return{start:0,end:0};if(c){if(g[0].nodeType==f.NODE_ELEMENT)if((C=new p(g[0].childNodes[t]))&&C[0]&&C[0].nodeType==f.NODE_TEXT&&t>0&&C[0].previousSibling.nodeType==f.NODE_TEXT){g=C;t=0}for(;g[0].nodeType==f.NODE_TEXT&&(P=g._4e_previous())&&P[0].nodeType==f.NODE_TEXT;){g=P;t+=P[0].nodeValue.length}if(!this.collapsed){if(q[0].nodeType==f.NODE_ELEMENT)if((C=new p(q[0].childNodes[n]))&&C[0]&&C[0].nodeType==f.NODE_TEXT&&
n>0&&C[0].previousSibling.nodeType==f.NODE_TEXT){q=C;n=0}for(;q[0].nodeType==f.NODE_TEXT&&(P=q._4e_previous())&&P[0].nodeType==f.NODE_TEXT;){q=P;n+=P[0].nodeValue.length}}}return{start:g._4e_address(c),end:this.collapsed?e:q._4e_address(c),startOffset:t,endOffset:n,normalized:c,is2:s}},createBookmark:function(c){var g,q,t,n,C=this.collapsed;g=new p("<span>",e,this.document);g.attr("_ke_bookmark",1);g.css("display","none");g.html("&nbsp;");if(c){t=h.guid("ke_bm_");g.attr("id",t+"S")}if(!C){q=g._4e_clone();
q.html("&nbsp;");c&&q.attr("id",t+"E");n=this.clone();n.collapse();n.insertNode(q)}n=this.clone();n.collapse(s);n.insertNode(g);if(q){this.setStartAfter(g);this.setEndBefore(q)}else this.moveToPosition(g,k.POSITION_AFTER_END);return{startNode:c?t+"S":g,endNode:c?t+"E":q,serializable:c,collapsed:C}},moveToPosition:function(c,g){this.setStartAt(c,g);this.collapse(s)},trim:function(c,g){var q=this.startContainer,t=this.startOffset,n=this.collapsed;if((!c||n)&&q[0]&&q[0].nodeType==f.NODE_TEXT){if(t)if(t>=
q[0].nodeValue.length){t=q._4e_index()+1;q=q.parent()}else{var C=q._4e_splitText(t);t=q._4e_index()+1;q=q.parent();if(a._4e_equals(this.startContainer,this.endContainer))this.setEnd(C,this.endOffset-this.startOffset);else if(a._4e_equals(q,this.endContainer))this.endOffset+=1}else{t=q._4e_index();q=q.parent()}this.setStart(q,t);if(n){this.collapse(s);return}}q=this.endContainer;t=this.endOffset;if(!(g||n)&&q[0]&&q[0].nodeType==f.NODE_TEXT){if(t){t>=q.nodeValue.length||q._4e_splitText(t);t=q._4e_index()+
1}else t=q._4e_index();q=q.parent();this.setEnd(q,t)}},insertNode:function(c){this.optimizeBookmark();this.trim(o,s);var g=this.startContainer;g[0].insertBefore(c[0]||c,g[0].childNodes[this.startOffset]||null);a._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var g=b(this.document,c.start,c.normalized),q=c.startOffset,t=c.end&&b(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(g,q);t?this.setEnd(t,c):this.collapse(s)}else{g=
(q=c.serializable)?h.one("#"+c.startNode,this.document):c.startNode;c=q?h.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(g);g._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(s)}},getCommonAncestor:function(c,g){var q=this.startContainer,t=this.endContainer;q=a._4e_equals(q,t)?c&&q[0].nodeType==f.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new p(q[0].childNodes[this.startOffset]):q:q._4e_commonAncestor(t);return g&&q[0].nodeType==f.NODE_TEXT?q.parent():
q},enlarge:function(c){switch(c){case k.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var g=new p(this.document.body),q,t,n,C,P,M=o,O,Q;O=this.startContainer;Q=this.startOffset;if(O[0].nodeType==f.NODE_TEXT){if(Q){O=!h.trim(O[0].nodeValue.substring(0,Q)).length&&O;M=!!O}if(O)if(!(C=O[0].previousSibling))n=O.parent()}else{if(Q)C=O[0].childNodes[Q-1]||O[0].lastChild;C||(n=O)}for(;n||C;){if(n&&!C){if(!P&&a._4e_equals(n,c))P=s;if(!g.contains(n))break;if(!M||n.css("display")!="inline"){M=
o;if(P)q=n;else this.setStartBefore(n)}C=n[0].previousSibling}for(;C;){O=o;if(C.nodeType==f.NODE_TEXT){Q=C.nodeValue;if(/[^\s\ufeff]/.test(Q))C=e;O=/[\s\ufeff]$/.test(Q)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(M&&j.$removeEmpty[C.nodeName.toLowerCase()]){Q=a.text(C);if(/[^\s\ufeff]/.test(Q))C=e;else for(var U=C.all||C.getElementsByTagName("*"),S=0,T;T=U[S++];)if(!j.$removeEmpty[T.nodeName.toLowerCase()]){C=e;break}if(C)O=!!Q.length}else C=e;if(O)if(M)if(P)q=n;else n&&this.setStartBefore(n);
else M=s;if(C){O=C.previousSibling;if(!n&&!O){n=new p(C);C=e;break}C=O}else n=e}if(n)n=n.parent()}O=this.endContainer;Q=this.endOffset;n=C=e;P=M=o;if(O[0].nodeType==f.NODE_TEXT){O=!h.trim(O[0].nodeValue.substring(Q)).length&&O;M=!(O&&O[0].nodeValue.length);if(O)if(!(C=O[0].nextSibling))n=O.parent()}else(C=O[0].childNodes[Q])||(n=O);for(;n||C;){if(n&&!C){if(!P&&a._4e_equals(n,c))P=s;if(!g.contains(n))break;if(!M||n.css("display")!="inline"){M=o;if(P)t=n;else n&&this.setEndAfter(n)}C=n[0].nextSibling}for(;C;){O=
o;if(C.nodeType==f.NODE_TEXT){Q=C.nodeValue;if(/[^\s\ufeff]/.test(Q))C=e;O=/^[\s\ufeff]/.test(Q)}else if(C.offsetWidth>0&&!C.getAttribute("_ke_bookmark"))if(M&&j.$removeEmpty[C.nodeName.toLowerCase()]){Q=a.text(C);if(/[^\s\ufeff]/.test(Q))C=e;else{U=C.all||C.getElementsByTagName("*");for(S=0;T=U[S++];)if(!j.$removeEmpty[T.nodeName.toLowerCase()]){C=e;break}}if(C)O=!!Q.length}else C=e;if(O)if(M)if(P)t=n;else this.setEndAfter(n);if(C){O=C.nextSibling;if(!n&&!O){n=new p(C);C=e;break}C=O}else n=e}if(n)n=
n.parent()}if(q&&t){c=q.contains(t)?t:q;this.setStartBefore(c);this.setEndAfter(c)}break;case k.ENLARGE_BLOCK_CONTENTS:case k.ENLARGE_LIST_ITEM_CONTENTS:n=new A(this.document);g=new p(this.document.body);n.setStartAt(g,k.POSITION_AFTER_START);n.setEnd(this.startContainer,this.startOffset);n=new i(n);var V,E,K=i.blockBoundary(c==k.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:e),G=function(F){var I=K(F);I||(V=F);return I};q=function(F){var I=G(F);if(!I&&F[0]&&F._4e_name()=="br")E=F;return I};n.guard=G;n=n.lastBackward();
V=V||g;this.setStartAt(V,V._4e_name()!="br"&&(!n&&this.checkStartOfBlock()||n&&V.contains(n))?k.POSITION_AFTER_START:k.POSITION_AFTER_END);n=this.clone();n.collapse();n.setEndAt(g,k.POSITION_BEFORE_END);n=new i(n);n.guard=c==k.ENLARGE_LIST_ITEM_CONTENTS?q:G;V=e;n=n.lastForward();V=V||g;this.setEndAt(V,!n&&this.checkEndOfBlock()||n&&V.contains(n)?k.POSITION_BEFORE_END:k.POSITION_BEFORE_START);E&&this.setEndAfter(E)}},checkStartOfBlock:function(){var c=this.startContainer,g=this.startOffset;if(g&&c[0].nodeType==
f.NODE_TEXT)if(h.trim(c[0].nodeValue.substring(0,g)).length)return o;this.trim();c=new y(this.startContainer);g=this.clone();g.collapse(s);g.setStartAt(c.block||c.blockLimit,k.POSITION_AFTER_START);c=new i(g);c.evaluator=x(s);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,g=this.endOffset;if(c[0].nodeType==f.NODE_TEXT)if(h.trim(c[0].nodeValue.substring(g)).length)return o;this.trim();c=new y(this.endContainer);g=this.clone();g.collapse(o);g.setEndAt(c.block||c.blockLimit,
k.POSITION_BEFORE_END);c=new i(g);c.evaluator=x(o);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,g){var q=this.clone();q[g==k.START?"setStartAt":"setEndAt"](c,g==k.START?k.POSITION_AFTER_START:k.POSITION_BEFORE_END);q=new i(q);q.evaluator=D;return q[g==k.START?"checkBackward":"checkForward"]()},
getBoundaryNodes:function(){var c=this.startContainer,g=this.endContainer,q=this.startOffset,t=this.endOffset,n;if(c[0].nodeType==f.NODE_ELEMENT){n=c[0].childNodes.length;if(n>q)c=new p(c[0].childNodes[q]);else if(n<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new p(c);c=c._4e_nextSourceNode()||c}}if(g[0].nodeType==f.NODE_ELEMENT){n=g[0].childNodes.length;if(n>t)g=(new p(g[0].childNodes[t]))._4e_previousSourceNode(s);else if(n<1)g=g._4e_previousSourceNode();else{for(g=
g[0];g.lastChild;)g=g.lastChild;g=new p(g)}}if(c._4e_position(g)&B.POSITION_FOLLOWING)c=g;return{startNode:c,endNode:g}},fixBlock:function(c,g){var q=this.createBookmark(),t=new p(this.document.createElement(g));this.collapse(c);this.enlarge(k.ENLARGE_BLOCK_CONTENTS);t[0].appendChild(this.extractContents());t._4e_trim();d.ie||t._4e_appendBogus();this.insertNode(t);this.moveToBookmark(q);return t},splitBlock:function(c){var g=new y(this.startContainer),q=new y(this.endContainer),t=g.block,n=q.block,
C=e;if(!g.blockLimit._4e_equals(q.blockLimit))return e;if(c!="br"){if(!t){t=this.fixBlock(s,c);n=(new y(this.endContainer)).block}n||(n=this.fixBlock(o,c))}c=t&&this.checkStartOfBlock();g=n&&this.checkEndOfBlock();this.deleteContents();if(t&&a._4e_equals(t,n))if(g){C=new y(this.startContainer);this.moveToPosition(n,k.POSITION_AFTER_END);n=e}else if(c){C=new y(this.startContainer);this.moveToPosition(t,k.POSITION_BEFORE_START);t=e}else{n=this.splitElement(t);!d.ie&&!h.inArray(t._4e_name(),["ul","ol"])&&
t._4e_appendBogus()}return{previousBlock:t,nextBlock:n,wasStartOfBlock:c,wasEndOfBlock:g,elementPath:C}},splitElement:function(c){if(!this.collapsed)return e;this.setEndAt(c,k.POSITION_BEFORE_END);var g=this.extractContents(),q=c._4e_clone(o);q[0].appendChild(g);q.insertAfter(c);this.moveToPosition(c,k.POSITION_AFTER_END);return q},moveToElementEditablePosition:function(c,g){var q,t=r.XHTML_DTD;if(t.$empty[c._4e_name()])return o;for(;c&&c[0].nodeType==f.NODE_ELEMENT;){if(q=c._4e_isEditable())this.moveToPosition(c,
g?k.POSITION_BEFORE_END:k.POSITION_AFTER_START);else if(t.$inline[c._4e_name()]){this.moveToPosition(c,g?k.POSITION_AFTER_END:k.POSITION_BEFORE_START);return s}if((c=t.$empty[c._4e_name()]?c[g?"_4e_previous":"_4e_next"](H):c[g?"_4e_last":"_4e_first"](H))&&c[0].nodeType==f.NODE_TEXT){this.moveToPosition(c,g?k.POSITION_AFTER_END:k.POSITION_BEFORE_START);return s}}return q},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==f.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});
var l={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},w=new i.whitespaces,J=new i.bookmark;r.Range=A;r.Range=A;var v=A.prototype;r.Utils.extern(v,{updateCollapsed:v.updateCollapsed,optimize:v.optimize,setStartAfter:v.setStartAfter,setEndAfter:v.setEndAfter,setStartBefore:v.setStartBefore,setEndBefore:v.setEndBefore,optimizeBookmark:v.optimizeBookmark,setStart:v.setStart,setEnd:v.setEnd,
setStartAt:v.setStartAt,setEndAt:v.setEndAt,execContentsAction:v.execContentsAction,collapse:v.collapse,clone:v.clone,getEnclosedNode:v.getEnclosedNode,shrink:v.shrink,getTouchedStartNode:v.getTouchedStartNode,createBookmark2:v.createBookmark2,createBookmark:v.createBookmark,moveToPosition:v.moveToPosition,trim:v.trim,insertNode:v.insertNode,moveToBookmark:v.moveToBookmark,getCommonAncestor:v.getCommonAncestor,enlarge:v.enlarge,checkStartOfBlock:v.checkStartOfBlock,checkEndOfBlock:v.checkEndOfBlock,
deleteContents:v.deleteContents,extractContents:v.extractContents,checkBoundaryOfElement:v.checkBoundaryOfElement,getBoundaryNodes:v.getBoundaryNodes,fixBlock:v.fixBlock,splitBlock:v.splitBlock,splitElement:v.splitElement,moveToElementEditablePosition:v.moveToElementEditablePosition,selectNodeContents:v.selectNodeContents})});
KISSY.Editor.add("domiterator",function(r){function A(i){if(!(arguments.length<1)){this.range=i;this.forceBrBreak=H;this.enlargeBr=D;this.enforceRealBlocks=H;this._||(this._={})}}var D=true,H=false,x=KISSY,z=x.UA,u=r.Walker,s=r.Range,o=r.RANGE,e=r.NODE,h=r.ElementPath,f=x.Node,k=x.DOM,B=/^[\r\n\t ]*$/;x.augment(A,{getNextParagraph:function(i){var a,b,d,j,y;if(!this._.lastNode){b=this.range.clone();b.shrink(o.SHRINK_ELEMENT,D);b.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:
o.ENLARGE_BLOCK_CONTENTS);var p=new u(b),m=u.bookmark(D,D);p.evaluator=m;this._.nextNode=p.next();p=new u(b);p.evaluator=m;p=p.previous();this._.lastNode=p._4e_nextSourceNode(D);if(this._.lastNode&&this._.lastNode[0].nodeType==e.NODE_TEXT&&!x.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){m=new s(b.document);m.moveToPosition(this._.lastNode,o.POSITION_AFTER_END);if(m.checkEndOfBlock()){m=new h(m.endContainer);this._.lastNode=(m.block||m.blockLimit)._4e_nextSourceNode(D)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new f(b.document.createTextNode(""));k.insertAfter(this._.lastNode[0],p[0])}b=null}m=this._.nextNode;p=this._.lastNode;for(this._.nextNode=null;m;){var l=H,w=m[0].nodeType!=e.NODE_ELEMENT,J=H;if(w){if(m[0].nodeType==e.NODE_TEXT)if(B.test(m[0].nodeValue))w=H}else{var v=m._4e_name();if(m._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(v=="br")w=D;else if(!b&&!m[0].childNodes.length&&v!="hr"){a=m;d=m._4e_equals(p);break}if(b){b.setEndAt(m,o.POSITION_BEFORE_START);if(v!="br")this._.nextNode=
m}l=D}else{if(m[0].firstChild){if(!b){b=new s(this.range.document);b.setStartAt(m,o.POSITION_BEFORE_START)}m=new f(m[0].firstChild);continue}w=D}}if(w&&!b){b=new s(this.range.document);b.setStartAt(m,o.POSITION_BEFORE_START)}d=(!l||w)&&m._4e_equals(p);if(b&&!l)for(;!m[0].nextSibling&&!d;){v=m.parent();if(v._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=D;d||v._4e_equals(p);break}m=v;w=D;d=m._4e_equals(p);J=D}w&&b.setEndAt(m,o.POSITION_AFTER_END);m=m._4e_nextSourceNode(J,null,p);if((d=!m)||l&&b)break}if(!a){if(!b){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new h(b.startContainer);m=a.blockLimit;l={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&l[m._4e_name()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=m;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new f(this.range.document.createElement(i||"p"));a[0].appendChild(b.extractContents());a._4e_trim();b.insertNode(a);j=y=D}else if(a._4e_name()!="li"){if(!b.checkStartOfBlock()||!b.checkEndOfBlock()){a=a._4e_clone(H);
a[0].appendChild(b.extractContents());a._4e_trim();y=b.splitBlock();j=!y.wasStartOfBlock;y=!y.wasEndOfBlock;b.insertNode(a)}}else if(!d)this._.nextNode=a._4e_equals(p)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(D,null,p)}if(j){b=new f(a[0].previousSibling);if(b[0]&&b[0].nodeType==e.NODE_ELEMENT)if(b._4e_name()=="br")b._4e_remove();else b[0].lastChild&&k._4e_name(b[0].lastChild)=="br"&&k._4e_remove(b[0].lastChild)}if(y){b=u.bookmark(H,D);j=new f(a[0].lastChild);if(j[0]&&j[0].nodeType==e.NODE_ELEMENT&&
j._4e_name()=="br")if(z.ie||j._4e_previous(b)||j._4e_next(b))j._4e_remove()}if(!this._.nextNode)this._.nextNode=d||a._4e_equals(p)?null:a._4e_nextSourceNode(D,null,p);return a}});s.prototype.createIterator=function(){return new A(this)}});
KISSY.Editor.add("selection",function(r){function A(m){this.document=this.document=m;this._={cache:{}};if(o.ie){var l=this.getNative().createRange();if(!l||l.item&&l.item(0).ownerDocument!=m||l.parentElement&&l.parentElement().ownerDocument!=m)this.isInvalid=x}}function D(m){m=new A(m);return!m||m.isInvalid?u:m}function H(m){var l=m.document,w=new f(l.body),J=new f(l.documentElement);if(o.ie){if(o.ie<8||document.documentMode==7)J.on("click",function(M){e._4e_name(M.target)==="html"&&m.getSelection().getRanges()[0].select()});
var v,c,g=1;J.on("mousedown",function(){g=0});J.on("mouseup",function(){g=1});w.on("focusin",function(M){if(e._4e_name(M.target)=="body")if(v){try{g&&v.select()}catch(O){}v=u}});w.on("focus",function(){c=x;t()});w.on("beforedeactivate",function(M){if(!M.relatedTarget){c=z;g=1}});h.on(e._4e_getWin(l),"blur",function(){l&&l.selection.empty()});w.on("mousedown",function(){q()});w.on("mouseup",function(){c=x;setTimeout(function(){t(x)},0)});var q=function(){c=z},t=function(M){if(c){var O=m.document,Q=
m.getSelection(),U=Q&&Q.getType(),S=Q&&Q.getNative();if(M&&S&&U==k.SELECTION_NONE)if(!O.queryCommandEnabled("InsertImage")){setTimeout(function(){t(x)},50);return}var T;if(!(S&&U==k.SELECTION_TEXT&&(T=e._4e_name(S.createRange().parentElement()))&&T in{input:1,textarea:1})){v=S&&Q.getRanges()[0];m._monitor()}}};w.on("keydown",q);w.on("keyup",function(){c=x;t()});h.on(l,"selectionchange",t)}else{h.on(l,"mouseup",m._monitor,m);h.on(l,"keyup",m._monitor,m)}var n={table:1,pre:1},C=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
P=r.Walker.whitespaces(x);m.on("selectionChange",function(M){var O=M.path;M=(M=M.selection)&&M.getRanges()[0];if(!(!M||!M.collapsed||O.block))if(O.blockLimit._4e_name()=="body"){O=M.fixBlock(x,"p");if(O._4e_outerHtml().match(C)){var Q=O._4e_next(P);if(Q&&Q[0].nodeType==i.NODE_ELEMENT&&!n[Q._4e_name()]){M.moveToElementEditablePosition(Q);O._4e_remove()}else if((Q=O._4e_previous(P))&&Q[0].nodeType==i.NODE_ELEMENT&&!n[Q._4e_name()]){M.moveToElementEditablePosition(Q,Q._4e_outerHtml().match(C)?z:x);O._4e_remove()}}M.select();
o.ie||m.notifySelectionChange()}})}r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var x=true,z=false,u=null,s=KISSY,o=s.UA,e=s.DOM,h=s.Event,f=s.Node,k=r.SELECTION,B=r.RANGE,i=r.NODE,a=r.Walker,b=r.Range,d={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};s.augment(A,{getNative:o.ie?function(){var m=this._.cache;return m.nativeSel||(m.nativeSel=this.document.selection)}:function(){var m=
this._.cache;return m.nativeSel||(m.nativeSel=e._4e_getWin(this.document).getSelection())},getType:o.ie?function(){var m=this._.cache;if(m.type)return m.type;var l=k.SELECTION_NONE;try{var w=this.getNative(),J=w.type;if(J=="Text")l=k.SELECTION_TEXT;if(J=="Control")l=k.SELECTION_ELEMENT;if(w.createRange().parentElement)l=k.SELECTION_TEXT}catch(v){}return m.type=l}:function(){var m=this._.cache;if(m.type)return m.type;var l=k.SELECTION_TEXT,w=this.getNative();if(w){if(w.rangeCount==1){w=w.getRangeAt(0);
var J=w.startContainer;if(J==w.endContainer&&J.nodeType==i.NODE_ELEMENT&&w.endOffset-w.startOffset===1&&d[J.childNodes[w.startOffset].nodeName.toLowerCase()])l=k.SELECTION_ELEMENT}}else l=k.SELECTION_NONE;return m.type=l},getRanges:o.ie?function(){var m=function(l,w){l=l.duplicate();l.collapse(w);for(var J=l.parentElement(),v=J.childNodes,c,g=0;g<v.length;g++){var q=v[g];if(q.nodeType==i.NODE_ELEMENT){c=l.duplicate();c.moveToElementText(q);q=c.compareEndPoints("StartToStart",l);var t=c.compareEndPoints("EndToStart",
l);c.collapse();if(q>0)break;else if(!q||t==1&&q==-1)return{container:J,offset:g};else if(!t)return{container:J,offset:g+1};c=u}}if(!c){c=l.duplicate();c.moveToElementText(J);c.collapse(z)}c.setEndPoint("StartToStart",l);c=c.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;c>0;)c-=v[--g].nodeValue.length}catch(n){c=0}return c===0?{container:J,offset:g}:{container:v[g],offset:-c}};return function(){var l=this._.cache;if(l.ranges)return l.ranges;var w=this.getNative(),J=w&&w.createRange(),v=this.getType();
if(!w)return[];if(v==k.SELECTION_TEXT){w=new b(this.document);v=m(J,x);w.setStart(new f(v.container),v.offset);v=m(J);w.setEnd(new f(v.container),v.offset);return l.ranges=[w]}else if(v==k.SELECTION_ELEMENT){l=l.ranges=[];for(v=0;v<J.length;v++){var c=J.item(v),g=c.parentNode,q=0;for(w=new b(this.document);q<g.childNodes.length&&g.childNodes[q]!=c;q++);w.setStart(new f(g),q);w.setEnd(new f(g),q+1);l.push(w)}return l}return l.ranges=[]}}():function(){var m=this._.cache;if(m.ranges)return m.ranges;
var l=[],w=this.getNative();if(!w)return[];for(var J=0;J<w.rangeCount;J++){var v=w.getRangeAt(J),c=new b(this.document);c.setStart(new f(v.startContainer),v.startOffset);c.setEnd(new f(v.endContainer),v.endOffset);l.push(c)}return m.ranges=l},getStartElement:function(){var m=this._.cache;if(m.startElement!==undefined)return m.startElement;var l,w=this.getNative();switch(this.getType()){case k.SELECTION_ELEMENT:return this.getSelectedElement();case k.SELECTION_TEXT:var J=this.getRanges()[0];if(J)if(!J.collapsed){for(J.optimize();x;){l=
J.startContainer;if(J.startOffset==(l[0].nodeType===i.NODE_ELEMENT?l[0].childNodes.length:l[0].nodeValue.length)&&!l._4e_isBlockBoundary())J.setStartAfter(l);else break}l=J.startContainer;if(l[0].nodeType!=i.NODE_ELEMENT)return l.parent();l=new f(l[0].childNodes[J.startOffset]);if(!l[0]||l[0].nodeType!=i.NODE_ELEMENT)return J.startContainer;for(J=l[0].firstChild;J&&J.nodeType==i.NODE_ELEMENT;){l=new f(J);J=J.firstChild}return l}if(o.ie){J=w.createRange();J.collapse(x);l=J.parentElement()}else if((l=
w.anchorNode)&&l.nodeType!=i.NODE_ELEMENT)l=l.parentNode}return m.startElement=l?e._4e_wrap(l):u},getSelectedElement:function(){var m=this,l,w=m._.cache;if(w.selectedElement!==undefined)return w.selectedElement;if(o.ie){l=m.getNative().createRange();l=l.item&&l.item(0)}l||(l=function(){for(var J=m.getRanges()[0],v,c,g=2;g&&!((v=J.getEnclosedNode())&&v[0].nodeType==i.NODE_ELEMENT&&d[v._4e_name()]&&(c=v));g--)J.shrink(B.SHRINK_ELEMENT);return c&&c[0]}());return w.selectedElement=e._4e_wrap(l)},reset:function(){this._.cache=
{}},selectElement:function(m){var l;if(o.ie)try{l=this.document.body.createControlRange();l.addElement(m[0]);l.select()}catch(w){l=this.document.body.createTextRange();l.moveToElementText(m[0]);l.select()}finally{}else{l=this.document.createRange();l.selectNode(m[0]);m=this.getNative();m.removeAllRanges();m.addRange(l)}this.reset()},selectRanges:function(m){if(o.ie){if(m.length>1){var l=m[m.length-1];m[0].setEnd(l.endContainer,l.endOffset);m.length=1}m[0]&&m[0].select()}else{l=this.getNative();if(!l)return;
l.removeAllRanges();for(var w=0;w<m.length;w++){var J=m[w],v=this.document.createRange(),c=J.startContainer;J.collapsed&&o.gecko&&o.gecko<1.09&&c[0].nodeType==i.NODE_ELEMENT&&!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));v.setStart(c[0],J.startOffset);v.setEnd(J.endContainer[0],J.endOffset);l.addRange(v)}}this.reset()},createBookmarks2:function(m){for(var l=[],w=this.getRanges(),J=0;J<w.length;J++)l.push(w[J].createBookmark2(m));return l},createBookmarks:function(m,l){var w=
[],J=this.document,v;l=l||this.getRanges();for(var c=l.length,g=0;g<c;g++){w.push(v=l[g].createBookmark(m,x));var q=(m=v.serializable)?s.one("#"+v.startNode,J):v.startNode;v=m?s.one("#"+v.endNode,J):v.endNode;for(var t=g+1;t<c;t++){var n=l[t],C=n.startContainer,P=n.endContainer;e._4e_equals(C,q.parent())&&n.startOffset++;e._4e_equals(C,v.parent())&&n.startOffset++;e._4e_equals(P,q.parent())&&n.endOffset++;e._4e_equals(P,v.parent())&&n.endOffset++}}return w},selectBookmarks:function(m){for(var l=[],
w=0;w<m.length;w++){var J=new b(this.document);J.moveToBookmark(m[w]);l.push(J)}this.selectRanges(l);return this},getCommonAncestor:function(){var m=this.getRanges();return m[0].startContainer._4e_commonAncestor(m[m.length-1].endContainer)},scrollIntoView:function(){var m=this.getStartElement();m&&m._4e_scrollIntoView()},removeAllRanges:function(){var m=this.getNative();if(o.ie)m&&m.clear();else m&&m.removeAllRanges()}});var j={table:1,tbody:1,tr:1},y=a.whitespaces(x),p=/\ufeff|\u00a0/;b.prototype.select=
b.prototype.select=o.ie?function(m){var l=this.collapsed,w,J;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var v=this.startContainer[0].childNodes[this.startOffset];if(v.nodeType==i.NODE_ELEMENT){(new A(this.document)).selectElement(new f(v));return}}if(this.startContainer[0].nodeType==i.NODE_ELEMENT&&this.startContainer._4e_name()in j||this.endContainer[0].nodeType==i.NODE_ELEMENT&&this.endContainer._4e_name()in j)this.shrink(B.SHRINK_ELEMENT,x);var c=this.createBookmark();
v=c.startNode;var g;if(!l)g=c.endNode;c=this.document.body.createTextRange();c.moveToElementText(v[0]);c.moveStart("character",1);if(g){m=this.document.body.createTextRange();m.moveToElementText(g[0]);c.setEndPoint("EndToEnd",m);c.moveEnd("character",-1)}else{for(w=v[0].nextSibling;w&&!y(w);)w=w.nextSibling;w=!(w&&w.nodeValue&&w.nodeValue.match(p))&&(m||!v[0].previousSibling||v[0].previousSibling&&e._4e_name(v[0].previousSibling)=="br");J=this.document.createElement("span");J.innerHTML="&#65279;";
J=(new f(J)).insertBefore(v);w&&e.insertBefore(this.document.createTextNode("\ufeff"),v)}this.setStartBefore(v);v._4e_remove();if(l){if(w){c.moveStart("character",-1);c.select();this.document.selection.clear()}else c.select();if(J){this.moveToPosition(J,B.POSITION_BEFORE_START);J._4e_remove()}}else{this.setEndBefore(g);g._4e_remove();c.select()}}:function(){var m=this.startContainer;this.collapsed&&m[0].nodeType==i.NODE_ELEMENT&&!m[0].childNodes.length&&m[0].appendChild(this.document.createTextNode(""));
var l=this.document.createRange();l.setStart(m[0],this.startOffset);try{l.setEnd(this.endContainer[0],this.endOffset)}catch(w){if(w.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(x);l.setEnd(this.endContainer[0],this.endOffset)}else throw w;}m=D(this.document).getNative();m.removeAllRanges();m.addRange(l)};A.getSelection=D;r.Selection=A;r.Selection=A;a=A.prototype;r.Utils.extern(a,{getNative:a.getNative,getType:a.getType,getRanges:a.getRanges,getStartElement:a.getStartElement,getSelectedElement:a.getSelectedElement,
reset:a.reset,selectElement:a.selectElement,selectRanges:a.selectRanges,createBookmarks2:a.createBookmarks2,createBookmarks:a.createBookmarks,getCommonAncestor:a.getCommonAncestor,scrollIntoView:a.scrollIntoView,selectBookmarks:a.selectBookmarks,removeAllRanges:a.removeAllRanges});r.on("instanceCreated",function(m){H(m.editor)})});
KISSY.Editor.add("styles",function(r){function A(E,K){for(var G in E)E[G]=E[G].replace(T,function(F,I){return K[I]})}function D(E,K){if(K){E=w.clone(E);A(E.attributes,K);A(E.styles,K)}var G=this.element=this.element=(E.element||"*").toLowerCase();this.type=this.type=G=="#"||Q[G]?c.STYLE_BLOCK:U[G]?c.STYLE_OBJECT:c.STYLE_INLINE;this._={definition:E}}function H(E,K){var G=K?this.removeFromRange:this.applyToRange;E.body.focus();for(var F=new q(E),I=F.getRanges(),N=0;N<I.length;N++)G.call(this,I[N]);
F.selectRanges(I)}function x(E,K){var G;G=E.element;if(G=="*")G="span";G=new P(K.createElement(G));return z(G,E)}function z(E,K){var G=K._.definition,F=G.attributes;G=D.getStyleText(G);if(F)for(var I in F)E.attr(I,F[I]);if(G)E[0].style.cssText=G;return E}function u(E){var K=E.createBookmark(p),G=E.createIterator();G.enforceRealBlocks=p;G.enlargeBr=p;for(var F,I=E.document;F=G.getNextParagraph();){var N=x(this,I);F=F;var L=N;N=L._4e_name=="pre";var R=F._4e_name=="pre",Z=!N&&R;if(N&&!R){R=F;L=L;Z=R.html();
Z=s(Z,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");Z=Z.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");Z=Z.replace(/([ \t\n\r]+|&nbsp;)/g," ");Z=Z.replace(/<br\b[^>]*>/gi,"\n");if(M.ie){R=R[0].ownerDocument.createElement("div");R.appendChild(L[0]);L[0].outerHTML="<pre>"+Z+"</pre>";L=new P(R.firstChild);L._4e_remove()}else L.html(Z);L=L}else if(Z)L=e(o(F),L);else F._4e_moveChildren(L);F[0].parentNode.replaceChild(L[0],F[0]);if(N){F=L;N=void 0;if((N=F._4e_previousSourceNode(p,t.NODE_ELEMENT))&&N._4e_name()==
"pre"){L=s(N.html(),/\n$/,"")+"\n\n"+s(F.html(),/^\n/,"");if(M.ie)F[0].outerHTML="<pre>"+L+"</pre>";else F.html(L);N._4e_remove()}}}E.moveToBookmark(K)}function s(E,K,G){var F="",I="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(N,L,R){L&&(F=L);R&&(I=R);return""});return F+E.replace(K,G)+I}function o(E){var K=[];s(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(G,F,I){return F+"</pre>"+I+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(G,F){K.push(F)});return K}function e(E,K){for(var G=K[0].ownerDocument.createDocumentFragment(),F=0;F<E.length;F++){var I=E[F];I=I.replace(/(\r\n|\r)/g,"\n");I=s(I,/^[ \t]*\n/,"");I=s(I,/\n$/,"");I=s(I,/^[ \t]+|[ \t]+$/g,function(L,R){return L.length==1?"&nbsp;":R?" "+Array(L.length).join("&nbsp;"):Array(L.length).join("&nbsp;")+" "});I=I.replace(/\n/g,"<br>");I=I.replace(/[ \t]{2,}/g,function(L){return Array(L.length).join("&nbsp;")+" "});var N=K._4e_clone();N.html(I);G.appendChild(N[0])}return G}
function h(E){var K=E.document;if(E.collapsed){K=x(this,K);E.insertNode(K);E.moveToPosition(K,g.POSITION_BEFORE_END)}else{var G=this.element,F=this._.definition,I,N=r.XHTML_DTD[G]||(I=p,r.XHTML_DTD.span),L=E.createBookmark();E.enlarge(g.ENLARGE_ELEMENT);E.trim();var R=E.createBookmark(),Z=R.startNode;R=R.endNode;for(var X=Z,$;X&&X[0];){var W=m;if(v._4e_equals(X,R)){X=l;W=p}else{var Y=X[0].nodeType,ca=Y==t.NODE_ELEMENT?X._4e_name():l;if(ca&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(p);continue}if(!ca||
N[ca]&&(X._4e_position(R)|n.POSITION_PRECEDING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_PRECEDING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED&&(!F.childRule||F.childRule(X))){var da=X.parent();if(da&&da[0]&&((r.XHTML_DTD[da._4e_name()]||r.XHTML_DTD.span)[G]||I)&&(!F.parentRule||F.parentRule(da))){if(!$&&(!ca||!r.XHTML_DTD.$removeEmpty[ca]||(X._4e_position(R)|n.POSITION_PRECEDING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_PRECEDING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED)){$=
new C(K);$.setStartBefore(X)}if(Y==t.NODE_TEXT||Y==t.NODE_ELEMENT&&!X[0].childNodes.length){Y=X;var aa;for(ca=Y._4e_next(function(fa){return!fa.attr("_ke_bookmark")});!ca&&(aa=Y.parent(),N[aa._4e_name()])&&(aa._4e_position(Z)|n.POSITION_FOLLOWING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_FOLLOWING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED&&(!F.childRule||F.childRule(aa));)Y=aa;$.setEndAfter(Y);Y[0].nextSibling||(W=p)}}else W=p}else W=p;X=X._4e_nextSourceNode()}if(W&&$&&!$.collapsed){W=
x(this,K);for(Y=$.getCommonAncestor();W&&Y&&W[0]&&Y[0];){if(Y._4e_name()==G){for(var ba in F.attributes)W.attr(ba)==Y.attr(ba)&&W[0].removeAttribute(ba);for(var ea in F.styles)W._4e_style(ea)==Y._4e_style(ea)&&W._4e_style(ea,"");if(!W._4e_hasAttributes()){W=l;break}}Y=Y.parent()}if(W){W[0].appendChild($.extractContents());d(this,W);$.insertNode(W);W._4e_mergeSiblings();M.ie||W[0].normalize()}$=l}}Z._4e_remove();R._4e_remove();E.moveToBookmark(L);E.shrink(g.SHRINK_TEXT)}}function f(E){E.enlarge(g.ENLARGE_ELEMENT);
var K=E.createBookmark(),G=K.startNode;if(E.collapsed){for(var F=new O(G.parent()),I,N=0,L;N<F.elements.length&&(L=F.elements[N]);N++){if(L==F.block||L==F.blockLimit)break;if(this.checkElementRemovable(L)){var R=E.checkBoundaryOfElement(L,g.END),Z=!R&&E.checkBoundaryOfElement(L,g.START);if(Z||R){I=L;I.match=Z?"start":"end"}else{L._4e_mergeSiblings();L._4e_name()==this.element?a(this,L):j(L,i(this)[L._4e_name()])}}}if(I&&I[0]){L=G;for(N=0;;N++){R=F.elements[N];if(v._4e_equals(R,I))break;else if(R.match)continue;
else R=R._4e_clone();R[0].appendChild(L[0]);L=R}v[I.match=="start"?"insertBefore":"insertAfter"](L,I)}}else{var X=K.endNode,$=this;F=function(){for(var W=new O(G.parent()),Y=new O(X.parent()),ca=l,da=l,aa=0;aa<W.elements.length;aa++){var ba=W.elements[aa];if(ba==W.block||ba==W.blockLimit)break;if($.checkElementRemovable(ba))ca=ba}for(aa=0;aa<Y.elements.length;aa++){ba=Y.elements[aa];if(ba==Y.block||ba==Y.blockLimit)break;if($.checkElementRemovable(ba))da=ba}da&&X._4e_breakParent(da);ca&&G._4e_breakParent(ca)};
F();for(I=new P(G[0].nextSibling);I[0]!==X[0];){N=I._4e_nextSourceNode();if(I[0]&&I[0].nodeType==t.NODE_ELEMENT&&this.checkElementRemovable(I)){I._4e_name()==this.element?a(this,I):j(I,i(this)[I._4e_name()]);if(N[0].nodeType==t.NODE_ELEMENT&&N.contains(G)){F();N=new P(G[0].nextSibling)}}I=N}}E.moveToBookmark(K)}function k(E){var K={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,F,I){K[F]=I});return K}function B(E,K){var G;if(K!==m){G=document.createElement("span");
G.style.cssText=E;G=G.style.cssText||""}else G=E;return G.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function i(E){if(E._.overrides)return E._.overrides;var K=E._.overrides={},G=E._.definition.overrides;if(G){w.isArray(G)||(G=[G]);for(var F=0;F<G.length;F++){var I=G[F],N,L;if(typeof I=="string")N=I.toLowerCase();else{N=I.element?I.element.toLowerCase():E.element;L=I.attributes}I=K[N]||(K[N]={});if(L){I=I.attributes=I.attributes||[];for(var R in L)I.push([R.toLowerCase(),
L[R]])}}}return K}function a(E,K){var G=E._.definition,F=J.mix(G.attributes,i(E)[K._4e_name()]);G=G.styles;var I=w.isEmptyObject(F)&&w.isEmptyObject(G),N;for(N in F)if(!((N=="class"||E._.definition.fullMatch)&&K.attr(N)!=b(N,F[N]))){I=I||!!K._4e_hasAttribute(N);K.removeAttr(N)}for(var L in G)if(!(E._.definition.fullMatch&&K._4e_style(L)!=b(L,G[L],p))){I=I||!!K._4e_style(L);K._4e_style(L,"")}y(K)}function b(E,K,G){var F=new P("<span>");F[G?"_4e_style":"attr"](E,K);return F[G?"_4e_style":"attr"](E)}
function d(E,K){for(var G=i(E),F=K.all(E.element),I=F.length;--I>=0;)a(E,new P(F[I]));for(var N in G)if(N!=E.element){F=K.all(N);for(I=F.length-1;I>=0;I--){var L=new P(F[I]);j(L,G[N])}}}function j(E,K){var G=K&&K.attributes;if(G)for(var F=0;F<G.length;F++){var I=G[F][0],N;if(N=E.attr(I)){var L=G[F][1];if(L===l||L.test&&L.test(N)||typeof L=="string"&&N==L)E[0].removeAttribute(I)}}y(E)}function y(E){if(!E._4e_hasAttributes()){var K=E[0].firstChild,G=E[0].lastChild;E._4e_remove(p);if(K){K.nodeType==
t.NODE_ELEMENT&&v._4e_mergeSiblings(K);G&&K!=G&&G.nodeType==t.NODE_ELEMENT&&v._4e_mergeSiblings(G)}}}var p=true,m=false,l=null,w=KISSY,J=r.Utils,v=w.DOM,c={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},g=r.RANGE,q=r.Selection,t=r.NODE,n=r.POSITION,C=r.Range,P=w.Node,M=w.UA,O=r.ElementPath,Q={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},U={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},S=/\s*(?:;\s*|$)/,T=/#\((.+?)\)/g;r.STYLE=c;D.prototype={apply:function(E){H.call(this,
E,m)},remove:function(E){H.call(this,E,p)},applyToRange:function(E){return(this.applyToRange=this.type==c.STYLE_INLINE?h:this.type==c.STYLE_BLOCK?u:this.type==c.STYLE_OBJECT?l:l).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==c.STYLE_INLINE?f:l).call(this,E)},applyToObject:function(E){z(E,this)},checkElementRemovable:function(E,K){if(!E)return m;var G=this._.definition;if(E._4e_name()==this.element){if(!K&&!E._4e_hasAttributes())return p;var F=G._AC;if(F)G=F;else{F=
{};var I=0,N=G.attributes;if(N)for(var L in N){I++;F[L]=N[L]}if(N=D.getStyleText(G)){F.style||I++;F.style=N}F._length=I;G=G._AC=F}if(G._length){for(var R in G)if(R!="_length"){I=E.attr(R)||"";if(R=="style")a:{F=G[R];I=B(I,m);typeof F=="string"&&(F=k(F));typeof I=="string"&&(I=k(I));N=void 0;for(N in F)if(!(N in I&&(I[N]==F[N]||F[N]=="inherit"||I[N]=="inherit"))){F=m;break a}F=p}else F=G[R]==I;if(F){if(!K)return p}else if(K)return m}if(K)return p}else return p}if(R=i(this)[E._4e_name()]){if(!(G=R.attributes))return p;
for(F=0;F<G.length;F++){R=G[F][0];if(R=E.attr(R)){I=G[F][1];if(I===l||typeof I=="string"&&R==I||I.test&&I.test(R))return p}}}return m},checkActive:function(E){switch(this.type){case c.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,p);case c.STYLE_OBJECT:case c.STYLE_INLINE:for(var K=E.elements,G=0,F;G<K.length;G++){F=K[G];if(!(this.type==c.STYLE_INLINE&&(v._4e_equals(F,E.block)||v._4e_equals(F,E.blockLimit))))if(!(this.type==c.STYLE_OBJECT&&!(F._4e_name()in U)))if(this.checkElementRemovable(F,
p))return p}}return m}};D.getStyleText=function(E){var K=E._ST;if(K)return K;K=E.styles;var G=E.attributes&&E.attributes.style||"",F="";if(G.length)G=G.replace(S,";");for(var I in K){var N=K[I],L=(I+":"+N).replace(S,";");if(N=="inherit")F+=L;else G+=L}if(G.length)G=B(G);G+=F;return E._ST=G};r.Style=D;r.Style=D;var V=D.prototype;r.Utils.extern(V,{apply:V.apply,remove:V.remove,applyToRange:V.applyToRange,removeFromRange:V.removeFromRange,applyToObject:V.applyToObject,checkElementRemovable:V.checkElementRemovable,
checkActive:V.checkActive})});
KISSY.Editor.add("htmlparser",function(){function r(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var A=KISSY,D=function(){},H=A.Editor,x=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,z={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},u=H.XHTML_DTD;A.augment(r,{onTagOpen:D,onTagClose:D,
onText:D,onCDATA:D,onComment:D,parse:function(s){for(var o,e,h=0,f;o=this._.htmlPartsRegex.exec(s);){e=o.index;if(e>h){h=s.substring(h,e);f?f.push(h):this.onText(h)}h=this._.htmlPartsRegex.lastIndex;if(e=o[1]){e=e.toLowerCase();if(f&&u.$cdata[e]){this.onCDATA(f.join(""));f=null}if(!f){this.onTagClose(e);continue}}if(f)f.push(o[0]);else if(e=o[3]){e=e.toLowerCase();if(!/="/.test(e)){var k={},B;o=o[4];var i=!!(o&&o.charAt(o.length-1)=="/");if(o)for(;B=x.exec(o);){var a=B[1].toLowerCase();B=B[2]||B[3]||
B[4]||"";k[a]=!B&&z[a]?a:B}this.onTagOpen(e,k,i);if(!f&&u.$cdata[e])f=[]}}else if(e=o[2])this.onComment(e)}s.length>h&&this.onText(s.substring(h,s.length))}});H.HtmlParser=r;H.HtmlParser=r});
KISSY.Editor.add("htmlparser-basicwriter",function(){function r(){this._={output:[]}}var A=KISSY,D=A.Editor,H=D.Utils;A.augment(r,{openTag:function(x){this._.output.push("<",x)},openTagClose:function(x,z){z?this._.output.push(" />"):this._.output.push(">")},attribute:function(x,z){if(typeof z=="string")z=H.htmlEncodeAttr(z);this._.output.push(" ",x,'="',z,'"')},closeTag:function(x){this._.output.push("</",x,">")},text:function(x){this._.output.push(x)},comment:function(x){this._.output.push("<!--",
x,"--\>")},write:function(x){this._.output.push(x)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(x){var z=this._.output.join("");x&&this.reset();return z}});D.HtmlParser.BasicWriter=r;D.HtmlParser.BasicWriter=r;A=r.prototype;D.Utils.extern(A,{openTag:A.openTag,openTagClose:A.openTagClose,attribute:A.attribute,closeTag:A.closeTag,text:A.text,comment:A.comment,write:A.write,reset:A.reset,getHtml:A.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function r(){r.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=z;this.sortAttributes=x;this._.indent=z;this._.indentation="";this._.rules={};var u=D.XHTML_DTD,s;for(s in H.mix({},u.$nonBodyContent,u.$block,u.$listItem,u.$tableContent))this.setRules(s,{indent:x,breakBeforeOpen:x,breakAfterOpen:x,breakBeforeClose:!u[s]["#"],breakAfterClose:x});this.setRules("br",
{breakAfterOpen:x});this.setRules("title",{indent:z,breakAfterOpen:z});this.setRules("style",{indent:z,breakBeforeClose:x});this.setRules("pre",{indent:z})}var A=KISSY,D=A.Editor,H=D.Utils,x=true,z=false;A.extend(r,D.HtmlParser.BasicWriter,{openTag:function(u){var s=this._.rules[u];if(this._.indent)this.indentation();else if(s&&s.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",u)},openTagClose:function(u,s){var o=this._.rules[u];if(s)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(o&&o.indent)this._.indentation+=this.indentationChars}o&&o.breakAfterOpen&&this.lineBreak()},attribute:function(u,s){if(typeof s=="string"){this.forceSimpleAmpersand&&(s=s.replace(/&amp;/g,"&"));s=H.htmlEncodeAttr(s)}this._.output.push(" ",u,'="',s,'"')},closeTag:function(u){var s=this._.rules[u];if(s&&s.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(s&&s.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",u,">");s&&s.breakAfterClose&&this.lineBreak()},text:function(u){if(this._.indent){this.indentation();u=H.ltrim(u)}this._.output.push(u)},comment:function(u){this._.indent&&this.indentation();this._.output.push("<!--",u,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=x},indentation:function(){this._.output.push(this._.indentation);this._.indent=z},setRules:function(u,s){var o=this._.rules[u];if(o)H.mix(o,
s);else this._.rules[u]=s}});D.HtmlParser.HtmlWriter=r;D.HtmlParser.HtmlWriter=r;A=r.prototype;D.Utils.extern(A,{openTag:A.openTag,openTagClose:A.openTagClose,attribute:A.attribute,closeTag:A.closeTag,text:A.text,comment:A.comment,lineBreak:A.lineBreak,indentation:A.indentation,setRules:A.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function r(){this.children=[];this.parent=H;this._={isBlockLike:A,hasInlineStarted:D}}var A=true,D=false,H=null,x=KISSY.Editor,z={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},u=KISSY,s=x.Utils,o=x.NODE,e=x.XHTML_DTD,h=s.mix({table:1,ul:1,ol:1,dl:1},e.table,e.ul,e.ol,e.dl),f=e.$list,k=e.$listItem;r.FromHtml=function(B,i){function a(g){var q;if(p.length>0)for(var t=0;t<p.length;t++){var n=p[t],C=n.name,P=e[C],M=l.name&&e[l.name];
if((!M||M[C])&&(!g||!P||P[g]||!e[g])){if(!q){b();q=1}n=n.clone();n.parent=l;l=n;p.splice(t,1);t--}}}function b(){for(;m.length;)l.add(m.shift())}function d(g,q,t){q=q||l||y;if(i&&!q.type){var n,C;if((n=g.attributes&&(C=g.attributes._ke_real_element_type)?C:g.name)&&!(n in e.$body)&&!(n in e.$nonBodyContent)){n=l;l=q;j.onTagOpen(i,{});q=l;if(t)l=n}}if(g._.isBlockLike&&g.name!="pre"){t=g.children.length;if((n=g.children[t-1])&&n.type==o.NODE_TEXT)if(C=s.rtrim(n.value))n.value=C;else g.children.length=
t-1}q.add(g);if(g.returnPoint){l=g.returnPoint;delete g.returnPoint}}var j=new x.HtmlParser,y=new r,p=[],m=[],l=y,w=D,J;j.onTagOpen=function(g,q,t){var n=new x.HtmlParser.Element(g,q);if(n.isUnknown&&t)n.isEmpty=A;if(e.$removeEmpty[g])p.push(n);else{if(g=="pre")w=A;else if(g=="br"&&w){l.add(new x.HtmlParser.Text("\n"));return}if(g=="br")m.push(n);else{var C=l.name,P=C&&(e[C]||(l._.isBlockLike?e.div:e.span));if(P&&!n.isUnknown&&!l.isUnknown&&!P[g]){P=D;var M;if(g in f&&C in f){C=l.children;(C=C[C.length-
1])&&C.name in k||d(C=new x.HtmlParser.Element("li"),l);J=l;M=C}else if(g==C)d(l,l.parent);else{if(h[C])J||(J=l);else{d(l,l.parent,A);z[C]||p.unshift(l)}P=A}l=M?M:l.returnPoint||l.parent;if(P){j.onTagOpen.apply(this,arguments);return}}a(g);b();n.parent=l;n.returnPoint=J;J=0;if(n.isEmpty)d(n);else l=n}}};j.onTagClose=function(g){for(var q=p.length-1;q>=0;q--)if(g==p[q].name){p.splice(q,1);return}for(var t=[],n=[],C=l;C.type&&C.name!=g;){C._.isBlockLike||n.unshift(C);t.push(C);C=C.parent}if(C.type){for(q=
0;q<t.length;q++){var P=t[q];d(P,P.parent)}l=C;if(l.name=="pre")w=D;C._.isBlockLike&&b();d(C,C.parent);if(C==l)l=l.parent;p=p.concat(n)}if(g=="body")i=D};j.onText=function(g){if(!l._.hasInlineStarted&&!w){g=s.ltrim(g);if(g.length===0)return}b();a();if(i&&(!l.type||l.name=="body")&&s.trim(g))this.onTagOpen(i,{});w||(g=g.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));l.add(new x.HtmlParser.Text(g))};j.onCDATA=function(){};j.onComment=function(g){l.add(new x.HtmlParser.Comment(g))};j.parse(B);for(b();l.type;){var v=
l.parent,c=l;if(i&&(!v.type||v.name=="body")&&!e.$body[c.name]){l=v;j.onTagOpen(i,{});v=l}v.add(c);l=v}return y};u.augment(r,{add:function(B){var i=this.children.length;if(i=i>0&&this.children[i-1]||H){if(B._.isBlockLike&&i.type==o.NODE_TEXT){i.value=s.rtrim(i.value);if(i.value.length===0){this.children.pop();this.add(B);return}}i.next=B}B.previous=i;B.parent=this;this.children.push(B);this._.hasInlineStarted=B.type==o.NODE_TEXT||B.type==o.NODE_ELEMENT&&!B._.isBlockLike},writeHtml:function(B,i){var a;
this.filterChildren=this.filterChildren=function(){var b=new x.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,b,i,A);b=b.getHtml();this.children=(new r.FromHtml(b)).children;a=1};!this.name&&i&&i.onFragment(this);this.writeChildrenHtml(B,a?H:i)},writeChildrenHtml:function(B,i){for(var a=0;a<this.children.length;a++)this.children[a].writeHtml(B,i)}});x.HtmlParser.Fragment=r;x.HtmlParser.Fragment=r;r.FromHtml=r.FromHtml;u=r.prototype;x.Utils.extern(u,{add:u.add,writeHtml:u.writeHtml,writeChildrenHtml:u.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function r(z,u){this.name=z;this.attributes=u||(u={});this.children=[];var s=u._ke_real_element_type||z,o=A.XHTML_DTD;s=!!(o.$nonBodyContent[s]||o.$block[s]||o.$listItem[s]||o.$tableContent[s]||o.$nonEditable[s]||s=="br");var e=!!o.$empty[z];this.isEmpty=e;this.isUnknown=!o[z];this._={isBlockLike:s,hasInlineStarted:e||!s}}var A=KISSY.Editor,D=A.NODE,H=function(z,u){z=z[0];u=u[0];return z<u?-1:z>u?1:0};KISSY.augment(r,{type:D.NODE_ELEMENT,add:A.HtmlParser.Fragment.prototype.add,
clone:function(){return new r(this.name,this.attributes)},writeHtml:function(z,u){var s=this.attributes,o=this,e=o.name,h,f,k,B;o.filterChildren=function(){if(!B){var b=new A.HtmlParser.BasicWriter;A.HtmlParser.Fragment.prototype.writeChildrenHtml.call(o,b,u);o.children=(new A.HtmlParser.Fragment.FromHtml(b.getHtml())).children;B=1}};o.filterChildren=o.filterChildren;if(u){for(;;){if(!(e=u.onElementName(e)))return;o.name=e;if(!(o=u.onElement(o)))return;o.parent=this.parent;if(o.name==e)break;if(o.type!=
D.NODE_ELEMENT){o.writeHtml(z,u);return}e=o.name;if(!e){this.writeChildrenHtml.call(o,z,B?null:u);return}}s=o.attributes}z.openTag(e,s);for(var i=[],a=0;a<2;a++)for(h in s){f=h;k=s[h];if(a==1)i.push([h,k]);else if(u){for(;;)if(f=u.onAttributeName(h))if(f!=h){delete s[h];h=f}else break;else{delete s[h];break}if(f)if((k=u.onAttribute(o,f,k))===false)delete s[f];else s[f]=k}}z.sortAttributes&&i.sort(H);s=i.length;for(a=0;a<s;a++){h=i[a];z.attribute(h[0],h[1])}z.openTagClose(e,o.isEmpty);if(!o.isEmpty){this.writeChildrenHtml.call(o,
z,B?null:u);z.closeTag(e)}},writeChildrenHtml:function(){A.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});A.HtmlParser.Element=r;A.HtmlParser.Element=r;var x=r.prototype;A.Utils.extern(x,{type:x.type,add:x.add,clone:x.clone,writeHtml:x.writeHtml,writeChildrenHtml:x.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function r(h){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};h&&this.addRules(h,10)}function A(h,f){for(var k=0;h&&k<f.length;k++){var B=f[k];h=h.replace(B[0],B[1])}return h}function D(h,f,k){if(typeof f=="function")f=[f];var B,i;i=h.length;var a=f&&f.length;if(a){for(B=0;B<i&&h[B].pri<k;B++);for(i=a-1;i>=0;i--)if(a=f[i]){a.pri=k;h.splice(B,0,a)}}}function H(h,f,k){if(f)for(var B in f){var i=h[B];h[B]=x(i,f[B],
k);i||h.$length++}}function x(h,f,k){if(f){f.pri=k;if(h){if(h.splice)D(h,f,k);else{h=h.pri>k?[f,h]:[h,f];h.filter=z}return h}else return f.filter=f}}function z(h){for(var f=h.type||h instanceof s.HtmlParser.Fragment,k=0;k<this.length;k++){if(f)var B=h.type,i=h.name;var a=this[k].apply(window,arguments);if(a===e)return a;if(f){if(a&&(a.name!=i||a.type!=B))return a}else if(typeof a!="string")return a;a!=undefined&&(h=a)}return h}var u=KISSY,s=u.Editor,o=s.NODE,e=false;u.augment(r,{addRules:function(h,
f){if(typeof f!="number")f=10;D(this._.elementNames,h.elementNames,f);D(this._.attributeNames,h.attributeNames,f);H(this._.elements,h.elements,f);H(this._.attributes,h.attributes,f);this._.text=x(this._.text,h.text,f)||this._.text;this._.comment=x(this._.comment,h.comment,f)||this._.comment;this._.root=x(this._.root,h.root,f)||this._.root},onElementName:function(h){return A(h,this._.elementNames)},onAttributeName:function(h){return A(h,this._.attributeNames)},onText:function(h){var f=this._.text;
return f?f.filter(h):h},onComment:function(h,f){var k=this._.comment;return k?k.filter(h,f):h},onFragment:function(h){var f=this._.root;return f?f.filter(h):h},onElement:function(h){for(var f=[this._.elements["^"],this._.elements[h.name],this._.elements.$],k,B=0;B<3;B++)if(k=f[B]){k=k.filter(h,this);if(k===e)return null;if(k&&k!=h)return this.onNode(k);if(h.parent&&!h.name)break}return h},onNode:function(h){var f=h.type;return f==o.NODE_ELEMENT?this.onElement(h):f==o.NODE_TEXT?new s.HtmlParser.Text(this.onText(h.value)):
null},onAttribute:function(h,f,k){if(f=this._.attributes[f]){h=f.filter(k,h,this);if(h===e)return e;if(typeof h!="undefined")return h}return k}});s.HtmlParser.Filter=r;u=r.prototype;s.Utils.extern(u,{addRules:u.addRules,onElementName:u.onElementName,onAttributeName:u.onAttributeName,onText:u.onText,onComment:u.onComment,onFragment:u.onFragment,onElement:u.onElement,onNode:u.onNode,onAttribute:u.onAttribute});s.HtmlParser.Filter=r});
KISSY.Editor.add("htmlparser-text",function(){function r(x){this.value=x;this._={isBlockLike:H}}var A=KISSY,D=A.Editor,H=false;A.augment(r,{type:D.NODE.NODE_TEXT,writeHtml:function(x,z){var u=this.value;z&&!(u=z.onText(u,this))||x.text(u)}});D.HtmlParser.Text=r;D.HtmlParser.Text=r});
KISSY.Editor.add("htmlparser-comment",function(){function r(H){this.value=H;this._={isBlockLike:false}}var A=KISSY.Editor,D=A.NODE;A.HtmlParser.Comment=r;A.HtmlParser.Comment=r;r.prototype={constructor:r,type:D.NODE_COMMENT,writeHtml:function(H,x){var z=this.value;if(x){if(!(z=x.onComment(z,this)))return;if(typeof z!="string"){z.parent=this.parent;z.writeHtml(H,x);return}}H.comment(z)}}});
