KISSY.add("editor",function(y,G){function H(i,r){function a(e){for(var n=H.Env.mods,k=0;k<e.length;k++){for(var c=e[k],f=false,j=0;j<k;j++)if(c==e[j]){f=true;break}j=n[c];if(f&&j){f=y.clone(j);c=c+"_"+k;f.name=c;e[k]=c;n[c]||(n[c]=f)}}}var b=this;if(!(b instanceof H))return new H(i,r);if(y.isString(i))i=y.one(i);i=D._4e_wrap(i);r=r||{};r.pluginConfig=r.pluginConfig||{};b.cfg=r;y.app(b,y.EventTarget);var d=["htmldataprocessor","enterkey","clipboard"];b.use=function(e,n){e=e.split(",");a(e);for(var k=
0;k<d.length;k++){var c=d[k];y.inArray(c,e)||e.unshift(c)}y.use.call(b,e.join(","),function(){b.ready(function(){n&&n.call(b);b.setData(i.val());if(r.focus)b.focus();else{var f=b.getSelection();f&&f.removeAllRanges()}b.fire("save")})},{order:true,global:H});return b};b.init(i)}function w(i){if(!C)return i.replace(/\.(js|css)/i,"-min.$1");if(C==="dev")return"../src/"+i;return i}var D=y.DOM;y.app(H,y.EventTarget);H.Config.base=y.Config.base+"editor/";var C=y.Config.debug,M={htmlparser:{attach:false,
path:w("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},l=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection","styles"],g=["separator","sourceareasupport","tabs","flashbridge","flashutils","clipboard",{name:"colorsupport",requires:["overlay"]},{name:"forecolor",requires:["colorsupport"]},{name:"bgcolor",requires:["colorsupport"]},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},
{name:"draft",requires:["localStorage"]},{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["flashutils","contextmenu","fakeobjects","overlay","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview","tabs"]},"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize",{name:"music",requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},
{name:"sourcearea",requires:["sourceareasupport"]},{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],h=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",
requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],q,t,A,s;q=0;for(t=g.length;q<t;q++){A=g[q];if(y.isString(A))A=g[q]={name:A};A.requires=A.requires||[];A.requires=A.requires.concat(["button"])}g=[{name:"localStorage",requires:["flashutils","flashbridge"]},{name:"button"},{name:"dd"},{name:"progressbar"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(g);
q=0;for(t=g.length;q<t;q++){A=g[q];s=A.name;M[s]={attach:false,requires:A.requires,csspath:A.useCss?w("plugins/"+s+"/plugin.css"):G,path:w("plugins/"+s+"/plugin.js")}}q=0;for(t=h.length;q<t;q++){A=h[q];g=G;if(!y.isString(A)){g=A.requires;A=A.name}M[A]={attach:false,requires:g,path:w("plugins/htmldataprocessor/htmlparser/"+A.substring(11)+".js")}}q=0;for(t=l.length;q<t;q++){A=l[q];M[A]={host:"editor",requires:q>0?l[q-1]:[]}}H.add(M);y.Editor=H});
KISSY.Editor.add("utils",function(y){var G=KISSY,H=G.Node,w=G.DOM,D=G.Config.debug,C=G.UA,M=G.Event;y.Utils={debugUrl:function(l){if(!D)return l.replace(/\.(js|css)/i,"-min.$1");if(D==="dev")return"../src/"+l;return l},lazyRun:function(l,g,h){var q=l[g],t=l[h];l[g]=function(){q.apply(this,arguments);l[g]=l[h];return t.apply(this,arguments)}},getXY:function(l,g,h,q){h=h.defaultView||h.parentWindow;l-=w.scrollLeft(h);g-=w.scrollTop(h);if(q)if(h!=(q.defaultView||q.parentWindow)&&h.frameElement){q=w._4e_getOffset(h.frameElement,
q);l+=q.left;g+=q.top}return{left:l,top:g}},tryThese:function(){for(var l,g=0,h=arguments.length;g<h;g++){var q=arguments[g];try{l=q();break}catch(t){}}return l},arrayCompare:function(l,g){if(!l&&!g)return true;if(!l||!g||l.length!=g.length)return false;for(var h=0;h<l.length;h++)if(l[h]!==g[h])return false;return true},getByAddress:function(l,g,h){l=l.documentElement;for(var q=0;l&&q<g.length;q++){var t=g[q];if(h)for(var A=-1,s=0;s<l.childNodes.length;s++){var i=l.childNodes[s];if(!(h===true&&i.nodeType==
3&&i.previousSibling&&i.previousSibling.nodeType==3)){A++;if(A==t){l=i;break}}}else l=l.childNodes[t]}return l?new H(l):null},clearAllMarkers:function(l){for(var g in l)l[g]._4e_clearMarkers(l,true)},htmlEncodeAttr:function(l){return l.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(l){return l.replace(/^\s+/,"")},rtrim:function(l){return l.replace(/\s+$/,"")},trim:function(l){return this.ltrim(this.rtrim(l))},mix:function(){for(var l={},g=0;g<arguments.length;g++)l=
G.mix(l,arguments[g]);return l},isCustomDomain:function(){if(!C.ie)return false;var l=document.domain,g=window.location.hostname;return l!=g&&l!="["+g+"]"},duplicateStr:function(l,g){return Array(g+1).join(l)},throttle:function(l,g,h){h=h||150;if(h===-1)return function(){l.apply(g,arguments)};var q=(new Date).getTime();return function(){var t=(new Date).getTime();if(t-q>h){q=t;l.apply(g,arguments)}}},buffer:function(l,g,h){h=h||0;var q=null;return function(){q&&clearTimeout(q);var t=arguments;q=setTimeout(function(){return l.apply(g,
t)},h)}},isNumber:function(l){return/^\d+(.\d+)?$/.test(G.trim(l))},verifyInputs:function(l){for(var g=0;g<l.length;g++){var h=w._4e_wrap(l[g]),q=G.trim(h.val()),t=h.attr("data-verify");h=h.attr("data-warning");if(t&&!RegExp(t).test(q)){alert(h);return}}return true},sourceDisable:function(l,g){l.on("sourcemode",g.disable,g);l.on("wysiwygmode",g.enable,g)},resetInput:function(l){var g=l.attr("placeholder");if(g&&!C.webkit){l.val(g);l.addClass("ke-input-tip")}else C.webkit&&l.val("")},placeholder:function(l,
g){l.attr("placeholder",g);if(!C.webkit){l.on("blur",function(){if(!G.trim(l.val())){l.val(g);l.addClass("ke-input-tip")}});l.on("focus",function(){G.trim(l.val())==g&&l.val("");l.removeClass("ke-input-tip")})}},clean:function(l){l=l[0]||l;for(var g=G.makeArray(l.childNodes),h=0;h<g.length;h++){var q=g[h];q.nodeType==y.NODE.NODE_TEXT&&!G.trim(q.nodeValue)&&l.removeChild(q)}},htmlEncode:function(l){return!l?l:String(l).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},
htmlDecode:function(l){return!l?l:String(l).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(l,g){return l.toLowerCase()==g.toLowerCase()},normParams:function(l){l=G.clone(l);for(var g in l)if(l.hasOwnProperty(g)){var h=l[g];if(G.isFunction(h))l[g]=h()}return l},doFormUpload:function(l,g,h){function q(){var b={responseText:"",responseXML:null};b.argument=l?l.argument:null;try{var d;if((d=C.ie?A.contentWindow.document:A.contentDocument||
window.frames[t].document)&&d.body)b.responseText=d.body.innerHTML;b.responseXML=d&&d.XMLDocument?d.XMLDocument:d}catch(e){}M.remove(A,"load",q);l.callback&&l.callback(b);setTimeout(function(){w._4e_remove(A)},100)}var t=G.guid("form-upload-"),A=document.createElement("iframe");A.id=t;A.name=t;A.className="ke-hidden";if(C.ie)A.src="javascript:false";document.body.appendChild(A);if(C.ie)document.frames[t].name=t;var s=w._4e_unwrap(l.form),i={target:s.target,method:s.method,encoding:s.encoding,enctype:s.enctype,
action:s.action};s.target=t;s.method="POST";s.enctype=s.encoding="multipart/form-data";if(h)s.action=h;var r;if(g){r=[];g=y.Utils.normParams(g);for(var a in g)if(g.hasOwnProperty(a)){h=document.createElement("input");h.type="hidden";h.name=a;h.value=g[a];s.appendChild(h);r.push(h)}}M.on(A,"load",q);s.submit();s.target=i.target;s.method=i.method;s.enctype=i.enctype;s.encoding=i.encoding;s.action=i.action;if(r){g=0;for(s=r.length;g<s;g++)w._4e_remove(r[g])}}}});
KISSY.Editor.add("focusmanager",function(y){function G(){this.iframeFocus=true;l=this}function H(){this.iframeFocus=false;l=null}var w=KISSY,D=w.DOM,C=w.Event;w={};var M={},l;w={refreshAll:function(){for(var g in M){var h=M[g];h.document.designMode="off";h.document.designMode="on"}},currentInstance:function(){return l},getInstance:function(g){return M[g]},add:function(g){var h=D._4e_getWin(g.document);C.on(h,"focus",G,g);C.on(h,"blur",H,g)},register:function(g){M[g._UUID]=g},remove:function(g){delete M[g._UUID];
var h=D._4e_getWin(g.document);C.remove(h,"focus",G,g);C.remove(h,"blur",H,g)}};y.focusManager=w;y.getInstances=function(){return M}});
KISSY.Editor.add("definition",function(y){function G(i,r){return h+"<html><head><title>${title}</title><link href='"+y.Config.base+q+"' rel='stylesheet'/><style>"+(r||"")+"</style></head><body class='ke-editor'>&nbsp;"+(i?'<script id="ke_actscript" type="text/javascript">'+(y.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+i+'");<\/script>':"")+"</body></html>"}var H=KISSY,w=H.UA,D=H.DOM,C=H.Node,M=H.Event,l=y.focusManager,g=y.Utils.tryThese,
h="<!doctype html>",q=y.Utils.debugUrl("theme/editor-iframe.css"),t=1,A="document.open();"+(y.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",s="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(w.ie?"javascript:void(function(){"+encodeURIComponent(A)+
"}())":"")+'"  tabIndex="'+(w.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";y.SOURCE_MODE=0;y.WYSIWYG_MODE=1;H.augment(y,{init:function(i){if(w.ie)D.addClass(document.body,"ie"+w.ie);else if(w.gecko)D.addClass(document.body,"gecko");else w.webkit&&D.addClass(document.body,"webkit");var r=this,a=new C(s.replace(/\$\(tabIndex\)/,i.attr("tabIndex")));a.on("mousedown",function(e){if(w.webkit){var n=D._4e_name(e.target);
if(n=="select"||n=="option")return true}e.halt()});i.on("mousedown",function(e){e.stopPropagation()});r.editorWrap=a;r._UUID=t++;l.register(r);r.wrap=a.one(".ke-textarea-wrap");r.iframe=r.wrap.one("iframe");r.toolBarDiv=a.one(".ke-editor-tools");r.textarea=i;r.statusDiv=a.one(".ke-editor-status");r.toolBarDiv._4e_unselectable();r._commands={};var b=i._4e_style("width"),d=i._4e_style("height");if(b){a.css("width",b);i.css("width","100%")}r.textarea.css("display","none");a.insertAfter(i);r.wrap[0].appendChild(i[0]);
if(d){r.wrap.css("height",d);i.css("height","100%")}a=r.iframe;r.on("dataReady",function(){r._ready=true;y.fire("instanceCreated",{editor:r})});w.gecko?a.on("load",r._setUpIFrame,r):r._setUpIFrame();r.cfg.attachForm&&i[0].form&&r._attachForm()},_attachForm:function(){(new C(this.textarea[0].form)).on("submit",this.sync,this)},addCommand:function(i,r){this._commands[i]=r},hasCommand:function(i){return this._commands[i]},execCommand:function(i){var r=this._commands[i],a=H.makeArray(arguments);a.shift();
a.unshift(this);return r.exec.apply(r,a)},getMode:function(){return this.textarea.css("display")=="none"?y.WYSIWYG_MODE:y.SOURCE_MODE},getData:function(){var i;if(this.getMode()==y.WYSIWYG_MODE){i=this.document.body.innerHTML;if(this.htmlDataProcessor)i=this.htmlDataProcessor.toHtml(i,"p")}else i=this.textarea.val();return i},setData:function(i){var r;if(this.htmlDataProcessor)r=this.htmlDataProcessor.toDataFormat(i,"p");this.document.body.innerHTML=r;this.getMode()!=y.WYSIWYG_MODE&&this.textarea.val(i)},
sync:function(){this.textarea.val(this.getData())},baseZIndex:function(i){i=i||0;return i+(this.cfg.baseZIndex||0)},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(i){this.document.body.innerHTML=i},_prepareIFrameHtml:G,getSelection:function(){var i=new y.Selection(this.document);return!i||i.isInvalid?null:i},focus:function(){var i=D._4e_getWin(this.document);w.webkit&&i&&i.parent&&i.parent.focus();i&&i.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},
blur:function(){D._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(i){var r=this.cfg,a=this.document;r.customStyle=r.customStyle||"";r.customStyle+="\n"+i;r=a.createElement("style");a.getElementsByTagName("head")[0].appendChild(r);if(r.styleSheet)r.styleSheet.cssText=i;else r.appendChild(a.createTextNode(i))},_setUpIFrame:function(){function i(){e=d.document;r.document=e;a.detach();e.open("text/html","replace");e.write(b);e.close()}var r=this,a=r.iframe,
b=G(r._UUID,r.cfg.customStyle),d=a[0].contentWindow,e;try{e=d.document}catch(n){a[0].src=a[0].src;if(w.ie<7){setTimeout(i,10);return}}i()},addPlugin:function(i){this.ready(i)},ready:function(i){this._ready?i():this.on("dataReady",i)},_monitor:function(){var i=this;i._monitorId&&clearTimeout(i._monitorId);i._monitorId=setTimeout(function(){var r=i.getSelection();if(r&&!r.isInvalid){var a=r.getStartElement(),b=new y.ElementPath(a);if(!i.previousPath||!i.previousPath.compare(b)){i.previousPath=b;i.fire("selectionChange",
{selection:r,path:b,element:a})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(i,r){var a=this;a.focus();var b=i._4e_name(),d=y.XHTML_DTD,e=y.RANGE,n=y.NODE,k=d.$block[b],c=a.getSelection(),f=c.getRanges(),j,m,o,x,J;a.fire("save");for(var I=f.length-1;I>=0;I--){j=f[I];j.deleteContents();m=!I&&i||i._4e_clone(true);r&&r(m);if(k)for(;(x=j.getCommonAncestor(false,true))&&(J=d[x._4e_name()])&&!(J&&J[b]);)if(x._4e_name()in d.span)j.splitElement(x);
else if(j.checkStartOfBlock()&&j.checkEndOfBlock()){j.setStartBefore(x);j.collapse(true);x._4e_remove()}else j.splitBlock();j.insertNode(m);o||(o=m)}b=o._4e_nextSourceNode(true);d=a.document;J=y.XHTML_DTD;if(J.$inline[m._4e_name()]){b=new C(d.createTextNode(" "));b.insertAfter(o)}else if(b){if(b._4e_name()=="br"&&J[b.parent()._4e_name()].p){J=new C("<p>&nbsp;</p>",null,d);b[0].parentNode.replaceChild(J[0],b[0]);b=J}}else{J=new C("<p>&nbsp;</p>",null,d);J.insertAfter(o);b=J}j.moveToPosition(o,e.POSITION_AFTER_END);
b&&b[0].nodeType==n.NODE_ELEMENT&&j.moveToElementEditablePosition(b);c.selectRanges([j]);a.focus();m&&m._4e_scrollIntoView();setTimeout(function(){a.fire("save")},10);return m},insertHtml:function(i){var r=this;if(r.htmlDataProcessor)i=r.htmlDataProcessor.toDataFormat(i);if(w.webkit){i=D.create(i,null,this.document);i=i.nodeType==11?H.makeArray(i.childNodes):[i];for(var a=0;a<i.length;a++)r.insertElement(new C(i[a]))}else{r.focus();r.fire("save");a=r.getSelection();if(w.ie){a=a.getNative();a.type==
"Control"&&a.clear();a.createRange().pasteHTML(i)}else r.document.execCommand("inserthtml",false,i);r.focus();setTimeout(function(){r.fire("save")},10)}}});y._initIFrame=function(i){function r(m){g(function(){d.designMode="on";setTimeout(function(){d.designMode="off";k.focus();if(!arguments.callee.retry)arguments.callee.retry=true},50)},function(){d.designMode="off";D.attr(k,"contentEditable",false);D.attr(k,"contentEditable",true);!m&&r(1)})}var a=l.getInstance(i);i=a.textarea[0];var b=a.iframe[0].contentWindow,
d=a.document,e=a.cfg,n=d.getElementById("ke_actscript");D._4e_remove(n);var k=d.body;if(w.ie){k.hideFocus=true;k.disabled=true;k.contentEditable=true;k.removeAttribute("disabled")}else setTimeout(function(){if(w.gecko||w.opera)k.contentEditable=true;else if(w.webkit)k.parentNode.contentEditable=true;else d.designMode="on"},0);if(w.webkit){M.on(d,"click",function(m){var o=new C(m.target);H.inArray(o._4e_name(),["input","select"])&&m.preventDefault()});M.on(d,"mouseup",function(m){var o=new C(m.target);
H.inArray(o._4e_name(),["input","textarea"])&&m.preventDefault()})}if(w.gecko||w.ie||w.opera){var c;c=new C(D.insertAfter((new C('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],i));c.on("focus",function(){a.focus()});a.activateGecko=function(){w.gecko&&a.iframeFocus&&c[0].focus()};a.on("destroy",function(){})}if(w.ie&&d.compatMode=="CSS1Compat"||w.gecko||w.opera){var f=new C(d.documentElement);f.on("mousedown",function(m){if(m.target==f[0]){w.gecko&&r(false);
c[0].focus()}})}M.on(b,"focus",function(){if(w.gecko)r(false);else w.opera&&k.focus();a.notifySelectionChange()});w.gecko&&M.on(a.document,"mousedown",function(){a.iframeFocus||r(false)});if(w.ie){M.on(d,"keydown",function(m){if(m.keyCode in{8:1,46:1}){var o=a.getSelection(),x=o.getSelectedElement();if(x){a.fire("save");var J=o.getRanges()[0].createBookmark();x._4e_remove();o.selectBookmarks([J]);a.fire("save");m.preventDefault()}}});if(d.compatMode=="CSS1Compat"){var j={33:1,34:1};M.on(d,"keydown",
function(m){m.keyCode in j&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){w.ie&&setTimeout(function(){if(d){k.runtimeStyle.marginBottom="0px";k.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady");var m=e.disableObjectResizing,o=e.disableInlineTableEditing;if(m||o)try{d.execCommand("enableObjectResizing",false,!m);d.execCommand("enableInlineTableEditing",false,!o)}catch(x){M.on(k,w.ie?"resizestart":"resize",function(J){if(m||D._4e_name(J.target)===
"table"&&o)J.preventDefault()})}},10);w.webkit&&M.on(d,"mousedown",function(m){m=new C(m.target);H.inArray(m._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(m)});w.gecko&&M.on(d,"dragstart",function(m){var o=new C(m.target);o._4e_name()==="img"&&/ke_/.test(o[0].className)&&m.preventDefault()});l.add(a)};y.baseZIndex=function(i){var r=i,a=y.getInstances(),b;for(b in a){if(!a.hasOwnProperty(b))return;r=Math.max(r,a[b].baseZIndex(i))}return r}});
KISSY.Editor.add("dtd",function(y){y.XHTML_DTD=function(){var G=function(k){for(var c=arguments.length-1;c>0;)KISSY.mix(k,arguments[c--]);return k},H={isindex:1,fieldset:1},w={input:1,button:1,select:1,textarea:1,label:1},D=G({a:1},w),C=G({iframe:1},D),M={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},l={ins:1,del:1,script:1,style:1},g=G({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},l),h=G({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},g),q=G({p:1},h);w=G({iframe:1},h,w);h={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var t=G({a:1},w),A={tr:1},s={"#":1},i=G({param:1},h),r=G({form:1},H,C,M,q),a={li:1},b={base:1,link:1,meta:1,title:1},d=G(b,{style:1,script:1}),e={head:1,body:1},n={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:G({html:1},e,b),$block:n,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:t,$body:G({script:1,style:1},n),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:e,head:d,style:s,body:r,base:{},link:{},meta:{},title:s,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:r,td:r,br:{},th:r,center:r,kbd:t,button:G(q,M),basefont:{},h5:t,h4:t,samp:t,h6:t,ol:a,h1:t,h3:t,option:s,h2:t,form:G(H,C,M,q),select:{optgroup:1,option:1},font:t,ins:t,menu:a,abbr:t,label:t,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:t,script:s,tfoot:A,cite:t,li:r,input:{},iframe:r,strong:t,textarea:s,noframes:r,big:t,small:t,span:t,hr:{},dt:t,sub:t,optgroup:{option:1},param:{},bdo:t,"var":t,div:r,object:i,sup:t,dd:r,strike:t,area:{},dir:a,map:G({area:1,form:1,p:1},H,l,M),applet:i,dl:{dt:1,dd:1},del:t,isindex:{},fieldset:G({legend:1},h),thead:A,ul:a,acronym:t,b:t,a:w,blockquote:r,caption:t,i:t,u:t,tbody:A,s:t,address:G(C,q),tt:t,legend:t,q:t,pre:G(g,D),p:t,em:t,dfn:t}}()});
KISSY.Editor.add("dom",function(y){function G(a){return a.replace(/-(\w)/g,function(b,d){return d.toUpperCase()})}var H=KISSY,w=H.DOM,D=H.UA,C=H.Node,M=y.Utils,l={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};y.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};y.POSITION={};var g=y.NODE,h=y.POSITION;h.POSITION_IDENTICAL=0;h.POSITION_DISCONNECTED=
1;h.POSITION_FOLLOWING=2;h.POSITION_PRECEDING=4;h.POSITION_IS_CONTAINED=8;h.POSITION_CONTAINS=16;var q={},t={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},A={hr:1},s=function(a){return a[0]||a},i=function(a){if(a&&!a[0])return new C(a);return a},r={_4e_wrap:i,_4e_unwrap:s,_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=s(a);b=s(b);return a===
b},_4e_isBlockBoundary:function(a,b){a=i(a);var d=H.mix(H.mix({},A),b||{});return t[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=s(a);for(var b=a.parentNode.childNodes,d=0;d<b.length;d++)if(b[d]===a)return d;return-1},_4e_first:function(a,b){a=s(a);var d=a.firstChild;if((d=d&&new C(d))&&b&&!b(d))d=d._4e_next(b);return d},_4e_move:function(a,b,d){a._4e_remove();a=s(a);
b=s(b);d?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_name:function(a){a=s(a);var b=a.nodeName.toLowerCase();if(D.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var d=a[0].attributes,e=b[0].attributes,n=d.length,k=e.length;if(!D.ie&&n!=k)return false;for(var c=0;c<n;c++){var f=d[c];if((!D.ie||f.specified&&f.nodeName!="_ke_expando")&&f.nodeValue!=b.attr(f.nodeName))return false}if(D.ie)for(c=0;c<k;c++){f=
e[c];if(f.specified&&f.nodeName!="_ke_expando"&&f.nodeValue!=a.attr(f.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=s(a).childNodes;for(var b=0,d=a.length;b<d;b++){var e=a[b],n=e.nodeType;if(!(n==g.NODE_ELEMENT&&e.getAttribute("_ke_bookmark")))if(n==g.NODE_ELEMENT&&!r._4e_isEmptyInlineRemoveable(e)||n==g.NODE_TEXT&&H.trim(e.nodeValue))return false}return true},_4e_moveChildren:function(a,b,d){a=s(a);b=b[0]||b;if(a!=b)if(d)for(;d=a.lastChild;)b.insertBefore(a.removeChild(d),
b.firstChild);else for(;d=a.firstChild;)b.appendChild(a.removeChild(d))},_4e_mergeSiblings:function(){function a(b,d,e){if(d[0]&&d[0].nodeType==g.NODE_ELEMENT){for(var n=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){n.push(d);d=e?new C(d[0].nextSibling):new C(d[0].previousSibling);if(!d[0]||d[0].nodeType!=g.NODE_ELEMENT)return}if(b._4e_isIdentical(d)){for(var k=e?b[0].lastChild:b[0].firstChild;n.length;)n.shift()._4e_move(b,!e);d._4e_moveChildren(b,!e);d._4e_remove();k[0]&&k[0].nodeType==
g.NODE_ELEMENT&&k._4e_mergeSiblings()}}}return function(b){if(b[0])if(l[b._4e_name()]||b._4e_name()=="a"){a(b,new C(b[0].nextSibling),true);a(b,new C(b[0].previousSibling))}}}(),_4e_unselectable:D.gecko?function(a){a=s(a);a.style.MozUserSelect="none"}:D.webkit?function(a){a=s(a);a.style.KhtmlUserSelect="none"}:function(a){a=s(a);if(D.ie||D.opera){var b,d=0;for(a.unselectable="on";b=a.all[d++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable=
"on"}}},_4e_getOffset:function(a,b){a=s(a);var d,e=0;d=0;var n=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,k=a.ownerDocument,c=k.documentElement;b=b||k;if(a.getBoundingClientRect){if(a!==k.body&&c!==a){d=a.getBoundingClientRect();e=d.left+(b===k?w.scrollLeft(n):0);d=d.top+(b===k?w.scrollTop(n):0)}if(b)if(n!=(b.defaultView||b.parentWindow)&&n.frameElement){n=r._4e_getOffset(n.frameElement,b);e+=n.left;d+=n.top}}return{left:e,top:d}},_4e_getFrameDocument:function(a){return(a=s(a))&&a.contentWindow.document},
_4e_splitText:function(a,b){a=s(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=g.NODE_TEXT)){if(D.ie&&b==a.nodeValue.length){var e=d.createTextNode("");w.insertAfter(e,a);return new C(e)}e=new C(a.splitText(b));if(D.ie==8){d=d.createTextNode("");w.insertAfter(d,e[0]);d.parentNode.removeChild(d)}return e}},_4e_parents:function(a,b){a=i(a);var d=[];do d[b?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,b,d){a=s(a);a=a.cloneNode(b);if(!d){var e=function(n){if(n.nodeType==g.NODE_ELEMENT){n.removeAttribute("id",
false);n.removeAttribute("_ke_expando",false);n=n.childNodes;for(var k=0;k<n.length;k++)e(n[k])}};e(a)}return new C(a)},_4e_nextSourceNode:function(a,b,d,e){a=s(a);if(e&&!e.call){var n=e[0]||e;e=function(c){c=c[0]||c;return c!==n}}b=!b&&a.firstChild;var k=new C(a);if(!b){if(a.nodeType==g.NODE_ELEMENT&&e&&e(a,true)===false)return null;b=a.nextSibling}for(;!b&&(k=k.parent());){if(e&&e(k,true)===false)return null;b=k[0].nextSibling}if(!b)return null;b=w._4e_wrap(b);if(e&&e(b)===false)return null;if(d&&
d!=b[0].nodeType)return b._4e_nextSourceNode(false,d,e);return b},_4e_previousSourceNode:function(a,b,d,e){a=s(a);if(e&&!e.call){var n=e[0]||e;e=function(c){c=c[0]||c;return c!==n}}b=!b&&a.lastChild;var k=new C(a);if(!b){if(a.nodeType==g.NODE_ELEMENT&&e&&e(a,true)===false)return null;b=a.previousSibling}for(;!b&&(k=k.parent());){if(e&&e(k,true)===false)return null;b=k[0].previousSibling}if(!b)return null;b=w._4e_wrap(b);if(e&&e(b)===false)return null;if(d&&b[0].nodeType!=d)return b._4e_previousSourceNode(false,
d,e);return b},_4e_contains:D.ie||D.webkit?function(a,b){a=s(a);b=s(b);return b.nodeType!=g.NODE_ELEMENT?a.contains(b.parentNode):a!=b&&a.contains(b)}:function(a,b){a=s(a);b=s(b);return!!(a.compareDocumentPosition(b)&16)},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=g.NODE_TEXT&&b._4e_contains(a))return b;var d=a[0].nodeType==g.NODE_TEXT?a.parent():a;do if(d[0].nodeType!=g.NODE_TEXT&&d._4e_contains(b))return d;while(d=d.parent());return null},_4e_ascendant:function(a,
b,d){a=s(a);if(!d)a=a.parentNode;if(b&&!H.isFunction(b)){var e=b;b=function(n){return n._4e_name()==e}}for(;a&&a.nodeType!=9;){if(!b||b(new C(a))===true)return new C(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,b){a=s(a);var d=a.attributes.getNamedItem(b);return!!(d&&d.specified)},_4e_hasAttributes:D.ie?function(a){a=s(a);for(var b=a.attributes,d=0;d<b.length;d++){var e=b[d];switch(e.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(e.specified)return true}}return false}:
function(a){a=s(a);D.gecko&&a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,b){var d=s(a),e=s(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(e);if(d==e)return h.POSITION_IDENTICAL;if(d.nodeType==g.NODE_ELEMENT&&e.nodeType==g.NODE_ELEMENT){if(d.contains){if(d.contains(e))return h.POSITION_CONTAINS+h.POSITION_PRECEDING;if(e.contains(d))return h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING}if("sourceIndex"in
d)return d.sourceIndex<0||e.sourceIndex<0?h.POSITION_DISCONNECTED:d.sourceIndex<e.sourceIndex?h.POSITION_PRECEDING:h.POSITION_FOLLOWING}d=a._4e_address();e=b._4e_address();for(var n=Math.min(d.length,e.length),k=0;k<=n-1;k++)if(d[k]!=e[k]){if(k<n)return d[k]<e[k]?h.POSITION_PRECEDING:h.POSITION_FOLLOWING;break}return d.length<e.length?h.POSITION_CONTAINS+h.POSITION_PRECEDING:h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING},_4e_address:function(a,b){a=s(a);for(var d=[],e=a.ownerDocument.documentElement,
n=a;n&&n!=e;){var k=n.parentNode,c=-1;if(k){for(var f=0;f<k.childNodes.length;f++){var j=k.childNodes[f];if(!(b&&j.nodeType==3&&j.previousSibling&&j.previousSibling.nodeType==3)){c++;if(j==n)break}}d.unshift(c)}n=k}return d},_4e_breakParent:function(a,b){var d=new y.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);var e=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(e,a[0].nextSibling)},_4e_style:function(a,b,d){if(d!==undefined)return a.css(b,d);a=a[0]||
a;return a.style[G(b)]},_4e_remove:function(a,b){var d=s(a),e=d.parentNode;if(e){if(b)for(var n;n=d.firstChild;)e.insertBefore(d.removeChild(n),d);e.removeChild(d)}return a},_4e_trim:function(a){w._4e_ltrim(a);w._4e_rtrim(a)},_4e_ltrim:function(a){a=s(a);for(var b;b=a.firstChild;){if(b.nodeType==g.NODE_TEXT){var d=M.ltrim(b.nodeValue),e=b.nodeValue.length;if(d){if(d.length<e){(new C(b))._4e_splitText(e-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=
s(a);for(var b;b=a.lastChild;){if(b.type==g.NODE_TEXT){var d=M.rtrim(b.nodeValue),e=b.nodeValue.length;if(d){if(d.length<e){(new C(b))._4e_splitText(d.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!D.ie&&!D.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=s(a);for(var b=a.lastChild;b&&b.nodeType==g.NODE_TEXT&&!H.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==g.NODE_TEXT||w._4e_name(b)!==
"br"){b=D.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");D.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){var d=s(a),e;do e=(d=d.previousSibling)&&new C(d);while(e&&b&&!b(e));return e},_4e_last:function(a,b){a=w._4e_wrap(a);var d=a[0].lastChild;if((d=d&&new C(d))&&b&&!b(d))d=d._4e_previous(b);return d},_4e_next:function(a,b){var d=s(a),e;do e=(d=d.nextSibling)&&new C(d);while(e&&b&&!b(e));return e},_4e_outerHtml:function(a){a=s(a);
if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,d,e){a=w._4e_wrap(a);var n=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",H.guid())._4e_getData("list_marker_id"),k=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");b[n]=a;k[d]=1;return a._4e_setData(d,e)},_4e_clearMarkers:function(a,b,d){a=i(a);
var e=a._4e_getData("list_marker_names"),n=a._4e_getData("list_marker_id"),k;for(k in e)a._4e_removeData(k);a._4e_removeData("list_marker_names");if(d){a._4e_removeData("list_marker_id");delete b[n]}},_4e_setData:function(a,b,d){var e=w._4e_getUniqueId(a);(q[e]||(q[e]={}))[b]=d;return a},_4e_getData:function(a,b){a=s(a);var d=a.getAttribute("_ke_expando");return(d=d&&q[d])&&d[b]},_4e_removeData:function(a,b){a=s(a);var d=a.getAttribute("_ke_expando");var e=(d=d&&q[d])&&d[b];typeof e!="undefined"&&
d&&delete d[b];H.isEmptyObject(d)&&w._4e_clearData(a);return e||null},_4e_clearData:function(a){a=s(a);var b=a.getAttribute("_ke_expando");b&&delete q[b];b&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=s(a);var b=a.getAttribute("_ke_expando");if(b)return b;b=H.guid();a.setAttribute("_ke_expando",b);return b},_4e_copyAttributes:function(a,b,d){a=s(a);var e=a.attributes;d=d||{};for(var n=0;n<e.length;n++){var k=e[n],c=k.nodeName.toLowerCase(),f;if(!(c in d))if(c=="checked"&&(f=w.attr(a,
c)))b.attr(c,f);else if(k.specified||D.ie&&k.nodeValue&&c=="value"){f=w.attr(a,c);if(f===null)f=k.nodeValue;b.attr(c,f)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=w._4e_name(a);var b=y.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=i(a);var b=a[0].ownerDocument,d=w.scrollLeft(b),e=w.scrollTop(b),n=a.offset(),k=n.left;n=n.top;if(w.viewportHeight(b)+e<n||n<e||w.viewportWidth(b)+d<k||k<d)a.scrollIntoView(b)},
_4e_getElementsByTagName:function(a,b,d){a=s(a);if(!D.ie&&d)b=d+":"+b;d=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)d.push(new C(a[b]));return d}};H.DOM._4e_inject=function(a){H.mix(w,a);for(var b in a)a.hasOwnProperty(b)&&function(d){C.prototype[d]=function(){var e=[].slice.call(arguments,0);e.unshift(this);return a[d].apply(null,e)}}(b)};H.DOM._4e_inject(r)});
KISSY.Editor.add("elementpath",function(y){function G(h){var q=null,t=null,A=[];for(h=h;h&&h[0];){if(h[0].nodeType==C.NODE_ELEMENT){if(!this.lastElement)this.lastElement=h;var s=h._4e_name();if(M.ie&&h[0].scopeName!="HTML")s=h[0].scopeName.toLowerCase()+":"+s;if(!t){if(!q&&l[s])q=h;if(g[s]){var i;if(i=!q){if(i=s=="div"){a:{i=h;i=i[0]||i;i=i.childNodes;for(var r=0,a=i.length;r<a;r++){var b=i[r];if(b.nodeType==C.NODE_ELEMENT&&D.$block[b.nodeName.toLowerCase()]){i=true;break a}}i=false}i=!i}i=i}if(i)q=
h;else t=h}}A.push(h);if(s=="body")break}h=h.parent()}this.block=q;this.blockLimit=t;this.elements=A}var H=KISSY,w=H.DOM,D=y.XHTML_DTD,C=y.NODE,M=H.UA,l={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},g={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};G.prototype={compare:function(h){var q=this.elements;h=h&&h.elements;if(!h||q.length!=h.length)return false;for(var t=0;t<q.length;t++)if(!w._4e_equals(q[t],h[t]))return false;return true},contains:function(h){for(var q=
this.elements,t=0;t<q.length;t++)if(q[t]._4e_name()in h)return q[t];return null}};y.ElementPath=G});
KISSY.Editor.add("walker",function(y){function G(g,h){if(this._.end)return null;var q,t=this.range,A,s=this.guard,i=this.type,r=g?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;t.trim();if(t.collapsed){this.end();return null}}if(!g&&!this._.guardLTR){var a=t.endContainer,b=new l(a[0].childNodes[t.endOffset]);this._.guardLTR=function(k,c){return(k=M._4e_wrap(k))&&k[0]&&(!c||!M._4e_equals(a,k))&&(!b[0]||!k._4e_equals(b))&&(k[0].nodeType!=C.NODE_ELEMENT||!c||k._4e_name()!=
"body")}}if(g&&!this._.guardRTL){var d=t.startContainer,e=t.startOffset>0&&new l(d[0].childNodes[t.startOffset-1]);this._.guardRTL=function(k,c){return(k=M._4e_wrap(k))&&k[0]&&(!c||!k._4e_equals(d))&&(!e[0]||!k._4e_equals(e))&&(k[0].nodeType!=C.NODE_ELEMENT||!c||k._4e_name()!="body")}}var n=g?this._.guardRTL:this._.guardLTR;A=s?function(k,c){if(n(k,c)===false)return false;return s(k,c)}:n;if(this.current)q=this.current[r](false,i,A);else if(g){q=t.endContainer;if(t.endOffset>0){q=new l(q[0].childNodes[t.endOffset-
1]);if(A(q)===false)q=null}else q=A(q,true)===false?null:q._4e_previousSourceNode(true,i,A)}else{q=t.startContainer;if((q=new l(q[0].childNodes[t.startOffset]))&&q[0]){if(A(q)===false)q=null}else q=A(t.startContainer,true)===false?null:t.startContainer._4e_nextSourceNode(true,i,A)}for(;q&&q[0]&&!this._.end;){this.current=q;if(!this.evaluator||this.evaluator(q)!==false){if(!h)return q}else if(h&&this.evaluator)return false;q=q[r](false,i,A)}this.end();return this.current=null}function H(g){for(var h,
q=null;h=G.call(this,g);)q=h;return q}function w(g){this.range=g;this._={}}var D=KISSY,C=y.NODE,M=D.DOM,l=D.Node;D.augment(w,{end:function(){this._.end=1},next:function(){return G.call(this)},previous:function(){return G.call(this,true)},checkForward:function(){return G.call(this,false,true)!==false},checkBackward:function(){return G.call(this,true,true)!==false},lastForward:function(){return H.call(this)},lastBackward:function(){return H.call(this,true)},reset:function(){delete this.current;this._=
{}}});w.blockBoundary=function(g){return function(h){h=M._4e_wrap(h);return!(h&&h[0].nodeType==C.NODE_ELEMENT&&h._4e_isBlockBoundary(g))}};w.listItemBoundary=function(){return this.blockBoundary({br:1})};w.bookmark=function(g,h){function q(t){return t&&t[0]&&t._4e_name()=="span"&&t.attr("_ke_bookmark")}return function(t){var A,s;A=t&&t[0]&&t[0].nodeType==C.NODE_TEXT&&(s=t.parent())&&q(s);A=g?A:A||q(t);return h^A}};w.whitespaces=function(g){return function(h){h=(h=h[0]||h)&&h.nodeType==C.NODE_TEXT&&
!D.trim(h.nodeValue);return g^h}};w.invisible=function(g){var h=w.whitespaces();return function(q){q=h(q)||q[0].nodeType==C.NODE_ELEMENT&&!q[0].offsetHeight;return g^q}};y.Walker=w});
KISSY.Editor.add("range",function(y){function G(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=c}function H(c){var f=c[0].nodeType!=g.NODE_TEXT&&c._4e_name()in r.$removeEmpty,j=!l.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return f||j||c}function w(c){return!n(c)&&!k(c)}function D(c){var f=false,j=t.bookmark(true);return function(m){if(j(m))return true;if(m[0].nodeType==g.NODE_TEXT){if(l.trim(m[0].nodeValue).length)return false}else if(m[0].nodeType==
g.NODE_ELEMENT)if(!e[m._4e_name()])if(!c&&!i.ie&&m._4e_name()=="br"&&!f)f=true;else return false;return true}}function C(c,f){function j(m){return m&&m.nodeName=="span"&&m.getAttribute("_ke_bookmark")}return function(m){var o,x;o=m&&!m.nodeName&&(x=m.parentNode)&&j(x);o=c?o:o||j(m);return f^o}}function M(c){return function(f){f=(f=f[0]||f)&&f.nodeType==g.NODE_TEXT&&!l.trim(f.nodeValue);return c^f}}y.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var l=KISSY,g=y.NODE,h=y.RANGE,q=y.POSITION,t=y.Walker,A=l.DOM,s=y.Utils.getByAddress,i=l.UA,r=y.XHTML_DTD,a=y.ElementPath,b=l.Node,d={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};G.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return c.join("<br/>")};l.augment(G,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&A._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,f=this.startOffset;if(c[0].nodeType!=g.NODE_ELEMENT)if(f)f>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;f=this.endOffset;if(c[0].nodeType!=g.NODE_ELEMENT)if(f)f>=c[0].nodeValue.length&&
this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,f=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,h.POSITION_BEFORE_START);f&&f._4e_name()=="span"&&
f.attr("_ke_bookmark")&&this.setEndAt(f,h.POSITION_AFTER_END)},setStart:function(c,f){if(c[0].nodeType==g.NODE_ELEMENT&&d[c._4e_name()]){c=c.parent();f=c._4e_index()}this.startContainer=c;this.startOffset=f;if(!this.endContainer){this.endContainer=c;this.endOffset=f}this.updateCollapsed()},setEnd:function(c,f){if(c[0].nodeType==g.NODE_ELEMENT&&d[c._4e_name()]){c=c.parent();f=c._4e_index()+1}this.endContainer=c;this.endOffset=f;if(!this.startContainer){this.startContainer=c;this.startOffset=f}this.updateCollapsed()},
setStartAt:function(c,f){switch(f){case h.POSITION_AFTER_START:this.setStart(c,0);break;case h.POSITION_BEFORE_END:c[0].nodeType==g.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setStartBefore(c);break;case h.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,f){switch(f){case h.POSITION_AFTER_START:this.setEnd(c,0);break;case h.POSITION_BEFORE_END:c[0].nodeType==g.NODE_TEXT?this.setEnd(c,
c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setEndBefore(c);break;case h.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,f){var j=this.startContainer,m=this.endContainer,o=this.startOffset,x=this.endOffset,J,I=this.document,K;this.optimizeBookmark();if(m[0].nodeType==g.NODE_TEXT)m=m._4e_splitText(x);else if(m[0].childNodes.length>0)if(x>=m[0].childNodes.length){m=new b(m[0].appendChild(I.createTextNode("")));
K=true}else m=new b(m[0].childNodes[x]);if(j[0].nodeType==g.NODE_TEXT){j._4e_splitText(o);if(j._4e_equals(m))m=new b(j[0].nextSibling)}else if(o)if(o>=j[0].childNodes.length){J=new b(I.createTextNode(""));j.append(J);j=J;J=true}else j=new b(j[0].childNodes[o].previousSibling);else{J=new b(I.createTextNode(""));(o=j[0].firstChild)?A.insertBefore(J[0],o):j.append(J);j=J;J=true}o=j._4e_parents();x=m._4e_parents();var L,P,O;for(L=0;L<o.length;L++){P=o[L];O=x[L];if(!P._4e_equals(O))break}I=f;for(var p,
B,u,v=L;v<o.length;v++){p=o[v];if(I&&!p._4e_equals(j))B=I.appendChild(p._4e_clone()[0]);for(p=p[0].nextSibling;p;){if(A._4e_equals(x[v],p)||A._4e_equals(m,p))break;u=p.nextSibling;if(c==2)I.appendChild(p.cloneNode(true));else{p.parentNode.removeChild(p);c==1&&I.appendChild(p)}p=u}if(B)I=B}I=f;for(L=L;L<x.length;L++){p=x[L];if(c>0&&!p._4e_equals(m))B=I.appendChild(p._4e_clone()[0]);if(!o[L]||!p.parent()._4e_equals(o[L].parent()))for(p=p[0].previousSibling;p;){if(A._4e_equals(o[L],p)||A._4e_equals(j,
p))break;u=p.previousSibling;if(c==2)I.insertBefore(p.cloneNode(true),I.firstChild);else{A._4e_remove(p);c==1&&I.insertBefore(p,I.firstChild)}p=u}if(B)I=B}if(c==2){O=this.startContainer[0];if(O.nodeType==g.NODE_TEXT&&O.nextSibling&&O.nextSibling.nodeType==g.NODE_TEXT){O.data+=O.nextSibling.data;O.parentNode.removeChild(O.nextSibling)}O=this.endContainer[0];if(O.nodeType==g.NODE_TEXT&&O.nextSibling&&O.nextSibling.nodeType==g.NODE_TEXT){O.data+=O.nextSibling.data;O.parentNode.removeChild(O.nextSibling)}}else{if(P&&
O&&(!j.parent()._4e_equals(P.parent())||!m.parent()._4e_equals(O.parent()))){P=O._4e_index();J&&O.parent()._4e_equals(j.parent())&&P--;this.setStart(O.parent(),P)}this.collapse(true)}J&&j._4e_remove();K&&m[0].parentNode&&m._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var c=new G(this.document);c.startContainer=this.startContainer;
c.startOffset=this.startOffset;c.endContainer=this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=g.NODE_ELEMENT||c.endContainer[0].nodeType!=g.NODE_ELEMENT)return null;var f=new y.Walker(c),j=C(true,undefined),m=M(true);c.evaluator=function(o){return m(o)&&j(o)};c=f.next();f.reset();f=f.previous();return c&&c._4e_equals(f)?c:null},shrink:function(c,f){if(!this.collapsed){c=c||
h.SHRINK_TEXT;var j=this.clone(),m=this.startContainer,o=this.endContainer,x=this.startOffset,J=this.endOffset,I=1,K=1;if(m&&m[0].nodeType==g.NODE_TEXT)if(x)if(x>=m[0].nodeValue.length)j.setStartAfter(m);else{j.setStartBefore(m);I=0}else j.setStartBefore(m);if(o&&o[0].nodeType==g.NODE_TEXT)if(J)if(J>=o[0].nodeValue.length)j.setEndAfter(o);else{j.setEndAfter(o);K=0}else j.setEndBefore(o);j=new t(j);j.evaluator=function(P){P=P[0]||P;return P.nodeType==(c==h.SHRINK_ELEMENT?g.NODE_ELEMENT:g.NODE_TEXT)};
var L;j.guard=function(P,O){P=P[0]||P;if(c==h.SHRINK_ELEMENT&&P.nodeType==g.NODE_TEXT)return false;if(O&&P==L)return false;if(!O&&P.nodeType==g.NODE_ELEMENT)L=P;return true};if(I)(m=j[c==h.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(m,f?h.POSITION_AFTER_START:h.POSITION_BEFORE_START);if(K){j.reset();(j=j[c==h.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(j,f?h.POSITION_BEFORE_END:h.POSITION_AFTER_END)}return!!(I||K)}},getTouchedStartNode:function(){var c=this.startContainer;
if(this.collapsed||c[0].nodeType!=g.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var f=this.startContainer,j=this.endContainer,m=this.startOffset,o=this.endOffset,x,J;if(!f||!j)return{start:0,end:0};if(c){if(f[0].nodeType==g.NODE_ELEMENT)if((x=new b(f[0].childNodes[m]))&&x[0]&&x[0].nodeType==g.NODE_TEXT&&m>0&&x[0].previousSibling.nodeType==g.NODE_TEXT){f=x;m=0}for(;f[0].nodeType==g.NODE_TEXT&&(J=f._4e_previous())&&J[0].nodeType==g.NODE_TEXT;){f=J;m+=
J[0].nodeValue.length}if(!this.collapsed){if(j[0].nodeType==g.NODE_ELEMENT)if((x=new b(j[0].childNodes[o]))&&x[0]&&x[0].nodeType==g.NODE_TEXT&&o>0&&x[0].previousSibling.nodeType==g.NODE_TEXT){j=x;o=0}for(;j[0].nodeType==g.NODE_TEXT&&(J=j._4e_previous())&&J[0].nodeType==g.NODE_TEXT;){j=J;o+=J[0].nodeValue.length}}}return{start:f._4e_address(c),end:this.collapsed?null:j._4e_address(c),startOffset:m,endOffset:o,normalized:c,is2:true}},createBookmark:function(c){var f,j,m,o;f=new b("<span>",null,this.document);
f.attr("_ke_bookmark",1);f.css("display","none");f.html("&nbsp;");if(c){m=l.guid("ke_bm_");f.attr("id",m+"S")}if(!this.collapsed){j=f._4e_clone();j.html("&nbsp;");c&&j.attr("id",m+"E");o=this.clone();o.collapse();o.insertNode(j)}o=this.clone();o.collapse(true);o.insertNode(f);if(j){this.setStartAfter(f);this.setEndBefore(j)}else this.moveToPosition(f,h.POSITION_AFTER_END);return{startNode:c?m+"S":f,endNode:c?m+"E":j,serializable:c}},moveToPosition:function(c,f){this.setStartAt(c,f);this.collapse(true)},
trim:function(c,f){var j=this.startContainer,m=this.startOffset,o=this.collapsed;if((!c||o)&&j[0]&&j[0].nodeType==g.NODE_TEXT){if(m)if(m>=j[0].nodeValue.length){m=j._4e_index()+1;j=j.parent()}else{var x=j._4e_splitText(m);m=j._4e_index()+1;j=j.parent();if(A._4e_equals(this.startContainer,this.endContainer))this.setEnd(x,this.endOffset-this.startOffset);else if(A._4e_equals(j,this.endContainer))this.endOffset+=1}else{m=j._4e_index();j=j.parent()}this.setStart(j,m);if(o){this.collapse(true);return}}j=
this.endContainer;m=this.endOffset;if(!(f||o)&&j[0]&&j[0].nodeType==g.NODE_TEXT){if(m){m>=j.nodeValue.length||j._4e_splitText(m);m=j._4e_index()+1}else m=j._4e_index();j=j.parent();this.setEnd(j,m)}},insertNode:function(c){this.optimizeBookmark();this.trim(false,true);var f=this.startContainer,j=f[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);j?A.insertBefore(c[0]||c,j):f[0].appendChild(c[0]||c);A._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},
moveToBookmark:function(c){if(c.is2){var f=s(this.document,c.start,c.normalized),j=c.startOffset,m=c.end&&s(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(f,j);m?this.setEnd(m,c):this.collapse(true)}else{f=(j=c.serializable)?l.one("#"+c.startNode,this.document):c.startNode;c=j?l.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(f);f._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(c,f){var j=this.startContainer,
m=this.endContainer;j=A._4e_equals(j,m)?c&&j[0].nodeType==g.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new b(j[0].childNodes[this.startOffset]):j:j._4e_commonAncestor(m);return f&&j[0].nodeType==g.NODE_TEXT?j.parent():j},enlarge:function(c){switch(c){case h.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var f=new b(this.document.body),j,m,o,x,J,I=false,K,L;K=this.startContainer;L=this.startOffset;if(K[0].nodeType==g.NODE_TEXT){if(L){K=!l.trim(K[0].nodeValue.substring(0,L)).length&&
K;I=!!K}if(K)if(!(x=K[0].previousSibling))o=K.parent()}else{if(L)x=K[0].childNodes[L-1]||K[0].lastChild;x||(o=K)}for(;o||x;){if(o&&!x){if(!J&&A._4e_equals(o,c))J=true;if(!f._4e_contains(o))break;if(!I||o.css("display")!="inline"){I=false;if(J)j=o;else this.setStartBefore(o)}x=o[0].previousSibling}for(;x;){K=false;if(x.nodeType==g.NODE_TEXT){L=x.nodeValue;if(/[^\s\ufeff]/.test(L))x=null;K=/[\s\ufeff]$/.test(L)}else if(x.offsetWidth>0&&!x.getAttribute("_ke_bookmark"))if(I&&r.$removeEmpty[x.nodeName.toLowerCase()]){L=
A.text(x);if(/[^\s\ufeff]/.test(L))x=null;else for(var P=x.all||x.getElementsByTagName("*"),O=0,p;p=P[O++];)if(!r.$removeEmpty[p.nodeName.toLowerCase()]){x=null;break}if(x)K=!!L.length}else x=null;if(K)if(I)if(J)j=o;else o&&this.setStartBefore(o);else I=true;if(x){K=x.previousSibling;if(!o&&!K){o=new b(x);x=null;break}x=K}else o=null}if(o)o=o.parent()}K=this.endContainer;L=this.endOffset;o=x=null;J=I=false;if(K[0].nodeType==g.NODE_TEXT){K=!l.trim(K[0].nodeValue.substring(L)).length&&K;I=!(K&&K[0].nodeValue.length);
if(K)if(!(x=K[0].nextSibling))o=K.parent()}else(x=K[0].childNodes[L])||(o=K);for(;o||x;){if(o&&!x){if(!J&&A._4e_equals(o,c))J=true;if(!f._4e_contains(o))break;if(!I||o.css("display")!="inline"){I=false;if(J)m=o;else o&&this.setEndAfter(o)}x=o[0].nextSibling}for(;x;){K=false;if(x.nodeType==g.NODE_TEXT){L=x.nodeValue;if(/[^\s\ufeff]/.test(L))x=null;K=/^[\s\ufeff]/.test(L)}else if(x.offsetWidth>0&&!x.getAttribute("_ke_bookmark"))if(I&&r.$removeEmpty[x.nodeName.toLowerCase()]){L=A.text(x);if(/[^\s\ufeff]/.test(L))x=
null;else{P=x.all||x.getElementsByTagName("*");for(O=0;p=P[O++];)if(!r.$removeEmpty[p.nodeName.toLowerCase()]){x=null;break}}if(x)K=!!L.length}else x=null;if(K)if(I)if(J)m=o;else this.setEndAfter(o);if(x){K=x.nextSibling;if(!o&&!K){o=new b(x);x=null;break}x=K}else o=null}if(o)o=o.parent()}if(j&&m){c=j._4e_contains(m)?m:j;this.setStartBefore(c);this.setEndAfter(c)}break;case h.ENLARGE_BLOCK_CONTENTS:case h.ENLARGE_LIST_ITEM_CONTENTS:o=new G(this.document);f=new b(this.document.body);o.setStartAt(f,
h.POSITION_AFTER_START);o.setEnd(this.startContainer,this.startOffset);o=new t(o);var B,u,v=t.blockBoundary(c==h.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),z=function(F){var E=v(F);E||(B=F);return E};j=function(F){var E=z(F);if(!E&&F[0]&&F._4e_name()=="br")u=F;return E};o.guard=z;o=o.lastBackward();B=B||f;this.setStartAt(B,B._4e_name()!="br"&&(!o&&this.checkStartOfBlock()||o&&B._4e_contains(o))?h.POSITION_AFTER_START:h.POSITION_AFTER_END);o=this.clone();o.collapse();o.setEndAt(f,h.POSITION_BEFORE_END);
o=new t(o);o.guard=c==h.ENLARGE_LIST_ITEM_CONTENTS?j:z;B=null;o=o.lastForward();B=B||f;this.setEndAt(B,!o&&this.checkEndOfBlock()||o&&B._4e_contains(o)?h.POSITION_BEFORE_END:h.POSITION_BEFORE_START);u&&this.setEndAfter(u)}},checkStartOfBlock:function(){var c=this.startContainer,f=this.startOffset;if(f&&c[0].nodeType==g.NODE_TEXT)if(l.trim(c[0].nodeValue.substring(0,f)).length)return false;this.trim();c=new a(this.startContainer);f=this.clone();f.collapse(true);f.setStartAt(c.block||c.blockLimit,h.POSITION_AFTER_START);
c=new t(f);c.evaluator=D(true);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,f=this.endOffset;if(c[0].nodeType==g.NODE_TEXT)if(l.trim(c[0].nodeValue.substring(f)).length)return false;this.trim();c=new a(this.endContainer);f=this.clone();f.collapse(false);f.setEndAt(c.block||c.blockLimit,h.POSITION_BEFORE_END);c=new t(f);c.evaluator=D(false);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,f){var j=this.clone();j[f==h.START?"setStartAt":"setEndAt"](c,f==h.START?h.POSITION_AFTER_START:h.POSITION_BEFORE_END);j=new t(j);j.evaluator=H;return j[f==h.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,f=this.endContainer,j=this.startOffset,m=this.endOffset,o;if(c[0].nodeType==g.NODE_ELEMENT){o=c[0].childNodes.length;if(o>
j)c=new b(c[0].childNodes[j]);else if(o<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new b(c);c=c._4e_nextSourceNode()||c}}if(f[0].nodeType==g.NODE_ELEMENT){o=f[0].childNodes.length;if(o>m)f=(new b(f[0].childNodes[m]))._4e_previousSourceNode(true);else if(o<1)f=f._4e_previousSourceNode();else{for(f=f[0];f.lastChild;)f=f.lastChild;f=new b(f)}}if(c._4e_position(f)&q.POSITION_FOLLOWING)c=f;return{startNode:c,endNode:f}},fixBlock:function(c,f){var j=this.createBookmark(),
m=new b(this.document.createElement(f));this.collapse(c);this.enlarge(h.ENLARGE_BLOCK_CONTENTS);m[0].appendChild(this.extractContents());m._4e_trim();i.ie||m._4e_appendBogus();this.insertNode(m);this.moveToBookmark(j);return m},splitBlock:function(c){var f=new a(this.startContainer),j=new a(this.endContainer),m=f.block,o=j.block,x=null;if(!f.blockLimit._4e_equals(j.blockLimit))return null;if(c!="br"){if(!m){m=this.fixBlock(true,c);o=(new a(this.endContainer)).block}o||(o=this.fixBlock(false,c))}c=
m&&this.checkStartOfBlock();f=o&&this.checkEndOfBlock();this.deleteContents();if(m&&A._4e_equals(m,o))if(f){x=new a(this.startContainer);this.moveToPosition(o,h.POSITION_AFTER_END);o=null}else if(c){x=new a(this.startContainer);this.moveToPosition(m,h.POSITION_BEFORE_START);m=null}else{o=this.splitElement(m);!i.ie&&!l.inArray(m._4e_name(),["ul","ol"])&&m._4e_appendBogus()}return{previousBlock:m,nextBlock:o,wasStartOfBlock:c,wasEndOfBlock:f,elementPath:x}},splitElement:function(c){if(!this.collapsed)return null;
this.setEndAt(c,h.POSITION_BEFORE_END);var f=this.extractContents(),j=c._4e_clone(false);j[0].appendChild(f);j.insertAfter(c);this.moveToPosition(c,h.POSITION_AFTER_END);return j},moveToElementEditablePosition:function(c,f){var j,m=y.XHTML_DTD;if(m.$empty[c._4e_name()])return false;for(;c&&c[0].nodeType==g.NODE_ELEMENT;){if(j=c._4e_isEditable())this.moveToPosition(c,f?h.POSITION_BEFORE_END:h.POSITION_AFTER_START);else if(m.$inline[c._4e_name()]){this.moveToPosition(c,f?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);
return true}if((c=m.$empty[c._4e_name()]?c[f?"_4e_previous":"_4e_next"](w):c[f?"_4e_last":"_4e_first"](w))&&c[0].nodeType==g.NODE_TEXT){this.moveToPosition(c,f?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);return true}}return j},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==g.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var e={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},n=new t.whitespaces,k=new t.bookmark;y.Range=G});
KISSY.Editor.add("domiterator",function(y){function G(A){if(!(arguments.length<1)){this.range=A;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var H=KISSY,w=H.UA,D=y.Walker,C=y.Range,M=y.RANGE,l=y.NODE,g=y.ElementPath,h=H.Node,q=H.DOM,t=/^[\r\n\t ]*$/;D.bookmark();H.augment(G,{getNextParagraph:function(A){var s,i,r,a,b;if(!this._.lastNode){i=this.range.clone();i.shrink(M.SHRINK_ELEMENT,true);i.enlarge(this.forceBrBreak||!this.enlargeBr?M.ENLARGE_LIST_ITEM_CONTENTS:
M.ENLARGE_BLOCK_CONTENTS);var d=new D(i),e=D.bookmark(true,true);d.evaluator=e;this._.nextNode=d.next();d=new D(i);d.evaluator=e;d=d.previous();this._.lastNode=d._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==l.NODE_TEXT&&!H.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){e=new C(i.document);e.moveToPosition(this._.lastNode,M.POSITION_AFTER_END);if(e.checkEndOfBlock()){e=new g(e.endContainer);this._.lastNode=(e.block||e.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new h(i.document.createTextNode(""));q.insertAfter(this._.lastNode[0],d[0])}i=null}e=this._.nextNode;d=this._.lastNode;for(this._.nextNode=null;e;){var n=false,k=e[0].nodeType!=l.NODE_ELEMENT,c=false;if(k){if(e[0].nodeType==l.NODE_TEXT)if(t.test(e[0].nodeValue))k=false}else{var f=e._4e_name();if(e._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(f=="br")k=true;else if(!i&&!e[0].childNodes.length&&f!="hr"){s=e;r=e._4e_equals(d);break}if(i){i.setEndAt(e,M.POSITION_BEFORE_START);
if(f!="br")this._.nextNode=e}n=true}else{if(e[0].firstChild){if(!i){i=new C(this.range.document);i.setStartAt(e,M.POSITION_BEFORE_START)}e=new h(e[0].firstChild);continue}k=true}}if(k&&!i){i=new C(this.range.document);i.setStartAt(e,M.POSITION_BEFORE_START)}r=(!n||k)&&e._4e_equals(d);if(i&&!n)for(;!e[0].nextSibling&&!r;){f=e.parent();if(f._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){n=true;r||f._4e_equals(d);break}e=f;k=true;r=e._4e_equals(d);c=true}k&&i.setEndAt(e,M.POSITION_AFTER_END);e=e._4e_nextSourceNode(c,
null,d);if((r=!e)||n&&i)break}if(!s){if(!i){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}s=new g(i.startContainer);e=s.blockLimit;n={div:1,th:1,td:1};s=s.block;if((!s||!s[0])&&!this.enforceRealBlocks&&n[e._4e_name()]&&i.checkStartOfBlock()&&i.checkEndOfBlock())s=e;else if(!s||this.enforceRealBlocks&&s._4e_name()=="li"){s=new h(this.range.document.createElement(A||"p"));s[0].appendChild(i.extractContents());s._4e_trim();i.insertNode(s);a=b=true}else if(s._4e_name()!=
"li"){if(!i.checkStartOfBlock()||!i.checkEndOfBlock()){s=s._4e_clone(false);s[0].appendChild(i.extractContents());s._4e_trim();b=i.splitBlock();a=!b.wasStartOfBlock;b=!b.wasEndOfBlock;i.insertNode(s)}}else if(!r)this._.nextNode=s._4e_equals(d)?null:i.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,d)}if(a){i=new h(s[0].previousSibling);if(i[0]&&i[0].nodeType==l.NODE_ELEMENT)if(i._4e_name()=="br")i._4e_remove();else i[0].lastChild&&q._4e_name(i[0].lastChild)=="br"&&q._4e_remove(i[0].lastChild)}if(b){i=
D.bookmark(false,true);a=new h(s[0].lastChild);if(a[0]&&a[0].nodeType==l.NODE_ELEMENT&&a._4e_name()=="br")if(w.ie||a._4e_previous(i)||a._4e_next(i))a._4e_remove()}if(!this._.nextNode)this._.nextNode=r||s._4e_equals(d)?null:s._4e_nextSourceNode(true,null,d);return s}});C.prototype.createIterator=function(){return new G(this)}});
KISSY.Editor.add("selection",function(y){function G(b){this.document=b;this._={cache:{}};if(D.ie){var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!=b||d.parentElement&&d.parentElement().ownerDocument!=b)this.isInvalid=true}}function H(b){var d=b.document,e=new l(d.body),n=new l(d.documentElement);if(D.ie){if(D.ie<8||document.documentMode==7)n.on("click",function(I){C._4e_name(I.target)==="html"&&b.getSelection().getRanges()[0].select()});var k,c,f=1;n.on("mousedown",function(){f=
0});n.on("mouseup",function(){f=1});e.on("focusin",function(I){if(C._4e_name(I.target)=="body")if(k){try{f&&k.select()}catch(K){}k=null}});e.on("focus",function(){c=true;m()});e.on("beforedeactivate",function(I){if(!I.relatedTarget){c=false;f=1}});M.on(C._4e_getWin(d),"blur",function(){d&&d.selection.empty()});e.on("mousedown",function(){j()});e.on("mouseup",function(){c=true;setTimeout(function(){m(true)},0)});e.on("keydown",j);e.on("keyup",function(){c=true;m()});M.on(d,"selectionchange",m);var j=
function(){c=false},m=function(I){if(c){var K=b.document,L=b.getSelection(),P=L&&L.getType(),O=L&&L.getNative();if(I&&O&&P==g.SELECTION_NONE)if(!K.queryCommandEnabled("InsertImage")){setTimeout(function(){m(true)},50);return}var p;if(!(O&&P==g.SELECTION_TEXT&&(p=C._4e_name(O.createRange().parentElement()))&&p in{input:1,textarea:1})){k=O&&L.getRanges()[0];b._monitor()}}}}else{M.on(d,"mouseup",b._monitor,b);M.on(d,"keyup",b._monitor,b)}var o={table:1,pre:1},x=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
J=y.Walker.whitespaces(true);y.Walker.bookmark(false,true);b.on("selectionChange",function(I){var K=I.path;I=(I=I.selection)&&I.getRanges()[0];var L=K.blockLimit;if(I)if(I.collapse&&!K.block&&L._4e_name()=="body"){K=I.fixBlock(true,"p");if(K._4e_outerHtml().match(x))if((L=K._4e_next(J))&&L[0].nodeType==q.NODE_ELEMENT&&!o[L._4e_name()]){I.moveToElementEditablePosition(L);K._4e_remove()}else if((L=K._4e_previous(J))&&L[0].nodeType==q.NODE_ELEMENT&&!o[L._4e_name()]){I.moveToElementEditablePosition(L,
L._4e_outerHtml().match(x)?false:true);K._4e_remove()}I.select();D.ie||b.notifySelectionChange()}})}y.SELECTION={};var w=KISSY,D=w.UA,C=w.DOM,M=w.Event,l=w.Node,g=y.SELECTION,h=y.RANGE,q=y.NODE,t=y.Walker,A=y.Range;g.SELECTION_NONE=1;g.SELECTION_TEXT=2;g.SELECTION_ELEMENT=3;var s={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};w.augment(G,{getNative:D.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=
this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=C._4e_getWin(this.document).getSelection())},getType:D.ie?function(){var b=this._.cache;if(b.type)return b.type;var d=g.SELECTION_NONE;try{var e=this.getNative(),n=e.type;if(n=="Text")d=g.SELECTION_TEXT;if(n=="Control")d=g.SELECTION_ELEMENT;if(e.createRange().parentElement)d=g.SELECTION_TEXT}catch(k){}return b.type=d}:function(){var b=this._.cache;if(b.type)return b.type;var d=g.SELECTION_TEXT,e=this.getNative();
if(e){if(e.rangeCount==1){e=e.getRangeAt(0);var n=e.startContainer;if(n==e.endContainer&&n.nodeType==q.NODE_ELEMENT&&e.endOffset-e.startOffset===1&&s[n.childNodes[e.startOffset].nodeName.toLowerCase()])d=g.SELECTION_ELEMENT}}else d=g.SELECTION_NONE;return b.type=d},getRanges:D.ie?function(){var b=function(d,e){d=d.duplicate();d.collapse(e);for(var n=d.parentElement(),k=n.childNodes,c,f=0;f<k.length;f++){var j=k[f];if(j.nodeType==q.NODE_ELEMENT){c=d.duplicate();c.moveToElementText(j);j=c.compareEndPoints("StartToStart",
d);var m=c.compareEndPoints("EndToStart",d);c.collapse();if(j>0)break;else if(!j||m==1&&j==-1)return{container:n,offset:f};else if(!m)return{container:n,offset:f+1};c=null}}if(!c){c=d.duplicate();c.moveToElementText(n);c.collapse(false)}c.setEndPoint("StartToStart",d);c=c.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;c>0;)c-=k[--f].nodeValue.length}catch(o){c=0}return c===0?{container:n,offset:f}:{container:k[f],offset:-c}};return function(){var d=this._.cache;if(d.ranges)return d.ranges;var e=
this.getNative(),n=e&&e.createRange(),k=this.getType();if(!e)return[];if(k==g.SELECTION_TEXT){e=new A(this.document);k=b(n,true);e.setStart(new l(k.container),k.offset);k=b(n);e.setEnd(new l(k.container),k.offset);return d.ranges=[e]}else if(k==g.SELECTION_ELEMENT){d=this._.cache.ranges=[];for(k=0;k<n.length;k++){var c=n.item(k),f=c.parentNode,j=0;for(e=new A(this.document);j<f.childNodes.length&&f.childNodes[j]!=c;j++);e.setStart(new l(f),j);e.setEnd(new l(f),j+1);d.push(e)}return d}return d.ranges=
[]}}():function(){var b=this._.cache;if(b.ranges)return b.ranges;var d=[],e=this.getNative();if(!e)return[];for(var n=0;n<e.rangeCount;n++){var k=e.getRangeAt(n),c=new A(this.document);c.setStart(new l(k.startContainer),k.startOffset);c.setEnd(new l(k.endContainer),k.endOffset);d.push(c)}return b.ranges=d},getStartElement:function(){var b=this._.cache;if(b.startElement!==undefined)return b.startElement;var d,e=this.getNative();switch(this.getType()){case g.SELECTION_ELEMENT:return this.getSelectedElement();
case g.SELECTION_TEXT:var n=this.getRanges()[0];if(n)if(!n.collapsed){for(n.optimize();;){d=n.startContainer;if(n.startOffset==(d[0].nodeType===q.NODE_ELEMENT?d[0].childNodes.length:d[0].nodeValue.length)&&!d._4e_isBlockBoundary())n.setStartAfter(d);else break}d=n.startContainer;if(d[0].nodeType!=q.NODE_ELEMENT)return d.parent();d=new l(d[0].childNodes[n.startOffset]);if(!d[0]||d[0].nodeType!=q.NODE_ELEMENT)return n.startContainer;for(n=d[0].firstChild;n&&n.nodeType==q.NODE_ELEMENT;){d=new l(n);n=
n.firstChild}return d}if(D.ie){n=e.createRange();n.collapse(true);d=n.parentElement()}else if((d=e.anchorNode)&&d.nodeType!=q.NODE_ELEMENT)d=d.parentNode}return b.startElement=d?C._4e_wrap(d):null},getSelectedElement:function(){var b=this._.cache;if(b.selectedElement!==undefined)return b.selectedElement;var d=this,e;if(D.ie){e=d.getNative().createRange();e=e.item&&e.item(0)}e||(e=function(){for(var n=d.getRanges()[0],k,c,f=2;f&&!((k=n.getEnclosedNode())&&k[0].nodeType==q.NODE_ELEMENT&&s[k._4e_name()]&&
(c=k));f--)n.shrink(h.SHRINK_ELEMENT);return c&&c[0]}());return b.selectedElement=C._4e_wrap(e)},reset:function(){this._.cache={}},selectElement:function(b){var d;if(D.ie)try{d=this.document.body.createControlRange();d.addElement(b[0]);d.select()}catch(e){d=this.document.body.createTextRange();d.moveToElementText(b[0]);d.select()}finally{}else{d=this.document.createRange();d.selectNode(b[0]);b=this.getNative();b.removeAllRanges();b.addRange(d)}this.reset()},selectRanges:function(b){if(D.ie)b[0]&&
b[0].select();else{var d=this.getNative();if(!d)return;d.removeAllRanges();for(var e=0;e<b.length;e++){var n=b[e],k=this.document.createRange(),c=n.startContainer;n.collapsed&&D.gecko&&D.gecko<1.09&&c[0].nodeType==q.NODE_ELEMENT&&!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));k.setStart(c[0],n.startOffset);k.setEnd(n.endContainer[0],n.endOffset);d.addRange(k)}}this.reset()},createBookmarks2:function(b){for(var d=[],e=this.getRanges(),n=0;n<e.length;n++)d.push(e[n].createBookmark2(b));
return d},createBookmarks:function(b){for(var d=[],e=this.getRanges(),n=e.length,k=this.document,c,f=0;f<n;f++){d.push(c=e[f].createBookmark(b,true));var j=(b=c.serializable)?w.one("#"+c.startNode,k):c.startNode;c=b?w.one("#"+c.endNode,k):c.endNode;for(var m=f+1;m<n;m++){var o=e[m],x=o.startContainer,J=o.endContainer;C._4e_equals(x,j.parent())&&o.startOffset++;C._4e_equals(x,c.parent())&&o.startOffset++;C._4e_equals(J,j.parent())&&o.endOffset++;C._4e_equals(J,c.parent())&&o.endOffset++}}return d},
selectBookmarks:function(b){for(var d=[],e=0;e<b.length;e++){var n=new A(this.document);n.moveToBookmark(b[e]);d.push(n)}this.selectRanges(d);return this},getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4e_commonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();b&&b._4e_scrollIntoView()},removeAllRanges:function(){var b=this.getNative();D.ie?b.clear():b.removeAllRanges()}});y.Selection=G;var i={table:1,tbody:1,tr:1},r=t.whitespaces(true),
a=/\ufeff|\u00a0/;A.prototype.select=D.ie?function(b){var d=this.collapsed,e,n;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var k=this.startContainer[0].childNodes[this.startOffset];if(k.nodeType==q.NODE_ELEMENT){(new G(this.document)).selectElement(new l(k));return}}if(this.startContainer[0].nodeType==q.NODE_ELEMENT&&this.startContainer._4e_name()in i||this.endContainer[0].nodeType==q.NODE_ELEMENT&&this.endContainer._4e_name()in i)this.shrink(h.SHRINK_ELEMENT,
true);var c=this.createBookmark();k=c.startNode;var f;if(!d)f=c.endNode;c=this.document.body.createTextRange();c.moveToElementText(k[0]);c.moveStart("character",1);if(f){b=this.document.body.createTextRange();b.moveToElementText(f[0]);c.setEndPoint("EndToEnd",b);c.moveEnd("character",-1)}else{for(e=k[0].nextSibling;e&&!r(e);)e=e.nextSibling;e=!(e&&e.nodeValue&&e.nodeValue.match(a))&&(b||!k[0].previousSibling||k[0].previousSibling&&C._4e_name(k[0].previousSibling)=="br");n=this.document.createElement("span");
n.innerHTML="&#65279;";n=new l(n);C.insertBefore(n[0],k[0]);e&&C.insertBefore(this.document.createTextNode("\ufeff"),k[0])}this.setStartBefore(k);k._4e_remove();if(d){if(e){c.moveStart("character",-1);c.select();this.document.selection.clear()}else c.select();if(n){this.moveToPosition(n,h.POSITION_BEFORE_START);n._4e_remove()}}else{this.setEndBefore(f);f._4e_remove();c.select()}}:function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==q.NODE_ELEMENT&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));
var d=this.document.createRange();d.setStart(b[0],this.startOffset);try{d.setEnd(this.endContainer[0],this.endOffset)}catch(e){if(e.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);d.setEnd(this.endContainer[0],this.endOffset)}else throw e;}b=new G(this.document);b=(!b||b.isInvalid?null:b).getNative();b.removeAllRanges();b.addRange(d)};y.on("instanceCreated",function(b){H(b.editor)})});
KISSY.Editor.add("styles",function(y){function G(p,B){for(var u in p)p[u]=p[u].replace(O,function(v,z){return B[z]})}function H(p,B){if(B){p=e.clone(p);G(p.attributes,B);G(p.styles,B)}var u=this.element=(p.element||"*").toLowerCase();this.type=u=="#"||K[u]?k.STYLE_BLOCK:L[u]?k.STYLE_OBJECT:k.STYLE_INLINE;this._={definition:p}}function w(p,B){var u=B?this.removeFromRange:this.applyToRange;p.body.focus();for(var v=new f(p),z=v.getRanges(),F=0;F<z.length;F++)u.call(this,z[F]);v.selectRanges(z)}function D(p,
B){var u;u=p.element;if(u=="*")u="span";u=new x(B.createElement(u));return C(u,p)}function C(p,B){var u=B._.definition,v=u.attributes;u=H.getStyleText(u);if(v)for(var z in v)p.attr(z,v[z]);if(u)p[0].style.cssText=u;return p}function M(p){var B=p.createBookmark(true),u=p.createIterator();u.enforceRealBlocks=true;u.enlargeBr=true;for(var v,z=p.document;v=u.getNextParagraph();){var F=D(this,z);v=v;var E=F;F=E._4e_name=="pre";var N=v._4e_name=="pre",T=!F&&N;if(F&&!N){N=v;E=E;T=N.html();T=l(T,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,
"");T=T.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");T=T.replace(/([ \t\n\r]+|&nbsp;)/g," ");T=T.replace(/<br\b[^>]*>/gi,"\n");if(J.ie){N=N[0].ownerDocument.createElement("div");N.appendChild(E[0]);E[0].outerHTML="<pre>"+T+"</pre>";E=new x(N.firstChild);E._4e_remove()}else E.html(T);E=E}else if(T)E=h(g(v),E);else v._4e_moveChildren(E);v[0].parentNode.replaceChild(E[0],v[0]);if(F){v=E;F=void 0;if((F=v._4e_previousSourceNode(true,j.NODE_ELEMENT))&&F._4e_name()=="pre"){E=l(F.html(),/\n$/,"")+"\n\n"+
l(v.html(),/^\n/,"");if(J.ie)v[0].outerHTML="<pre>"+E+"</pre>";else v.html(E);F._4e_remove()}}}p.moveToBookmark(B)}function l(p,B,u){var v="",z="";p=p.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(F,E,N){E&&(v=E);N&&(z=N);return""});return v+p.replace(B,u)+z}function g(p){var B=[];l(p._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(u,v,z){return v+"</pre>"+z+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(u,
v){B.push(v)});return B}function h(p,B){for(var u=B[0].ownerDocument.createDocumentFragment(),v=0;v<p.length;v++){var z=p[v];z=z.replace(/(\r\n|\r)/g,"\n");z=l(z,/^[ \t]*\n/,"");z=l(z,/\n$/,"");z=l(z,/^[ \t]+|[ \t]+$/g,function(E,N){return E.length==1?"&nbsp;":N?" "+Array(E.length).join("&nbsp;"):Array(E.length).join("&nbsp;")+" "});z=z.replace(/\n/g,"<br>");z=z.replace(/[ \t]{2,}/g,function(E){return Array(E.length).join("&nbsp;")+" "});var F=B._4e_clone();F.html(z);u.appendChild(F[0])}return u}
function q(p){var B=p.document;if(p.collapsed){B=D(this,B);p.insertNode(B);p.moveToPosition(B,c.POSITION_BEFORE_END)}else{var u=this.element,v=this._.definition,z,F=y.XHTML_DTD[u]||(z=true,y.XHTML_DTD.span),E=p.createBookmark();p.enlarge(c.ENLARGE_ELEMENT);p.trim();var N=p.createBookmark(),T=N.startNode;N=N.endNode;for(var S=T,V;S&&S[0];){var Q=false;if(n._4e_equals(S,N)){S=null;Q=true}else{var R=S[0].nodeType,Y=R==j.NODE_ELEMENT?S._4e_name():null;if(Y&&S.attr("_ke_bookmark")){S=S._4e_nextSourceNode(true);
continue}if(!Y||F[Y]&&(S._4e_position(N)|m.POSITION_PRECEDING|m.POSITION_IDENTICAL|m.POSITION_IS_CONTAINED)==m.POSITION_PRECEDING+m.POSITION_IDENTICAL+m.POSITION_IS_CONTAINED&&(!v.childRule||v.childRule(S))){var U=S.parent();if(U&&U[0]&&((y.XHTML_DTD[U._4e_name()]||y.XHTML_DTD.span)[u]||z)&&(!v.parentRule||v.parentRule(U))){if(!V&&(!Y||!y.XHTML_DTD.$removeEmpty[Y]||(S._4e_position(N)|m.POSITION_PRECEDING|m.POSITION_IDENTICAL|m.POSITION_IS_CONTAINED)==m.POSITION_PRECEDING+m.POSITION_IDENTICAL+m.POSITION_IS_CONTAINED)){V=
new o(B);V.setStartBefore(S)}if(R==j.NODE_TEXT||R==j.NODE_ELEMENT&&!S[0].childNodes.length){R=S;for(var W;!R[0].nextSibling&&(W=R.parent(),F[W._4e_name()])&&(W._4e_position(T)|m.POSITION_FOLLOWING|m.POSITION_IDENTICAL|m.POSITION_IS_CONTAINED)==m.POSITION_FOLLOWING+m.POSITION_IDENTICAL+m.POSITION_IS_CONTAINED&&(!v.childRule||v.childRule(W));)R=W;V.setEndAfter(R);R[0].nextSibling||(Q=true)}}else Q=true}else Q=true;S=S._4e_nextSourceNode()}if(Q&&V&&!V.collapsed){Q=D(this,B);for(R=V.getCommonAncestor();Q&&
R&&Q[0]&&R[0];){if(R._4e_name()==u){for(var X in v.attributes)Q.attr(X)==R.attr(X)&&Q[0].removeAttribute(X);for(var aa in v.styles)Q._4e_style(aa)==R._4e_style(aa)&&Q._4e_style(aa,"");if(!Q._4e_hasAttributes()){Q=null;break}}R=R.parent()}if(Q){Q[0].appendChild(V.extractContents());R=Q;Y=i(this);U=R.all(this.element);for(var Z=U.length;--Z>=0;)r(this,new x(U[Z]));var $=void 0;for($ in Y)if($!=this.element){U=R.all($);for(Z=U.length-1;Z>=0;Z--){var ba=new x(U[Z]);b(ba,Y[$])}}V.insertNode(Q);Q._4e_mergeSiblings();
J.ie||Q[0].normalize()}V=null}}T._4e_remove();N._4e_remove();p.moveToBookmark(E);p.shrink(c.SHRINK_TEXT)}}function t(p){p.enlarge(c.ENLARGE_ELEMENT);var B=p.createBookmark(),u=B.startNode;if(p.collapsed){for(var v=new I(u.parent()),z,F=0,E;F<v.elements.length&&(E=v.elements[F]);F++){if(E==v.block||E==v.blockLimit)break;if(this.checkElementRemovable(E)){var N=p.checkBoundaryOfElement(E,c.END),T=!N&&p.checkBoundaryOfElement(E,c.START);if(T||N){z=E;z.match=T?"start":"end"}else{E._4e_mergeSiblings();
E._4e_name()==this.element?r(this,E):b(E,i(this)[E._4e_name()])}}}if(z&&z[0]){E=u;for(F=0;;F++){N=v.elements[F];if(n._4e_equals(N,z))break;else if(N.match)continue;else N=N._4e_clone();N[0].appendChild(E[0]);E=N}n[z.match=="start"?"insertBefore":"insertAfter"](E[0],z[0])}}else{var S=B.endNode,V=this;v=function(){for(var Q=new I(u.parent()),R=new I(S.parent()),Y=null,U=null,W=0;W<Q.elements.length;W++){var X=Q.elements[W];if(X==Q.block||X==Q.blockLimit)break;if(V.checkElementRemovable(X))Y=X}for(W=
0;W<R.elements.length;W++){X=R.elements[W];if(X==R.block||X==R.blockLimit)break;if(V.checkElementRemovable(X))U=X}U&&S._4e_breakParent(U);Y&&u._4e_breakParent(Y)};v();for(z=new x(u[0].nextSibling);z[0]!==S[0];){F=z._4e_nextSourceNode();if(z[0]&&z[0].nodeType==j.NODE_ELEMENT&&this.checkElementRemovable(z)){z._4e_name()==this.element?r(this,z):b(z,i(this)[z._4e_name()]);if(F[0].nodeType==j.NODE_ELEMENT&&F._4e_contains(u)){v();F=new x(u[0].nextSibling)}}z=F}}p.moveToBookmark(B)}function A(p){var B={};
p.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(u,v,z){B[v]=z});return B}function s(p,B){var u;if(B!==false){u=document.createElement("span");u.style.cssText=p;u=u.style.cssText||""}else u=p;return u.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function i(p){if(p._.overrides)return p._.overrides;var B=p._.overrides={},u=p._.definition.overrides;if(u){e.isArray(u)||(u=[u]);for(var v=0;v<u.length;v++){var z=u[v],F,E;if(typeof z==
"string")F=z.toLowerCase();else{F=z.element?z.element.toLowerCase():p.element;E=z.attributes}z=B[F]||(B[F]={});if(E){z=z.attributes=z.attributes||[];for(var N in E)z.push([N.toLowerCase(),E[N]])}}}return B}function r(p,B){var u=p._.definition,v=e.mix(e.mix({},u.attributes),i(p)[B._4e_name()]);u=u.styles;var z=e.isEmptyObject(v)&&e.isEmptyObject(u),F;for(F in v)if(!((F=="class"||p._.definition.fullMatch)&&B.attr(F)!=a(F,v[F]))){z=z||!!B._4e_hasAttribute(F);B.removeAttr(F)}for(var E in u)if(!(p._.definition.fullMatch&&
B._4e_style(E)!=a(E,u[E],true))){z=z||!!B._4e_style(E);B._4e_style(E,"")}z&&d(B)}function a(p,B,u){var v=new x("<span></span>");v[u?"_4e_style":"attr"](p,B);return v[u?"_4e_style":"attr"](p)}function b(p,B){var u=B&&B.attributes;if(u)for(var v=0;v<u.length;v++){var z=u[v][0],F;if(F=p.attr(z)){var E=u[v][1];if(E===null||E.test&&E.test(F)||typeof E=="string"&&F==E)p[0].removeAttribute(z)}}d(p)}function d(p){if(!p._4e_hasAttributes()){var B=p[0].firstChild,u=p[0].lastChild;p._4e_remove(true);if(B){B.nodeType==
j.NODE_ELEMENT&&n._4e_mergeSiblings(B);u&&!B===u&&u.nodeType==j.NODE_ELEMENT&&n._4e_mergeSiblings(u)}}}var e=KISSY,n=e.DOM,k=y.STYLE={},c=y.RANGE,f=y.Selection,j=y.NODE,m=y.POSITION,o=y.Range,x=e.Node,J=e.UA,I=y.ElementPath,K={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/,O=/#\((.+?)\)/g;k.STYLE_BLOCK=1;k.STYLE_INLINE=2;k.STYLE_OBJECT=3;H.prototype={apply:function(p){w.call(this,
p,false)},remove:function(p){w.call(this,p,true)},applyToRange:function(p){return(this.applyToRange=this.type==k.STYLE_INLINE?q:this.type==k.STYLE_BLOCK?M:this.type==k.STYLE_OBJECT?null:null).call(this,p)},removeFromRange:function(p){return(this.removeFromRange=this.type==k.STYLE_INLINE?t:null).call(this,p)},applyToObject:function(p){C(p,this)},checkElementRemovable:function(p,B){if(!p)return false;var u=this._.definition;if(p._4e_name()==this.element){if(!B&&!p._4e_hasAttributes())return true;var v=
u._AC;if(v)u=v;else{v={};var z=0,F=u.attributes;if(F)for(var E in F){z++;v[E]=F[E]}if(F=H.getStyleText(u)){v.style||z++;v.style=F}v._length=z;u=u._AC=v}if(u._length){for(var N in u)if(N!="_length"){z=p.attr(N)||"";if(N=="style")a:{v=u[N];z=s(z,false);typeof v=="string"&&(v=A(v));typeof z=="string"&&(z=A(z));F=void 0;for(F in v)if(!(F in z&&(z[F]==v[F]||v[F]=="inherit"||z[F]=="inherit"))){v=false;break a}v=true}else v=u[N]==z;if(v){if(!B)return true}else if(B)return false}if(B)return true}else return true}if(N=
i(this)[p._4e_name()]){if(!(u=N.attributes))return true;for(v=0;v<u.length;v++){N=u[v][0];if(N=p.attr(N)){z=u[v][1];if(z===null||typeof z=="string"&&N==z||z.test&&z.test(N))return true}}}return false},checkActive:function(p){switch(this.type){case k.STYLE_BLOCK:return this.checkElementRemovable(p.block||p.blockLimit,true);case k.STYLE_OBJECT:case k.STYLE_INLINE:for(var B=p.elements,u=0,v;u<B.length;u++){v=B[u];if(!(this.type==k.STYLE_INLINE&&(n._4e_equals(v,p.block)||n._4e_equals(v,p.blockLimit))))if(!(this.type==
k.STYLE_OBJECT&&!(v._4e_name()in L)))if(this.checkElementRemovable(v,true))return true}}return false}};H.getStyleText=function(p){var B=p._ST;if(B)return B;B=p.styles;var u=p.attributes&&p.attributes.style||"",v="";if(u.length)u=u.replace(P,";");for(var z in B){var F=B[z],E=(z+":"+F).replace(P,";");if(F=="inherit")v+=E;else u+=E}if(u.length)u=s(u);u+=v;return p._ST=u};y.Style=H});
