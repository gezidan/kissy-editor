/*
 Constructor for kissy editor,dependency moved to independent module
 thanks to CKSource's intelligent work on CKEditor
 @author: yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.1.5
 @buildtime: 2010-12-17 17:33:46
*/
KISSY.add("editor",function(p){function x(v,s){var m=this;if(!(m instanceof x))return new x(v,s);if(p.isString(v))v=p.one(v);v=C._4e_wrap(v);s=s||{};s.pluginConfig=s.pluginConfig||{};m.cfg=s;s.pluginConfig=s.pluginConfig;m.cfg=s;p.app(m,p.EventTarget);var h=["htmldataprocessor","enterkey","clipboard"],c=t;m.use=function(g,f){g=g.split(",");if(!c)for(var j=0;j<h.length;j++){var A=h[j];p.inArray(A,g)||g.unshift(A)}m.ready(function(){p.use.call(m,g.join(","),function(){for(var k=0;k<g.length;k++)m.usePlugin(g[k]);
f&&f.call(m);if(!c){m.setData(v.val());if(s.focus)m.focus();else(k=m.getSelection())&&k.removeAllRanges();c=B}},{global:x})});return m};m.use=m.use;m.Config.base=x.Config.base;m.Config.componentJsName="plugin.js?t=2010-12-17 17:33:46";m.init(v);return m}var C=p.DOM,B=true,t=false;p.app(x,p.EventTarget);x.Config.base=p.Config.base+"editor/plugins/";x.Config.componentJsName="plugin.js?t=2010-12-17 17:33:46";p.Editor=x;p.Editor=x});
KISSY.Editor.add("utils",function(p){var x=null,C=KISSY,B=C.Node,t=C.DOM,v=C.UA,s=C.Event,m;m=v.ie?document.documentMode||v.ie:void 0;var h={debugUrl:function(c){c=C.Config.debug?c:c.replace(/\.(js|css)/i,"-min.$1");c+=c.indexOf("?")!=-1?"&":"?";c+="t="+encodeURIComponent("2010-12-17 16:59:33");return c},lazyRun:function(c,g,f){var j=c[g],A=c[f];c[g]=function(){j.apply(this,arguments);c[g]=c[f];return A.apply(this,arguments)}},getXY:function(c,g,f,j){f=f.defaultView||f.parentWindow;c-=t.scrollLeft(f);
g-=t.scrollTop(f);if(j)if(f!=(j.defaultView||j.parentWindow)&&f.frameElement){j=t._4e_getOffset(f.frameElement,j);c+=j.left;g+=j.top}return{left:c,top:g}},tryThese:function(){for(var c,g=0,f=arguments.length;g<f;g++){var j=arguments[g];try{c=j();break}catch(A){}}return c},arrayCompare:function(c,g){if(!c&&!g)return true;if(!c||!g||c.length!=g.length)return false;for(var f=0;f<c.length;f++)if(c[f]!==g[f])return false;return true},getByAddress:function(c,g,f){c=c.documentElement;for(var j=0;c&&j<g.length;j++){var A=
g[j];if(f)for(var k=-1,a=0;a<c.childNodes.length;a++){var b=c.childNodes[a];if(!(f===true&&b.nodeType==3&&b.previousSibling&&b.previousSibling.nodeType==3)){k++;if(k==A){c=b;break}}}else c=c.childNodes[A]}return c?new B(c):x},clearAllMarkers:function(c){for(var g in c)c[g]._4e_clearMarkers(c,true)},htmlEncodeAttr:function(c){return c.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(c){return c.replace(/^\s+/,"")},rtrim:function(c){return c.replace(/\s+$/,"")},trim:function(c){return this.ltrim(this.rtrim(c))},
mix:function(){for(var c={},g=0;g<arguments.length;g++)c=C.mix(c,arguments[g]);return c},isCustomDomain:function(){if(!v.ie)return false;var c=document.domain,g=window.location.hostname;return c!=g&&c!="["+g+"]"},duplicateStr:function(c,g){return Array(g+1).join(c)},throttle:function(c,g,f){f=f||150;if(f===-1)return function(){c.apply(g,arguments)};var j=(new Date).getTime();return function(){var A=(new Date).getTime();if(A-j>f){j=A;c.apply(g,arguments)}}},buffer:function(c,g,f){f=f||0;var j=x;return function(){j&&
clearTimeout(j);var A=arguments;j=setTimeout(function(){return c.apply(g,A)},f)}},isNumber:function(c){return/^\d+(.\d+)?$/.test(C.trim(c))},verifyInputs:function(c){for(var g=0;g<c.length;g++){var f=t._4e_wrap(c[g]),j=C.trim(f.val()),A=f.attr("data-verify");f=f.attr("data-warning");if(A&&!RegExp(A).test(j)){alert(f);return false}}return true},sourceDisable:function(c,g){c.on("sourcemode",g.disable,g);c.on("wysiwygmode",g.enable,g)},resetInput:function(c){var g=c.attr("placeholder");if(g&&!v.webkit){c.addClass("ke-input-tip");
c.val(g)}else v.webkit&&c.val("")},valInput:function(c,g){c.removeClass("ke-input-tip");c.val(g)},placeholder:function(c,g){c.attr("placeholder",g);if(!v.webkit){c.on("blur",function(){if(!C.trim(c.val())){c.addClass("ke-input-tip");c.val(g)}});c.on("focus",function(){c.removeClass("ke-input-tip");C.trim(c.val())==g&&c.val("")})}},clean:function(c){c=c[0]||c;for(var g=C.makeArray(c.childNodes),f=0;f<g.length;f++){var j=g[f];j.nodeType==p.NODE.NODE_TEXT&&!C.trim(j.nodeValue)&&c.removeChild(j)}},htmlEncode:function(c){return!c?
c:String(c).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(c){return!c?c:String(c).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(c,g){return c.toLowerCase()==g.toLowerCase()},normParams:function(c){c=C.clone(c);for(var g in c)if(c.hasOwnProperty(g)){var f=c[g];if(C.isFunction(f))c[g]=f()}return c},doFormUpload:function(c,g,f){function j(){var D={responseText:"",responseXML:x};
D.argument=c?c.argument:x;try{var r;if((r=v.ie?k.contentWindow.document:k.contentDocument||window.frames[A].document)&&r.body)D.responseText=r.body.innerHTML;D.responseXML=r&&r.XMLDocument?r.XMLDocument:r}catch(E){C.log(E)}s.remove(k,"load",j);c.callback&&c.callback(D);setTimeout(function(){t._4e_remove(k)},100)}var A=C.guid("form-upload-"),k=document.createElement("iframe");k.id=A;k.name=A;k.className="ke-hidden";var a="document.open();"+(h.isCustomDomain()?'document.domain="'+document.domain+'";':
"")+"document.close();";if(v.ie)k.src=v.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";C.log("doFormUpload : "+k.src);document.body.appendChild(k);if(v.ie)document.frames[A].name=A;a=t._4e_unwrap(c.form);var b={target:a.target,method:a.method,encoding:a.encoding,enctype:a.enctype,action:a.action};a.target=A;a.method="POST";a.enctype=a.encoding="multipart/form-data";if(f)a.action=f;var d;if(g){d=[];g=p.Utils.normParams(g);for(var l in g)if(g.hasOwnProperty(l)){f=document.createElement("input");
f.type="hidden";f.name=l;f.value=g[l];a.appendChild(f);d.push(f)}}s.on(k,"load",j);a.submit();a.target=b.target;a.method=b.method;a.enctype=b.enctype;a.encoding=b.encoding;a.action=b.action;if(d){g=0;for(l=d.length;g<l;g++)t._4e_remove(d[g])}return k},extern:function(c,g){for(var f in g)c[f]=g[f]},map:function(c,g){for(var f=0;f<c.length;f++)c[f]=g(c[f]);return c},ieEngine:m,preventFocus:function(c){v.ie?c._4e_unselectable():c.attr("onmousedown","return false;")},isFlashEmbed:function(c){c=c.attributes;
return c.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(c.src||"")}};p.Utils=h;p.Utils=h;v.ieEngine=h.ieEngine;h.extern(h,{debugUrl:h.debugUrl,lazyRun:h.lazyRun,getXY:h.getXY,tryThese:h.tryThese,arrayCompare:h.arrayCompare,getByAddress:h.getByAddress,clearAllMarkers:h.clearAllMarkers,htmlEncodeAttr:h.htmlEncodeAttr,ltrim:h.ltrim,rtrim:h.rtrim,trim:h.trim,mix:h.mix,isCustomDomain:h.isCustomDomain,duplicateStr:h.duplicateStr,buffer:h.buffer,isNumber:h.isNumber,verifyInputs:h.verifyInputs,
sourceDisable:h.sourceDisable,resetInput:h.resetInput,placeholder:h.placeholder,clean:h.clean,htmlEncode:h.htmlEncode,htmlDecode:h.htmlDecode,equalsIgnoreCase:h.equalsIgnoreCase,normParams:h.normParams,throttle:h.throttle,doFormUpload:h.doFormUpload,map:h.map})});
KISSY.Editor.add("dom",function(p){function x(a){return a.replace(/-(\w)/g,function(b,d){return d.toUpperCase()})}var C=KISSY,B=C.DOM,t=C.UA,v=C.Node,s=p.Utils,m={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};p.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};p.NODE=p.NODE;p.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};p.POSITION=p.POSITION;var h=p.NODE,c=p.POSITION,g={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},f={hr:1},j=function(a){return a[0]||a},A=function(a){if(a&&!a[0])return new v(a);return a},k={_4e_wrap:A,_4e_unwrap:j,_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=j(a);b=j(b);
return a===b},_4e_isBlockBoundary:function(a,b){a=A(a);var d=C.mix(C.mix({},f),b||{});return g[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=j(a);for(var b=a.parentNode.childNodes,d=0;d<b.length;d++)if(b[d]===a)return d;return-1},_4e_first:function(a,b){a=j(a);var d=a.firstChild;if((d=d&&new v(d))&&b&&!b(d))d=d._4e_next(b);return d},_4e_move:function(a,b,d){a=j(a);B._4e_remove(a);
b=j(b);d?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_name:function(a){a=j(a);var b=a.nodeName.toLowerCase();if(t.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var d=a[0].attributes,l=b[0].attributes,D=d.length,r=l.length;if(D!=r)return false;for(var E=0;E<D;E++){var o=d[E],u=o.name;if(o.specified&&a.attr(u)!=b.attr(u))return false}if(s.ieEngine<8)for(E=0;E<r;E++){o=l[E];u=o.name;if(o.specified&&
a.attr(u)!=b.attr(u))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=j(a).childNodes;for(var b=0,d=a.length;b<d;b++){var l=a[b],D=l.nodeType;if(!(D==h.NODE_ELEMENT&&l.getAttribute("_ke_bookmark")))if(D==h.NODE_ELEMENT&&!k._4e_isEmptyInlineRemoveable(l)||D==h.NODE_TEXT&&C.trim(l.nodeValue))return false}return true},_4e_moveChildren:function(a,b,d){a=j(a);b=b[0]||b;if(a!=b)if(d)for(;d=a.lastChild;)b.insertBefore(a.removeChild(d),b.firstChild);else for(;d=a.firstChild;)b.appendChild(a.removeChild(d))},
_4e_mergeSiblings:function(){function a(b,d,l){if(d[0]&&d[0].nodeType==h.NODE_ELEMENT){for(var D=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){D.push(d);d=l?new v(d[0].nextSibling):new v(d[0].previousSibling);if(!d[0]||d[0].nodeType!=h.NODE_ELEMENT)return}if(b._4e_isIdentical(d)){for(var r=l?b[0].lastChild:b[0].firstChild;D.length;)D.shift()._4e_move(b,!l);d._4e_moveChildren(b,!l);d._4e_remove();r[0]&&r[0].nodeType==h.NODE_ELEMENT&&r._4e_mergeSiblings()}}}return function(b){if(b[0])if(m[b._4e_name()]||
b._4e_name()=="a"){a(b,new v(b[0].nextSibling),true);a(b,new v(b[0].previousSibling))}}}(),_4e_unselectable:t.gecko?function(a){a=j(a);a.style.MozUserSelect="none"}:t.webkit?function(a){a=j(a);a.style.KhtmlUserSelect="none"}:function(a){a=j(a);if(t.ie||t.opera){var b=0;a.setAttribute("unselectable","on");for(var d=a.getElementsByTagName("*");a=d[b++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.setAttribute("unselectable","on")}}},_4e_getOffset:function(a,
b){a=j(a);var d,l=0;d=0;var D=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,r=a.ownerDocument,E=r.documentElement;b=b||r;if(a.getBoundingClientRect){if(a!==r.body&&E!==a){d=a.getBoundingClientRect();l=d.left+(b===r?B.scrollLeft(D):0);d=d.top+(b===r?B.scrollTop(D):0)}if(b)if(D!=(b.defaultView||b.parentWindow)&&D.frameElement){D=k._4e_getOffset(D.frameElement,b);l+=D.left;d+=D.top}}return{left:l,top:d}},_4e_getFrameDocument:function(a){return(a=j(a))&&a.contentWindow.document},_4e_splitText:function(a,
b){a=j(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=h.NODE_TEXT)){if(t.ie&&b==a.nodeValue.length){var l=d.createTextNode("");B.insertAfter(l,a);return new v(l)}l=new v(a.splitText(b));if(d.documentMode){d=d.createTextNode("");B.insertAfter(d,l[0]);B._4e_remove(d)}return l}},_4e_parents:function(a,b){a=A(a);var d=[];do d[b?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,b,d){a=j(a);a=a.cloneNode(b);if(!d){var l=function(D){if(D.nodeType==h.NODE_ELEMENT){D.removeAttribute("id");
D=D.childNodes;for(var r=0;r<D.length;r++)l(D[r])}};l(a)}return new v(a)},_4e_nextSourceNode:function(a,b,d,l){a=j(a);if(l&&!l.call){var D=l[0]||l;l=function(E){E=E[0]||E;return E!==D}}b=!b&&a.firstChild;var r=new v(a);if(!b){if(a.nodeType==h.NODE_ELEMENT&&l&&l(a,true)===false)return null;b=a.nextSibling}for(;!b&&(r=r.parent());){if(l&&l(r,true)===false)return null;b=r[0].nextSibling}if(!b)return null;b=B._4e_wrap(b);if(l&&l(b)===false)return null;if(d&&d!=b[0].nodeType)return b._4e_nextSourceNode(false,
d,l);return b},_4e_previousSourceNode:function(a,b,d,l){a=j(a);if(l&&!l.call){var D=l[0]||l;l=function(E){E=E[0]||E;return E!==D}}b=!b&&a.lastChild;var r=new v(a);if(!b){if(a.nodeType==h.NODE_ELEMENT&&l&&l(a,true)===false)return null;b=a.previousSibling}for(;!b&&(r=r.parent());){if(l&&l(r,true)===false)return null;b=r[0].previousSibling}if(!b)return null;b=B._4e_wrap(b);if(l&&l(b)===false)return null;if(d&&b[0].nodeType!=d)return b._4e_previousSourceNode(false,d,l);return b},_4e_commonAncestor:function(a,
b){if(a._4e_equals(b))return a;if(b[0].nodeType!=h.NODE_TEXT&&b.contains(a))return b;var d=a[0].nodeType==h.NODE_TEXT?a.parent():a;do if(d[0].nodeType!=h.NODE_TEXT&&d.contains(b))return d;while(d=d.parent());return null},_4e_ascendant:function(a,b,d){a=j(a);if(!d)a=a.parentNode;if(b&&!C.isFunction(b)){var l=b;b=function(D){return D._4e_name()==l}}for(;a&&a.nodeType!=9;){if(!b||b(new v(a))===true)return new v(a);a=a.parentNode}return null},_4e_hasAttribute:s.ieEngine<9?function(a,b){a=j(a);var d=a.attributes[b];
return!!(d&&d.specified)}:function(a,b){a=j(a);return a.hasAttribute(b)},_4e_hasAttributes:s.ieEngine<9?function(a){a=j(a);for(var b=a.attributes,d=0;d<b.length;d++){var l=b[d];switch(l.name){case "class":if(a.getAttribute("class"))return true;break;default:if(l.specified)return true}}return false}:function(a){a=j(a);t.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,b){var d=j(a),l=j(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(l);if(d==
l)return c.POSITION_IDENTICAL;if(d.nodeType==h.NODE_ELEMENT&&l.nodeType==h.NODE_ELEMENT){if(d.contains){if(d.contains(l))return c.POSITION_CONTAINS+c.POSITION_PRECEDING;if(l.contains(d))return c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING}if("sourceIndex"in d)return d.sourceIndex<0||l.sourceIndex<0?c.POSITION_DISCONNECTED:d.sourceIndex<l.sourceIndex?c.POSITION_PRECEDING:c.POSITION_FOLLOWING}d=a._4e_address();l=b._4e_address();for(var D=Math.min(d.length,l.length),r=0;r<=D-1;r++)if(d[r]!=l[r]){if(r<
D)return d[r]<l[r]?c.POSITION_PRECEDING:c.POSITION_FOLLOWING;break}return d.length<l.length?c.POSITION_CONTAINS+c.POSITION_PRECEDING:c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING},_4e_address:function(a,b){a=j(a);for(var d=[],l=a.ownerDocument.documentElement,D=a;D&&D!=l;){var r=D.parentNode,E=-1;if(r){for(var o=0;o<r.childNodes.length;o++){var u=r.childNodes[o];if(!(b&&u.nodeType==3&&u.previousSibling&&u.previousSibling.nodeType==3)){E++;if(u==D)break}}d.unshift(E)}D=r}return d},_4e_breakParent:function(a,
b){var d=new p.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);var l=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(l,a[0].nextSibling)},_4e_style:function(a,b,d){a=A(a);if(d!==undefined)return a.css(b,d);a=j(a);return a.style[x(b)]},_4e_remove:function(a,b){var d=j(a),l=d.parentNode;if(l){if(b)for(var D;D=d.firstChild;)l.insertBefore(d.removeChild(D),d);l.removeChild(d)}return a},_4e_trim:function(a){B._4e_ltrim(a);B._4e_rtrim(a)},_4e_ltrim:function(a){a=
j(a);for(var b;b=a.firstChild;){if(b.nodeType==h.NODE_TEXT){var d=s.ltrim(b.nodeValue),l=b.nodeValue.length;if(d){if(d.length<l){(new v(b))._4e_splitText(l-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=j(a);for(var b;b=a.lastChild;){if(b.type==h.NODE_TEXT){var d=s.rtrim(b.nodeValue),l=b.nodeValue.length;if(d){if(d.length<l){(new v(b))._4e_splitText(d.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!t.ie&&!t.opera)(b=
a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=j(a);for(var b=a.lastChild;b&&b.nodeType==h.NODE_TEXT&&!C.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==h.NODE_TEXT||B._4e_name(b)!=="br"){b=t.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");t.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){var d=j(a),l;do l=(d=d.previousSibling)&&new v(d);while(l&&b&&!b(l));
return l},_4e_last:function(a,b){a=B._4e_wrap(a);var d=a[0].lastChild;if((d=d&&new v(d))&&b&&!b(d))d=d._4e_previous(b);return d},_4e_next:function(a,b){var d=j(a),l;do l=(d=d.nextSibling)&&new v(d);while(l&&b&&!b(l));return l},_4e_outerHtml:function(a){a=j(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,d,l){a=B._4e_wrap(a);var D=a.data("list_marker_id")||a.data("list_marker_id",
C.guid()).data("list_marker_id"),r=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[D]=a;r[d]=1;return a.data(d,l)},_4e_clearMarkers:function(a,b,d){a=A(a);var l=a.data("list_marker_names"),D=a.data("list_marker_id"),r;for(r in l)a.removeData(r);a.removeData("list_marker_names");if(d){a.removeData("list_marker_id");delete b[D]}},_4e_copyAttributes:function(a,b,d){a=j(a);b=A(b);var l=a.attributes;d=d||{};for(var D=0;D<l.length;D++){var r=l[D],E=r.name.toLowerCase(),
o;if(!(E in d))if(E=="checked"&&(o=B.attr(a,E)))b.attr(E,o);else if(r.specified||t.ie&&r.value&&E=="value"){o=B.attr(a,E);if(o===null)o=r.nodeValue;b.attr(E,o)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=B._4e_name(a);var b=p.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=A(a);var b=a[0].ownerDocument,d=B.scrollLeft(b),l=B.scrollTop(b),D=a.offset(),r=D.left;D=D.top;if(B.viewportHeight(b)+l<D||D<l||B.viewportWidth(b)+
d<r||r<d)a.scrollIntoView(b)},_4e_getElementsByTagName:function(a,b,d){a=j(a);if(!t.ie&&d)b=d+":"+b;d=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)d.push(new v(a[b]));return d}};C.DOM._4e_inject=function(a){C.mix(B,a);for(var b in a)a.hasOwnProperty(b)&&function(d){v.prototype[d]=function(){var l=[].slice.call(arguments,0);l.unshift(this);return a[d].apply(null,l)}}(b)};s.extern(k,{_4e_wrap:k._4e_wrap,_4e_unwrap:k._4e_unwrap,_4e_equals:k._4e_equals,_4e_isBlockBoundary:k._4e_isBlockBoundary,
_4e_getWin:k._4e_getWin,_4e_index:k._4e_index,_4e_first:k._4e_first,_4e_move:k._4e_move,_4e_name:k._4e_name,_4e_isIdentical:k._4e_isIdentical,_4e_isEmptyInlineRemoveable:k._4e_isEmptyInlineRemoveable,_4e_moveChildren:k._4e_moveChildren,_4e_mergeSiblings:k._4e_mergeSiblings,_4e_unselectable:k._4e_unselectable,_4e_getOffset:k._4e_getOffset,_4e_getFrameDocument:k._4e_getFrameDocument,_4e_splitText:k._4e_splitText,_4e_parents:k._4e_parents,_4e_clone:k._4e_clone,_4e_nextSourceNode:k._4e_nextSourceNode,
_4e_previousSourceNode:k._4e_previousSourceNode,_4e_commonAncestor:k._4e_commonAncestor,_4e_ascendant:k._4e_ascendant,_4e_hasAttribute:k._4e_hasAttribute,_4e_hasAttributes:k._4e_hasAttributes,_4e_position:k._4e_position,_4e_address:k._4e_address,_4e_breakParent:k._4e_breakParent,_4e_style:k._4e_style,_4e_remove:k._4e_remove,_4e_trim:k._4e_trim,_4e_ltrim:k._4e_ltrim,_4e_rtrim:k._4e_rtrim,_4e_appendBogus:k._4e_appendBogus,_4e_last:k._4e_last,_4e_previous:k._4e_previous,_4e_next:k._4e_next,_4e_outerHtml:k._4e_outerHtml,
_4e_setMarker:k._4e_setMarker,_4e_clearMarkers:k._4e_clearMarkers,_4e_getUniqueId:k._4e_getUniqueId,_4e_copyAttributes:k._4e_copyAttributes,_4e_isEditable:k._4e_isEditable,_4e_scrollIntoView:k._4e_scrollIntoView,_4e_getElementsByTagName:k._4e_getElementsByTagName});B._4e_inject(k)});
KISSY.Editor.add("focusmanager",function(p){function x(){this.iframeFocus=h;m=this}function C(){this.iframeFocus=c;m=g}var B=KISSY,t=B.DOM,v=B.Event,s={},m;B={refreshAll:function(){for(var f in s){var j=s[f];j.document.designMode="off";j.document.designMode="on"}},currentInstance:function(){return m},getInstance:function(f){return s[f]},add:function(f){var j=t._4e_getWin(f.document);v.on(j,"focus",x,f);v.on(j,"blur",C,f)},register:function(f){s[f._UUID]=f},remove:function(f){delete s[f._UUID];var j=
t._4e_getWin(f.document);v.remove(j,"focus",x,f);v.remove(j,"blur",C,f)}};var h=true,c=false,g=null;p.focusManager=B;p.focusManager=B;p.getInstances=function(){return s};p.getInstances=p.getInstances});
KISSY.Editor.add("definition",function(p){var x=true,C=false,B=p.Utils,t=document,v=KISSY,s=v.UA,m=v.DOM,h=v.Node,c=v.Event,g=p.focusManager,f=B.tryThese,j=B.debugUrl("../theme/editor-iframe.css"),A=1,k="document.open();"+(B.isCustomDomain()?'document.domain="'+t.domain+'";':"")+"document.close();",a="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"' ></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(s.ie?"javascript:void(function(){"+encodeURIComponent(k)+"}())":"")+'"  tabIndex="'+(s.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";p.SOURCE_MODE=0;p.WYSIWYG_MODE=1;p.SOURCE_MODE=p.SOURCE_MODE;p.WYSIWYG_MODE=p.WYSIWYG_MODE;v.augment(p,{init:function(b){if(s.ie)m.addClass(t.body,"ke-ie"+s.ie);else if(s.gecko)m.addClass(t.body,"ke-gecko");else s.webkit&&m.addClass(t.body,"ke-webkit");var d=this,l=new h(a.replace(/\$\(tabIndex\)/,
b.attr("tabIndex")));d.editorWrap=l;d._UUID=A++;g.register(d);d.wrap=l.one(".ke-textarea-wrap");d.wrap=d.wrap;d.iframe=d.wrap.one("iframe");d.iframe=d.iframe;d.toolBarDiv=l.one(".ke-editor-tools");d.toolBarDiv=d.toolBarDiv;d.textarea=b;d.textarea=d.textarea;d.statusDiv=l.one(".ke-editor-status");d.statusDiv=d.statusDiv;B.preventFocus(d.toolBarDiv);d._commands={};d._dialogs={};var D=b._4e_style("width"),r=b._4e_style("height");if(D){l.css("width",D);b.css("width","100%")}d.textarea.css("display","none");
l.insertAfter(b);d.wrap[0].appendChild(b[0]);if(r){d.wrap.css("height",r);b.css("height","100%")}l=d.iframe;d.on("dataReady",function(){d._ready=x;p.fire("instanceCreated",{editor:d})});s.gecko?l.on("load",d._setUpIFrame,d):d._setUpIFrame();d.cfg.attachForm&&b[0].form&&d._attachForm()},_attachForm:function(){(new h(this.textarea[0].form)).on("submit",this.sync,this)},useDialog:function(b,d){var l=this,D=p.Overlay;D&&D.loading();l.use(b,function(){var r=l.getDialog(b);if(r){d(r);D&&D.unloading()}else v.later(arguments.callee,
50,false,l)})},addDialog:function(b,d){this._dialogs[b]=d},getDialog:function(b){return this._dialogs[b]},addCommand:function(b,d){this._commands[b]=d},hasCommand:function(b){return this._commands[b]},execCommand:function(b){var d=this._commands[b],l=v.makeArray(arguments);l.shift();l.unshift(this);return d.exec.apply(d,l)},getMode:function(){return this.textarea.css("display")=="none"?p.WYSIWYG_MODE:p.SOURCE_MODE},getData:function(b){var d;d=this.getMode()==p.WYSIWYG_MODE?this.document.body.innerHTML:
this.textarea.val();if(this.htmlDataProcessor)d=b?this.htmlDataProcessor.toHtml(d,"p"):this.htmlDataProcessor.toServer(d,"p");d=v.trim(d);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(d))d="";return d},setData:function(b){var d=b;if(this.htmlDataProcessor)d=this.htmlDataProcessor.toDataFormat(b,"p");this.document.body.innerHTML=d;this.getMode()!=p.WYSIWYG_MODE&&this.textarea.val(b)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(b){this.document.body.innerHTML=
b},_prepareIFrameHtml:function(b){var d=this.cfg,l=d.customLink,D="";if(l)for(var r=0;r<l.length;r++)D+='<link href="'+l[r]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+p.Config.base+j+"' rel='stylesheet'/><style>"+(d.customStyle||"")+"</style>"+D+"</head><body class='ke-editor'>&nbsp;"+(b?'<script id="ke_actscript" type="text/javascript">'+(B.isCustomDomain()?'document.domain="'+t.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':
"")+"</body></html>"},getSelection:function(){return p.Selection.getSelection(this.document)},focus:function(){var b=this.document,d=m._4e_getWin(b);s.webkit&&d&&d.parent&&d.parent.focus();s.webkit&&d&&d.focus();b&&b.body.focus();this.notifySelectionChange()},blur:function(){m._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(b){var d=this.cfg,l=this.document;d.customStyle=d.customStyle||"";d.customStyle+="\n"+b;d=l.createElement("style");l.getElementsByTagName("head")[0].appendChild(d);
if(d.styleSheet)d.styleSheet.cssText=b;else d.appendChild(l.createTextNode(b))},addCustomLink:function(b){var d=this.cfg,l=this.document;d.customLink=d.customLink||[];d.customLink.push(b);d=l.createElement("link");d.rel="stylesheet";l.getElementsByTagName("head")[0].appendChild(d);d.href=b},removeCustomLink:function(b){for(var d=this.cfg,l=v.makeArray(this.document.getElementsByTagName("link")),D=0;D<l.length;D++)l[D].href==b&&m._4e_remove(l[D]);d.customLink=d.customLink||[];d=d.customLink;b=v.indexOf(b,
d);b!=-1&&d.splice(b,1)},_setUpIFrame:function(){function b(){E=r.document;d.document=E;l.detach();E.open("text/html","replace");E.write(D);E.close()}var d=this,l=d.iframe,D=d._prepareIFrameHtml(d._UUID),r=l[0].contentWindow,E;try{E=r.document}catch(o){l[0].src=l[0].src;if(s.ie<7){setTimeout(b,10);return}}b()},ready:function(b){this._ready?b():this.on("dataReady",b)},addPlugin:function(b,d,l){this.__plugins=this.__plugins||[];l=l||{};l.func=d;this.__plugins[b]=l},usePlugin:function(b){if(this.__plugins){var d=
this.__plugins[b];if(d)if(!(d.status&&!d.duplicate)){b=this.Env.mods[b].requires||[];for(var l=0;l<b.length;l++)this.usePlugin(b[l]);d.func.call(this);d.status=1}}},_monitor:function(){var b=this;b._monitorId&&clearTimeout(b._monitorId);b._monitorId=setTimeout(function(){var d=b.getSelection();if(d&&!d.isInvalid){var l=d.getStartElement(),D=new p.ElementPath(l);if(!b.previousPath||!b.previousPath.compare(D)){b.previousPath=D;b.fire("selectionChange",{selection:d,path:D,element:l})}}},100)},notifySelectionChange:function(){this.previousPath=
null;this._monitor()},insertElement:function(b,d,l){var D=this;D.focus();setTimeout(function(){var r,E=b._4e_name(),o=p.XHTML_DTD,u=p.RANGE,J=p.NODE,y=o.$block[E],e=D.getSelection(),i=e&&e.getRanges(),n,w,q,z;if(!i||i.length==0){var O=arguments,P=O.callee;setTimeout(function(){P.apply(D,O)},30)}else{D.fire("save");for(var L=i.length-1;L>=0;L--){n=i[L];n.deleteContents();r=!L&&b||b._4e_clone(x);d&&d(r);if(y)for(;(q=n.getCommonAncestor(C,x))&&(z=o[q._4e_name()])&&!(z&&z[E]);)if(q._4e_name()in o.span)n.splitElement(q);
else if(n.checkStartOfBlock()&&n.checkEndOfBlock()){n.setStartBefore(q);n.collapse(x);q._4e_remove()}else n.splitBlock();n.insertNode(r);w||(w=r)}if(w){E=w._4e_nextSourceNode(x);o=D.document;z=p.XHTML_DTD;if(z.$inline[r._4e_name()]){E=new h(o.createTextNode(" "));E.insertAfter(w)}else if(E){if(E._4e_name()=="br"&&z[E.parent()._4e_name()].p){z=new h("<p>&nbsp;</p>",null,o);E[0].parentNode.replaceChild(z[0],E[0]);E=z}}else{z=new h("<p>&nbsp;</p>",null,o);z.insertAfter(w);E=z}n.moveToPosition(w,u.POSITION_AFTER_END);
E&&E[0].nodeType==J.NODE_ELEMENT&&n.moveToElementEditablePosition(E);e.selectRanges([n]);D.focus();r&&r._4e_scrollIntoView();setTimeout(function(){D.fire("save")},10);l&&l(r)}}},0)},insertHtml:function(b){var d=this;if(d.htmlDataProcessor)b=d.htmlDataProcessor.toDataFormat(b);if(s.webkit){var l=m.create(b,null,d.document);l=l.nodeType==11?v.makeArray(l.childNodes):[l];for(var D=0;D<l.length;D++)d.insertElement(new h(l[D]))}else{d.focus();setTimeout(function(){var r=d.getSelection(),E=r&&r.getRanges();
if(!E||E.length==0){var o=arguments,u=o.callee;setTimeout(function(){u.apply(d,o)},30)}else{d.fire("save");if(s.ie){r=r.getNative();r.type=="Control"&&r.clear();r.createRange().pasteHTML(b)}else d.document.execCommand("inserthtml",C,b);setTimeout(function(){d.fire("save")},10)}},0)}}});p._initIFrame=function(b){function d(i){f(function(){r.designMode="on";setTimeout(function(){r.designMode="off";u.focus();if(!arguments.callee.retry)arguments.callee.retry=x},50)},function(){r.designMode="off";m.attr(u,
"contentEditable",C);m.attr(u,"contentEditable",x);!i&&d(1)})}var l=g.getInstance(b);b=l.textarea[0];var D=l.iframe[0].contentWindow,r=l.document,E=l.cfg,o=r.getElementById("ke_actscript");m._4e_remove(o);var u=r.body;if(s.ie){u.hideFocus=x;u.disabled=x;u.contentEditable=x;u.removeAttribute("disabled")}else setTimeout(function(){if(s.gecko||s.opera)u.contentEditable=x;else if(s.webkit)u.parentNode.contentEditable=x;else r.designMode="on"},0);if(s.webkit){c.on(r,"click",function(i){var n=new h(i.target);
v.inArray(n._4e_name(),["input","select"])&&i.preventDefault()});c.on(r,"mouseup",function(i){var n=new h(i.target);v.inArray(n._4e_name(),["input","textarea"])&&i.preventDefault()})}if(s.gecko||s.ie||s.opera){var J;J=new h(m.insertAfter((new h('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],b));J.on("focus",function(){l.focus()});l.activateGecko=function(){s.gecko&&l.iframeFocus&&J[0].focus()};l.on("destroy",function(){})}if(s.ie&&r.compatMode=="CSS1Compat"||
s.gecko||s.opera){var y=new h(r.documentElement);y.on("mousedown",function(i){if((new h(i.target))[0]==y[0]){s.gecko&&d(C);J[0].focus()}})}c.on(D,"focus",function(){if(s.gecko)d(C);else s.opera&&u.focus();l.notifySelectionChange()});s.gecko&&c.on(l.document,"mousedown",function(){l.iframeFocus||d(C)});if(s.ie){c.on(r,"keydown",function(i){if(i.keyCode in{8:1,46:1}){var n=l.getSelection(),w=n.getSelectedElement();if(w){l.fire("save");var q=n.getRanges()[0].createBookmark();w._4e_remove();n.selectBookmarks([q]);
l.fire("save");i.preventDefault()}}});if(r.compatMode=="CSS1Compat"){var e={33:1,34:1};c.on(r,"keydown",function(i){i.keyCode in e&&setTimeout(function(){l.getSelection().scrollIntoView()},0)})}}setTimeout(function(){s.ie&&setTimeout(function(){if(r){u.runtimeStyle.marginBottom="0px";u.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){l.fire("dataReady");var i=E.disableObjectResizing,n=E.disableInlineTableEditing;if(i||n)try{r.execCommand("enableObjectResizing",C,!i);r.execCommand("enableInlineTableEditing",
C,!n)}catch(w){c.on(u,s.ie?"resizestart":"resize",function(q){var z=new h(q.target);if(i||z._4e_name()==="table"&&n)q.preventDefault()})}},10);s.webkit&&c.on(r,"mousedown",function(i){i=new h(i.target);v.inArray(i._4e_name(),["img","hr","input","textarea","select"])&&l.getSelection().selectElement(i)});s.gecko&&c.on(r,"dragstart",function(i){var n=new h(i.target);n._4e_name()==="img"&&/ke_/.test(n[0].className)&&i.preventDefault()});g.add(l)};k=p.prototype;B.extern(k,{setData:k.setData,getData:k.getData,
insertElement:k.insertElement,insertHtml:k.insertHtml,ready:k.ready,addCustomStyle:k.addCustomStyle,addCommand:k.addCommand,hasCommand:k.hasCommand,execCommand:k.execCommand,useDialog:k.useDialog,addDialog:k.addDialog,getDialog:k.getDialog,getMode:k.getMode,sync:k.sync,getSelection:k.getSelection,focus:k.focus,blur:k.blur,notifySelectionChange:k.notifySelectionChange})});
KISSY.Editor.add("zindex",function(){var p=KISSY.Editor;if(!p.zIndexManager){p.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};p.baseZIndex=function(x){return(p.Config.baseZIndex||1E4)+x};p.baseZIndex=p.baseZIndex;p.zIndexManager=p.zIndexManager}});
KISSY.Editor.add("dtd",function(p){p.XHTML_DTD=function(){function x(E){for(var o=arguments.length-1;o>0;)KISSY.mix(E,arguments[o--]);return E}var C={isindex:1,fieldset:1},B={input:1,button:1,select:1,textarea:1,label:1},t=x({a:1},B),v=x({iframe:1},t),s={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},m={ins:1,del:1,script:1,style:1},h=x({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},m),c=x({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},h),g=x({p:1},c);B=x({iframe:1},c,B);c={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var f=x({a:1},B),j={tr:1},A={"#":1},k=x({param:1},c),a=x({form:1},C,v,s,g),b={li:1},d={base:1,link:1,meta:1,title:1},l=x(d,{style:1,script:1}),D={head:1,body:1},r={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:x({html:1},D,d),$block:r,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:f,$body:x({script:1,style:1},r),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:D,head:l,style:A,body:a,base:{},link:{},meta:{},title:A,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:f,button:x(g,s),basefont:{},h5:f,h4:f,samp:f,h6:f,ol:b,h1:f,h3:f,option:A,h2:f,form:x(C,v,s,g),select:{optgroup:1,option:1},font:f,ins:f,menu:b,abbr:f,label:f,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:f,script:A,tfoot:j,cite:f,li:a,input:{},iframe:a,strong:f,textarea:A,noframes:a,big:f,small:f,span:f,hr:{},dt:f,sub:f,optgroup:{option:1},param:{},bdo:f,"var":f,div:a,object:k,sup:f,dd:a,strike:f,area:{},dir:b,map:x({area:1,form:1,p:1},C,m,s),applet:k,dl:{dt:1,dd:1},del:f,isindex:{},fieldset:x({legend:1},c),thead:j,ul:b,acronym:f,b:f,a:B,blockquote:a,caption:f,i:f,u:f,tbody:j,s:f,address:x(v,g),tt:f,legend:f,q:f,pre:x(h,t),p:f,em:f,dfn:f}}();p.XHTML_DTD=
p.XHTML_DTD});
KISSY.Editor.add("elementpath",function(p){function x(c){var g=v,f=v,j=[];for(c=c;c&&c[0];){if(c[0].nodeType==t.NODE_ELEMENT){if(!this.lastElement)this.lastElement=c;var A=c._4e_name();if(!f){if(!g&&s[A])g=c;if(m[A]){var k;if(k=!g){if(k=A=="div"){a:{k=c;k=k[0]||k;k=k.childNodes;for(var a=0,b=k.length;a<b;a++){var d=k[a];if(d.nodeType==t.NODE_ELEMENT&&B.$block[d.nodeName.toLowerCase()]){k=true;break a}}k=false}k=!k}k=k}if(k)g=c;else f=c}}j.push(c);if(A=="body")break}c=c.parent()}this.block=this.block=
g;this.blockLimit=this.blockLimit=f;this.elements=this.elements=j}var C=KISSY.DOM,B=p.XHTML_DTD,t=p.NODE,v=null,s={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},m={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};x.prototype={compare:function(c){var g=this.elements;c=c&&c.elements;if(!c||g.length!=c.length)return false;for(var f=0;f<g.length;f++)if(!C._4e_equals(g[f],c[f]))return false;return true},contains:function(c){for(var g=this.elements,f=0;f<
g.length;f++)if(g[f]._4e_name()in c)return g[f];return v}};p.ElementPath=p.ElementPath=x;var h=x.prototype;p.Utils.extern(h,{compare:h.compare,contains:h.contains})});
KISSY.Editor.add("walker",function(p){function x(j,A){if(this._.end)return s;var k,a=this.range,b,d=this.guard,l=this.type,D=j?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;a.trim();if(a.collapsed){this.end();return s}}if(!j&&!this._.guardLTR){var r=a.endContainer,E=new g(r[0].childNodes[a.endOffset]);this._.guardLTR=function(y,e){return(y=c._4e_wrap(y))&&y[0]&&(!e||!c._4e_equals(r,y))&&(!E[0]||!y._4e_equals(E))&&(y[0].nodeType!=h.NODE_ELEMENT||!e||y._4e_name()!="body")}}if(j&&
!this._.guardRTL){var o=a.startContainer,u=a.startOffset>0&&new g(o[0].childNodes[a.startOffset-1]);this._.guardRTL=function(y,e){return(y=c._4e_wrap(y))&&y[0]&&(!e||!y._4e_equals(o))&&(!u[0]||!y._4e_equals(u))&&(y[0].nodeType!=h.NODE_ELEMENT||!e||y._4e_name()!="body")}}var J=j?this._.guardRTL:this._.guardLTR;b=d?function(y,e){if(J(y,e)===v)return v;return d(y,e)}:J;if(this.current)k=this.current[D](v,l,b);else if(j){k=a.endContainer;if(a.endOffset>0){k=new g(k[0].childNodes[a.endOffset-1]);if(b(k)===
v)k=s}else k=b(k,t)===v?s:k._4e_previousSourceNode(t,l,b)}else{k=a.startContainer;if((k=new g(k[0].childNodes[a.startOffset]))&&k[0]){if(b(k)===v)k=s}else k=b(a.startContainer,t)===v?s:a.startContainer._4e_nextSourceNode(t,l,b)}for(;k&&k[0]&&!this._.end;){this.current=k;if(!this.evaluator||this.evaluator(k)!==v){if(!A)return k}else if(A&&this.evaluator)return v;k=k[D](v,l,b)}this.end();return this.current=s}function C(j){for(var A,k=s;A=x.call(this,j);)k=A;return k}function B(j){this.range=j;this._=
{}}var t=true,v=false,s=null,m=KISSY,h=p.NODE,c=m.DOM,g=m.Node;m.augment(B,{end:function(){this._.end=1},next:function(){return x.call(this)},previous:function(){return x.call(this,t)},checkForward:function(){return x.call(this,v,t)!==v},checkBackward:function(){return x.call(this,t,t)!==v},lastForward:function(){return C.call(this)},lastBackward:function(){return C.call(this,t)},reset:function(){delete this.current;this._={}}});B.blockBoundary=function(j){return function(A){A=c._4e_wrap(A);return!(A&&
A[0].nodeType==h.NODE_ELEMENT&&A._4e_isBlockBoundary(j))}};B.listItemBoundary=function(){return this.blockBoundary({br:1})};B.bookmark=function(j,A){function k(a){return a&&a[0]&&a._4e_name()=="span"&&a.attr("_ke_bookmark")}return function(a){var b,d;b=a&&a[0]&&a[0].nodeType==h.NODE_TEXT&&(d=a.parent())&&k(d);b=j?b:b||k(a);return A^b}};B.whitespaces=function(j){return function(A){A=(A=A[0]||A)&&A.nodeType==h.NODE_TEXT&&!m.trim(A.nodeValue);return j^A}};B.invisible=function(j){var A=B.whitespaces();
return function(k){k=A(k)||k[0].nodeType==h.NODE_ELEMENT&&!k[0].offsetHeight;return j^k}};p.Walker=B;p.Walker=B;var f=B.prototype;p.Utils.extern(f,{end:f.end,next:f.next,previous:f.previous,checkForward:f.checkForward,checkBackward:f.checkBackward,lastForward:f.lastForward,lastBackward:f.lastBackward,reset:f.reset});p.Utils.extern(B,{blockBoundary:B.blockBoundary,listItemBoundary:B.listItemBoundary,bookmark:B.bookmark,whitespaces:B.whitespaces,invisible:B.invisible})});
KISSY.Editor.add("range",function(p){function x(e){this.endOffset=this.endContainer=this.startOffset=this.startContainer=c;this.collapsed=m;this.document=e}function C(e){var i=e[0].nodeType!=f.NODE_TEXT&&e._4e_name()in l.$removeEmpty,n=!g.trim(e[0].nodeValue);e=!!e.parent().attr("_ke_bookmark");return i||n||e}function B(e){return!u(e)&&!J(e)}function t(e){var i=h,n=k.bookmark(m);return function(w){if(n(w))return m;if(w[0].nodeType==f.NODE_TEXT){if(g.trim(w[0].nodeValue).length)return h}else if(w[0].nodeType==
f.NODE_ELEMENT)if(!o[w._4e_name()])if(!e&&!d.ie&&w._4e_name()=="br"&&!i)i=m;else return h;return m}}function v(e,i){function n(w){return w&&w.nodeName=="span"&&w.getAttribute("_ke_bookmark")}return function(w){var q,z;q=w&&!w.nodeName&&(z=w.parentNode)&&n(z);q=e?q:q||n(w);return i^q}}function s(e){return function(i){i=(i=i[0]||i)&&i.nodeType==f.NODE_TEXT&&!g.trim(i.nodeValue);return e^i}}p.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};p.RANGE=p.RANGE;var m=true,h=false,c=null,g=KISSY,f=p.NODE,j=p.RANGE,A=p.POSITION,k=p.Walker,a=g.DOM,b=p.Utils.getByAddress,d=g.UA,l=p.XHTML_DTD,D=p.ElementPath,r=g.Node,E={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};x.prototype.toString=function(){var e=[];e.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);e.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return e.join("<br/>")};g.augment(x,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var e=this.startContainer,i=this.startOffset;if(e[0].nodeType!=f.NODE_ELEMENT)if(i)i>=e[0].nodeValue.length&&this.setStartAfter(e);else this.setStartBefore(e);e=this.endContainer;i=this.endOffset;if(e[0].nodeType!=f.NODE_ELEMENT)if(i)i>=
e[0].nodeValue.length&&this.setEndAfter(e);else this.setEndBefore(e)},setStartAfter:function(e){this.setStart(e.parent(),e._4e_index()+1)},setStartBefore:function(e){this.setStart(e.parent(),e._4e_index())},setEndAfter:function(e){this.setEnd(e.parent(),e._4e_index()+1)},setEndBefore:function(e){this.setEnd(e.parent(),e._4e_index())},optimizeBookmark:function(){var e=this.startContainer,i=this.endContainer;e&&e._4e_name()=="span"&&e.attr("_ke_bookmark")&&this.setStartAt(e,j.POSITION_BEFORE_START);
i&&i._4e_name()=="span"&&i.attr("_ke_bookmark")&&this.setEndAt(i,j.POSITION_AFTER_END)},setStart:function(e,i){if(e[0].nodeType==f.NODE_ELEMENT&&E[e._4e_name()]){e=e.parent();i=e._4e_index()}this.startContainer=e;this.startOffset=i;if(!this.endContainer){this.endContainer=e;this.endOffset=i}this.updateCollapsed()},setEnd:function(e,i){if(e[0].nodeType==f.NODE_ELEMENT&&E[e._4e_name()]){e=e.parent();i=e._4e_index()+1}this.endContainer=e;this.endOffset=i;if(!this.startContainer){this.startContainer=
e;this.startOffset=i}this.updateCollapsed()},setStartAt:function(e,i){switch(i){case j.POSITION_AFTER_START:this.setStart(e,0);break;case j.POSITION_BEFORE_END:e[0].nodeType==f.NODE_TEXT?this.setStart(e,e[0].nodeValue.length):this.setStart(e,e[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setStartBefore(e);break;case j.POSITION_AFTER_END:this.setStartAfter(e)}this.updateCollapsed()},setEndAt:function(e,i){switch(i){case j.POSITION_AFTER_START:this.setEnd(e,0);break;case j.POSITION_BEFORE_END:e[0].nodeType==
f.NODE_TEXT?this.setEnd(e,e[0].nodeValue.length):this.setEnd(e,e[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setEndBefore(e);break;case j.POSITION_AFTER_END:this.setEndAfter(e)}this.updateCollapsed()},execContentsAction:function(e,i){var n=this.startContainer,w=this.endContainer,q=this.startOffset,z=this.endOffset,O,P=this.document,L;this.optimizeBookmark();if(w[0].nodeType==f.NODE_TEXT)w=w._4e_splitText(z);else if(w[0].childNodes.length>0)if(z>=w[0].childNodes.length){w=new r(w[0].appendChild(P.createTextNode("")));
L=m}else w=new r(w[0].childNodes[z]);if(n[0].nodeType==f.NODE_TEXT){n._4e_splitText(q);if(n._4e_equals(w))w=new r(n[0].nextSibling)}else if(q)if(q>=n[0].childNodes.length){O=new r(P.createTextNode(""));n.append(O);n=O;O=m}else n=new r(n[0].childNodes[q].previousSibling);else{O=new r(P.createTextNode(""));n.prepend(O);n=O;O=m}q=n._4e_parents();z=w._4e_parents();var Q,S,U;for(Q=0;Q<q.length;Q++){S=q[Q];U=z[Q];if(!S._4e_equals(U))break}P=i;for(var T,V,F,K=Q;K<q.length;K++){T=q[K];V=P&&!T._4e_equals(n)?
P.appendChild(T._4e_clone()[0]):null;for(T=T[0].nextSibling;T;){if(a._4e_equals(z[K],T)||a._4e_equals(w,T))break;F=T.nextSibling;if(e==2)P.appendChild(T.cloneNode(m));else{a._4e_remove(T);e==1&&P.appendChild(T)}T=F}if(V)P=V}P=i;for(Q=Q;Q<z.length;Q++){T=z[Q];V=P&&e>0&&!T._4e_equals(w)?P.appendChild(T._4e_clone()[0]):null;if(!q[Q]||!T.parent()._4e_equals(q[Q].parent()))for(T=T[0].previousSibling;T;){if(a._4e_equals(q[Q],T)||a._4e_equals(n,T))break;F=T.previousSibling;if(e==2)P.insertBefore(T.cloneNode(m),
P.firstChild);else{a._4e_remove(T);e==1&&P.insertBefore(T,P.firstChild)}T=F}if(V)P=V}if(e==2){U=this.startContainer[0];if(U.nodeType==f.NODE_TEXT&&U.nextSibling&&U.nextSibling.nodeType==f.NODE_TEXT){U.data+=U.nextSibling.data;U.parentNode.removeChild(U.nextSibling)}U=this.endContainer[0];if(U.nodeType==f.NODE_TEXT&&U.nextSibling&&U.nextSibling.nodeType==f.NODE_TEXT){U.data+=U.nextSibling.data;U.parentNode.removeChild(U.nextSibling)}}else{if(S&&U&&(!n.parent()._4e_equals(S.parent())||!w.parent()._4e_equals(U.parent()))){S=
U._4e_index();O&&U.parent()._4e_equals(n.parent())&&S--;this.setStart(U.parent(),S)}this.collapse(m)}O&&n._4e_remove();L&&w[0].parentNode&&w._4e_remove()},collapse:function(e){if(e){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=m},clone:function(){var e=new x(this.document);e.startContainer=this.startContainer;e.startOffset=this.startOffset;e.endContainer=this.endContainer;e.endOffset=
this.endOffset;e.collapsed=this.collapsed;return e},getEnclosedNode:function(){var e=this.clone();e.optimize();if(e.startContainer[0].nodeType!=f.NODE_ELEMENT||e.endContainer[0].nodeType!=f.NODE_ELEMENT)return c;var i=new p.Walker(e),n=v(m,undefined),w=s(m);e.evaluator=function(q){return w(q)&&n(q)};e=i.next();i.reset();i=i.previous();return e&&e._4e_equals(i)?e:c},shrink:function(e,i){if(!this.collapsed){e=e||j.SHRINK_TEXT;var n=this.clone(),w=this.startContainer,q=this.endContainer,z=this.startOffset,
O=this.endOffset,P=1,L=1;if(w&&w[0].nodeType==f.NODE_TEXT)if(z)if(z>=w[0].nodeValue.length)n.setStartAfter(w);else{n.setStartBefore(w);P=0}else n.setStartBefore(w);if(q&&q[0].nodeType==f.NODE_TEXT)if(O)if(O>=q[0].nodeValue.length)n.setEndAfter(q);else{n.setEndAfter(q);L=0}else n.setEndBefore(q);n=new k(n);n.evaluator=function(S){S=S[0]||S;return S.nodeType==(e==j.SHRINK_ELEMENT?f.NODE_ELEMENT:f.NODE_TEXT)};var Q;n.guard=function(S,U){S=S[0]||S;if(e==j.SHRINK_ELEMENT&&S.nodeType==f.NODE_TEXT)return h;
if(U&&S==Q)return h;if(!U&&S.nodeType==f.NODE_ELEMENT)Q=S;return m};if(P)(w=n[e==j.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(w,i?j.POSITION_AFTER_START:j.POSITION_BEFORE_START);if(L){n.reset();(n=n[e==j.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,i?j.POSITION_BEFORE_END:j.POSITION_AFTER_END)}return!!(P||L)}},getTouchedStartNode:function(){var e=this.startContainer;if(this.collapsed||e[0].nodeType!=f.NODE_ELEMENT)return e;return e.childNodes[this.startOffset]||e},createBookmark2:function(e){var i=
this.startContainer,n=this.endContainer,w=this.startOffset,q=this.endOffset,z,O;if(!i||!n)return{start:0,end:0};if(e){if(i[0].nodeType==f.NODE_ELEMENT)if((z=new r(i[0].childNodes[w]))&&z[0]&&z[0].nodeType==f.NODE_TEXT&&w>0&&z[0].previousSibling.nodeType==f.NODE_TEXT){i=z;w=0}for(;i[0].nodeType==f.NODE_TEXT&&(O=i._4e_previous())&&O[0].nodeType==f.NODE_TEXT;){i=O;w+=O[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==f.NODE_ELEMENT)if((z=new r(n[0].childNodes[q]))&&z[0]&&z[0].nodeType==f.NODE_TEXT&&
q>0&&z[0].previousSibling.nodeType==f.NODE_TEXT){n=z;q=0}for(;n[0].nodeType==f.NODE_TEXT&&(O=n._4e_previous())&&O[0].nodeType==f.NODE_TEXT;){n=O;q+=O[0].nodeValue.length}}}return{start:i._4e_address(e),end:this.collapsed?c:n._4e_address(e),startOffset:w,endOffset:q,normalized:e,is2:m}},createBookmark:function(e){var i,n,w,q,z=this.collapsed;i=new r("<span>",c,this.document);i.attr("_ke_bookmark",1);i.css("display","none");i.html("&nbsp;");if(e){w=g.guid("ke_bm_");i.attr("id",w+"S")}if(!z){n=i._4e_clone();
n.html("&nbsp;");e&&n.attr("id",w+"E");q=this.clone();q.collapse();q.insertNode(n)}q=this.clone();q.collapse(m);q.insertNode(i);if(n){this.setStartAfter(i);this.setEndBefore(n)}else this.moveToPosition(i,j.POSITION_AFTER_END);return{startNode:e?w+"S":i,endNode:e?w+"E":n,serializable:e,collapsed:z}},moveToPosition:function(e,i){this.setStartAt(e,i);this.collapse(m)},trim:function(e,i){var n=this.startContainer,w=this.startOffset,q=this.collapsed;if((!e||q)&&n[0]&&n[0].nodeType==f.NODE_TEXT){if(w)if(w>=
n[0].nodeValue.length){w=n._4e_index()+1;n=n.parent()}else{var z=n._4e_splitText(w);w=n._4e_index()+1;n=n.parent();if(a._4e_equals(this.startContainer,this.endContainer))this.setEnd(z,this.endOffset-this.startOffset);else if(a._4e_equals(n,this.endContainer))this.endOffset+=1}else{w=n._4e_index();n=n.parent()}this.setStart(n,w);if(q){this.collapse(m);return}}n=this.endContainer;w=this.endOffset;if(!(i||q)&&n[0]&&n[0].nodeType==f.NODE_TEXT){if(w){w>=n.nodeValue.length||n._4e_splitText(w);w=n._4e_index()+
1}else w=n._4e_index();n=n.parent();this.setEnd(n,w)}},insertNode:function(e){this.optimizeBookmark();this.trim(h,m);var i=this.startContainer;i[0].insertBefore(e[0]||e,i[0].childNodes[this.startOffset]||null);a._4e_equals(e.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(e)},moveToBookmark:function(e){if(e.is2){var i=b(this.document,e.start,e.normalized),n=e.startOffset,w=e.end&&b(this.document,e.end,e.normalized);e=e.endOffset;this.setStart(i,n);w?this.setEnd(w,e):this.collapse(m)}else{i=
(n=e.serializable)?g.one("#"+e.startNode,this.document):e.startNode;e=n?g.one("#"+e.endNode,this.document):e.endNode;this.setStartBefore(i);i._4e_remove();if(e&&e[0]){this.setEndBefore(e);e._4e_remove()}else this.collapse(m)}},getCommonAncestor:function(e,i){var n=this.startContainer,w=this.endContainer;n=a._4e_equals(n,w)?e&&n[0].nodeType==f.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new r(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(w);return i&&n[0].nodeType==f.NODE_TEXT?n.parent():
n},enlarge:function(e){switch(e){case j.ENLARGE_ELEMENT:if(this.collapsed)break;e=this.getCommonAncestor();var i=new r(this.document.body),n,w,q,z,O,P=h,L,Q;L=this.startContainer;Q=this.startOffset;if(L[0].nodeType==f.NODE_TEXT){if(Q){L=!g.trim(L[0].nodeValue.substring(0,Q)).length&&L;P=!!L}if(L)if(!(z=L[0].previousSibling))q=L.parent()}else{if(Q)z=L[0].childNodes[Q-1]||L[0].lastChild;z||(q=L)}for(;q||z;){if(q&&!z){if(!O&&a._4e_equals(q,e))O=m;if(!i.contains(q))break;if(!P||q.css("display")!="inline"){P=
h;if(O)n=q;else this.setStartBefore(q)}z=q[0].previousSibling}for(;z;){L=h;if(z.nodeType==f.NODE_TEXT){Q=z.nodeValue;if(/[^\s\ufeff]/.test(Q))z=c;L=/[\s\ufeff]$/.test(Q)}else if(z.offsetWidth>0&&!z.getAttribute("_ke_bookmark"))if(P&&l.$removeEmpty[z.nodeName.toLowerCase()]){Q=a.text(z);if(/[^\s\ufeff]/.test(Q))z=c;else for(var S=z.all||z.getElementsByTagName("*"),U=0,T;T=S[U++];)if(!l.$removeEmpty[T.nodeName.toLowerCase()]){z=c;break}if(z)L=!!Q.length}else z=c;if(L)if(P)if(O)n=q;else q&&this.setStartBefore(q);
else P=m;if(z){L=z.previousSibling;if(!q&&!L){q=new r(z);z=c;break}z=L}else q=c}if(q)q=q.parent()}L=this.endContainer;Q=this.endOffset;q=z=c;O=P=h;if(L[0].nodeType==f.NODE_TEXT){L=!g.trim(L[0].nodeValue.substring(Q)).length&&L;P=!(L&&L[0].nodeValue.length);if(L)if(!(z=L[0].nextSibling))q=L.parent()}else(z=L[0].childNodes[Q])||(q=L);for(;q||z;){if(q&&!z){if(!O&&a._4e_equals(q,e))O=m;if(!i.contains(q))break;if(!P||q.css("display")!="inline"){P=h;if(O)w=q;else q&&this.setEndAfter(q)}z=q[0].nextSibling}for(;z;){L=
h;if(z.nodeType==f.NODE_TEXT){Q=z.nodeValue;if(/[^\s\ufeff]/.test(Q))z=c;L=/^[\s\ufeff]/.test(Q)}else if(z.offsetWidth>0&&!z.getAttribute("_ke_bookmark"))if(P&&l.$removeEmpty[z.nodeName.toLowerCase()]){Q=a.text(z);if(/[^\s\ufeff]/.test(Q))z=c;else{S=z.all||z.getElementsByTagName("*");for(U=0;T=S[U++];)if(!l.$removeEmpty[T.nodeName.toLowerCase()]){z=c;break}}if(z)L=!!Q.length}else z=c;if(L)if(P)if(O)w=q;else this.setEndAfter(q);if(z){L=z.nextSibling;if(!q&&!L){q=new r(z);z=c;break}z=L}else q=c}if(q)q=
q.parent()}if(n&&w){e=n.contains(w)?w:n;this.setStartBefore(e);this.setEndAfter(e)}break;case j.ENLARGE_BLOCK_CONTENTS:case j.ENLARGE_LIST_ITEM_CONTENTS:q=new x(this.document);i=new r(this.document.body);q.setStartAt(i,j.POSITION_AFTER_START);q.setEnd(this.startContainer,this.startOffset);q=new k(q);var V,F,K=k.blockBoundary(e==j.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:c),H=function(G){var I=K(G);I||(V=G);return I};n=function(G){var I=H(G);if(!I&&G[0]&&G._4e_name()=="br")F=G;return I};q.guard=H;q=q.lastBackward();
V=V||i;this.setStartAt(V,V._4e_name()!="br"&&(!q&&this.checkStartOfBlock()||q&&V.contains(q))?j.POSITION_AFTER_START:j.POSITION_AFTER_END);q=this.clone();q.collapse();q.setEndAt(i,j.POSITION_BEFORE_END);q=new k(q);q.guard=e==j.ENLARGE_LIST_ITEM_CONTENTS?n:H;V=c;q=q.lastForward();V=V||i;this.setEndAt(V,!q&&this.checkEndOfBlock()||q&&V.contains(q)?j.POSITION_BEFORE_END:j.POSITION_BEFORE_START);F&&this.setEndAfter(F)}},checkStartOfBlock:function(){var e=this.startContainer,i=this.startOffset;if(i&&e[0].nodeType==
f.NODE_TEXT)if(g.trim(e[0].nodeValue.substring(0,i)).length)return h;this.trim();e=new D(this.startContainer);i=this.clone();i.collapse(m);i.setStartAt(e.block||e.blockLimit,j.POSITION_AFTER_START);e=new k(i);e.evaluator=t(m);return e.checkBackward()},checkEndOfBlock:function(){var e=this.endContainer,i=this.endOffset;if(e[0].nodeType==f.NODE_TEXT)if(g.trim(e[0].nodeValue.substring(i)).length)return h;this.trim();e=new D(this.endContainer);i=this.clone();i.collapse(h);i.setEndAt(e.block||e.blockLimit,
j.POSITION_BEFORE_END);e=new k(i);e.evaluator=t(h);return e.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var e=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,e);return e},checkBoundaryOfElement:function(e,i){var n=this.clone();n[i==j.START?"setStartAt":"setEndAt"](e,i==j.START?j.POSITION_AFTER_START:j.POSITION_BEFORE_END);n=new k(n);n.evaluator=C;return n[i==j.START?"checkBackward":"checkForward"]()},
getBoundaryNodes:function(){var e=this.startContainer,i=this.endContainer,n=this.startOffset,w=this.endOffset,q;if(e[0].nodeType==f.NODE_ELEMENT){q=e[0].childNodes.length;if(q>n)e=new r(e[0].childNodes[n]);else if(q<1)e=e._4e_previousSourceNode();else{for(e=e[0];e.lastChild;)e=e.lastChild;e=new r(e);e=e._4e_nextSourceNode()||e}}if(i[0].nodeType==f.NODE_ELEMENT){q=i[0].childNodes.length;if(q>w)i=(new r(i[0].childNodes[w]))._4e_previousSourceNode(m);else if(q<1)i=i._4e_previousSourceNode();else{for(i=
i[0];i.lastChild;)i=i.lastChild;i=new r(i)}}if(e._4e_position(i)&A.POSITION_FOLLOWING)e=i;return{startNode:e,endNode:i}},fixBlock:function(e,i){var n=this.createBookmark(),w=new r(this.document.createElement(i));this.collapse(e);this.enlarge(j.ENLARGE_BLOCK_CONTENTS);w[0].appendChild(this.extractContents());w._4e_trim();d.ie||w._4e_appendBogus();this.insertNode(w);this.moveToBookmark(n);return w},splitBlock:function(e){var i=new D(this.startContainer),n=new D(this.endContainer),w=i.block,q=n.block,
z=c;if(!i.blockLimit._4e_equals(n.blockLimit))return c;if(e!="br"){if(!w){w=this.fixBlock(m,e);q=(new D(this.endContainer)).block}q||(q=this.fixBlock(h,e))}e=w&&this.checkStartOfBlock();i=q&&this.checkEndOfBlock();this.deleteContents();if(w&&a._4e_equals(w,q))if(i){z=new D(this.startContainer);this.moveToPosition(q,j.POSITION_AFTER_END);q=c}else if(e){z=new D(this.startContainer);this.moveToPosition(w,j.POSITION_BEFORE_START);w=c}else{q=this.splitElement(w);!d.ie&&!g.inArray(w._4e_name(),["ul","ol"])&&
w._4e_appendBogus()}return{previousBlock:w,nextBlock:q,wasStartOfBlock:e,wasEndOfBlock:i,elementPath:z}},splitElement:function(e){if(!this.collapsed)return c;this.setEndAt(e,j.POSITION_BEFORE_END);var i=this.extractContents(),n=e._4e_clone(h);n[0].appendChild(i);n.insertAfter(e);this.moveToPosition(e,j.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(e,i){var n,w=p.XHTML_DTD;if(w.$empty[e._4e_name()])return h;for(;e&&e[0].nodeType==f.NODE_ELEMENT;){if(n=e._4e_isEditable())this.moveToPosition(e,
i?j.POSITION_BEFORE_END:j.POSITION_AFTER_START);else if(w.$inline[e._4e_name()]){this.moveToPosition(e,i?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);return m}if((e=w.$empty[e._4e_name()]?e[i?"_4e_previous":"_4e_next"](B):e[i?"_4e_last":"_4e_first"](B))&&e[0].nodeType==f.NODE_TEXT){this.moveToPosition(e,i?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);return m}}return n},selectNodeContents:function(e){this.setStart(e,0);this.setEnd(e,e[0].nodeType==f.NODE_TEXT?e[0].nodeValue.length:e[0].childNodes.length)}});
var o={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},u=new k.whitespaces,J=new k.bookmark;p.Range=x;p.Range=x;var y=x.prototype;p.Utils.extern(y,{updateCollapsed:y.updateCollapsed,optimize:y.optimize,setStartAfter:y.setStartAfter,setEndAfter:y.setEndAfter,setStartBefore:y.setStartBefore,setEndBefore:y.setEndBefore,optimizeBookmark:y.optimizeBookmark,setStart:y.setStart,setEnd:y.setEnd,
setStartAt:y.setStartAt,setEndAt:y.setEndAt,execContentsAction:y.execContentsAction,collapse:y.collapse,clone:y.clone,getEnclosedNode:y.getEnclosedNode,shrink:y.shrink,getTouchedStartNode:y.getTouchedStartNode,createBookmark2:y.createBookmark2,createBookmark:y.createBookmark,moveToPosition:y.moveToPosition,trim:y.trim,insertNode:y.insertNode,moveToBookmark:y.moveToBookmark,getCommonAncestor:y.getCommonAncestor,enlarge:y.enlarge,checkStartOfBlock:y.checkStartOfBlock,checkEndOfBlock:y.checkEndOfBlock,
deleteContents:y.deleteContents,extractContents:y.extractContents,checkBoundaryOfElement:y.checkBoundaryOfElement,getBoundaryNodes:y.getBoundaryNodes,fixBlock:y.fixBlock,splitBlock:y.splitBlock,splitElement:y.splitElement,moveToElementEditablePosition:y.moveToElementEditablePosition,selectNodeContents:y.selectNodeContents})});
KISSY.Editor.add("domiterator",function(p){function x(k){if(!(arguments.length<1)){this.range=k;this.forceBrBreak=B;this.enlargeBr=C;this.enforceRealBlocks=B;this._||(this._={})}}var C=true,B=false,t=KISSY,v=t.UA,s=p.Walker,m=p.Range,h=p.RANGE,c=p.NODE,g=p.ElementPath,f=t.Node,j=t.DOM,A=/^[\r\n\t ]*$/;t.augment(x,{getNextParagraph:function(k){var a,b,d,l,D;if(!this._.lastNode){b=this.range.clone();b.shrink(h.SHRINK_ELEMENT,C);b.enlarge(this.forceBrBreak||!this.enlargeBr?h.ENLARGE_LIST_ITEM_CONTENTS:
h.ENLARGE_BLOCK_CONTENTS);var r=new s(b),E=s.bookmark(C,C);r.evaluator=E;this._.nextNode=r.next();r=new s(b);r.evaluator=E;r=r.previous();this._.lastNode=r._4e_nextSourceNode(C);if(this._.lastNode&&this._.lastNode[0].nodeType==c.NODE_TEXT&&!t.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){E=new m(b.document);E.moveToPosition(this._.lastNode,h.POSITION_AFTER_END);if(E.checkEndOfBlock()){E=new g(E.endContainer);this._.lastNode=(E.block||E.blockLimit)._4e_nextSourceNode(C)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new f(b.document.createTextNode(""));j.insertAfter(this._.lastNode[0],r[0])}b=null}E=this._.nextNode;r=this._.lastNode;for(this._.nextNode=null;E;){var o=B,u=E[0].nodeType!=c.NODE_ELEMENT,J=B;if(u){if(E[0].nodeType==c.NODE_TEXT)if(A.test(E[0].nodeValue))u=B}else{var y=E._4e_name();if(E._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(y=="br")u=C;else if(!b&&!E[0].childNodes.length&&y!="hr"){a=E;d=E._4e_equals(r);break}if(b){b.setEndAt(E,h.POSITION_BEFORE_START);if(y!="br")this._.nextNode=
E}o=C}else{if(E[0].firstChild){if(!b){b=new m(this.range.document);b.setStartAt(E,h.POSITION_BEFORE_START)}E=new f(E[0].firstChild);continue}u=C}}if(u&&!b){b=new m(this.range.document);b.setStartAt(E,h.POSITION_BEFORE_START)}d=(!o||u)&&E._4e_equals(r);if(b&&!o)for(;!E[0].nextSibling&&!d;){y=E.parent();if(y._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){o=C;d||y._4e_equals(r);break}E=y;u=C;d=E._4e_equals(r);J=C}u&&b.setEndAt(E,h.POSITION_AFTER_END);E=E._4e_nextSourceNode(J,null,r);if((d=!E)||o&&b)break}if(!a){if(!b){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new g(b.startContainer);E=a.blockLimit;o={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&o[E._4e_name()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=E;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new f(this.range.document.createElement(k||"p"));a[0].appendChild(b.extractContents());a._4e_trim();b.insertNode(a);l=D=C}else if(a._4e_name()!="li"){if(!b.checkStartOfBlock()||!b.checkEndOfBlock()){a=a._4e_clone(B);
a[0].appendChild(b.extractContents());a._4e_trim();D=b.splitBlock();l=!D.wasStartOfBlock;D=!D.wasEndOfBlock;b.insertNode(a)}}else if(!d)this._.nextNode=a._4e_equals(r)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(C,null,r)}if(l){b=new f(a[0].previousSibling);if(b[0]&&b[0].nodeType==c.NODE_ELEMENT)if(b._4e_name()=="br")b._4e_remove();else b[0].lastChild&&j._4e_name(b[0].lastChild)=="br"&&j._4e_remove(b[0].lastChild)}if(D){b=s.bookmark(B,C);l=new f(a[0].lastChild);if(l[0]&&l[0].nodeType==c.NODE_ELEMENT&&
l._4e_name()=="br")if(v.ie||l._4e_previous(b)||l._4e_next(b))l._4e_remove()}if(!this._.nextNode)this._.nextNode=d||a._4e_equals(r)?null:a._4e_nextSourceNode(C,null,r);return a}});m.prototype.createIterator=function(){return new x(this)}});
KISSY.Editor.add("selection",function(p){function x(o){this.document=this.document=o;this._={cache:{}};if(a){var u=this.getNative().createRange();if(!u||u.item&&u.item(0).ownerDocument!=o||u.parentElement&&u.parentElement().ownerDocument!=o)this.isInvalid=t}}function C(o){o=new x(o);return!o||o.isInvalid?s:o}function B(o){var u=o.document,J=new f(u.body),y=new f(u.documentElement);if(h.ie){if(h.ie<8||document.documentMode==7)y.on("click",function(L){(new f(L.target))._4e_name()==="html"&&o.getSelection().getRanges()[0].select()});
var e,i,n=1;y.on("mousedown",function(){n=0});y.on("mouseup",function(){n=1});J.on("focusin",function(L){if((new f(L.target))._4e_name()=="body")if(e){try{n&&e.select()}catch(Q){}e=s}});J.on("focus",function(){i=t;q()});J.on("beforedeactivate",function(L){if(!L.relatedTarget){i=v;n=1}});g.on(c._4e_getWin(u),"blur",function(){u&&u.selection.empty()});J.on("mousedown",function(){w()});J.on("mouseup",function(){i=t;setTimeout(function(){q(t)},0)});var w=function(){i=v},q=function(L){if(i){var Q=o.document,
S=o.getSelection(),U=S&&S.getType(),T=S&&S.getNative();if(L&&T&&U==j.SELECTION_NONE)if(!Q.queryCommandEnabled("InsertImage")){setTimeout(function(){q(t)},50);return}var V;if(!(T&&U==j.SELECTION_TEXT&&(V=c._4e_name(S.getStartElement()))&&V in{input:1,textarea:1})){e=T&&S.getRanges()[0];o._monitor()}}};J.on("keydown",w);J.on("keyup",function(){i=t;q()});g.on(u,"selectionchange",q)}else{g.on(u,"mouseup",o._monitor,o);g.on(u,"keyup",o._monitor,o)}var z={table:1,pre:1},O=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
P=p.Walker.whitespaces(t);o.on("selectionChange",function(L){var Q=L.path;L=(L=L.selection)&&L.getRanges()[0];if(!(!L||!L.collapsed||Q.block))if(Q.blockLimit._4e_name()=="body"){Q=L.fixBlock(t,"p");if(Q._4e_outerHtml().match(O)){var S=Q._4e_next(P);if(S&&S[0].nodeType==k.NODE_ELEMENT&&!z[S._4e_name()]){L.moveToElementEditablePosition(S);Q._4e_remove()}else if((S=Q._4e_previous(P))&&S[0].nodeType==k.NODE_ELEMENT&&!z[S._4e_name()]){L.moveToElementEditablePosition(S,S._4e_outerHtml().match(O)?v:t);Q._4e_remove()}}L.select();
a||o.notifySelectionChange()}})}p.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var t=true,v=false,s=null,m=KISSY,h=m.UA,c=m.DOM,g=m.Event,f=m.Node,j=p.SELECTION,A=p.RANGE,k=p.NODE,a=!window.getSelection,b=p.Walker,d=p.Range,l={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};m.augment(x,{getNative:!a?function(){var o=this._.cache;return o.nativeSel||(o.nativeSel=c._4e_getWin(this.document).getSelection())}:
function(){var o=this._.cache;return o.nativeSel||(o.nativeSel=this.document.selection)},getType:!a?function(){var o=this._.cache;if(o.type)return o.type;var u=j.SELECTION_TEXT,J=this.getNative();if(J){if(J.rangeCount==1){J=J.getRangeAt(0);var y=J.startContainer;if(y==J.endContainer&&y.nodeType==k.NODE_ELEMENT&&J.endOffset-J.startOffset===1&&l[y.childNodes[J.startOffset].nodeName.toLowerCase()])u=j.SELECTION_ELEMENT}}else u=j.SELECTION_NONE;return o.type=u}:function(){var o=this._.cache;if(o.type)return o.type;
var u=j.SELECTION_NONE;try{var J=this.getNative(),y=J.type;if(y=="Text")u=j.SELECTION_TEXT;if(y=="Control")u=j.SELECTION_ELEMENT;if(J.createRange().parentElement)u=j.SELECTION_TEXT}catch(e){}return o.type=u},getRanges:a?function(){var o=function(u,J){u=u.duplicate();u.collapse(J);for(var y=u.parentElement(),e=y.childNodes,i,n=0;n<e.length;n++){var w=e[n];if(w.nodeType==k.NODE_ELEMENT){i=u.duplicate();i.moveToElementText(w);w=i.compareEndPoints("StartToStart",u);var q=i.compareEndPoints("EndToStart",
u);i.collapse();if(w>0)break;else if(!w||q==1&&w==-1)return{container:y,offset:n};else if(!q)return{container:y,offset:n+1};i=s}}if(!i){i=u.duplicate();i.moveToElementText(y);i.collapse(v)}i.setEndPoint("StartToStart",u);i=i.text.replace(/\r\n|\r/g,"\n").length;try{for(;i>0;)i-=e[--n].nodeValue.length}catch(z){i=0}return i===0?{container:y,offset:n}:{container:e[n],offset:-i}};return function(){var u=this._.cache;if(u.ranges)return u.ranges;var J=this.getNative(),y=J&&J.createRange(),e=this.getType();
if(!J)return[];if(e==j.SELECTION_TEXT){J=new d(this.document);e=o(y,t);J.setStart(new f(e.container),e.offset);e=o(y);J.setEnd(new f(e.container),e.offset);return u.ranges=[J]}else if(e==j.SELECTION_ELEMENT){u=u.ranges=[];for(e=0;e<y.length;e++){var i=y.item(e),n=i.parentNode,w=0;for(J=new d(this.document);w<n.childNodes.length&&n.childNodes[w]!=i;w++);J.setStart(new f(n),w);J.setEnd(new f(n),w+1);u.push(J)}return u}return u.ranges=[]}}():function(){var o=this._.cache;if(o.ranges)return o.ranges;
var u=[],J=this.getNative();if(!J)return[];for(var y=0;y<J.rangeCount;y++){var e=J.getRangeAt(y),i=new d(this.document);i.setStart(new f(e.startContainer),e.startOffset);i.setEnd(new f(e.endContainer),e.endOffset);u.push(i)}return o.ranges=u},getStartElement:function(){var o=this._.cache;if(o.startElement!==undefined)return o.startElement;var u,J=this.getNative();switch(this.getType()){case j.SELECTION_ELEMENT:return this.getSelectedElement();case j.SELECTION_TEXT:var y=this.getRanges()[0];if(y)if(!y.collapsed){for(y.optimize();t;){u=
y.startContainer;if(y.startOffset==(u[0].nodeType===k.NODE_ELEMENT?u[0].childNodes.length:u[0].nodeValue.length)&&!u._4e_isBlockBoundary())y.setStartAfter(u);else break}u=y.startContainer;if(u[0].nodeType!=k.NODE_ELEMENT)return u.parent();u=new f(u[0].childNodes[y.startOffset]);if(!u[0]||u[0].nodeType!=k.NODE_ELEMENT)return y.startContainer;for(y=u[0].firstChild;y&&y.nodeType==k.NODE_ELEMENT;){u=new f(y);y=y.firstChild}return u}if(a){y=J.createRange();y.collapse(t);u=y.parentElement()}else if((u=
J.anchorNode)&&u.nodeType!=k.NODE_ELEMENT)u=u.parentNode}return o.startElement=u?c._4e_wrap(u):s},getSelectedElement:function(){var o=this,u,J=o._.cache;if(J.selectedElement!==undefined)return J.selectedElement;if(a){u=o.getNative().createRange();u=u.item&&u.item(0)}u||(u=function(){for(var y=o.getRanges()[0],e,i,n=2;n&&!((e=y.getEnclosedNode())&&e[0].nodeType==k.NODE_ELEMENT&&l[e._4e_name()]&&(i=e));n--)y.shrink(A.SHRINK_ELEMENT);return i&&i[0]}());return J.selectedElement=c._4e_wrap(u)},reset:function(){this._.cache=
{}},selectElement:function(o){var u,J=this.document;if(a)try{u=J.body.createControlRange();u.addElement(o[0]);u.select()}catch(y){u=J.body.createTextRange();u.moveToElementText(o[0]);u.select()}finally{}else{u=J.createRange();u.selectNode(o[0]);o=this.getNative();o.removeAllRanges();o.addRange(u)}this.reset()},selectRanges:function(o){if(a){if(o.length>1){var u=o[o.length-1];o[0].setEnd(u.endContainer,u.endOffset);o.length=1}o[0]&&o[0].select()}else{u=this.getNative();if(!u)return;u.removeAllRanges();
for(var J=0;J<o.length;J++){var y=o[J],e=this.document.createRange(),i=y.startContainer;y.collapsed&&h.gecko&&h.gecko<1.09&&i[0].nodeType==k.NODE_ELEMENT&&!i[0].childNodes.length&&i[0].appendChild(this.document.createTextNode(""));e.setStart(i[0],y.startOffset);e.setEnd(y.endContainer[0],y.endOffset);u.addRange(e)}}this.reset()},createBookmarks2:function(o){for(var u=[],J=this.getRanges(),y=0;y<J.length;y++)u.push(J[y].createBookmark2(o));return u},createBookmarks:function(o,u){var J=[],y=this.document,
e;u=u||this.getRanges();for(var i=u.length,n=0;n<i;n++){J.push(e=u[n].createBookmark(o,t));var w=(o=e.serializable)?m.one("#"+e.startNode,y):e.startNode;e=o?m.one("#"+e.endNode,y):e.endNode;for(var q=n+1;q<i;q++){var z=u[q],O=z.startContainer,P=z.endContainer;c._4e_equals(O,w.parent())&&z.startOffset++;c._4e_equals(O,e.parent())&&z.startOffset++;c._4e_equals(P,w.parent())&&z.endOffset++;c._4e_equals(P,e.parent())&&z.endOffset++}}return J},selectBookmarks:function(o){for(var u=[],J=0;J<o.length;J++){var y=
new d(this.document);y.moveToBookmark(o[J]);u.push(y)}this.selectRanges(u);return this},getCommonAncestor:function(){var o=this.getRanges();return o[0].startContainer._4e_commonAncestor(o[o.length-1].endContainer)},scrollIntoView:function(){var o=this.getStartElement();o&&o._4e_scrollIntoView()},removeAllRanges:function(){var o=this.getNative();if(a)o&&o.clear();else o&&o.removeAllRanges()}});var D={table:1,tbody:1,tr:1},r=b.whitespaces(t),E=/\ufeff|\u00a0/;d.prototype.select=d.prototype.select=!a?
function(){var o=this.startContainer;this.collapsed&&o[0].nodeType==k.NODE_ELEMENT&&!o[0].childNodes.length&&o[0].appendChild(this.document.createTextNode(""));var u=this.document.createRange();u.setStart(o[0],this.startOffset);try{u.setEnd(this.endContainer[0],this.endOffset)}catch(J){if(J.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(t);u.setEnd(this.endContainer[0],this.endOffset)}else throw J;}o=C(this.document).getNative();o.removeAllRanges();o.addRange(u)}:function(o){var u=
this.collapsed,J,y;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var e=this.startContainer[0].childNodes[this.startOffset];if(e.nodeType==k.NODE_ELEMENT){(new x(this.document)).selectElement(new f(e));return}}if(this.startContainer[0].nodeType==k.NODE_ELEMENT&&this.startContainer._4e_name()in D||this.endContainer[0].nodeType==k.NODE_ELEMENT&&this.endContainer._4e_name()in D)this.shrink(A.SHRINK_ELEMENT,t);var i=this.createBookmark();e=i.startNode;var n;if(!u)n=
i.endNode;i=this.document.body.createTextRange();i.moveToElementText(e[0]);i.moveStart("character",1);if(n){o=this.document.body.createTextRange();o.moveToElementText(n[0]);i.setEndPoint("EndToEnd",o);i.moveEnd("character",-1)}else{for(J=e[0].nextSibling;J&&!r(J);)J=J.nextSibling;J=!(J&&J.nodeValue&&J.nodeValue.match(E))&&(o||!e[0].previousSibling||e[0].previousSibling&&c._4e_name(e[0].previousSibling)=="br");y=new f(this.document.createElement("span"));y.html("&#65279;");y.insertBefore(e);J&&c.insertBefore(this.document.createTextNode("\ufeff"),
e)}this.setStartBefore(e);e._4e_remove();if(u){if(J){i.moveStart("character",-1);i.select();this.document.selection.clear()}else i.select();if(y){this.moveToPosition(y,A.POSITION_BEFORE_START);y._4e_remove()}}else{this.setEndBefore(n);n._4e_remove();i.select()}};x.getSelection=C;p.Selection=x;p.Selection=x;b=x.prototype;p.Utils.extern(b,{getNative:b.getNative,getType:b.getType,getRanges:b.getRanges,getStartElement:b.getStartElement,getSelectedElement:b.getSelectedElement,reset:b.reset,selectElement:b.selectElement,
selectRanges:b.selectRanges,createBookmarks2:b.createBookmarks2,createBookmarks:b.createBookmarks,getCommonAncestor:b.getCommonAncestor,scrollIntoView:b.scrollIntoView,selectBookmarks:b.selectBookmarks,removeAllRanges:b.removeAllRanges});p.on("instanceCreated",function(o){B(o.editor)})});
KISSY.Editor.add("styles",function(p){function x(F,K){for(var H in F)F[H]=F[H].replace(T,function(G,I){return K[I]})}function C(F,K){if(K){F=u.clone(F);x(F.attributes,K);x(F.styles,K)}var H=this.element=this.element=(F.element||"*").toLowerCase();this.type=this.type=H=="#"||Q[H]?e.STYLE_BLOCK:S[H]?e.STYLE_OBJECT:e.STYLE_INLINE;this._={definition:F}}function B(F,K){var H=K?this.removeFromRange:this.applyToRange;F.body.focus();for(var G=new n(F),I=G.getRanges(),N=0;N<I.length;N++)H.call(this,I[N]);
G.selectRanges(I)}function t(F,K){var H;H=F.element;if(H=="*")H="span";H=new O(K.createElement(H));return v(H,F)}function v(F,K){var H=K._.definition,G=H.attributes;H=C.getStyleText(H);if(G)for(var I in G)F.attr(I,G[I]);if(H)F[0].style.cssText=H;return F}function s(F){var K=F.createBookmark(r),H=F.createIterator();H.enforceRealBlocks=r;H.enlargeBr=r;for(var G,I=F.document;G=H.getNextParagraph();){var N=t(this,I);G=G;var M=N;N=M._4e_name=="pre";var R=G._4e_name=="pre",Z=!N&&R;if(N&&!R){R=G;M=M;Z=R.html();
Z=m(Z,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");Z=Z.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");Z=Z.replace(/([ \t\n\r]+|&nbsp;)/g," ");Z=Z.replace(/<br\b[^>]*>/gi,"\n");if(P.ie){R=R[0].ownerDocument.createElement("div");R.appendChild(M[0]);M[0].outerHTML="<pre>"+Z+"</pre>";M=new O(R.firstChild);M._4e_remove()}else M.html(Z);M=M}else if(Z)M=c(h(G),M);else G._4e_moveChildren(M);G[0].parentNode.replaceChild(M[0],G[0]);if(N){G=M;N=void 0;if((N=G._4e_previousSourceNode(r,w.NODE_ELEMENT))&&N._4e_name()==
"pre"){M=m(N.html(),/\n$/,"")+"\n\n"+m(G.html(),/^\n/,"");if(P.ie)G[0].outerHTML="<pre>"+M+"</pre>";else G.html(M);N._4e_remove()}}}F.moveToBookmark(K)}function m(F,K,H){var G="",I="";F=F.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(N,M,R){M&&(G=M);R&&(I=R);return""});return G+F.replace(K,H)+I}function h(F){var K=[];m(F._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(H,G,I){return G+"</pre>"+I+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(H,G){K.push(G)});return K}function c(F,K){for(var H=K[0].ownerDocument.createDocumentFragment(),G=0;G<F.length;G++){var I=F[G];I=I.replace(/(\r\n|\r)/g,"\n");I=m(I,/^[ \t]*\n/,"");I=m(I,/\n$/,"");I=m(I,/^[ \t]+|[ \t]+$/g,function(M,R){return M.length==1?"&nbsp;":R?" "+Array(M.length).join("&nbsp;"):Array(M.length).join("&nbsp;")+" "});I=I.replace(/\n/g,"<br>");I=I.replace(/[ \t]{2,}/g,function(M){return Array(M.length).join("&nbsp;")+" "});var N=K._4e_clone();N.html(I);H.appendChild(N[0])}return H}
function g(F){var K=F.document;if(F.collapsed){K=t(this,K);F.insertNode(K);F.moveToPosition(K,i.POSITION_BEFORE_END)}else{var H=this.element,G=this._.definition,I,N=p.XHTML_DTD[H]||(I=r,p.XHTML_DTD.span),M=F.createBookmark();F.enlarge(i.ENLARGE_ELEMENT);F.trim();var R=F.createBookmark(),Z=R.startNode;R=R.endNode;for(var X=Z,$;X&&X[0];){var W=E;if(y._4e_equals(X,R)){X=o;W=r}else{var Y=X[0].nodeType,ca=Y==w.NODE_ELEMENT?X._4e_name():o;if(ca&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(r);continue}if(!ca||
N[ca]&&(X._4e_position(R)|q.POSITION_PRECEDING|q.POSITION_IDENTICAL|q.POSITION_IS_CONTAINED)==q.POSITION_PRECEDING+q.POSITION_IDENTICAL+q.POSITION_IS_CONTAINED&&(!G.childRule||G.childRule(X))){var da=X.parent();if(da&&da[0]&&((p.XHTML_DTD[da._4e_name()]||p.XHTML_DTD.span)[H]||I)&&(!G.parentRule||G.parentRule(da))){if(!$&&(!ca||!p.XHTML_DTD.$removeEmpty[ca]||(X._4e_position(R)|q.POSITION_PRECEDING|q.POSITION_IDENTICAL|q.POSITION_IS_CONTAINED)==q.POSITION_PRECEDING+q.POSITION_IDENTICAL+q.POSITION_IS_CONTAINED)){$=
new z(K);$.setStartBefore(X)}if(Y==w.NODE_TEXT||Y==w.NODE_ELEMENT&&!X[0].childNodes.length){Y=X;var aa;for(ca=Y._4e_next(function(fa){return!fa.attr("_ke_bookmark")});!ca&&(aa=Y.parent(),N[aa._4e_name()])&&(aa._4e_position(Z)|q.POSITION_FOLLOWING|q.POSITION_IDENTICAL|q.POSITION_IS_CONTAINED)==q.POSITION_FOLLOWING+q.POSITION_IDENTICAL+q.POSITION_IS_CONTAINED&&(!G.childRule||G.childRule(aa));)Y=aa;$.setEndAfter(Y);Y[0].nextSibling||(W=r)}}else W=r}else W=r;X=X._4e_nextSourceNode()}if(W&&$&&!$.collapsed){W=
t(this,K);for(Y=$.getCommonAncestor();W&&Y&&W[0]&&Y[0];){if(Y._4e_name()==H){for(var ba in G.attributes)W.attr(ba)==Y.attr(ba)&&W[0].removeAttribute(ba);for(var ea in G.styles)W._4e_style(ea)==Y._4e_style(ea)&&W._4e_style(ea,"");if(!W._4e_hasAttributes()){W=o;break}}Y=Y.parent()}if(W){W[0].appendChild($.extractContents());d(this,W);$.insertNode(W);W._4e_mergeSiblings();P.ie||W[0].normalize()}$=o}}Z._4e_remove();R._4e_remove();F.moveToBookmark(M);F.shrink(i.SHRINK_TEXT)}}function f(F){F.enlarge(i.ENLARGE_ELEMENT);
var K=F.createBookmark(),H=K.startNode;if(F.collapsed){for(var G=new L(H.parent()),I,N=0,M;N<G.elements.length&&(M=G.elements[N]);N++){if(M==G.block||M==G.blockLimit)break;if(this.checkElementRemovable(M)){var R=F.checkBoundaryOfElement(M,i.END),Z=!R&&F.checkBoundaryOfElement(M,i.START);if(Z||R){I=M;I.match=Z?"start":"end"}else{M._4e_mergeSiblings();M._4e_name()==this.element?a(this,M):l(M,k(this)[M._4e_name()])}}}if(I&&I[0]){M=H;for(N=0;;N++){R=G.elements[N];if(y._4e_equals(R,I))break;else if(R.match)continue;
else R=R._4e_clone();R[0].appendChild(M[0]);M=R}y[I.match=="start"?"insertBefore":"insertAfter"](M,I)}}else{var X=K.endNode,$=this;G=function(){for(var W=new L(H.parent()),Y=new L(X.parent()),ca=o,da=o,aa=0;aa<W.elements.length;aa++){var ba=W.elements[aa];if(ba==W.block||ba==W.blockLimit)break;if($.checkElementRemovable(ba))ca=ba}for(aa=0;aa<Y.elements.length;aa++){ba=Y.elements[aa];if(ba==Y.block||ba==Y.blockLimit)break;if($.checkElementRemovable(ba))da=ba}da&&X._4e_breakParent(da);ca&&H._4e_breakParent(ca)};
G();for(I=new O(H[0].nextSibling);I[0]!==X[0];){N=I._4e_nextSourceNode();if(I[0]&&I[0].nodeType==w.NODE_ELEMENT&&this.checkElementRemovable(I)){I._4e_name()==this.element?a(this,I):l(I,k(this)[I._4e_name()]);if(N[0].nodeType==w.NODE_ELEMENT&&N.contains(H)){G();N=new O(H[0].nextSibling)}}I=N}}F.moveToBookmark(K)}function j(F){var K={};F.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(H,G,I){K[G]=I});return K}function A(F,K){var H;if(K!==E){H=document.createElement("span");
H.style.cssText=F;H=H.style.cssText||""}else H=F;return H.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function k(F){if(F._.overrides)return F._.overrides;var K=F._.overrides={},H=F._.definition.overrides;if(H){u.isArray(H)||(H=[H]);for(var G=0;G<H.length;G++){var I=H[G],N,M;if(typeof I=="string")N=I.toLowerCase();else{N=I.element?I.element.toLowerCase():F.element;M=I.attributes}I=K[N]||(K[N]={});if(M){I=I.attributes=I.attributes||[];for(var R in M)I.push([R.toLowerCase(),
M[R]])}}}return K}function a(F,K){var H=F._.definition,G=J.mix(H.attributes,k(F)[K._4e_name()]);H=H.styles;var I=u.isEmptyObject(G)&&u.isEmptyObject(H),N;for(N in G)if(!((N=="class"||F._.definition.fullMatch)&&K.attr(N)!=b(N,G[N]))){I=I||!!K._4e_hasAttribute(N);K.removeAttr(N)}for(var M in H)if(!(F._.definition.fullMatch&&K._4e_style(M)!=b(M,H[M],r))){I=I||!!K._4e_style(M);K._4e_style(M,"")}D(K)}function b(F,K,H){var G=new O("<span>");G[H?"_4e_style":"attr"](F,K);return G[H?"_4e_style":"attr"](F)}
function d(F,K){for(var H=k(F),G=K.all(F.element),I=G.length;--I>=0;)a(F,new O(G[I]));for(var N in H)if(N!=F.element){G=K.all(N);for(I=G.length-1;I>=0;I--){var M=new O(G[I]);l(M,H[N])}}}function l(F,K){var H=K&&K.attributes;if(H)for(var G=0;G<H.length;G++){var I=H[G][0],N;if(N=F.attr(I)){var M=H[G][1];if(M===o||M.test&&M.test(N)||typeof M=="string"&&N==M)F[0].removeAttribute(I)}}D(F)}function D(F){if(!F._4e_hasAttributes()){var K=F[0].firstChild,H=F[0].lastChild;F._4e_remove(r);if(K){K.nodeType==
w.NODE_ELEMENT&&y._4e_mergeSiblings(K);H&&K!=H&&H.nodeType==w.NODE_ELEMENT&&y._4e_mergeSiblings(H)}}}var r=true,E=false,o=null,u=KISSY,J=p.Utils,y=u.DOM,e={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},i=p.RANGE,n=p.Selection,w=p.NODE,q=p.POSITION,z=p.Range,O=u.Node,P=u.UA,L=p.ElementPath,Q={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},S={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},U=/\s*(?:;\s*|$)/g,T=/#\((.+?)\)/g;p.STYLE=e;C.prototype={apply:function(F){B.call(this,
F,E)},remove:function(F){B.call(this,F,r)},applyToRange:function(F){return(this.applyToRange=this.type==e.STYLE_INLINE?g:this.type==e.STYLE_BLOCK?s:this.type==e.STYLE_OBJECT?o:o).call(this,F)},removeFromRange:function(F){return(this.removeFromRange=this.type==e.STYLE_INLINE?f:o).call(this,F)},applyToObject:function(F){v(F,this)},checkElementRemovable:function(F,K){if(!F)return E;var H=this._.definition;if(F._4e_name()==this.element){if(!K&&!F._4e_hasAttributes())return r;var G=H._AC;if(G)H=G;else{G=
{};var I=0,N=H.attributes;if(N)for(var M in N){I++;G[M]=N[M]}if(N=C.getStyleText(H)){G.style||I++;G.style=N}G._length=I;H=H._AC=G}if(H._length){for(var R in H)if(R!="_length"){I=F.attr(R)||"";if(R=="style")a:{G=H[R];I=A(I,E);typeof G=="string"&&(G=j(G));typeof I=="string"&&(I=j(I));N=void 0;for(N in G)if(!(N in I&&(I[N]==G[N]||G[N]=="inherit"||I[N]=="inherit"))){G=E;break a}G=r}else G=H[R]==I;if(G){if(!K)return r}else if(K)return E}if(K)return r}else return r}if(R=k(this)[F._4e_name()]){if(!(H=R.attributes))return r;
for(G=0;G<H.length;G++){R=H[G][0];if(R=F.attr(R)){I=H[G][1];if(I===o||typeof I=="string"&&R==I||I.test&&I.test(R))return r}}}return E},checkActive:function(F){switch(this.type){case e.STYLE_BLOCK:return this.checkElementRemovable(F.block||F.blockLimit,r);case e.STYLE_OBJECT:case e.STYLE_INLINE:for(var K=F.elements,H=0,G;H<K.length;H++){G=K[H];if(!(this.type==e.STYLE_INLINE&&(y._4e_equals(G,F.block)||y._4e_equals(G,F.blockLimit))))if(!(this.type==e.STYLE_OBJECT&&!(G._4e_name()in S)))if(this.checkElementRemovable(G,
r))return r}}return E}};C.getStyleText=function(F){var K=F._ST;if(K)return K;K=F.styles;var H=F.attributes&&F.attributes.style||"",G="";if(H.length)H=H.replace(U,";");for(var I in K){var N=K[I],M=(I+":"+N).replace(U,";");if(N=="inherit")G+=M;else H+=M}if(H.length)H=A(H);H+=G;return F._ST=H};p.Style=C;p.Style=C;var V=C.prototype;p.Utils.extern(V,{apply:V.apply,remove:V.remove,applyToRange:V.applyToRange,removeFromRange:V.removeFromRange,applyToObject:V.applyToObject,checkElementRemovable:V.checkElementRemovable,
checkActive:V.checkActive})});
KISSY.Editor.add("htmlparser",function(){function p(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var x=KISSY,C=function(){},B=x.Editor,t=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,v={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},s=B.XHTML_DTD;x.augment(p,{onTagOpen:C,onTagClose:C,
onText:C,onCDATA:C,onComment:C,parse:function(m){for(var h,c,g=0,f;h=this._.htmlPartsRegex.exec(m);){c=h.index;if(c>g){g=m.substring(g,c);f?f.push(g):this.onText(g)}g=this._.htmlPartsRegex.lastIndex;if(c=h[1]){c=c.toLowerCase();if(f&&s.$cdata[c]){this.onCDATA(f.join(""));f=null}if(!f){this.onTagClose(c);continue}}if(f)f.push(h[0]);else if(c=h[3]){c=c.toLowerCase();if(!/="/.test(c)){var j={},A;h=h[4];var k=!!(h&&h.charAt(h.length-1)=="/");if(h)for(;A=t.exec(h);){var a=A[1].toLowerCase();A=A[2]||A[3]||
A[4]||"";j[a]=!A&&v[a]?a:A}this.onTagOpen(c,j,k);if(!f&&s.$cdata[c])f=[]}}else if(c=h[2])this.onComment(c)}m.length>g&&this.onText(m.substring(g,m.length))}});B.HtmlParser=p;B.HtmlParser=p});
KISSY.Editor.add("htmlparser-basicwriter",function(){function p(){this._={output:[]}}var x=KISSY,C=x.Editor,B=C.Utils;x.augment(p,{openTag:function(t){this._.output.push("<",t)},openTagClose:function(t,v){v?this._.output.push(" />"):this._.output.push(">")},attribute:function(t,v){if(typeof v=="string")v=B.htmlEncodeAttr(v);this._.output.push(" ",t,'="',v,'"')},closeTag:function(t){this._.output.push("</",t,">")},text:function(t){this._.output.push(t)},comment:function(t){this._.output.push("<!--",
t,"--\>")},write:function(t){this._.output.push(t)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(t){var v=this._.output.join("");t&&this.reset();return v}});C.HtmlParser.BasicWriter=p;C.HtmlParser.BasicWriter=p;x=p.prototype;C.Utils.extern(x,{openTag:x.openTag,openTagClose:x.openTagClose,attribute:x.attribute,closeTag:x.closeTag,text:x.text,comment:x.comment,write:x.write,reset:x.reset,getHtml:x.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function p(){p.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=v;this.sortAttributes=t;this._.indent=v;this._.indentation="";this._.rules={};var s=C.XHTML_DTD,m;for(m in B.mix({},s.$nonBodyContent,s.$block,s.$listItem,s.$tableContent))this.setRules(m,{indent:t,breakBeforeOpen:t,breakAfterOpen:t,breakBeforeClose:!s[m]["#"],breakAfterClose:t});this.setRules("br",
{breakAfterOpen:t});this.setRules("title",{indent:v,breakAfterOpen:v});this.setRules("style",{indent:v,breakBeforeClose:t});this.setRules("pre",{indent:v})}var x=KISSY,C=x.Editor,B=C.Utils,t=true,v=false;x.extend(p,C.HtmlParser.BasicWriter,{openTag:function(s){var m=this._.rules[s];if(this._.indent)this.indentation();else if(m&&m.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",s)},openTagClose:function(s,m){var h=this._.rules[s];if(m)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(h&&h.indent)this._.indentation+=this.indentationChars}h&&h.breakAfterOpen&&this.lineBreak()},attribute:function(s,m){if(typeof m=="string"){this.forceSimpleAmpersand&&(m=m.replace(/&amp;/g,"&"));m=B.htmlEncodeAttr(m)}this._.output.push(" ",s,'="',m,'"')},closeTag:function(s){var m=this._.rules[s];if(m&&m.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(m&&m.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",s,">");m&&m.breakAfterClose&&this.lineBreak()},text:function(s){if(this._.indent){this.indentation();s=B.ltrim(s)}this._.output.push(s)},comment:function(s){this._.indent&&this.indentation();this._.output.push("<!--",s,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=t},indentation:function(){this._.output.push(this._.indentation);this._.indent=v},setRules:function(s,m){var h=this._.rules[s];if(h)B.mix(h,
m);else this._.rules[s]=m}});C.HtmlParser.HtmlWriter=p;C.HtmlParser.HtmlWriter=p;x=p.prototype;C.Utils.extern(x,{openTag:x.openTag,openTagClose:x.openTagClose,attribute:x.attribute,closeTag:x.closeTag,text:x.text,comment:x.comment,lineBreak:x.lineBreak,indentation:x.indentation,setRules:x.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function p(){this.children=[];this.parent=B;this._={isBlockLike:x,hasInlineStarted:C}}var x=true,C=false,B=null,t=KISSY.Editor,v={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},s=KISSY,m=t.Utils,h=t.NODE,c=t.XHTML_DTD,g=m.mix({table:1,ul:1,ol:1,dl:1},c.table,c.ul,c.ol,c.dl),f=c.$list,j=c.$listItem;p.FromHtml=function(A,k){function a(i){var n;if(r.length>0)for(var w=0;w<r.length;w++){var q=r[w],z=q.name,O=c[z],P=o.name&&c[o.name];
if((!P||P[z])&&(!i||!O||O[i]||!c[i])){if(!n){b();n=1}q=q.clone();q.parent=o;o=q;r.splice(w,1);w--}}}function b(){for(;E.length;)o.add(E.shift())}function d(i,n,w){n=n||o||D;if(k&&!n.type){var q,z;if((q=i.attributes&&(z=i.attributes._ke_real_element_type)?z:i.name)&&!(q in c.$body)&&!(q in c.$nonBodyContent)){q=o;o=n;l.onTagOpen(k,{});n=o;if(w)o=q}}if(i._.isBlockLike&&i.name!="pre"){w=i.children.length;if((q=i.children[w-1])&&q.type==h.NODE_TEXT)if(z=m.rtrim(q.value))q.value=z;else i.children.length=
w-1}n.add(i);if(i.returnPoint){o=i.returnPoint;delete i.returnPoint}}var l=new t.HtmlParser,D=new p,r=[],E=[],o=D,u=C,J;l.onTagOpen=function(i,n,w){var q=new t.HtmlParser.Element(i,n);if(q.isUnknown&&w)q.isEmpty=x;if(c.$removeEmpty[i])r.push(q);else{if(i==="pre")u=x;else if(i==="br"&&u){o.add(new t.HtmlParser.Text("\n"));return}if(i==="br")E.push(q);else{var z=o.name,O=z&&(c[z]||(o._.isBlockLike?c.div:c.span));if(O&&!q.isUnknown&&!o.isUnknown&&!O[i]){O=C;var P;if(i in f&&z in f){z=o.children;(z=z[z.length-
1])&&z.name in j||d(z=new t.HtmlParser.Element("li"),o);J=o;P=z}else if(i==z)d(o,o.parent);else{if(g[z])J||(J=o);else{d(o,o.parent,x);v[z]||r.unshift(o)}O=x}o=P?P:o.returnPoint||o.parent;if(O){l.onTagOpen.apply(this,arguments);return}}a(i);b();q.parent=o;q.returnPoint=J;J=0;if(q.isEmpty)d(q);else o=q}}};l.onTagClose=function(i){for(var n=r.length-1;n>=0;n--)if(i==r[n].name){r.splice(n,1);return}for(var w=[],q=[],z=o;z.type&&z.name!=i;){z._.isBlockLike||q.unshift(z);w.push(z);z=z.parent}if(z.type){for(n=
0;n<w.length;n++){var O=w[n];d(O,O.parent)}o=z;if(o.name=="pre")u=C;z._.isBlockLike&&b();d(z,z.parent);if(z==o)o=o.parent;r=r.concat(q)}if(i=="body")k=C};l.onText=function(i){if(!o._.hasInlineStarted&&!u){i=m.ltrim(i);if(i.length===0)return}b();a();if(k&&(!o.type||o.name=="body")&&m.trim(i))this.onTagOpen(k,{});u||(i=i.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));o.add(new t.HtmlParser.Text(i))};l.onCDATA=function(){};l.onComment=function(i){o.add(new t.HtmlParser.Comment(i))};l.parse(A);for(b();o.type;){var y=
o.parent,e=o;if(k&&(!y.type||y.name=="body")&&!c.$body[e.name]){o=y;l.onTagOpen(k,{});y=o}y.add(e);o=y}return D};s.augment(p,{add:function(A){var k=this.children.length;if(k=k>0&&this.children[k-1]||B){if(A._.isBlockLike&&k.type==h.NODE_TEXT){k.value=m.rtrim(k.value);if(k.value.length===0){this.children.pop();this.add(A);return}}k.next=A}A.previous=k;A.parent=this;this.children.push(A);this._.hasInlineStarted=A.type==h.NODE_TEXT||A.type==h.NODE_ELEMENT&&!A._.isBlockLike},writeHtml:function(A,k){var a;
this.filterChildren=this.filterChildren=function(){var b=new t.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,b,k,x);b=b.getHtml();this.children=(new p.FromHtml(b)).children;a=1};!this.name&&k&&k.onFragment(this);this.writeChildrenHtml(A,a?B:k)},writeChildrenHtml:function(A,k){for(var a=0;a<this.children.length;a++)this.children[a].writeHtml(A,k)}});t.HtmlParser.Fragment=p;t.HtmlParser.Fragment=p;p.FromHtml=p.FromHtml;s=p.prototype;t.Utils.extern(s,{add:s.add,writeHtml:s.writeHtml,writeChildrenHtml:s.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function p(v,s){this.name=v;this.attributes=s||(s={});this.children=[];var m=s._ke_real_element_type||v,h=x.XHTML_DTD;m=!!(h.$nonBodyContent[m]||h.$block[m]||h.$listItem[m]||h.$tableContent[m]||h.$nonEditable[m]||m=="br");var c=!!h.$empty[v];this.isEmpty=c;this.isUnknown=!h[v];this._={isBlockLike:m,hasInlineStarted:c||!m}}var x=KISSY.Editor,C=x.NODE,B=function(v,s){v=v[0];s=s[0];return v<s?-1:v>s?1:0};KISSY.augment(p,{type:C.NODE_ELEMENT,add:x.HtmlParser.Fragment.prototype.add,
clone:function(){return new p(this.name,this.attributes)},writeHtml:function(v,s){var m=this.attributes,h=this,c=h.name,g,f,j,A;h.filterChildren=function(){if(!A){var b=new x.HtmlParser.BasicWriter;x.HtmlParser.Fragment.prototype.writeChildrenHtml.call(h,b,s);h.children=(new x.HtmlParser.Fragment.FromHtml(b.getHtml())).children;A=1}};h.filterChildren=h.filterChildren;if(s){for(;;){if(!(c=s.onElementName(c)))return;h.name=c;if(!(h=s.onElement(h)))return;h.parent=this.parent;if(h.name==c)break;if(h.type!=
C.NODE_ELEMENT){h.writeHtml(v,s);return}c=h.name;if(!c){this.writeChildrenHtml.call(h,v,A?null:s);return}}m=h.attributes}v.openTag(c,m);for(var k=[],a=0;a<2;a++)for(g in m){f=g;j=m[g];if(a==1)k.push([g,j]);else if(s){for(;;)if(f=s.onAttributeName(g))if(f!=g){delete m[g];g=f}else break;else{delete m[g];break}if(f)if((j=s.onAttribute(h,f,j))===false)delete m[f];else m[f]=j}}v.sortAttributes&&k.sort(B);m=k.length;for(a=0;a<m;a++){g=k[a];v.attribute(g[0],g[1])}v.openTagClose(c,h.isEmpty);if(!h.isEmpty){this.writeChildrenHtml.call(h,
v,A?null:s);v.closeTag(c)}},writeChildrenHtml:function(){x.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});x.HtmlParser.Element=p;x.HtmlParser.Element=p;var t=p.prototype;x.Utils.extern(t,{type:t.type,add:t.add,clone:t.clone,writeHtml:t.writeHtml,writeChildrenHtml:t.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function p(g){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};g&&this.addRules(g,10)}function x(g,f){for(var j=0;g&&j<f.length;j++){var A=f[j];g=g.replace(A[0],A[1])}return g}function C(g,f,j){if(typeof f=="function")f=[f];var A,k;k=g.length;var a=f&&f.length;if(a){for(A=0;A<k&&g[A].pri<j;A++);for(k=a-1;k>=0;k--)if(a=f[k]){a.pri=j;g.splice(A,0,a)}}}function B(g,f,j){if(f)for(var A in f){var k=g[A];g[A]=t(k,f[A],
j);k||g.$length++}}function t(g,f,j){if(f){f.pri=j;if(g){if(g.splice)C(g,f,j);else{g=g.pri>j?[f,g]:[g,f];g.filter=v}return g}else return f.filter=f}}function v(g){for(var f=g.type||g instanceof m.HtmlParser.Fragment,j=0;j<this.length;j++){if(f)var A=g.type,k=g.name;var a=this[j].apply(window,arguments);if(a===c)return a;if(f){if(a&&(a.name!=k||a.type!=A))return a}else if(typeof a!="string")return a;a!=undefined&&(g=a)}return g}var s=KISSY,m=s.Editor,h=m.NODE,c=false;s.augment(p,{addRules:function(g,
f){if(typeof f!="number")f=10;C(this._.elementNames,g.elementNames,f);C(this._.attributeNames,g.attributeNames,f);B(this._.elements,g.elements,f);B(this._.attributes,g.attributes,f);this._.text=t(this._.text,g.text,f)||this._.text;this._.comment=t(this._.comment,g.comment,f)||this._.comment;this._.root=t(this._.root,g.root,f)||this._.root},onElementName:function(g){return x(g,this._.elementNames)},onAttributeName:function(g){return x(g,this._.attributeNames)},onText:function(g){var f=this._.text;
return f?f.filter(g):g},onComment:function(g,f){var j=this._.comment;return j?j.filter(g,f):g},onFragment:function(g){var f=this._.root;return f?f.filter(g):g},onElement:function(g){for(var f=[this._.elements["^"],this._.elements[g.name],this._.elements.$],j,A=0;A<3;A++)if(j=f[A]){j=j.filter(g,this);if(j===c)return null;if(j&&j!=g)return this.onNode(j);if(g.parent&&!g.name)break}return g},onNode:function(g){var f=g.type;return f==h.NODE_ELEMENT?this.onElement(g):f==h.NODE_TEXT?new m.HtmlParser.Text(this.onText(g.value)):
null},onAttribute:function(g,f,j){if(f=this._.attributes[f]){g=f.filter(j,g,this);if(g===c)return c;if(typeof g!="undefined")return g}return j}});m.HtmlParser.Filter=p;s=p.prototype;m.Utils.extern(s,{addRules:s.addRules,onElementName:s.onElementName,onAttributeName:s.onAttributeName,onText:s.onText,onComment:s.onComment,onFragment:s.onFragment,onElement:s.onElement,onNode:s.onNode,onAttribute:s.onAttribute});m.HtmlParser.Filter=p});
KISSY.Editor.add("htmlparser-text",function(){function p(t){this.value=t;this._={isBlockLike:B}}var x=KISSY,C=x.Editor,B=false;x.augment(p,{type:C.NODE.NODE_TEXT,writeHtml:function(t,v){var s=this.value;v&&!(s=v.onText(s,this))||t.text(s)}});C.HtmlParser.Text=p;C.HtmlParser.Text=p});
KISSY.Editor.add("htmlparser-comment",function(){function p(B){this.value=B;this._={isBlockLike:false}}var x=KISSY.Editor,C=x.NODE;x.HtmlParser.Comment=p;x.HtmlParser.Comment=p;p.prototype={constructor:p,type:C.NODE_COMMENT,writeHtml:function(B,t){var v=this.value;if(t){if(!(v=t.onComment(v,this)))return;if(typeof v!="string"){v.parent=this.parent;v.writeHtml(B,t);return}}B.comment(v)}}});
KISSY.Editor.add("button",function(){var p=KISSY,x=p.Editor;if(x.TripleButton)p.log("TripleButton attach twice","warn");else{var C=p.UIBase.create([p.UIBase.Box],{bindUI:function(){var B=this,t=B.get("el");t.on("click",B._action,B);t.on("mousedown",function(){B.get("state")=="off"&&t.addClass("ke-triplebutton-active")});t.on("mouseup mouseleave",function(){B.get("state")=="off"&&t.hasClass("ke-triplebutton-active")&&setTimeout(function(){t.removeClass("ke-triplebutton-active")},300)})},_uiSetTitle:function(){this.get("el").attr("title",
this.get("title"))},_uiSetContentCls:function(B){var t=this.get("el");if(B!==undefined){t.html("<span class='ke-toolbar-item "+B+"'>");t._4e_unselectable()}},_uiSetText:function(B){var t=this.get("el");B!==undefined&&t.html(B)},_uiSetState:function(B){this["_"+B]()},disable:function(){this._savedState=this.get("state");this.set("state","disabled")},enable:function(){this.get("state")=="disabled"&&this.set("state",this._savedState)},_action:function(B){this.fire(this.get("state")+"Click",B);B.type=
this.get("state")+"Click";this.fire("click",B);B.preventDefault()},bon:function(){this.set("state","on")},boff:function(){this.set("state","off")},_on:function(){var B=this.get("el");B.removeClass("ke-triplebutton-off ke-triplebutton-disabled");B.addClass("ke-triplebutton-on")},_off:function(){var B=this.get("el");B.removeClass("ke-triplebutton-on ke-triplebutton-disabled");B.addClass("ke-triplebutton-off")},_disabled:function(){var B=this.get("el");B.removeClass("ke-triplebutton-off ke-triplebutton-on");
B.addClass("ke-triplebutton-disabled")}},{ATTRS:{state:{value:"off"},elCls:{value:"ke-triplebutton ke-triplebutton-off"},elAttrs:{value:{hideFocus:true,tabIndex:-1}},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});C.ON="on";C.OFF="off";C.DISABLED="disabled";C.ON_CLASS="ke-triplebutton-on";C.OFF_CLASS="ke-triplebutton-off";C.DISABLED_CLASS="ke-triplebutton-disabled";x.TripleButton=C;x.prototype.addButton=function(B,t){var v=this,s=new C({render:v.toolBarDiv,autoRender:true,title:t.title,text:t.text,
contentCls:t.contentCls}),m={btn:s,editor:v,cfg:t,call:function(){var h=p.makeArray(arguments),c=h.shift();return t[c].apply(m,h)},reload:function(h){p.mix(t,h);s.enable();v.on("selectionChange",function(){v.getMode()!=x.SOURCE_MODE&&t.selectionChange&&t.selectionChange.apply(m,arguments)});s.on("click",function(c){var g=c.type;t[g]&&t[g].apply(m,arguments)});if(t.mode==x.WYSIWYG_MODE){v.on("wysiwygmode",s.enable,s);v.on("sourcemode",s.disable,s)}t.init&&t.init.call(m)}};t.loading?s.disable():m.reload(undefined);
return m}}});
KISSY.Editor.add("select",function(){function p(m){p.superclass.constructor.call(this,m);this._init()}var x=KISSY,C=x.Node,B=x.Event,t=x.DOM,v=x.Editor;if(v.Select)x.log("ke select attach more");else{p.DISABLED=0;p.ENABLED=1;var s=v.XHTML_DTD;p.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var m=this.el.parent();m;){var h=m._4e_name();if(s[h]&&s[h].div)return m;m=m.parent()}return new C(document.body)}},state:{value:1}};
p.decorate=function(m){for(var h=m.width(),c=[],g=m.all("option"),f=0;f<g.length;f++){var j=g[f];c.push({name:t.html(j),value:t.attr(j,"value")})}return new p({width:h+"px",el:m,items:c,cls:"ke-combox",value:m.val()})};x.extend(p,x.Base,{_init:function(){var m=this.get("container"),h=this.get("el"),c=new C("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
g=this.get("title")||"",f=this.get("cls"),j=c.one(".ke-select-text"),A=c.one(".ke-select-text-inner");c.one(".ke-select-drop");this.get("value")!==undefined?A.html(this._findNameByV(this.get("value"))):A.html(g);j.css("width",this.get("width"));c._4e_unselectable();g&&c.attr("title",g);f&&c.addClass(f);if(h)h[0].parentNode.replaceChild(c[0],h[0]);else m&&c.appendTo(m);c.on("click",this._click,this);this.el=c;this.title=A;this._focusA=c.one("a.ke-select");v.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",
this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_findNameByV:function(m){var h=this.get("title")||"",c=this.get("items");if(this.get("showValue"))return m||h;for(var g=0;g<c.length;g++){var f=c[g];if(f.value==m){h=f.name;break}}return h},_valueChange:function(m){this.title.html(this._findNameByV(m.newVal))},_itemsChange:function(m){m=m.newVal;var h=this._selectList;h.html("");if(m)for(var c=0;c<m.length;c++){var g=m[c];(new C("<a class='ke-select-menu-item' href='#' data-value='"+
g.value+"'>"+g.name+"</a>",g.attrs)).appendTo(h)._4e_unselectable()}this.as=h.all("a")},val:function(m){if(m!==undefined){this.set("value",m);return this}else return this.get("value")},_resize:function(){this.menu.get("visible")&&this._real()},_prepare:function(){function m(k){k=new C(k.target);c.contains(k)||c._4e_equals(k)||j.hide()}var h=this,c=h.el,g=h.get("popUpWidth"),f=h._focusA,j=new v.Overlay({autoRender:true,render:h.get("menuContainer"),content:"<div>",focus4e:false,elCls:"ke-menu",width:g?
g:c.width(),zIndex:v.baseZIndex(v.zIndexManager.SELECT),focusMgr:false}),A=h.get("items");g=j.get("contentEl").one("div");h.menu=j;B.on(window,"resize",h._resize,h);h.get("title")&&(new C("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+h.get("title")+"</div>")).appendTo(g);h._selectList=(new C("<div>")).appendTo(g);h._itemsChange({newVal:A});j.on("show",function(){f.addClass("ke-select-active")});j.on("hide",function(){f.removeClass("ke-select-active")});B.on(document,
"click",m);h.get("doc")&&B.on(h.get("doc"),"click",m);g.on("click",h._select,h);h.as=h._selectList.all("a");B.on(g[0],"mouseenter",function(){h.as.removeClass("ke-menu-selected")});h.on("afterItemsChange",h._itemsChange,h);h.menuNode=g},_stateChange:function(m){var h=this.el;m.newVal==1?h.removeClass("ke-select-disabled"):h.addClass("ke-select-disabled")},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(m){m.halt();var h=this.menu,c=this.menuNode;if(m=
(new C(m.target))._4e_ascendant(function(j){return c.contains(j)&&j._4e_name()=="a"},true)){var g=this.get("value"),f=m.attr("data-value");this.set("value",f);this.fire("click",{newVal:f,prevVal:g,name:m.html()});h.hide()}},_real:function(){var m=this.el,h=m.offset(),c=x.clone(h),g=this.menu.get("el").height(),f=this.menu.get("el").width(),j=t.scrollTop(),A=t.scrollLeft(),k=t.viewportHeight(),a=t.viewportWidth();a=A+a-60;k=j+k;var b=h.top+(m.height()-2);m=h.left+m.width()-2;var d=this.get("align"),
l=d[0];if(d[1]=="b"){h.top=b;if(h.top+g>k&&c.top-j>k-b)h.top=c.top-g}else{h.top=c.top-g;if(h.top<j&&c.top-j<k-b)h.top=b}if(l=="l"){if(h.left+f>a&&m-A>a-c.left)h.left=m-f}else{h.left=m-f;if(h.left<A&&m-A<a-c.left)h.left=c.left}this.menu.set("xy",[h.left,h.top]);this.menu.show()},_click:function(m){if(!this.loading){m.preventDefault();var h=this;m=h.el;var c=h.get("value");if(!m.hasClass("ke-select-disabled"))if(h._focusA.hasClass("ke-select-active"))h.menu&&h.menu.hide();else{h.loading=true;v.use("overlay",
function(){h.loading=false;h._prepare();c&&h.menu&&h.as.each(function(g){g.attr("data-value")==c?g.addClass("ke-menu-selected"):g.removeClass("ke-menu-selected")})})}}}});v.Select=p;v.prototype.addSelect=function(m,h){var c=this;h=x.mix({container:c.toolBarDiv,doc:c.document,menuContainer:new C(document.body)},h);var g=new p(h),f={btn:g,editor:c,cfg:h,call:function(){var j=x.makeArray(arguments),A=j.shift();return h[A].apply(f,j)},reload:function(j){x.mix(h,j);g.enable();c.on("selectionChange",function(){c.getMode()!=
v.SOURCE_MODE&&h.selectionChange&&h.selectionChange.apply(f,arguments)});g.on("click",function(A){var k=A.type;h[k]&&h[k].apply(f,arguments)});if(h.mode==v.WYSIWYG_MODE){c.on("wysiwygmode",g.enable,g);c.on("sourcemode",g.disable,g)}h.init&&h.init.call(f)}};h.loading?g.disable():f.reload(undefined);return f}}});
