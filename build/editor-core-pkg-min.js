/*
 Constructor for kissy editor and module dependency definition
 thanks to CKSource's intelligent work on CKEditor
 @author: yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.0
 @buildtime: 2010-11-10 13:03:14
*/
KISSY.add("editor",function(p,z){function C(j,a){function b(r){for(var l=C.Env.mods,i=0;i<r.length;i++){for(var B=r[i],J=A,t=0;t<i;t++)if(B==r[t]){J=u;break}t=l[B];if(J&&t){J=p.clone(t);B=B+"_"+i;J.name=B;r[i]=B;l[B]||(l[B]=J)}}}var d=this;if(!(d instanceof C))return new C(j,a);if(p.isString(j))j=p.one(j);j=w._4e_wrap(j);a=a||{};a.pluginConfig=a.pluginConfig||{};d.cfg=a;a.pluginConfig=a.pluginConfig;d.cfg=a;p.app(d,p.EventTarget);var m=["htmldataprocessor","enterkey","clipboard"],y=A;d.use=function(r,
l){r=r.split(",");b(r);if(!y)for(var i=0;i<m.length;i++){var B=m[i];p.inArray(B,r)||r.unshift(B)}p.use.call(d,r.join(","),function(){d.ready(function(){l&&l.call(d);if(!y){d.setData(j.val());if(a.focus)d.focus();else{var J=d.getSelection();J&&J.removeAllRanges()}d.fire("save");y=u}})},{order:u,global:C});return d};d.use=d.use;d.init(j);return d}function H(j){var a=p.Config.debug;j=a?a==="dev"?"../src/"+j:j:j.replace(/\.(js|css)/i,"-min.$1");j+=j.indexOf("?")!=-1?"&":"?";j+="t="+encodeURIComponent("2010-11-10 13:03:14");
return j}var w=p.DOM,u=true,A=false;p.app(C,p.EventTarget);C.Config.base=p.Config.base+"editor/";var v=["separator","sourcearea/support","tabs","flashbridge","flashutils","clipboard",{name:"colorsupport",requires:["overlay"]},{name:"colorsupport/dialog"},{name:"forecolor",requires:["colorsupport"]},{name:"bgcolor",requires:["colorsupport"]},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},
{name:"flash",requires:["flash/support"]},{name:"flash/dialog"},{name:"flash/support",requires:["flashutils","contextmenu","fakeobjects","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor"},{name:"image",requires:["contextmenu","bubbleview"]},{name:"image/dialog",requires:["tabs"]},"indent","justify",{name:"link",requires:["bubbleview"]},{name:"link/dialog"},"list","maximize",{name:"music",requires:["flash/support"]},{name:"music/dialog",requires:["flash/dialog"]},
"preview","removeformat",{name:"smiley"},{name:"sourcearea",requires:["sourcearea/support"]},{name:"table",requires:["contextmenu"]},{name:"table/dialog"},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],n,f,h,e,k={};n=0;for(f=v.length;n<f;n++){h=v[n];if(p.isString(h))h=v[n]={name:h+"",requires:null};e=h.requires||[];var x=["button"];h.name.indexOf("/dialog")!=-1&&x.push("overlay");h.requires=e.concat(x)}v=[{name:"localStorage",requires:["flashutils","flashbridge"]},
{name:"button"},{name:"dd"},{name:"progressbar"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(v);n=0;for(f=v.length;n<f;n++){h=v[n];e=h.name;k[e]={attach:A,charset:"utf-8",requires:h.requires,csspath:h.useCss?H("plugins/"+e+"/plugin.css"):z,path:H("plugins/"+e+"/plugin.js")}}C.add(k);p.Editor=C;p.Editor=C});
KISSY.Editor.add("utils",function(p){var z=null,C=KISSY,H=C.Node,w=C.DOM,u=C.UA,A=C.Event,v;v=u.ie?document.documentMode||u.ie:void 0;var n={debugUrl:function(f){var h=C.Config.debug;f=h?h==="dev"?"../src/"+f:f:f.replace(/\.(js|css)/i,"-min.$1");f+=f.indexOf("?")!=-1?"&":"?";f+="t="+encodeURIComponent("2010-11-17 20:35:10");return f},lazyRun:function(f,h,e){var k=f[h],x=f[e];f[h]=function(){k.apply(this,arguments);f[h]=f[e];return x.apply(this,arguments)}},getXY:function(f,h,e,k){e=e.defaultView||
e.parentWindow;f-=w.scrollLeft(e);h-=w.scrollTop(e);if(k)if(e!=(k.defaultView||k.parentWindow)&&e.frameElement){k=w._4e_getOffset(e.frameElement,k);f+=k.left;h+=k.top}return{left:f,top:h}},tryThese:function(){for(var f,h=0,e=arguments.length;h<e;h++){var k=arguments[h];try{f=k();break}catch(x){}}return f},arrayCompare:function(f,h){if(!f&&!h)return true;if(!f||!h||f.length!=h.length)return false;for(var e=0;e<f.length;e++)if(f[e]!==h[e])return false;return true},getByAddress:function(f,h,e){f=f.documentElement;
for(var k=0;f&&k<h.length;k++){var x=h[k];if(e)for(var j=-1,a=0;a<f.childNodes.length;a++){var b=f.childNodes[a];if(!(e===true&&b.nodeType==3&&b.previousSibling&&b.previousSibling.nodeType==3)){j++;if(j==x){f=b;break}}}else f=f.childNodes[x]}return f?new H(f):z},clearAllMarkers:function(f){for(var h in f)f[h]._4e_clearMarkers(f,true)},htmlEncodeAttr:function(f){return f.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(f){return f.replace(/^\s+/,"")},rtrim:function(f){return f.replace(/\s+$/,
"")},trim:function(f){return this.ltrim(this.rtrim(f))},mix:function(){for(var f={},h=0;h<arguments.length;h++)f=C.mix(f,arguments[h]);return f},isCustomDomain:function(){if(!u.ie)return false;var f=document.domain,h=window.location.hostname;return f!=h&&f!="["+h+"]"},duplicateStr:function(f,h){return Array(h+1).join(f)},throttle:function(f,h,e){e=e||150;if(e===-1)return function(){f.apply(h,arguments)};var k=(new Date).getTime();return function(){var x=(new Date).getTime();if(x-k>e){k=x;f.apply(h,
arguments)}}},buffer:function(f,h,e){e=e||0;var k=z;return function(){k&&clearTimeout(k);var x=arguments;k=setTimeout(function(){return f.apply(h,x)},e)}},isNumber:function(f){return/^\d+(.\d+)?$/.test(C.trim(f))},verifyInputs:function(f){for(var h=0;h<f.length;h++){var e=w._4e_wrap(f[h]),k=C.trim(e.val()),x=e.attr("data-verify");e=e.attr("data-warning");if(x&&!RegExp(x).test(k)){alert(e);return false}}return true},sourceDisable:function(f,h){f.on("sourcemode",h.disable,h);f.on("wysiwygmode",h.enable,
h)},resetInput:function(f){var h=f.attr("placeholder");if(h&&!u.webkit){f.addClass("ke-input-tip");f.val(h)}else u.webkit&&f.val("")},valInput:function(f,h){f.removeClass("ke-input-tip");f.val(h)},placeholder:function(f,h){f.attr("placeholder",h);if(!u.webkit){f.on("blur",function(){if(!C.trim(f.val())){f.addClass("ke-input-tip");f.val(h)}});f.on("focus",function(){f.removeClass("ke-input-tip");C.trim(f.val())==h&&f.val("")})}},clean:function(f){f=f[0]||f;for(var h=C.makeArray(f.childNodes),e=0;e<
h.length;e++){var k=h[e];k.nodeType==p.NODE.NODE_TEXT&&!C.trim(k.nodeValue)&&f.removeChild(k)}},htmlEncode:function(f){return!f?f:String(f).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(f){return!f?f:String(f).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(f,h){return f.toLowerCase()==h.toLowerCase()},normParams:function(f){f=C.clone(f);for(var h in f)if(f.hasOwnProperty(h)){var e=
f[h];if(C.isFunction(e))f[h]=e()}return f},doFormUpload:function(f,h,e){function k(){var y={responseText:"",responseXML:z};y.argument=f?f.argument:z;try{var r;if((r=u.ie?j.contentWindow.document:j.contentDocument||window.frames[x].document)&&r.body)y.responseText=r.body.innerHTML;y.responseXML=r&&r.XMLDocument?r.XMLDocument:r}catch(l){C.log(l)}A.remove(j,"load",k);f.callback&&f.callback(y);setTimeout(function(){w._4e_remove(j)},100)}var x=C.guid("form-upload-"),j=document.createElement("iframe");
j.id=x;j.name=x;j.className="ke-hidden";var a="document.open();"+(n.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(u.ie)j.src=u.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";C.log("doFormUpload : "+j.src);document.body.appendChild(j);if(u.ie)document.frames[x].name=x;a=w._4e_unwrap(f.form);var b={target:a.target,method:a.method,encoding:a.encoding,enctype:a.enctype,action:a.action};a.target=x;a.method="POST";a.enctype=a.encoding="multipart/form-data";
if(e)a.action=e;var d;if(h){d=[];h=p.Utils.normParams(h);for(var m in h)if(h.hasOwnProperty(m)){e=document.createElement("input");e.type="hidden";e.name=m;e.value=h[m];a.appendChild(e);d.push(e)}}A.on(j,"load",k);a.submit();a.target=b.target;a.method=b.method;a.enctype=b.enctype;a.encoding=b.encoding;a.action=b.action;if(d){h=0;for(m=d.length;h<m;h++)w._4e_remove(d[h])}return j},extern:function(f,h){for(var e in h)f[e]=h[e]},map:function(f,h){for(var e=0;e<f.length;e++)f[e]=h(f[e]);return f},ieEngine:v};
p.Utils=n;p.Utils=n;n.extern(n,{debugUrl:n.debugUrl,lazyRun:n.lazyRun,getXY:n.getXY,tryThese:n.tryThese,arrayCompare:n.arrayCompare,getByAddress:n.getByAddress,clearAllMarkers:n.clearAllMarkers,htmlEncodeAttr:n.htmlEncodeAttr,ltrim:n.ltrim,rtrim:n.rtrim,trim:n.trim,mix:n.mix,isCustomDomain:n.isCustomDomain,duplicateStr:n.duplicateStr,buffer:n.buffer,isNumber:n.isNumber,verifyInputs:n.verifyInputs,sourceDisable:n.sourceDisable,resetInput:n.resetInput,placeholder:n.placeholder,clean:n.clean,htmlEncode:n.htmlEncode,
htmlDecode:n.htmlDecode,equalsIgnoreCase:n.equalsIgnoreCase,normParams:n.normParams,throttle:n.throttle,doFormUpload:n.doFormUpload,map:n.map})});
KISSY.Editor.add("focusmanager",function(p){function z(){this.iframeFocus=n;v=this}function C(){this.iframeFocus=f;v=h}var H=KISSY,w=H.DOM,u=H.Event,A={},v;H={refreshAll:function(){for(var e in A){var k=A[e];k.document.designMode="off";k.document.designMode="on"}},currentInstance:function(){return v},getInstance:function(e){return A[e]},add:function(e){var k=w._4e_getWin(e.document);u.on(k,"focus",z,e);u.on(k,"blur",C,e)},register:function(e){A[e._UUID]=e},remove:function(e){delete A[e._UUID];var k=
w._4e_getWin(e.document);u.remove(k,"focus",z,e);u.remove(k,"blur",C,e)}};var n=true,f=false,h=null;p.focusManager=H;p.focusManager=H;p.getInstances=function(){return A};p.getInstances=p.getInstances});
KISSY.Editor.add("definition",function(p){var z=true,C=false,H=document,w=KISSY,u=w.UA,A=w.DOM,v=w.Node,n=w.Event,f=p.focusManager,h=p.Utils.tryThese,e=p.Utils.debugUrl("theme/editor-iframe.css"),k=1,x="document.open();"+(p.Utils.isCustomDomain()?'document.domain="'+H.domain+'";':"")+"document.close();",j="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(u.ie?"javascript:void(function(){"+encodeURIComponent(x)+"}())":"")+'"  tabIndex="'+(u.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";p.SOURCE_MODE=0;p.WYSIWYG_MODE=1;p.SOURCE_MODE=p.SOURCE_MODE;p.WYSIWYG_MODE=p.WYSIWYG_MODE;w.augment(p,{init:function(a){if(u.ie)A.addClass(H.body,"ie"+u.ie);else if(u.gecko)A.addClass(H.body,"gecko");else u.webkit&&A.addClass(H.body,"webkit");var b=this,d=new v(j.replace(/\$\(tabIndex\)/,
a.attr("tabIndex")));d.on("mousedown",function(r){if(u.webkit){var l=A._4e_name(r.target);if(l=="select"||l=="option")return z}r.halt()});a.on("mousedown",function(r){r.stopPropagation()});b.editorWrap=d;b._UUID=k++;f.register(b);b.wrap=d.one(".ke-textarea-wrap");b.wrap=b.wrap;b.iframe=b.wrap.one("iframe");b.iframe=b.iframe;b.toolBarDiv=d.one(".ke-editor-tools");b.toolBarDiv=b.toolBarDiv;b.textarea=a;b.textarea=b.textarea;b.statusDiv=d.one(".ke-editor-status");b.statusDiv=b.statusDiv;b.toolBarDiv._4e_unselectable();
b._commands={};b._dialogs={};var m=a._4e_style("width"),y=a._4e_style("height");if(m){d.css("width",m);a.css("width","100%")}b.textarea.css("display","none");d.insertAfter(a);b.wrap[0].appendChild(a[0]);if(y){b.wrap.css("height",y);a.css("height","100%")}d=b.iframe;b.on("dataReady",function(){b._ready=z;p.fire("instanceCreated",{editor:b})});u.gecko?d.on("load",b._setUpIFrame,b):b._setUpIFrame();b.cfg.attachForm&&a[0].form&&b._attachForm()},_attachForm:function(){(new v(this.textarea[0].form)).on("submit",
this.sync,this)},useDialog:function(a,b){var d=this,m=p.SimpleOverlay;m.loading();d.use(a,function(){var y=d.getDialog(a);b(y);m.unloading()})},addDialog:function(a,b){this._dialogs[a]=b},getDialog:function(a){return this._dialogs[a]},addPlugin:function(a){this.ready(a)},addCommand:function(a,b){this._commands[a]=b},hasCommand:function(a){return this._commands[a]},execCommand:function(a){var b=this._commands[a],d=w.makeArray(arguments);d.shift();d.unshift(this);return b.exec.apply(b,d)},getMode:function(){return this.textarea.css("display")==
"none"?p.WYSIWYG_MODE:p.SOURCE_MODE},getData:function(a){var b;b=this.getMode()==p.WYSIWYG_MODE?this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)b=a?this.htmlDataProcessor.toHtml(b,"p"):this.htmlDataProcessor.toServer(b,"p");b=w.trim(b);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(b))b="";return b},setData:function(a){var b=a;if(this.htmlDataProcessor)b=this.htmlDataProcessor.toDataFormat(a,"p");this.document.body.innerHTML=b;this.getMode()!=p.WYSIWYG_MODE&&this.textarea.val(a)},sync:function(){this.textarea.val(this.getData())},
baseZIndex:function(a){a=a||0;return a+(this.cfg.baseZIndex||0)},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(a){this.document.body.innerHTML=a},_prepareIFrameHtml:function(a){var b=this.cfg,d=b.customLink,m="";if(d)for(var y=0;y<d.length;y++)m+='<link href="'+d[y]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+p.Config.base+e+"' rel='stylesheet'/><style>"+(b.customStyle||"")+"</style>"+m+"</head><body class='ke-editor'>&nbsp;"+
(a?'<script id="ke_actscript" type="text/javascript">'+(p.Utils.isCustomDomain()?'document.domain="'+H.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':"")+"</body></html>"},getSelection:function(){return p.Selection.getSelection(this.document)},focus:function(){var a=this.document,b=A._4e_getWin(a);u.webkit&&b&&b.parent&&b.parent.focus();b&&b.focus();a&&a.body.focus();this.notifySelectionChange()},blur:function(){A._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},
addCustomStyle:function(a){var b=this.cfg,d=this.document;b.customStyle=b.customStyle||"";b.customStyle+="\n"+a;b=d.createElement("style");d.getElementsByTagName("head")[0].appendChild(b);if(b.styleSheet)b.styleSheet.cssText=a;else b.appendChild(d.createTextNode(a))},addCustomLink:function(a){var b=this.cfg,d=this.document;b.customLink=b.customLink||[];b.customLink.push(a);b=d.createElement("link");b.rel="stylesheet";d.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=
this.cfg,d=w.makeArray(this.document.getElementsByTagName("link")),m=0;m<d.length;m++)d[m].href==a&&A._4e_remove(d[m]);b.customLink=b.customLink||[];b=b.customLink;a=w.indexOf(a,b);a!=-1&&b.splice(a,1)},_setUpIFrame:function(){function a(){r=y.document;b.document=r;d.detach();r.open("text/html","replace");r.write(m);r.close()}var b=this,d=b.iframe,m=b._prepareIFrameHtml(b._UUID),y=d[0].contentWindow,r;try{r=y.document}catch(l){d[0].src=d[0].src;if(u.ie<7){setTimeout(a,10);return}}a()},ready:function(a){this._ready?
a():this.on("dataReady",a)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var d=b.getStartElement(),m=new p.ElementPath(d);if(!a.previousPath||!a.previousPath.compare(m)){a.previousPath=m;a.fire("selectionChange",{selection:b,path:m,element:d})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(a,b){var d=this;d.focus();var m=a._4e_name(),y=
p.XHTML_DTD,r=p.RANGE,l=p.NODE,i=y.$block[m],B=d.getSelection(),J=B&&B.getRanges(),t,c,g,q,s;if(!J||J.length==0){var o=arguments,D=o.callee;setTimeout(function(){D.apply(d,o)},30)}else{d.fire("save");for(var O=J.length-1;O>=0;O--){t=J[O];t.deleteContents();c=!O&&a||a._4e_clone(z);b&&b(c);if(i)for(;(q=t.getCommonAncestor(C,z))&&(s=y[q._4e_name()])&&!(s&&s[m]);)if(q._4e_name()in y.span)t.splitElement(q);else if(t.checkStartOfBlock()&&t.checkEndOfBlock()){t.setStartBefore(q);t.collapse(z);q._4e_remove()}else t.splitBlock();
t.insertNode(c);g||(g=c)}if(g){m=g._4e_nextSourceNode(z);y=d.document;s=p.XHTML_DTD;if(s.$inline[c._4e_name()]){m=new v(y.createTextNode(" "));m.insertAfter(g)}else if(m){if(m._4e_name()=="br"&&s[m.parent()._4e_name()].p){s=new v("<p>&nbsp;</p>",null,y);m[0].parentNode.replaceChild(s[0],m[0]);m=s}}else{s=new v("<p>&nbsp;</p>",null,y);s.insertAfter(g);m=s}t.moveToPosition(g,r.POSITION_AFTER_END);m&&m[0].nodeType==l.NODE_ELEMENT&&t.moveToElementEditablePosition(m);B.selectRanges([t]);d.focus();c&&c._4e_scrollIntoView();
setTimeout(function(){d.fire("save")},10);return c}}},insertHtml:function(a){var b=this;if(b.htmlDataProcessor)a=b.htmlDataProcessor.toDataFormat(a);if(u.webkit){var d=A.create(a,null,this.document);d=d.nodeType==11?w.makeArray(d.childNodes):[d];for(var m=0;m<d.length;m++)b.insertElement(new v(d[m]))}else{b.focus();m=(d=b.getSelection())&&d.getRanges();if(!m||m.length==0){var y=arguments,r=y.callee;setTimeout(function(){r.apply(b,y)},30)}else{b.fire("save");if(u.ie){d=d.getNative();d.type=="Control"&&
d.clear();d.createRange().pasteHTML(a)}else b.document.execCommand("inserthtml",C,a);b.focus();setTimeout(function(){b.fire("save")},10)}}}});p._initIFrame=function(a){function b(c){h(function(){y.designMode="on";setTimeout(function(){y.designMode="off";i.focus();if(!arguments.callee.retry)arguments.callee.retry=z},50)},function(){y.designMode="off";A.attr(i,"contentEditable",C);A.attr(i,"contentEditable",z);!c&&b(1)})}var d=f.getInstance(a);a=d.textarea[0];var m=d.iframe[0].contentWindow,y=d.document,
r=d.cfg,l=y.getElementById("ke_actscript");A._4e_remove(l);var i=y.body;if(u.ie){i.hideFocus=z;i.disabled=z;i.contentEditable=z;i.removeAttribute("disabled")}else setTimeout(function(){if(u.gecko||u.opera)i.contentEditable=z;else if(u.webkit)i.parentNode.contentEditable=z;else y.designMode="on"},0);if(u.webkit){n.on(y,"click",function(c){var g=new v(c.target);w.inArray(g._4e_name(),["input","select"])&&c.preventDefault()});n.on(y,"mouseup",function(c){var g=new v(c.target);w.inArray(g._4e_name(),
["input","textarea"])&&c.preventDefault()})}if(u.gecko||u.ie||u.opera){var B;B=new v(A.insertAfter((new v('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],a));B.on("focus",function(){d.focus()});d.activateGecko=function(){u.gecko&&d.iframeFocus&&B[0].focus()};d.on("destroy",function(){})}if(u.ie&&y.compatMode=="CSS1Compat"||u.gecko||u.opera){var J=new v(y.documentElement);J.on("mousedown",function(c){if(c.target==J[0]){u.gecko&&b(C);B[0].focus()}})}n.on(m,
"focus",function(){if(u.gecko)b(C);else u.opera&&i.focus();d.notifySelectionChange()});u.gecko&&n.on(d.document,"mousedown",function(){d.iframeFocus||b(C)});if(u.ie){n.on(y,"keydown",function(c){if(c.keyCode in{8:1,46:1}){var g=d.getSelection(),q=g.getSelectedElement();if(q){d.fire("save");var s=g.getRanges()[0].createBookmark();q._4e_remove();g.selectBookmarks([s]);d.fire("save");c.preventDefault()}}});if(y.compatMode=="CSS1Compat"){var t={33:1,34:1};n.on(y,"keydown",function(c){c.keyCode in t&&
setTimeout(function(){d.getSelection().scrollIntoView()},0)})}}setTimeout(function(){u.ie&&setTimeout(function(){if(y){i.runtimeStyle.marginBottom="0px";i.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){d.fire("dataReady");var c=r.disableObjectResizing,g=r.disableInlineTableEditing;if(c||g)try{y.execCommand("enableObjectResizing",C,!c);y.execCommand("enableInlineTableEditing",C,!g)}catch(q){n.on(i,u.ie?"resizestart":"resize",function(s){if(c||A._4e_name(s.target)==="table"&&g)s.preventDefault()})}},
10);u.webkit&&n.on(y,"mousedown",function(c){c=new v(c.target);w.inArray(c._4e_name(),["img","hr","input","textarea","select"])&&d.getSelection().selectElement(c)});u.gecko&&n.on(y,"dragstart",function(c){var g=new v(c.target);g._4e_name()==="img"&&/ke_/.test(g[0].className)&&c.preventDefault()});f.add(d)};x=p.prototype;p.Utils.extern(x,{setData:x.setData,getData:x.getData,insertElement:x.insertElement,insertHtml:x.insertHtml,ready:x.ready,addCustomStyle:x.addCustomStyle,addCommand:x.addCommand,hasCommand:x.hasCommand,
execCommand:x.execCommand,addPlugin:x.addPlugin,useDialog:x.useDialog,addDialog:x.addDialog,getDialog:x.getDialog,getMode:x.getMode,sync:x.sync,baseZIndex:x.baseZIndex,getSelection:x.getSelection,focus:x.focus,blur:x.blur,notifySelectionChange:x.notifySelectionChange})});
KISSY.Editor.add("zindex",function(){var p=KISSY.Editor;if(!p.zIndexManager){p.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};p.baseZIndex=function(z){var C=z,H=p.getInstances(),w;for(w in H){if(!H.hasOwnProperty(w))return;C=Math.max(C,H[w].baseZIndex(z))}return C};p.baseZIndex=p.baseZIndex;p.zIndexManager=p.zIndexManager}});
KISSY.Editor.add("dtd",function(p){p.XHTML_DTD=function(){function z(l){for(var i=arguments.length-1;i>0;)KISSY.mix(l,arguments[i--]);return l}var C={isindex:1,fieldset:1},H={input:1,button:1,select:1,textarea:1,label:1},w=z({a:1},H),u=z({iframe:1},w),A={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},v={ins:1,del:1,script:1,style:1},n=z({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},v),f=z({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},n),h=z({p:1},f);H=z({iframe:1},f,H);f={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var e=z({a:1},H),k={tr:1},x={"#":1},j=z({param:1},f),a=z({form:1},C,u,A,h),b={li:1},d={base:1,link:1,meta:1,title:1},m=z(d,{style:1,script:1}),y={head:1,body:1},r={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:z({html:1},y,d),$block:r,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:e,$body:z({script:1,style:1},r),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:y,head:m,style:x,body:a,base:{},link:{},meta:{},title:x,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:e,button:z(h,A),basefont:{},h5:e,h4:e,samp:e,h6:e,ol:b,h1:e,h3:e,option:x,h2:e,form:z(C,u,A,h),select:{optgroup:1,option:1},font:e,ins:e,menu:b,abbr:e,label:e,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:e,script:x,tfoot:k,cite:e,li:a,input:{},iframe:a,strong:e,textarea:x,noframes:a,big:e,small:e,span:e,hr:{},dt:e,sub:e,optgroup:{option:1},param:{},bdo:e,"var":e,div:a,object:j,sup:e,dd:a,strike:e,area:{},dir:b,map:z({area:1,form:1,p:1},C,v,A),applet:j,dl:{dt:1,dd:1},del:e,isindex:{},fieldset:z({legend:1},f),thead:k,ul:b,acronym:e,b:e,a:H,blockquote:a,caption:e,i:e,u:e,tbody:k,s:e,address:z(u,h),tt:e,legend:e,q:e,pre:z(n,w),p:e,em:e,dfn:e}}();p.XHTML_DTD=
p.XHTML_DTD});
KISSY.Editor.add("dom",function(p){function z(a){return a.replace(/-(\w)/g,function(b,d){return d.toUpperCase()})}var C=KISSY,H=C.DOM,w=C.UA,u=C.Node,A=p.Utils,v={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};p.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};p.NODE=p.NODE;p.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};p.POSITION=p.POSITION;var n=p.NODE,f=p.POSITION,h={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},e={hr:1},k=function(a){return a[0]||a},x=function(a){if(a&&!a[0])return new u(a);return a},j={_4e_wrap:x,_4e_unwrap:k,_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=k(a);b=k(b);
return a===b},_4e_isBlockBoundary:function(a,b){a=x(a);var d=C.mix(C.mix({},e),b||{});return h[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=k(a);for(var b=a.parentNode.childNodes,d=0;d<b.length;d++)if(b[d]===a)return d;return-1},_4e_first:function(a,b){a=k(a);var d=a.firstChild;if((d=d&&new u(d))&&b&&!b(d))d=d._4e_next(b);return d},_4e_move:function(a,b,d){a=k(a);H._4e_remove(a);
b=k(b);d?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_name:function(a){a=k(a);var b=a.nodeName.toLowerCase();if(w.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var d=a[0].attributes,m=b[0].attributes,y=d.length,r=m.length;if(y!=r)return false;for(var l=0;l<y;l++){var i=d[l],B=i.name;if(i.specified&&a.attr(B)!=b.attr(B))return false}if(A.ieEngine<8)for(l=0;l<r;l++){i=m[l];B=i.name;if(i.specified&&
a.attr(B)!=b.attr(B))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=k(a).childNodes;for(var b=0,d=a.length;b<d;b++){var m=a[b],y=m.nodeType;if(!(y==n.NODE_ELEMENT&&m.getAttribute("_ke_bookmark")))if(y==n.NODE_ELEMENT&&!j._4e_isEmptyInlineRemoveable(m)||y==n.NODE_TEXT&&C.trim(m.nodeValue))return false}return true},_4e_moveChildren:function(a,b,d){a=k(a);b=b[0]||b;if(a!=b)if(d)for(;d=a.lastChild;)b.insertBefore(a.removeChild(d),b.firstChild);else for(;d=a.firstChild;)b.appendChild(a.removeChild(d))},
_4e_mergeSiblings:function(){function a(b,d,m){if(d[0]&&d[0].nodeType==n.NODE_ELEMENT){for(var y=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){y.push(d);d=m?new u(d[0].nextSibling):new u(d[0].previousSibling);if(!d[0]||d[0].nodeType!=n.NODE_ELEMENT)return}if(b._4e_isIdentical(d)){for(var r=m?b[0].lastChild:b[0].firstChild;y.length;)y.shift()._4e_move(b,!m);d._4e_moveChildren(b,!m);d._4e_remove();r[0]&&r[0].nodeType==n.NODE_ELEMENT&&r._4e_mergeSiblings()}}}return function(b){if(b[0])if(v[b._4e_name()]||
b._4e_name()=="a"){a(b,new u(b[0].nextSibling),true);a(b,new u(b[0].previousSibling))}}}(),_4e_unselectable:w.gecko?function(a){a=k(a);a.style.MozUserSelect="none"}:w.webkit?function(a){a=k(a);a.style.KhtmlUserSelect="none"}:function(a){a=k(a);if(w.ie||w.opera){var b,d=0;for(a.unselectable="on";b=a.all[d++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable="on"}}},_4e_getOffset:function(a,b){a=k(a);var d,m=0;d=0;var y=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,r=a.ownerDocument,l=r.documentElement;b=b||r;if(a.getBoundingClientRect){if(a!==r.body&&l!==a){d=a.getBoundingClientRect();m=d.left+(b===r?H.scrollLeft(y):0);d=d.top+(b===r?H.scrollTop(y):0)}if(b)if(y!=(b.defaultView||b.parentWindow)&&y.frameElement){y=j._4e_getOffset(y.frameElement,b);m+=y.left;d+=y.top}}return{left:m,top:d}},_4e_getFrameDocument:function(a){return(a=k(a))&&a.contentWindow.document},_4e_splitText:function(a,b){a=k(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=
n.NODE_TEXT)){if(w.ie&&b==a.nodeValue.length){var m=d.createTextNode("");H.insertAfter(m,a);return new u(m)}m=new u(a.splitText(b));if(d.documentMode){d=d.createTextNode("");H.insertAfter(d,m[0]);H._4e_remove(d)}return m}},_4e_parents:function(a,b){a=x(a);var d=[];do d[b?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,b,d){a=k(a);a=a.cloneNode(b);if(!d){var m=function(y){if(y.nodeType==n.NODE_ELEMENT){y.removeAttribute("id");y=y.childNodes;for(var r=0;r<y.length;r++)m(y[r])}};
m(a)}return new u(a)},_4e_nextSourceNode:function(a,b,d,m){a=k(a);if(m&&!m.call){var y=m[0]||m;m=function(l){l=l[0]||l;return l!==y}}b=!b&&a.firstChild;var r=new u(a);if(!b){if(a.nodeType==n.NODE_ELEMENT&&m&&m(a,true)===false)return null;b=a.nextSibling}for(;!b&&(r=r.parent());){if(m&&m(r,true)===false)return null;b=r[0].nextSibling}if(!b)return null;b=H._4e_wrap(b);if(m&&m(b)===false)return null;if(d&&d!=b[0].nodeType)return b._4e_nextSourceNode(false,d,m);return b},_4e_previousSourceNode:function(a,
b,d,m){a=k(a);if(m&&!m.call){var y=m[0]||m;m=function(l){l=l[0]||l;return l!==y}}b=!b&&a.lastChild;var r=new u(a);if(!b){if(a.nodeType==n.NODE_ELEMENT&&m&&m(a,true)===false)return null;b=a.previousSibling}for(;!b&&(r=r.parent());){if(m&&m(r,true)===false)return null;b=r[0].previousSibling}if(!b)return null;b=H._4e_wrap(b);if(m&&m(b)===false)return null;if(d&&b[0].nodeType!=d)return b._4e_previousSourceNode(false,d,m);return b},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=
n.NODE_TEXT&&b.contains(a))return b;var d=a[0].nodeType==n.NODE_TEXT?a.parent():a;do if(d[0].nodeType!=n.NODE_TEXT&&d.contains(b))return d;while(d=d.parent());return null},_4e_ascendant:function(a,b,d){a=k(a);if(!d)a=a.parentNode;if(b&&!C.isFunction(b)){var m=b;b=function(y){return y._4e_name()==m}}for(;a&&a.nodeType!=9;){if(!b||b(new u(a))===true)return new u(a);a=a.parentNode}return null},_4e_hasAttribute:A.ieEngine<9?function(a,b){a=k(a);var d=a.attributes[b];return!!(d&&d.specified)}:function(a,
b){a=k(a);return a.hasAttribute(b)},_4e_hasAttributes:A.ieEngine<9?function(a){a=k(a);for(var b=a.attributes,d=0;d<b.length;d++){var m=b[d];switch(m.name){case "class":if(a.getAttribute("class"))return true;break;default:if(m.specified)return true}}return false}:function(a){a=k(a);w.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,b){var d=k(a),m=k(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(m);if(d==m)return f.POSITION_IDENTICAL;if(d.nodeType==
n.NODE_ELEMENT&&m.nodeType==n.NODE_ELEMENT){if(d.contains){if(d.contains(m))return f.POSITION_CONTAINS+f.POSITION_PRECEDING;if(m.contains(d))return f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING}if("sourceIndex"in d)return d.sourceIndex<0||m.sourceIndex<0?f.POSITION_DISCONNECTED:d.sourceIndex<m.sourceIndex?f.POSITION_PRECEDING:f.POSITION_FOLLOWING}d=a._4e_address();m=b._4e_address();for(var y=Math.min(d.length,m.length),r=0;r<=y-1;r++)if(d[r]!=m[r]){if(r<y)return d[r]<m[r]?f.POSITION_PRECEDING:f.POSITION_FOLLOWING;
break}return d.length<m.length?f.POSITION_CONTAINS+f.POSITION_PRECEDING:f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING},_4e_address:function(a,b){a=k(a);for(var d=[],m=a.ownerDocument.documentElement,y=a;y&&y!=m;){var r=y.parentNode,l=-1;if(r){for(var i=0;i<r.childNodes.length;i++){var B=r.childNodes[i];if(!(b&&B.nodeType==3&&B.previousSibling&&B.previousSibling.nodeType==3)){l++;if(B==y)break}}d.unshift(l)}y=r}return d},_4e_breakParent:function(a,b){var d=new p.Range(a[0].ownerDocument);d.setStartAfter(a);
d.setEndAfter(b);var m=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(m,a[0].nextSibling)},_4e_style:function(a,b,d){a=x(a);if(d!==undefined)return a.css(b,d);a=k(a);return a.style[z(b)]},_4e_remove:function(a,b){var d=k(a),m=d.parentNode;if(m){if(b)for(var y;y=d.firstChild;)m.insertBefore(d.removeChild(y),d);m.removeChild(d)}return a},_4e_trim:function(a){H._4e_ltrim(a);H._4e_rtrim(a)},_4e_ltrim:function(a){a=k(a);for(var b;b=a.firstChild;){if(b.nodeType==n.NODE_TEXT){var d=
A.ltrim(b.nodeValue),m=b.nodeValue.length;if(d){if(d.length<m){(new u(b))._4e_splitText(m-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=k(a);for(var b;b=a.lastChild;){if(b.type==n.NODE_TEXT){var d=A.rtrim(b.nodeValue),m=b.nodeValue.length;if(d){if(d.length<m){(new u(b))._4e_splitText(d.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!w.ie&&!w.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&
b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=k(a);for(var b=a.lastChild;b&&b.nodeType==n.NODE_TEXT&&!C.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==n.NODE_TEXT||H._4e_name(b)!=="br"){b=w.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");w.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){var d=k(a),m;do m=(d=d.previousSibling)&&new u(d);while(m&&b&&!b(m));return m},_4e_last:function(a,b){a=H._4e_wrap(a);var d=a[0].lastChild;
if((d=d&&new u(d))&&b&&!b(d))d=d._4e_previous(b);return d},_4e_next:function(a,b){var d=k(a),m;do m=(d=d.nextSibling)&&new u(d);while(m&&b&&!b(m));return m},_4e_outerHtml:function(a){a=k(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,d,m){a=H._4e_wrap(a);var y=a.data("list_marker_id")||a.data("list_marker_id",C.guid()).data("list_marker_id"),r=a.data("list_marker_names")||
a.data("list_marker_names",{}).data("list_marker_names");b[y]=a;r[d]=1;return a.data(d,m)},_4e_clearMarkers:function(a,b,d){a=x(a);var m=a.data("list_marker_names"),y=a.data("list_marker_id"),r;for(r in m)a.removeData(r);a.removeData("list_marker_names");if(d){a.removeData("list_marker_id");delete b[y]}},_4e_copyAttributes:function(a,b,d){a=k(a);b=x(b);var m=a.attributes;d=d||{};for(var y=0;y<m.length;y++){var r=m[y],l=r.name.toLowerCase(),i;if(!(l in d))if(l=="checked"&&(i=H.attr(a,l)))b.attr(l,
i);else if(r.specified||w.ie&&r.value&&l=="value"){i=H.attr(a,l);if(i===null)i=r.nodeValue;b.attr(l,i)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=H._4e_name(a);var b=p.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=x(a);var b=a[0].ownerDocument,d=H.scrollLeft(b),m=H.scrollTop(b),y=a.offset(),r=y.left;y=y.top;if(H.viewportHeight(b)+m<y||y<m||H.viewportWidth(b)+d<r||r<d)a.scrollIntoView(b)},_4e_getElementsByTagName:function(a,
b,d){a=k(a);if(!w.ie&&d)b=d+":"+b;d=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)d.push(new u(a[b]));return d}};C.DOM._4e_inject=function(a){C.mix(H,a);for(var b in a)a.hasOwnProperty(b)&&function(d){u.prototype[d]=function(){var m=[].slice.call(arguments,0);m.unshift(this);return a[d].apply(null,m)}}(b)};A.extern(j,{_4e_wrap:j._4e_wrap,_4e_unwrap:j._4e_unwrap,_4e_equals:j._4e_equals,_4e_isBlockBoundary:j._4e_isBlockBoundary,_4e_getWin:j._4e_getWin,_4e_index:j._4e_index,_4e_first:j._4e_first,
_4e_move:j._4e_move,_4e_name:j._4e_name,_4e_isIdentical:j._4e_isIdentical,_4e_isEmptyInlineRemoveable:j._4e_isEmptyInlineRemoveable,_4e_moveChildren:j._4e_moveChildren,_4e_mergeSiblings:j._4e_mergeSiblings,_4e_unselectable:j._4e_unselectable,_4e_getOffset:j._4e_getOffset,_4e_getFrameDocument:j._4e_getFrameDocument,_4e_splitText:j._4e_splitText,_4e_parents:j._4e_parents,_4e_clone:j._4e_clone,_4e_nextSourceNode:j._4e_nextSourceNode,_4e_previousSourceNode:j._4e_previousSourceNode,_4e_commonAncestor:j._4e_commonAncestor,
_4e_ascendant:j._4e_ascendant,_4e_hasAttribute:j._4e_hasAttribute,_4e_hasAttributes:j._4e_hasAttributes,_4e_position:j._4e_position,_4e_address:j._4e_address,_4e_breakParent:j._4e_breakParent,_4e_style:j._4e_style,_4e_remove:j._4e_remove,_4e_trim:j._4e_trim,_4e_ltrim:j._4e_ltrim,_4e_rtrim:j._4e_rtrim,_4e_appendBogus:j._4e_appendBogus,_4e_last:j._4e_last,_4e_previous:j._4e_previous,_4e_next:j._4e_next,_4e_outerHtml:j._4e_outerHtml,_4e_setMarker:j._4e_setMarker,_4e_clearMarkers:j._4e_clearMarkers,_4e_getUniqueId:j._4e_getUniqueId,
_4e_copyAttributes:j._4e_copyAttributes,_4e_isEditable:j._4e_isEditable,_4e_scrollIntoView:j._4e_scrollIntoView,_4e_getElementsByTagName:j._4e_getElementsByTagName});H._4e_inject(j)});
KISSY.Editor.add("elementpath",function(p){function z(f){var h=u,e=u,k=[];for(f=f;f&&f[0];){if(f[0].nodeType==w.NODE_ELEMENT){if(!this.lastElement)this.lastElement=f;var x=f._4e_name();if(!e){if(!h&&A[x])h=f;if(v[x]){var j;if(j=!h){if(j=x=="div"){a:{j=f;j=j[0]||j;j=j.childNodes;for(var a=0,b=j.length;a<b;a++){var d=j[a];if(d.nodeType==w.NODE_ELEMENT&&H.$block[d.nodeName.toLowerCase()]){j=true;break a}}j=false}j=!j}j=j}if(j)h=f;else e=f}}k.push(f);if(x=="body")break}f=f.parent()}this.block=this.block=
h;this.blockLimit=this.blockLimit=e;this.elements=this.elements=k}var C=KISSY.DOM,H=p.XHTML_DTD,w=p.NODE,u=null,A={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},v={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};z.prototype={compare:function(f){var h=this.elements;f=f&&f.elements;if(!f||h.length!=f.length)return false;for(var e=0;e<h.length;e++)if(!C._4e_equals(h[e],f[e]))return false;return true},contains:function(f){for(var h=this.elements,e=0;e<
h.length;e++)if(h[e]._4e_name()in f)return h[e];return u}};p.ElementPath=p.ElementPath=z;var n=z.prototype;p.Utils.extern(n,{compare:n.compare,contains:n.contains})});
KISSY.Editor.add("walker",function(p){function z(k,x){if(this._.end)return A;var j,a=this.range,b,d=this.guard,m=this.type,y=k?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;a.trim();if(a.collapsed){this.end();return A}}if(!k&&!this._.guardLTR){var r=a.endContainer,l=new h(r[0].childNodes[a.endOffset]);this._.guardLTR=function(t,c){return(t=f._4e_wrap(t))&&t[0]&&(!c||!f._4e_equals(r,t))&&(!l[0]||!t._4e_equals(l))&&(t[0].nodeType!=n.NODE_ELEMENT||!c||t._4e_name()!="body")}}if(k&&
!this._.guardRTL){var i=a.startContainer,B=a.startOffset>0&&new h(i[0].childNodes[a.startOffset-1]);this._.guardRTL=function(t,c){return(t=f._4e_wrap(t))&&t[0]&&(!c||!t._4e_equals(i))&&(!B[0]||!t._4e_equals(B))&&(t[0].nodeType!=n.NODE_ELEMENT||!c||t._4e_name()!="body")}}var J=k?this._.guardRTL:this._.guardLTR;b=d?function(t,c){if(J(t,c)===u)return u;return d(t,c)}:J;if(this.current)j=this.current[y](u,m,b);else if(k){j=a.endContainer;if(a.endOffset>0){j=new h(j[0].childNodes[a.endOffset-1]);if(b(j)===
u)j=A}else j=b(j,w)===u?A:j._4e_previousSourceNode(w,m,b)}else{j=a.startContainer;if((j=new h(j[0].childNodes[a.startOffset]))&&j[0]){if(b(j)===u)j=A}else j=b(a.startContainer,w)===u?A:a.startContainer._4e_nextSourceNode(w,m,b)}for(;j&&j[0]&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j)!==u){if(!x)return j}else if(x&&this.evaluator)return u;j=j[y](u,m,b)}this.end();return this.current=A}function C(k){for(var x,j=A;x=z.call(this,k);)j=x;return j}function H(k){this.range=k;this._=
{}}var w=true,u=false,A=null,v=KISSY,n=p.NODE,f=v.DOM,h=v.Node;v.augment(H,{end:function(){this._.end=1},next:function(){return z.call(this)},previous:function(){return z.call(this,w)},checkForward:function(){return z.call(this,u,w)!==u},checkBackward:function(){return z.call(this,w,w)!==u},lastForward:function(){return C.call(this)},lastBackward:function(){return C.call(this,w)},reset:function(){delete this.current;this._={}}});H.blockBoundary=function(k){return function(x){x=f._4e_wrap(x);return!(x&&
x[0].nodeType==n.NODE_ELEMENT&&x._4e_isBlockBoundary(k))}};H.listItemBoundary=function(){return this.blockBoundary({br:1})};H.bookmark=function(k,x){function j(a){return a&&a[0]&&a._4e_name()=="span"&&a.attr("_ke_bookmark")}return function(a){var b,d;b=a&&a[0]&&a[0].nodeType==n.NODE_TEXT&&(d=a.parent())&&j(d);b=k?b:b||j(a);return x^b}};H.whitespaces=function(k){return function(x){x=(x=x[0]||x)&&x.nodeType==n.NODE_TEXT&&!v.trim(x.nodeValue);return k^x}};H.invisible=function(k){var x=H.whitespaces();
return function(j){j=x(j)||j[0].nodeType==n.NODE_ELEMENT&&!j[0].offsetHeight;return k^j}};p.Walker=H;p.Walker=H;var e=H.prototype;p.Utils.extern(e,{end:e.end,next:e.next,previous:e.previous,checkForward:e.checkForward,checkBackward:e.checkBackward,lastForward:e.lastForward,lastBackward:e.lastBackward,reset:e.reset});p.Utils.extern(H,{blockBoundary:H.blockBoundary,listItemBoundary:H.listItemBoundary,bookmark:H.bookmark,whitespaces:H.whitespaces,invisible:H.invisible})});
KISSY.Editor.add("range",function(p){function z(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=f;this.collapsed=v;this.document=c}function C(c){var g=c[0].nodeType!=e.NODE_TEXT&&c._4e_name()in m.$removeEmpty,q=!h.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return g||q||c}function H(c){return!B(c)&&!J(c)}function w(c){var g=n,q=j.bookmark(v);return function(s){if(q(s))return v;if(s[0].nodeType==e.NODE_TEXT){if(h.trim(s[0].nodeValue).length)return n}else if(s[0].nodeType==
e.NODE_ELEMENT)if(!i[s._4e_name()])if(!c&&!d.ie&&s._4e_name()=="br"&&!g)g=v;else return n;return v}}function u(c,g){function q(s){return s&&s.nodeName=="span"&&s.getAttribute("_ke_bookmark")}return function(s){var o,D;o=s&&!s.nodeName&&(D=s.parentNode)&&q(D);o=c?o:o||q(s);return g^o}}function A(c){return function(g){g=(g=g[0]||g)&&g.nodeType==e.NODE_TEXT&&!h.trim(g.nodeValue);return c^g}}p.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};p.RANGE=p.RANGE;var v=true,n=false,f=null,h=KISSY,e=p.NODE,k=p.RANGE,x=p.POSITION,j=p.Walker,a=h.DOM,b=p.Utils.getByAddress,d=h.UA,m=p.XHTML_DTD,y=p.ElementPath,r=h.Node,l={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};z.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return c.join("<br/>")};h.augment(z,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,g=this.startOffset;if(c[0].nodeType!=e.NODE_ELEMENT)if(g)g>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;g=this.endOffset;if(c[0].nodeType!=e.NODE_ELEMENT)if(g)g>=
c[0].nodeValue.length&&this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,g=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,k.POSITION_BEFORE_START);
g&&g._4e_name()=="span"&&g.attr("_ke_bookmark")&&this.setEndAt(g,k.POSITION_AFTER_END)},setStart:function(c,g){if(c[0].nodeType==e.NODE_ELEMENT&&l[c._4e_name()]){c=c.parent();g=c._4e_index()}this.startContainer=c;this.startOffset=g;if(!this.endContainer){this.endContainer=c;this.endOffset=g}this.updateCollapsed()},setEnd:function(c,g){if(c[0].nodeType==e.NODE_ELEMENT&&l[c._4e_name()]){c=c.parent();g=c._4e_index()+1}this.endContainer=c;this.endOffset=g;if(!this.startContainer){this.startContainer=
c;this.startOffset=g}this.updateCollapsed()},setStartAt:function(c,g){switch(g){case k.POSITION_AFTER_START:this.setStart(c,0);break;case k.POSITION_BEFORE_END:c[0].nodeType==e.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case k.POSITION_BEFORE_START:this.setStartBefore(c);break;case k.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,g){switch(g){case k.POSITION_AFTER_START:this.setEnd(c,0);break;case k.POSITION_BEFORE_END:c[0].nodeType==
e.NODE_TEXT?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case k.POSITION_BEFORE_START:this.setEndBefore(c);break;case k.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,g){var q=this.startContainer,s=this.endContainer,o=this.startOffset,D=this.endOffset,O,N=this.document,P;this.optimizeBookmark();if(s[0].nodeType==e.NODE_TEXT)s=s._4e_splitText(D);else if(s[0].childNodes.length>0)if(D>=s[0].childNodes.length){s=new r(s[0].appendChild(N.createTextNode("")));
P=v}else s=new r(s[0].childNodes[D]);if(q[0].nodeType==e.NODE_TEXT){q._4e_splitText(o);if(q._4e_equals(s))s=new r(q[0].nextSibling)}else if(o)if(o>=q[0].childNodes.length){O=new r(N.createTextNode(""));q.append(O);q=O;O=v}else q=new r(q[0].childNodes[o].previousSibling);else{O=new r(N.createTextNode(""));(o=q[0].firstChild)?a.insertBefore(O[0],o):q.append(O);q=O;O=v}o=q._4e_parents();D=s._4e_parents();var Q,U,S;for(Q=0;Q<o.length;Q++){U=o[Q];S=D[Q];if(!U._4e_equals(S))break}N=g;for(var T,V,E,K=Q;K<
o.length;K++){T=o[K];V=N&&!T._4e_equals(q)?N.appendChild(T._4e_clone()[0]):null;for(T=T[0].nextSibling;T;){if(a._4e_equals(D[K],T)||a._4e_equals(s,T))break;E=T.nextSibling;if(c==2)N.appendChild(T.cloneNode(v));else{a._4e_remove(T);c==1&&N.appendChild(T)}T=E}if(V)N=V}N=g;for(Q=Q;Q<D.length;Q++){T=D[Q];V=N&&c>0&&!T._4e_equals(s)?N.appendChild(T._4e_clone()[0]):null;if(!o[Q]||!T.parent()._4e_equals(o[Q].parent()))for(T=T[0].previousSibling;T;){if(a._4e_equals(o[Q],T)||a._4e_equals(q,T))break;E=T.previousSibling;
if(c==2)N.insertBefore(T.cloneNode(v),N.firstChild);else{a._4e_remove(T);c==1&&N.insertBefore(T,N.firstChild)}T=E}if(V)N=V}if(c==2){S=this.startContainer[0];if(S.nodeType==e.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==e.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}S=this.endContainer[0];if(S.nodeType==e.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==e.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}}else{if(U&&S&&(!q.parent()._4e_equals(U.parent())||
!s.parent()._4e_equals(S.parent()))){U=S._4e_index();O&&S.parent()._4e_equals(q.parent())&&U--;this.setStart(S.parent(),U)}this.collapse(v)}O&&q._4e_remove();P&&s[0].parentNode&&s._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=v},clone:function(){var c=new z(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;c.endContainer=
this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=e.NODE_ELEMENT||c.endContainer[0].nodeType!=e.NODE_ELEMENT)return f;var g=new p.Walker(c),q=u(v,undefined),s=A(v);c.evaluator=function(o){return s(o)&&q(o)};c=g.next();g.reset();g=g.previous();return c&&c._4e_equals(g)?c:f},shrink:function(c,g){if(!this.collapsed){c=c||k.SHRINK_TEXT;var q=this.clone(),s=this.startContainer,o=
this.endContainer,D=this.startOffset,O=this.endOffset,N=1,P=1;if(s&&s[0].nodeType==e.NODE_TEXT)if(D)if(D>=s[0].nodeValue.length)q.setStartAfter(s);else{q.setStartBefore(s);N=0}else q.setStartBefore(s);if(o&&o[0].nodeType==e.NODE_TEXT)if(O)if(O>=o[0].nodeValue.length)q.setEndAfter(o);else{q.setEndAfter(o);P=0}else q.setEndBefore(o);q=new j(q);q.evaluator=function(U){U=U[0]||U;return U.nodeType==(c==k.SHRINK_ELEMENT?e.NODE_ELEMENT:e.NODE_TEXT)};var Q;q.guard=function(U,S){U=U[0]||U;if(c==k.SHRINK_ELEMENT&&
U.nodeType==e.NODE_TEXT)return n;if(S&&U==Q)return n;if(!S&&U.nodeType==e.NODE_ELEMENT)Q=U;return v};if(N)(s=q[c==k.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(s,g?k.POSITION_AFTER_START:k.POSITION_BEFORE_START);if(P){q.reset();(q=q[c==k.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(q,g?k.POSITION_BEFORE_END:k.POSITION_AFTER_END)}return!!(N||P)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||c[0].nodeType!=e.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||
c},createBookmark2:function(c){var g=this.startContainer,q=this.endContainer,s=this.startOffset,o=this.endOffset,D,O;if(!g||!q)return{start:0,end:0};if(c){if(g[0].nodeType==e.NODE_ELEMENT)if((D=new r(g[0].childNodes[s]))&&D[0]&&D[0].nodeType==e.NODE_TEXT&&s>0&&D[0].previousSibling.nodeType==e.NODE_TEXT){g=D;s=0}for(;g[0].nodeType==e.NODE_TEXT&&(O=g._4e_previous())&&O[0].nodeType==e.NODE_TEXT;){g=O;s+=O[0].nodeValue.length}if(!this.collapsed){if(q[0].nodeType==e.NODE_ELEMENT)if((D=new r(q[0].childNodes[o]))&&
D[0]&&D[0].nodeType==e.NODE_TEXT&&o>0&&D[0].previousSibling.nodeType==e.NODE_TEXT){q=D;o=0}for(;q[0].nodeType==e.NODE_TEXT&&(O=q._4e_previous())&&O[0].nodeType==e.NODE_TEXT;){q=O;o+=O[0].nodeValue.length}}}return{start:g._4e_address(c),end:this.collapsed?f:q._4e_address(c),startOffset:s,endOffset:o,normalized:c,is2:v}},createBookmark:function(c){var g,q,s,o,D=this.collapsed;g=new r("<span>",f,this.document);g.attr("_ke_bookmark",1);g.css("display","none");g.html("&nbsp;");if(c){s=h.guid("ke_bm_");
g.attr("id",s+"S")}if(!D){q=g._4e_clone();q.html("&nbsp;");c&&q.attr("id",s+"E");o=this.clone();o.collapse();o.insertNode(q)}o=this.clone();o.collapse(v);o.insertNode(g);if(q){this.setStartAfter(g);this.setEndBefore(q)}else this.moveToPosition(g,k.POSITION_AFTER_END);return{startNode:c?s+"S":g,endNode:c?s+"E":q,serializable:c,collapsed:D}},moveToPosition:function(c,g){this.setStartAt(c,g);this.collapse(v)},trim:function(c,g){var q=this.startContainer,s=this.startOffset,o=this.collapsed;if((!c||o)&&
q[0]&&q[0].nodeType==e.NODE_TEXT){if(s)if(s>=q[0].nodeValue.length){s=q._4e_index()+1;q=q.parent()}else{var D=q._4e_splitText(s);s=q._4e_index()+1;q=q.parent();if(a._4e_equals(this.startContainer,this.endContainer))this.setEnd(D,this.endOffset-this.startOffset);else if(a._4e_equals(q,this.endContainer))this.endOffset+=1}else{s=q._4e_index();q=q.parent()}this.setStart(q,s);if(o){this.collapse(v);return}}q=this.endContainer;s=this.endOffset;if(!(g||o)&&q[0]&&q[0].nodeType==e.NODE_TEXT){if(s){s>=q.nodeValue.length||
q._4e_splitText(s);s=q._4e_index()+1}else s=q._4e_index();q=q.parent();this.setEnd(q,s)}},insertNode:function(c){this.optimizeBookmark();this.trim(n,v);var g=this.startContainer,q=g[0].childNodes[this.startOffset];q?a.insertBefore(c[0]||c,q):g[0].appendChild(c[0]||c);a._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var g=b(this.document,c.start,c.normalized),q=c.startOffset,s=c.end&&b(this.document,c.end,c.normalized);c=c.endOffset;
this.setStart(g,q);s?this.setEnd(s,c):this.collapse(v)}else{g=(q=c.serializable)?h.one("#"+c.startNode,this.document):c.startNode;c=q?h.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(g);g._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(v)}},getCommonAncestor:function(c,g){var q=this.startContainer,s=this.endContainer;q=a._4e_equals(q,s)?c&&q[0].nodeType==e.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new r(q[0].childNodes[this.startOffset]):q:q._4e_commonAncestor(s);
return g&&q[0].nodeType==e.NODE_TEXT?q.parent():q},enlarge:function(c){switch(c){case k.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var g=new r(this.document.body),q,s,o,D,O,N=n,P,Q;P=this.startContainer;Q=this.startOffset;if(P[0].nodeType==e.NODE_TEXT){if(Q){P=!h.trim(P[0].nodeValue.substring(0,Q)).length&&P;N=!!P}if(P)if(!(D=P[0].previousSibling))o=P.parent()}else{if(Q)D=P[0].childNodes[Q-1]||P[0].lastChild;D||(o=P)}for(;o||D;){if(o&&!D){if(!O&&a._4e_equals(o,c))O=v;if(!g.contains(o))break;
if(!N||o.css("display")!="inline"){N=n;if(O)q=o;else this.setStartBefore(o)}D=o[0].previousSibling}for(;D;){P=n;if(D.nodeType==e.NODE_TEXT){Q=D.nodeValue;if(/[^\s\ufeff]/.test(Q))D=f;P=/[\s\ufeff]$/.test(Q)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(N&&m.$removeEmpty[D.nodeName.toLowerCase()]){Q=a.text(D);if(/[^\s\ufeff]/.test(Q))D=f;else for(var U=D.all||D.getElementsByTagName("*"),S=0,T;T=U[S++];)if(!m.$removeEmpty[T.nodeName.toLowerCase()]){D=f;break}if(D)P=!!Q.length}else D=f;
if(P)if(N)if(O)q=o;else o&&this.setStartBefore(o);else N=v;if(D){P=D.previousSibling;if(!o&&!P){o=new r(D);D=f;break}D=P}else o=f}if(o)o=o.parent()}P=this.endContainer;Q=this.endOffset;o=D=f;O=N=n;if(P[0].nodeType==e.NODE_TEXT){P=!h.trim(P[0].nodeValue.substring(Q)).length&&P;N=!(P&&P[0].nodeValue.length);if(P)if(!(D=P[0].nextSibling))o=P.parent()}else(D=P[0].childNodes[Q])||(o=P);for(;o||D;){if(o&&!D){if(!O&&a._4e_equals(o,c))O=v;if(!g.contains(o))break;if(!N||o.css("display")!="inline"){N=n;if(O)s=
o;else o&&this.setEndAfter(o)}D=o[0].nextSibling}for(;D;){P=n;if(D.nodeType==e.NODE_TEXT){Q=D.nodeValue;if(/[^\s\ufeff]/.test(Q))D=f;P=/^[\s\ufeff]/.test(Q)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(N&&m.$removeEmpty[D.nodeName.toLowerCase()]){Q=a.text(D);if(/[^\s\ufeff]/.test(Q))D=f;else{U=D.all||D.getElementsByTagName("*");for(S=0;T=U[S++];)if(!m.$removeEmpty[T.nodeName.toLowerCase()]){D=f;break}}if(D)P=!!Q.length}else D=f;if(P)if(N)if(O)s=o;else this.setEndAfter(o);if(D){P=D.nextSibling;
if(!o&&!P){o=new r(D);D=f;break}D=P}else o=f}if(o)o=o.parent()}if(q&&s){c=q.contains(s)?s:q;this.setStartBefore(c);this.setEndAfter(c)}break;case k.ENLARGE_BLOCK_CONTENTS:case k.ENLARGE_LIST_ITEM_CONTENTS:o=new z(this.document);g=new r(this.document.body);o.setStartAt(g,k.POSITION_AFTER_START);o.setEnd(this.startContainer,this.startOffset);o=new j(o);var V,E,K=j.blockBoundary(c==k.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:f),G=function(F){var I=K(F);I||(V=F);return I};q=function(F){var I=G(F);if(!I&&F[0]&&
F._4e_name()=="br")E=F;return I};o.guard=G;o=o.lastBackward();V=V||g;this.setStartAt(V,V._4e_name()!="br"&&(!o&&this.checkStartOfBlock()||o&&V.contains(o))?k.POSITION_AFTER_START:k.POSITION_AFTER_END);o=this.clone();o.collapse();o.setEndAt(g,k.POSITION_BEFORE_END);o=new j(o);o.guard=c==k.ENLARGE_LIST_ITEM_CONTENTS?q:G;V=f;o=o.lastForward();V=V||g;this.setEndAt(V,!o&&this.checkEndOfBlock()||o&&V.contains(o)?k.POSITION_BEFORE_END:k.POSITION_BEFORE_START);E&&this.setEndAfter(E)}},checkStartOfBlock:function(){var c=
this.startContainer,g=this.startOffset;if(g&&c[0].nodeType==e.NODE_TEXT)if(h.trim(c[0].nodeValue.substring(0,g)).length)return n;this.trim();c=new y(this.startContainer);g=this.clone();g.collapse(v);g.setStartAt(c.block||c.blockLimit,k.POSITION_AFTER_START);c=new j(g);c.evaluator=w(v);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,g=this.endOffset;if(c[0].nodeType==e.NODE_TEXT)if(h.trim(c[0].nodeValue.substring(g)).length)return n;this.trim();c=new y(this.endContainer);
g=this.clone();g.collapse(n);g.setEndAt(c.block||c.blockLimit,k.POSITION_BEFORE_END);c=new j(g);c.evaluator=w(n);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,g){var q=this.clone();q[g==k.START?"setStartAt":"setEndAt"](c,g==k.START?k.POSITION_AFTER_START:k.POSITION_BEFORE_END);q=new j(q);q.evaluator=
C;return q[g==k.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,g=this.endContainer,q=this.startOffset,s=this.endOffset,o;if(c[0].nodeType==e.NODE_ELEMENT){o=c[0].childNodes.length;if(o>q)c=new r(c[0].childNodes[q]);else if(o<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new r(c);c=c._4e_nextSourceNode()||c}}if(g[0].nodeType==e.NODE_ELEMENT){o=g[0].childNodes.length;if(o>s)g=(new r(g[0].childNodes[s]))._4e_previousSourceNode(v);
else if(o<1)g=g._4e_previousSourceNode();else{for(g=g[0];g.lastChild;)g=g.lastChild;g=new r(g)}}if(c._4e_position(g)&x.POSITION_FOLLOWING)c=g;return{startNode:c,endNode:g}},fixBlock:function(c,g){var q=this.createBookmark(),s=new r(this.document.createElement(g));this.collapse(c);this.enlarge(k.ENLARGE_BLOCK_CONTENTS);s[0].appendChild(this.extractContents());s._4e_trim();d.ie||s._4e_appendBogus();this.insertNode(s);this.moveToBookmark(q);return s},splitBlock:function(c){var g=new y(this.startContainer),
q=new y(this.endContainer),s=g.block,o=q.block,D=f;if(!g.blockLimit._4e_equals(q.blockLimit))return f;if(c!="br"){if(!s){s=this.fixBlock(v,c);o=(new y(this.endContainer)).block}o||(o=this.fixBlock(n,c))}c=s&&this.checkStartOfBlock();g=o&&this.checkEndOfBlock();this.deleteContents();if(s&&a._4e_equals(s,o))if(g){D=new y(this.startContainer);this.moveToPosition(o,k.POSITION_AFTER_END);o=f}else if(c){D=new y(this.startContainer);this.moveToPosition(s,k.POSITION_BEFORE_START);s=f}else{o=this.splitElement(s);
!d.ie&&!h.inArray(s._4e_name(),["ul","ol"])&&s._4e_appendBogus()}return{previousBlock:s,nextBlock:o,wasStartOfBlock:c,wasEndOfBlock:g,elementPath:D}},splitElement:function(c){if(!this.collapsed)return f;this.setEndAt(c,k.POSITION_BEFORE_END);var g=this.extractContents(),q=c._4e_clone(n);q[0].appendChild(g);q.insertAfter(c);this.moveToPosition(c,k.POSITION_AFTER_END);return q},moveToElementEditablePosition:function(c,g){var q,s=p.XHTML_DTD;if(s.$empty[c._4e_name()])return n;for(;c&&c[0].nodeType==
e.NODE_ELEMENT;){if(q=c._4e_isEditable())this.moveToPosition(c,g?k.POSITION_BEFORE_END:k.POSITION_AFTER_START);else if(s.$inline[c._4e_name()]){this.moveToPosition(c,g?k.POSITION_AFTER_END:k.POSITION_BEFORE_START);return v}if((c=s.$empty[c._4e_name()]?c[g?"_4e_previous":"_4e_next"](H):c[g?"_4e_last":"_4e_first"](H))&&c[0].nodeType==e.NODE_TEXT){this.moveToPosition(c,g?k.POSITION_AFTER_END:k.POSITION_BEFORE_START);return v}}return q},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,
c[0].nodeType==e.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var i={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},B=new j.whitespaces,J=new j.bookmark;p.Range=z;p.Range=z;var t=z.prototype;p.Utils.extern(t,{updateCollapsed:t.updateCollapsed,optimize:t.optimize,setStartAfter:t.setStartAfter,setEndAfter:t.setEndAfter,setStartBefore:t.setStartBefore,setEndBefore:t.setEndBefore,
optimizeBookmark:t.optimizeBookmark,setStart:t.setStart,setEnd:t.setEnd,setStartAt:t.setStartAt,setEndAt:t.setEndAt,execContentsAction:t.execContentsAction,collapse:t.collapse,clone:t.clone,getEnclosedNode:t.getEnclosedNode,shrink:t.shrink,getTouchedStartNode:t.getTouchedStartNode,createBookmark2:t.createBookmark2,createBookmark:t.createBookmark,moveToPosition:t.moveToPosition,trim:t.trim,insertNode:t.insertNode,moveToBookmark:t.moveToBookmark,getCommonAncestor:t.getCommonAncestor,enlarge:t.enlarge,
checkStartOfBlock:t.checkStartOfBlock,checkEndOfBlock:t.checkEndOfBlock,deleteContents:t.deleteContents,extractContents:t.extractContents,checkBoundaryOfElement:t.checkBoundaryOfElement,getBoundaryNodes:t.getBoundaryNodes,fixBlock:t.fixBlock,splitBlock:t.splitBlock,splitElement:t.splitElement,moveToElementEditablePosition:t.moveToElementEditablePosition,selectNodeContents:t.selectNodeContents})});
KISSY.Editor.add("domiterator",function(p){function z(j){if(!(arguments.length<1)){this.range=j;this.forceBrBreak=H;this.enlargeBr=C;this.enforceRealBlocks=H;this._||(this._={})}}var C=true,H=false,w=KISSY,u=w.UA,A=p.Walker,v=p.Range,n=p.RANGE,f=p.NODE,h=p.ElementPath,e=w.Node,k=w.DOM,x=/^[\r\n\t ]*$/;w.augment(z,{getNextParagraph:function(j){var a,b,d,m,y;if(!this._.lastNode){b=this.range.clone();b.shrink(n.SHRINK_ELEMENT,C);b.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:
n.ENLARGE_BLOCK_CONTENTS);var r=new A(b),l=A.bookmark(C,C);r.evaluator=l;this._.nextNode=r.next();r=new A(b);r.evaluator=l;r=r.previous();this._.lastNode=r._4e_nextSourceNode(C);if(this._.lastNode&&this._.lastNode[0].nodeType==f.NODE_TEXT&&!w.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){l=new v(b.document);l.moveToPosition(this._.lastNode,n.POSITION_AFTER_END);if(l.checkEndOfBlock()){l=new h(l.endContainer);this._.lastNode=(l.block||l.blockLimit)._4e_nextSourceNode(C)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new e(b.document.createTextNode(""));k.insertAfter(this._.lastNode[0],r[0])}b=null}l=this._.nextNode;r=this._.lastNode;for(this._.nextNode=null;l;){var i=H,B=l[0].nodeType!=f.NODE_ELEMENT,J=H;if(B){if(l[0].nodeType==f.NODE_TEXT)if(x.test(l[0].nodeValue))B=H}else{var t=l._4e_name();if(l._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(t=="br")B=C;else if(!b&&!l[0].childNodes.length&&t!="hr"){a=l;d=l._4e_equals(r);break}if(b){b.setEndAt(l,n.POSITION_BEFORE_START);if(t!="br")this._.nextNode=
l}i=C}else{if(l[0].firstChild){if(!b){b=new v(this.range.document);b.setStartAt(l,n.POSITION_BEFORE_START)}l=new e(l[0].firstChild);continue}B=C}}if(B&&!b){b=new v(this.range.document);b.setStartAt(l,n.POSITION_BEFORE_START)}d=(!i||B)&&l._4e_equals(r);if(b&&!i)for(;!l[0].nextSibling&&!d;){t=l.parent();if(t._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){i=C;d||t._4e_equals(r);break}l=t;B=C;d=l._4e_equals(r);J=C}B&&b.setEndAt(l,n.POSITION_AFTER_END);l=l._4e_nextSourceNode(J,null,r);if((d=!l)||i&&b)break}if(!a){if(!b){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new h(b.startContainer);l=a.blockLimit;i={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&i[l._4e_name()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=l;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new e(this.range.document.createElement(j||"p"));a[0].appendChild(b.extractContents());a._4e_trim();b.insertNode(a);m=y=C}else if(a._4e_name()!="li"){if(!b.checkStartOfBlock()||!b.checkEndOfBlock()){a=a._4e_clone(H);
a[0].appendChild(b.extractContents());a._4e_trim();y=b.splitBlock();m=!y.wasStartOfBlock;y=!y.wasEndOfBlock;b.insertNode(a)}}else if(!d)this._.nextNode=a._4e_equals(r)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(C,null,r)}if(m){b=new e(a[0].previousSibling);if(b[0]&&b[0].nodeType==f.NODE_ELEMENT)if(b._4e_name()=="br")b._4e_remove();else b[0].lastChild&&k._4e_name(b[0].lastChild)=="br"&&k._4e_remove(b[0].lastChild)}if(y){b=A.bookmark(H,C);m=new e(a[0].lastChild);if(m[0]&&m[0].nodeType==f.NODE_ELEMENT&&
m._4e_name()=="br")if(u.ie||m._4e_previous(b)||m._4e_next(b))m._4e_remove()}if(!this._.nextNode)this._.nextNode=d||a._4e_equals(r)?null:a._4e_nextSourceNode(C,null,r);return a}});v.prototype.createIterator=function(){return new z(this)}});
KISSY.Editor.add("selection",function(p){function z(l){this.document=this.document=l;this._={cache:{}};if(n.ie){var i=this.getNative().createRange();if(!i||i.item&&i.item(0).ownerDocument!=l||i.parentElement&&i.parentElement().ownerDocument!=l)this.isInvalid=w}}function C(l){l=new z(l);return!l||l.isInvalid?A:l}function H(l){var i=l.document,B=new e(i.body),J=new e(i.documentElement);if(n.ie){if(n.ie<8||document.documentMode==7)J.on("click",function(N){f._4e_name(N.target)==="html"&&l.getSelection().getRanges()[0].select()});
var t,c,g=1;J.on("mousedown",function(){g=0});J.on("mouseup",function(){g=1});B.on("focusin",function(N){if(f._4e_name(N.target)=="body")if(t){try{g&&t.select()}catch(P){}t=A}});B.on("focus",function(){c=w;s()});B.on("beforedeactivate",function(N){if(!N.relatedTarget){c=u;g=1}});h.on(f._4e_getWin(i),"blur",function(){i&&i.selection.empty()});B.on("mousedown",function(){q()});B.on("mouseup",function(){c=w;setTimeout(function(){s(w)},0)});var q=function(){c=u},s=function(N){if(c){var P=l.document,Q=
l.getSelection(),U=Q&&Q.getType(),S=Q&&Q.getNative();if(N&&S&&U==k.SELECTION_NONE)if(!P.queryCommandEnabled("InsertImage")){setTimeout(function(){s(w)},50);return}var T;if(!(S&&U==k.SELECTION_TEXT&&(T=f._4e_name(S.createRange().parentElement()))&&T in{input:1,textarea:1})){t=S&&Q.getRanges()[0];l._monitor()}}};B.on("keydown",q);B.on("keyup",function(){c=w;s()});h.on(i,"selectionchange",s)}else{h.on(i,"mouseup",l._monitor,l);h.on(i,"keyup",l._monitor,l)}var o={table:1,pre:1},D=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
O=p.Walker.whitespaces(w);l.on("selectionChange",function(N){var P=N.path;N=(N=N.selection)&&N.getRanges()[0];if(!(!N||!N.collapsed||P.block))if(P.blockLimit._4e_name()=="body"){P=N.fixBlock(w,"p");if(P._4e_outerHtml().match(D)){var Q=P._4e_next(O);if(Q&&Q[0].nodeType==j.NODE_ELEMENT&&!o[Q._4e_name()]){N.moveToElementEditablePosition(Q);P._4e_remove()}else if((Q=P._4e_previous(O))&&Q[0].nodeType==j.NODE_ELEMENT&&!o[Q._4e_name()]){N.moveToElementEditablePosition(Q,Q._4e_outerHtml().match(D)?u:w);P._4e_remove()}}N.select();
n.ie||l.notifySelectionChange()}})}p.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var w=true,u=false,A=null,v=KISSY,n=v.UA,f=v.DOM,h=v.Event,e=v.Node,k=p.SELECTION,x=p.RANGE,j=p.NODE,a=p.Walker,b=p.Range,d={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};v.augment(z,{getNative:n.ie?function(){var l=this._.cache;return l.nativeSel||(l.nativeSel=this.document.selection)}:function(){var l=
this._.cache;return l.nativeSel||(l.nativeSel=f._4e_getWin(this.document).getSelection())},getType:n.ie?function(){var l=this._.cache;if(l.type)return l.type;var i=k.SELECTION_NONE;try{var B=this.getNative(),J=B.type;if(J=="Text")i=k.SELECTION_TEXT;if(J=="Control")i=k.SELECTION_ELEMENT;if(B.createRange().parentElement)i=k.SELECTION_TEXT}catch(t){}return l.type=i}:function(){var l=this._.cache;if(l.type)return l.type;var i=k.SELECTION_TEXT,B=this.getNative();if(B){if(B.rangeCount==1){B=B.getRangeAt(0);
var J=B.startContainer;if(J==B.endContainer&&J.nodeType==j.NODE_ELEMENT&&B.endOffset-B.startOffset===1&&d[J.childNodes[B.startOffset].nodeName.toLowerCase()])i=k.SELECTION_ELEMENT}}else i=k.SELECTION_NONE;return l.type=i},getRanges:n.ie?function(){var l=function(i,B){i=i.duplicate();i.collapse(B);for(var J=i.parentElement(),t=J.childNodes,c,g=0;g<t.length;g++){var q=t[g];if(q.nodeType==j.NODE_ELEMENT){c=i.duplicate();c.moveToElementText(q);q=c.compareEndPoints("StartToStart",i);var s=c.compareEndPoints("EndToStart",
i);c.collapse();if(q>0)break;else if(!q||s==1&&q==-1)return{container:J,offset:g};else if(!s)return{container:J,offset:g+1};c=A}}if(!c){c=i.duplicate();c.moveToElementText(J);c.collapse(u)}c.setEndPoint("StartToStart",i);c=c.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;c>0;)c-=t[--g].nodeValue.length}catch(o){c=0}return c===0?{container:J,offset:g}:{container:t[g],offset:-c}};return function(){var i=this._.cache;if(i.ranges)return i.ranges;var B=this.getNative(),J=B&&B.createRange(),t=this.getType();
if(!B)return[];if(t==k.SELECTION_TEXT){B=new b(this.document);t=l(J,w);B.setStart(new e(t.container),t.offset);t=l(J);B.setEnd(new e(t.container),t.offset);return i.ranges=[B]}else if(t==k.SELECTION_ELEMENT){i=i.ranges=[];for(t=0;t<J.length;t++){var c=J.item(t),g=c.parentNode,q=0;for(B=new b(this.document);q<g.childNodes.length&&g.childNodes[q]!=c;q++);B.setStart(new e(g),q);B.setEnd(new e(g),q+1);i.push(B)}return i}return i.ranges=[]}}():function(){var l=this._.cache;if(l.ranges)return l.ranges;
var i=[],B=this.getNative();if(!B)return[];for(var J=0;J<B.rangeCount;J++){var t=B.getRangeAt(J),c=new b(this.document);c.setStart(new e(t.startContainer),t.startOffset);c.setEnd(new e(t.endContainer),t.endOffset);i.push(c)}return l.ranges=i},getStartElement:function(){var l=this._.cache;if(l.startElement!==undefined)return l.startElement;var i,B=this.getNative();switch(this.getType()){case k.SELECTION_ELEMENT:return this.getSelectedElement();case k.SELECTION_TEXT:var J=this.getRanges()[0];if(J)if(!J.collapsed){for(J.optimize();w;){i=
J.startContainer;if(J.startOffset==(i[0].nodeType===j.NODE_ELEMENT?i[0].childNodes.length:i[0].nodeValue.length)&&!i._4e_isBlockBoundary())J.setStartAfter(i);else break}i=J.startContainer;if(i[0].nodeType!=j.NODE_ELEMENT)return i.parent();i=new e(i[0].childNodes[J.startOffset]);if(!i[0]||i[0].nodeType!=j.NODE_ELEMENT)return J.startContainer;for(J=i[0].firstChild;J&&J.nodeType==j.NODE_ELEMENT;){i=new e(J);J=J.firstChild}return i}if(n.ie){J=B.createRange();J.collapse(w);i=J.parentElement()}else if((i=
B.anchorNode)&&i.nodeType!=j.NODE_ELEMENT)i=i.parentNode}return l.startElement=i?f._4e_wrap(i):A},getSelectedElement:function(){var l=this,i,B=l._.cache;if(B.selectedElement!==undefined)return B.selectedElement;if(n.ie){i=l.getNative().createRange();i=i.item&&i.item(0)}i||(i=function(){for(var J=l.getRanges()[0],t,c,g=2;g&&!((t=J.getEnclosedNode())&&t[0].nodeType==j.NODE_ELEMENT&&d[t._4e_name()]&&(c=t));g--)J.shrink(x.SHRINK_ELEMENT);return c&&c[0]}());return B.selectedElement=f._4e_wrap(i)},reset:function(){this._.cache=
{}},selectElement:function(l){var i;if(n.ie)try{i=this.document.body.createControlRange();i.addElement(l[0]);i.select()}catch(B){i=this.document.body.createTextRange();i.moveToElementText(l[0]);i.select()}finally{}else{i=this.document.createRange();i.selectNode(l[0]);l=this.getNative();l.removeAllRanges();l.addRange(i)}this.reset()},selectRanges:function(l){if(n.ie){if(l.length>1){var i=l[l.length-1];l[0].setEnd(i.endContainer,i.endOffset);l.length=1}l[0]&&l[0].select()}else{i=this.getNative();if(!i)return;
i.removeAllRanges();for(var B=0;B<l.length;B++){var J=l[B],t=this.document.createRange(),c=J.startContainer;J.collapsed&&n.gecko&&n.gecko<1.09&&c[0].nodeType==j.NODE_ELEMENT&&!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));t.setStart(c[0],J.startOffset);t.setEnd(J.endContainer[0],J.endOffset);i.addRange(t)}}this.reset()},createBookmarks2:function(l){for(var i=[],B=this.getRanges(),J=0;J<B.length;J++)i.push(B[J].createBookmark2(l));return i},createBookmarks:function(l,i){var B=
[],J=this.document,t;i=i||this.getRanges();for(var c=i.length,g=0;g<c;g++){B.push(t=i[g].createBookmark(l,w));var q=(l=t.serializable)?v.one("#"+t.startNode,J):t.startNode;t=l?v.one("#"+t.endNode,J):t.endNode;for(var s=g+1;s<c;s++){var o=i[s],D=o.startContainer,O=o.endContainer;f._4e_equals(D,q.parent())&&o.startOffset++;f._4e_equals(D,t.parent())&&o.startOffset++;f._4e_equals(O,q.parent())&&o.endOffset++;f._4e_equals(O,t.parent())&&o.endOffset++}}return B},selectBookmarks:function(l){for(var i=[],
B=0;B<l.length;B++){var J=new b(this.document);J.moveToBookmark(l[B]);i.push(J)}this.selectRanges(i);return this},getCommonAncestor:function(){var l=this.getRanges();return l[0].startContainer._4e_commonAncestor(l[l.length-1].endContainer)},scrollIntoView:function(){var l=this.getStartElement();l&&l._4e_scrollIntoView()},removeAllRanges:function(){var l=this.getNative();if(n.ie)l&&l.clear();else l&&l.removeAllRanges()}});var m={table:1,tbody:1,tr:1},y=a.whitespaces(w),r=/\ufeff|\u00a0/;b.prototype.select=
b.prototype.select=n.ie?function(l){var i=this.collapsed,B,J;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var t=this.startContainer[0].childNodes[this.startOffset];if(t.nodeType==j.NODE_ELEMENT){(new z(this.document)).selectElement(new e(t));return}}if(this.startContainer[0].nodeType==j.NODE_ELEMENT&&this.startContainer._4e_name()in m||this.endContainer[0].nodeType==j.NODE_ELEMENT&&this.endContainer._4e_name()in m)this.shrink(x.SHRINK_ELEMENT,w);var c=this.createBookmark();
t=c.startNode;var g;if(!i)g=c.endNode;c=this.document.body.createTextRange();c.moveToElementText(t[0]);c.moveStart("character",1);if(g){l=this.document.body.createTextRange();l.moveToElementText(g[0]);c.setEndPoint("EndToEnd",l);c.moveEnd("character",-1)}else{for(B=t[0].nextSibling;B&&!y(B);)B=B.nextSibling;B=!(B&&B.nodeValue&&B.nodeValue.match(r))&&(l||!t[0].previousSibling||t[0].previousSibling&&f._4e_name(t[0].previousSibling)=="br");J=this.document.createElement("span");J.innerHTML="&#65279;";
J=new e(J);f.insertBefore(J[0],t[0]);B&&f.insertBefore(this.document.createTextNode("\ufeff"),t[0])}this.setStartBefore(t);t._4e_remove();if(i){if(B){c.moveStart("character",-1);c.select();this.document.selection.clear()}else c.select();if(J){this.moveToPosition(J,x.POSITION_BEFORE_START);J._4e_remove()}}else{this.setEndBefore(g);g._4e_remove();c.select()}}:function(){var l=this.startContainer;this.collapsed&&l[0].nodeType==j.NODE_ELEMENT&&!l[0].childNodes.length&&l[0].appendChild(this.document.createTextNode(""));
var i=this.document.createRange();i.setStart(l[0],this.startOffset);try{i.setEnd(this.endContainer[0],this.endOffset)}catch(B){if(B.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(w);i.setEnd(this.endContainer[0],this.endOffset)}else throw B;}l=C(this.document).getNative();l.removeAllRanges();l.addRange(i)};z.getSelection=C;p.Selection=z;p.Selection=z;a=z.prototype;p.Utils.extern(a,{getNative:a.getNative,getType:a.getType,getRanges:a.getRanges,getStartElement:a.getStartElement,getSelectedElement:a.getSelectedElement,
reset:a.reset,selectElement:a.selectElement,selectRanges:a.selectRanges,createBookmarks2:a.createBookmarks2,createBookmarks:a.createBookmarks,getCommonAncestor:a.getCommonAncestor,scrollIntoView:a.scrollIntoView,selectBookmarks:a.selectBookmarks,removeAllRanges:a.removeAllRanges});p.on("instanceCreated",function(l){H(l.editor)})});
KISSY.Editor.add("styles",function(p){function z(E,K){for(var G in E)E[G]=E[G].replace(T,function(F,I){return K[I]})}function C(E,K){if(K){E=B.clone(E);z(E.attributes,K);z(E.styles,K)}var G=this.element=this.element=(E.element||"*").toLowerCase();this.type=this.type=G=="#"||Q[G]?c.STYLE_BLOCK:U[G]?c.STYLE_OBJECT:c.STYLE_INLINE;this._={definition:E}}function H(E,K){var G=K?this.removeFromRange:this.applyToRange;E.body.focus();for(var F=new q(E),I=F.getRanges(),M=0;M<I.length;M++)G.call(this,I[M]);
F.selectRanges(I)}function w(E,K){var G;G=E.element;if(G=="*")G="span";G=new O(K.createElement(G));return u(G,E)}function u(E,K){var G=K._.definition,F=G.attributes;G=C.getStyleText(G);if(F)for(var I in F)E.attr(I,F[I]);if(G)E[0].style.cssText=G;return E}function A(E){var K=E.createBookmark(r),G=E.createIterator();G.enforceRealBlocks=r;G.enlargeBr=r;for(var F,I=E.document;F=G.getNextParagraph();){var M=w(this,I);F=F;var L=M;M=L._4e_name=="pre";var R=F._4e_name=="pre",Z=!M&&R;if(M&&!R){R=F;L=L;Z=R.html();
Z=v(Z,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");Z=Z.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");Z=Z.replace(/([ \t\n\r]+|&nbsp;)/g," ");Z=Z.replace(/<br\b[^>]*>/gi,"\n");if(N.ie){R=R[0].ownerDocument.createElement("div");R.appendChild(L[0]);L[0].outerHTML="<pre>"+Z+"</pre>";L=new O(R.firstChild);L._4e_remove()}else L.html(Z);L=L}else if(Z)L=f(n(F),L);else F._4e_moveChildren(L);F[0].parentNode.replaceChild(L[0],F[0]);if(M){F=L;M=void 0;if((M=F._4e_previousSourceNode(r,s.NODE_ELEMENT))&&M._4e_name()==
"pre"){L=v(M.html(),/\n$/,"")+"\n\n"+v(F.html(),/^\n/,"");if(N.ie)F[0].outerHTML="<pre>"+L+"</pre>";else F.html(L);M._4e_remove()}}}E.moveToBookmark(K)}function v(E,K,G){var F="",I="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(M,L,R){L&&(F=L);R&&(I=R);return""});return F+E.replace(K,G)+I}function n(E){var K=[];v(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(G,F,I){return F+"</pre>"+I+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(G,F){K.push(F)});return K}function f(E,K){for(var G=K[0].ownerDocument.createDocumentFragment(),F=0;F<E.length;F++){var I=E[F];I=I.replace(/(\r\n|\r)/g,"\n");I=v(I,/^[ \t]*\n/,"");I=v(I,/\n$/,"");I=v(I,/^[ \t]+|[ \t]+$/g,function(L,R){return L.length==1?"&nbsp;":R?" "+Array(L.length).join("&nbsp;"):Array(L.length).join("&nbsp;")+" "});I=I.replace(/\n/g,"<br>");I=I.replace(/[ \t]{2,}/g,function(L){return Array(L.length).join("&nbsp;")+" "});var M=K._4e_clone();M.html(I);G.appendChild(M[0])}return G}
function h(E){var K=E.document;if(E.collapsed){K=w(this,K);E.insertNode(K);E.moveToPosition(K,g.POSITION_BEFORE_END)}else{var G=this.element,F=this._.definition,I,M=p.XHTML_DTD[G]||(I=r,p.XHTML_DTD.span),L=E.createBookmark();E.enlarge(g.ENLARGE_ELEMENT);E.trim();var R=E.createBookmark(),Z=R.startNode;R=R.endNode;for(var X=Z,$;X&&X[0];){var W=l;if(t._4e_equals(X,R)){X=i;W=r}else{var Y=X[0].nodeType,ca=Y==s.NODE_ELEMENT?X._4e_name():i;if(ca&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(r);continue}if(!ca||
M[ca]&&(X._4e_position(R)|o.POSITION_PRECEDING|o.POSITION_IDENTICAL|o.POSITION_IS_CONTAINED)==o.POSITION_PRECEDING+o.POSITION_IDENTICAL+o.POSITION_IS_CONTAINED&&(!F.childRule||F.childRule(X))){var da=X.parent();if(da&&da[0]&&((p.XHTML_DTD[da._4e_name()]||p.XHTML_DTD.span)[G]||I)&&(!F.parentRule||F.parentRule(da))){if(!$&&(!ca||!p.XHTML_DTD.$removeEmpty[ca]||(X._4e_position(R)|o.POSITION_PRECEDING|o.POSITION_IDENTICAL|o.POSITION_IS_CONTAINED)==o.POSITION_PRECEDING+o.POSITION_IDENTICAL+o.POSITION_IS_CONTAINED)){$=
new D(K);$.setStartBefore(X)}if(Y==s.NODE_TEXT||Y==s.NODE_ELEMENT&&!X[0].childNodes.length){Y=X;var aa;for(ca=Y._4e_next(function(fa){return!fa.attr("_ke_bookmark")});!ca&&(aa=Y.parent(),M[aa._4e_name()])&&(aa._4e_position(Z)|o.POSITION_FOLLOWING|o.POSITION_IDENTICAL|o.POSITION_IS_CONTAINED)==o.POSITION_FOLLOWING+o.POSITION_IDENTICAL+o.POSITION_IS_CONTAINED&&(!F.childRule||F.childRule(aa));)Y=aa;$.setEndAfter(Y);Y[0].nextSibling||(W=r)}}else W=r}else W=r;X=X._4e_nextSourceNode()}if(W&&$&&!$.collapsed){W=
w(this,K);for(Y=$.getCommonAncestor();W&&Y&&W[0]&&Y[0];){if(Y._4e_name()==G){for(var ba in F.attributes)W.attr(ba)==Y.attr(ba)&&W[0].removeAttribute(ba);for(var ea in F.styles)W._4e_style(ea)==Y._4e_style(ea)&&W._4e_style(ea,"");if(!W._4e_hasAttributes()){W=i;break}}Y=Y.parent()}if(W){W[0].appendChild($.extractContents());d(this,W);$.insertNode(W);W._4e_mergeSiblings();N.ie||W[0].normalize()}$=i}}Z._4e_remove();R._4e_remove();E.moveToBookmark(L);E.shrink(g.SHRINK_TEXT)}}function e(E){E.enlarge(g.ENLARGE_ELEMENT);
var K=E.createBookmark(),G=K.startNode;if(E.collapsed){for(var F=new P(G.parent()),I,M=0,L;M<F.elements.length&&(L=F.elements[M]);M++){if(L==F.block||L==F.blockLimit)break;if(this.checkElementRemovable(L)){var R=E.checkBoundaryOfElement(L,g.END),Z=!R&&E.checkBoundaryOfElement(L,g.START);if(Z||R){I=L;I.match=Z?"start":"end"}else{L._4e_mergeSiblings();L._4e_name()==this.element?a(this,L):m(L,j(this)[L._4e_name()])}}}if(I&&I[0]){L=G;for(M=0;;M++){R=F.elements[M];if(t._4e_equals(R,I))break;else if(R.match)continue;
else R=R._4e_clone();R[0].appendChild(L[0]);L=R}t[I.match=="start"?"insertBefore":"insertAfter"](L[0],I[0])}}else{var X=K.endNode,$=this;F=function(){for(var W=new P(G.parent()),Y=new P(X.parent()),ca=i,da=i,aa=0;aa<W.elements.length;aa++){var ba=W.elements[aa];if(ba==W.block||ba==W.blockLimit)break;if($.checkElementRemovable(ba))ca=ba}for(aa=0;aa<Y.elements.length;aa++){ba=Y.elements[aa];if(ba==Y.block||ba==Y.blockLimit)break;if($.checkElementRemovable(ba))da=ba}da&&X._4e_breakParent(da);ca&&G._4e_breakParent(ca)};
F();for(I=new O(G[0].nextSibling);I[0]!==X[0];){M=I._4e_nextSourceNode();if(I[0]&&I[0].nodeType==s.NODE_ELEMENT&&this.checkElementRemovable(I)){I._4e_name()==this.element?a(this,I):m(I,j(this)[I._4e_name()]);if(M[0].nodeType==s.NODE_ELEMENT&&M.contains(G)){F();M=new O(G[0].nextSibling)}}I=M}}E.moveToBookmark(K)}function k(E){var K={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,F,I){K[F]=I});return K}function x(E,K){var G;if(K!==l){G=document.createElement("span");
G.style.cssText=E;G=G.style.cssText||""}else G=E;return G.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function j(E){if(E._.overrides)return E._.overrides;var K=E._.overrides={},G=E._.definition.overrides;if(G){B.isArray(G)||(G=[G]);for(var F=0;F<G.length;F++){var I=G[F],M,L;if(typeof I=="string")M=I.toLowerCase();else{M=I.element?I.element.toLowerCase():E.element;L=I.attributes}I=K[M]||(K[M]={});if(L){I=I.attributes=I.attributes||[];for(var R in L)I.push([R.toLowerCase(),
L[R]])}}}return K}function a(E,K){var G=E._.definition,F=J.mix(G.attributes,j(E)[K._4e_name()]);G=G.styles;var I=B.isEmptyObject(F)&&B.isEmptyObject(G),M;for(M in F)if(!((M=="class"||E._.definition.fullMatch)&&K.attr(M)!=b(M,F[M]))){I=I||!!K._4e_hasAttribute(M);K.removeAttr(M)}for(var L in G)if(!(E._.definition.fullMatch&&K._4e_style(L)!=b(L,G[L],r))){I=I||!!K._4e_style(L);K._4e_style(L,"")}y(K)}function b(E,K,G){var F=new O("<span>");F[G?"_4e_style":"attr"](E,K);return F[G?"_4e_style":"attr"](E)}
function d(E,K){for(var G=j(E),F=K.all(E.element),I=F.length;--I>=0;)a(E,new O(F[I]));for(var M in G)if(M!=E.element){F=K.all(M);for(I=F.length-1;I>=0;I--){var L=new O(F[I]);m(L,G[M])}}}function m(E,K){var G=K&&K.attributes;if(G)for(var F=0;F<G.length;F++){var I=G[F][0],M;if(M=E.attr(I)){var L=G[F][1];if(L===i||L.test&&L.test(M)||typeof L=="string"&&M==L)E[0].removeAttribute(I)}}y(E)}function y(E){if(!E._4e_hasAttributes()){var K=E[0].firstChild,G=E[0].lastChild;E._4e_remove(r);if(K){K.nodeType==
s.NODE_ELEMENT&&t._4e_mergeSiblings(K);G&&K!=G&&G.nodeType==s.NODE_ELEMENT&&t._4e_mergeSiblings(G)}}}var r=true,l=false,i=null,B=KISSY,J=p.Utils,t=B.DOM,c={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},g=p.RANGE,q=p.Selection,s=p.NODE,o=p.POSITION,D=p.Range,O=B.Node,N=B.UA,P=p.ElementPath,Q={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},U={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},S=/\s*(?:;\s*|$)/,T=/#\((.+?)\)/g;p.STYLE=c;C.prototype={apply:function(E){H.call(this,
E,l)},remove:function(E){H.call(this,E,r)},applyToRange:function(E){return(this.applyToRange=this.type==c.STYLE_INLINE?h:this.type==c.STYLE_BLOCK?A:this.type==c.STYLE_OBJECT?i:i).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==c.STYLE_INLINE?e:i).call(this,E)},applyToObject:function(E){u(E,this)},checkElementRemovable:function(E,K){if(!E)return l;var G=this._.definition;if(E._4e_name()==this.element){if(!K&&!E._4e_hasAttributes())return r;var F=G._AC;if(F)G=F;else{F=
{};var I=0,M=G.attributes;if(M)for(var L in M){I++;F[L]=M[L]}if(M=C.getStyleText(G)){F.style||I++;F.style=M}F._length=I;G=G._AC=F}if(G._length){for(var R in G)if(R!="_length"){I=E.attr(R)||"";if(R=="style")a:{F=G[R];I=x(I,l);typeof F=="string"&&(F=k(F));typeof I=="string"&&(I=k(I));M=void 0;for(M in F)if(!(M in I&&(I[M]==F[M]||F[M]=="inherit"||I[M]=="inherit"))){F=l;break a}F=r}else F=G[R]==I;if(F){if(!K)return r}else if(K)return l}if(K)return r}else return r}if(R=j(this)[E._4e_name()]){if(!(G=R.attributes))return r;
for(F=0;F<G.length;F++){R=G[F][0];if(R=E.attr(R)){I=G[F][1];if(I===i||typeof I=="string"&&R==I||I.test&&I.test(R))return r}}}return l},checkActive:function(E){switch(this.type){case c.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,r);case c.STYLE_OBJECT:case c.STYLE_INLINE:for(var K=E.elements,G=0,F;G<K.length;G++){F=K[G];if(!(this.type==c.STYLE_INLINE&&(t._4e_equals(F,E.block)||t._4e_equals(F,E.blockLimit))))if(!(this.type==c.STYLE_OBJECT&&!(F._4e_name()in U)))if(this.checkElementRemovable(F,
r))return r}}return l}};C.getStyleText=function(E){var K=E._ST;if(K)return K;K=E.styles;var G=E.attributes&&E.attributes.style||"",F="";if(G.length)G=G.replace(S,";");for(var I in K){var M=K[I],L=(I+":"+M).replace(S,";");if(M=="inherit")F+=L;else G+=L}if(G.length)G=x(G);G+=F;return E._ST=G};p.Style=C;p.Style=C;var V=C.prototype;p.Utils.extern(V,{apply:V.apply,remove:V.remove,applyToRange:V.applyToRange,removeFromRange:V.removeFromRange,applyToObject:V.applyToObject,checkElementRemovable:V.checkElementRemovable,
checkActive:V.checkActive})});
KISSY.Editor.add("htmlparser",function(){function p(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var z=KISSY,C=function(){},H=z.Editor,w=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,u={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},A=H.XHTML_DTD;z.augment(p,{onTagOpen:C,onTagClose:C,
onText:C,onCDATA:C,onComment:C,parse:function(v){for(var n,f,h=0,e;n=this._.htmlPartsRegex.exec(v);){f=n.index;if(f>h){h=v.substring(h,f);e?e.push(h):this.onText(h)}h=this._.htmlPartsRegex.lastIndex;if(f=n[1]){f=f.toLowerCase();if(e&&A.$cdata[f]){this.onCDATA(e.join(""));e=null}if(!e){this.onTagClose(f);continue}}if(e)e.push(n[0]);else if(f=n[3]){f=f.toLowerCase();if(!/="/.test(f)){var k={},x;n=n[4];var j=!!(n&&n.charAt(n.length-1)=="/");if(n)for(;x=w.exec(n);){var a=x[1].toLowerCase();x=x[2]||x[3]||
x[4]||"";k[a]=!x&&u[a]?a:x}this.onTagOpen(f,k,j);if(!e&&A.$cdata[f])e=[]}}else if(f=n[2])this.onComment(f)}v.length>h&&this.onText(v.substring(h,v.length))}});H.HtmlParser=p;H.HtmlParser=p});
KISSY.Editor.add("htmlparser-basicwriter",function(){function p(){this._={output:[]}}var z=KISSY,C=z.Editor,H=C.Utils;z.augment(p,{openTag:function(w){this._.output.push("<",w)},openTagClose:function(w,u){u?this._.output.push(" />"):this._.output.push(">")},attribute:function(w,u){if(typeof u=="string")u=H.htmlEncodeAttr(u);this._.output.push(" ",w,'="',u,'"')},closeTag:function(w){this._.output.push("</",w,">")},text:function(w){this._.output.push(w)},comment:function(w){this._.output.push("<!--",
w,"--\>")},write:function(w){this._.output.push(w)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(w){var u=this._.output.join("");w&&this.reset();return u}});C.HtmlParser.BasicWriter=p;C.HtmlParser.BasicWriter=p;z=p.prototype;C.Utils.extern(z,{openTag:z.openTag,openTagClose:z.openTagClose,attribute:z.attribute,closeTag:z.closeTag,text:z.text,comment:z.comment,write:z.write,reset:z.reset,getHtml:z.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function p(){p.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=u;this.sortAttributes=w;this._.indent=u;this._.indentation="";this._.rules={};var A=C.XHTML_DTD,v;for(v in H.mix({},A.$nonBodyContent,A.$block,A.$listItem,A.$tableContent))this.setRules(v,{indent:w,breakBeforeOpen:w,breakAfterOpen:w,breakBeforeClose:!A[v]["#"],breakAfterClose:w});this.setRules("br",
{breakAfterOpen:w});this.setRules("title",{indent:u,breakAfterOpen:u});this.setRules("style",{indent:u,breakBeforeClose:w});this.setRules("pre",{indent:u})}var z=KISSY,C=z.Editor,H=C.Utils,w=true,u=false;z.extend(p,C.HtmlParser.BasicWriter,{openTag:function(A){var v=this._.rules[A];if(this._.indent)this.indentation();else if(v&&v.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",A)},openTagClose:function(A,v){var n=this._.rules[A];if(v)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(n&&n.indent)this._.indentation+=this.indentationChars}n&&n.breakAfterOpen&&this.lineBreak()},attribute:function(A,v){if(typeof v=="string"){this.forceSimpleAmpersand&&(v=v.replace(/&amp;/g,"&"));v=H.htmlEncodeAttr(v)}this._.output.push(" ",A,'="',v,'"')},closeTag:function(A){var v=this._.rules[A];if(v&&v.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(v&&v.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",A,">");v&&v.breakAfterClose&&this.lineBreak()},text:function(A){if(this._.indent){this.indentation();A=H.ltrim(A)}this._.output.push(A)},comment:function(A){this._.indent&&this.indentation();this._.output.push("<!--",A,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=w},indentation:function(){this._.output.push(this._.indentation);this._.indent=u},setRules:function(A,v){var n=this._.rules[A];if(n)H.mix(n,
v);else this._.rules[A]=v}});C.HtmlParser.HtmlWriter=p;C.HtmlParser.HtmlWriter=p;z=p.prototype;C.Utils.extern(z,{openTag:z.openTag,openTagClose:z.openTagClose,attribute:z.attribute,closeTag:z.closeTag,text:z.text,comment:z.comment,lineBreak:z.lineBreak,indentation:z.indentation,setRules:z.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function p(){this.children=[];this.parent=H;this._={isBlockLike:z,hasInlineStarted:C}}var z=true,C=false,H=null,w=KISSY.Editor,u={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},A=KISSY,v=w.Utils,n=w.NODE,f=w.XHTML_DTD,h=v.mix({table:1,ul:1,ol:1,dl:1},f.table,f.ul,f.ol,f.dl),e=f.$list,k=f.$listItem;p.FromHtml=function(x,j){function a(g){var q;if(r.length>0)for(var s=0;s<r.length;s++){var o=r[s],D=o.name,O=f[D],N=i.name&&f[i.name];
if((!N||N[D])&&(!g||!O||O[g]||!f[g])){if(!q){b();q=1}o=o.clone();o.parent=i;i=o;r.splice(s,1);s--}}}function b(){for(;l.length;)i.add(l.shift())}function d(g,q,s){q=q||i||y;if(j&&!q.type){var o,D;if((o=g.attributes&&(D=g.attributes._ke_real_element_type)?D:g.name)&&!(o in f.$body)&&!(o in f.$nonBodyContent)){o=i;i=q;m.onTagOpen(j,{});q=i;if(s)i=o}}if(g._.isBlockLike&&g.name!="pre"){s=g.children.length;if((o=g.children[s-1])&&o.type==n.NODE_TEXT)if(D=v.rtrim(o.value))o.value=D;else g.children.length=
s-1}q.add(g);if(g.returnPoint){i=g.returnPoint;delete g.returnPoint}}var m=new w.HtmlParser,y=new p,r=[],l=[],i=y,B=C,J;m.onTagOpen=function(g,q,s){var o=new w.HtmlParser.Element(g,q);if(o.isUnknown&&s)o.isEmpty=z;if(f.$removeEmpty[g])r.push(o);else{if(g=="pre")B=z;else if(g=="br"&&B){i.add(new w.HtmlParser.Text("\n"));return}if(g=="br")l.push(o);else{var D=i.name,O=D&&(f[D]||(i._.isBlockLike?f.div:f.span));if(O&&!o.isUnknown&&!i.isUnknown&&!O[g]){O=C;var N;if(g in e&&D in e){D=i.children;(D=D[D.length-
1])&&D.name in k||d(D=new w.HtmlParser.Element("li"),i);J=i;N=D}else if(g==D)d(i,i.parent);else{if(h[D])J||(J=i);else{d(i,i.parent,z);u[D]||r.unshift(i)}O=z}i=N?N:i.returnPoint||i.parent;if(O){m.onTagOpen.apply(this,arguments);return}}a(g);b();o.parent=i;o.returnPoint=J;J=0;if(o.isEmpty)d(o);else i=o}}};m.onTagClose=function(g){for(var q=r.length-1;q>=0;q--)if(g==r[q].name){r.splice(q,1);return}for(var s=[],o=[],D=i;D.type&&D.name!=g;){D._.isBlockLike||o.unshift(D);s.push(D);D=D.parent}if(D.type){for(q=
0;q<s.length;q++){var O=s[q];d(O,O.parent)}i=D;if(i.name=="pre")B=C;D._.isBlockLike&&b();d(D,D.parent);if(D==i)i=i.parent;r=r.concat(o)}if(g=="body")j=C};m.onText=function(g){if(!i._.hasInlineStarted&&!B){g=v.ltrim(g);if(g.length===0)return}b();a();if(j&&(!i.type||i.name=="body")&&v.trim(g))this.onTagOpen(j,{});B||(g=g.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));i.add(new w.HtmlParser.Text(g))};m.onCDATA=function(){};m.onComment=function(g){i.add(new w.HtmlParser.Comment(g))};m.parse(x);for(b();i.type;){var t=
i.parent,c=i;if(j&&(!t.type||t.name=="body")&&!f.$body[c.name]){i=t;m.onTagOpen(j,{});t=i}t.add(c);i=t}return y};A.augment(p,{add:function(x){var j=this.children.length;if(j=j>0&&this.children[j-1]||H){if(x._.isBlockLike&&j.type==n.NODE_TEXT){j.value=v.rtrim(j.value);if(j.value.length===0){this.children.pop();this.add(x);return}}j.next=x}x.previous=j;x.parent=this;this.children.push(x);this._.hasInlineStarted=x.type==n.NODE_TEXT||x.type==n.NODE_ELEMENT&&!x._.isBlockLike},writeHtml:function(x,j){var a;
this.filterChildren=this.filterChildren=function(){var b=new w.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,b,j,z);b=b.getHtml();this.children=(new p.FromHtml(b)).children;a=1};!this.name&&j&&j.onFragment(this);this.writeChildrenHtml(x,a?H:j)},writeChildrenHtml:function(x,j){for(var a=0;a<this.children.length;a++)this.children[a].writeHtml(x,j)}});w.HtmlParser.Fragment=p;w.HtmlParser.Fragment=p;p.FromHtml=p.FromHtml;A=p.prototype;w.Utils.extern(A,{add:A.add,writeHtml:A.writeHtml,writeChildrenHtml:A.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function p(u,A){this.name=u;this.attributes=A||(A={});this.children=[];var v=A._ke_real_element_type||u,n=z.XHTML_DTD;v=!!(n.$nonBodyContent[v]||n.$block[v]||n.$listItem[v]||n.$tableContent[v]||n.$nonEditable[v]||v=="br");var f=!!n.$empty[u];this.isEmpty=f;this.isUnknown=!n[u];this._={isBlockLike:v,hasInlineStarted:f||!v}}var z=KISSY.Editor,C=z.NODE,H=function(u,A){u=u[0];A=A[0];return u<A?-1:u>A?1:0};KISSY.augment(p,{type:C.NODE_ELEMENT,add:z.HtmlParser.Fragment.prototype.add,
clone:function(){return new p(this.name,this.attributes)},writeHtml:function(u,A){var v=this.attributes,n=this,f=n.name,h,e,k,x;n.filterChildren=function(){if(!x){var b=new z.HtmlParser.BasicWriter;z.HtmlParser.Fragment.prototype.writeChildrenHtml.call(n,b,A);n.children=(new z.HtmlParser.Fragment.FromHtml(b.getHtml())).children;x=1}};n.filterChildren=n.filterChildren;if(A){for(;;){if(!(f=A.onElementName(f)))return;n.name=f;if(!(n=A.onElement(n)))return;n.parent=this.parent;if(n.name==f)break;if(n.type!=
C.NODE_ELEMENT){n.writeHtml(u,A);return}f=n.name;if(!f){this.writeChildrenHtml.call(n,u,x?null:A);return}}v=n.attributes}u.openTag(f,v);for(var j=[],a=0;a<2;a++)for(h in v){e=h;k=v[h];if(a==1)j.push([h,k]);else if(A){for(;;)if(e=A.onAttributeName(h))if(e!=h){delete v[h];h=e}else break;else{delete v[h];break}if(e)if((k=A.onAttribute(n,e,k))===false)delete v[e];else v[e]=k}}u.sortAttributes&&j.sort(H);v=j.length;for(a=0;a<v;a++){h=j[a];u.attribute(h[0],h[1])}u.openTagClose(f,n.isEmpty);if(!n.isEmpty){this.writeChildrenHtml.call(n,
u,x?null:A);u.closeTag(f)}},writeChildrenHtml:function(){z.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});z.HtmlParser.Element=p;z.HtmlParser.Element=p;var w=p.prototype;z.Utils.extern(w,{type:w.type,add:w.add,clone:w.clone,writeHtml:w.writeHtml,writeChildrenHtml:w.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function p(h){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};h&&this.addRules(h,10)}function z(h,e){for(var k=0;h&&k<e.length;k++){var x=e[k];h=h.replace(x[0],x[1])}return h}function C(h,e,k){if(typeof e=="function")e=[e];var x,j;j=h.length;var a=e&&e.length;if(a){for(x=0;x<j&&h[x].pri<k;x++);for(j=a-1;j>=0;j--)if(a=e[j]){a.pri=k;h.splice(x,0,a)}}}function H(h,e,k){if(e)for(var x in e){var j=h[x];h[x]=w(j,e[x],
k);j||h.$length++}}function w(h,e,k){if(e){e.pri=k;if(h){if(h.splice)C(h,e,k);else{h=h.pri>k?[e,h]:[h,e];h.filter=u}return h}else return e.filter=e}}function u(h){for(var e=h.type||h instanceof v.HtmlParser.Fragment,k=0;k<this.length;k++){if(e)var x=h.type,j=h.name;var a=this[k].apply(window,arguments);if(a===f)return a;if(e){if(a&&(a.name!=j||a.type!=x))return a}else if(typeof a!="string")return a;a!=undefined&&(h=a)}return h}var A=KISSY,v=A.Editor,n=v.NODE,f=false;A.augment(p,{addRules:function(h,
e){if(typeof e!="number")e=10;C(this._.elementNames,h.elementNames,e);C(this._.attributeNames,h.attributeNames,e);H(this._.elements,h.elements,e);H(this._.attributes,h.attributes,e);this._.text=w(this._.text,h.text,e)||this._.text;this._.comment=w(this._.comment,h.comment,e)||this._.comment;this._.root=w(this._.root,h.root,e)||this._.root},onElementName:function(h){return z(h,this._.elementNames)},onAttributeName:function(h){return z(h,this._.attributeNames)},onText:function(h){var e=this._.text;
return e?e.filter(h):h},onComment:function(h,e){var k=this._.comment;return k?k.filter(h,e):h},onFragment:function(h){var e=this._.root;return e?e.filter(h):h},onElement:function(h){for(var e=[this._.elements["^"],this._.elements[h.name],this._.elements.$],k,x=0;x<3;x++)if(k=e[x]){k=k.filter(h,this);if(k===f)return null;if(k&&k!=h)return this.onNode(k);if(h.parent&&!h.name)break}return h},onNode:function(h){var e=h.type;return e==n.NODE_ELEMENT?this.onElement(h):e==n.NODE_TEXT?new v.HtmlParser.Text(this.onText(h.value)):
null},onAttribute:function(h,e,k){if(e=this._.attributes[e]){h=e.filter(k,h,this);if(h===f)return f;if(typeof h!="undefined")return h}return k}});v.HtmlParser.Filter=p;A=p.prototype;v.Utils.extern(A,{addRules:A.addRules,onElementName:A.onElementName,onAttributeName:A.onAttributeName,onText:A.onText,onComment:A.onComment,onFragment:A.onFragment,onElement:A.onElement,onNode:A.onNode,onAttribute:A.onAttribute});v.HtmlParser.Filter=p});
KISSY.Editor.add("htmlparser-text",function(){function p(w){this.value=w;this._={isBlockLike:H}}var z=KISSY,C=z.Editor,H=false;z.augment(p,{type:C.NODE.NODE_TEXT,writeHtml:function(w,u){var A=this.value;u&&!(A=u.onText(A,this))||w.text(A)}});C.HtmlParser.Text=p;C.HtmlParser.Text=p});
KISSY.Editor.add("htmlparser-comment",function(){function p(H){this.value=H;this._={isBlockLike:false}}var z=KISSY.Editor,C=z.NODE;z.HtmlParser.Comment=p;z.HtmlParser.Comment=p;p.prototype={constructor:p,type:C.NODE_COMMENT,writeHtml:function(H,w){var u=this.value;if(w){if(!(u=w.onComment(u,this)))return;if(typeof u!="string"){u.parent=this.parent;u.writeHtml(H,w);return}}H.comment(u)}}});
