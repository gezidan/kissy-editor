/*
 Constructor for kissy editor and module dependency definition
 thanks to CKSource's intelligent work on CKEditor
 @author: yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.0
 @buildtime: 2010-11-10 13:03:14
*/
KISSY.add("editor",function(q,B){function D(p,d){function a(v){for(var k=D.Env.mods,i=0;i<v.length;i++){for(var A=v[i],F=C,u=0;u<i;u++)if(A==v[u]){F=w;break}u=k[A];if(F&&u){F=q.clone(u);A=A+"_"+i;F.name=A;v[i]=A;k[A]||(k[A]=F)}}}var b=this;if(!(b instanceof D))return new D(p,d);if(q.isString(p))p=q.one(p);p=y._4e_wrap(p);d=d||{};d.pluginConfig=d.pluginConfig||{};b.cfg=d;d.pluginConfig=d.pluginConfig;b.cfg=d;q.app(b,q.EventTarget);var f=["htmldataprocessor","enterkey","clipboard"],m=C;b.use=function(v,
k){v=v.split(",");a(v);if(!m)for(var i=0;i<f.length;i++){var A=f[i];q.inArray(A,v)||v.unshift(A)}q.use.call(b,v.join(","),function(){b.ready(function(){k&&k.call(b);if(!m){b.setData(p.val());if(d.focus)b.focus();else{var F=b.getSelection();F&&F.removeAllRanges()}b.fire("save");m=w}})},{order:w,global:D});return b};b.use=b.use;b.init(p);return b}function H(p){var d=q.Config.debug;p=d?d==="dev"?"../src/"+p:p:p.replace(/\.(js|css)/i,"-min.$1");p+=p.indexOf("?")!=-1?"&":"?";p+="t="+encodeURIComponent("2010-11-10 13:03:14");
return p}var y=q.DOM,w=true,C=false;q.app(D,q.EventTarget);D.Config.base=q.Config.base+"editor/";var o=["separator","sourcearea/support","tabs","flashbridge","flashutils","clipboard",{name:"colorsupport",requires:["overlay"]},{name:"colorsupport/dialog"},{name:"forecolor",requires:["colorsupport"]},{name:"bgcolor",requires:["colorsupport"]},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},
{name:"flash",requires:["flash/support"]},{name:"flash/dialog"},{name:"flash/support",requires:["flashutils","contextmenu","fakeobjects","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor"},{name:"image",requires:["contextmenu","bubbleview"]},{name:"image/dialog",requires:["tabs"]},"indent","justify",{name:"link",requires:["bubbleview"]},{name:"link/dialog"},"list","maximize",{name:"music",requires:["flash/support"]},{name:"music/dialog",requires:["flash/dialog"]},
"preview","removeformat",{name:"smiley"},{name:"sourcearea",requires:["sourcearea/support"]},{name:"table",requires:["contextmenu"]},{name:"table/dialog"},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],e,j,l,g,t={};e=0;for(j=o.length;e<j;e++){l=o[e];if(q.isString(l))l=o[e]={name:l+"",requires:null};g=l.requires||[];var r=["button"];l.name.indexOf("/dialog")!=-1&&r.push("overlay");l.requires=g.concat(r)}o=[{name:"localStorage",requires:["flashutils","flashbridge"]},
{name:"button"},{name:"dd"},{name:"progressbar"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(o);e=0;for(j=o.length;e<j;e++){l=o[e];g=l.name;t[g]={attach:C,charset:"utf-8",requires:l.requires,csspath:l.useCss?H("plugins/"+g+"/plugin.css"):B,path:H("plugins/"+g+"/plugin.js")}}D.add(t);q.Editor=D;q.Editor=D});
KISSY.Editor.add("utils",function(q){var B=null,D=KISSY,H=D.Node,y=D.DOM,w=D.UA,C=D.Event,o={debugUrl:function(e){var j=D.Config.debug;e=j?j==="dev"?"../src/"+e:e:e.replace(/\.(js|css)/i,"-min.$1");e+=e.indexOf("?")!=-1?"&":"?";e+="t="+encodeURIComponent("2010-11-16 12:23:55");return e},lazyRun:function(e,j,l){var g=e[j],t=e[l];e[j]=function(){g.apply(this,arguments);e[j]=e[l];return t.apply(this,arguments)}},getXY:function(e,j,l,g){l=l.defaultView||l.parentWindow;e-=y.scrollLeft(l);j-=y.scrollTop(l);
if(g)if(l!=(g.defaultView||g.parentWindow)&&l.frameElement){g=y._4e_getOffset(l.frameElement,g);e+=g.left;j+=g.top}return{left:e,top:j}},tryThese:function(){for(var e,j=0,l=arguments.length;j<l;j++){var g=arguments[j];try{e=g();break}catch(t){}}return e},arrayCompare:function(e,j){if(!e&&!j)return true;if(!e||!j||e.length!=j.length)return false;for(var l=0;l<e.length;l++)if(e[l]!==j[l])return false;return true},getByAddress:function(e,j,l){e=e.documentElement;for(var g=0;e&&g<j.length;g++){var t=
j[g];if(l)for(var r=-1,p=0;p<e.childNodes.length;p++){var d=e.childNodes[p];if(!(l===true&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){r++;if(r==t){e=d;break}}}else e=e.childNodes[t]}return e?new H(e):B},clearAllMarkers:function(e){for(var j in e)e[j]._4e_clearMarkers(e,true)},htmlEncodeAttr:function(e){return e.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(e){return e.replace(/^\s+/,"")},rtrim:function(e){return e.replace(/\s+$/,"")},trim:function(e){return this.ltrim(this.rtrim(e))},
mix:function(){for(var e={},j=0;j<arguments.length;j++)e=D.mix(e,arguments[j]);return e},isCustomDomain:function(){if(!w.ie)return false;var e=document.domain,j=window.location.hostname;return e!=j&&e!="["+j+"]"},duplicateStr:function(e,j){return Array(j+1).join(e)},throttle:function(e,j,l){l=l||150;if(l===-1)return function(){e.apply(j,arguments)};var g=(new Date).getTime();return function(){var t=(new Date).getTime();if(t-g>l){g=t;e.apply(j,arguments)}}},buffer:function(e,j,l){l=l||0;var g=B;return function(){g&&
clearTimeout(g);var t=arguments;g=setTimeout(function(){return e.apply(j,t)},l)}},isNumber:function(e){return/^\d+(.\d+)?$/.test(D.trim(e))},verifyInputs:function(e){for(var j=0;j<e.length;j++){var l=y._4e_wrap(e[j]),g=D.trim(l.val()),t=l.attr("data-verify");l=l.attr("data-warning");if(t&&!RegExp(t).test(g)){alert(l);return false}}return true},sourceDisable:function(e,j){e.on("sourcemode",j.disable,j);e.on("wysiwygmode",j.enable,j)},resetInput:function(e){var j=e.attr("placeholder");if(j&&!w.webkit){e.addClass("ke-input-tip");
e.val(j)}else w.webkit&&e.val("")},valInput:function(e,j){e.removeClass("ke-input-tip");e.val(j)},placeholder:function(e,j){e.attr("placeholder",j);if(!w.webkit){e.on("focusout",function(){if(!D.trim(e.val())){e.addClass("ke-input-tip");e.val(j)}});e.on("focusin",function(){e.removeClass("ke-input-tip");D.trim(e.val())==j&&e.val("")})}},clean:function(e){e=e[0]||e;for(var j=D.makeArray(e.childNodes),l=0;l<j.length;l++){var g=j[l];g.nodeType==q.NODE.NODE_TEXT&&!D.trim(g.nodeValue)&&e.removeChild(g)}},
htmlEncode:function(e){return!e?e:String(e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(e){return!e?e:String(e).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(e,j){return e.toLowerCase()==j.toLowerCase()},normParams:function(e){e=D.clone(e);for(var j in e)if(e.hasOwnProperty(j)){var l=e[j];if(D.isFunction(l))e[j]=l()}return e},doFormUpload:function(e,j,l){function g(){var f=
{responseText:"",responseXML:B};f.argument=e?e.argument:B;try{var m;if((m=w.ie?r.contentWindow.document:r.contentDocument||window.frames[t].document)&&m.body)f.responseText=m.body.innerHTML;f.responseXML=m&&m.XMLDocument?m.XMLDocument:m}catch(v){D.log(v)}C.remove(r,"load",g);e.callback&&e.callback(f);setTimeout(function(){y._4e_remove(r)},100)}var t=D.guid("form-upload-"),r=document.createElement("iframe");r.id=t;r.name=t;r.className="ke-hidden";var p="document.open();"+(o.isCustomDomain()?'document.domain="'+
document.domain+'";':"")+"document.close();";if(w.ie)r.src=w.ie?"javascript:void(function(){"+encodeURIComponent(p)+"}())":"";D.log("doFormUpload : "+r.src);document.body.appendChild(r);if(w.ie)document.frames[t].name=t;p=y._4e_unwrap(e.form);var d={target:p.target,method:p.method,encoding:p.encoding,enctype:p.enctype,action:p.action};p.target=t;p.method="POST";p.enctype=p.encoding="multipart/form-data";if(l)p.action=l;var a;if(j){a=[];j=q.Utils.normParams(j);for(var b in j)if(j.hasOwnProperty(b)){l=
document.createElement("input");l.type="hidden";l.name=b;l.value=j[b];p.appendChild(l);a.push(l)}}C.on(r,"load",g);p.submit();p.target=d.target;p.method=d.method;p.enctype=d.enctype;p.encoding=d.encoding;p.action=d.action;if(a){j=0;for(b=a.length;j<b;j++)y._4e_remove(a[j])}return r},extern:function(e,j){for(var l in j)e[l]=j[l]},map:function(e,j){for(var l=0;l<e.length;l++)e[l]=j(e[l]);return e}};q.Utils=o;q.Utils=o;o.extern(o,{debugUrl:o.debugUrl,lazyRun:o.lazyRun,getXY:o.getXY,tryThese:o.tryThese,
arrayCompare:o.arrayCompare,getByAddress:o.getByAddress,clearAllMarkers:o.clearAllMarkers,htmlEncodeAttr:o.htmlEncodeAttr,ltrim:o.ltrim,rtrim:o.rtrim,trim:o.trim,mix:o.mix,isCustomDomain:o.isCustomDomain,duplicateStr:o.duplicateStr,buffer:o.buffer,isNumber:o.isNumber,verifyInputs:o.verifyInputs,sourceDisable:o.sourceDisable,resetInput:o.resetInput,placeholder:o.placeholder,clean:o.clean,htmlEncode:o.htmlEncode,htmlDecode:o.htmlDecode,equalsIgnoreCase:o.equalsIgnoreCase,normParams:o.normParams,throttle:o.throttle,
doFormUpload:o.doFormUpload,map:o.map})});
KISSY.Editor.add("focusmanager",function(q){function B(){this.iframeFocus=e;o=this}function D(){this.iframeFocus=j;o=l}var H=KISSY,y=H.DOM,w=H.Event,C={},o;H={refreshAll:function(){for(var g in C){var t=C[g];t.document.designMode="off";t.document.designMode="on"}},currentInstance:function(){return o},getInstance:function(g){return C[g]},add:function(g){var t=y._4e_getWin(g.document);w.on(t,"focus",B,g);w.on(t,"blur",D,g)},register:function(g){C[g._UUID]=g},remove:function(g){delete C[g._UUID];var t=
y._4e_getWin(g.document);w.remove(t,"focus",B,g);w.remove(t,"blur",D,g)}};var e=true,j=false,l=null;q.focusManager=H;q.focusManager=H;q.getInstances=function(){return C};q.getInstances=q.getInstances});
KISSY.Editor.add("definition",function(q){var B=true,D=false,H=document,y=KISSY,w=y.UA,C=y.DOM,o=y.Node,e=y.Event,j=q.focusManager,l=q.Utils.tryThese,g=q.Utils.debugUrl("theme/editor-iframe.css"),t=1,r="document.open();"+(q.Utils.isCustomDomain()?'document.domain="'+H.domain+'";':"")+"document.close();",p="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(w.ie?"javascript:void(function(){"+encodeURIComponent(r)+"}())":"")+'"  tabIndex="'+(w.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";q.SOURCE_MODE=0;q.WYSIWYG_MODE=1;q.SOURCE_MODE=q.SOURCE_MODE;q.WYSIWYG_MODE=q.WYSIWYG_MODE;y.augment(q,{init:function(d){if(w.ie)C.addClass(H.body,"ie"+w.ie);else if(w.gecko)C.addClass(H.body,"gecko");else w.webkit&&C.addClass(H.body,"webkit");var a=this,b=new o(p.replace(/\$\(tabIndex\)/,
d.attr("tabIndex")));b.on("mousedown",function(v){if(w.webkit){var k=C._4e_name(v.target);if(k=="select"||k=="option")return B}v.halt()});d.on("mousedown",function(v){v.stopPropagation()});a.editorWrap=b;a._UUID=t++;j.register(a);a.wrap=b.one(".ke-textarea-wrap");a.wrap=a.wrap;a.iframe=a.wrap.one("iframe");a.iframe=a.iframe;a.toolBarDiv=b.one(".ke-editor-tools");a.toolBarDiv=a.toolBarDiv;a.textarea=d;a.textarea=a.textarea;a.statusDiv=b.one(".ke-editor-status");a.statusDiv=a.statusDiv;a.toolBarDiv._4e_unselectable();
a._commands={};a._dialogs={};var f=d._4e_style("width"),m=d._4e_style("height");if(f){b.css("width",f);d.css("width","100%")}a.textarea.css("display","none");b.insertAfter(d);a.wrap[0].appendChild(d[0]);if(m){a.wrap.css("height",m);d.css("height","100%")}b=a.iframe;a.on("dataReady",function(){a._ready=B;q.fire("instanceCreated",{editor:a})});w.gecko?b.on("load",a._setUpIFrame,a):a._setUpIFrame();a.cfg.attachForm&&d[0].form&&a._attachForm()},_attachForm:function(){(new o(this.textarea[0].form)).on("submit",
this.sync,this)},useDialog:function(d,a){var b=this,f=q.SimpleOverlay;f.loading();b.use(d,function(){var m=b.getDialog(d);a(m);f.unloading()})},addDialog:function(d,a){this._dialogs[d]=a},getDialog:function(d){return this._dialogs[d]},addPlugin:function(d){this.ready(d)},addCommand:function(d,a){this._commands[d]=a},hasCommand:function(d){return this._commands[d]},execCommand:function(d){var a=this._commands[d],b=y.makeArray(arguments);b.shift();b.unshift(this);return a.exec.apply(a,b)},getMode:function(){return this.textarea.css("display")==
"none"?q.WYSIWYG_MODE:q.SOURCE_MODE},getData:function(d){var a;a=this.getMode()==q.WYSIWYG_MODE?this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)a=d?this.htmlDataProcessor.toHtml(a,"p"):this.htmlDataProcessor.toServer(a,"p");a=y.trim(a);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(a))a="";return a},setData:function(d){var a=d;if(this.htmlDataProcessor)a=this.htmlDataProcessor.toDataFormat(d,"p");this.document.body.innerHTML=a;this.getMode()!=q.WYSIWYG_MODE&&this.textarea.val(d)},sync:function(){this.textarea.val(this.getData())},
baseZIndex:function(d){d=d||0;return d+(this.cfg.baseZIndex||0)},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(d){this.document.body.innerHTML=d},_prepareIFrameHtml:function(d){var a=this.cfg,b=a.customLink,f="";if(b)for(var m=0;m<b.length;m++)f+='<link href="'+b[m]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+q.Config.base+g+"' rel='stylesheet'/><style>"+(a.customStyle||"")+"</style>"+f+"</head><body class='ke-editor'>&nbsp;"+
(d?'<script id="ke_actscript" type="text/javascript">'+(q.Utils.isCustomDomain()?'document.domain="'+H.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+d+'");<\/script>':"")+"</body></html>"},getSelection:function(){return q.Selection.getSelection(this.document)},focus:function(){var d=this.document,a=C._4e_getWin(d);w.webkit&&a&&a.parent&&a.parent.focus();a&&a.focus();d&&d.body.focus();this.notifySelectionChange()},blur:function(){C._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},
addCustomStyle:function(d){var a=this.cfg,b=this.document;a.customStyle=a.customStyle||"";a.customStyle+="\n"+d;a=b.createElement("style");b.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=d;else a.appendChild(b.createTextNode(d))},addCustomLink:function(d){var a=this.cfg,b=this.document;a.customLink=a.customLink||[];a.customLink.push(d);a=b.createElement("link");a.rel="stylesheet";b.getElementsByTagName("head")[0].appendChild(a);a.href=d},removeCustomLink:function(d){for(var a=
this.cfg,b=y.makeArray(this.document.getElementsByTagName("link")),f=0;f<b.length;f++)b[f].href==d&&C._4e_remove(b[f]);a.customLink=a.customLink||[];a=a.customLink;d=y.indexOf(d,a);d!=-1&&a.splice(d,1)},_setUpIFrame:function(){function d(){v=m.document;a.document=v;b.detach();v.open("text/html","replace");v.write(f);v.close()}var a=this,b=a.iframe,f=a._prepareIFrameHtml(a._UUID),m=b[0].contentWindow,v;try{v=m.document}catch(k){b[0].src=b[0].src;if(w.ie<7){setTimeout(d,10);return}}d()},ready:function(d){this._ready?
d():this.on("dataReady",d)},_monitor:function(){var d=this;d._monitorId&&clearTimeout(d._monitorId);d._monitorId=setTimeout(function(){var a=d.getSelection();if(a&&!a.isInvalid){var b=a.getStartElement(),f=new q.ElementPath(b);if(!d.previousPath||!d.previousPath.compare(f)){d.previousPath=f;d.fire("selectionChange",{selection:a,path:f,element:b})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(d,a){var b=this;b.focus();var f=d._4e_name(),m=
q.XHTML_DTD,v=q.RANGE,k=q.NODE,i=m.$block[f],A=b.getSelection(),F=A&&A.getRanges(),u,c,h,n,x;if(!F||F.length==0){var s=arguments,E=s.callee;setTimeout(function(){E.apply(b,s)},30)}else{b.fire("save");for(var O=F.length-1;O>=0;O--){u=F[O];u.deleteContents();c=!O&&d||d._4e_clone(B);a&&a(c);if(i)for(;(n=u.getCommonAncestor(D,B))&&(x=m[n._4e_name()])&&!(x&&x[f]);)if(n._4e_name()in m.span)u.splitElement(n);else if(u.checkStartOfBlock()&&u.checkEndOfBlock()){u.setStartBefore(n);u.collapse(B);n._4e_remove()}else u.splitBlock();
u.insertNode(c);h||(h=c)}if(h){f=h._4e_nextSourceNode(B);m=b.document;x=q.XHTML_DTD;if(x.$inline[c._4e_name()]){f=new o(m.createTextNode(" "));f.insertAfter(h)}else if(f){if(f._4e_name()=="br"&&x[f.parent()._4e_name()].p){x=new o("<p>&nbsp;</p>",null,m);f[0].parentNode.replaceChild(x[0],f[0]);f=x}}else{x=new o("<p>&nbsp;</p>",null,m);x.insertAfter(h);f=x}u.moveToPosition(h,v.POSITION_AFTER_END);f&&f[0].nodeType==k.NODE_ELEMENT&&u.moveToElementEditablePosition(f);A.selectRanges([u]);b.focus();c&&c._4e_scrollIntoView();
setTimeout(function(){b.fire("save")},10);return c}}},insertHtml:function(d){var a=this;if(a.htmlDataProcessor)d=a.htmlDataProcessor.toDataFormat(d);if(w.webkit){var b=C.create(d,null,this.document);b=b.nodeType==11?y.makeArray(b.childNodes):[b];for(var f=0;f<b.length;f++)a.insertElement(new o(b[f]))}else{a.focus();f=(b=a.getSelection())&&b.getRanges();if(!f||f.length==0){var m=arguments,v=m.callee;setTimeout(function(){v.apply(a,m)},30)}else{a.fire("save");if(w.ie){b=b.getNative();b.type=="Control"&&
b.clear();b.createRange().pasteHTML(d)}else a.document.execCommand("inserthtml",D,d);a.focus();setTimeout(function(){a.fire("save")},10)}}}});q._initIFrame=function(d){function a(c){l(function(){m.designMode="on";setTimeout(function(){m.designMode="off";i.focus();if(!arguments.callee.retry)arguments.callee.retry=B},50)},function(){m.designMode="off";C.attr(i,"contentEditable",D);C.attr(i,"contentEditable",B);!c&&a(1)})}var b=j.getInstance(d);d=b.textarea[0];var f=b.iframe[0].contentWindow,m=b.document,
v=b.cfg,k=m.getElementById("ke_actscript");C._4e_remove(k);var i=m.body;if(w.ie){i.hideFocus=B;i.disabled=B;i.contentEditable=B;i.removeAttribute("disabled")}else setTimeout(function(){if(w.gecko||w.opera)i.contentEditable=B;else if(w.webkit)i.parentNode.contentEditable=B;else m.designMode="on"},0);if(w.webkit){e.on(m,"click",function(c){var h=new o(c.target);y.inArray(h._4e_name(),["input","select"])&&c.preventDefault()});e.on(m,"mouseup",function(c){var h=new o(c.target);y.inArray(h._4e_name(),
["input","textarea"])&&c.preventDefault()})}if(w.gecko||w.ie||w.opera){var A;A=new o(C.insertAfter((new o('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],d));A.on("focus",function(){b.focus()});b.activateGecko=function(){w.gecko&&b.iframeFocus&&A[0].focus()};b.on("destroy",function(){})}if(w.ie&&m.compatMode=="CSS1Compat"||w.gecko||w.opera){var F=new o(m.documentElement);F.on("mousedown",function(c){if(c.target==F[0]){w.gecko&&a(D);A[0].focus()}})}e.on(f,
"focus",function(){if(w.gecko)a(D);else w.opera&&i.focus();b.notifySelectionChange()});w.gecko&&e.on(b.document,"mousedown",function(){b.iframeFocus||a(D)});if(w.ie){e.on(m,"keydown",function(c){if(c.keyCode in{8:1,46:1}){var h=b.getSelection(),n=h.getSelectedElement();if(n){b.fire("save");var x=h.getRanges()[0].createBookmark();n._4e_remove();h.selectBookmarks([x]);b.fire("save");c.preventDefault()}}});if(m.compatMode=="CSS1Compat"){var u={33:1,34:1};e.on(m,"keydown",function(c){c.keyCode in u&&
setTimeout(function(){b.getSelection().scrollIntoView()},0)})}}setTimeout(function(){w.ie&&setTimeout(function(){if(m){i.runtimeStyle.marginBottom="0px";i.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){b.fire("dataReady");var c=v.disableObjectResizing,h=v.disableInlineTableEditing;if(c||h)try{m.execCommand("enableObjectResizing",D,!c);m.execCommand("enableInlineTableEditing",D,!h)}catch(n){e.on(i,w.ie?"resizestart":"resize",function(x){if(c||C._4e_name(x.target)==="table"&&h)x.preventDefault()})}},
10);w.webkit&&e.on(m,"mousedown",function(c){c=new o(c.target);y.inArray(c._4e_name(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});w.gecko&&e.on(m,"dragstart",function(c){var h=new o(c.target);h._4e_name()==="img"&&/ke_/.test(h[0].className)&&c.preventDefault()});j.add(b)};r=q.prototype;q.Utils.extern(r,{setData:r.setData,getData:r.getData,insertElement:r.insertElement,insertHtml:r.insertHtml,ready:r.ready,addCustomStyle:r.addCustomStyle,addCommand:r.addCommand,hasCommand:r.hasCommand,
execCommand:r.execCommand,addPlugin:r.addPlugin,useDialog:r.useDialog,addDialog:r.addDialog,getDialog:r.getDialog,getMode:r.getMode,sync:r.sync,baseZIndex:r.baseZIndex,getSelection:r.getSelection,focus:r.focus,blur:r.blur,notifySelectionChange:r.notifySelectionChange})});
KISSY.Editor.add("zindex",function(){var q=KISSY.Editor;if(!q.zIndexManager){q.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};q.baseZIndex=function(B){var D=B,H=q.getInstances(),y;for(y in H){if(!H.hasOwnProperty(y))return;D=Math.max(D,H[y].baseZIndex(B))}return D};q.baseZIndex=q.baseZIndex;q.zIndexManager=q.zIndexManager}});
KISSY.Editor.add("dtd",function(q){q.XHTML_DTD=function(){function B(k){for(var i=arguments.length-1;i>0;)KISSY.mix(k,arguments[i--]);return k}var D={isindex:1,fieldset:1},H={input:1,button:1,select:1,textarea:1,label:1},y=B({a:1},H),w=B({iframe:1},y),C={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},o={ins:1,del:1,script:1,style:1},e=B({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},o),j=B({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},e),l=B({p:1},j);H=B({iframe:1},j,H);j={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var g=B({a:1},H),t={tr:1},r={"#":1},p=B({param:1},j),d=B({form:1},D,w,C,l),a={li:1},b={base:1,link:1,meta:1,title:1},f=B(b,{style:1,script:1}),m={head:1,body:1},v={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:B({html:1},m,b),$block:v,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:g,$body:B({script:1,style:1},v),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:m,head:f,style:r,body:d,base:{},link:{},meta:{},title:r,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:d,td:d,br:{},th:d,center:d,kbd:g,button:B(l,C),basefont:{},h5:g,h4:g,samp:g,h6:g,ol:a,h1:g,h3:g,option:r,h2:g,form:B(D,w,C,l),select:{optgroup:1,option:1},font:g,ins:g,menu:a,abbr:g,label:g,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:g,script:r,tfoot:t,cite:g,li:d,input:{},iframe:d,strong:g,textarea:r,noframes:d,big:g,small:g,span:g,hr:{},dt:g,sub:g,optgroup:{option:1},param:{},bdo:g,"var":g,div:d,object:p,sup:g,dd:d,strike:g,area:{},dir:a,map:B({area:1,form:1,p:1},D,o,C),applet:p,dl:{dt:1,dd:1},del:g,isindex:{},fieldset:B({legend:1},j),thead:t,ul:a,acronym:g,b:g,a:H,blockquote:d,caption:g,i:g,u:g,tbody:t,s:g,address:B(w,l),tt:g,legend:g,q:g,pre:B(e,y),p:g,em:g,dfn:g}}();q.XHTML_DTD=
q.XHTML_DTD});
KISSY.Editor.add("dom",function(q){function B(a){return a.replace(/-(\w)/g,function(b,f){return f.toUpperCase()})}var D=KISSY,H=D.DOM,y=D.UA,w=D.Node,C=q.Utils,o={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};q.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};q.NODE=q.NODE;q.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};q.POSITION=q.POSITION;var e=q.NODE,j=q.POSITION,l={},g={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},t={hr:1},r=function(a){return a[0]||a},p=function(a){if(a&&!a[0])return new w(a);return a},d={_4e_wrap:p,_4e_unwrap:r,_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=r(a);
b=r(b);return a===b},_4e_isBlockBoundary:function(a,b){a=p(a);var f=D.mix(D.mix({},t),b||{});return g[a.css("display")]||f[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=r(a);for(var b=a.parentNode.childNodes,f=0;f<b.length;f++)if(b[f]===a)return f;return-1},_4e_first:function(a,b){a=r(a);var f=a.firstChild;if((f=f&&new w(f))&&b&&!b(f))f=f._4e_next(b);return f},_4e_move:function(a,b,f){a=r(a);
H._4e_remove(a);b=r(b);f?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_name:function(a){a=r(a);var b=a.nodeName.toLowerCase();if(y.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var f=a[0].attributes,m=b[0].attributes,v=f.length,k=m.length;if(!y.ie&&v!=k)return false;for(var i=0;i<v;i++){var A=f[i];if((!y.ie||A.specified&&A.nodeName!="_ke_expando")&&A.nodeValue!=b.attr(A.nodeName))return false}if(y.ie)for(i=
0;i<k;i++){A=m[i];if(A.specified&&A.nodeName!="_ke_expando"&&A.nodeValue!=a.attr(A.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=r(a).childNodes;for(var b=0,f=a.length;b<f;b++){var m=a[b],v=m.nodeType;if(!(v==e.NODE_ELEMENT&&m.getAttribute("_ke_bookmark")))if(v==e.NODE_ELEMENT&&!d._4e_isEmptyInlineRemoveable(m)||v==e.NODE_TEXT&&D.trim(m.nodeValue))return false}return true},_4e_moveChildren:function(a,b,f){a=r(a);b=b[0]||b;if(a!=b)if(f)for(;f=a.lastChild;)b.insertBefore(a.removeChild(f),
b.firstChild);else for(;f=a.firstChild;)b.appendChild(a.removeChild(f))},_4e_mergeSiblings:function(){function a(b,f,m){if(f[0]&&f[0].nodeType==e.NODE_ELEMENT){for(var v=[];f.attr("_ke_bookmark")||f._4e_isEmptyInlineRemoveable();){v.push(f);f=m?new w(f[0].nextSibling):new w(f[0].previousSibling);if(!f[0]||f[0].nodeType!=e.NODE_ELEMENT)return}if(b._4e_isIdentical(f)){for(var k=m?b[0].lastChild:b[0].firstChild;v.length;)v.shift()._4e_move(b,!m);f._4e_moveChildren(b,!m);f._4e_remove();k[0]&&k[0].nodeType==
e.NODE_ELEMENT&&k._4e_mergeSiblings()}}}return function(b){if(b[0])if(o[b._4e_name()]||b._4e_name()=="a"){a(b,new w(b[0].nextSibling),true);a(b,new w(b[0].previousSibling))}}}(),_4e_unselectable:y.gecko?function(a){a=r(a);a.style.MozUserSelect="none"}:y.webkit?function(a){a=r(a);a.style.KhtmlUserSelect="none"}:function(a){a=r(a);if(y.ie||y.opera){var b,f=0;for(a.unselectable="on";b=a.all[f++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable=
"on"}}},_4e_getOffset:function(a,b){a=r(a);var f,m=0;f=0;var v=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,k=a.ownerDocument,i=k.documentElement;b=b||k;if(a.getBoundingClientRect){if(a!==k.body&&i!==a){f=a.getBoundingClientRect();m=f.left+(b===k?H.scrollLeft(v):0);f=f.top+(b===k?H.scrollTop(v):0)}if(b)if(v!=(b.defaultView||b.parentWindow)&&v.frameElement){v=d._4e_getOffset(v.frameElement,b);m+=v.left;f+=v.top}}return{left:m,top:f}},_4e_getFrameDocument:function(a){return(a=r(a))&&a.contentWindow.document},
_4e_splitText:function(a,b){a=r(a);var f=a.ownerDocument;if(!(!a||a.nodeType!=e.NODE_TEXT)){if(y.ie&&b==a.nodeValue.length){var m=f.createTextNode("");H.insertAfter(m,a);return new w(m)}m=new w(a.splitText(b));if(f.documentMode){f=f.createTextNode("");H.insertAfter(f,m[0]);H._4e_remove(f)}return m}},_4e_parents:function(a,b){a=p(a);var f=[];do f[b?"push":"unshift"](a);while(a=a.parent());return f},_4e_clone:function(a,b,f){a=r(a);a=a.cloneNode(b);if(!f){var m=function(v){if(v.nodeType==e.NODE_ELEMENT){v.removeAttribute("id",
false);v.removeAttribute("_ke_expando",false);v=v.childNodes;for(var k=0;k<v.length;k++)m(v[k])}};m(a)}return new w(a)},_4e_nextSourceNode:function(a,b,f,m){a=r(a);if(m&&!m.call){var v=m[0]||m;m=function(i){i=i[0]||i;return i!==v}}b=!b&&a.firstChild;var k=new w(a);if(!b){if(a.nodeType==e.NODE_ELEMENT&&m&&m(a,true)===false)return null;b=a.nextSibling}for(;!b&&(k=k.parent());){if(m&&m(k,true)===false)return null;b=k[0].nextSibling}if(!b)return null;b=H._4e_wrap(b);if(m&&m(b)===false)return null;if(f&&
f!=b[0].nodeType)return b._4e_nextSourceNode(false,f,m);return b},_4e_previousSourceNode:function(a,b,f,m){a=r(a);if(m&&!m.call){var v=m[0]||m;m=function(i){i=i[0]||i;return i!==v}}b=!b&&a.lastChild;var k=new w(a);if(!b){if(a.nodeType==e.NODE_ELEMENT&&m&&m(a,true)===false)return null;b=a.previousSibling}for(;!b&&(k=k.parent());){if(m&&m(k,true)===false)return null;b=k[0].previousSibling}if(!b)return null;b=H._4e_wrap(b);if(m&&m(b)===false)return null;if(f&&b[0].nodeType!=f)return b._4e_previousSourceNode(false,
f,m);return b},_4e_contains:y.ie||y.webkit?function(a,b){a=r(a);b=r(b);return b.nodeType!=e.NODE_ELEMENT?a.contains(b.parentNode):a!=b&&a.contains(b)}:function(a,b){a=r(a);b=r(b);return!!(a.compareDocumentPosition(b)&16)},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=e.NODE_TEXT&&b._4e_contains(a))return b;var f=a[0].nodeType==e.NODE_TEXT?a.parent():a;do if(f[0].nodeType!=e.NODE_TEXT&&f._4e_contains(b))return f;while(f=f.parent());return null},_4e_ascendant:function(a,
b,f){a=r(a);if(!f)a=a.parentNode;if(b&&!D.isFunction(b)){var m=b;b=function(v){return v._4e_name()==m}}for(;a&&a.nodeType!=9;){if(!b||b(new w(a))===true)return new w(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,b){a=r(a);var f=a.attributes.getNamedItem(b);return!!(f&&f.specified)},_4e_hasAttributes:y.ie?function(a){a=r(a);for(var b=a.attributes,f=0;f<b.length;f++){var m=b[f];switch(m.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(m.specified)return true}}return false}:
function(a){a=r(a);y.gecko&&a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,b){var f=r(a),m=r(b);if(f.compareDocumentPosition)return f.compareDocumentPosition(m);if(f==m)return j.POSITION_IDENTICAL;if(f.nodeType==e.NODE_ELEMENT&&m.nodeType==e.NODE_ELEMENT){if(f.contains){if(f.contains(m))return j.POSITION_CONTAINS+j.POSITION_PRECEDING;if(m.contains(f))return j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING}if("sourceIndex"in
f)return f.sourceIndex<0||m.sourceIndex<0?j.POSITION_DISCONNECTED:f.sourceIndex<m.sourceIndex?j.POSITION_PRECEDING:j.POSITION_FOLLOWING}f=a._4e_address();m=b._4e_address();for(var v=Math.min(f.length,m.length),k=0;k<=v-1;k++)if(f[k]!=m[k]){if(k<v)return f[k]<m[k]?j.POSITION_PRECEDING:j.POSITION_FOLLOWING;break}return f.length<m.length?j.POSITION_CONTAINS+j.POSITION_PRECEDING:j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING},_4e_address:function(a,b){a=r(a);for(var f=[],m=a.ownerDocument.documentElement,
v=a;v&&v!=m;){var k=v.parentNode,i=-1;if(k){for(var A=0;A<k.childNodes.length;A++){var F=k.childNodes[A];if(!(b&&F.nodeType==3&&F.previousSibling&&F.previousSibling.nodeType==3)){i++;if(F==v)break}}f.unshift(i)}v=k}return f},_4e_breakParent:function(a,b){var f=new q.Range(a[0].ownerDocument);f.setStartAfter(a);f.setEndAfter(b);var m=f.extractContents();f.insertNode(a._4e_remove());a[0].parentNode.insertBefore(m,a[0].nextSibling)},_4e_style:function(a,b,f){a=p(a);if(f!==undefined)return a.css(b,f);
a=r(a);return a.style[B(b)]},_4e_remove:function(a,b){var f=r(a),m=f.parentNode;if(m){if(b)for(var v;v=f.firstChild;)m.insertBefore(f.removeChild(v),f);m.removeChild(f)}return a},_4e_trim:function(a){H._4e_ltrim(a);H._4e_rtrim(a)},_4e_ltrim:function(a){a=r(a);for(var b;b=a.firstChild;){if(b.nodeType==e.NODE_TEXT){var f=C.ltrim(b.nodeValue),m=b.nodeValue.length;if(f){if(f.length<m){(new w(b))._4e_splitText(m-f.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=
r(a);for(var b;b=a.lastChild;){if(b.type==e.NODE_TEXT){var f=C.rtrim(b.nodeValue),m=b.nodeValue.length;if(f){if(f.length<m){(new w(b))._4e_splitText(f.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!y.ie&&!y.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=r(a);for(var b=a.lastChild;b&&b.nodeType==e.NODE_TEXT&&!D.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==e.NODE_TEXT||H._4e_name(b)!==
"br"){b=y.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");y.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){var f=r(a),m;do m=(f=f.previousSibling)&&new w(f);while(m&&b&&!b(m));return m},_4e_last:function(a,b){a=H._4e_wrap(a);var f=a[0].lastChild;if((f=f&&new w(f))&&b&&!b(f))f=f._4e_previous(b);return f},_4e_next:function(a,b){var f=r(a),m;do m=(f=f.nextSibling)&&new w(f);while(m&&b&&!b(m));return m},_4e_outerHtml:function(a){a=r(a);
if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,f,m){a=H._4e_wrap(a);var v=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",D.guid())._4e_getData("list_marker_id"),k=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");b[v]=a;k[f]=1;return a._4e_setData(f,m)},_4e_clearMarkers:function(a,b,f){a=p(a);
var m=a._4e_getData("list_marker_names"),v=a._4e_getData("list_marker_id"),k;for(k in m)a._4e_removeData(k);a._4e_removeData("list_marker_names");if(f){a._4e_removeData("list_marker_id");delete b[v]}},_4e_setData:function(a,b,f){var m=H._4e_getUniqueId(a);(l[m]||(l[m]={}))[b]=f;return a},_4e_getData:function(a,b){a=r(a);var f=a.getAttribute("_ke_expando");return(f=f&&l[f])&&f[b]},_4e_removeData:function(a,b){a=r(a);var f=a.getAttribute("_ke_expando");var m=(f=f&&l[f])&&f[b];typeof m!="undefined"&&
f&&delete f[b];D.isEmptyObject(f)&&H._4e_clearData(a);return m||null},_4e_clearData:function(a){a=r(a);var b=a.getAttribute("_ke_expando");b&&delete l[b];b&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=r(a);var b=a.getAttribute("_ke_expando");if(b)return b;b=D.guid();a.setAttribute("_ke_expando",b);return b},_4e_copyAttributes:function(a,b,f){a=r(a);b=p(b);var m=a.attributes;f=f||{};for(var v=0;v<m.length;v++){var k=m[v],i=k.nodeName.toLowerCase(),A;if(!(i in f))if(i=="checked"&&
(A=H.attr(a,i)))b.attr(i,A);else if(k.specified||y.ie&&k.nodeValue&&i=="value"){A=H.attr(a,i);if(A===null)A=k.nodeValue;b.attr(i,A)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=H._4e_name(a);var b=q.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=p(a);var b=a[0].ownerDocument,f=H.scrollLeft(b),m=H.scrollTop(b),v=a.offset(),k=v.left;v=v.top;if(H.viewportHeight(b)+m<v||v<m||H.viewportWidth(b)+f<k||k<f)a.scrollIntoView(b)},
_4e_getElementsByTagName:function(a,b,f){a=r(a);if(!y.ie&&f)b=f+":"+b;f=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)f.push(new w(a[b]));return f}};D.DOM._4e_inject=function(a){D.mix(H,a);for(var b in a)a.hasOwnProperty(b)&&function(f){w.prototype[f]=function(){var m=[].slice.call(arguments,0);m.unshift(this);return a[f].apply(null,m)}}(b)};C.extern(d,{_4e_wrap:d._4e_wrap,_4e_unwrap:d._4e_unwrap,_4e_equals:d._4e_equals,_4e_isBlockBoundary:d._4e_isBlockBoundary,_4e_getWin:d._4e_getWin,_4e_index:d._4e_index,
_4e_first:d._4e_first,_4e_move:d._4e_move,_4e_name:d._4e_name,_4e_isIdentical:d._4e_isIdentical,_4e_isEmptyInlineRemoveable:d._4e_isEmptyInlineRemoveable,_4e_moveChildren:d._4e_moveChildren,_4e_mergeSiblings:d._4e_mergeSiblings,_4e_unselectable:d._4e_unselectable,_4e_getOffset:d._4e_getOffset,_4e_getFrameDocument:d._4e_getFrameDocument,_4e_splitText:d._4e_splitText,_4e_parents:d._4e_parents,_4e_clone:d._4e_clone,_4e_nextSourceNode:d._4e_nextSourceNode,_4e_previousSourceNode:d._4e_previousSourceNode,
_4e_contains:d._4e_contains,_4e_commonAncestor:d._4e_commonAncestor,_4e_ascendant:d._4e_ascendant,_4e_hasAttribute:d._4e_hasAttribute,_4e_hasAttributes:d._4e_hasAttributes,_4e_position:d._4e_position,_4e_address:d._4e_address,_4e_breakParent:d._4e_breakParent,_4e_style:d._4e_style,_4e_remove:d._4e_remove,_4e_trim:d._4e_trim,_4e_ltrim:d._4e_ltrim,_4e_rtrim:d._4e_rtrim,_4e_appendBogus:d._4e_appendBogus,_4e_last:d._4e_last,_4e_previous:d._4e_previous,_4e_next:d._4e_next,_4e_outerHtml:d._4e_outerHtml,
_4e_setMarker:d._4e_setMarker,_4e_clearMarkers:d._4e_clearMarkers,_4e_setData:d._4e_setData,_4e_getData:d._4e_getData,_4e_removeData:d._4e_removeData,_4e_clearData:d._4e_clearData,_4e_removeData:d._4e_removeData,_4e_getUniqueId:d._4e_getUniqueId,_4e_copyAttributes:d._4e_copyAttributes,_4e_isEditable:d._4e_isEditable,_4e_scrollIntoView:d._4e_scrollIntoView,_4e_getElementsByTagName:d._4e_getElementsByTagName});H._4e_inject(d)});
KISSY.Editor.add("elementpath",function(q){function B(j){var l=w,g=w,t=[];for(j=j;j&&j[0];){if(j[0].nodeType==y.NODE_ELEMENT){if(!this.lastElement)this.lastElement=j;var r=j._4e_name();if(!g){if(!l&&C[r])l=j;if(o[r]){var p;if(p=!l){if(p=r=="div"){a:{p=j;p=p[0]||p;p=p.childNodes;for(var d=0,a=p.length;d<a;d++){var b=p[d];if(b.nodeType==y.NODE_ELEMENT&&H.$block[b.nodeName.toLowerCase()]){p=true;break a}}p=false}p=!p}p=p}if(p)l=j;else g=j}}t.push(j);if(r=="body")break}j=j.parent()}this.block=this.block=
l;this.blockLimit=this.blockLimit=g;this.elements=this.elements=t}var D=KISSY.DOM,H=q.XHTML_DTD,y=q.NODE,w=null,C={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},o={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};B.prototype={compare:function(j){var l=this.elements;j=j&&j.elements;if(!j||l.length!=j.length)return false;for(var g=0;g<l.length;g++)if(!D._4e_equals(l[g],j[g]))return false;return true},contains:function(j){for(var l=this.elements,g=0;g<
l.length;g++)if(l[g]._4e_name()in j)return l[g];return w}};q.ElementPath=q.ElementPath=B;var e=B.prototype;q.Utils.extern(e,{compare:e.compare,contains:e.contains})});
KISSY.Editor.add("walker",function(q){function B(t,r){if(this._.end)return C;var p,d=this.range,a,b=this.guard,f=this.type,m=t?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;d.trim();if(d.collapsed){this.end();return C}}if(!t&&!this._.guardLTR){var v=d.endContainer,k=new l(v[0].childNodes[d.endOffset]);this._.guardLTR=function(u,c){return(u=j._4e_wrap(u))&&u[0]&&(!c||!j._4e_equals(v,u))&&(!k[0]||!u._4e_equals(k))&&(u[0].nodeType!=e.NODE_ELEMENT||!c||u._4e_name()!="body")}}if(t&&
!this._.guardRTL){var i=d.startContainer,A=d.startOffset>0&&new l(i[0].childNodes[d.startOffset-1]);this._.guardRTL=function(u,c){return(u=j._4e_wrap(u))&&u[0]&&(!c||!u._4e_equals(i))&&(!A[0]||!u._4e_equals(A))&&(u[0].nodeType!=e.NODE_ELEMENT||!c||u._4e_name()!="body")}}var F=t?this._.guardRTL:this._.guardLTR;a=b?function(u,c){if(F(u,c)===w)return w;return b(u,c)}:F;if(this.current)p=this.current[m](w,f,a);else if(t){p=d.endContainer;if(d.endOffset>0){p=new l(p[0].childNodes[d.endOffset-1]);if(a(p)===
w)p=C}else p=a(p,y)===w?C:p._4e_previousSourceNode(y,f,a)}else{p=d.startContainer;if((p=new l(p[0].childNodes[d.startOffset]))&&p[0]){if(a(p)===w)p=C}else p=a(d.startContainer,y)===w?C:d.startContainer._4e_nextSourceNode(y,f,a)}for(;p&&p[0]&&!this._.end;){this.current=p;if(!this.evaluator||this.evaluator(p)!==w){if(!r)return p}else if(r&&this.evaluator)return w;p=p[m](w,f,a)}this.end();return this.current=C}function D(t){for(var r,p=C;r=B.call(this,t);)p=r;return p}function H(t){this.range=t;this._=
{}}var y=true,w=false,C=null,o=KISSY,e=q.NODE,j=o.DOM,l=o.Node;o.augment(H,{end:function(){this._.end=1},next:function(){return B.call(this)},previous:function(){return B.call(this,y)},checkForward:function(){return B.call(this,w,y)!==w},checkBackward:function(){return B.call(this,y,y)!==w},lastForward:function(){return D.call(this)},lastBackward:function(){return D.call(this,y)},reset:function(){delete this.current;this._={}}});H.blockBoundary=function(t){return function(r){r=j._4e_wrap(r);return!(r&&
r[0].nodeType==e.NODE_ELEMENT&&r._4e_isBlockBoundary(t))}};H.listItemBoundary=function(){return this.blockBoundary({br:1})};H.bookmark=function(t,r){function p(d){return d&&d[0]&&d._4e_name()=="span"&&d.attr("_ke_bookmark")}return function(d){var a,b;a=d&&d[0]&&d[0].nodeType==e.NODE_TEXT&&(b=d.parent())&&p(b);a=t?a:a||p(d);return r^a}};H.whitespaces=function(t){return function(r){r=(r=r[0]||r)&&r.nodeType==e.NODE_TEXT&&!o.trim(r.nodeValue);return t^r}};H.invisible=function(t){var r=H.whitespaces();
return function(p){p=r(p)||p[0].nodeType==e.NODE_ELEMENT&&!p[0].offsetHeight;return t^p}};q.Walker=H;q.Walker=H;var g=H.prototype;q.Utils.extern(g,{end:g.end,next:g.next,previous:g.previous,checkForward:g.checkForward,checkBackward:g.checkBackward,lastForward:g.lastForward,lastBackward:g.lastBackward,reset:g.reset});q.Utils.extern(H,{blockBoundary:H.blockBoundary,listItemBoundary:H.listItemBoundary,bookmark:H.bookmark,whitespaces:H.whitespaces,invisible:H.invisible})});
KISSY.Editor.add("range",function(q){function B(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=j;this.collapsed=o;this.document=c}function D(c){var h=c[0].nodeType!=g.NODE_TEXT&&c._4e_name()in f.$removeEmpty,n=!l.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return h||n||c}function H(c){return!A(c)&&!F(c)}function y(c){var h=e,n=p.bookmark(o);return function(x){if(n(x))return o;if(x[0].nodeType==g.NODE_TEXT){if(l.trim(x[0].nodeValue).length)return e}else if(x[0].nodeType==
g.NODE_ELEMENT)if(!i[x._4e_name()])if(!c&&!b.ie&&x._4e_name()=="br"&&!h)h=o;else return e;return o}}function w(c,h){function n(x){return x&&x.nodeName=="span"&&x.getAttribute("_ke_bookmark")}return function(x){var s,E;s=x&&!x.nodeName&&(E=x.parentNode)&&n(E);s=c?s:s||n(x);return h^s}}function C(c){return function(h){h=(h=h[0]||h)&&h.nodeType==g.NODE_TEXT&&!l.trim(h.nodeValue);return c^h}}q.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};q.RANGE=q.RANGE;var o=true,e=false,j=null,l=KISSY,g=q.NODE,t=q.RANGE,r=q.POSITION,p=q.Walker,d=l.DOM,a=q.Utils.getByAddress,b=l.UA,f=q.XHTML_DTD,m=q.ElementPath,v=l.Node,k={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};B.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return c.join("<br/>")};l.augment(B,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&d._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,h=this.startOffset;if(c[0].nodeType!=g.NODE_ELEMENT)if(h)h>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;h=this.endOffset;if(c[0].nodeType!=g.NODE_ELEMENT)if(h)h>=
c[0].nodeValue.length&&this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,h=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,t.POSITION_BEFORE_START);
h&&h._4e_name()=="span"&&h.attr("_ke_bookmark")&&this.setEndAt(h,t.POSITION_AFTER_END)},setStart:function(c,h){if(c[0].nodeType==g.NODE_ELEMENT&&k[c._4e_name()]){c=c.parent();h=c._4e_index()}this.startContainer=c;this.startOffset=h;if(!this.endContainer){this.endContainer=c;this.endOffset=h}this.updateCollapsed()},setEnd:function(c,h){if(c[0].nodeType==g.NODE_ELEMENT&&k[c._4e_name()]){c=c.parent();h=c._4e_index()+1}this.endContainer=c;this.endOffset=h;if(!this.startContainer){this.startContainer=
c;this.startOffset=h}this.updateCollapsed()},setStartAt:function(c,h){switch(h){case t.POSITION_AFTER_START:this.setStart(c,0);break;case t.POSITION_BEFORE_END:c[0].nodeType==g.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case t.POSITION_BEFORE_START:this.setStartBefore(c);break;case t.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,h){switch(h){case t.POSITION_AFTER_START:this.setEnd(c,0);break;case t.POSITION_BEFORE_END:c[0].nodeType==
g.NODE_TEXT?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case t.POSITION_BEFORE_START:this.setEndBefore(c);break;case t.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,h){var n=this.startContainer,x=this.endContainer,s=this.startOffset,E=this.endOffset,O,N=this.document,P;this.optimizeBookmark();if(x[0].nodeType==g.NODE_TEXT)x=x._4e_splitText(E);else if(x[0].childNodes.length>0)if(E>=x[0].childNodes.length){x=new v(x[0].appendChild(N.createTextNode("")));
P=o}else x=new v(x[0].childNodes[E]);if(n[0].nodeType==g.NODE_TEXT){n._4e_splitText(s);if(n._4e_equals(x))x=new v(n[0].nextSibling)}else if(s)if(s>=n[0].childNodes.length){O=new v(N.createTextNode(""));n.append(O);n=O;O=o}else n=new v(n[0].childNodes[s].previousSibling);else{O=new v(N.createTextNode(""));(s=n[0].firstChild)?d.insertBefore(O[0],s):n.append(O);n=O;O=o}s=n._4e_parents();E=x._4e_parents();var Q,T,S;for(Q=0;Q<s.length;Q++){T=s[Q];S=E[Q];if(!T._4e_equals(S))break}N=h;for(var z,K,G,I=Q;I<
s.length;I++){z=s[I];if(N&&!z._4e_equals(n))K=N.appendChild(z._4e_clone()[0]);for(z=z[0].nextSibling;z;){if(d._4e_equals(E[I],z)||d._4e_equals(x,z))break;G=z.nextSibling;if(c==2)N.appendChild(z.cloneNode(o));else{z.parentNode.removeChild(z);c==1&&N.appendChild(z)}z=G}if(K)N=K}N=h;for(Q=Q;Q<E.length;Q++){z=E[Q];if(c>0&&!z._4e_equals(x))K=N.appendChild(z._4e_clone()[0]);if(!s[Q]||!z.parent()._4e_equals(s[Q].parent()))for(z=z[0].previousSibling;z;){if(d._4e_equals(s[Q],z)||d._4e_equals(n,z))break;G=
z.previousSibling;if(c==2)N.insertBefore(z.cloneNode(o),N.firstChild);else{d._4e_remove(z);c==1&&N.insertBefore(z,N.firstChild)}z=G}if(K)N=K}if(c==2){S=this.startContainer[0];if(S.nodeType==g.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==g.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}S=this.endContainer[0];if(S.nodeType==g.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==g.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}}else{if(T&&
S&&(!n.parent()._4e_equals(T.parent())||!x.parent()._4e_equals(S.parent()))){T=S._4e_index();O&&S.parent()._4e_equals(n.parent())&&T--;this.setStart(S.parent(),T)}this.collapse(o)}O&&n._4e_remove();P&&x[0].parentNode&&x._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=o},clone:function(){var c=new B(this.document);c.startContainer=this.startContainer;
c.startOffset=this.startOffset;c.endContainer=this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=g.NODE_ELEMENT||c.endContainer[0].nodeType!=g.NODE_ELEMENT)return j;var h=new q.Walker(c),n=w(o,undefined),x=C(o);c.evaluator=function(s){return x(s)&&n(s)};c=h.next();h.reset();h=h.previous();return c&&c._4e_equals(h)?c:j},shrink:function(c,h){if(!this.collapsed){c=c||t.SHRINK_TEXT;
var n=this.clone(),x=this.startContainer,s=this.endContainer,E=this.startOffset,O=this.endOffset,N=1,P=1;if(x&&x[0].nodeType==g.NODE_TEXT)if(E)if(E>=x[0].nodeValue.length)n.setStartAfter(x);else{n.setStartBefore(x);N=0}else n.setStartBefore(x);if(s&&s[0].nodeType==g.NODE_TEXT)if(O)if(O>=s[0].nodeValue.length)n.setEndAfter(s);else{n.setEndAfter(s);P=0}else n.setEndBefore(s);n=new p(n);n.evaluator=function(T){T=T[0]||T;return T.nodeType==(c==t.SHRINK_ELEMENT?g.NODE_ELEMENT:g.NODE_TEXT)};var Q;n.guard=
function(T,S){T=T[0]||T;if(c==t.SHRINK_ELEMENT&&T.nodeType==g.NODE_TEXT)return e;if(S&&T==Q)return e;if(!S&&T.nodeType==g.NODE_ELEMENT)Q=T;return o};if(N)(x=n[c==t.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(x,h?t.POSITION_AFTER_START:t.POSITION_BEFORE_START);if(P){n.reset();(n=n[c==t.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,h?t.POSITION_BEFORE_END:t.POSITION_AFTER_END)}return!!(N||P)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||c[0].nodeType!=
g.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var h=this.startContainer,n=this.endContainer,x=this.startOffset,s=this.endOffset,E,O;if(!h||!n)return{start:0,end:0};if(c){if(h[0].nodeType==g.NODE_ELEMENT)if((E=new v(h[0].childNodes[x]))&&E[0]&&E[0].nodeType==g.NODE_TEXT&&x>0&&E[0].previousSibling.nodeType==g.NODE_TEXT){h=E;x=0}for(;h[0].nodeType==g.NODE_TEXT&&(O=h._4e_previous())&&O[0].nodeType==g.NODE_TEXT;){h=O;x+=O[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==
g.NODE_ELEMENT)if((E=new v(n[0].childNodes[s]))&&E[0]&&E[0].nodeType==g.NODE_TEXT&&s>0&&E[0].previousSibling.nodeType==g.NODE_TEXT){n=E;s=0}for(;n[0].nodeType==g.NODE_TEXT&&(O=n._4e_previous())&&O[0].nodeType==g.NODE_TEXT;){n=O;s+=O[0].nodeValue.length}}}return{start:h._4e_address(c),end:this.collapsed?j:n._4e_address(c),startOffset:x,endOffset:s,normalized:c,is2:o}},createBookmark:function(c){var h,n,x,s,E=this.collapsed;h=new v("<span>",j,this.document);h.attr("_ke_bookmark",1);h.css("display",
"none");h.html("&nbsp;");if(c){x=l.guid("ke_bm_");h.attr("id",x+"S")}if(!E){n=h._4e_clone();n.html("&nbsp;");c&&n.attr("id",x+"E");s=this.clone();s.collapse();s.insertNode(n)}s=this.clone();s.collapse(o);s.insertNode(h);if(n){this.setStartAfter(h);this.setEndBefore(n)}else this.moveToPosition(h,t.POSITION_AFTER_END);return{startNode:c?x+"S":h,endNode:c?x+"E":n,serializable:c,collapsed:E}},moveToPosition:function(c,h){this.setStartAt(c,h);this.collapse(o)},trim:function(c,h){var n=this.startContainer,
x=this.startOffset,s=this.collapsed;if((!c||s)&&n[0]&&n[0].nodeType==g.NODE_TEXT){if(x)if(x>=n[0].nodeValue.length){x=n._4e_index()+1;n=n.parent()}else{var E=n._4e_splitText(x);x=n._4e_index()+1;n=n.parent();if(d._4e_equals(this.startContainer,this.endContainer))this.setEnd(E,this.endOffset-this.startOffset);else if(d._4e_equals(n,this.endContainer))this.endOffset+=1}else{x=n._4e_index();n=n.parent()}this.setStart(n,x);if(s){this.collapse(o);return}}n=this.endContainer;x=this.endOffset;if(!(h||s)&&
n[0]&&n[0].nodeType==g.NODE_TEXT){if(x){x>=n.nodeValue.length||n._4e_splitText(x);x=n._4e_index()+1}else x=n._4e_index();n=n.parent();this.setEnd(n,x)}},insertNode:function(c){this.optimizeBookmark();this.trim(e,o);var h=this.startContainer,n=h[0].childNodes[this.startOffset];n?d.insertBefore(c[0]||c,n):h[0].appendChild(c[0]||c);d._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var h=a(this.document,c.start,c.normalized),n=c.startOffset,
x=c.end&&a(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(h,n);x?this.setEnd(x,c):this.collapse(o)}else{h=(n=c.serializable)?l.one("#"+c.startNode,this.document):c.startNode;c=n?l.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(h);h._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(o)}},getCommonAncestor:function(c,h){var n=this.startContainer,x=this.endContainer;n=d._4e_equals(n,x)?c&&n[0].nodeType==g.NODE_ELEMENT&&this.startOffset==this.endOffset-
1?new v(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(x);return h&&n[0].nodeType==g.NODE_TEXT?n.parent():n},enlarge:function(c){switch(c){case t.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var h=new v(this.document.body),n,x,s,E,O,N=e,P,Q;P=this.startContainer;Q=this.startOffset;if(P[0].nodeType==g.NODE_TEXT){if(Q){P=!l.trim(P[0].nodeValue.substring(0,Q)).length&&P;N=!!P}if(P)if(!(E=P[0].previousSibling))s=P.parent()}else{if(Q)E=P[0].childNodes[Q-1]||P[0].lastChild;
E||(s=P)}for(;s||E;){if(s&&!E){if(!O&&d._4e_equals(s,c))O=o;if(!h._4e_contains(s))break;if(!N||s.css("display")!="inline"){N=e;if(O)n=s;else this.setStartBefore(s)}E=s[0].previousSibling}for(;E;){P=e;if(E.nodeType==g.NODE_TEXT){Q=E.nodeValue;if(/[^\s\ufeff]/.test(Q))E=j;P=/[\s\ufeff]$/.test(Q)}else if(E.offsetWidth>0&&!E.getAttribute("_ke_bookmark"))if(N&&f.$removeEmpty[E.nodeName.toLowerCase()]){Q=d.text(E);if(/[^\s\ufeff]/.test(Q))E=j;else for(var T=E.all||E.getElementsByTagName("*"),S=0,z;z=T[S++];)if(!f.$removeEmpty[z.nodeName.toLowerCase()]){E=
j;break}if(E)P=!!Q.length}else E=j;if(P)if(N)if(O)n=s;else s&&this.setStartBefore(s);else N=o;if(E){P=E.previousSibling;if(!s&&!P){s=new v(E);E=j;break}E=P}else s=j}if(s)s=s.parent()}P=this.endContainer;Q=this.endOffset;s=E=j;O=N=e;if(P[0].nodeType==g.NODE_TEXT){P=!l.trim(P[0].nodeValue.substring(Q)).length&&P;N=!(P&&P[0].nodeValue.length);if(P)if(!(E=P[0].nextSibling))s=P.parent()}else(E=P[0].childNodes[Q])||(s=P);for(;s||E;){if(s&&!E){if(!O&&d._4e_equals(s,c))O=o;if(!h._4e_contains(s))break;if(!N||
s.css("display")!="inline"){N=e;if(O)x=s;else s&&this.setEndAfter(s)}E=s[0].nextSibling}for(;E;){P=e;if(E.nodeType==g.NODE_TEXT){Q=E.nodeValue;if(/[^\s\ufeff]/.test(Q))E=j;P=/^[\s\ufeff]/.test(Q)}else if(E.offsetWidth>0&&!E.getAttribute("_ke_bookmark"))if(N&&f.$removeEmpty[E.nodeName.toLowerCase()]){Q=d.text(E);if(/[^\s\ufeff]/.test(Q))E=j;else{T=E.all||E.getElementsByTagName("*");for(S=0;z=T[S++];)if(!f.$removeEmpty[z.nodeName.toLowerCase()]){E=j;break}}if(E)P=!!Q.length}else E=j;if(P)if(N)if(O)x=
s;else this.setEndAfter(s);if(E){P=E.nextSibling;if(!s&&!P){s=new v(E);E=j;break}E=P}else s=j}if(s)s=s.parent()}if(n&&x){c=n._4e_contains(x)?x:n;this.setStartBefore(c);this.setEndAfter(c)}break;case t.ENLARGE_BLOCK_CONTENTS:case t.ENLARGE_LIST_ITEM_CONTENTS:s=new B(this.document);h=new v(this.document.body);s.setStartAt(h,t.POSITION_AFTER_START);s.setEnd(this.startContainer,this.startOffset);s=new p(s);var K,G,I=p.blockBoundary(c==t.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:j),J=function(M){var L=I(M);L||
(K=M);return L};n=function(M){var L=J(M);if(!L&&M[0]&&M._4e_name()=="br")G=M;return L};s.guard=J;s=s.lastBackward();K=K||h;this.setStartAt(K,K._4e_name()!="br"&&(!s&&this.checkStartOfBlock()||s&&K._4e_contains(s))?t.POSITION_AFTER_START:t.POSITION_AFTER_END);s=this.clone();s.collapse();s.setEndAt(h,t.POSITION_BEFORE_END);s=new p(s);s.guard=c==t.ENLARGE_LIST_ITEM_CONTENTS?n:J;K=j;s=s.lastForward();K=K||h;this.setEndAt(K,!s&&this.checkEndOfBlock()||s&&K._4e_contains(s)?t.POSITION_BEFORE_END:t.POSITION_BEFORE_START);
G&&this.setEndAfter(G)}},checkStartOfBlock:function(){var c=this.startContainer,h=this.startOffset;if(h&&c[0].nodeType==g.NODE_TEXT)if(l.trim(c[0].nodeValue.substring(0,h)).length)return e;this.trim();c=new m(this.startContainer);h=this.clone();h.collapse(o);h.setStartAt(c.block||c.blockLimit,t.POSITION_AFTER_START);c=new p(h);c.evaluator=y(o);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,h=this.endOffset;if(c[0].nodeType==g.NODE_TEXT)if(l.trim(c[0].nodeValue.substring(h)).length)return e;
this.trim();c=new m(this.endContainer);h=this.clone();h.collapse(e);h.setEndAt(c.block||c.blockLimit,t.POSITION_BEFORE_END);c=new p(h);c.evaluator=y(e);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,h){var n=this.clone();n[h==t.START?"setStartAt":"setEndAt"](c,h==t.START?t.POSITION_AFTER_START:
t.POSITION_BEFORE_END);n=new p(n);n.evaluator=D;return n[h==t.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,h=this.endContainer,n=this.startOffset,x=this.endOffset,s;if(c[0].nodeType==g.NODE_ELEMENT){s=c[0].childNodes.length;if(s>n)c=new v(c[0].childNodes[n]);else if(s<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new v(c);c=c._4e_nextSourceNode()||c}}if(h[0].nodeType==g.NODE_ELEMENT){s=h[0].childNodes.length;if(s>x)h=
(new v(h[0].childNodes[x]))._4e_previousSourceNode(o);else if(s<1)h=h._4e_previousSourceNode();else{for(h=h[0];h.lastChild;)h=h.lastChild;h=new v(h)}}if(c._4e_position(h)&r.POSITION_FOLLOWING)c=h;return{startNode:c,endNode:h}},fixBlock:function(c,h){var n=this.createBookmark(),x=new v(this.document.createElement(h));this.collapse(c);this.enlarge(t.ENLARGE_BLOCK_CONTENTS);x[0].appendChild(this.extractContents());x._4e_trim();b.ie||x._4e_appendBogus();this.insertNode(x);this.moveToBookmark(n);return x},
splitBlock:function(c){var h=new m(this.startContainer),n=new m(this.endContainer),x=h.block,s=n.block,E=j;if(!h.blockLimit._4e_equals(n.blockLimit))return j;if(c!="br"){if(!x){x=this.fixBlock(o,c);s=(new m(this.endContainer)).block}s||(s=this.fixBlock(e,c))}c=x&&this.checkStartOfBlock();h=s&&this.checkEndOfBlock();this.deleteContents();if(x&&d._4e_equals(x,s))if(h){E=new m(this.startContainer);this.moveToPosition(s,t.POSITION_AFTER_END);s=j}else if(c){E=new m(this.startContainer);this.moveToPosition(x,
t.POSITION_BEFORE_START);x=j}else{s=this.splitElement(x);!b.ie&&!l.inArray(x._4e_name(),["ul","ol"])&&x._4e_appendBogus()}return{previousBlock:x,nextBlock:s,wasStartOfBlock:c,wasEndOfBlock:h,elementPath:E}},splitElement:function(c){if(!this.collapsed)return j;this.setEndAt(c,t.POSITION_BEFORE_END);var h=this.extractContents(),n=c._4e_clone(e);n[0].appendChild(h);n.insertAfter(c);this.moveToPosition(c,t.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(c,h){var n,x=q.XHTML_DTD;if(x.$empty[c._4e_name()])return e;
for(;c&&c[0].nodeType==g.NODE_ELEMENT;){if(n=c._4e_isEditable())this.moveToPosition(c,h?t.POSITION_BEFORE_END:t.POSITION_AFTER_START);else if(x.$inline[c._4e_name()]){this.moveToPosition(c,h?t.POSITION_AFTER_END:t.POSITION_BEFORE_START);return o}if((c=x.$empty[c._4e_name()]?c[h?"_4e_previous":"_4e_next"](H):c[h?"_4e_last":"_4e_first"](H))&&c[0].nodeType==g.NODE_TEXT){this.moveToPosition(c,h?t.POSITION_AFTER_END:t.POSITION_BEFORE_START);return o}}return n},selectNodeContents:function(c){this.setStart(c,
0);this.setEnd(c,c[0].nodeType==g.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var i={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},A=new p.whitespaces,F=new p.bookmark;q.Range=B;q.Range=B;var u=B.prototype;q.Utils.extern(u,{updateCollapsed:u.updateCollapsed,optimize:u.optimize,setStartAfter:u.setStartAfter,setEndAfter:u.setEndAfter,setStartBefore:u.setStartBefore,
setEndBefore:u.setEndBefore,optimizeBookmark:u.optimizeBookmark,setStart:u.setStart,setEnd:u.setEnd,setStartAt:u.setStartAt,setEndAt:u.setEndAt,execContentsAction:u.execContentsAction,collapse:u.collapse,clone:u.clone,getEnclosedNode:u.getEnclosedNode,shrink:u.shrink,getTouchedStartNode:u.getTouchedStartNode,createBookmark2:u.createBookmark2,createBookmark:u.createBookmark,moveToPosition:u.moveToPosition,trim:u.trim,insertNode:u.insertNode,moveToBookmark:u.moveToBookmark,getCommonAncestor:u.getCommonAncestor,
enlarge:u.enlarge,checkStartOfBlock:u.checkStartOfBlock,checkEndOfBlock:u.checkEndOfBlock,deleteContents:u.deleteContents,extractContents:u.extractContents,checkBoundaryOfElement:u.checkBoundaryOfElement,getBoundaryNodes:u.getBoundaryNodes,fixBlock:u.fixBlock,splitBlock:u.splitBlock,splitElement:u.splitElement,moveToElementEditablePosition:u.moveToElementEditablePosition,selectNodeContents:u.selectNodeContents})});
KISSY.Editor.add("domiterator",function(q){function B(p){if(!(arguments.length<1)){this.range=p;this.forceBrBreak=H;this.enlargeBr=D;this.enforceRealBlocks=H;this._||(this._={})}}var D=true,H=false,y=KISSY,w=y.UA,C=q.Walker,o=q.Range,e=q.RANGE,j=q.NODE,l=q.ElementPath,g=y.Node,t=y.DOM,r=/^[\r\n\t ]*$/;C.bookmark();y.augment(B,{getNextParagraph:function(p){var d,a,b,f,m;if(!this._.lastNode){a=this.range.clone();a.shrink(e.SHRINK_ELEMENT,D);a.enlarge(this.forceBrBreak||!this.enlargeBr?e.ENLARGE_LIST_ITEM_CONTENTS:
e.ENLARGE_BLOCK_CONTENTS);var v=new C(a),k=C.bookmark(D,D);v.evaluator=k;this._.nextNode=v.next();v=new C(a);v.evaluator=k;v=v.previous();this._.lastNode=v._4e_nextSourceNode(D);if(this._.lastNode&&this._.lastNode[0].nodeType==j.NODE_TEXT&&!y.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){k=new o(a.document);k.moveToPosition(this._.lastNode,e.POSITION_AFTER_END);if(k.checkEndOfBlock()){k=new l(k.endContainer);this._.lastNode=(k.block||k.blockLimit)._4e_nextSourceNode(D)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new g(a.document.createTextNode(""));t.insertAfter(this._.lastNode[0],v[0])}a=null}k=this._.nextNode;v=this._.lastNode;for(this._.nextNode=null;k;){var i=H,A=k[0].nodeType!=j.NODE_ELEMENT,F=H;if(A){if(k[0].nodeType==j.NODE_TEXT)if(r.test(k[0].nodeValue))A=H}else{var u=k._4e_name();if(k._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(u=="br")A=D;else if(!a&&!k[0].childNodes.length&&u!="hr"){d=k;b=k._4e_equals(v);break}if(a){a.setEndAt(k,e.POSITION_BEFORE_START);if(u!="br")this._.nextNode=
k}i=D}else{if(k[0].firstChild){if(!a){a=new o(this.range.document);a.setStartAt(k,e.POSITION_BEFORE_START)}k=new g(k[0].firstChild);continue}A=D}}if(A&&!a){a=new o(this.range.document);a.setStartAt(k,e.POSITION_BEFORE_START)}b=(!i||A)&&k._4e_equals(v);if(a&&!i)for(;!k[0].nextSibling&&!b;){u=k.parent();if(u._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){i=D;b||u._4e_equals(v);break}k=u;A=D;b=k._4e_equals(v);F=D}A&&a.setEndAt(k,e.POSITION_AFTER_END);k=k._4e_nextSourceNode(F,null,v);if((b=!k)||i&&a)break}if(!d){if(!a){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}d=new l(a.startContainer);k=d.blockLimit;i={div:1,th:1,td:1};d=d.block;if((!d||!d[0])&&!this.enforceRealBlocks&&i[k._4e_name()]&&a.checkStartOfBlock()&&a.checkEndOfBlock())d=k;else if(!d||this.enforceRealBlocks&&d._4e_name()=="li"){d=new g(this.range.document.createElement(p||"p"));d[0].appendChild(a.extractContents());d._4e_trim();a.insertNode(d);f=m=D}else if(d._4e_name()!="li"){if(!a.checkStartOfBlock()||!a.checkEndOfBlock()){d=d._4e_clone(H);
d[0].appendChild(a.extractContents());d._4e_trim();m=a.splitBlock();f=!m.wasStartOfBlock;m=!m.wasEndOfBlock;a.insertNode(d)}}else if(!b)this._.nextNode=d._4e_equals(v)?null:a.getBoundaryNodes().endNode._4e_nextSourceNode(D,null,v)}if(f){a=new g(d[0].previousSibling);if(a[0]&&a[0].nodeType==j.NODE_ELEMENT)if(a._4e_name()=="br")a._4e_remove();else a[0].lastChild&&t._4e_name(a[0].lastChild)=="br"&&t._4e_remove(a[0].lastChild)}if(m){a=C.bookmark(H,D);f=new g(d[0].lastChild);if(f[0]&&f[0].nodeType==j.NODE_ELEMENT&&
f._4e_name()=="br")if(w.ie||f._4e_previous(a)||f._4e_next(a))f._4e_remove()}if(!this._.nextNode)this._.nextNode=b||d._4e_equals(v)?null:d._4e_nextSourceNode(D,null,v);return d}});o.prototype.createIterator=function(){return new B(this)}});
KISSY.Editor.add("selection",function(q){function B(k){this.document=this.document=k;this._={cache:{}};if(e.ie){var i=this.getNative().createRange();if(!i||i.item&&i.item(0).ownerDocument!=k||i.parentElement&&i.parentElement().ownerDocument!=k)this.isInvalid=y}}function D(k){k=new B(k);return!k||k.isInvalid?C:k}function H(k){var i=k.document,A=new g(i.body),F=new g(i.documentElement);if(e.ie){if(e.ie<8||document.documentMode==7)F.on("click",function(N){j._4e_name(N.target)==="html"&&k.getSelection().getRanges()[0].select()});
var u,c,h=1;F.on("mousedown",function(){h=0});F.on("mouseup",function(){h=1});A.on("focusin",function(N){if(j._4e_name(N.target)=="body")if(u){try{h&&u.select()}catch(P){}u=C}});A.on("focus",function(){c=y;x()});A.on("beforedeactivate",function(N){if(!N.relatedTarget){c=w;h=1}});l.on(j._4e_getWin(i),"blur",function(){i&&i.selection.empty()});A.on("mousedown",function(){n()});A.on("mouseup",function(){c=y;setTimeout(function(){x(y)},0)});var n=function(){c=w},x=function(N){if(c){var P=k.document,Q=
k.getSelection(),T=Q&&Q.getType(),S=Q&&Q.getNative();if(N&&S&&T==t.SELECTION_NONE)if(!P.queryCommandEnabled("InsertImage")){setTimeout(function(){x(y)},50);return}var z;if(!(S&&T==t.SELECTION_TEXT&&(z=j._4e_name(S.createRange().parentElement()))&&z in{input:1,textarea:1})){u=S&&Q.getRanges()[0];k._monitor()}}};A.on("keydown",n);A.on("keyup",function(){c=y;x()});l.on(i,"selectionchange",x)}else{l.on(i,"mouseup",k._monitor,k);l.on(i,"keyup",k._monitor,k)}var s={table:1,pre:1},E=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
O=q.Walker.whitespaces(y);k.on("selectionChange",function(N){var P=N.path;N=(N=N.selection)&&N.getRanges()[0];var Q=P.blockLimit;if(N)if(N.collapse&&!P.block&&Q._4e_name()=="body"){P=N.fixBlock(y,"p");if(P._4e_outerHtml().match(E))if((Q=P._4e_next(O))&&Q[0].nodeType==p.NODE_ELEMENT&&!s[Q._4e_name()]){N.moveToElementEditablePosition(Q);P._4e_remove()}else if((Q=P._4e_previous(O))&&Q[0].nodeType==p.NODE_ELEMENT&&!s[Q._4e_name()]){N.moveToElementEditablePosition(Q,Q._4e_outerHtml().match(E)?w:y);P._4e_remove()}N.select();
e.ie||k.notifySelectionChange()}})}q.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var y=true,w=false,C=null,o=KISSY,e=o.UA,j=o.DOM,l=o.Event,g=o.Node,t=q.SELECTION,r=q.RANGE,p=q.NODE,d=q.Walker,a=q.Range,b={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};o.augment(B,{getNative:e.ie?function(){var k=this._.cache;return k.nativeSel||(k.nativeSel=this.document.selection)}:function(){var k=
this._.cache;return k.nativeSel||(k.nativeSel=j._4e_getWin(this.document).getSelection())},getType:e.ie?function(){var k=this._.cache;if(k.type)return k.type;var i=t.SELECTION_NONE;try{var A=this.getNative(),F=A.type;if(F=="Text")i=t.SELECTION_TEXT;if(F=="Control")i=t.SELECTION_ELEMENT;if(A.createRange().parentElement)i=t.SELECTION_TEXT}catch(u){}return k.type=i}:function(){var k=this._.cache;if(k.type)return k.type;var i=t.SELECTION_TEXT,A=this.getNative();if(A){if(A.rangeCount==1){A=A.getRangeAt(0);
var F=A.startContainer;if(F==A.endContainer&&F.nodeType==p.NODE_ELEMENT&&A.endOffset-A.startOffset===1&&b[F.childNodes[A.startOffset].nodeName.toLowerCase()])i=t.SELECTION_ELEMENT}}else i=t.SELECTION_NONE;return k.type=i},getRanges:e.ie?function(){var k=function(i,A){i=i.duplicate();i.collapse(A);for(var F=i.parentElement(),u=F.childNodes,c,h=0;h<u.length;h++){var n=u[h];if(n.nodeType==p.NODE_ELEMENT){c=i.duplicate();c.moveToElementText(n);n=c.compareEndPoints("StartToStart",i);var x=c.compareEndPoints("EndToStart",
i);c.collapse();if(n>0)break;else if(!n||x==1&&n==-1)return{container:F,offset:h};else if(!x)return{container:F,offset:h+1};c=C}}if(!c){c=i.duplicate();c.moveToElementText(F);c.collapse(w)}c.setEndPoint("StartToStart",i);c=c.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;c>0;)c-=u[--h].nodeValue.length}catch(s){c=0}return c===0?{container:F,offset:h}:{container:u[h],offset:-c}};return function(){var i=this._.cache;if(i.ranges)return i.ranges;var A=this.getNative(),F=A&&A.createRange(),u=this.getType();
if(!A)return[];if(u==t.SELECTION_TEXT){A=new a(this.document);u=k(F,y);A.setStart(new g(u.container),u.offset);u=k(F);A.setEnd(new g(u.container),u.offset);return i.ranges=[A]}else if(u==t.SELECTION_ELEMENT){i=i.ranges=[];for(u=0;u<F.length;u++){var c=F.item(u),h=c.parentNode,n=0;for(A=new a(this.document);n<h.childNodes.length&&h.childNodes[n]!=c;n++);A.setStart(new g(h),n);A.setEnd(new g(h),n+1);i.push(A)}return i}return i.ranges=[]}}():function(){var k=this._.cache;if(k.ranges)return k.ranges;
var i=[],A=this.getNative();if(!A)return[];for(var F=0;F<A.rangeCount;F++){var u=A.getRangeAt(F),c=new a(this.document);c.setStart(new g(u.startContainer),u.startOffset);c.setEnd(new g(u.endContainer),u.endOffset);i.push(c)}return k.ranges=i},getStartElement:function(){var k=this._.cache;if(k.startElement!==undefined)return k.startElement;var i,A=this.getNative();switch(this.getType()){case t.SELECTION_ELEMENT:return this.getSelectedElement();case t.SELECTION_TEXT:var F=this.getRanges()[0];if(F)if(!F.collapsed){for(F.optimize();y;){i=
F.startContainer;if(F.startOffset==(i[0].nodeType===p.NODE_ELEMENT?i[0].childNodes.length:i[0].nodeValue.length)&&!i._4e_isBlockBoundary())F.setStartAfter(i);else break}i=F.startContainer;if(i[0].nodeType!=p.NODE_ELEMENT)return i.parent();i=new g(i[0].childNodes[F.startOffset]);if(!i[0]||i[0].nodeType!=p.NODE_ELEMENT)return F.startContainer;for(F=i[0].firstChild;F&&F.nodeType==p.NODE_ELEMENT;){i=new g(F);F=F.firstChild}return i}if(e.ie){F=A.createRange();F.collapse(y);i=F.parentElement()}else if((i=
A.anchorNode)&&i.nodeType!=p.NODE_ELEMENT)i=i.parentNode}return k.startElement=i?j._4e_wrap(i):C},getSelectedElement:function(){var k=this,i,A=k._.cache;if(A.selectedElement!==undefined)return A.selectedElement;if(e.ie){i=k.getNative().createRange();i=i.item&&i.item(0)}i||(i=function(){for(var F=k.getRanges()[0],u,c,h=2;h&&!((u=F.getEnclosedNode())&&u[0].nodeType==p.NODE_ELEMENT&&b[u._4e_name()]&&(c=u));h--)F.shrink(r.SHRINK_ELEMENT);return c&&c[0]}());return A.selectedElement=j._4e_wrap(i)},reset:function(){this._.cache=
{}},selectElement:function(k){var i;if(e.ie)try{i=this.document.body.createControlRange();i.addElement(k[0]);i.select()}catch(A){i=this.document.body.createTextRange();i.moveToElementText(k[0]);i.select()}finally{}else{i=this.document.createRange();i.selectNode(k[0]);k=this.getNative();k.removeAllRanges();k.addRange(i)}this.reset()},selectRanges:function(k){if(e.ie){if(k.length>1){var i=k[k.length-1];k[0].setEnd(i.endContainer,i.endOffset);k.length=1}k[0]&&k[0].select()}else{i=this.getNative();if(!i)return;
i.removeAllRanges();for(var A=0;A<k.length;A++){var F=k[A],u=this.document.createRange(),c=F.startContainer;F.collapsed&&e.gecko&&e.gecko<1.09&&c[0].nodeType==p.NODE_ELEMENT&&!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));u.setStart(c[0],F.startOffset);u.setEnd(F.endContainer[0],F.endOffset);i.addRange(u)}}this.reset()},createBookmarks2:function(k){for(var i=[],A=this.getRanges(),F=0;F<A.length;F++)i.push(A[F].createBookmark2(k));return i},createBookmarks:function(k,i){var A=
[],F=this.document,u;i=i||this.getRanges();for(var c=i.length,h=0;h<c;h++){A.push(u=i[h].createBookmark(k,y));var n=(k=u.serializable)?o.one("#"+u.startNode,F):u.startNode;u=k?o.one("#"+u.endNode,F):u.endNode;for(var x=h+1;x<c;x++){var s=i[x],E=s.startContainer,O=s.endContainer;j._4e_equals(E,n.parent())&&s.startOffset++;j._4e_equals(E,u.parent())&&s.startOffset++;j._4e_equals(O,n.parent())&&s.endOffset++;j._4e_equals(O,u.parent())&&s.endOffset++}}return A},selectBookmarks:function(k){for(var i=[],
A=0;A<k.length;A++){var F=new a(this.document);F.moveToBookmark(k[A]);i.push(F)}this.selectRanges(i);return this},getCommonAncestor:function(){var k=this.getRanges();return k[0].startContainer._4e_commonAncestor(k[k.length-1].endContainer)},scrollIntoView:function(){var k=this.getStartElement();k&&k._4e_scrollIntoView()},removeAllRanges:function(){var k=this.getNative();if(e.ie)k&&k.clear();else k&&k.removeAllRanges()}});var f={table:1,tbody:1,tr:1},m=d.whitespaces(y),v=/\ufeff|\u00a0/;a.prototype.select=
a.prototype.select=e.ie?function(k){var i=this.collapsed,A,F;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var u=this.startContainer[0].childNodes[this.startOffset];if(u.nodeType==p.NODE_ELEMENT){(new B(this.document)).selectElement(new g(u));return}}if(this.startContainer[0].nodeType==p.NODE_ELEMENT&&this.startContainer._4e_name()in f||this.endContainer[0].nodeType==p.NODE_ELEMENT&&this.endContainer._4e_name()in f)this.shrink(r.SHRINK_ELEMENT,y);var c=this.createBookmark();
u=c.startNode;var h;if(!i)h=c.endNode;c=this.document.body.createTextRange();c.moveToElementText(u[0]);c.moveStart("character",1);if(h){k=this.document.body.createTextRange();k.moveToElementText(h[0]);c.setEndPoint("EndToEnd",k);c.moveEnd("character",-1)}else{for(A=u[0].nextSibling;A&&!m(A);)A=A.nextSibling;A=!(A&&A.nodeValue&&A.nodeValue.match(v))&&(k||!u[0].previousSibling||u[0].previousSibling&&j._4e_name(u[0].previousSibling)=="br");F=this.document.createElement("span");F.innerHTML="&#65279;";
F=new g(F);j.insertBefore(F[0],u[0]);A&&j.insertBefore(this.document.createTextNode("\ufeff"),u[0])}this.setStartBefore(u);u._4e_remove();if(i){if(A){c.moveStart("character",-1);c.select();this.document.selection.clear()}else c.select();if(F){this.moveToPosition(F,r.POSITION_BEFORE_START);F._4e_remove()}}else{this.setEndBefore(h);h._4e_remove();c.select()}}:function(){var k=this.startContainer;this.collapsed&&k[0].nodeType==p.NODE_ELEMENT&&!k[0].childNodes.length&&k[0].appendChild(this.document.createTextNode(""));
var i=this.document.createRange();i.setStart(k[0],this.startOffset);try{i.setEnd(this.endContainer[0],this.endOffset)}catch(A){if(A.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(y);i.setEnd(this.endContainer[0],this.endOffset)}else throw A;}k=D(this.document).getNative();k.removeAllRanges();k.addRange(i)};B.getSelection=D;q.Selection=B;q.Selection=B;d=B.prototype;q.Utils.extern(d,{getNative:d.getNative,getType:d.getType,getRanges:d.getRanges,getStartElement:d.getStartElement,getSelectedElement:d.getSelectedElement,
reset:d.reset,selectElement:d.selectElement,selectRanges:d.selectRanges,createBookmarks2:d.createBookmarks2,createBookmarks:d.createBookmarks,getCommonAncestor:d.getCommonAncestor,scrollIntoView:d.scrollIntoView,selectBookmarks:d.selectBookmarks,removeAllRanges:d.removeAllRanges});q.on("instanceCreated",function(k){H(k.editor)})});
KISSY.Editor.add("styles",function(q){function B(z,K){for(var G in z)z[G]=z[G].replace(T,function(I,J){return K[J]})}function D(z,K){if(K){z=i.clone(z);B(z.attributes,K);B(z.styles,K)}var G=this.element=this.element=(z.element||"*").toLowerCase();this.type=this.type=G=="#"||N[G]?F.STYLE_BLOCK:P[G]?F.STYLE_OBJECT:F.STYLE_INLINE;this._={definition:z}}function H(z,K){var G=K?this.removeFromRange:this.applyToRange;z.body.focus();for(var I=new c(z),J=I.getRanges(),M=0;M<J.length;M++)G.call(this,J[M]);
I.selectRanges(J)}function y(z,K){var G;G=z.element;if(G=="*")G="span";G=new s(K.createElement(G));return w(G,z)}function w(z,K){var G=K._.definition,I=G.attributes;G=D.getStyleText(G);if(I)for(var J in I)z.attr(J,I[J]);if(G)z[0].style.cssText=G;return z}function C(z){var K=z.createBookmark(m),G=z.createIterator();G.enforceRealBlocks=m;G.enlargeBr=m;for(var I,J=z.document;I=G.getNextParagraph();){var M=y(this,J);I=I;var L=M;M=L._4e_name=="pre";var R=I._4e_name=="pre",X=!M&&R;if(M&&!R){R=I;L=L;X=R.html();
X=o(X,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");X=X.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");X=X.replace(/([ \t\n\r]+|&nbsp;)/g," ");X=X.replace(/<br\b[^>]*>/gi,"\n");if(E.ie){R=R[0].ownerDocument.createElement("div");R.appendChild(L[0]);L[0].outerHTML="<pre>"+X+"</pre>";L=new s(R.firstChild);L._4e_remove()}else L.html(X);L=L}else if(X)L=j(e(I),L);else I._4e_moveChildren(L);I[0].parentNode.replaceChild(L[0],I[0]);if(M){I=L;M=void 0;if((M=I._4e_previousSourceNode(m,h.NODE_ELEMENT))&&M._4e_name()==
"pre"){L=o(M.html(),/\n$/,"")+"\n\n"+o(I.html(),/^\n/,"");if(E.ie)I[0].outerHTML="<pre>"+L+"</pre>";else I.html(L);M._4e_remove()}}}z.moveToBookmark(K)}function o(z,K,G){var I="",J="";z=z.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(M,L,R){L&&(I=L);R&&(J=R);return""});return I+z.replace(K,G)+J}function e(z){var K=[];o(z._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(G,I,J){return I+"</pre>"+J+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(G,I){K.push(I)});return K}function j(z,K){for(var G=K[0].ownerDocument.createDocumentFragment(),I=0;I<z.length;I++){var J=z[I];J=J.replace(/(\r\n|\r)/g,"\n");J=o(J,/^[ \t]*\n/,"");J=o(J,/\n$/,"");J=o(J,/^[ \t]+|[ \t]+$/g,function(L,R){return L.length==1?"&nbsp;":R?" "+Array(L.length).join("&nbsp;"):Array(L.length).join("&nbsp;")+" "});J=J.replace(/\n/g,"<br>");J=J.replace(/[ \t]{2,}/g,function(L){return Array(L.length).join("&nbsp;")+" "});var M=K._4e_clone();M.html(J);G.appendChild(M[0])}return G}
function l(z){var K=z.document;if(z.collapsed){K=y(this,K);z.insertNode(K);z.moveToPosition(K,u.POSITION_BEFORE_END)}else{var G=this.element,I=this._.definition,J,M=q.XHTML_DTD[G]||(J=m,q.XHTML_DTD.span),L=z.createBookmark();z.enlarge(u.ENLARGE_ELEMENT);z.trim();var R=z.createBookmark(),X=R.startNode;R=R.endNode;for(var W=X,Z;W&&W[0];){var U=v;if(A._4e_equals(W,R)){W=k;U=m}else{var V=W[0].nodeType,ba=V==h.NODE_ELEMENT?W._4e_name():k;if(ba&&W.attr("_ke_bookmark")){W=W._4e_nextSourceNode(m);continue}if(!ba||
M[ba]&&(W._4e_position(R)|n.POSITION_PRECEDING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_PRECEDING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(W))){var Y=W.parent();if(Y&&Y[0]&&((q.XHTML_DTD[Y._4e_name()]||q.XHTML_DTD.span)[G]||J)&&(!I.parentRule||I.parentRule(Y))){if(!Z&&(!ba||!q.XHTML_DTD.$removeEmpty[ba]||(W._4e_position(R)|n.POSITION_PRECEDING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_PRECEDING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED)){Z=
new x(K);Z.setStartBefore(W)}if(V==h.NODE_TEXT||V==h.NODE_ELEMENT&&!W[0].childNodes.length){V=W;for(var $;!V[0].nextSibling&&($=V.parent(),M[$._4e_name()])&&($._4e_position(X)|n.POSITION_FOLLOWING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_FOLLOWING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule($));)V=$;Z.setEndAfter(V);V[0].nextSibling||(U=m)}}else U=m}else U=m;W=W._4e_nextSourceNode()}if(U&&Z&&!Z.collapsed){U=y(this,K);for(V=Z.getCommonAncestor();U&&V&&
U[0]&&V[0];){if(V._4e_name()==G){for(var aa in I.attributes)U.attr(aa)==V.attr(aa)&&U[0].removeAttribute(aa);for(var ea in I.styles)U._4e_style(ea)==V._4e_style(ea)&&U._4e_style(ea,"");if(!U._4e_hasAttributes()){U=k;break}}V=V.parent()}if(U){U[0].appendChild(Z.extractContents());V=U;ba=p(this);Y=V.all(this.element);for(var ca=Y.length;--ca>=0;)d(this,new s(Y[ca]));var da=void 0;for(da in ba)if(da!=this.element){Y=V.all(da);for(ca=Y.length-1;ca>=0;ca--){var fa=new s(Y[ca]);b(fa,ba[da])}}Z.insertNode(U);
U._4e_mergeSiblings();E.ie||U[0].normalize()}Z=k}}X._4e_remove();R._4e_remove();z.moveToBookmark(L);z.shrink(u.SHRINK_TEXT)}}function g(z){z.enlarge(u.ENLARGE_ELEMENT);var K=z.createBookmark(),G=K.startNode;if(z.collapsed){for(var I=new O(G.parent()),J,M=0,L;M<I.elements.length&&(L=I.elements[M]);M++){if(L==I.block||L==I.blockLimit)break;if(this.checkElementRemovable(L)){var R=z.checkBoundaryOfElement(L,u.END),X=!R&&z.checkBoundaryOfElement(L,u.START);if(X||R){J=L;J.match=X?"start":"end"}else{L._4e_mergeSiblings();
L._4e_name()==this.element?d(this,L):b(L,p(this)[L._4e_name()])}}}if(J&&J[0]){L=G;for(M=0;;M++){R=I.elements[M];if(A._4e_equals(R,J))break;else if(R.match)continue;else R=R._4e_clone();R[0].appendChild(L[0]);L=R}A[J.match=="start"?"insertBefore":"insertAfter"](L[0],J[0])}}else{var W=K.endNode,Z=this;I=function(){for(var U=new O(G.parent()),V=new O(W.parent()),ba=k,Y=k,$=0;$<U.elements.length;$++){var aa=U.elements[$];if(aa==U.block||aa==U.blockLimit)break;if(Z.checkElementRemovable(aa))ba=aa}for($=
0;$<V.elements.length;$++){aa=V.elements[$];if(aa==V.block||aa==V.blockLimit)break;if(Z.checkElementRemovable(aa))Y=aa}Y&&W._4e_breakParent(Y);ba&&G._4e_breakParent(ba)};I();for(J=new s(G[0].nextSibling);J[0]!==W[0];){M=J._4e_nextSourceNode();if(J[0]&&J[0].nodeType==h.NODE_ELEMENT&&this.checkElementRemovable(J)){J._4e_name()==this.element?d(this,J):b(J,p(this)[J._4e_name()]);if(M[0].nodeType==h.NODE_ELEMENT&&M._4e_contains(G)){I();M=new s(G[0].nextSibling)}}J=M}}z.moveToBookmark(K)}function t(z){var K=
{};z.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,I,J){K[I]=J});return K}function r(z,K){var G;if(K!==v){G=document.createElement("span");G.style.cssText=z;G=G.style.cssText||""}else G=z;return G.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function p(z){if(z._.overrides)return z._.overrides;var K=z._.overrides={},G=z._.definition.overrides;if(G){i.isArray(G)||(G=[G]);for(var I=0;I<G.length;I++){var J=G[I],M,L;if(typeof J==
"string")M=J.toLowerCase();else{M=J.element?J.element.toLowerCase():z.element;L=J.attributes}J=K[M]||(K[M]={});if(L){J=J.attributes=J.attributes||[];for(var R in L)J.push([R.toLowerCase(),L[R]])}}}return K}function d(z,K){var G=z._.definition,I=i.mix(i.mix({},G.attributes),p(z)[K._4e_name()]);G=G.styles;var J=i.isEmptyObject(I)&&i.isEmptyObject(G),M;for(M in I)if(!((M=="class"||z._.definition.fullMatch)&&K.attr(M)!=a(M,I[M]))){J=J||!!K._4e_hasAttribute(M);K.removeAttr(M)}for(var L in G)if(!(z._.definition.fullMatch&&
K._4e_style(L)!=a(L,G[L],m))){J=J||!!K._4e_style(L);K._4e_style(L,"")}J&&f(K)}function a(z,K,G){var I=new s("<span>");I[G?"_4e_style":"attr"](z,K);return I[G?"_4e_style":"attr"](z)}function b(z,K){var G=K&&K.attributes;if(G)for(var I=0;I<G.length;I++){var J=G[I][0],M;if(M=z.attr(J)){var L=G[I][1];if(L===k||L.test&&L.test(M)||typeof L=="string"&&M==L)z[0].removeAttribute(J)}}f(z)}function f(z){if(!z._4e_hasAttributes()){var K=z[0].firstChild,G=z[0].lastChild;z._4e_remove(m);if(K){K.nodeType==h.NODE_ELEMENT&&
A._4e_mergeSiblings(K);G&&!K===G&&G.nodeType==h.NODE_ELEMENT&&A._4e_mergeSiblings(G)}}}var m=true,v=false,k=null,i=KISSY,A=i.DOM,F={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},u=q.RANGE,c=q.Selection,h=q.NODE,n=q.POSITION,x=q.Range,s=i.Node,E=i.UA,O=q.ElementPath,N={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/,T=/#\((.+?)\)/g;q.STYLE=F;D.prototype={apply:function(z){H.call(this,
z,v)},remove:function(z){H.call(this,z,m)},applyToRange:function(z){return(this.applyToRange=this.type==F.STYLE_INLINE?l:this.type==F.STYLE_BLOCK?C:this.type==F.STYLE_OBJECT?k:k).call(this,z)},removeFromRange:function(z){return(this.removeFromRange=this.type==F.STYLE_INLINE?g:k).call(this,z)},applyToObject:function(z){w(z,this)},checkElementRemovable:function(z,K){if(!z)return v;var G=this._.definition;if(z._4e_name()==this.element){if(!K&&!z._4e_hasAttributes())return m;var I=G._AC;if(I)G=I;else{I=
{};var J=0,M=G.attributes;if(M)for(var L in M){J++;I[L]=M[L]}if(M=D.getStyleText(G)){I.style||J++;I.style=M}I._length=J;G=G._AC=I}if(G._length){for(var R in G)if(R!="_length"){J=z.attr(R)||"";if(R=="style")a:{I=G[R];J=r(J,v);typeof I=="string"&&(I=t(I));typeof J=="string"&&(J=t(J));M=void 0;for(M in I)if(!(M in J&&(J[M]==I[M]||I[M]=="inherit"||J[M]=="inherit"))){I=v;break a}I=m}else I=G[R]==J;if(I){if(!K)return m}else if(K)return v}if(K)return m}else return m}if(R=p(this)[z._4e_name()]){if(!(G=R.attributes))return m;
for(I=0;I<G.length;I++){R=G[I][0];if(R=z.attr(R)){J=G[I][1];if(J===k||typeof J=="string"&&R==J||J.test&&J.test(R))return m}}}return v},checkActive:function(z){switch(this.type){case F.STYLE_BLOCK:return this.checkElementRemovable(z.block||z.blockLimit,m);case F.STYLE_OBJECT:case F.STYLE_INLINE:for(var K=z.elements,G=0,I;G<K.length;G++){I=K[G];if(!(this.type==F.STYLE_INLINE&&(A._4e_equals(I,z.block)||A._4e_equals(I,z.blockLimit))))if(!(this.type==F.STYLE_OBJECT&&!(I._4e_name()in P)))if(this.checkElementRemovable(I,
m))return m}}return v}};D.getStyleText=function(z){var K=z._ST;if(K)return K;K=z.styles;var G=z.attributes&&z.attributes.style||"",I="";if(G.length)G=G.replace(Q,";");for(var J in K){var M=K[J],L=(J+":"+M).replace(Q,";");if(M=="inherit")I+=L;else G+=L}if(G.length)G=r(G);G+=I;return z._ST=G};q.Style=D;q.Style=D;var S=D.prototype;q.Utils.extern(S,{apply:S.apply,remove:S.remove,applyToRange:S.applyToRange,removeFromRange:S.removeFromRange,applyToObject:S.applyToObject,checkElementRemovable:S.checkElementRemovable,
checkActive:S.checkActive})});
KISSY.Editor.add("htmlparser",function(){function q(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var B=KISSY,D=function(){},H=B.Editor,y=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,w={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},C=H.XHTML_DTD;B.augment(q,{onTagOpen:D,onTagClose:D,
onText:D,onCDATA:D,onComment:D,parse:function(o){for(var e,j,l=0,g;e=this._.htmlPartsRegex.exec(o);){j=e.index;if(j>l){l=o.substring(l,j);g?g.push(l):this.onText(l)}l=this._.htmlPartsRegex.lastIndex;if(j=e[1]){j=j.toLowerCase();if(g&&C.$cdata[j]){this.onCDATA(g.join(""));g=null}if(!g){this.onTagClose(j);continue}}if(g)g.push(e[0]);else if(j=e[3]){j=j.toLowerCase();if(!/="/.test(j)){var t={},r;e=e[4];var p=!!(e&&e.charAt(e.length-1)=="/");if(e)for(;r=y.exec(e);){var d=r[1].toLowerCase();r=r[2]||r[3]||
r[4]||"";t[d]=!r&&w[d]?d:r}this.onTagOpen(j,t,p);if(!g&&C.$cdata[j])g=[]}}else if(j=e[2])this.onComment(j)}o.length>l&&this.onText(o.substring(l,o.length))}});H.HtmlParser=q;H.HtmlParser=q});
KISSY.Editor.add("htmlparser-basicwriter",function(){function q(){this._={output:[]}}var B=KISSY,D=B.Editor,H=D.Utils;B.augment(q,{openTag:function(y){this._.output.push("<",y)},openTagClose:function(y,w){w?this._.output.push(" />"):this._.output.push(">")},attribute:function(y,w){if(typeof w=="string")w=H.htmlEncodeAttr(w);this._.output.push(" ",y,'="',w,'"')},closeTag:function(y){this._.output.push("</",y,">")},text:function(y){this._.output.push(y)},comment:function(y){this._.output.push("<!--",
y,"--\>")},write:function(y){this._.output.push(y)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(y){var w=this._.output.join("");y&&this.reset();return w}});D.HtmlParser.BasicWriter=q;D.HtmlParser.BasicWriter=q;B=q.prototype;D.Utils.extern(B,{openTag:B.openTag,openTagClose:B.openTagClose,attribute:B.attribute,closeTag:B.closeTag,text:B.text,comment:B.comment,write:B.write,reset:B.reset,getHtml:B.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function q(){q.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=w;this.sortAttributes=y;this._.indent=w;this._.indentation="";this._.rules={};var C=D.XHTML_DTD,o;for(o in H.mix({},C.$nonBodyContent,C.$block,C.$listItem,C.$tableContent))this.setRules(o,{indent:y,breakBeforeOpen:y,breakAfterOpen:y,breakBeforeClose:!C[o]["#"],breakAfterClose:y});this.setRules("br",
{breakAfterOpen:y});this.setRules("title",{indent:w,breakAfterOpen:w});this.setRules("style",{indent:w,breakBeforeClose:y});this.setRules("pre",{indent:w})}var B=KISSY,D=B.Editor,H=D.Utils,y=true,w=false;B.extend(q,D.HtmlParser.BasicWriter,{openTag:function(C){var o=this._.rules[C];if(this._.indent)this.indentation();else if(o&&o.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",C)},openTagClose:function(C,o){var e=this._.rules[C];if(o)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(e&&e.indent)this._.indentation+=this.indentationChars}e&&e.breakAfterOpen&&this.lineBreak()},attribute:function(C,o){if(typeof o=="string"){this.forceSimpleAmpersand&&(o=o.replace(/&amp;/g,"&"));o=H.htmlEncodeAttr(o)}this._.output.push(" ",C,'="',o,'"')},closeTag:function(C){var o=this._.rules[C];if(o&&o.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(o&&o.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",C,">");o&&o.breakAfterClose&&this.lineBreak()},text:function(C){if(this._.indent){this.indentation();C=H.ltrim(C)}this._.output.push(C)},comment:function(C){this._.indent&&this.indentation();this._.output.push("<!--",C,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=y},indentation:function(){this._.output.push(this._.indentation);this._.indent=w},setRules:function(C,o){var e=this._.rules[C];if(e)H.mix(e,
o);else this._.rules[C]=o}});D.HtmlParser.HtmlWriter=q;D.HtmlParser.HtmlWriter=q;B=q.prototype;D.Utils.extern(B,{openTag:B.openTag,openTagClose:B.openTagClose,attribute:B.attribute,closeTag:B.closeTag,text:B.text,comment:B.comment,lineBreak:B.lineBreak,indentation:B.indentation,setRules:B.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function q(){this.children=[];this.parent=H;this._={isBlockLike:B,hasInlineStarted:D}}var B=true,D=false,H=null,y=KISSY.Editor,w={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},C=KISSY,o=y.Utils,e=y.NODE,j=y.XHTML_DTD,l=o.mix({table:1,ul:1,ol:1,dl:1},j.table,j.ul,j.ol,j.dl),g=j.$list,t=j.$listItem;q.FromHtml=function(r,p){function d(h){var n;if(v.length>0)for(var x=0;x<v.length;x++){var s=v[x],E=s.name,O=j[E],N=i.name&&j[i.name];
if((!N||N[E])&&(!h||!O||O[h]||!j[h])){if(!n){a();n=1}s=s.clone();s.parent=i;i=s;v.splice(x,1);x--}}}function a(){for(;k.length;)i.add(k.shift())}function b(h,n,x){n=n||i||m;if(p&&!n.type){var s,E;if((s=h.attributes&&(E=h.attributes._ke_real_element_type)?E:h.name)&&!(s in j.$body)&&!(s in j.$nonBodyContent)){s=i;i=n;f.onTagOpen(p,{});n=i;if(x)i=s}}if(h._.isBlockLike&&h.name!="pre"){x=h.children.length;if((s=h.children[x-1])&&s.type==e.NODE_TEXT)if(E=o.rtrim(s.value))s.value=E;else h.children.length=
x-1}n.add(h);if(h.returnPoint){i=h.returnPoint;delete h.returnPoint}}var f=new y.HtmlParser,m=new q,v=[],k=[],i=m,A=D,F;f.onTagOpen=function(h,n,x){var s=new y.HtmlParser.Element(h,n);if(s.isUnknown&&x)s.isEmpty=B;if(j.$removeEmpty[h])v.push(s);else{if(h=="pre")A=B;else if(h=="br"&&A){i.add(new y.HtmlParser.Text("\n"));return}if(h=="br")k.push(s);else{var E=i.name,O=E&&(j[E]||(i._.isBlockLike?j.div:j.span));if(O&&!s.isUnknown&&!i.isUnknown&&!O[h]){O=D;var N;if(h in g&&E in g){E=i.children;(E=E[E.length-
1])&&E.name in t||b(E=new y.HtmlParser.Element("li"),i);F=i;N=E}else if(h==E)b(i,i.parent);else{if(l[E])F||(F=i);else{b(i,i.parent,B);w[E]||v.unshift(i)}O=B}i=N?N:i.returnPoint||i.parent;if(O){f.onTagOpen.apply(this,arguments);return}}d(h);a();s.parent=i;s.returnPoint=F;F=0;if(s.isEmpty)b(s);else i=s}}};f.onTagClose=function(h){for(var n=v.length-1;n>=0;n--)if(h==v[n].name){v.splice(n,1);return}for(var x=[],s=[],E=i;E.type&&E.name!=h;){E._.isBlockLike||s.unshift(E);x.push(E);E=E.parent}if(E.type){for(n=
0;n<x.length;n++){var O=x[n];b(O,O.parent)}i=E;if(i.name=="pre")A=D;E._.isBlockLike&&a();b(E,E.parent);if(E==i)i=i.parent;v=v.concat(s)}if(h=="body")p=D};f.onText=function(h){if(!i._.hasInlineStarted&&!A){h=o.ltrim(h);if(h.length===0)return}a();d();if(p&&(!i.type||i.name=="body")&&o.trim(h))this.onTagOpen(p,{});A||(h=h.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));i.add(new y.HtmlParser.Text(h))};f.onCDATA=function(){};f.onComment=function(h){i.add(new y.HtmlParser.Comment(h))};f.parse(r);for(a();i.type;){var u=
i.parent,c=i;if(p&&(!u.type||u.name=="body")&&!j.$body[c.name]){i=u;f.onTagOpen(p,{});u=i}u.add(c);i=u}return m};C.augment(q,{add:function(r){var p=this.children.length;if(p=p>0&&this.children[p-1]||H){if(r._.isBlockLike&&p.type==e.NODE_TEXT){p.value=o.rtrim(p.value);if(p.value.length===0){this.children.pop();this.add(r);return}}p.next=r}r.previous=p;r.parent=this;this.children.push(r);this._.hasInlineStarted=r.type==e.NODE_TEXT||r.type==e.NODE_ELEMENT&&!r._.isBlockLike},writeHtml:function(r,p){var d;
this.filterChildren=this.filterChildren=function(){var a=new y.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,a,p,B);a=a.getHtml();this.children=(new q.FromHtml(a)).children;d=1};!this.name&&p&&p.onFragment(this);this.writeChildrenHtml(r,d?H:p)},writeChildrenHtml:function(r,p){for(var d=0;d<this.children.length;d++)this.children[d].writeHtml(r,p)}});y.HtmlParser.Fragment=q;y.HtmlParser.Fragment=q;q.FromHtml=q.FromHtml;C=q.prototype;y.Utils.extern(C,{add:C.add,writeHtml:C.writeHtml,writeChildrenHtml:C.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function q(w,C){this.name=w;this.attributes=C||(C={});this.children=[];var o=C._ke_real_element_type||w,e=B.XHTML_DTD;o=!!(e.$nonBodyContent[o]||e.$block[o]||e.$listItem[o]||e.$tableContent[o]||e.$nonEditable[o]||o=="br");var j=!!e.$empty[w];this.isEmpty=j;this.isUnknown=!e[w];this._={isBlockLike:o,hasInlineStarted:j||!o}}var B=KISSY.Editor,D=B.NODE,H=function(w,C){w=w[0];C=C[0];return w<C?-1:w>C?1:0};KISSY.augment(q,{type:D.NODE_ELEMENT,add:B.HtmlParser.Fragment.prototype.add,
clone:function(){return new q(this.name,this.attributes)},writeHtml:function(w,C){var o=this.attributes,e=this,j=e.name,l,g,t,r;e.filterChildren=function(){if(!r){var a=new B.HtmlParser.BasicWriter;B.HtmlParser.Fragment.prototype.writeChildrenHtml.call(e,a,C);e.children=(new B.HtmlParser.Fragment.FromHtml(a.getHtml())).children;r=1}};e.filterChildren=e.filterChildren;if(C){for(;;){if(!(j=C.onElementName(j)))return;e.name=j;if(!(e=C.onElement(e)))return;e.parent=this.parent;if(e.name==j)break;if(e.type!=
D.NODE_ELEMENT){e.writeHtml(w,C);return}j=e.name;if(!j){this.writeChildrenHtml.call(e,w,r?null:C);return}}o=e.attributes}w.openTag(j,o);for(var p=[],d=0;d<2;d++)for(l in o){g=l;t=o[l];if(d==1)p.push([l,t]);else if(C){for(;;)if(g=C.onAttributeName(l))if(g!=l){delete o[l];l=g}else break;else{delete o[l];break}if(g)if((t=C.onAttribute(e,g,t))===false)delete o[g];else o[g]=t}}w.sortAttributes&&p.sort(H);o=p.length;for(d=0;d<o;d++){l=p[d];w.attribute(l[0],l[1])}w.openTagClose(j,e.isEmpty);if(!e.isEmpty){this.writeChildrenHtml.call(e,
w,r?null:C);w.closeTag(j)}},writeChildrenHtml:function(){B.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});B.HtmlParser.Element=q;B.HtmlParser.Element=q;var y=q.prototype;B.Utils.extern(y,{type:y.type,add:y.add,clone:y.clone,writeHtml:y.writeHtml,writeChildrenHtml:y.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function q(l){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};l&&this.addRules(l,10)}function B(l,g){for(var t=0;l&&t<g.length;t++){var r=g[t];l=l.replace(r[0],r[1])}return l}function D(l,g,t){if(typeof g=="function")g=[g];var r,p;p=l.length;var d=g&&g.length;if(d){for(r=0;r<p&&l[r].pri<t;r++);for(p=d-1;p>=0;p--)if(d=g[p]){d.pri=t;l.splice(r,0,d)}}}function H(l,g,t){if(g)for(var r in g){var p=l[r];l[r]=y(p,g[r],
t);p||l.$length++}}function y(l,g,t){if(g){g.pri=t;if(l){if(l.splice)D(l,g,t);else{l=l.pri>t?[g,l]:[l,g];l.filter=w}return l}else return g.filter=g}}function w(l){for(var g=l.type||l instanceof o.HtmlParser.Fragment,t=0;t<this.length;t++){if(g)var r=l.type,p=l.name;var d=this[t].apply(window,arguments);if(d===j)return d;if(g){if(d&&(d.name!=p||d.type!=r))return d}else if(typeof d!="string")return d;d!=undefined&&(l=d)}return l}var C=KISSY,o=C.Editor,e=o.NODE,j=false;C.augment(q,{addRules:function(l,
g){if(typeof g!="number")g=10;D(this._.elementNames,l.elementNames,g);D(this._.attributeNames,l.attributeNames,g);H(this._.elements,l.elements,g);H(this._.attributes,l.attributes,g);this._.text=y(this._.text,l.text,g)||this._.text;this._.comment=y(this._.comment,l.comment,g)||this._.comment;this._.root=y(this._.root,l.root,g)||this._.root},onElementName:function(l){return B(l,this._.elementNames)},onAttributeName:function(l){return B(l,this._.attributeNames)},onText:function(l){var g=this._.text;
return g?g.filter(l):l},onComment:function(l,g){var t=this._.comment;return t?t.filter(l,g):l},onFragment:function(l){var g=this._.root;return g?g.filter(l):l},onElement:function(l){for(var g=[this._.elements["^"],this._.elements[l.name],this._.elements.$],t,r=0;r<3;r++)if(t=g[r]){t=t.filter(l,this);if(t===j)return null;if(t&&t!=l)return this.onNode(t);if(l.parent&&!l.name)break}return l},onNode:function(l){var g=l.type;return g==e.NODE_ELEMENT?this.onElement(l):g==e.NODE_TEXT?new o.HtmlParser.Text(this.onText(l.value)):
null},onAttribute:function(l,g,t){if(g=this._.attributes[g]){l=g.filter(t,l,this);if(l===j)return j;if(typeof l!="undefined")return l}return t}});o.HtmlParser.Filter=q;C=q.prototype;o.Utils.extern(C,{addRules:C.addRules,onElementName:C.onElementName,onAttributeName:C.onAttributeName,onText:C.onText,onComment:C.onComment,onFragment:C.onFragment,onElement:C.onElement,onNode:C.onNode,onAttribute:C.onAttribute});o.HtmlParser.Filter=q});
KISSY.Editor.add("htmlparser-text",function(){function q(y){this.value=y;this._={isBlockLike:H}}var B=KISSY,D=B.Editor,H=false;B.augment(q,{type:D.NODE.NODE_TEXT,writeHtml:function(y,w){var C=this.value;w&&!(C=w.onText(C,this))||y.text(C)}});D.HtmlParser.Text=q;D.HtmlParser.Text=q});
KISSY.Editor.add("htmlparser-comment",function(){function q(H){this.value=H;this._={isBlockLike:false}}var B=KISSY.Editor,D=B.NODE;B.HtmlParser.Comment=q;B.HtmlParser.Comment=q;q.prototype={constructor:q,type:D.NODE_COMMENT,writeHtml:function(H,y){var w=this.value;if(y){if(!(w=y.onComment(w,this)))return;if(typeof w!="string"){w.parent=this.parent;w.writeHtml(H,y);return}}H.comment(w)}}});
