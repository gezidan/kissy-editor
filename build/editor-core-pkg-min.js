/*
 Constructor for kissy editor and module dependency definition
 thanks to CKSource's intelligent work on CKEditor
 @author: yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.1
 @buildtime: 2010-12-15 15:11:30
*/
KISSY.add("editor",function(q,B){function D(w,i){function a(A){for(var n=D.Env.mods,C=0;C<A.length;C++){for(var l=A[C],r=t,I=0;I<C;I++)if(l==A[I]){r=y;break}I=n[l];if(r&&I){r=q.clone(I);l=l+"_"+C;r.name=l;A[C]=l;n[l]||(n[l]=r)}}}var b=this;if(!(b instanceof D))return new D(w,i);if(q.isString(w))w=q.one(w);w=z._4e_wrap(w);i=i||{};i.pluginConfig=i.pluginConfig||{};b.cfg=i;i.pluginConfig=i.pluginConfig;b.cfg=i;q.app(b,q.EventTarget);var d=["htmldataprocessor","enterkey","clipboard"],k=t;b.use=function(A,
n){A=A.split(",");a(A);if(!k)for(var C=0;C<d.length;C++){var l=d[C];q.inArray(l,A)||A.unshift(l)}b.ready(function(){q.use.call(b,A.join(","),function(){n&&n.call(b);if(!k){b.setData(w.val());if(i.focus)b.focus();else{var r=b.getSelection();r&&r.removeAllRanges()}b.fire("save");k=y}},{order:y,global:D})});return b};b.use=b.use;b.init(w);return b}function H(w){var i=q.Config.debug;w=i?i==="dev"?"../src/"+w:w:w.replace(/\.(js|css)/i,"-min.$1");w+=w.indexOf("?")!=-1?"&":"?";w+="t="+encodeURIComponent("2010-12-15 15:11:30");
return w}var z=q.DOM,y=true,t=false;q.app(D,q.EventTarget);D.Config.base=q.Config.base+"editor/";var u=["separator","sourcearea/support","tabs","flashbridge","flashutils","clipboard","colorsupport/dialog/colorpicker",{name:"colorsupport"},"color/dialog","color","elementpaths","enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},"draft",{name:"draft/support",requires:["localstorage"]},{name:"flash",requires:["fakeobjects"]},"flash/dialog",{name:"flash/support",
requires:["flashutils","contextmenu","bubbleview"]},{name:"font",requires:["select"]},"format","htmldataprocessor",{name:"image",requires:["contextmenu","bubbleview"]},{name:"image/dialog",requires:["tabs"]},"indent","indent/support","justify",{name:"link",requires:["bubbleview"]},"link/dialog","list/support","list","maximize","maximize/support",{name:"music/support",requires:["flash/support"]},{name:"music",requires:["fakeobjects"]},{name:"music/dialog",requires:["flash/dialog"]},"preview","removeformat",
"smiley",{name:"smiley/support"},{name:"sourcearea",requires:["sourcearea/support"]},{name:"table"},{name:"table/support",requires:["contextmenu"]},"table/dialog",{name:"templates"},"undo",{name:"resize"}],p,e,h,f,j={};p=0;for(e=u.length;p<e;p++){h=u[p];if(q.isString(h))h=u[p]={name:h+"",requires:null};f=h.requires||[];h.requires=f.concat(["button"])}u=[{name:"localstorage",requires:["flashutils","flashbridge"]},{name:"button"},"progressbar","overlay",{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",
requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(u);p=0;for(e=u.length;p<e;p++){h=u[p];f=h.name||h;j[f]={attach:t,charset:"utf-8",requires:h.requires,csspath:h.useCss?H("plugins/"+f+"/plugin.css"):B,path:H("plugins/"+f+"/plugin.js")}}D.add(j);q.Editor=D;q.Editor=D});
KISSY.Editor.add("utils",function(q){var B=null,D=KISSY,H=D.Node,z=D.DOM,y=D.UA,t=D.Event,u;u=y.ie?document.documentMode||y.ie:void 0;var p={debugUrl:function(e){var h=D.Config.debug;e=h?h==="dev"?"../src/"+e:e:e.replace(/\.(js|css)/i,"-min.$1");e+=e.indexOf("?")!=-1?"&":"?";e+="t="+encodeURIComponent("2010-12-15 15:11:30");return e},lazyRun:function(e,h,f){var j=e[h],w=e[f];e[h]=function(){j.apply(this,arguments);e[h]=e[f];return w.apply(this,arguments)}},getXY:function(e,h,f,j){f=f.defaultView||
f.parentWindow;e-=z.scrollLeft(f);h-=z.scrollTop(f);if(j)if(f!=(j.defaultView||j.parentWindow)&&f.frameElement){j=z._4e_getOffset(f.frameElement,j);e+=j.left;h+=j.top}return{left:e,top:h}},tryThese:function(){for(var e,h=0,f=arguments.length;h<f;h++){var j=arguments[h];try{e=j();break}catch(w){}}return e},arrayCompare:function(e,h){if(!e&&!h)return true;if(!e||!h||e.length!=h.length)return false;for(var f=0;f<e.length;f++)if(e[f]!==h[f])return false;return true},getByAddress:function(e,h,f){e=e.documentElement;
for(var j=0;e&&j<h.length;j++){var w=h[j];if(f)for(var i=-1,a=0;a<e.childNodes.length;a++){var b=e.childNodes[a];if(!(f===true&&b.nodeType==3&&b.previousSibling&&b.previousSibling.nodeType==3)){i++;if(i==w){e=b;break}}}else e=e.childNodes[w]}return e?new H(e):B},clearAllMarkers:function(e){for(var h in e)e[h]._4e_clearMarkers(e,true)},htmlEncodeAttr:function(e){return e.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(e){return e.replace(/^\s+/,"")},rtrim:function(e){return e.replace(/\s+$/,
"")},trim:function(e){return this.ltrim(this.rtrim(e))},mix:function(){for(var e={},h=0;h<arguments.length;h++)e=D.mix(e,arguments[h]);return e},isCustomDomain:function(){if(!y.ie)return false;var e=document.domain,h=window.location.hostname;return e!=h&&e!="["+h+"]"},duplicateStr:function(e,h){return Array(h+1).join(e)},throttle:function(e,h,f){f=f||150;if(f===-1)return function(){e.apply(h,arguments)};var j=(new Date).getTime();return function(){var w=(new Date).getTime();if(w-j>f){j=w;e.apply(h,
arguments)}}},buffer:function(e,h,f){f=f||0;var j=B;return function(){j&&clearTimeout(j);var w=arguments;j=setTimeout(function(){return e.apply(h,w)},f)}},isNumber:function(e){return/^\d+(.\d+)?$/.test(D.trim(e))},verifyInputs:function(e){for(var h=0;h<e.length;h++){var f=z._4e_wrap(e[h]),j=D.trim(f.val()),w=f.attr("data-verify");f=f.attr("data-warning");if(w&&!RegExp(w).test(j)){alert(f);return false}}return true},sourceDisable:function(e,h){e.on("sourcemode",h.disable,h);e.on("wysiwygmode",h.enable,
h)},resetInput:function(e){var h=e.attr("placeholder");if(h&&!y.webkit){e.addClass("ke-input-tip");e.val(h)}else y.webkit&&e.val("")},valInput:function(e,h){e.removeClass("ke-input-tip");e.val(h)},placeholder:function(e,h){e.attr("placeholder",h);if(!y.webkit){e.on("blur",function(){if(!D.trim(e.val())){e.addClass("ke-input-tip");e.val(h)}});e.on("focus",function(){e.removeClass("ke-input-tip");D.trim(e.val())==h&&e.val("")})}},clean:function(e){e=e[0]||e;for(var h=D.makeArray(e.childNodes),f=0;f<
h.length;f++){var j=h[f];j.nodeType==q.NODE.NODE_TEXT&&!D.trim(j.nodeValue)&&e.removeChild(j)}},htmlEncode:function(e){return!e?e:String(e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(e){return!e?e:String(e).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(e,h){return e.toLowerCase()==h.toLowerCase()},normParams:function(e){e=D.clone(e);for(var h in e)if(e.hasOwnProperty(h)){var f=
e[h];if(D.isFunction(f))e[h]=f()}return e},doFormUpload:function(e,h,f){function j(){var A={responseText:"",responseXML:B};A.argument=e?e.argument:B;try{var n;if((n=y.ie?i.contentWindow.document:i.contentDocument||window.frames[w].document)&&n.body)A.responseText=n.body.innerHTML;A.responseXML=n&&n.XMLDocument?n.XMLDocument:n}catch(C){D.log(C)}t.remove(i,"load",j);e.callback&&e.callback(A);setTimeout(function(){z._4e_remove(i)},100)}var w=D.guid("form-upload-"),i=document.createElement("iframe");
i.id=w;i.name=w;i.className="ke-hidden";var a="document.open();"+(p.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(y.ie)i.src=y.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";D.log("doFormUpload : "+i.src);document.body.appendChild(i);if(y.ie)document.frames[w].name=w;a=z._4e_unwrap(e.form);var b={target:a.target,method:a.method,encoding:a.encoding,enctype:a.enctype,action:a.action};a.target=w;a.method="POST";a.enctype=a.encoding="multipart/form-data";
if(f)a.action=f;var d;if(h){d=[];h=q.Utils.normParams(h);for(var k in h)if(h.hasOwnProperty(k)){f=document.createElement("input");f.type="hidden";f.name=k;f.value=h[k];a.appendChild(f);d.push(f)}}t.on(i,"load",j);a.submit();a.target=b.target;a.method=b.method;a.enctype=b.enctype;a.encoding=b.encoding;a.action=b.action;if(d){h=0;for(k=d.length;h<k;h++)z._4e_remove(d[h])}return i},extern:function(e,h){for(var f in h)e[f]=h[f]},map:function(e,h){for(var f=0;f<e.length;f++)e[f]=h(e[f]);return e},ieEngine:u,
preventFocus:function(e){y.ie?e._4e_unselectable():e.attr("onmousedown","return false;")},isFlashEmbed:function(e){e=e.attributes;return e.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(e.src||"")}};q.Utils=p;q.Utils=p;y.ieEngine=p.ieEngine;p.extern(p,{debugUrl:p.debugUrl,lazyRun:p.lazyRun,getXY:p.getXY,tryThese:p.tryThese,arrayCompare:p.arrayCompare,getByAddress:p.getByAddress,clearAllMarkers:p.clearAllMarkers,htmlEncodeAttr:p.htmlEncodeAttr,ltrim:p.ltrim,rtrim:p.rtrim,trim:p.trim,
mix:p.mix,isCustomDomain:p.isCustomDomain,duplicateStr:p.duplicateStr,buffer:p.buffer,isNumber:p.isNumber,verifyInputs:p.verifyInputs,sourceDisable:p.sourceDisable,resetInput:p.resetInput,placeholder:p.placeholder,clean:p.clean,htmlEncode:p.htmlEncode,htmlDecode:p.htmlDecode,equalsIgnoreCase:p.equalsIgnoreCase,normParams:p.normParams,throttle:p.throttle,doFormUpload:p.doFormUpload,map:p.map})});
KISSY.Editor.add("dom",function(q){function B(a){return a.replace(/-(\w)/g,function(b,d){return d.toUpperCase()})}var D=KISSY,H=D.DOM,z=D.UA,y=D.Node,t=q.Utils,u={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};q.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};q.NODE=q.NODE;q.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};q.POSITION=q.POSITION;var p=q.NODE,e=q.POSITION,h={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},f={hr:1},j=function(a){return a[0]||a},w=function(a){if(a&&!a[0])return new y(a);return a},i={_4e_wrap:w,_4e_unwrap:j,_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=j(a);b=j(b);
return a===b},_4e_isBlockBoundary:function(a,b){a=w(a);var d=D.mix(D.mix({},f),b||{});return h[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=j(a);for(var b=a.parentNode.childNodes,d=0;d<b.length;d++)if(b[d]===a)return d;return-1},_4e_first:function(a,b){a=j(a);var d=a.firstChild;if((d=d&&new y(d))&&b&&!b(d))d=d._4e_next(b);return d},_4e_move:function(a,b,d){a=j(a);H._4e_remove(a);
b=j(b);d?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_name:function(a){a=j(a);var b=a.nodeName.toLowerCase();if(z.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var d=a[0].attributes,k=b[0].attributes,A=d.length,n=k.length;if(A!=n)return false;for(var C=0;C<A;C++){var l=d[C],r=l.name;if(l.specified&&a.attr(r)!=b.attr(r))return false}if(t.ieEngine<8)for(C=0;C<n;C++){l=k[C];r=l.name;if(l.specified&&
a.attr(r)!=b.attr(r))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=j(a).childNodes;for(var b=0,d=a.length;b<d;b++){var k=a[b],A=k.nodeType;if(!(A==p.NODE_ELEMENT&&k.getAttribute("_ke_bookmark")))if(A==p.NODE_ELEMENT&&!i._4e_isEmptyInlineRemoveable(k)||A==p.NODE_TEXT&&D.trim(k.nodeValue))return false}return true},_4e_moveChildren:function(a,b,d){a=j(a);b=b[0]||b;if(a!=b)if(d)for(;d=a.lastChild;)b.insertBefore(a.removeChild(d),b.firstChild);else for(;d=a.firstChild;)b.appendChild(a.removeChild(d))},
_4e_mergeSiblings:function(){function a(b,d,k){if(d[0]&&d[0].nodeType==p.NODE_ELEMENT){for(var A=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){A.push(d);d=k?new y(d[0].nextSibling):new y(d[0].previousSibling);if(!d[0]||d[0].nodeType!=p.NODE_ELEMENT)return}if(b._4e_isIdentical(d)){for(var n=k?b[0].lastChild:b[0].firstChild;A.length;)A.shift()._4e_move(b,!k);d._4e_moveChildren(b,!k);d._4e_remove();n[0]&&n[0].nodeType==p.NODE_ELEMENT&&n._4e_mergeSiblings()}}}return function(b){if(b[0])if(u[b._4e_name()]||
b._4e_name()=="a"){a(b,new y(b[0].nextSibling),true);a(b,new y(b[0].previousSibling))}}}(),_4e_unselectable:z.gecko?function(a){a=j(a);a.style.MozUserSelect="none"}:z.webkit?function(a){a=j(a);a.style.KhtmlUserSelect="none"}:function(a){a=j(a);if(z.ie||z.opera){var b=0;a.setAttribute("unselectable","on");for(var d=a.getElementsByTagName("*");a=d[b++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.setAttribute("unselectable","on")}}},_4e_getOffset:function(a,
b){a=j(a);var d,k=0;d=0;var A=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,n=a.ownerDocument,C=n.documentElement;b=b||n;if(a.getBoundingClientRect){if(a!==n.body&&C!==a){d=a.getBoundingClientRect();k=d.left+(b===n?H.scrollLeft(A):0);d=d.top+(b===n?H.scrollTop(A):0)}if(b)if(A!=(b.defaultView||b.parentWindow)&&A.frameElement){A=i._4e_getOffset(A.frameElement,b);k+=A.left;d+=A.top}}return{left:k,top:d}},_4e_getFrameDocument:function(a){return(a=j(a))&&a.contentWindow.document},_4e_splitText:function(a,
b){a=j(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=p.NODE_TEXT)){if(z.ie&&b==a.nodeValue.length){var k=d.createTextNode("");H.insertAfter(k,a);return new y(k)}k=new y(a.splitText(b));if(d.documentMode){d=d.createTextNode("");H.insertAfter(d,k[0]);H._4e_remove(d)}return k}},_4e_parents:function(a,b){a=w(a);var d=[];do d[b?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,b,d){a=j(a);a=a.cloneNode(b);if(!d){var k=function(A){if(A.nodeType==p.NODE_ELEMENT){A.removeAttribute("id");
A=A.childNodes;for(var n=0;n<A.length;n++)k(A[n])}};k(a)}return new y(a)},_4e_nextSourceNode:function(a,b,d,k){a=j(a);if(k&&!k.call){var A=k[0]||k;k=function(C){C=C[0]||C;return C!==A}}b=!b&&a.firstChild;var n=new y(a);if(!b){if(a.nodeType==p.NODE_ELEMENT&&k&&k(a,true)===false)return null;b=a.nextSibling}for(;!b&&(n=n.parent());){if(k&&k(n,true)===false)return null;b=n[0].nextSibling}if(!b)return null;b=H._4e_wrap(b);if(k&&k(b)===false)return null;if(d&&d!=b[0].nodeType)return b._4e_nextSourceNode(false,
d,k);return b},_4e_previousSourceNode:function(a,b,d,k){a=j(a);if(k&&!k.call){var A=k[0]||k;k=function(C){C=C[0]||C;return C!==A}}b=!b&&a.lastChild;var n=new y(a);if(!b){if(a.nodeType==p.NODE_ELEMENT&&k&&k(a,true)===false)return null;b=a.previousSibling}for(;!b&&(n=n.parent());){if(k&&k(n,true)===false)return null;b=n[0].previousSibling}if(!b)return null;b=H._4e_wrap(b);if(k&&k(b)===false)return null;if(d&&b[0].nodeType!=d)return b._4e_previousSourceNode(false,d,k);return b},_4e_commonAncestor:function(a,
b){if(a._4e_equals(b))return a;if(b[0].nodeType!=p.NODE_TEXT&&b.contains(a))return b;var d=a[0].nodeType==p.NODE_TEXT?a.parent():a;do if(d[0].nodeType!=p.NODE_TEXT&&d.contains(b))return d;while(d=d.parent());return null},_4e_ascendant:function(a,b,d){a=j(a);if(!d)a=a.parentNode;if(b&&!D.isFunction(b)){var k=b;b=function(A){return A._4e_name()==k}}for(;a&&a.nodeType!=9;){if(!b||b(new y(a))===true)return new y(a);a=a.parentNode}return null},_4e_hasAttribute:t.ieEngine<9?function(a,b){a=j(a);var d=a.attributes[b];
return!!(d&&d.specified)}:function(a,b){a=j(a);return a.hasAttribute(b)},_4e_hasAttributes:t.ieEngine<9?function(a){a=j(a);for(var b=a.attributes,d=0;d<b.length;d++){var k=b[d];switch(k.name){case "class":if(a.getAttribute("class"))return true;break;default:if(k.specified)return true}}return false}:function(a){a=j(a);z.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,b){var d=j(a),k=j(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(k);if(d==
k)return e.POSITION_IDENTICAL;if(d.nodeType==p.NODE_ELEMENT&&k.nodeType==p.NODE_ELEMENT){if(d.contains){if(d.contains(k))return e.POSITION_CONTAINS+e.POSITION_PRECEDING;if(k.contains(d))return e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING}if("sourceIndex"in d)return d.sourceIndex<0||k.sourceIndex<0?e.POSITION_DISCONNECTED:d.sourceIndex<k.sourceIndex?e.POSITION_PRECEDING:e.POSITION_FOLLOWING}d=a._4e_address();k=b._4e_address();for(var A=Math.min(d.length,k.length),n=0;n<=A-1;n++)if(d[n]!=k[n]){if(n<
A)return d[n]<k[n]?e.POSITION_PRECEDING:e.POSITION_FOLLOWING;break}return d.length<k.length?e.POSITION_CONTAINS+e.POSITION_PRECEDING:e.POSITION_IS_CONTAINED+e.POSITION_FOLLOWING},_4e_address:function(a,b){a=j(a);for(var d=[],k=a.ownerDocument.documentElement,A=a;A&&A!=k;){var n=A.parentNode,C=-1;if(n){for(var l=0;l<n.childNodes.length;l++){var r=n.childNodes[l];if(!(b&&r.nodeType==3&&r.previousSibling&&r.previousSibling.nodeType==3)){C++;if(r==A)break}}d.unshift(C)}A=n}return d},_4e_breakParent:function(a,
b){var d=new q.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);var k=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(k,a[0].nextSibling)},_4e_style:function(a,b,d){a=w(a);if(d!==undefined)return a.css(b,d);a=j(a);return a.style[B(b)]},_4e_remove:function(a,b){var d=j(a),k=d.parentNode;if(k){if(b)for(var A;A=d.firstChild;)k.insertBefore(d.removeChild(A),d);k.removeChild(d)}return a},_4e_trim:function(a){H._4e_ltrim(a);H._4e_rtrim(a)},_4e_ltrim:function(a){a=
j(a);for(var b;b=a.firstChild;){if(b.nodeType==p.NODE_TEXT){var d=t.ltrim(b.nodeValue),k=b.nodeValue.length;if(d){if(d.length<k){(new y(b))._4e_splitText(k-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=j(a);for(var b;b=a.lastChild;){if(b.type==p.NODE_TEXT){var d=t.rtrim(b.nodeValue),k=b.nodeValue.length;if(d){if(d.length<k){(new y(b))._4e_splitText(d.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!z.ie&&!z.opera)(b=
a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=j(a);for(var b=a.lastChild;b&&b.nodeType==p.NODE_TEXT&&!D.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==p.NODE_TEXT||H._4e_name(b)!=="br"){b=z.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");z.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){var d=j(a),k;do k=(d=d.previousSibling)&&new y(d);while(k&&b&&!b(k));
return k},_4e_last:function(a,b){a=H._4e_wrap(a);var d=a[0].lastChild;if((d=d&&new y(d))&&b&&!b(d))d=d._4e_previous(b);return d},_4e_next:function(a,b){var d=j(a),k;do k=(d=d.nextSibling)&&new y(d);while(k&&b&&!b(k));return k},_4e_outerHtml:function(a){a=j(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,d,k){a=H._4e_wrap(a);var A=a.data("list_marker_id")||a.data("list_marker_id",
D.guid()).data("list_marker_id"),n=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[A]=a;n[d]=1;return a.data(d,k)},_4e_clearMarkers:function(a,b,d){a=w(a);var k=a.data("list_marker_names"),A=a.data("list_marker_id"),n;for(n in k)a.removeData(n);a.removeData("list_marker_names");if(d){a.removeData("list_marker_id");delete b[A]}},_4e_copyAttributes:function(a,b,d){a=j(a);b=w(b);var k=a.attributes;d=d||{};for(var A=0;A<k.length;A++){var n=k[A],C=n.name.toLowerCase(),
l;if(!(C in d))if(C=="checked"&&(l=H.attr(a,C)))b.attr(C,l);else if(n.specified||z.ie&&n.value&&C=="value"){l=H.attr(a,C);if(l===null)l=n.nodeValue;b.attr(C,l)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=H._4e_name(a);var b=q.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=w(a);var b=a[0].ownerDocument,d=H.scrollLeft(b),k=H.scrollTop(b),A=a.offset(),n=A.left;A=A.top;if(H.viewportHeight(b)+k<A||A<k||H.viewportWidth(b)+
d<n||n<d)a.scrollIntoView(b)},_4e_getElementsByTagName:function(a,b,d){a=j(a);if(!z.ie&&d)b=d+":"+b;d=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)d.push(new y(a[b]));return d}};D.DOM._4e_inject=function(a){D.mix(H,a);for(var b in a)a.hasOwnProperty(b)&&function(d){y.prototype[d]=function(){var k=[].slice.call(arguments,0);k.unshift(this);return a[d].apply(null,k)}}(b)};t.extern(i,{_4e_wrap:i._4e_wrap,_4e_unwrap:i._4e_unwrap,_4e_equals:i._4e_equals,_4e_isBlockBoundary:i._4e_isBlockBoundary,
_4e_getWin:i._4e_getWin,_4e_index:i._4e_index,_4e_first:i._4e_first,_4e_move:i._4e_move,_4e_name:i._4e_name,_4e_isIdentical:i._4e_isIdentical,_4e_isEmptyInlineRemoveable:i._4e_isEmptyInlineRemoveable,_4e_moveChildren:i._4e_moveChildren,_4e_mergeSiblings:i._4e_mergeSiblings,_4e_unselectable:i._4e_unselectable,_4e_getOffset:i._4e_getOffset,_4e_getFrameDocument:i._4e_getFrameDocument,_4e_splitText:i._4e_splitText,_4e_parents:i._4e_parents,_4e_clone:i._4e_clone,_4e_nextSourceNode:i._4e_nextSourceNode,
_4e_previousSourceNode:i._4e_previousSourceNode,_4e_commonAncestor:i._4e_commonAncestor,_4e_ascendant:i._4e_ascendant,_4e_hasAttribute:i._4e_hasAttribute,_4e_hasAttributes:i._4e_hasAttributes,_4e_position:i._4e_position,_4e_address:i._4e_address,_4e_breakParent:i._4e_breakParent,_4e_style:i._4e_style,_4e_remove:i._4e_remove,_4e_trim:i._4e_trim,_4e_ltrim:i._4e_ltrim,_4e_rtrim:i._4e_rtrim,_4e_appendBogus:i._4e_appendBogus,_4e_last:i._4e_last,_4e_previous:i._4e_previous,_4e_next:i._4e_next,_4e_outerHtml:i._4e_outerHtml,
_4e_setMarker:i._4e_setMarker,_4e_clearMarkers:i._4e_clearMarkers,_4e_getUniqueId:i._4e_getUniqueId,_4e_copyAttributes:i._4e_copyAttributes,_4e_isEditable:i._4e_isEditable,_4e_scrollIntoView:i._4e_scrollIntoView,_4e_getElementsByTagName:i._4e_getElementsByTagName});H._4e_inject(i)});
KISSY.Editor.add("focusmanager",function(q){function B(){this.iframeFocus=e;u=this;H.log(this._UUID+" focus")}function D(){this.iframeFocus=h;u=f;H.log(this._UUID+" blur")}var H=KISSY,z=H.DOM,y=H.Event,t={},u,p={refreshAll:function(){for(var j in t){var w=t[j];w.document.designMode="off";w.document.designMode="on"}},currentInstance:function(){return u},getInstance:function(j){return t[j]},add:function(j){var w=z._4e_getWin(j.document);y.on(w,"focus",B,j);y.on(w,"blur",D,j)},register:function(j){t[j._UUID]=
j},remove:function(j){delete t[j._UUID];var w=z._4e_getWin(j.document);y.remove(w,"focus",B,j);y.remove(w,"blur",D,j)}},e=true,h=false,f=null;q.focusManager=p;q.focusManager=p;q.getInstances=function(){return t};q.getInstances=q.getInstances});
KISSY.Editor.add("definition",function(q){var B=true,D=false,H=q.Utils,z=document,y=KISSY,t=y.UA,u=y.DOM,p=y.Node,e=y.Event,h=q.focusManager,f=H.tryThese,j=H.debugUrl("theme/editor-iframe.css"),w=1,i="document.open();"+(H.isCustomDomain()?'document.domain="'+z.domain+'";':"")+"document.close();",a="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"' ></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(t.ie?"javascript:void(function(){"+encodeURIComponent(i)+"}())":"")+'"  tabIndex="'+(t.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";q.SOURCE_MODE=0;q.WYSIWYG_MODE=1;q.SOURCE_MODE=q.SOURCE_MODE;q.WYSIWYG_MODE=q.WYSIWYG_MODE;y.augment(q,{init:function(b){if(t.ie)u.addClass(z.body,"ke-ie"+t.ie);else if(t.gecko)u.addClass(z.body,"ke-gecko");else t.webkit&&u.addClass(z.body,"ke-webkit");var d=this,k=new p(a.replace(/\$\(tabIndex\)/,
b.attr("tabIndex")));d.editorWrap=k;d._UUID=w++;h.register(d);d.wrap=k.one(".ke-textarea-wrap");d.wrap=d.wrap;d.iframe=d.wrap.one("iframe");d.iframe=d.iframe;d.toolBarDiv=k.one(".ke-editor-tools");d.toolBarDiv=d.toolBarDiv;d.textarea=b;d.textarea=d.textarea;d.statusDiv=k.one(".ke-editor-status");d.statusDiv=d.statusDiv;H.preventFocus(d.toolBarDiv);d._commands={};d._dialogs={};var A=b._4e_style("width"),n=b._4e_style("height");if(A){k.css("width",A);b.css("width","100%")}d.textarea.css("display","none");
k.insertAfter(b);d.wrap[0].appendChild(b[0]);if(n){d.wrap.css("height",n);b.css("height","100%")}k=d.iframe;d.on("dataReady",function(){d._ready=B;q.fire("instanceCreated",{editor:d})});t.gecko?k.on("load",d._setUpIFrame,d):d._setUpIFrame();d.cfg.attachForm&&b[0].form&&d._attachForm()},_attachForm:function(){(new p(this.textarea[0].form)).on("submit",this.sync,this)},useDialog:function(b,d){var k=this,A=q.Overlay;A.loading();k.use(b,function(){var n=k.getDialog(b);if(n){d(n);A.unloading()}else y.later(arguments.callee,
50,false,k)})},addDialog:function(b,d){this._dialogs[b]=d},getDialog:function(b){return this._dialogs[b]},addCommand:function(b,d){this._commands[b]=d},hasCommand:function(b){return this._commands[b]},execCommand:function(b){var d=this._commands[b],k=y.makeArray(arguments);k.shift();k.unshift(this);return d.exec.apply(d,k)},getMode:function(){return this.textarea.css("display")=="none"?q.WYSIWYG_MODE:q.SOURCE_MODE},getData:function(b){var d;d=this.getMode()==q.WYSIWYG_MODE?this.document.body.innerHTML:
this.textarea.val();if(this.htmlDataProcessor)d=b?this.htmlDataProcessor.toHtml(d,"p"):this.htmlDataProcessor.toServer(d,"p");d=y.trim(d);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(d))d="";return d},setData:function(b){var d=b;if(this.htmlDataProcessor)d=this.htmlDataProcessor.toDataFormat(b,"p");this.document.body.innerHTML=d;this.getMode()!=q.WYSIWYG_MODE&&this.textarea.val(b)},sync:function(){this.textarea.val(this.getData())},baseZIndex:function(b){b=b||0;return b+(this.cfg.baseZIndex||0)},_getRawData:function(){return this.document.body.innerHTML},
_setRawData:function(b){this.document.body.innerHTML=b},_prepareIFrameHtml:function(b){var d=this.cfg,k=d.customLink,A="";if(k)for(var n=0;n<k.length;n++)A+='<link href="'+k[n]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+q.Config.base+j+"' rel='stylesheet'/><style>"+(d.customStyle||"")+"</style>"+A+"</head><body class='ke-editor'>&nbsp;"+(b?'<script id="ke_actscript" type="text/javascript">'+(H.isCustomDomain()?'document.domain="'+z.domain+'";':"")+
'window.parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':"")+"</body></html>"},getSelection:function(){return q.Selection.getSelection(this.document)},focus:function(){var b=this.document,d=u._4e_getWin(b);t.webkit&&d&&d.parent&&d.parent.focus();t.webkit&&d&&d.focus();b&&b.body.focus();this.notifySelectionChange()},blur:function(){u._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(b){var d=this.cfg,k=this.document;d.customStyle=d.customStyle||
"";d.customStyle+="\n"+b;d=k.createElement("style");k.getElementsByTagName("head")[0].appendChild(d);if(d.styleSheet)d.styleSheet.cssText=b;else d.appendChild(k.createTextNode(b))},addCustomLink:function(b){var d=this.cfg,k=this.document;d.customLink=d.customLink||[];d.customLink.push(b);d=k.createElement("link");d.rel="stylesheet";k.getElementsByTagName("head")[0].appendChild(d);d.href=b},removeCustomLink:function(b){for(var d=this.cfg,k=y.makeArray(this.document.getElementsByTagName("link")),A=
0;A<k.length;A++)k[A].href==b&&u._4e_remove(k[A]);d.customLink=d.customLink||[];d=d.customLink;b=y.indexOf(b,d);b!=-1&&d.splice(b,1)},_setUpIFrame:function(){function b(){C=n.document;d.document=C;k.detach();C.open("text/html","replace");C.write(A);C.close()}var d=this,k=d.iframe,A=d._prepareIFrameHtml(d._UUID),n=k[0].contentWindow,C;try{C=n.document}catch(l){k[0].src=k[0].src;if(t.ie<7){setTimeout(b,10);return}}b()},ready:function(b){this._ready?b():this.on("dataReady",b)},_monitor:function(){var b=
this;b._monitorId&&clearTimeout(b._monitorId);b._monitorId=setTimeout(function(){var d=b.getSelection();if(d&&!d.isInvalid){var k=d.getStartElement(),A=new q.ElementPath(k);if(!b.previousPath||!b.previousPath.compare(A)){b.previousPath=A;b.fire("selectionChange",{selection:d,path:A,element:k})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(b,d,k){var A=this;A.focus();setTimeout(function(){var n,C=b._4e_name(),l=q.XHTML_DTD,r=q.RANGE,I=q.NODE,
v=l.$block[C],c=A.getSelection(),g=c&&c.getRanges(),m,s,o,x;if(!g||g.length==0){var O=arguments,P=O.callee;setTimeout(function(){P.apply(A,O)},30)}else{A.fire("save");for(var L=g.length-1;L>=0;L--){m=g[L];m.deleteContents();n=!L&&b||b._4e_clone(B);d&&d(n);if(v)for(;(o=m.getCommonAncestor(D,B))&&(x=l[o._4e_name()])&&!(x&&x[C]);)if(o._4e_name()in l.span)m.splitElement(o);else if(m.checkStartOfBlock()&&m.checkEndOfBlock()){m.setStartBefore(o);m.collapse(B);o._4e_remove()}else m.splitBlock();m.insertNode(n);
s||(s=n)}if(s){C=s._4e_nextSourceNode(B);l=A.document;x=q.XHTML_DTD;if(x.$inline[n._4e_name()]){C=new p(l.createTextNode(" "));C.insertAfter(s)}else if(C){if(C._4e_name()=="br"&&x[C.parent()._4e_name()].p){x=new p("<p>&nbsp;</p>",null,l);C[0].parentNode.replaceChild(x[0],C[0]);C=x}}else{x=new p("<p>&nbsp;</p>",null,l);x.insertAfter(s);C=x}m.moveToPosition(s,r.POSITION_AFTER_END);C&&C[0].nodeType==I.NODE_ELEMENT&&m.moveToElementEditablePosition(C);c.selectRanges([m]);A.focus();n&&n._4e_scrollIntoView();
setTimeout(function(){A.fire("save")},10);k&&k(n)}}},0)},insertHtml:function(b){var d=this;if(d.htmlDataProcessor)b=d.htmlDataProcessor.toDataFormat(b);if(t.webkit){var k=u.create(b,null,d.document);k=k.nodeType==11?y.makeArray(k.childNodes):[k];for(var A=0;A<k.length;A++)d.insertElement(new p(k[A]))}else{d.focus();setTimeout(function(){var n=d.getSelection(),C=n&&n.getRanges();if(!C||C.length==0){var l=arguments,r=l.callee;setTimeout(function(){r.apply(d,l)},30)}else{d.fire("save");if(t.ie){n=n.getNative();
n.type=="Control"&&n.clear();n.createRange().pasteHTML(b)}else d.document.execCommand("inserthtml",D,b);setTimeout(function(){d.fire("save")},10)}},0)}}});q._initIFrame=function(b){function d(g){f(function(){n.designMode="on";setTimeout(function(){n.designMode="off";r.focus();if(!arguments.callee.retry)arguments.callee.retry=B},50)},function(){n.designMode="off";u.attr(r,"contentEditable",D);u.attr(r,"contentEditable",B);!g&&d(1)})}var k=h.getInstance(b);b=k.textarea[0];var A=k.iframe[0].contentWindow,
n=k.document,C=k.cfg,l=n.getElementById("ke_actscript");u._4e_remove(l);var r=n.body;if(t.ie){r.hideFocus=B;r.disabled=B;r.contentEditable=B;r.removeAttribute("disabled")}else setTimeout(function(){if(t.gecko||t.opera)r.contentEditable=B;else if(t.webkit)r.parentNode.contentEditable=B;else n.designMode="on"},0);if(t.webkit){e.on(n,"click",function(g){var m=new p(g.target);y.inArray(m._4e_name(),["input","select"])&&g.preventDefault()});e.on(n,"mouseup",function(g){var m=new p(g.target);y.inArray(m._4e_name(),
["input","textarea"])&&g.preventDefault()})}if(t.gecko||t.ie||t.opera){var I;I=new p(u.insertAfter((new p('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],b));I.on("focus",function(){k.focus()});k.activateGecko=function(){t.gecko&&k.iframeFocus&&I[0].focus()};k.on("destroy",function(){})}if(t.ie&&n.compatMode=="CSS1Compat"||t.gecko||t.opera){var v=new p(n.documentElement);v.on("mousedown",function(g){if((new p(g.target))[0]==v[0]){t.gecko&&d(D);I[0].focus()}})}e.on(A,
"focus",function(){if(t.gecko)d(D);else t.opera&&r.focus();k.notifySelectionChange()});t.gecko&&e.on(k.document,"mousedown",function(){k.iframeFocus||d(D)});if(t.ie){e.on(n,"keydown",function(g){if(g.keyCode in{8:1,46:1}){var m=k.getSelection(),s=m.getSelectedElement();if(s){k.fire("save");var o=m.getRanges()[0].createBookmark();s._4e_remove();m.selectBookmarks([o]);k.fire("save");g.preventDefault()}}});if(n.compatMode=="CSS1Compat"){var c={33:1,34:1};e.on(n,"keydown",function(g){g.keyCode in c&&
setTimeout(function(){k.getSelection().scrollIntoView()},0)})}}setTimeout(function(){t.ie&&setTimeout(function(){if(n){r.runtimeStyle.marginBottom="0px";r.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){k.fire("dataReady");var g=C.disableObjectResizing,m=C.disableInlineTableEditing;if(g||m)try{n.execCommand("enableObjectResizing",D,!g);n.execCommand("enableInlineTableEditing",D,!m)}catch(s){e.on(r,t.ie?"resizestart":"resize",function(o){var x=new p(o.target);if(g||x._4e_name()==="table"&&
m)o.preventDefault()})}},10);t.webkit&&e.on(n,"mousedown",function(g){g=new p(g.target);y.inArray(g._4e_name(),["img","hr","input","textarea","select"])&&k.getSelection().selectElement(g)});t.gecko&&e.on(n,"dragstart",function(g){var m=new p(g.target);m._4e_name()==="img"&&/ke_/.test(m[0].className)&&g.preventDefault()});h.add(k)};i=q.prototype;H.extern(i,{setData:i.setData,getData:i.getData,insertElement:i.insertElement,insertHtml:i.insertHtml,ready:i.ready,addCustomStyle:i.addCustomStyle,addCommand:i.addCommand,
hasCommand:i.hasCommand,execCommand:i.execCommand,useDialog:i.useDialog,addDialog:i.addDialog,getDialog:i.getDialog,getMode:i.getMode,sync:i.sync,baseZIndex:i.baseZIndex,getSelection:i.getSelection,focus:i.focus,blur:i.blur,notifySelectionChange:i.notifySelectionChange})});
KISSY.Editor.add("zindex",function(){var q=KISSY.Editor;if(!q.zIndexManager){q.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};q.baseZIndex=function(B){var D=B,H=q.getInstances(),z;for(z in H){if(!H.hasOwnProperty(z))return;D=Math.max(D,H[z].baseZIndex(B))}return D};q.baseZIndex=q.baseZIndex;q.zIndexManager=q.zIndexManager}});
KISSY.Editor.add("dtd",function(q){q.XHTML_DTD=function(){function B(C){for(var l=arguments.length-1;l>0;)KISSY.mix(C,arguments[l--]);return C}var D={isindex:1,fieldset:1},H={input:1,button:1,select:1,textarea:1,label:1},z=B({a:1},H),y=B({iframe:1},z),t={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},u={ins:1,del:1,script:1,style:1},p=B({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},u),e=B({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},p),h=B({p:1},e);H=B({iframe:1},e,H);e={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var f=B({a:1},H),j={tr:1},w={"#":1},i=B({param:1},e),a=B({form:1},D,y,t,h),b={li:1},d={base:1,link:1,meta:1,title:1},k=B(d,{style:1,script:1}),A={head:1,body:1},n={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:B({html:1},A,d),$block:n,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:f,$body:B({script:1,style:1},n),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:A,head:k,style:w,body:a,base:{},link:{},meta:{},title:w,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:f,button:B(h,t),basefont:{},h5:f,h4:f,samp:f,h6:f,ol:b,h1:f,h3:f,option:w,h2:f,form:B(D,y,t,h),select:{optgroup:1,option:1},font:f,ins:f,menu:b,abbr:f,label:f,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:f,script:w,tfoot:j,cite:f,li:a,input:{},iframe:a,strong:f,textarea:w,noframes:a,big:f,small:f,span:f,hr:{},dt:f,sub:f,optgroup:{option:1},param:{},bdo:f,"var":f,div:a,object:i,sup:f,dd:a,strike:f,area:{},dir:b,map:B({area:1,form:1,p:1},D,u,t),applet:i,dl:{dt:1,dd:1},del:f,isindex:{},fieldset:B({legend:1},e),thead:j,ul:b,acronym:f,b:f,a:H,blockquote:a,caption:f,i:f,u:f,tbody:j,s:f,address:B(y,h),tt:f,legend:f,q:f,pre:B(p,z),p:f,em:f,dfn:f}}();q.XHTML_DTD=
q.XHTML_DTD});
KISSY.Editor.add("elementpath",function(q){function B(e){var h=y,f=y,j=[];for(e=e;e&&e[0];){if(e[0].nodeType==z.NODE_ELEMENT){if(!this.lastElement)this.lastElement=e;var w=e._4e_name();if(!f){if(!h&&t[w])h=e;if(u[w]){var i;if(i=!h){if(i=w=="div"){a:{i=e;i=i[0]||i;i=i.childNodes;for(var a=0,b=i.length;a<b;a++){var d=i[a];if(d.nodeType==z.NODE_ELEMENT&&H.$block[d.nodeName.toLowerCase()]){i=true;break a}}i=false}i=!i}i=i}if(i)h=e;else f=e}}j.push(e);if(w=="body")break}e=e.parent()}this.block=this.block=
h;this.blockLimit=this.blockLimit=f;this.elements=this.elements=j}var D=KISSY.DOM,H=q.XHTML_DTD,z=q.NODE,y=null,t={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},u={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};B.prototype={compare:function(e){var h=this.elements;e=e&&e.elements;if(!e||h.length!=e.length)return false;for(var f=0;f<h.length;f++)if(!D._4e_equals(h[f],e[f]))return false;return true},contains:function(e){for(var h=this.elements,f=0;f<
h.length;f++)if(h[f]._4e_name()in e)return h[f];return y}};q.ElementPath=q.ElementPath=B;var p=B.prototype;q.Utils.extern(p,{compare:p.compare,contains:p.contains})});
KISSY.Editor.add("walker",function(q){function B(j,w){if(this._.end)return t;var i,a=this.range,b,d=this.guard,k=this.type,A=j?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;a.trim();if(a.collapsed){this.end();return t}}if(!j&&!this._.guardLTR){var n=a.endContainer,C=new h(n[0].childNodes[a.endOffset]);this._.guardLTR=function(v,c){return(v=e._4e_wrap(v))&&v[0]&&(!c||!e._4e_equals(n,v))&&(!C[0]||!v._4e_equals(C))&&(v[0].nodeType!=p.NODE_ELEMENT||!c||v._4e_name()!="body")}}if(j&&
!this._.guardRTL){var l=a.startContainer,r=a.startOffset>0&&new h(l[0].childNodes[a.startOffset-1]);this._.guardRTL=function(v,c){return(v=e._4e_wrap(v))&&v[0]&&(!c||!v._4e_equals(l))&&(!r[0]||!v._4e_equals(r))&&(v[0].nodeType!=p.NODE_ELEMENT||!c||v._4e_name()!="body")}}var I=j?this._.guardRTL:this._.guardLTR;b=d?function(v,c){if(I(v,c)===y)return y;return d(v,c)}:I;if(this.current)i=this.current[A](y,k,b);else if(j){i=a.endContainer;if(a.endOffset>0){i=new h(i[0].childNodes[a.endOffset-1]);if(b(i)===
y)i=t}else i=b(i,z)===y?t:i._4e_previousSourceNode(z,k,b)}else{i=a.startContainer;if((i=new h(i[0].childNodes[a.startOffset]))&&i[0]){if(b(i)===y)i=t}else i=b(a.startContainer,z)===y?t:a.startContainer._4e_nextSourceNode(z,k,b)}for(;i&&i[0]&&!this._.end;){this.current=i;if(!this.evaluator||this.evaluator(i)!==y){if(!w)return i}else if(w&&this.evaluator)return y;i=i[A](y,k,b)}this.end();return this.current=t}function D(j){for(var w,i=t;w=B.call(this,j);)i=w;return i}function H(j){this.range=j;this._=
{}}var z=true,y=false,t=null,u=KISSY,p=q.NODE,e=u.DOM,h=u.Node;u.augment(H,{end:function(){this._.end=1},next:function(){return B.call(this)},previous:function(){return B.call(this,z)},checkForward:function(){return B.call(this,y,z)!==y},checkBackward:function(){return B.call(this,z,z)!==y},lastForward:function(){return D.call(this)},lastBackward:function(){return D.call(this,z)},reset:function(){delete this.current;this._={}}});H.blockBoundary=function(j){return function(w){w=e._4e_wrap(w);return!(w&&
w[0].nodeType==p.NODE_ELEMENT&&w._4e_isBlockBoundary(j))}};H.listItemBoundary=function(){return this.blockBoundary({br:1})};H.bookmark=function(j,w){function i(a){return a&&a[0]&&a._4e_name()=="span"&&a.attr("_ke_bookmark")}return function(a){var b,d;b=a&&a[0]&&a[0].nodeType==p.NODE_TEXT&&(d=a.parent())&&i(d);b=j?b:b||i(a);return w^b}};H.whitespaces=function(j){return function(w){w=(w=w[0]||w)&&w.nodeType==p.NODE_TEXT&&!u.trim(w.nodeValue);return j^w}};H.invisible=function(j){var w=H.whitespaces();
return function(i){i=w(i)||i[0].nodeType==p.NODE_ELEMENT&&!i[0].offsetHeight;return j^i}};q.Walker=H;q.Walker=H;var f=H.prototype;q.Utils.extern(f,{end:f.end,next:f.next,previous:f.previous,checkForward:f.checkForward,checkBackward:f.checkBackward,lastForward:f.lastForward,lastBackward:f.lastBackward,reset:f.reset});q.Utils.extern(H,{blockBoundary:H.blockBoundary,listItemBoundary:H.listItemBoundary,bookmark:H.bookmark,whitespaces:H.whitespaces,invisible:H.invisible})});
KISSY.Editor.add("range",function(q){function B(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=e;this.collapsed=u;this.document=c}function D(c){var g=c[0].nodeType!=f.NODE_TEXT&&c._4e_name()in k.$removeEmpty,m=!h.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return g||m||c}function H(c){return!r(c)&&!I(c)}function z(c){var g=p,m=i.bookmark(u);return function(s){if(m(s))return u;if(s[0].nodeType==f.NODE_TEXT){if(h.trim(s[0].nodeValue).length)return p}else if(s[0].nodeType==
f.NODE_ELEMENT)if(!l[s._4e_name()])if(!c&&!d.ie&&s._4e_name()=="br"&&!g)g=u;else return p;return u}}function y(c,g){function m(s){return s&&s.nodeName=="span"&&s.getAttribute("_ke_bookmark")}return function(s){var o,x;o=s&&!s.nodeName&&(x=s.parentNode)&&m(x);o=c?o:o||m(s);return g^o}}function t(c){return function(g){g=(g=g[0]||g)&&g.nodeType==f.NODE_TEXT&&!h.trim(g.nodeValue);return c^g}}q.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};q.RANGE=q.RANGE;var u=true,p=false,e=null,h=KISSY,f=q.NODE,j=q.RANGE,w=q.POSITION,i=q.Walker,a=h.DOM,b=q.Utils.getByAddress,d=h.UA,k=q.XHTML_DTD,A=q.ElementPath,n=h.Node,C={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};B.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return c.join("<br/>")};h.augment(B,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,g=this.startOffset;if(c[0].nodeType!=f.NODE_ELEMENT)if(g)g>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;g=this.endOffset;if(c[0].nodeType!=f.NODE_ELEMENT)if(g)g>=
c[0].nodeValue.length&&this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,g=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,j.POSITION_BEFORE_START);
g&&g._4e_name()=="span"&&g.attr("_ke_bookmark")&&this.setEndAt(g,j.POSITION_AFTER_END)},setStart:function(c,g){if(c[0].nodeType==f.NODE_ELEMENT&&C[c._4e_name()]){c=c.parent();g=c._4e_index()}this.startContainer=c;this.startOffset=g;if(!this.endContainer){this.endContainer=c;this.endOffset=g}this.updateCollapsed()},setEnd:function(c,g){if(c[0].nodeType==f.NODE_ELEMENT&&C[c._4e_name()]){c=c.parent();g=c._4e_index()+1}this.endContainer=c;this.endOffset=g;if(!this.startContainer){this.startContainer=
c;this.startOffset=g}this.updateCollapsed()},setStartAt:function(c,g){switch(g){case j.POSITION_AFTER_START:this.setStart(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==f.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setStartBefore(c);break;case j.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,g){switch(g){case j.POSITION_AFTER_START:this.setEnd(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==
f.NODE_TEXT?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setEndBefore(c);break;case j.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,g){var m=this.startContainer,s=this.endContainer,o=this.startOffset,x=this.endOffset,O,P=this.document,L;this.optimizeBookmark();if(s[0].nodeType==f.NODE_TEXT)s=s._4e_splitText(x);else if(s[0].childNodes.length>0)if(x>=s[0].childNodes.length){s=new n(s[0].appendChild(P.createTextNode("")));
L=u}else s=new n(s[0].childNodes[x]);if(m[0].nodeType==f.NODE_TEXT){m._4e_splitText(o);if(m._4e_equals(s))s=new n(m[0].nextSibling)}else if(o)if(o>=m[0].childNodes.length){O=new n(P.createTextNode(""));m.append(O);m=O;O=u}else m=new n(m[0].childNodes[o].previousSibling);else{O=new n(P.createTextNode(""));m.prepend(O);m=O;O=u}o=m._4e_parents();x=s._4e_parents();var Q,S,U;for(Q=0;Q<o.length;Q++){S=o[Q];U=x[Q];if(!S._4e_equals(U))break}P=g;for(var T,V,E,K=Q;K<o.length;K++){T=o[K];V=P&&!T._4e_equals(m)?
P.appendChild(T._4e_clone()[0]):null;for(T=T[0].nextSibling;T;){if(a._4e_equals(x[K],T)||a._4e_equals(s,T))break;E=T.nextSibling;if(c==2)P.appendChild(T.cloneNode(u));else{a._4e_remove(T);c==1&&P.appendChild(T)}T=E}if(V)P=V}P=g;for(Q=Q;Q<x.length;Q++){T=x[Q];V=P&&c>0&&!T._4e_equals(s)?P.appendChild(T._4e_clone()[0]):null;if(!o[Q]||!T.parent()._4e_equals(o[Q].parent()))for(T=T[0].previousSibling;T;){if(a._4e_equals(o[Q],T)||a._4e_equals(m,T))break;E=T.previousSibling;if(c==2)P.insertBefore(T.cloneNode(u),
P.firstChild);else{a._4e_remove(T);c==1&&P.insertBefore(T,P.firstChild)}T=E}if(V)P=V}if(c==2){U=this.startContainer[0];if(U.nodeType==f.NODE_TEXT&&U.nextSibling&&U.nextSibling.nodeType==f.NODE_TEXT){U.data+=U.nextSibling.data;U.parentNode.removeChild(U.nextSibling)}U=this.endContainer[0];if(U.nodeType==f.NODE_TEXT&&U.nextSibling&&U.nextSibling.nodeType==f.NODE_TEXT){U.data+=U.nextSibling.data;U.parentNode.removeChild(U.nextSibling)}}else{if(S&&U&&(!m.parent()._4e_equals(S.parent())||!s.parent()._4e_equals(U.parent()))){S=
U._4e_index();O&&U.parent()._4e_equals(m.parent())&&S--;this.setStart(U.parent(),S)}this.collapse(u)}O&&m._4e_remove();L&&s[0].parentNode&&s._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=u},clone:function(){var c=new B(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;c.endContainer=this.endContainer;c.endOffset=
this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=f.NODE_ELEMENT||c.endContainer[0].nodeType!=f.NODE_ELEMENT)return e;var g=new q.Walker(c),m=y(u,undefined),s=t(u);c.evaluator=function(o){return s(o)&&m(o)};c=g.next();g.reset();g=g.previous();return c&&c._4e_equals(g)?c:e},shrink:function(c,g){if(!this.collapsed){c=c||j.SHRINK_TEXT;var m=this.clone(),s=this.startContainer,o=this.endContainer,x=this.startOffset,
O=this.endOffset,P=1,L=1;if(s&&s[0].nodeType==f.NODE_TEXT)if(x)if(x>=s[0].nodeValue.length)m.setStartAfter(s);else{m.setStartBefore(s);P=0}else m.setStartBefore(s);if(o&&o[0].nodeType==f.NODE_TEXT)if(O)if(O>=o[0].nodeValue.length)m.setEndAfter(o);else{m.setEndAfter(o);L=0}else m.setEndBefore(o);m=new i(m);m.evaluator=function(S){S=S[0]||S;return S.nodeType==(c==j.SHRINK_ELEMENT?f.NODE_ELEMENT:f.NODE_TEXT)};var Q;m.guard=function(S,U){S=S[0]||S;if(c==j.SHRINK_ELEMENT&&S.nodeType==f.NODE_TEXT)return p;
if(U&&S==Q)return p;if(!U&&S.nodeType==f.NODE_ELEMENT)Q=S;return u};if(P)(s=m[c==j.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(s,g?j.POSITION_AFTER_START:j.POSITION_BEFORE_START);if(L){m.reset();(m=m[c==j.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(m,g?j.POSITION_BEFORE_END:j.POSITION_AFTER_END)}return!!(P||L)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||c[0].nodeType!=f.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var g=
this.startContainer,m=this.endContainer,s=this.startOffset,o=this.endOffset,x,O;if(!g||!m)return{start:0,end:0};if(c){if(g[0].nodeType==f.NODE_ELEMENT)if((x=new n(g[0].childNodes[s]))&&x[0]&&x[0].nodeType==f.NODE_TEXT&&s>0&&x[0].previousSibling.nodeType==f.NODE_TEXT){g=x;s=0}for(;g[0].nodeType==f.NODE_TEXT&&(O=g._4e_previous())&&O[0].nodeType==f.NODE_TEXT;){g=O;s+=O[0].nodeValue.length}if(!this.collapsed){if(m[0].nodeType==f.NODE_ELEMENT)if((x=new n(m[0].childNodes[o]))&&x[0]&&x[0].nodeType==f.NODE_TEXT&&
o>0&&x[0].previousSibling.nodeType==f.NODE_TEXT){m=x;o=0}for(;m[0].nodeType==f.NODE_TEXT&&(O=m._4e_previous())&&O[0].nodeType==f.NODE_TEXT;){m=O;o+=O[0].nodeValue.length}}}return{start:g._4e_address(c),end:this.collapsed?e:m._4e_address(c),startOffset:s,endOffset:o,normalized:c,is2:u}},createBookmark:function(c){var g,m,s,o,x=this.collapsed;g=new n("<span>",e,this.document);g.attr("_ke_bookmark",1);g.css("display","none");g.html("&nbsp;");if(c){s=h.guid("ke_bm_");g.attr("id",s+"S")}if(!x){m=g._4e_clone();
m.html("&nbsp;");c&&m.attr("id",s+"E");o=this.clone();o.collapse();o.insertNode(m)}o=this.clone();o.collapse(u);o.insertNode(g);if(m){this.setStartAfter(g);this.setEndBefore(m)}else this.moveToPosition(g,j.POSITION_AFTER_END);return{startNode:c?s+"S":g,endNode:c?s+"E":m,serializable:c,collapsed:x}},moveToPosition:function(c,g){this.setStartAt(c,g);this.collapse(u)},trim:function(c,g){var m=this.startContainer,s=this.startOffset,o=this.collapsed;if((!c||o)&&m[0]&&m[0].nodeType==f.NODE_TEXT){if(s)if(s>=
m[0].nodeValue.length){s=m._4e_index()+1;m=m.parent()}else{var x=m._4e_splitText(s);s=m._4e_index()+1;m=m.parent();if(a._4e_equals(this.startContainer,this.endContainer))this.setEnd(x,this.endOffset-this.startOffset);else if(a._4e_equals(m,this.endContainer))this.endOffset+=1}else{s=m._4e_index();m=m.parent()}this.setStart(m,s);if(o){this.collapse(u);return}}m=this.endContainer;s=this.endOffset;if(!(g||o)&&m[0]&&m[0].nodeType==f.NODE_TEXT){if(s){s>=m.nodeValue.length||m._4e_splitText(s);s=m._4e_index()+
1}else s=m._4e_index();m=m.parent();this.setEnd(m,s)}},insertNode:function(c){this.optimizeBookmark();this.trim(p,u);var g=this.startContainer;g[0].insertBefore(c[0]||c,g[0].childNodes[this.startOffset]||null);a._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var g=b(this.document,c.start,c.normalized),m=c.startOffset,s=c.end&&b(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(g,m);s?this.setEnd(s,c):this.collapse(u)}else{g=
(m=c.serializable)?h.one("#"+c.startNode,this.document):c.startNode;c=m?h.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(g);g._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(u)}},getCommonAncestor:function(c,g){var m=this.startContainer,s=this.endContainer;m=a._4e_equals(m,s)?c&&m[0].nodeType==f.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new n(m[0].childNodes[this.startOffset]):m:m._4e_commonAncestor(s);return g&&m[0].nodeType==f.NODE_TEXT?m.parent():
m},enlarge:function(c){switch(c){case j.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var g=new n(this.document.body),m,s,o,x,O,P=p,L,Q;L=this.startContainer;Q=this.startOffset;if(L[0].nodeType==f.NODE_TEXT){if(Q){L=!h.trim(L[0].nodeValue.substring(0,Q)).length&&L;P=!!L}if(L)if(!(x=L[0].previousSibling))o=L.parent()}else{if(Q)x=L[0].childNodes[Q-1]||L[0].lastChild;x||(o=L)}for(;o||x;){if(o&&!x){if(!O&&a._4e_equals(o,c))O=u;if(!g.contains(o))break;if(!P||o.css("display")!="inline"){P=
p;if(O)m=o;else this.setStartBefore(o)}x=o[0].previousSibling}for(;x;){L=p;if(x.nodeType==f.NODE_TEXT){Q=x.nodeValue;if(/[^\s\ufeff]/.test(Q))x=e;L=/[\s\ufeff]$/.test(Q)}else if(x.offsetWidth>0&&!x.getAttribute("_ke_bookmark"))if(P&&k.$removeEmpty[x.nodeName.toLowerCase()]){Q=a.text(x);if(/[^\s\ufeff]/.test(Q))x=e;else for(var S=x.all||x.getElementsByTagName("*"),U=0,T;T=S[U++];)if(!k.$removeEmpty[T.nodeName.toLowerCase()]){x=e;break}if(x)L=!!Q.length}else x=e;if(L)if(P)if(O)m=o;else o&&this.setStartBefore(o);
else P=u;if(x){L=x.previousSibling;if(!o&&!L){o=new n(x);x=e;break}x=L}else o=e}if(o)o=o.parent()}L=this.endContainer;Q=this.endOffset;o=x=e;O=P=p;if(L[0].nodeType==f.NODE_TEXT){L=!h.trim(L[0].nodeValue.substring(Q)).length&&L;P=!(L&&L[0].nodeValue.length);if(L)if(!(x=L[0].nextSibling))o=L.parent()}else(x=L[0].childNodes[Q])||(o=L);for(;o||x;){if(o&&!x){if(!O&&a._4e_equals(o,c))O=u;if(!g.contains(o))break;if(!P||o.css("display")!="inline"){P=p;if(O)s=o;else o&&this.setEndAfter(o)}x=o[0].nextSibling}for(;x;){L=
p;if(x.nodeType==f.NODE_TEXT){Q=x.nodeValue;if(/[^\s\ufeff]/.test(Q))x=e;L=/^[\s\ufeff]/.test(Q)}else if(x.offsetWidth>0&&!x.getAttribute("_ke_bookmark"))if(P&&k.$removeEmpty[x.nodeName.toLowerCase()]){Q=a.text(x);if(/[^\s\ufeff]/.test(Q))x=e;else{S=x.all||x.getElementsByTagName("*");for(U=0;T=S[U++];)if(!k.$removeEmpty[T.nodeName.toLowerCase()]){x=e;break}}if(x)L=!!Q.length}else x=e;if(L)if(P)if(O)s=o;else this.setEndAfter(o);if(x){L=x.nextSibling;if(!o&&!L){o=new n(x);x=e;break}x=L}else o=e}if(o)o=
o.parent()}if(m&&s){c=m.contains(s)?s:m;this.setStartBefore(c);this.setEndAfter(c)}break;case j.ENLARGE_BLOCK_CONTENTS:case j.ENLARGE_LIST_ITEM_CONTENTS:o=new B(this.document);g=new n(this.document.body);o.setStartAt(g,j.POSITION_AFTER_START);o.setEnd(this.startContainer,this.startOffset);o=new i(o);var V,E,K=i.blockBoundary(c==j.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:e),G=function(F){var J=K(F);J||(V=F);return J};m=function(F){var J=G(F);if(!J&&F[0]&&F._4e_name()=="br")E=F;return J};o.guard=G;o=o.lastBackward();
V=V||g;this.setStartAt(V,V._4e_name()!="br"&&(!o&&this.checkStartOfBlock()||o&&V.contains(o))?j.POSITION_AFTER_START:j.POSITION_AFTER_END);o=this.clone();o.collapse();o.setEndAt(g,j.POSITION_BEFORE_END);o=new i(o);o.guard=c==j.ENLARGE_LIST_ITEM_CONTENTS?m:G;V=e;o=o.lastForward();V=V||g;this.setEndAt(V,!o&&this.checkEndOfBlock()||o&&V.contains(o)?j.POSITION_BEFORE_END:j.POSITION_BEFORE_START);E&&this.setEndAfter(E)}},checkStartOfBlock:function(){var c=this.startContainer,g=this.startOffset;if(g&&c[0].nodeType==
f.NODE_TEXT)if(h.trim(c[0].nodeValue.substring(0,g)).length)return p;this.trim();c=new A(this.startContainer);g=this.clone();g.collapse(u);g.setStartAt(c.block||c.blockLimit,j.POSITION_AFTER_START);c=new i(g);c.evaluator=z(u);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,g=this.endOffset;if(c[0].nodeType==f.NODE_TEXT)if(h.trim(c[0].nodeValue.substring(g)).length)return p;this.trim();c=new A(this.endContainer);g=this.clone();g.collapse(p);g.setEndAt(c.block||c.blockLimit,
j.POSITION_BEFORE_END);c=new i(g);c.evaluator=z(p);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,g){var m=this.clone();m[g==j.START?"setStartAt":"setEndAt"](c,g==j.START?j.POSITION_AFTER_START:j.POSITION_BEFORE_END);m=new i(m);m.evaluator=D;return m[g==j.START?"checkBackward":"checkForward"]()},
getBoundaryNodes:function(){var c=this.startContainer,g=this.endContainer,m=this.startOffset,s=this.endOffset,o;if(c[0].nodeType==f.NODE_ELEMENT){o=c[0].childNodes.length;if(o>m)c=new n(c[0].childNodes[m]);else if(o<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new n(c);c=c._4e_nextSourceNode()||c}}if(g[0].nodeType==f.NODE_ELEMENT){o=g[0].childNodes.length;if(o>s)g=(new n(g[0].childNodes[s]))._4e_previousSourceNode(u);else if(o<1)g=g._4e_previousSourceNode();else{for(g=
g[0];g.lastChild;)g=g.lastChild;g=new n(g)}}if(c._4e_position(g)&w.POSITION_FOLLOWING)c=g;return{startNode:c,endNode:g}},fixBlock:function(c,g){var m=this.createBookmark(),s=new n(this.document.createElement(g));this.collapse(c);this.enlarge(j.ENLARGE_BLOCK_CONTENTS);s[0].appendChild(this.extractContents());s._4e_trim();d.ie||s._4e_appendBogus();this.insertNode(s);this.moveToBookmark(m);return s},splitBlock:function(c){var g=new A(this.startContainer),m=new A(this.endContainer),s=g.block,o=m.block,
x=e;if(!g.blockLimit._4e_equals(m.blockLimit))return e;if(c!="br"){if(!s){s=this.fixBlock(u,c);o=(new A(this.endContainer)).block}o||(o=this.fixBlock(p,c))}c=s&&this.checkStartOfBlock();g=o&&this.checkEndOfBlock();this.deleteContents();if(s&&a._4e_equals(s,o))if(g){x=new A(this.startContainer);this.moveToPosition(o,j.POSITION_AFTER_END);o=e}else if(c){x=new A(this.startContainer);this.moveToPosition(s,j.POSITION_BEFORE_START);s=e}else{o=this.splitElement(s);!d.ie&&!h.inArray(s._4e_name(),["ul","ol"])&&
s._4e_appendBogus()}return{previousBlock:s,nextBlock:o,wasStartOfBlock:c,wasEndOfBlock:g,elementPath:x}},splitElement:function(c){if(!this.collapsed)return e;this.setEndAt(c,j.POSITION_BEFORE_END);var g=this.extractContents(),m=c._4e_clone(p);m[0].appendChild(g);m.insertAfter(c);this.moveToPosition(c,j.POSITION_AFTER_END);return m},moveToElementEditablePosition:function(c,g){var m,s=q.XHTML_DTD;if(s.$empty[c._4e_name()])return p;for(;c&&c[0].nodeType==f.NODE_ELEMENT;){if(m=c._4e_isEditable())this.moveToPosition(c,
g?j.POSITION_BEFORE_END:j.POSITION_AFTER_START);else if(s.$inline[c._4e_name()]){this.moveToPosition(c,g?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);return u}if((c=s.$empty[c._4e_name()]?c[g?"_4e_previous":"_4e_next"](H):c[g?"_4e_last":"_4e_first"](H))&&c[0].nodeType==f.NODE_TEXT){this.moveToPosition(c,g?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);return u}}return m},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==f.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});
var l={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},r=new i.whitespaces,I=new i.bookmark;q.Range=B;q.Range=B;var v=B.prototype;q.Utils.extern(v,{updateCollapsed:v.updateCollapsed,optimize:v.optimize,setStartAfter:v.setStartAfter,setEndAfter:v.setEndAfter,setStartBefore:v.setStartBefore,setEndBefore:v.setEndBefore,optimizeBookmark:v.optimizeBookmark,setStart:v.setStart,setEnd:v.setEnd,
setStartAt:v.setStartAt,setEndAt:v.setEndAt,execContentsAction:v.execContentsAction,collapse:v.collapse,clone:v.clone,getEnclosedNode:v.getEnclosedNode,shrink:v.shrink,getTouchedStartNode:v.getTouchedStartNode,createBookmark2:v.createBookmark2,createBookmark:v.createBookmark,moveToPosition:v.moveToPosition,trim:v.trim,insertNode:v.insertNode,moveToBookmark:v.moveToBookmark,getCommonAncestor:v.getCommonAncestor,enlarge:v.enlarge,checkStartOfBlock:v.checkStartOfBlock,checkEndOfBlock:v.checkEndOfBlock,
deleteContents:v.deleteContents,extractContents:v.extractContents,checkBoundaryOfElement:v.checkBoundaryOfElement,getBoundaryNodes:v.getBoundaryNodes,fixBlock:v.fixBlock,splitBlock:v.splitBlock,splitElement:v.splitElement,moveToElementEditablePosition:v.moveToElementEditablePosition,selectNodeContents:v.selectNodeContents})});
KISSY.Editor.add("domiterator",function(q){function B(i){if(!(arguments.length<1)){this.range=i;this.forceBrBreak=H;this.enlargeBr=D;this.enforceRealBlocks=H;this._||(this._={})}}var D=true,H=false,z=KISSY,y=z.UA,t=q.Walker,u=q.Range,p=q.RANGE,e=q.NODE,h=q.ElementPath,f=z.Node,j=z.DOM,w=/^[\r\n\t ]*$/;z.augment(B,{getNextParagraph:function(i){var a,b,d,k,A;if(!this._.lastNode){b=this.range.clone();b.shrink(p.SHRINK_ELEMENT,D);b.enlarge(this.forceBrBreak||!this.enlargeBr?p.ENLARGE_LIST_ITEM_CONTENTS:
p.ENLARGE_BLOCK_CONTENTS);var n=new t(b),C=t.bookmark(D,D);n.evaluator=C;this._.nextNode=n.next();n=new t(b);n.evaluator=C;n=n.previous();this._.lastNode=n._4e_nextSourceNode(D);if(this._.lastNode&&this._.lastNode[0].nodeType==e.NODE_TEXT&&!z.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){C=new u(b.document);C.moveToPosition(this._.lastNode,p.POSITION_AFTER_END);if(C.checkEndOfBlock()){C=new h(C.endContainer);this._.lastNode=(C.block||C.blockLimit)._4e_nextSourceNode(D)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new f(b.document.createTextNode(""));j.insertAfter(this._.lastNode[0],n[0])}b=null}C=this._.nextNode;n=this._.lastNode;for(this._.nextNode=null;C;){var l=H,r=C[0].nodeType!=e.NODE_ELEMENT,I=H;if(r){if(C[0].nodeType==e.NODE_TEXT)if(w.test(C[0].nodeValue))r=H}else{var v=C._4e_name();if(C._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(v=="br")r=D;else if(!b&&!C[0].childNodes.length&&v!="hr"){a=C;d=C._4e_equals(n);break}if(b){b.setEndAt(C,p.POSITION_BEFORE_START);if(v!="br")this._.nextNode=
C}l=D}else{if(C[0].firstChild){if(!b){b=new u(this.range.document);b.setStartAt(C,p.POSITION_BEFORE_START)}C=new f(C[0].firstChild);continue}r=D}}if(r&&!b){b=new u(this.range.document);b.setStartAt(C,p.POSITION_BEFORE_START)}d=(!l||r)&&C._4e_equals(n);if(b&&!l)for(;!C[0].nextSibling&&!d;){v=C.parent();if(v._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=D;d||v._4e_equals(n);break}C=v;r=D;d=C._4e_equals(n);I=D}r&&b.setEndAt(C,p.POSITION_AFTER_END);C=C._4e_nextSourceNode(I,null,n);if((d=!C)||l&&b)break}if(!a){if(!b){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new h(b.startContainer);C=a.blockLimit;l={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&l[C._4e_name()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=C;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new f(this.range.document.createElement(i||"p"));a[0].appendChild(b.extractContents());a._4e_trim();b.insertNode(a);k=A=D}else if(a._4e_name()!="li"){if(!b.checkStartOfBlock()||!b.checkEndOfBlock()){a=a._4e_clone(H);
a[0].appendChild(b.extractContents());a._4e_trim();A=b.splitBlock();k=!A.wasStartOfBlock;A=!A.wasEndOfBlock;b.insertNode(a)}}else if(!d)this._.nextNode=a._4e_equals(n)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(D,null,n)}if(k){b=new f(a[0].previousSibling);if(b[0]&&b[0].nodeType==e.NODE_ELEMENT)if(b._4e_name()=="br")b._4e_remove();else b[0].lastChild&&j._4e_name(b[0].lastChild)=="br"&&j._4e_remove(b[0].lastChild)}if(A){b=t.bookmark(H,D);k=new f(a[0].lastChild);if(k[0]&&k[0].nodeType==e.NODE_ELEMENT&&
k._4e_name()=="br")if(y.ie||k._4e_previous(b)||k._4e_next(b))k._4e_remove()}if(!this._.nextNode)this._.nextNode=d||a._4e_equals(n)?null:a._4e_nextSourceNode(D,null,n);return a}});u.prototype.createIterator=function(){return new B(this)}});
KISSY.Editor.add("selection",function(q){function B(l){this.document=this.document=l;this._={cache:{}};if(a){var r=this.getNative().createRange();if(!r||r.item&&r.item(0).ownerDocument!=l||r.parentElement&&r.parentElement().ownerDocument!=l)this.isInvalid=z}}function D(l){l=new B(l);return!l||l.isInvalid?t:l}function H(l){var r=l.document,I=new f(r.body),v=new f(r.documentElement);if(p.ie){if(p.ie<8||document.documentMode==7)v.on("click",function(L){(new f(L.target))._4e_name()==="html"&&l.getSelection().getRanges()[0].select()});
var c,g,m=1;v.on("mousedown",function(){m=0});v.on("mouseup",function(){m=1});I.on("focusin",function(L){if((new f(L.target))._4e_name()=="body")if(c){try{m&&c.select()}catch(Q){}c=t}});I.on("focus",function(){g=z;o()});I.on("beforedeactivate",function(L){if(!L.relatedTarget){g=y;m=1}});h.on(e._4e_getWin(r),"blur",function(){r&&r.selection.empty()});I.on("mousedown",function(){s()});I.on("mouseup",function(){g=z;setTimeout(function(){o(z)},0)});var s=function(){g=y},o=function(L){if(g){var Q=l.document,
S=l.getSelection(),U=S&&S.getType(),T=S&&S.getNative();if(L&&T&&U==j.SELECTION_NONE)if(!Q.queryCommandEnabled("InsertImage")){setTimeout(function(){o(z)},50);return}var V;if(!(T&&U==j.SELECTION_TEXT&&(V=e._4e_name(S.getStartElement()))&&V in{input:1,textarea:1})){c=T&&S.getRanges()[0];l._monitor()}}};I.on("keydown",s);I.on("keyup",function(){g=z;o()});h.on(r,"selectionchange",o)}else{h.on(r,"mouseup",l._monitor,l);h.on(r,"keyup",l._monitor,l)}var x={table:1,pre:1},O=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
P=q.Walker.whitespaces(z);l.on("selectionChange",function(L){var Q=L.path;L=(L=L.selection)&&L.getRanges()[0];if(!(!L||!L.collapsed||Q.block))if(Q.blockLimit._4e_name()=="body"){Q=L.fixBlock(z,"p");if(Q._4e_outerHtml().match(O)){var S=Q._4e_next(P);if(S&&S[0].nodeType==i.NODE_ELEMENT&&!x[S._4e_name()]){L.moveToElementEditablePosition(S);Q._4e_remove()}else if((S=Q._4e_previous(P))&&S[0].nodeType==i.NODE_ELEMENT&&!x[S._4e_name()]){L.moveToElementEditablePosition(S,S._4e_outerHtml().match(O)?y:z);Q._4e_remove()}}L.select();
a||l.notifySelectionChange()}})}q.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var z=true,y=false,t=null,u=KISSY,p=u.UA,e=u.DOM,h=u.Event,f=u.Node,j=q.SELECTION,w=q.RANGE,i=q.NODE,a=!window.getSelection,b=q.Walker,d=q.Range,k={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};u.augment(B,{getNative:!a?function(){var l=this._.cache;return l.nativeSel||(l.nativeSel=e._4e_getWin(this.document).getSelection())}:
function(){var l=this._.cache;return l.nativeSel||(l.nativeSel=this.document.selection)},getType:!a?function(){var l=this._.cache;if(l.type)return l.type;var r=j.SELECTION_TEXT,I=this.getNative();if(I){if(I.rangeCount==1){I=I.getRangeAt(0);var v=I.startContainer;if(v==I.endContainer&&v.nodeType==i.NODE_ELEMENT&&I.endOffset-I.startOffset===1&&k[v.childNodes[I.startOffset].nodeName.toLowerCase()])r=j.SELECTION_ELEMENT}}else r=j.SELECTION_NONE;return l.type=r}:function(){var l=this._.cache;if(l.type)return l.type;
var r=j.SELECTION_NONE;try{var I=this.getNative(),v=I.type;if(v=="Text")r=j.SELECTION_TEXT;if(v=="Control")r=j.SELECTION_ELEMENT;if(I.createRange().parentElement)r=j.SELECTION_TEXT}catch(c){}return l.type=r},getRanges:a?function(){var l=function(r,I){r=r.duplicate();r.collapse(I);for(var v=r.parentElement(),c=v.childNodes,g,m=0;m<c.length;m++){var s=c[m];if(s.nodeType==i.NODE_ELEMENT){g=r.duplicate();g.moveToElementText(s);s=g.compareEndPoints("StartToStart",r);var o=g.compareEndPoints("EndToStart",
r);g.collapse();if(s>0)break;else if(!s||o==1&&s==-1)return{container:v,offset:m};else if(!o)return{container:v,offset:m+1};g=t}}if(!g){g=r.duplicate();g.moveToElementText(v);g.collapse(y)}g.setEndPoint("StartToStart",r);g=g.text.replace(/\r\n|\r/g,"\n").length;try{for(;g>0;)g-=c[--m].nodeValue.length}catch(x){g=0}return g===0?{container:v,offset:m}:{container:c[m],offset:-g}};return function(){var r=this._.cache;if(r.ranges)return r.ranges;var I=this.getNative(),v=I&&I.createRange(),c=this.getType();
if(!I)return[];if(c==j.SELECTION_TEXT){I=new d(this.document);c=l(v,z);I.setStart(new f(c.container),c.offset);c=l(v);I.setEnd(new f(c.container),c.offset);return r.ranges=[I]}else if(c==j.SELECTION_ELEMENT){r=r.ranges=[];for(c=0;c<v.length;c++){var g=v.item(c),m=g.parentNode,s=0;for(I=new d(this.document);s<m.childNodes.length&&m.childNodes[s]!=g;s++);I.setStart(new f(m),s);I.setEnd(new f(m),s+1);r.push(I)}return r}return r.ranges=[]}}():function(){var l=this._.cache;if(l.ranges)return l.ranges;
var r=[],I=this.getNative();if(!I)return[];for(var v=0;v<I.rangeCount;v++){var c=I.getRangeAt(v),g=new d(this.document);g.setStart(new f(c.startContainer),c.startOffset);g.setEnd(new f(c.endContainer),c.endOffset);r.push(g)}return l.ranges=r},getStartElement:function(){var l=this._.cache;if(l.startElement!==undefined)return l.startElement;var r,I=this.getNative();switch(this.getType()){case j.SELECTION_ELEMENT:return this.getSelectedElement();case j.SELECTION_TEXT:var v=this.getRanges()[0];if(v)if(!v.collapsed){for(v.optimize();z;){r=
v.startContainer;if(v.startOffset==(r[0].nodeType===i.NODE_ELEMENT?r[0].childNodes.length:r[0].nodeValue.length)&&!r._4e_isBlockBoundary())v.setStartAfter(r);else break}r=v.startContainer;if(r[0].nodeType!=i.NODE_ELEMENT)return r.parent();r=new f(r[0].childNodes[v.startOffset]);if(!r[0]||r[0].nodeType!=i.NODE_ELEMENT)return v.startContainer;for(v=r[0].firstChild;v&&v.nodeType==i.NODE_ELEMENT;){r=new f(v);v=v.firstChild}return r}if(a){v=I.createRange();v.collapse(z);r=v.parentElement()}else if((r=
I.anchorNode)&&r.nodeType!=i.NODE_ELEMENT)r=r.parentNode}return l.startElement=r?e._4e_wrap(r):t},getSelectedElement:function(){var l=this,r,I=l._.cache;if(I.selectedElement!==undefined)return I.selectedElement;if(a){r=l.getNative().createRange();r=r.item&&r.item(0)}r||(r=function(){for(var v=l.getRanges()[0],c,g,m=2;m&&!((c=v.getEnclosedNode())&&c[0].nodeType==i.NODE_ELEMENT&&k[c._4e_name()]&&(g=c));m--)v.shrink(w.SHRINK_ELEMENT);return g&&g[0]}());return I.selectedElement=e._4e_wrap(r)},reset:function(){this._.cache=
{}},selectElement:function(l){var r,I=this.document;if(a)try{r=I.body.createControlRange();r.addElement(l[0]);r.select()}catch(v){r=I.body.createTextRange();r.moveToElementText(l[0]);r.select()}finally{}else{r=I.createRange();r.selectNode(l[0]);l=this.getNative();l.removeAllRanges();l.addRange(r)}this.reset()},selectRanges:function(l){if(a){if(l.length>1){var r=l[l.length-1];l[0].setEnd(r.endContainer,r.endOffset);l.length=1}l[0]&&l[0].select()}else{r=this.getNative();if(!r)return;r.removeAllRanges();
for(var I=0;I<l.length;I++){var v=l[I],c=this.document.createRange(),g=v.startContainer;v.collapsed&&p.gecko&&p.gecko<1.09&&g[0].nodeType==i.NODE_ELEMENT&&!g[0].childNodes.length&&g[0].appendChild(this.document.createTextNode(""));c.setStart(g[0],v.startOffset);c.setEnd(v.endContainer[0],v.endOffset);r.addRange(c)}}this.reset()},createBookmarks2:function(l){for(var r=[],I=this.getRanges(),v=0;v<I.length;v++)r.push(I[v].createBookmark2(l));return r},createBookmarks:function(l,r){var I=[],v=this.document,
c;r=r||this.getRanges();for(var g=r.length,m=0;m<g;m++){I.push(c=r[m].createBookmark(l,z));var s=(l=c.serializable)?u.one("#"+c.startNode,v):c.startNode;c=l?u.one("#"+c.endNode,v):c.endNode;for(var o=m+1;o<g;o++){var x=r[o],O=x.startContainer,P=x.endContainer;e._4e_equals(O,s.parent())&&x.startOffset++;e._4e_equals(O,c.parent())&&x.startOffset++;e._4e_equals(P,s.parent())&&x.endOffset++;e._4e_equals(P,c.parent())&&x.endOffset++}}return I},selectBookmarks:function(l){for(var r=[],I=0;I<l.length;I++){var v=
new d(this.document);v.moveToBookmark(l[I]);r.push(v)}this.selectRanges(r);return this},getCommonAncestor:function(){var l=this.getRanges();return l[0].startContainer._4e_commonAncestor(l[l.length-1].endContainer)},scrollIntoView:function(){var l=this.getStartElement();l&&l._4e_scrollIntoView()},removeAllRanges:function(){var l=this.getNative();if(a)l&&l.clear();else l&&l.removeAllRanges()}});var A={table:1,tbody:1,tr:1},n=b.whitespaces(z),C=/\ufeff|\u00a0/;d.prototype.select=d.prototype.select=!a?
function(){var l=this.startContainer;this.collapsed&&l[0].nodeType==i.NODE_ELEMENT&&!l[0].childNodes.length&&l[0].appendChild(this.document.createTextNode(""));var r=this.document.createRange();r.setStart(l[0],this.startOffset);try{r.setEnd(this.endContainer[0],this.endOffset)}catch(I){if(I.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(z);r.setEnd(this.endContainer[0],this.endOffset)}else throw I;}l=D(this.document).getNative();l.removeAllRanges();l.addRange(r)}:function(l){var r=
this.collapsed,I,v;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var c=this.startContainer[0].childNodes[this.startOffset];if(c.nodeType==i.NODE_ELEMENT){(new B(this.document)).selectElement(new f(c));return}}if(this.startContainer[0].nodeType==i.NODE_ELEMENT&&this.startContainer._4e_name()in A||this.endContainer[0].nodeType==i.NODE_ELEMENT&&this.endContainer._4e_name()in A)this.shrink(w.SHRINK_ELEMENT,z);var g=this.createBookmark();c=g.startNode;var m;if(!r)m=
g.endNode;g=this.document.body.createTextRange();g.moveToElementText(c[0]);g.moveStart("character",1);if(m){l=this.document.body.createTextRange();l.moveToElementText(m[0]);g.setEndPoint("EndToEnd",l);g.moveEnd("character",-1)}else{for(I=c[0].nextSibling;I&&!n(I);)I=I.nextSibling;I=!(I&&I.nodeValue&&I.nodeValue.match(C))&&(l||!c[0].previousSibling||c[0].previousSibling&&e._4e_name(c[0].previousSibling)=="br");v=new f(this.document.createElement("span"));v.html("&#65279;");v.insertBefore(c);I&&e.insertBefore(this.document.createTextNode("\ufeff"),
c)}this.setStartBefore(c);c._4e_remove();if(r){if(I){g.moveStart("character",-1);g.select();this.document.selection.clear()}else g.select();if(v){this.moveToPosition(v,w.POSITION_BEFORE_START);v._4e_remove()}}else{this.setEndBefore(m);m._4e_remove();g.select()}};B.getSelection=D;q.Selection=B;q.Selection=B;b=B.prototype;q.Utils.extern(b,{getNative:b.getNative,getType:b.getType,getRanges:b.getRanges,getStartElement:b.getStartElement,getSelectedElement:b.getSelectedElement,reset:b.reset,selectElement:b.selectElement,
selectRanges:b.selectRanges,createBookmarks2:b.createBookmarks2,createBookmarks:b.createBookmarks,getCommonAncestor:b.getCommonAncestor,scrollIntoView:b.scrollIntoView,selectBookmarks:b.selectBookmarks,removeAllRanges:b.removeAllRanges});q.on("instanceCreated",function(l){H(l.editor)})});
KISSY.Editor.add("styles",function(q){function B(E,K){for(var G in E)E[G]=E[G].replace(T,function(F,J){return K[J]})}function D(E,K){if(K){E=r.clone(E);B(E.attributes,K);B(E.styles,K)}var G=this.element=this.element=(E.element||"*").toLowerCase();this.type=this.type=G=="#"||Q[G]?c.STYLE_BLOCK:S[G]?c.STYLE_OBJECT:c.STYLE_INLINE;this._={definition:E}}function H(E,K){var G=K?this.removeFromRange:this.applyToRange;E.body.focus();for(var F=new m(E),J=F.getRanges(),N=0;N<J.length;N++)G.call(this,J[N]);
F.selectRanges(J)}function z(E,K){var G;G=E.element;if(G=="*")G="span";G=new O(K.createElement(G));return y(G,E)}function y(E,K){var G=K._.definition,F=G.attributes;G=D.getStyleText(G);if(F)for(var J in F)E.attr(J,F[J]);if(G)E[0].style.cssText=G;return E}function t(E){var K=E.createBookmark(n),G=E.createIterator();G.enforceRealBlocks=n;G.enlargeBr=n;for(var F,J=E.document;F=G.getNextParagraph();){var N=z(this,J);F=F;var M=N;N=M._4e_name=="pre";var R=F._4e_name=="pre",Z=!N&&R;if(N&&!R){R=F;M=M;Z=R.html();
Z=u(Z,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");Z=Z.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");Z=Z.replace(/([ \t\n\r]+|&nbsp;)/g," ");Z=Z.replace(/<br\b[^>]*>/gi,"\n");if(P.ie){R=R[0].ownerDocument.createElement("div");R.appendChild(M[0]);M[0].outerHTML="<pre>"+Z+"</pre>";M=new O(R.firstChild);M._4e_remove()}else M.html(Z);M=M}else if(Z)M=e(p(F),M);else F._4e_moveChildren(M);F[0].parentNode.replaceChild(M[0],F[0]);if(N){F=M;N=void 0;if((N=F._4e_previousSourceNode(n,s.NODE_ELEMENT))&&N._4e_name()==
"pre"){M=u(N.html(),/\n$/,"")+"\n\n"+u(F.html(),/^\n/,"");if(P.ie)F[0].outerHTML="<pre>"+M+"</pre>";else F.html(M);N._4e_remove()}}}E.moveToBookmark(K)}function u(E,K,G){var F="",J="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(N,M,R){M&&(F=M);R&&(J=R);return""});return F+E.replace(K,G)+J}function p(E){var K=[];u(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(G,F,J){return F+"</pre>"+J+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(G,F){K.push(F)});return K}function e(E,K){for(var G=K[0].ownerDocument.createDocumentFragment(),F=0;F<E.length;F++){var J=E[F];J=J.replace(/(\r\n|\r)/g,"\n");J=u(J,/^[ \t]*\n/,"");J=u(J,/\n$/,"");J=u(J,/^[ \t]+|[ \t]+$/g,function(M,R){return M.length==1?"&nbsp;":R?" "+Array(M.length).join("&nbsp;"):Array(M.length).join("&nbsp;")+" "});J=J.replace(/\n/g,"<br>");J=J.replace(/[ \t]{2,}/g,function(M){return Array(M.length).join("&nbsp;")+" "});var N=K._4e_clone();N.html(J);G.appendChild(N[0])}return G}
function h(E){var K=E.document;if(E.collapsed){K=z(this,K);E.insertNode(K);E.moveToPosition(K,g.POSITION_BEFORE_END)}else{var G=this.element,F=this._.definition,J,N=q.XHTML_DTD[G]||(J=n,q.XHTML_DTD.span),M=E.createBookmark();E.enlarge(g.ENLARGE_ELEMENT);E.trim();var R=E.createBookmark(),Z=R.startNode;R=R.endNode;for(var X=Z,$;X&&X[0];){var W=C;if(v._4e_equals(X,R)){X=l;W=n}else{var Y=X[0].nodeType,ca=Y==s.NODE_ELEMENT?X._4e_name():l;if(ca&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(n);continue}if(!ca||
N[ca]&&(X._4e_position(R)|o.POSITION_PRECEDING|o.POSITION_IDENTICAL|o.POSITION_IS_CONTAINED)==o.POSITION_PRECEDING+o.POSITION_IDENTICAL+o.POSITION_IS_CONTAINED&&(!F.childRule||F.childRule(X))){var da=X.parent();if(da&&da[0]&&((q.XHTML_DTD[da._4e_name()]||q.XHTML_DTD.span)[G]||J)&&(!F.parentRule||F.parentRule(da))){if(!$&&(!ca||!q.XHTML_DTD.$removeEmpty[ca]||(X._4e_position(R)|o.POSITION_PRECEDING|o.POSITION_IDENTICAL|o.POSITION_IS_CONTAINED)==o.POSITION_PRECEDING+o.POSITION_IDENTICAL+o.POSITION_IS_CONTAINED)){$=
new x(K);$.setStartBefore(X)}if(Y==s.NODE_TEXT||Y==s.NODE_ELEMENT&&!X[0].childNodes.length){Y=X;var aa;for(ca=Y._4e_next(function(fa){return!fa.attr("_ke_bookmark")});!ca&&(aa=Y.parent(),N[aa._4e_name()])&&(aa._4e_position(Z)|o.POSITION_FOLLOWING|o.POSITION_IDENTICAL|o.POSITION_IS_CONTAINED)==o.POSITION_FOLLOWING+o.POSITION_IDENTICAL+o.POSITION_IS_CONTAINED&&(!F.childRule||F.childRule(aa));)Y=aa;$.setEndAfter(Y);Y[0].nextSibling||(W=n)}}else W=n}else W=n;X=X._4e_nextSourceNode()}if(W&&$&&!$.collapsed){W=
z(this,K);for(Y=$.getCommonAncestor();W&&Y&&W[0]&&Y[0];){if(Y._4e_name()==G){for(var ba in F.attributes)W.attr(ba)==Y.attr(ba)&&W[0].removeAttribute(ba);for(var ea in F.styles)W._4e_style(ea)==Y._4e_style(ea)&&W._4e_style(ea,"");if(!W._4e_hasAttributes()){W=l;break}}Y=Y.parent()}if(W){W[0].appendChild($.extractContents());d(this,W);$.insertNode(W);W._4e_mergeSiblings();P.ie||W[0].normalize()}$=l}}Z._4e_remove();R._4e_remove();E.moveToBookmark(M);E.shrink(g.SHRINK_TEXT)}}function f(E){E.enlarge(g.ENLARGE_ELEMENT);
var K=E.createBookmark(),G=K.startNode;if(E.collapsed){for(var F=new L(G.parent()),J,N=0,M;N<F.elements.length&&(M=F.elements[N]);N++){if(M==F.block||M==F.blockLimit)break;if(this.checkElementRemovable(M)){var R=E.checkBoundaryOfElement(M,g.END),Z=!R&&E.checkBoundaryOfElement(M,g.START);if(Z||R){J=M;J.match=Z?"start":"end"}else{M._4e_mergeSiblings();M._4e_name()==this.element?a(this,M):k(M,i(this)[M._4e_name()])}}}if(J&&J[0]){M=G;for(N=0;;N++){R=F.elements[N];if(v._4e_equals(R,J))break;else if(R.match)continue;
else R=R._4e_clone();R[0].appendChild(M[0]);M=R}v[J.match=="start"?"insertBefore":"insertAfter"](M,J)}}else{var X=K.endNode,$=this;F=function(){for(var W=new L(G.parent()),Y=new L(X.parent()),ca=l,da=l,aa=0;aa<W.elements.length;aa++){var ba=W.elements[aa];if(ba==W.block||ba==W.blockLimit)break;if($.checkElementRemovable(ba))ca=ba}for(aa=0;aa<Y.elements.length;aa++){ba=Y.elements[aa];if(ba==Y.block||ba==Y.blockLimit)break;if($.checkElementRemovable(ba))da=ba}da&&X._4e_breakParent(da);ca&&G._4e_breakParent(ca)};
F();for(J=new O(G[0].nextSibling);J[0]!==X[0];){N=J._4e_nextSourceNode();if(J[0]&&J[0].nodeType==s.NODE_ELEMENT&&this.checkElementRemovable(J)){J._4e_name()==this.element?a(this,J):k(J,i(this)[J._4e_name()]);if(N[0].nodeType==s.NODE_ELEMENT&&N.contains(G)){F();N=new O(G[0].nextSibling)}}J=N}}E.moveToBookmark(K)}function j(E){var K={};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,F,J){K[F]=J});return K}function w(E,K){var G;if(K!==C){G=document.createElement("span");
G.style.cssText=E;G=G.style.cssText||""}else G=E;return G.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function i(E){if(E._.overrides)return E._.overrides;var K=E._.overrides={},G=E._.definition.overrides;if(G){r.isArray(G)||(G=[G]);for(var F=0;F<G.length;F++){var J=G[F],N,M;if(typeof J=="string")N=J.toLowerCase();else{N=J.element?J.element.toLowerCase():E.element;M=J.attributes}J=K[N]||(K[N]={});if(M){J=J.attributes=J.attributes||[];for(var R in M)J.push([R.toLowerCase(),
M[R]])}}}return K}function a(E,K){var G=E._.definition,F=I.mix(G.attributes,i(E)[K._4e_name()]);G=G.styles;var J=r.isEmptyObject(F)&&r.isEmptyObject(G),N;for(N in F)if(!((N=="class"||E._.definition.fullMatch)&&K.attr(N)!=b(N,F[N]))){J=J||!!K._4e_hasAttribute(N);K.removeAttr(N)}for(var M in G)if(!(E._.definition.fullMatch&&K._4e_style(M)!=b(M,G[M],n))){J=J||!!K._4e_style(M);K._4e_style(M,"")}A(K)}function b(E,K,G){var F=new O("<span>");F[G?"_4e_style":"attr"](E,K);return F[G?"_4e_style":"attr"](E)}
function d(E,K){for(var G=i(E),F=K.all(E.element),J=F.length;--J>=0;)a(E,new O(F[J]));for(var N in G)if(N!=E.element){F=K.all(N);for(J=F.length-1;J>=0;J--){var M=new O(F[J]);k(M,G[N])}}}function k(E,K){var G=K&&K.attributes;if(G)for(var F=0;F<G.length;F++){var J=G[F][0],N;if(N=E.attr(J)){var M=G[F][1];if(M===l||M.test&&M.test(N)||typeof M=="string"&&N==M)E[0].removeAttribute(J)}}A(E)}function A(E){if(!E._4e_hasAttributes()){var K=E[0].firstChild,G=E[0].lastChild;E._4e_remove(n);if(K){K.nodeType==
s.NODE_ELEMENT&&v._4e_mergeSiblings(K);G&&K!=G&&G.nodeType==s.NODE_ELEMENT&&v._4e_mergeSiblings(G)}}}var n=true,C=false,l=null,r=KISSY,I=q.Utils,v=r.DOM,c={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},g=q.RANGE,m=q.Selection,s=q.NODE,o=q.POSITION,x=q.Range,O=r.Node,P=r.UA,L=q.ElementPath,Q={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},S={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},U=/\s*(?:;\s*|$)/g,T=/#\((.+?)\)/g;q.STYLE=c;D.prototype={apply:function(E){H.call(this,
E,C)},remove:function(E){H.call(this,E,n)},applyToRange:function(E){return(this.applyToRange=this.type==c.STYLE_INLINE?h:this.type==c.STYLE_BLOCK?t:this.type==c.STYLE_OBJECT?l:l).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==c.STYLE_INLINE?f:l).call(this,E)},applyToObject:function(E){y(E,this)},checkElementRemovable:function(E,K){if(!E)return C;var G=this._.definition;if(E._4e_name()==this.element){if(!K&&!E._4e_hasAttributes())return n;var F=G._AC;if(F)G=F;else{F=
{};var J=0,N=G.attributes;if(N)for(var M in N){J++;F[M]=N[M]}if(N=D.getStyleText(G)){F.style||J++;F.style=N}F._length=J;G=G._AC=F}if(G._length){for(var R in G)if(R!="_length"){J=E.attr(R)||"";if(R=="style")a:{F=G[R];J=w(J,C);typeof F=="string"&&(F=j(F));typeof J=="string"&&(J=j(J));N=void 0;for(N in F)if(!(N in J&&(J[N]==F[N]||F[N]=="inherit"||J[N]=="inherit"))){F=C;break a}F=n}else F=G[R]==J;if(F){if(!K)return n}else if(K)return C}if(K)return n}else return n}if(R=i(this)[E._4e_name()]){if(!(G=R.attributes))return n;
for(F=0;F<G.length;F++){R=G[F][0];if(R=E.attr(R)){J=G[F][1];if(J===l||typeof J=="string"&&R==J||J.test&&J.test(R))return n}}}return C},checkActive:function(E){switch(this.type){case c.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,n);case c.STYLE_OBJECT:case c.STYLE_INLINE:for(var K=E.elements,G=0,F;G<K.length;G++){F=K[G];if(!(this.type==c.STYLE_INLINE&&(v._4e_equals(F,E.block)||v._4e_equals(F,E.blockLimit))))if(!(this.type==c.STYLE_OBJECT&&!(F._4e_name()in S)))if(this.checkElementRemovable(F,
n))return n}}return C}};D.getStyleText=function(E){var K=E._ST;if(K)return K;K=E.styles;var G=E.attributes&&E.attributes.style||"",F="";if(G.length)G=G.replace(U,";");for(var J in K){var N=K[J],M=(J+":"+N).replace(U,";");if(N=="inherit")F+=M;else G+=M}if(G.length)G=w(G);G+=F;return E._ST=G};q.Style=D;q.Style=D;var V=D.prototype;q.Utils.extern(V,{apply:V.apply,remove:V.remove,applyToRange:V.applyToRange,removeFromRange:V.removeFromRange,applyToObject:V.applyToObject,checkElementRemovable:V.checkElementRemovable,
checkActive:V.checkActive})});
KISSY.Editor.add("htmlparser",function(){function q(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var B=KISSY,D=function(){},H=B.Editor,z=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,y={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},t=H.XHTML_DTD;B.augment(q,{onTagOpen:D,onTagClose:D,
onText:D,onCDATA:D,onComment:D,parse:function(u){for(var p,e,h=0,f;p=this._.htmlPartsRegex.exec(u);){e=p.index;if(e>h){h=u.substring(h,e);f?f.push(h):this.onText(h)}h=this._.htmlPartsRegex.lastIndex;if(e=p[1]){e=e.toLowerCase();if(f&&t.$cdata[e]){this.onCDATA(f.join(""));f=null}if(!f){this.onTagClose(e);continue}}if(f)f.push(p[0]);else if(e=p[3]){e=e.toLowerCase();if(!/="/.test(e)){var j={},w;p=p[4];var i=!!(p&&p.charAt(p.length-1)=="/");if(p)for(;w=z.exec(p);){var a=w[1].toLowerCase();w=w[2]||w[3]||
w[4]||"";j[a]=!w&&y[a]?a:w}this.onTagOpen(e,j,i);if(!f&&t.$cdata[e])f=[]}}else if(e=p[2])this.onComment(e)}u.length>h&&this.onText(u.substring(h,u.length))}});H.HtmlParser=q;H.HtmlParser=q});
KISSY.Editor.add("htmlparser-basicwriter",function(){function q(){this._={output:[]}}var B=KISSY,D=B.Editor,H=D.Utils;B.augment(q,{openTag:function(z){this._.output.push("<",z)},openTagClose:function(z,y){y?this._.output.push(" />"):this._.output.push(">")},attribute:function(z,y){if(typeof y=="string")y=H.htmlEncodeAttr(y);this._.output.push(" ",z,'="',y,'"')},closeTag:function(z){this._.output.push("</",z,">")},text:function(z){this._.output.push(z)},comment:function(z){this._.output.push("<!--",
z,"--\>")},write:function(z){this._.output.push(z)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(z){var y=this._.output.join("");z&&this.reset();return y}});D.HtmlParser.BasicWriter=q;D.HtmlParser.BasicWriter=q;B=q.prototype;D.Utils.extern(B,{openTag:B.openTag,openTagClose:B.openTagClose,attribute:B.attribute,closeTag:B.closeTag,text:B.text,comment:B.comment,write:B.write,reset:B.reset,getHtml:B.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function q(){q.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=y;this.sortAttributes=z;this._.indent=y;this._.indentation="";this._.rules={};var t=D.XHTML_DTD,u;for(u in H.mix({},t.$nonBodyContent,t.$block,t.$listItem,t.$tableContent))this.setRules(u,{indent:z,breakBeforeOpen:z,breakAfterOpen:z,breakBeforeClose:!t[u]["#"],breakAfterClose:z});this.setRules("br",
{breakAfterOpen:z});this.setRules("title",{indent:y,breakAfterOpen:y});this.setRules("style",{indent:y,breakBeforeClose:z});this.setRules("pre",{indent:y})}var B=KISSY,D=B.Editor,H=D.Utils,z=true,y=false;B.extend(q,D.HtmlParser.BasicWriter,{openTag:function(t){var u=this._.rules[t];if(this._.indent)this.indentation();else if(u&&u.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",t)},openTagClose:function(t,u){var p=this._.rules[t];if(u)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(p&&p.indent)this._.indentation+=this.indentationChars}p&&p.breakAfterOpen&&this.lineBreak()},attribute:function(t,u){if(typeof u=="string"){this.forceSimpleAmpersand&&(u=u.replace(/&amp;/g,"&"));u=H.htmlEncodeAttr(u)}this._.output.push(" ",t,'="',u,'"')},closeTag:function(t){var u=this._.rules[t];if(u&&u.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(u&&u.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",t,">");u&&u.breakAfterClose&&this.lineBreak()},text:function(t){if(this._.indent){this.indentation();t=H.ltrim(t)}this._.output.push(t)},comment:function(t){this._.indent&&this.indentation();this._.output.push("<!--",t,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=z},indentation:function(){this._.output.push(this._.indentation);this._.indent=y},setRules:function(t,u){var p=this._.rules[t];if(p)H.mix(p,
u);else this._.rules[t]=u}});D.HtmlParser.HtmlWriter=q;D.HtmlParser.HtmlWriter=q;B=q.prototype;D.Utils.extern(B,{openTag:B.openTag,openTagClose:B.openTagClose,attribute:B.attribute,closeTag:B.closeTag,text:B.text,comment:B.comment,lineBreak:B.lineBreak,indentation:B.indentation,setRules:B.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function q(){this.children=[];this.parent=H;this._={isBlockLike:B,hasInlineStarted:D}}var B=true,D=false,H=null,z=KISSY.Editor,y={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},t=KISSY,u=z.Utils,p=z.NODE,e=z.XHTML_DTD,h=u.mix({table:1,ul:1,ol:1,dl:1},e.table,e.ul,e.ol,e.dl),f=e.$list,j=e.$listItem;q.FromHtml=function(w,i){function a(g){var m;if(n.length>0)for(var s=0;s<n.length;s++){var o=n[s],x=o.name,O=e[x],P=l.name&&e[l.name];
if((!P||P[x])&&(!g||!O||O[g]||!e[g])){if(!m){b();m=1}o=o.clone();o.parent=l;l=o;n.splice(s,1);s--}}}function b(){for(;C.length;)l.add(C.shift())}function d(g,m,s){m=m||l||A;if(i&&!m.type){var o,x;if((o=g.attributes&&(x=g.attributes._ke_real_element_type)?x:g.name)&&!(o in e.$body)&&!(o in e.$nonBodyContent)){o=l;l=m;k.onTagOpen(i,{});m=l;if(s)l=o}}if(g._.isBlockLike&&g.name!="pre"){s=g.children.length;if((o=g.children[s-1])&&o.type==p.NODE_TEXT)if(x=u.rtrim(o.value))o.value=x;else g.children.length=
s-1}m.add(g);if(g.returnPoint){l=g.returnPoint;delete g.returnPoint}}var k=new z.HtmlParser,A=new q,n=[],C=[],l=A,r=D,I;k.onTagOpen=function(g,m,s){var o=new z.HtmlParser.Element(g,m);if(o.isUnknown&&s)o.isEmpty=B;if(e.$removeEmpty[g])n.push(o);else{if(g==="pre")r=B;else if(g==="br"&&r){l.add(new z.HtmlParser.Text("\n"));return}if(g==="br")C.push(o);else{var x=l.name,O=x&&(e[x]||(l._.isBlockLike?e.div:e.span));if(O&&!o.isUnknown&&!l.isUnknown&&!O[g]){O=D;var P;if(g in f&&x in f){x=l.children;(x=x[x.length-
1])&&x.name in j||d(x=new z.HtmlParser.Element("li"),l);I=l;P=x}else if(g==x)d(l,l.parent);else{if(h[x])I||(I=l);else{d(l,l.parent,B);y[x]||n.unshift(l)}O=B}l=P?P:l.returnPoint||l.parent;if(O){k.onTagOpen.apply(this,arguments);return}}a(g);b();o.parent=l;o.returnPoint=I;I=0;if(o.isEmpty)d(o);else l=o}}};k.onTagClose=function(g){for(var m=n.length-1;m>=0;m--)if(g==n[m].name){n.splice(m,1);return}for(var s=[],o=[],x=l;x.type&&x.name!=g;){x._.isBlockLike||o.unshift(x);s.push(x);x=x.parent}if(x.type){for(m=
0;m<s.length;m++){var O=s[m];d(O,O.parent)}l=x;if(l.name=="pre")r=D;x._.isBlockLike&&b();d(x,x.parent);if(x==l)l=l.parent;n=n.concat(o)}if(g=="body")i=D};k.onText=function(g){if(!l._.hasInlineStarted&&!r){g=u.ltrim(g);if(g.length===0)return}b();a();if(i&&(!l.type||l.name=="body")&&u.trim(g))this.onTagOpen(i,{});r||(g=g.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));l.add(new z.HtmlParser.Text(g))};k.onCDATA=function(){};k.onComment=function(g){l.add(new z.HtmlParser.Comment(g))};k.parse(w);for(b();l.type;){var v=
l.parent,c=l;if(i&&(!v.type||v.name=="body")&&!e.$body[c.name]){l=v;k.onTagOpen(i,{});v=l}v.add(c);l=v}return A};t.augment(q,{add:function(w){var i=this.children.length;if(i=i>0&&this.children[i-1]||H){if(w._.isBlockLike&&i.type==p.NODE_TEXT){i.value=u.rtrim(i.value);if(i.value.length===0){this.children.pop();this.add(w);return}}i.next=w}w.previous=i;w.parent=this;this.children.push(w);this._.hasInlineStarted=w.type==p.NODE_TEXT||w.type==p.NODE_ELEMENT&&!w._.isBlockLike},writeHtml:function(w,i){var a;
this.filterChildren=this.filterChildren=function(){var b=new z.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,b,i,B);b=b.getHtml();this.children=(new q.FromHtml(b)).children;a=1};!this.name&&i&&i.onFragment(this);this.writeChildrenHtml(w,a?H:i)},writeChildrenHtml:function(w,i){for(var a=0;a<this.children.length;a++)this.children[a].writeHtml(w,i)}});z.HtmlParser.Fragment=q;z.HtmlParser.Fragment=q;q.FromHtml=q.FromHtml;t=q.prototype;z.Utils.extern(t,{add:t.add,writeHtml:t.writeHtml,writeChildrenHtml:t.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function q(y,t){this.name=y;this.attributes=t||(t={});this.children=[];var u=t._ke_real_element_type||y,p=B.XHTML_DTD;u=!!(p.$nonBodyContent[u]||p.$block[u]||p.$listItem[u]||p.$tableContent[u]||p.$nonEditable[u]||u=="br");var e=!!p.$empty[y];this.isEmpty=e;this.isUnknown=!p[y];this._={isBlockLike:u,hasInlineStarted:e||!u}}var B=KISSY.Editor,D=B.NODE,H=function(y,t){y=y[0];t=t[0];return y<t?-1:y>t?1:0};KISSY.augment(q,{type:D.NODE_ELEMENT,add:B.HtmlParser.Fragment.prototype.add,
clone:function(){return new q(this.name,this.attributes)},writeHtml:function(y,t){var u=this.attributes,p=this,e=p.name,h,f,j,w;p.filterChildren=function(){if(!w){var b=new B.HtmlParser.BasicWriter;B.HtmlParser.Fragment.prototype.writeChildrenHtml.call(p,b,t);p.children=(new B.HtmlParser.Fragment.FromHtml(b.getHtml())).children;w=1}};p.filterChildren=p.filterChildren;if(t){for(;;){if(!(e=t.onElementName(e)))return;p.name=e;if(!(p=t.onElement(p)))return;p.parent=this.parent;if(p.name==e)break;if(p.type!=
D.NODE_ELEMENT){p.writeHtml(y,t);return}e=p.name;if(!e){this.writeChildrenHtml.call(p,y,w?null:t);return}}u=p.attributes}y.openTag(e,u);for(var i=[],a=0;a<2;a++)for(h in u){f=h;j=u[h];if(a==1)i.push([h,j]);else if(t){for(;;)if(f=t.onAttributeName(h))if(f!=h){delete u[h];h=f}else break;else{delete u[h];break}if(f)if((j=t.onAttribute(p,f,j))===false)delete u[f];else u[f]=j}}y.sortAttributes&&i.sort(H);u=i.length;for(a=0;a<u;a++){h=i[a];y.attribute(h[0],h[1])}y.openTagClose(e,p.isEmpty);if(!p.isEmpty){this.writeChildrenHtml.call(p,
y,w?null:t);y.closeTag(e)}},writeChildrenHtml:function(){B.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});B.HtmlParser.Element=q;B.HtmlParser.Element=q;var z=q.prototype;B.Utils.extern(z,{type:z.type,add:z.add,clone:z.clone,writeHtml:z.writeHtml,writeChildrenHtml:z.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function q(h){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};h&&this.addRules(h,10)}function B(h,f){for(var j=0;h&&j<f.length;j++){var w=f[j];h=h.replace(w[0],w[1])}return h}function D(h,f,j){if(typeof f=="function")f=[f];var w,i;i=h.length;var a=f&&f.length;if(a){for(w=0;w<i&&h[w].pri<j;w++);for(i=a-1;i>=0;i--)if(a=f[i]){a.pri=j;h.splice(w,0,a)}}}function H(h,f,j){if(f)for(var w in f){var i=h[w];h[w]=z(i,f[w],
j);i||h.$length++}}function z(h,f,j){if(f){f.pri=j;if(h){if(h.splice)D(h,f,j);else{h=h.pri>j?[f,h]:[h,f];h.filter=y}return h}else return f.filter=f}}function y(h){for(var f=h.type||h instanceof u.HtmlParser.Fragment,j=0;j<this.length;j++){if(f)var w=h.type,i=h.name;var a=this[j].apply(window,arguments);if(a===e)return a;if(f){if(a&&(a.name!=i||a.type!=w))return a}else if(typeof a!="string")return a;a!=undefined&&(h=a)}return h}var t=KISSY,u=t.Editor,p=u.NODE,e=false;t.augment(q,{addRules:function(h,
f){if(typeof f!="number")f=10;D(this._.elementNames,h.elementNames,f);D(this._.attributeNames,h.attributeNames,f);H(this._.elements,h.elements,f);H(this._.attributes,h.attributes,f);this._.text=z(this._.text,h.text,f)||this._.text;this._.comment=z(this._.comment,h.comment,f)||this._.comment;this._.root=z(this._.root,h.root,f)||this._.root},onElementName:function(h){return B(h,this._.elementNames)},onAttributeName:function(h){return B(h,this._.attributeNames)},onText:function(h){var f=this._.text;
return f?f.filter(h):h},onComment:function(h,f){var j=this._.comment;return j?j.filter(h,f):h},onFragment:function(h){var f=this._.root;return f?f.filter(h):h},onElement:function(h){for(var f=[this._.elements["^"],this._.elements[h.name],this._.elements.$],j,w=0;w<3;w++)if(j=f[w]){j=j.filter(h,this);if(j===e)return null;if(j&&j!=h)return this.onNode(j);if(h.parent&&!h.name)break}return h},onNode:function(h){var f=h.type;return f==p.NODE_ELEMENT?this.onElement(h):f==p.NODE_TEXT?new u.HtmlParser.Text(this.onText(h.value)):
null},onAttribute:function(h,f,j){if(f=this._.attributes[f]){h=f.filter(j,h,this);if(h===e)return e;if(typeof h!="undefined")return h}return j}});u.HtmlParser.Filter=q;t=q.prototype;u.Utils.extern(t,{addRules:t.addRules,onElementName:t.onElementName,onAttributeName:t.onAttributeName,onText:t.onText,onComment:t.onComment,onFragment:t.onFragment,onElement:t.onElement,onNode:t.onNode,onAttribute:t.onAttribute});u.HtmlParser.Filter=q});
KISSY.Editor.add("htmlparser-text",function(){function q(z){this.value=z;this._={isBlockLike:H}}var B=KISSY,D=B.Editor,H=false;B.augment(q,{type:D.NODE.NODE_TEXT,writeHtml:function(z,y){var t=this.value;y&&!(t=y.onText(t,this))||z.text(t)}});D.HtmlParser.Text=q;D.HtmlParser.Text=q});
KISSY.Editor.add("htmlparser-comment",function(){function q(H){this.value=H;this._={isBlockLike:false}}var B=KISSY.Editor,D=B.NODE;B.HtmlParser.Comment=q;B.HtmlParser.Comment=q;q.prototype={constructor:q,type:D.NODE_COMMENT,writeHtml:function(H,z){var y=this.value;if(z){if(!(y=z.onComment(y,this)))return;if(typeof y!="string"){y.parent=this.parent;y.writeHtml(H,z);return}}H.comment(y)}}});
