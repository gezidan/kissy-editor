/*
 Constructor for kissy editor and module dependency definition
 thanks to CKSource's intelligent work on CKEditor
 @author: yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.0
 @buildtime: 2010-11-10 13:03:14
*/
KISSY.add("editor",function(r,E){function B(n,k){function a(s){for(var i=B.Env.mods,j=0;j<s.length;j++){for(var x=s[j],F=v,w=0;w<j;w++)if(x==s[w]){F=C;break}w=i[x];if(F&&w){F=r.clone(w);x=x+"_"+j;F.name=x;s[j]=x;i[x]||(i[x]=F)}}}var b=this;if(!(b instanceof B))return new B(n,k);if(r.isString(n))n=r.one(n);n=z._4e_wrap(n);k=k||{};k.pluginConfig=k.pluginConfig||{};b.cfg=k;k.pluginConfig=k.pluginConfig;b.cfg=k;r.app(b,r.EventTarget);var d=["htmldataprocessor","enterkey","clipboard"],o=v;b.use=function(s,
i){s=s.split(",");a(s);if(!o)for(var j=0;j<d.length;j++){var x=d[j];r.inArray(x,s)||s.unshift(x)}r.use.call(b,s.join(","),function(){b.ready(function(){i&&i.call(b);if(!o){b.setData(n.val());if(k.focus)b.focus();else{var F=b.getSelection();F&&F.removeAllRanges()}b.fire("save");o=C}})},{order:C,global:B});return b};b.use=b.use;b.init(n);return b}function H(n){var k=r.Config.debug;n=k?k==="dev"?"../src/"+n:n:n.replace(/\.(js|css)/i,"-min.$1");n+=n.indexOf("?")!=-1?"&":"?";n+="t="+encodeURIComponent("2010-11-10 13:03:14");
return n}var z=r.DOM,C=true,v=false;r.app(B,r.EventTarget);B.Config.base=r.Config.base+"editor/";var q=["separator","sourcearea/support","tabs","flashbridge","flashutils","clipboard",{name:"colorsupport",requires:["overlay"]},{name:"colorsupport/dialog"},{name:"forecolor",requires:["colorsupport"]},{name:"bgcolor",requires:["colorsupport"]},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},
{name:"flash",requires:["flash/support"]},{name:"flash/dialog"},{name:"flash/support",requires:["flashutils","contextmenu","fakeobjects","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor"},{name:"image",requires:["contextmenu","bubbleview"]},{name:"image/dialog",requires:["tabs"]},"indent","justify",{name:"link",requires:["bubbleview"]},{name:"link/dialog"},"list","maximize",{name:"music",requires:["flash/support"]},{name:"music/dialog",requires:["flash/dialog"]},
"preview","removeformat",{name:"smiley"},{name:"sourcearea",requires:["sourcearea/support"]},{name:"table",requires:["contextmenu"]},{name:"table/dialog"},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],e,h,l,f,t={};e=0;for(h=q.length;e<h;e++){l=q[e];if(r.isString(l))l=q[e]={name:l+"",requires:null};f=l.requires||[];var u=["button"];l.name.indexOf("/dialog")!=-1&&u.push("overlay");l.requires=f.concat(u)}q=[{name:"localStorage",requires:["flashutils","flashbridge"]},
{name:"button"},{name:"dd"},{name:"progressbar"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(q);e=0;for(h=q.length;e<h;e++){l=q[e];f=l.name;t[f]={attach:v,charset:"utf-8",requires:l.requires,csspath:l.useCss?H("plugins/"+f+"/plugin.css"):E,path:H("plugins/"+f+"/plugin.js")}}B.add(t);r.Editor=B;r.Editor=B});
KISSY.Editor.add("utils",function(r){var E=null,B=KISSY,H=B.Node,z=B.DOM,C=B.UA,v=B.Event,q={debugUrl:function(e){var h=B.Config.debug;e=h?h==="dev"?"../src/"+e:e:e.replace(/\.(js|css)/i,"-min.$1");e+=e.indexOf("?")!=-1?"&":"?";e+="t="+encodeURIComponent("2010-11-05 14:02:14");return e},lazyRun:function(e,h,l){var f=e[h],t=e[l];e[h]=function(){f.apply(this,arguments);e[h]=e[l];return t.apply(this,arguments)}},getXY:function(e,h,l,f){l=l.defaultView||l.parentWindow;e-=z.scrollLeft(l);h-=z.scrollTop(l);
if(f)if(l!=(f.defaultView||f.parentWindow)&&l.frameElement){f=z._4e_getOffset(l.frameElement,f);e+=f.left;h+=f.top}return{left:e,top:h}},tryThese:function(){for(var e,h=0,l=arguments.length;h<l;h++){var f=arguments[h];try{e=f();break}catch(t){}}return e},arrayCompare:function(e,h){if(!e&&!h)return true;if(!e||!h||e.length!=h.length)return false;for(var l=0;l<e.length;l++)if(e[l]!==h[l])return false;return true},getByAddress:function(e,h,l){e=e.documentElement;for(var f=0;e&&f<h.length;f++){var t=
h[f];if(l)for(var u=-1,n=0;n<e.childNodes.length;n++){var k=e.childNodes[n];if(!(l===true&&k.nodeType==3&&k.previousSibling&&k.previousSibling.nodeType==3)){u++;if(u==t){e=k;break}}}else e=e.childNodes[t]}return e?new H(e):E},clearAllMarkers:function(e){for(var h in e)e[h]._4e_clearMarkers(e,true)},htmlEncodeAttr:function(e){return e.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(e){return e.replace(/^\s+/,"")},rtrim:function(e){return e.replace(/\s+$/,"")},trim:function(e){return this.ltrim(this.rtrim(e))},
mix:function(){for(var e={},h=0;h<arguments.length;h++)e=B.mix(e,arguments[h]);return e},isCustomDomain:function(){if(!C.ie)return false;var e=document.domain,h=window.location.hostname;return e!=h&&e!="["+h+"]"},duplicateStr:function(e,h){return Array(h+1).join(e)},throttle:function(e,h,l){l=l||150;if(l===-1)return function(){e.apply(h,arguments)};var f=(new Date).getTime();return function(){var t=(new Date).getTime();if(t-f>l){f=t;e.apply(h,arguments)}}},buffer:function(e,h,l){l=l||0;var f=E;return function(){f&&
clearTimeout(f);var t=arguments;f=setTimeout(function(){return e.apply(h,t)},l)}},isNumber:function(e){return/^\d+(.\d+)?$/.test(B.trim(e))},verifyInputs:function(e){for(var h=0;h<e.length;h++){var l=z._4e_wrap(e[h]),f=B.trim(l.val()),t=l.attr("data-verify");l=l.attr("data-warning");if(t&&!RegExp(t).test(f)){alert(l);return false}}return true},sourceDisable:function(e,h){e.on("sourcemode",h.disable,h);e.on("wysiwygmode",h.enable,h)},resetInput:function(e){var h=e.attr("placeholder");if(h&&!C.webkit){e.val(h);
e.addClass("ke-input-tip")}else C.webkit&&e.val("")},valInput:function(e,h){e.val(h);e.removeClass("ke-input-tip")},placeholder:function(e,h){e.attr("placeholder",h);if(!C.webkit){e.on("blur",function(){if(!B.trim(e.val())){e.val(h);e.addClass("ke-input-tip")}});e.on("focus",function(){B.trim(e.val())==h&&e.val("");e.removeClass("ke-input-tip")})}},clean:function(e){e=e[0]||e;for(var h=B.makeArray(e.childNodes),l=0;l<h.length;l++){var f=h[l];f.nodeType==r.NODE.NODE_TEXT&&!B.trim(f.nodeValue)&&e.removeChild(f)}},
htmlEncode:function(e){return!e?e:String(e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(e){return!e?e:String(e).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(e,h){return e.toLowerCase()==h.toLowerCase()},normParams:function(e){e=B.clone(e);for(var h in e)if(e.hasOwnProperty(h)){var l=e[h];if(B.isFunction(l))e[h]=l()}return e},doFormUpload:function(e,h,l){function f(){var d=
{responseText:"",responseXML:E};d.argument=e?e.argument:E;try{var o;if((o=C.ie?u.contentWindow.document:u.contentDocument||window.frames[t].document)&&o.body)d.responseText=o.body.innerHTML;d.responseXML=o&&o.XMLDocument?o.XMLDocument:o}catch(s){}v.remove(u,"load",f);e.callback&&e.callback(d);setTimeout(function(){z._4e_remove(u)},100)}var t=B.guid("form-upload-"),u=document.createElement("iframe");u.id=t;u.name=t;u.className="ke-hidden";if(C.ie)u.src="javascript:FALSE";document.body.appendChild(u);
if(C.ie)document.frames[t].name=t;var n=z._4e_unwrap(e.form),k={target:n.target,method:n.method,encoding:n.encoding,enctype:n.enctype,action:n.action};n.target=t;n.method="POST";n.enctype=n.encoding="multipart/form-data";if(l)n.action=l;var a;if(h){a=[];h=r.Utils.normParams(h);for(var b in h)if(h.hasOwnProperty(b)){l=document.createElement("input");l.type="hidden";l.name=b;l.value=h[b];n.appendChild(l);a.push(l)}}v.on(u,"load",f);n.submit();n.target=k.target;n.method=k.method;n.enctype=k.enctype;
n.encoding=k.encoding;n.action=k.action;if(a){h=0;for(n=a.length;h<n;h++)z._4e_remove(a[h])}return u},extern:function(e,h){for(var l in h)e[l]=h[l]},map:function(e,h){for(var l=0;l<e.length;l++)e[l]=h(e[l]);return e}};r.Utils=q;r.Utils=q;q.extern(q,{debugUrl:q.debugUrl,lazyRun:q.lazyRun,getXY:q.getXY,tryThese:q.tryThese,arrayCompare:q.arrayCompare,getByAddress:q.getByAddress,clearAllMarkers:q.clearAllMarkers,htmlEncodeAttr:q.htmlEncodeAttr,ltrim:q.ltrim,rtrim:q.rtrim,trim:q.trim,mix:q.mix,isCustomDomain:q.isCustomDomain,
duplicateStr:q.duplicateStr,buffer:q.buffer,isNumber:q.isNumber,verifyInputs:q.verifyInputs,sourceDisable:q.sourceDisable,resetInput:q.resetInput,placeholder:q.placeholder,clean:q.clean,htmlEncode:q.htmlEncode,htmlDecode:q.htmlDecode,equalsIgnoreCase:q.equalsIgnoreCase,normParams:q.normParams,throttle:q.throttle,doFormUpload:q.doFormUpload,map:q.map})});
KISSY.Editor.add("focusmanager",function(r){function E(){this.iframeFocus=e;q=this}function B(){this.iframeFocus=h;q=l}var H=KISSY,z=H.DOM,C=H.Event,v={},q;H={refreshAll:function(){for(var f in v){var t=v[f];t.document.designMode="off";t.document.designMode="on"}},currentInstance:function(){return q},getInstance:function(f){return v[f]},add:function(f){var t=z._4e_getWin(f.document);C.on(t,"focus",E,f);C.on(t,"blur",B,f)},register:function(f){v[f._UUID]=f},remove:function(f){delete v[f._UUID];var t=
z._4e_getWin(f.document);C.remove(t,"focus",E,f);C.remove(t,"blur",B,f)}};var e=true,h=false,l=null;r.focusManager=H;r.focusManager=H;r.getInstances=function(){return v};r.getInstances=r.getInstances});
KISSY.Editor.add("definition",function(r){function E(a,b){return"<!doctype html><html><head><title>${title}</title><link href='"+r.Config.base+t+"' rel='stylesheet'/><style>"+(b||"")+"</style></head><body class='ke-editor'>&nbsp;"+(a?'<script id="ke_actscript" type="text/javascript">'+(r.Utils.isCustomDomain()?'document.domain="'+z.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':"")+"</body></html>"}var B=true,H=false,z=document,C=KISSY,v=C.UA,q=C.DOM,e=C.Node,h=C.Event,
l=r.focusManager,f=r.Utils.tryThese,t=r.Utils.debugUrl("theme/editor-iframe.css"),u=1,n="document.open();"+(r.Utils.isCustomDomain()?'document.domain="'+z.domain+'";':"")+"document.close();",k="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(v.ie?"javascript:void(function(){"+encodeURIComponent(n)+
"}())":"")+'"  tabIndex="'+(v.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";r.SOURCE_MODE=0;r.WYSIWYG_MODE=1;r.SOURCE_MODE=r.SOURCE_MODE;r.WYSIWYG_MODE=r.WYSIWYG_MODE;C.augment(r,{init:function(a){if(v.ie)q.addClass(z.body,"ie"+v.ie);else if(v.gecko)q.addClass(z.body,"gecko");else v.webkit&&q.addClass(z.body,"webkit");var b=this,d=new e(k.replace(/\$\(tabIndex\)/,a.attr("tabIndex")));d.on("mousedown",function(i){if(v.webkit){var j=
q._4e_name(i.target);if(j=="select"||j=="option")return B}i.halt()});a.on("mousedown",function(i){i.stopPropagation()});b.editorWrap=d;b._UUID=u++;l.register(b);b.wrap=d.one(".ke-textarea-wrap");b.wrap=b.wrap;b.iframe=b.wrap.one("iframe");b.iframe=b.iframe;b.toolBarDiv=d.one(".ke-editor-tools");b.toolBarDiv=b.toolBarDiv;b.textarea=a;b.textarea=b.textarea;b.statusDiv=d.one(".ke-editor-status");b.statusDiv=b.statusDiv;b.toolBarDiv._4e_unselectable();b._commands={};b._dialogs={};var o=a._4e_style("width"),
s=a._4e_style("height");if(o){d.css("width",o);a.css("width","100%")}b.textarea.css("display","none");d.insertAfter(a);b.wrap[0].appendChild(a[0]);if(s){b.wrap.css("height",s);a.css("height","100%")}d=b.iframe;b.on("dataReady",function(){b._ready=B;r.fire("instanceCreated",{editor:b})});v.gecko?d.on("load",b._setUpIFrame,b):b._setUpIFrame();b.cfg.attachForm&&a[0].form&&b._attachForm()},_attachForm:function(){(new e(this.textarea[0].form)).on("submit",this.sync,this)},useDialog:function(a,b){var d=
this,o=r.SimpleOverlay;o.loading();d.use(a,function(){var s=d.getDialog(a);b(s);o.unloading()})},addDialog:function(a,b){this._dialogs[a]=b},getDialog:function(a){return this._dialogs[a]},addPlugin:function(a){this.ready(a)},addCommand:function(a,b){this._commands[a]=b},hasCommand:function(a){return this._commands[a]},execCommand:function(a){var b=this._commands[a],d=C.makeArray(arguments);d.shift();d.unshift(this);return b.exec.apply(b,d)},getMode:function(){return this.textarea.css("display")==
"none"?r.WYSIWYG_MODE:r.SOURCE_MODE},getData:function(a){var b;b=this.getMode()==r.WYSIWYG_MODE?this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)b=a?this.htmlDataProcessor.toHtml(b,"p"):this.htmlDataProcessor.toServer(b,"p");return b},setData:function(a){var b=a;if(this.htmlDataProcessor)b=this.htmlDataProcessor.toDataFormat(a,"p");this.document.body.innerHTML=b;this.getMode()!=r.WYSIWYG_MODE&&this.textarea.val(a)},sync:function(){this.textarea.val(this.getData())},baseZIndex:function(a){a=
a||0;return a+(this.cfg.baseZIndex||0)},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(a){this.document.body.innerHTML=a},_prepareIFrameHtml:E,getSelection:function(){return r.Selection.getSelection(this.document)},focus:function(){var a=this.document,b=q._4e_getWin(a);v.webkit&&b&&b.parent&&b.parent.focus();b&&b.focus();a&&a.body.focus();this.notifySelectionChange()},blur:function(){q._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(a){var b=
this.cfg,d=this.document;b.customStyle=b.customStyle||"";b.customStyle+="\n"+a;b=d.createElement("style");d.getElementsByTagName("head")[0].appendChild(b);if(b.styleSheet)b.styleSheet.cssText=a;else b.appendChild(d.createTextNode(a))},_setUpIFrame:function(){function a(){i=s.document;b.document=i;d.detach();i.open("text/html","replace");i.write(o);i.close()}var b=this,d=b.iframe,o=E(b._UUID,b.cfg.customStyle),s=d[0].contentWindow,i;try{i=s.document}catch(j){d[0].src=d[0].src;if(v.ie<7){setTimeout(a,
10);return}}a()},ready:function(a){this._ready?a():this.on("dataReady",a)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var d=b.getStartElement(),o=new r.ElementPath(d);if(!a.previousPath||!a.previousPath.compare(o)){a.previousPath=o;a.fire("selectionChange",{selection:b,path:o,element:d})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(a,
b){var d=this;d.focus();var o=a._4e_name(),s=r.XHTML_DTD,i=r.RANGE,j=r.NODE,x=s.$block[o],F=d.getSelection(),w=F&&F.getRanges(),c,g,m,y,p;if(!w||w.length==0){var D=arguments,Q=D.callee;setTimeout(function(){Q.apply(d,D)},30)}else{d.fire("save");for(var N=w.length-1;N>=0;N--){c=w[N];c.deleteContents();g=!N&&a||a._4e_clone(B);b&&b(g);if(x)for(;(y=c.getCommonAncestor(H,B))&&(p=s[y._4e_name()])&&!(p&&p[o]);)if(y._4e_name()in s.span)c.splitElement(y);else if(c.checkStartOfBlock()&&c.checkEndOfBlock()){c.setStartBefore(y);
c.collapse(B);y._4e_remove()}else c.splitBlock();c.insertNode(g);m||(m=g)}if(m){o=m._4e_nextSourceNode(B);s=d.document;p=r.XHTML_DTD;if(p.$inline[g._4e_name()]){o=new e(s.createTextNode(" "));o.insertAfter(m)}else if(o){if(o._4e_name()=="br"&&p[o.parent()._4e_name()].p){p=new e("<p>&nbsp;</p>",null,s);o[0].parentNode.replaceChild(p[0],o[0]);o=p}}else{p=new e("<p>&nbsp;</p>",null,s);p.insertAfter(m);o=p}c.moveToPosition(m,i.POSITION_AFTER_END);o&&o[0].nodeType==j.NODE_ELEMENT&&c.moveToElementEditablePosition(o);
F.selectRanges([c]);d.focus();g&&g._4e_scrollIntoView();setTimeout(function(){d.fire("save")},10);return g}}},insertHtml:function(a){var b=this;if(b.htmlDataProcessor)a=b.htmlDataProcessor.toDataFormat(a);if(v.webkit){var d=q.create(a,null,this.document);d=d.nodeType==11?C.makeArray(d.childNodes):[d];for(var o=0;o<d.length;o++)b.insertElement(new e(d[o]))}else{b.focus();o=(d=b.getSelection())&&d.getRanges();if(!o||o.length==0){var s=arguments,i=s.callee;setTimeout(function(){i.apply(b,s)},30)}else{b.fire("save");
if(v.ie){d=d.getNative();d.type=="Control"&&d.clear();d.createRange().pasteHTML(a)}else b.document.execCommand("inserthtml",H,a);b.focus();setTimeout(function(){b.fire("save")},10)}}}});r._initIFrame=function(a){function b(g){f(function(){s.designMode="on";setTimeout(function(){s.designMode="off";x.focus();if(!arguments.callee.retry)arguments.callee.retry=B},50)},function(){s.designMode="off";q.attr(x,"contentEditable",H);q.attr(x,"contentEditable",B);!g&&b(1)})}var d=l.getInstance(a);a=d.textarea[0];
var o=d.iframe[0].contentWindow,s=d.document,i=d.cfg,j=s.getElementById("ke_actscript");q._4e_remove(j);var x=s.body;if(v.ie){x.hideFocus=B;x.disabled=B;x.contentEditable=B;x.removeAttribute("disabled")}else setTimeout(function(){if(v.gecko||v.opera)x.contentEditable=B;else if(v.webkit)x.parentNode.contentEditable=B;else s.designMode="on"},0);if(v.webkit){h.on(s,"click",function(g){var m=new e(g.target);C.inArray(m._4e_name(),["input","select"])&&g.preventDefault()});h.on(s,"mouseup",function(g){var m=
new e(g.target);C.inArray(m._4e_name(),["input","textarea"])&&g.preventDefault()})}if(v.gecko||v.ie||v.opera){var F;F=new e(q.insertAfter((new e('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],a));F.on("focus",function(){d.focus()});d.activateGecko=function(){v.gecko&&d.iframeFocus&&F[0].focus()};d.on("destroy",function(){})}if(v.ie&&s.compatMode=="CSS1Compat"||v.gecko||v.opera){var w=new e(s.documentElement);w.on("mousedown",function(g){if(g.target==
w[0]){v.gecko&&b(H);F[0].focus()}})}h.on(o,"focus",function(){if(v.gecko)b(H);else v.opera&&x.focus();d.notifySelectionChange()});v.gecko&&h.on(d.document,"mousedown",function(){d.iframeFocus||b(H)});if(v.ie){h.on(s,"keydown",function(g){if(g.keyCode in{8:1,46:1}){var m=d.getSelection(),y=m.getSelectedElement();if(y){d.fire("save");var p=m.getRanges()[0].createBookmark();y._4e_remove();m.selectBookmarks([p]);d.fire("save");g.preventDefault()}}});if(s.compatMode=="CSS1Compat"){var c={33:1,34:1};h.on(s,
"keydown",function(g){g.keyCode in c&&setTimeout(function(){d.getSelection().scrollIntoView()},0)})}}setTimeout(function(){v.ie&&setTimeout(function(){if(s){x.runtimeStyle.marginBottom="0px";x.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){d.fire("dataReady");var g=i.disableObjectResizing,m=i.disableInlineTableEditing;if(g||m)try{s.execCommand("enableObjectResizing",H,!g);s.execCommand("enableInlineTableEditing",H,!m)}catch(y){h.on(x,v.ie?"resizestart":"resize",function(p){if(g||q._4e_name(p.target)===
"table"&&m)p.preventDefault()})}},10);v.webkit&&h.on(s,"mousedown",function(g){g=new e(g.target);C.inArray(g._4e_name(),["img","hr","input","textarea","select"])&&d.getSelection().selectElement(g)});v.gecko&&h.on(s,"dragstart",function(g){var m=new e(g.target);m._4e_name()==="img"&&/ke_/.test(m[0].className)&&g.preventDefault()});l.add(d)};n=r.prototype;r.Utils.extern(n,{setData:n.setData,getData:n.getData,insertElement:n.insertElement,insertHtml:n.insertHtml,ready:n.ready,addCustomStyle:n.addCustomStyle,
addCommand:n.addCommand,hasCommand:n.hasCommand,execCommand:n.execCommand,addPlugin:n.addPlugin,useDialog:n.useDialog,addDialog:n.addDialog,getDialog:n.getDialog,getMode:n.getMode,sync:n.sync,baseZIndex:n.baseZIndex,getSelection:n.getSelection,focus:n.focus,blur:n.blur,notifySelectionChange:n.notifySelectionChange})});
KISSY.Editor.add("zindex",function(){var r=KISSY.Editor;if(!r.zIndexManager){r.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};r.baseZIndex=function(E){var B=E,H=r.getInstances(),z;for(z in H){if(!H.hasOwnProperty(z))return;B=Math.max(B,H[z].baseZIndex(E))}return B};r.baseZIndex=r.baseZIndex;r.zIndexManager=r.zIndexManager}});
KISSY.Editor.add("dtd",function(r){r.XHTML_DTD=function(){function E(i){for(var j=arguments.length-1;j>0;)KISSY.mix(i,arguments[j--]);return i}var B={isindex:1,fieldset:1},H={input:1,button:1,select:1,textarea:1,label:1},z=E({a:1},H),C=E({iframe:1},z),v={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},q={ins:1,del:1,script:1,style:1},e=E({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},q),h=E({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},e),l=E({p:1},h);H=E({iframe:1},h,H);h={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var f=E({a:1},H),t={tr:1},u={"#":1},n=E({param:1},h),k=E({form:1},B,C,v,l),a={li:1},b={base:1,link:1,meta:1,title:1},d=E(b,{style:1,script:1}),o={head:1,body:1},s={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:E({html:1},o,b),$block:s,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:f,$body:E({script:1,style:1},s),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:o,head:d,style:u,body:k,base:{},link:{},meta:{},title:u,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:k,td:k,br:{},th:k,center:k,kbd:f,button:E(l,v),basefont:{},h5:f,h4:f,samp:f,h6:f,ol:a,h1:f,h3:f,option:u,h2:f,form:E(B,C,v,l),select:{optgroup:1,option:1},font:f,ins:f,menu:a,abbr:f,label:f,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:f,script:u,tfoot:t,cite:f,li:k,input:{},iframe:k,strong:f,textarea:u,noframes:k,big:f,small:f,span:f,hr:{},dt:f,sub:f,optgroup:{option:1},param:{},bdo:f,"var":f,div:k,object:n,sup:f,dd:k,strike:f,area:{},dir:a,map:E({area:1,form:1,p:1},B,q,v),applet:n,dl:{dt:1,dd:1},del:f,isindex:{},fieldset:E({legend:1},h),thead:t,ul:a,acronym:f,b:f,a:H,blockquote:k,caption:f,i:f,u:f,tbody:t,s:f,address:E(C,l),tt:f,legend:f,q:f,pre:E(e,z),p:f,em:f,dfn:f}}();r.XHTML_DTD=
r.XHTML_DTD});
KISSY.Editor.add("dom",function(r){function E(a){return a.replace(/-(\w)/g,function(b,d){return d.toUpperCase()})}var B=KISSY,H=B.DOM,z=B.UA,C=B.Node,v=r.Utils,q={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};r.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};r.NODE=r.NODE;r.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};r.POSITION=r.POSITION;var e=r.NODE,h=r.POSITION,l={},f={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},t={hr:1},u=function(a){return a[0]||a},n=function(a){if(a&&!a[0])return new C(a);return a},k={_4e_wrap:n,_4e_unwrap:u,_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=u(a);
b=u(b);return a===b},_4e_isBlockBoundary:function(a,b){a=n(a);var d=B.mix(B.mix({},t),b||{});return f[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=u(a);for(var b=a.parentNode.childNodes,d=0;d<b.length;d++)if(b[d]===a)return d;return-1},_4e_first:function(a,b){a=u(a);var d=a.firstChild;if((d=d&&new C(d))&&b&&!b(d))d=d._4e_next(b);return d},_4e_move:function(a,b,d){a=u(a);
H._4e_remove(a);b=u(b);d?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_name:function(a){a=u(a);var b=a.nodeName.toLowerCase();if(z.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var d=a[0].attributes,o=b[0].attributes,s=d.length,i=o.length;if(!z.ie&&s!=i)return false;for(var j=0;j<s;j++){var x=d[j];if((!z.ie||x.specified&&x.nodeName!="_ke_expando")&&x.nodeValue!=b.attr(x.nodeName))return false}if(z.ie)for(j=
0;j<i;j++){x=o[j];if(x.specified&&x.nodeName!="_ke_expando"&&x.nodeValue!=a.attr(x.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=u(a).childNodes;for(var b=0,d=a.length;b<d;b++){var o=a[b],s=o.nodeType;if(!(s==e.NODE_ELEMENT&&o.getAttribute("_ke_bookmark")))if(s==e.NODE_ELEMENT&&!k._4e_isEmptyInlineRemoveable(o)||s==e.NODE_TEXT&&B.trim(o.nodeValue))return false}return true},_4e_moveChildren:function(a,b,d){a=u(a);b=b[0]||b;if(a!=b)if(d)for(;d=a.lastChild;)b.insertBefore(a.removeChild(d),
b.firstChild);else for(;d=a.firstChild;)b.appendChild(a.removeChild(d))},_4e_mergeSiblings:function(){function a(b,d,o){if(d[0]&&d[0].nodeType==e.NODE_ELEMENT){for(var s=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){s.push(d);d=o?new C(d[0].nextSibling):new C(d[0].previousSibling);if(!d[0]||d[0].nodeType!=e.NODE_ELEMENT)return}if(b._4e_isIdentical(d)){for(var i=o?b[0].lastChild:b[0].firstChild;s.length;)s.shift()._4e_move(b,!o);d._4e_moveChildren(b,!o);d._4e_remove();i[0]&&i[0].nodeType==
e.NODE_ELEMENT&&i._4e_mergeSiblings()}}}return function(b){if(b[0])if(q[b._4e_name()]||b._4e_name()=="a"){a(b,new C(b[0].nextSibling),true);a(b,new C(b[0].previousSibling))}}}(),_4e_unselectable:z.gecko?function(a){a=u(a);a.style.MozUserSelect="none"}:z.webkit?function(a){a=u(a);a.style.KhtmlUserSelect="none"}:function(a){a=u(a);if(z.ie||z.opera){var b,d=0;for(a.unselectable="on";b=a.all[d++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable=
"on"}}},_4e_getOffset:function(a,b){a=u(a);var d,o=0;d=0;var s=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,i=a.ownerDocument,j=i.documentElement;b=b||i;if(a.getBoundingClientRect){if(a!==i.body&&j!==a){d=a.getBoundingClientRect();o=d.left+(b===i?H.scrollLeft(s):0);d=d.top+(b===i?H.scrollTop(s):0)}if(b)if(s!=(b.defaultView||b.parentWindow)&&s.frameElement){s=k._4e_getOffset(s.frameElement,b);o+=s.left;d+=s.top}}return{left:o,top:d}},_4e_getFrameDocument:function(a){return(a=u(a))&&a.contentWindow.document},
_4e_splitText:function(a,b){a=u(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=e.NODE_TEXT)){if(z.ie&&b==a.nodeValue.length){var o=d.createTextNode("");H.insertAfter(o,a);return new C(o)}o=new C(a.splitText(b));if(d.documentMode){d=d.createTextNode("");H.insertAfter(d,o[0]);H._4e_remove(d)}return o}},_4e_parents:function(a,b){a=n(a);var d=[];do d[b?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,b,d){a=u(a);a=a.cloneNode(b);if(!d){var o=function(s){if(s.nodeType==e.NODE_ELEMENT){s.removeAttribute("id",
false);s.removeAttribute("_ke_expando",false);s=s.childNodes;for(var i=0;i<s.length;i++)o(s[i])}};o(a)}return new C(a)},_4e_nextSourceNode:function(a,b,d,o){a=u(a);if(o&&!o.call){var s=o[0]||o;o=function(j){j=j[0]||j;return j!==s}}b=!b&&a.firstChild;var i=new C(a);if(!b){if(a.nodeType==e.NODE_ELEMENT&&o&&o(a,true)===false)return null;b=a.nextSibling}for(;!b&&(i=i.parent());){if(o&&o(i,true)===false)return null;b=i[0].nextSibling}if(!b)return null;b=H._4e_wrap(b);if(o&&o(b)===false)return null;if(d&&
d!=b[0].nodeType)return b._4e_nextSourceNode(false,d,o);return b},_4e_previousSourceNode:function(a,b,d,o){a=u(a);if(o&&!o.call){var s=o[0]||o;o=function(j){j=j[0]||j;return j!==s}}b=!b&&a.lastChild;var i=new C(a);if(!b){if(a.nodeType==e.NODE_ELEMENT&&o&&o(a,true)===false)return null;b=a.previousSibling}for(;!b&&(i=i.parent());){if(o&&o(i,true)===false)return null;b=i[0].previousSibling}if(!b)return null;b=H._4e_wrap(b);if(o&&o(b)===false)return null;if(d&&b[0].nodeType!=d)return b._4e_previousSourceNode(false,
d,o);return b},_4e_contains:z.ie||z.webkit?function(a,b){a=u(a);b=u(b);return b.nodeType!=e.NODE_ELEMENT?a.contains(b.parentNode):a!=b&&a.contains(b)}:function(a,b){a=u(a);b=u(b);return!!(a.compareDocumentPosition(b)&16)},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=e.NODE_TEXT&&b._4e_contains(a))return b;var d=a[0].nodeType==e.NODE_TEXT?a.parent():a;do if(d[0].nodeType!=e.NODE_TEXT&&d._4e_contains(b))return d;while(d=d.parent());return null},_4e_ascendant:function(a,
b,d){a=u(a);if(!d)a=a.parentNode;if(b&&!B.isFunction(b)){var o=b;b=function(s){return s._4e_name()==o}}for(;a&&a.nodeType!=9;){if(!b||b(new C(a))===true)return new C(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,b){a=u(a);var d=a.attributes.getNamedItem(b);return!!(d&&d.specified)},_4e_hasAttributes:z.ie?function(a){a=u(a);for(var b=a.attributes,d=0;d<b.length;d++){var o=b[d];switch(o.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(o.specified)return true}}return false}:
function(a){a=u(a);z.gecko&&a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,b){var d=u(a),o=u(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(o);if(d==o)return h.POSITION_IDENTICAL;if(d.nodeType==e.NODE_ELEMENT&&o.nodeType==e.NODE_ELEMENT){if(d.contains){if(d.contains(o))return h.POSITION_CONTAINS+h.POSITION_PRECEDING;if(o.contains(d))return h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING}if("sourceIndex"in
d)return d.sourceIndex<0||o.sourceIndex<0?h.POSITION_DISCONNECTED:d.sourceIndex<o.sourceIndex?h.POSITION_PRECEDING:h.POSITION_FOLLOWING}d=a._4e_address();o=b._4e_address();for(var s=Math.min(d.length,o.length),i=0;i<=s-1;i++)if(d[i]!=o[i]){if(i<s)return d[i]<o[i]?h.POSITION_PRECEDING:h.POSITION_FOLLOWING;break}return d.length<o.length?h.POSITION_CONTAINS+h.POSITION_PRECEDING:h.POSITION_IS_CONTAINED+h.POSITION_FOLLOWING},_4e_address:function(a,b){a=u(a);for(var d=[],o=a.ownerDocument.documentElement,
s=a;s&&s!=o;){var i=s.parentNode,j=-1;if(i){for(var x=0;x<i.childNodes.length;x++){var F=i.childNodes[x];if(!(b&&F.nodeType==3&&F.previousSibling&&F.previousSibling.nodeType==3)){j++;if(F==s)break}}d.unshift(j)}s=i}return d},_4e_breakParent:function(a,b){var d=new r.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);var o=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(o,a[0].nextSibling)},_4e_style:function(a,b,d){a=n(a);if(d!==undefined)return a.css(b,d);
a=u(a);return a.style[E(b)]},_4e_remove:function(a,b){var d=u(a),o=d.parentNode;if(o){if(b)for(var s;s=d.firstChild;)o.insertBefore(d.removeChild(s),d);o.removeChild(d)}return a},_4e_trim:function(a){H._4e_ltrim(a);H._4e_rtrim(a)},_4e_ltrim:function(a){a=u(a);for(var b;b=a.firstChild;){if(b.nodeType==e.NODE_TEXT){var d=v.ltrim(b.nodeValue),o=b.nodeValue.length;if(d){if(d.length<o){(new C(b))._4e_splitText(o-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=
u(a);for(var b;b=a.lastChild;){if(b.type==e.NODE_TEXT){var d=v.rtrim(b.nodeValue),o=b.nodeValue.length;if(d){if(d.length<o){(new C(b))._4e_splitText(d.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!z.ie&&!z.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=u(a);for(var b=a.lastChild;b&&b.nodeType==e.NODE_TEXT&&!B.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==e.NODE_TEXT||H._4e_name(b)!==
"br"){b=z.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");z.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){var d=u(a),o;do o=(d=d.previousSibling)&&new C(d);while(o&&b&&!b(o));return o},_4e_last:function(a,b){a=H._4e_wrap(a);var d=a[0].lastChild;if((d=d&&new C(d))&&b&&!b(d))d=d._4e_previous(b);return d},_4e_next:function(a,b){var d=u(a),o;do o=(d=d.nextSibling)&&new C(d);while(o&&b&&!b(o));return o},_4e_outerHtml:function(a){a=u(a);
if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,d,o){a=H._4e_wrap(a);var s=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",B.guid())._4e_getData("list_marker_id"),i=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");b[s]=a;i[d]=1;return a._4e_setData(d,o)},_4e_clearMarkers:function(a,b,d){a=n(a);
var o=a._4e_getData("list_marker_names"),s=a._4e_getData("list_marker_id"),i;for(i in o)a._4e_removeData(i);a._4e_removeData("list_marker_names");if(d){a._4e_removeData("list_marker_id");delete b[s]}},_4e_setData:function(a,b,d){var o=H._4e_getUniqueId(a);(l[o]||(l[o]={}))[b]=d;return a},_4e_getData:function(a,b){a=u(a);var d=a.getAttribute("_ke_expando");return(d=d&&l[d])&&d[b]},_4e_removeData:function(a,b){a=u(a);var d=a.getAttribute("_ke_expando");var o=(d=d&&l[d])&&d[b];typeof o!="undefined"&&
d&&delete d[b];B.isEmptyObject(d)&&H._4e_clearData(a);return o||null},_4e_clearData:function(a){a=u(a);var b=a.getAttribute("_ke_expando");b&&delete l[b];b&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=u(a);var b=a.getAttribute("_ke_expando");if(b)return b;b=B.guid();a.setAttribute("_ke_expando",b);return b},_4e_copyAttributes:function(a,b,d){a=u(a);b=n(b);var o=a.attributes;d=d||{};for(var s=0;s<o.length;s++){var i=o[s],j=i.nodeName.toLowerCase(),x;if(!(j in d))if(j=="checked"&&
(x=H.attr(a,j)))b.attr(j,x);else if(i.specified||z.ie&&i.nodeValue&&j=="value"){x=H.attr(a,j);if(x===null)x=i.nodeValue;b.attr(j,x)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=H._4e_name(a);var b=r.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=n(a);var b=a[0].ownerDocument,d=H.scrollLeft(b),o=H.scrollTop(b),s=a.offset(),i=s.left;s=s.top;if(H.viewportHeight(b)+o<s||s<o||H.viewportWidth(b)+d<i||i<d)a.scrollIntoView(b)},
_4e_getElementsByTagName:function(a,b,d){a=u(a);if(!z.ie&&d)b=d+":"+b;d=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)d.push(new C(a[b]));return d}};B.DOM._4e_inject=function(a){B.mix(H,a);for(var b in a)a.hasOwnProperty(b)&&function(d){C.prototype[d]=function(){var o=[].slice.call(arguments,0);o.unshift(this);return a[d].apply(null,o)}}(b)};v.extern(k,{_4e_wrap:k._4e_wrap,_4e_unwrap:k._4e_unwrap,_4e_equals:k._4e_equals,_4e_isBlockBoundary:k._4e_isBlockBoundary,_4e_getWin:k._4e_getWin,_4e_index:k._4e_index,
_4e_first:k._4e_first,_4e_move:k._4e_move,_4e_name:k._4e_name,_4e_isIdentical:k._4e_isIdentical,_4e_isEmptyInlineRemoveable:k._4e_isEmptyInlineRemoveable,_4e_moveChildren:k._4e_moveChildren,_4e_mergeSiblings:k._4e_mergeSiblings,_4e_unselectable:k._4e_unselectable,_4e_getOffset:k._4e_getOffset,_4e_getFrameDocument:k._4e_getFrameDocument,_4e_splitText:k._4e_splitText,_4e_parents:k._4e_parents,_4e_clone:k._4e_clone,_4e_nextSourceNode:k._4e_nextSourceNode,_4e_previousSourceNode:k._4e_previousSourceNode,
_4e_contains:k._4e_contains,_4e_commonAncestor:k._4e_commonAncestor,_4e_ascendant:k._4e_ascendant,_4e_hasAttribute:k._4e_hasAttribute,_4e_hasAttributes:k._4e_hasAttributes,_4e_position:k._4e_position,_4e_address:k._4e_address,_4e_breakParent:k._4e_breakParent,_4e_style:k._4e_style,_4e_remove:k._4e_remove,_4e_trim:k._4e_trim,_4e_ltrim:k._4e_ltrim,_4e_rtrim:k._4e_rtrim,_4e_appendBogus:k._4e_appendBogus,_4e_last:k._4e_last,_4e_previous:k._4e_previous,_4e_next:k._4e_next,_4e_outerHtml:k._4e_outerHtml,
_4e_setMarker:k._4e_setMarker,_4e_clearMarkers:k._4e_clearMarkers,_4e_setData:k._4e_setData,_4e_getData:k._4e_getData,_4e_removeData:k._4e_removeData,_4e_clearData:k._4e_clearData,_4e_removeData:k._4e_removeData,_4e_getUniqueId:k._4e_getUniqueId,_4e_copyAttributes:k._4e_copyAttributes,_4e_isEditable:k._4e_isEditable,_4e_scrollIntoView:k._4e_scrollIntoView,_4e_getElementsByTagName:k._4e_getElementsByTagName});H._4e_inject(k)});
KISSY.Editor.add("elementpath",function(r){function E(h){var l=C,f=C,t=[];for(h=h;h&&h[0];){if(h[0].nodeType==z.NODE_ELEMENT){if(!this.lastElement)this.lastElement=h;var u=h._4e_name();if(!f){if(!l&&v[u])l=h;if(q[u]){var n;if(n=!l){if(n=u=="div"){a:{n=h;n=n[0]||n;n=n.childNodes;for(var k=0,a=n.length;k<a;k++){var b=n[k];if(b.nodeType==z.NODE_ELEMENT&&H.$block[b.nodeName.toLowerCase()]){n=true;break a}}n=false}n=!n}n=n}if(n)l=h;else f=h}}t.push(h);if(u=="body")break}h=h.parent()}this.block=this.block=
l;this.blockLimit=this.blockLimit=f;this.elements=this.elements=t}var B=KISSY.DOM,H=r.XHTML_DTD,z=r.NODE,C=null,v={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},q={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};E.prototype={compare:function(h){var l=this.elements;h=h&&h.elements;if(!h||l.length!=h.length)return false;for(var f=0;f<l.length;f++)if(!B._4e_equals(l[f],h[f]))return false;return true},contains:function(h){for(var l=this.elements,f=0;f<
l.length;f++)if(l[f]._4e_name()in h)return l[f];return C}};r.ElementPath=r.ElementPath=E;var e=E.prototype;r.Utils.extern(e,{compare:e.compare,contains:e.contains})});
KISSY.Editor.add("walker",function(r){function E(t,u){if(this._.end)return v;var n,k=this.range,a,b=this.guard,d=this.type,o=t?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;k.trim();if(k.collapsed){this.end();return v}}if(!t&&!this._.guardLTR){var s=k.endContainer,i=new l(s[0].childNodes[k.endOffset]);this._.guardLTR=function(w,c){return(w=h._4e_wrap(w))&&w[0]&&(!c||!h._4e_equals(s,w))&&(!i[0]||!w._4e_equals(i))&&(w[0].nodeType!=e.NODE_ELEMENT||!c||w._4e_name()!="body")}}if(t&&
!this._.guardRTL){var j=k.startContainer,x=k.startOffset>0&&new l(j[0].childNodes[k.startOffset-1]);this._.guardRTL=function(w,c){return(w=h._4e_wrap(w))&&w[0]&&(!c||!w._4e_equals(j))&&(!x[0]||!w._4e_equals(x))&&(w[0].nodeType!=e.NODE_ELEMENT||!c||w._4e_name()!="body")}}var F=t?this._.guardRTL:this._.guardLTR;a=b?function(w,c){if(F(w,c)===C)return C;return b(w,c)}:F;if(this.current)n=this.current[o](C,d,a);else if(t){n=k.endContainer;if(k.endOffset>0){n=new l(n[0].childNodes[k.endOffset-1]);if(a(n)===
C)n=v}else n=a(n,z)===C?v:n._4e_previousSourceNode(z,d,a)}else{n=k.startContainer;if((n=new l(n[0].childNodes[k.startOffset]))&&n[0]){if(a(n)===C)n=v}else n=a(k.startContainer,z)===C?v:k.startContainer._4e_nextSourceNode(z,d,a)}for(;n&&n[0]&&!this._.end;){this.current=n;if(!this.evaluator||this.evaluator(n)!==C){if(!u)return n}else if(u&&this.evaluator)return C;n=n[o](C,d,a)}this.end();return this.current=v}function B(t){for(var u,n=v;u=E.call(this,t);)n=u;return n}function H(t){this.range=t;this._=
{}}var z=true,C=false,v=null,q=KISSY,e=r.NODE,h=q.DOM,l=q.Node;q.augment(H,{end:function(){this._.end=1},next:function(){return E.call(this)},previous:function(){return E.call(this,z)},checkForward:function(){return E.call(this,C,z)!==C},checkBackward:function(){return E.call(this,z,z)!==C},lastForward:function(){return B.call(this)},lastBackward:function(){return B.call(this,z)},reset:function(){delete this.current;this._={}}});H.blockBoundary=function(t){return function(u){u=h._4e_wrap(u);return!(u&&
u[0].nodeType==e.NODE_ELEMENT&&u._4e_isBlockBoundary(t))}};H.listItemBoundary=function(){return this.blockBoundary({br:1})};H.bookmark=function(t,u){function n(k){return k&&k[0]&&k._4e_name()=="span"&&k.attr("_ke_bookmark")}return function(k){var a,b;a=k&&k[0]&&k[0].nodeType==e.NODE_TEXT&&(b=k.parent())&&n(b);a=t?a:a||n(k);return u^a}};H.whitespaces=function(t){return function(u){u=(u=u[0]||u)&&u.nodeType==e.NODE_TEXT&&!q.trim(u.nodeValue);return t^u}};H.invisible=function(t){var u=H.whitespaces();
return function(n){n=u(n)||n[0].nodeType==e.NODE_ELEMENT&&!n[0].offsetHeight;return t^n}};r.Walker=H;r.Walker=H;var f=H.prototype;r.Utils.extern(f,{end:f.end,next:f.next,previous:f.previous,checkForward:f.checkForward,checkBackward:f.checkBackward,lastForward:f.lastForward,lastBackward:f.lastBackward,reset:f.reset});r.Utils.extern(H,{blockBoundary:H.blockBoundary,listItemBoundary:H.listItemBoundary,bookmark:H.bookmark,whitespaces:H.whitespaces,invisible:H.invisible})});
KISSY.Editor.add("range",function(r){function E(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=h;this.collapsed=q;this.document=c}function B(c){var g=c[0].nodeType!=f.NODE_TEXT&&c._4e_name()in d.$removeEmpty,m=!l.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return g||m||c}function H(c){return!x(c)&&!F(c)}function z(c){var g=e,m=n.bookmark(q);return function(y){if(m(y))return q;if(y[0].nodeType==f.NODE_TEXT){if(l.trim(y[0].nodeValue).length)return e}else if(y[0].nodeType==
f.NODE_ELEMENT)if(!j[y._4e_name()])if(!c&&!b.ie&&y._4e_name()=="br"&&!g)g=q;else return e;return q}}function C(c,g){function m(y){return y&&y.nodeName=="span"&&y.getAttribute("_ke_bookmark")}return function(y){var p,D;p=y&&!y.nodeName&&(D=y.parentNode)&&m(D);p=c?p:p||m(y);return g^p}}function v(c){return function(g){g=(g=g[0]||g)&&g.nodeType==f.NODE_TEXT&&!l.trim(g.nodeValue);return c^g}}r.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};r.RANGE=r.RANGE;var q=true,e=false,h=null,l=KISSY,f=r.NODE,t=r.RANGE,u=r.POSITION,n=r.Walker,k=l.DOM,a=r.Utils.getByAddress,b=l.UA,d=r.XHTML_DTD,o=r.ElementPath,s=l.Node,i={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};E.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return c.join("<br/>")};l.augment(E,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&k._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,g=this.startOffset;if(c[0].nodeType!=f.NODE_ELEMENT)if(g)g>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;g=this.endOffset;if(c[0].nodeType!=f.NODE_ELEMENT)if(g)g>=
c[0].nodeValue.length&&this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,g=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,t.POSITION_BEFORE_START);
g&&g._4e_name()=="span"&&g.attr("_ke_bookmark")&&this.setEndAt(g,t.POSITION_AFTER_END)},setStart:function(c,g){if(c[0].nodeType==f.NODE_ELEMENT&&i[c._4e_name()]){c=c.parent();g=c._4e_index()}this.startContainer=c;this.startOffset=g;if(!this.endContainer){this.endContainer=c;this.endOffset=g}this.updateCollapsed()},setEnd:function(c,g){if(c[0].nodeType==f.NODE_ELEMENT&&i[c._4e_name()]){c=c.parent();g=c._4e_index()+1}this.endContainer=c;this.endOffset=g;if(!this.startContainer){this.startContainer=
c;this.startOffset=g}this.updateCollapsed()},setStartAt:function(c,g){switch(g){case t.POSITION_AFTER_START:this.setStart(c,0);break;case t.POSITION_BEFORE_END:c[0].nodeType==f.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case t.POSITION_BEFORE_START:this.setStartBefore(c);break;case t.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,g){switch(g){case t.POSITION_AFTER_START:this.setEnd(c,0);break;case t.POSITION_BEFORE_END:c[0].nodeType==
f.NODE_TEXT?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case t.POSITION_BEFORE_START:this.setEndBefore(c);break;case t.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,g){var m=this.startContainer,y=this.endContainer,p=this.startOffset,D=this.endOffset,Q,N=this.document,O;this.optimizeBookmark();if(y[0].nodeType==f.NODE_TEXT)y=y._4e_splitText(D);else if(y[0].childNodes.length>0)if(D>=y[0].childNodes.length){y=new s(y[0].appendChild(N.createTextNode("")));
O=q}else y=new s(y[0].childNodes[D]);if(m[0].nodeType==f.NODE_TEXT){m._4e_splitText(p);if(m._4e_equals(y))y=new s(m[0].nextSibling)}else if(p)if(p>=m[0].childNodes.length){Q=new s(N.createTextNode(""));m.append(Q);m=Q;Q=q}else m=new s(m[0].childNodes[p].previousSibling);else{Q=new s(N.createTextNode(""));(p=m[0].firstChild)?k.insertBefore(Q[0],p):m.append(Q);m=Q;Q=q}p=m._4e_parents();D=y._4e_parents();var P,T,S;for(P=0;P<p.length;P++){T=p[P];S=D[P];if(!T._4e_equals(S))break}N=g;for(var A,K,G,I=P;I<
p.length;I++){A=p[I];if(N&&!A._4e_equals(m))K=N.appendChild(A._4e_clone()[0]);for(A=A[0].nextSibling;A;){if(k._4e_equals(D[I],A)||k._4e_equals(y,A))break;G=A.nextSibling;if(c==2)N.appendChild(A.cloneNode(q));else{A.parentNode.removeChild(A);c==1&&N.appendChild(A)}A=G}if(K)N=K}N=g;for(P=P;P<D.length;P++){A=D[P];if(c>0&&!A._4e_equals(y))K=N.appendChild(A._4e_clone()[0]);if(!p[P]||!A.parent()._4e_equals(p[P].parent()))for(A=A[0].previousSibling;A;){if(k._4e_equals(p[P],A)||k._4e_equals(m,A))break;G=
A.previousSibling;if(c==2)N.insertBefore(A.cloneNode(q),N.firstChild);else{k._4e_remove(A);c==1&&N.insertBefore(A,N.firstChild)}A=G}if(K)N=K}if(c==2){S=this.startContainer[0];if(S.nodeType==f.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==f.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}S=this.endContainer[0];if(S.nodeType==f.NODE_TEXT&&S.nextSibling&&S.nextSibling.nodeType==f.NODE_TEXT){S.data+=S.nextSibling.data;S.parentNode.removeChild(S.nextSibling)}}else{if(T&&
S&&(!m.parent()._4e_equals(T.parent())||!y.parent()._4e_equals(S.parent()))){T=S._4e_index();Q&&S.parent()._4e_equals(m.parent())&&T--;this.setStart(S.parent(),T)}this.collapse(q)}Q&&m._4e_remove();O&&y[0].parentNode&&y._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=q},clone:function(){var c=new E(this.document);c.startContainer=this.startContainer;
c.startOffset=this.startOffset;c.endContainer=this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=f.NODE_ELEMENT||c.endContainer[0].nodeType!=f.NODE_ELEMENT)return h;var g=new r.Walker(c),m=C(q,undefined),y=v(q);c.evaluator=function(p){return y(p)&&m(p)};c=g.next();g.reset();g=g.previous();return c&&c._4e_equals(g)?c:h},shrink:function(c,g){if(!this.collapsed){c=c||t.SHRINK_TEXT;
var m=this.clone(),y=this.startContainer,p=this.endContainer,D=this.startOffset,Q=this.endOffset,N=1,O=1;if(y&&y[0].nodeType==f.NODE_TEXT)if(D)if(D>=y[0].nodeValue.length)m.setStartAfter(y);else{m.setStartBefore(y);N=0}else m.setStartBefore(y);if(p&&p[0].nodeType==f.NODE_TEXT)if(Q)if(Q>=p[0].nodeValue.length)m.setEndAfter(p);else{m.setEndAfter(p);O=0}else m.setEndBefore(p);m=new n(m);m.evaluator=function(T){T=T[0]||T;return T.nodeType==(c==t.SHRINK_ELEMENT?f.NODE_ELEMENT:f.NODE_TEXT)};var P;m.guard=
function(T,S){T=T[0]||T;if(c==t.SHRINK_ELEMENT&&T.nodeType==f.NODE_TEXT)return e;if(S&&T==P)return e;if(!S&&T.nodeType==f.NODE_ELEMENT)P=T;return q};if(N)(y=m[c==t.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(y,g?t.POSITION_AFTER_START:t.POSITION_BEFORE_START);if(O){m.reset();(m=m[c==t.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(m,g?t.POSITION_BEFORE_END:t.POSITION_AFTER_END)}return!!(N||O)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||c[0].nodeType!=
f.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var g=this.startContainer,m=this.endContainer,y=this.startOffset,p=this.endOffset,D,Q;if(!g||!m)return{start:0,end:0};if(c){if(g[0].nodeType==f.NODE_ELEMENT)if((D=new s(g[0].childNodes[y]))&&D[0]&&D[0].nodeType==f.NODE_TEXT&&y>0&&D[0].previousSibling.nodeType==f.NODE_TEXT){g=D;y=0}for(;g[0].nodeType==f.NODE_TEXT&&(Q=g._4e_previous())&&Q[0].nodeType==f.NODE_TEXT;){g=Q;y+=Q[0].nodeValue.length}if(!this.collapsed){if(m[0].nodeType==
f.NODE_ELEMENT)if((D=new s(m[0].childNodes[p]))&&D[0]&&D[0].nodeType==f.NODE_TEXT&&p>0&&D[0].previousSibling.nodeType==f.NODE_TEXT){m=D;p=0}for(;m[0].nodeType==f.NODE_TEXT&&(Q=m._4e_previous())&&Q[0].nodeType==f.NODE_TEXT;){m=Q;p+=Q[0].nodeValue.length}}}return{start:g._4e_address(c),end:this.collapsed?h:m._4e_address(c),startOffset:y,endOffset:p,normalized:c,is2:q}},createBookmark:function(c){var g,m,y,p,D=this.collapsed;g=new s("<span>",h,this.document);g.attr("_ke_bookmark",1);g.css("display",
"none");g.html("&nbsp;");if(c){y=l.guid("ke_bm_");g.attr("id",y+"S")}if(!D){m=g._4e_clone();m.html("&nbsp;");c&&m.attr("id",y+"E");p=this.clone();p.collapse();p.insertNode(m)}p=this.clone();p.collapse(q);p.insertNode(g);if(m){this.setStartAfter(g);this.setEndBefore(m)}else this.moveToPosition(g,t.POSITION_AFTER_END);return{startNode:c?y+"S":g,endNode:c?y+"E":m,serializable:c,collapsed:D}},moveToPosition:function(c,g){this.setStartAt(c,g);this.collapse(q)},trim:function(c,g){var m=this.startContainer,
y=this.startOffset,p=this.collapsed;if((!c||p)&&m[0]&&m[0].nodeType==f.NODE_TEXT){if(y)if(y>=m[0].nodeValue.length){y=m._4e_index()+1;m=m.parent()}else{var D=m._4e_splitText(y);y=m._4e_index()+1;m=m.parent();if(k._4e_equals(this.startContainer,this.endContainer))this.setEnd(D,this.endOffset-this.startOffset);else if(k._4e_equals(m,this.endContainer))this.endOffset+=1}else{y=m._4e_index();m=m.parent()}this.setStart(m,y);if(p){this.collapse(q);return}}m=this.endContainer;y=this.endOffset;if(!(g||p)&&
m[0]&&m[0].nodeType==f.NODE_TEXT){if(y){y>=m.nodeValue.length||m._4e_splitText(y);y=m._4e_index()+1}else y=m._4e_index();m=m.parent();this.setEnd(m,y)}},insertNode:function(c){this.optimizeBookmark();this.trim(e,q);var g=this.startContainer,m=g[0].childNodes[this.startOffset];m?k.insertBefore(c[0]||c,m):g[0].appendChild(c[0]||c);k._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var g=a(this.document,c.start,c.normalized),m=c.startOffset,
y=c.end&&a(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(g,m);y?this.setEnd(y,c):this.collapse(q)}else{g=(m=c.serializable)?l.one("#"+c.startNode,this.document):c.startNode;c=m?l.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(g);g._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(q)}},getCommonAncestor:function(c,g){var m=this.startContainer,y=this.endContainer;m=k._4e_equals(m,y)?c&&m[0].nodeType==f.NODE_ELEMENT&&this.startOffset==this.endOffset-
1?new s(m[0].childNodes[this.startOffset]):m:m._4e_commonAncestor(y);return g&&m[0].nodeType==f.NODE_TEXT?m.parent():m},enlarge:function(c){switch(c){case t.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var g=new s(this.document.body),m,y,p,D,Q,N=e,O,P;O=this.startContainer;P=this.startOffset;if(O[0].nodeType==f.NODE_TEXT){if(P){O=!l.trim(O[0].nodeValue.substring(0,P)).length&&O;N=!!O}if(O)if(!(D=O[0].previousSibling))p=O.parent()}else{if(P)D=O[0].childNodes[P-1]||O[0].lastChild;
D||(p=O)}for(;p||D;){if(p&&!D){if(!Q&&k._4e_equals(p,c))Q=q;if(!g._4e_contains(p))break;if(!N||p.css("display")!="inline"){N=e;if(Q)m=p;else this.setStartBefore(p)}D=p[0].previousSibling}for(;D;){O=e;if(D.nodeType==f.NODE_TEXT){P=D.nodeValue;if(/[^\s\ufeff]/.test(P))D=h;O=/[\s\ufeff]$/.test(P)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(N&&d.$removeEmpty[D.nodeName.toLowerCase()]){P=k.text(D);if(/[^\s\ufeff]/.test(P))D=h;else for(var T=D.all||D.getElementsByTagName("*"),S=0,A;A=T[S++];)if(!d.$removeEmpty[A.nodeName.toLowerCase()]){D=
h;break}if(D)O=!!P.length}else D=h;if(O)if(N)if(Q)m=p;else p&&this.setStartBefore(p);else N=q;if(D){O=D.previousSibling;if(!p&&!O){p=new s(D);D=h;break}D=O}else p=h}if(p)p=p.parent()}O=this.endContainer;P=this.endOffset;p=D=h;Q=N=e;if(O[0].nodeType==f.NODE_TEXT){O=!l.trim(O[0].nodeValue.substring(P)).length&&O;N=!(O&&O[0].nodeValue.length);if(O)if(!(D=O[0].nextSibling))p=O.parent()}else(D=O[0].childNodes[P])||(p=O);for(;p||D;){if(p&&!D){if(!Q&&k._4e_equals(p,c))Q=q;if(!g._4e_contains(p))break;if(!N||
p.css("display")!="inline"){N=e;if(Q)y=p;else p&&this.setEndAfter(p)}D=p[0].nextSibling}for(;D;){O=e;if(D.nodeType==f.NODE_TEXT){P=D.nodeValue;if(/[^\s\ufeff]/.test(P))D=h;O=/^[\s\ufeff]/.test(P)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(N&&d.$removeEmpty[D.nodeName.toLowerCase()]){P=k.text(D);if(/[^\s\ufeff]/.test(P))D=h;else{T=D.all||D.getElementsByTagName("*");for(S=0;A=T[S++];)if(!d.$removeEmpty[A.nodeName.toLowerCase()]){D=h;break}}if(D)O=!!P.length}else D=h;if(O)if(N)if(Q)y=
p;else this.setEndAfter(p);if(D){O=D.nextSibling;if(!p&&!O){p=new s(D);D=h;break}D=O}else p=h}if(p)p=p.parent()}if(m&&y){c=m._4e_contains(y)?y:m;this.setStartBefore(c);this.setEndAfter(c)}break;case t.ENLARGE_BLOCK_CONTENTS:case t.ENLARGE_LIST_ITEM_CONTENTS:p=new E(this.document);g=new s(this.document.body);p.setStartAt(g,t.POSITION_AFTER_START);p.setEnd(this.startContainer,this.startOffset);p=new n(p);var K,G,I=n.blockBoundary(c==t.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:h),J=function(M){var L=I(M);L||
(K=M);return L};m=function(M){var L=J(M);if(!L&&M[0]&&M._4e_name()=="br")G=M;return L};p.guard=J;p=p.lastBackward();K=K||g;this.setStartAt(K,K._4e_name()!="br"&&(!p&&this.checkStartOfBlock()||p&&K._4e_contains(p))?t.POSITION_AFTER_START:t.POSITION_AFTER_END);p=this.clone();p.collapse();p.setEndAt(g,t.POSITION_BEFORE_END);p=new n(p);p.guard=c==t.ENLARGE_LIST_ITEM_CONTENTS?m:J;K=h;p=p.lastForward();K=K||g;this.setEndAt(K,!p&&this.checkEndOfBlock()||p&&K._4e_contains(p)?t.POSITION_BEFORE_END:t.POSITION_BEFORE_START);
G&&this.setEndAfter(G)}},checkStartOfBlock:function(){var c=this.startContainer,g=this.startOffset;if(g&&c[0].nodeType==f.NODE_TEXT)if(l.trim(c[0].nodeValue.substring(0,g)).length)return e;this.trim();c=new o(this.startContainer);g=this.clone();g.collapse(q);g.setStartAt(c.block||c.blockLimit,t.POSITION_AFTER_START);c=new n(g);c.evaluator=z(q);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,g=this.endOffset;if(c[0].nodeType==f.NODE_TEXT)if(l.trim(c[0].nodeValue.substring(g)).length)return e;
this.trim();c=new o(this.endContainer);g=this.clone();g.collapse(e);g.setEndAt(c.block||c.blockLimit,t.POSITION_BEFORE_END);c=new n(g);c.evaluator=z(e);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,g){var m=this.clone();m[g==t.START?"setStartAt":"setEndAt"](c,g==t.START?t.POSITION_AFTER_START:
t.POSITION_BEFORE_END);m=new n(m);m.evaluator=B;return m[g==t.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,g=this.endContainer,m=this.startOffset,y=this.endOffset,p;if(c[0].nodeType==f.NODE_ELEMENT){p=c[0].childNodes.length;if(p>m)c=new s(c[0].childNodes[m]);else if(p<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new s(c);c=c._4e_nextSourceNode()||c}}if(g[0].nodeType==f.NODE_ELEMENT){p=g[0].childNodes.length;if(p>y)g=
(new s(g[0].childNodes[y]))._4e_previousSourceNode(q);else if(p<1)g=g._4e_previousSourceNode();else{for(g=g[0];g.lastChild;)g=g.lastChild;g=new s(g)}}if(c._4e_position(g)&u.POSITION_FOLLOWING)c=g;return{startNode:c,endNode:g}},fixBlock:function(c,g){var m=this.createBookmark(),y=new s(this.document.createElement(g));this.collapse(c);this.enlarge(t.ENLARGE_BLOCK_CONTENTS);y[0].appendChild(this.extractContents());y._4e_trim();b.ie||y._4e_appendBogus();this.insertNode(y);this.moveToBookmark(m);return y},
splitBlock:function(c){var g=new o(this.startContainer),m=new o(this.endContainer),y=g.block,p=m.block,D=h;if(!g.blockLimit._4e_equals(m.blockLimit))return h;if(c!="br"){if(!y){y=this.fixBlock(q,c);p=(new o(this.endContainer)).block}p||(p=this.fixBlock(e,c))}c=y&&this.checkStartOfBlock();g=p&&this.checkEndOfBlock();this.deleteContents();if(y&&k._4e_equals(y,p))if(g){D=new o(this.startContainer);this.moveToPosition(p,t.POSITION_AFTER_END);p=h}else if(c){D=new o(this.startContainer);this.moveToPosition(y,
t.POSITION_BEFORE_START);y=h}else{p=this.splitElement(y);!b.ie&&!l.inArray(y._4e_name(),["ul","ol"])&&y._4e_appendBogus()}return{previousBlock:y,nextBlock:p,wasStartOfBlock:c,wasEndOfBlock:g,elementPath:D}},splitElement:function(c){if(!this.collapsed)return h;this.setEndAt(c,t.POSITION_BEFORE_END);var g=this.extractContents(),m=c._4e_clone(e);m[0].appendChild(g);m.insertAfter(c);this.moveToPosition(c,t.POSITION_AFTER_END);return m},moveToElementEditablePosition:function(c,g){var m,y=r.XHTML_DTD;if(y.$empty[c._4e_name()])return e;
for(;c&&c[0].nodeType==f.NODE_ELEMENT;){if(m=c._4e_isEditable())this.moveToPosition(c,g?t.POSITION_BEFORE_END:t.POSITION_AFTER_START);else if(y.$inline[c._4e_name()]){this.moveToPosition(c,g?t.POSITION_AFTER_END:t.POSITION_BEFORE_START);return q}if((c=y.$empty[c._4e_name()]?c[g?"_4e_previous":"_4e_next"](H):c[g?"_4e_last":"_4e_first"](H))&&c[0].nodeType==f.NODE_TEXT){this.moveToPosition(c,g?t.POSITION_AFTER_END:t.POSITION_BEFORE_START);return q}}return m},selectNodeContents:function(c){this.setStart(c,
0);this.setEnd(c,c[0].nodeType==f.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var j={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},x=new n.whitespaces,F=new n.bookmark;r.Range=E;r.Range=E;var w=E.prototype;r.Utils.extern(w,{updateCollapsed:w.updateCollapsed,optimize:w.optimize,setStartAfter:w.setStartAfter,setEndAfter:w.setEndAfter,setStartBefore:w.setStartBefore,
setEndBefore:w.setEndBefore,optimizeBookmark:w.optimizeBookmark,setStart:w.setStart,setEnd:w.setEnd,setStartAt:w.setStartAt,setEndAt:w.setEndAt,execContentsAction:w.execContentsAction,collapse:w.collapse,clone:w.clone,getEnclosedNode:w.getEnclosedNode,shrink:w.shrink,getTouchedStartNode:w.getTouchedStartNode,createBookmark2:w.createBookmark2,createBookmark:w.createBookmark,moveToPosition:w.moveToPosition,trim:w.trim,insertNode:w.insertNode,moveToBookmark:w.moveToBookmark,getCommonAncestor:w.getCommonAncestor,
enlarge:w.enlarge,checkStartOfBlock:w.checkStartOfBlock,checkEndOfBlock:w.checkEndOfBlock,deleteContents:w.deleteContents,extractContents:w.extractContents,checkBoundaryOfElement:w.checkBoundaryOfElement,getBoundaryNodes:w.getBoundaryNodes,fixBlock:w.fixBlock,splitBlock:w.splitBlock,splitElement:w.splitElement,moveToElementEditablePosition:w.moveToElementEditablePosition,selectNodeContents:w.selectNodeContents})});
KISSY.Editor.add("domiterator",function(r){function E(n){if(!(arguments.length<1)){this.range=n;this.forceBrBreak=H;this.enlargeBr=B;this.enforceRealBlocks=H;this._||(this._={})}}var B=true,H=false,z=KISSY,C=z.UA,v=r.Walker,q=r.Range,e=r.RANGE,h=r.NODE,l=r.ElementPath,f=z.Node,t=z.DOM,u=/^[\r\n\t ]*$/;v.bookmark();z.augment(E,{getNextParagraph:function(n){var k,a,b,d,o;if(!this._.lastNode){a=this.range.clone();a.shrink(e.SHRINK_ELEMENT,B);a.enlarge(this.forceBrBreak||!this.enlargeBr?e.ENLARGE_LIST_ITEM_CONTENTS:
e.ENLARGE_BLOCK_CONTENTS);var s=new v(a),i=v.bookmark(B,B);s.evaluator=i;this._.nextNode=s.next();s=new v(a);s.evaluator=i;s=s.previous();this._.lastNode=s._4e_nextSourceNode(B);if(this._.lastNode&&this._.lastNode[0].nodeType==h.NODE_TEXT&&!z.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){i=new q(a.document);i.moveToPosition(this._.lastNode,e.POSITION_AFTER_END);if(i.checkEndOfBlock()){i=new l(i.endContainer);this._.lastNode=(i.block||i.blockLimit)._4e_nextSourceNode(B)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new f(a.document.createTextNode(""));t.insertAfter(this._.lastNode[0],s[0])}a=null}i=this._.nextNode;s=this._.lastNode;for(this._.nextNode=null;i;){var j=H,x=i[0].nodeType!=h.NODE_ELEMENT,F=H;if(x){if(i[0].nodeType==h.NODE_TEXT)if(u.test(i[0].nodeValue))x=H}else{var w=i._4e_name();if(i._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(w=="br")x=B;else if(!a&&!i[0].childNodes.length&&w!="hr"){k=i;b=i._4e_equals(s);break}if(a){a.setEndAt(i,e.POSITION_BEFORE_START);if(w!="br")this._.nextNode=
i}j=B}else{if(i[0].firstChild){if(!a){a=new q(this.range.document);a.setStartAt(i,e.POSITION_BEFORE_START)}i=new f(i[0].firstChild);continue}x=B}}if(x&&!a){a=new q(this.range.document);a.setStartAt(i,e.POSITION_BEFORE_START)}b=(!j||x)&&i._4e_equals(s);if(a&&!j)for(;!i[0].nextSibling&&!b;){w=i.parent();if(w._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){j=B;b||w._4e_equals(s);break}i=w;x=B;b=i._4e_equals(s);F=B}x&&a.setEndAt(i,e.POSITION_AFTER_END);i=i._4e_nextSourceNode(F,null,s);if((b=!i)||j&&a)break}if(!k){if(!a){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}k=new l(a.startContainer);i=k.blockLimit;j={div:1,th:1,td:1};k=k.block;if((!k||!k[0])&&!this.enforceRealBlocks&&j[i._4e_name()]&&a.checkStartOfBlock()&&a.checkEndOfBlock())k=i;else if(!k||this.enforceRealBlocks&&k._4e_name()=="li"){k=new f(this.range.document.createElement(n||"p"));k[0].appendChild(a.extractContents());k._4e_trim();a.insertNode(k);d=o=B}else if(k._4e_name()!="li"){if(!a.checkStartOfBlock()||!a.checkEndOfBlock()){k=k._4e_clone(H);
k[0].appendChild(a.extractContents());k._4e_trim();o=a.splitBlock();d=!o.wasStartOfBlock;o=!o.wasEndOfBlock;a.insertNode(k)}}else if(!b)this._.nextNode=k._4e_equals(s)?null:a.getBoundaryNodes().endNode._4e_nextSourceNode(B,null,s)}if(d){a=new f(k[0].previousSibling);if(a[0]&&a[0].nodeType==h.NODE_ELEMENT)if(a._4e_name()=="br")a._4e_remove();else a[0].lastChild&&t._4e_name(a[0].lastChild)=="br"&&t._4e_remove(a[0].lastChild)}if(o){a=v.bookmark(H,B);d=new f(k[0].lastChild);if(d[0]&&d[0].nodeType==h.NODE_ELEMENT&&
d._4e_name()=="br")if(C.ie||d._4e_previous(a)||d._4e_next(a))d._4e_remove()}if(!this._.nextNode)this._.nextNode=b||k._4e_equals(s)?null:k._4e_nextSourceNode(B,null,s);return k}});q.prototype.createIterator=function(){return new E(this)}});
KISSY.Editor.add("selection",function(r){function E(i){this.document=this.document=i;this._={cache:{}};if(e.ie){var j=this.getNative().createRange();if(!j||j.item&&j.item(0).ownerDocument!=i||j.parentElement&&j.parentElement().ownerDocument!=i)this.isInvalid=z}}function B(i){i=new E(i);return!i||i.isInvalid?v:i}function H(i){var j=i.document,x=new f(j.body),F=new f(j.documentElement);if(e.ie){if(e.ie<8||document.documentMode==7)F.on("click",function(N){h._4e_name(N.target)==="html"&&i.getSelection().getRanges()[0].select()});
var w,c,g=1;F.on("mousedown",function(){g=0});F.on("mouseup",function(){g=1});x.on("focusin",function(N){if(h._4e_name(N.target)=="body")if(w){try{g&&w.select()}catch(O){}w=v}});x.on("focus",function(){c=z;y()});x.on("beforedeactivate",function(N){if(!N.relatedTarget){c=C;g=1}});l.on(h._4e_getWin(j),"blur",function(){j&&j.selection.empty()});x.on("mousedown",function(){m()});x.on("mouseup",function(){c=z;setTimeout(function(){y(z)},0)});var m=function(){c=C},y=function(N){if(c){var O=i.document,P=
i.getSelection(),T=P&&P.getType(),S=P&&P.getNative();if(N&&S&&T==t.SELECTION_NONE)if(!O.queryCommandEnabled("InsertImage")){setTimeout(function(){y(z)},50);return}var A;if(!(S&&T==t.SELECTION_TEXT&&(A=h._4e_name(S.createRange().parentElement()))&&A in{input:1,textarea:1})){w=S&&P.getRanges()[0];i._monitor()}}};x.on("keydown",m);x.on("keyup",function(){c=z;y()});l.on(j,"selectionchange",y)}else{l.on(j,"mouseup",i._monitor,i);l.on(j,"keyup",i._monitor,i)}var p={table:1,pre:1},D=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
Q=r.Walker.whitespaces(z);i.on("selectionChange",function(N){var O=N.path;N=(N=N.selection)&&N.getRanges()[0];var P=O.blockLimit;if(N)if(N.collapse&&!O.block&&P._4e_name()=="body"){O=N.fixBlock(z,"p");if(O._4e_outerHtml().match(D))if((P=O._4e_next(Q))&&P[0].nodeType==n.NODE_ELEMENT&&!p[P._4e_name()]){N.moveToElementEditablePosition(P);O._4e_remove()}else if((P=O._4e_previous(Q))&&P[0].nodeType==n.NODE_ELEMENT&&!p[P._4e_name()]){N.moveToElementEditablePosition(P,P._4e_outerHtml().match(D)?C:z);O._4e_remove()}N.select();
e.ie||i.notifySelectionChange()}})}r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var z=true,C=false,v=null,q=KISSY,e=q.UA,h=q.DOM,l=q.Event,f=q.Node,t=r.SELECTION,u=r.RANGE,n=r.NODE,k=r.Walker,a=r.Range,b={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};q.augment(E,{getNative:e.ie?function(){var i=this._.cache;return i.nativeSel||(i.nativeSel=this.document.selection)}:function(){var i=
this._.cache;return i.nativeSel||(i.nativeSel=h._4e_getWin(this.document).getSelection())},getType:e.ie?function(){var i=this._.cache;if(i.type)return i.type;var j=t.SELECTION_NONE;try{var x=this.getNative(),F=x.type;if(F=="Text")j=t.SELECTION_TEXT;if(F=="Control")j=t.SELECTION_ELEMENT;if(x.createRange().parentElement)j=t.SELECTION_TEXT}catch(w){}return i.type=j}:function(){var i=this._.cache;if(i.type)return i.type;var j=t.SELECTION_TEXT,x=this.getNative();if(x){if(x.rangeCount==1){x=x.getRangeAt(0);
var F=x.startContainer;if(F==x.endContainer&&F.nodeType==n.NODE_ELEMENT&&x.endOffset-x.startOffset===1&&b[F.childNodes[x.startOffset].nodeName.toLowerCase()])j=t.SELECTION_ELEMENT}}else j=t.SELECTION_NONE;return i.type=j},getRanges:e.ie?function(){var i=function(j,x){j=j.duplicate();j.collapse(x);for(var F=j.parentElement(),w=F.childNodes,c,g=0;g<w.length;g++){var m=w[g];if(m.nodeType==n.NODE_ELEMENT){c=j.duplicate();c.moveToElementText(m);m=c.compareEndPoints("StartToStart",j);var y=c.compareEndPoints("EndToStart",
j);c.collapse();if(m>0)break;else if(!m||y==1&&m==-1)return{container:F,offset:g};else if(!y)return{container:F,offset:g+1};c=v}}if(!c){c=j.duplicate();c.moveToElementText(F);c.collapse(C)}c.setEndPoint("StartToStart",j);c=c.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;c>0;)c-=w[--g].nodeValue.length}catch(p){c=0}return c===0?{container:F,offset:g}:{container:w[g],offset:-c}};return function(){var j=this._.cache;if(j.ranges)return j.ranges;var x=this.getNative(),F=x&&x.createRange(),w=this.getType();
if(!x)return[];if(w==t.SELECTION_TEXT){x=new a(this.document);w=i(F,z);x.setStart(new f(w.container),w.offset);w=i(F);x.setEnd(new f(w.container),w.offset);return j.ranges=[x]}else if(w==t.SELECTION_ELEMENT){j=j.ranges=[];for(w=0;w<F.length;w++){var c=F.item(w),g=c.parentNode,m=0;for(x=new a(this.document);m<g.childNodes.length&&g.childNodes[m]!=c;m++);x.setStart(new f(g),m);x.setEnd(new f(g),m+1);j.push(x)}return j}return j.ranges=[]}}():function(){var i=this._.cache;if(i.ranges)return i.ranges;
var j=[],x=this.getNative();if(!x)return[];for(var F=0;F<x.rangeCount;F++){var w=x.getRangeAt(F),c=new a(this.document);c.setStart(new f(w.startContainer),w.startOffset);c.setEnd(new f(w.endContainer),w.endOffset);j.push(c)}return i.ranges=j},getStartElement:function(){var i=this._.cache;if(i.startElement!==undefined)return i.startElement;var j,x=this.getNative();switch(this.getType()){case t.SELECTION_ELEMENT:return this.getSelectedElement();case t.SELECTION_TEXT:var F=this.getRanges()[0];if(F)if(!F.collapsed){for(F.optimize();z;){j=
F.startContainer;if(F.startOffset==(j[0].nodeType===n.NODE_ELEMENT?j[0].childNodes.length:j[0].nodeValue.length)&&!j._4e_isBlockBoundary())F.setStartAfter(j);else break}j=F.startContainer;if(j[0].nodeType!=n.NODE_ELEMENT)return j.parent();j=new f(j[0].childNodes[F.startOffset]);if(!j[0]||j[0].nodeType!=n.NODE_ELEMENT)return F.startContainer;for(F=j[0].firstChild;F&&F.nodeType==n.NODE_ELEMENT;){j=new f(F);F=F.firstChild}return j}if(e.ie){F=x.createRange();F.collapse(z);j=F.parentElement()}else if((j=
x.anchorNode)&&j.nodeType!=n.NODE_ELEMENT)j=j.parentNode}return i.startElement=j?h._4e_wrap(j):v},getSelectedElement:function(){var i=this,j,x=i._.cache;if(x.selectedElement!==undefined)return x.selectedElement;if(e.ie){j=i.getNative().createRange();j=j.item&&j.item(0)}j||(j=function(){for(var F=i.getRanges()[0],w,c,g=2;g&&!((w=F.getEnclosedNode())&&w[0].nodeType==n.NODE_ELEMENT&&b[w._4e_name()]&&(c=w));g--)F.shrink(u.SHRINK_ELEMENT);return c&&c[0]}());return x.selectedElement=h._4e_wrap(j)},reset:function(){this._.cache=
{}},selectElement:function(i){var j;if(e.ie)try{j=this.document.body.createControlRange();j.addElement(i[0]);j.select()}catch(x){j=this.document.body.createTextRange();j.moveToElementText(i[0]);j.select()}finally{}else{j=this.document.createRange();j.selectNode(i[0]);i=this.getNative();i.removeAllRanges();i.addRange(j)}this.reset()},selectRanges:function(i){if(e.ie){if(i.length>1){var j=i[i.length-1];i[0].setEnd(j.endContainer,j.endOffset);i.length=1}i[0]&&i[0].select()}else{j=this.getNative();if(!j)return;
j.removeAllRanges();for(var x=0;x<i.length;x++){var F=i[x],w=this.document.createRange(),c=F.startContainer;F.collapsed&&e.gecko&&e.gecko<1.09&&c[0].nodeType==n.NODE_ELEMENT&&!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));w.setStart(c[0],F.startOffset);w.setEnd(F.endContainer[0],F.endOffset);j.addRange(w)}}this.reset()},createBookmarks2:function(i){for(var j=[],x=this.getRanges(),F=0;F<x.length;F++)j.push(x[F].createBookmark2(i));return j},createBookmarks:function(i,j){var x=
[],F=this.document,w;j=j||this.getRanges();for(var c=j.length,g=0;g<c;g++){x.push(w=j[g].createBookmark(i,z));var m=(i=w.serializable)?q.one("#"+w.startNode,F):w.startNode;w=i?q.one("#"+w.endNode,F):w.endNode;for(var y=g+1;y<c;y++){var p=j[y],D=p.startContainer,Q=p.endContainer;h._4e_equals(D,m.parent())&&p.startOffset++;h._4e_equals(D,w.parent())&&p.startOffset++;h._4e_equals(Q,m.parent())&&p.endOffset++;h._4e_equals(Q,w.parent())&&p.endOffset++}}return x},selectBookmarks:function(i){for(var j=[],
x=0;x<i.length;x++){var F=new a(this.document);F.moveToBookmark(i[x]);j.push(F)}this.selectRanges(j);return this},getCommonAncestor:function(){var i=this.getRanges();return i[0].startContainer._4e_commonAncestor(i[i.length-1].endContainer)},scrollIntoView:function(){var i=this.getStartElement();i&&i._4e_scrollIntoView()},removeAllRanges:function(){var i=this.getNative();if(e.ie)i&&i.clear();else i&&i.removeAllRanges()}});var d={table:1,tbody:1,tr:1},o=k.whitespaces(z),s=/\ufeff|\u00a0/;a.prototype.select=
a.prototype.select=e.ie?function(i){var j=this.collapsed,x,F;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var w=this.startContainer[0].childNodes[this.startOffset];if(w.nodeType==n.NODE_ELEMENT){(new E(this.document)).selectElement(new f(w));return}}if(this.startContainer[0].nodeType==n.NODE_ELEMENT&&this.startContainer._4e_name()in d||this.endContainer[0].nodeType==n.NODE_ELEMENT&&this.endContainer._4e_name()in d)this.shrink(u.SHRINK_ELEMENT,z);var c=this.createBookmark();
w=c.startNode;var g;if(!j)g=c.endNode;c=this.document.body.createTextRange();c.moveToElementText(w[0]);c.moveStart("character",1);if(g){i=this.document.body.createTextRange();i.moveToElementText(g[0]);c.setEndPoint("EndToEnd",i);c.moveEnd("character",-1)}else{for(x=w[0].nextSibling;x&&!o(x);)x=x.nextSibling;x=!(x&&x.nodeValue&&x.nodeValue.match(s))&&(i||!w[0].previousSibling||w[0].previousSibling&&h._4e_name(w[0].previousSibling)=="br");F=this.document.createElement("span");F.innerHTML="&#65279;";
F=new f(F);h.insertBefore(F[0],w[0]);x&&h.insertBefore(this.document.createTextNode("\ufeff"),w[0])}this.setStartBefore(w);w._4e_remove();if(j){if(x){c.moveStart("character",-1);c.select();this.document.selection.clear()}else c.select();if(F){this.moveToPosition(F,u.POSITION_BEFORE_START);F._4e_remove()}}else{this.setEndBefore(g);g._4e_remove();c.select()}}:function(){var i=this.startContainer;this.collapsed&&i[0].nodeType==n.NODE_ELEMENT&&!i[0].childNodes.length&&i[0].appendChild(this.document.createTextNode(""));
var j=this.document.createRange();j.setStart(i[0],this.startOffset);try{j.setEnd(this.endContainer[0],this.endOffset)}catch(x){if(x.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(z);j.setEnd(this.endContainer[0],this.endOffset)}else throw x;}i=B(this.document).getNative();i.removeAllRanges();i.addRange(j)};E.getSelection=B;r.Selection=E;r.Selection=E;k=E.prototype;r.Utils.extern(k,{getNative:k.getNative,getType:k.getType,getRanges:k.getRanges,getStartElement:k.getStartElement,getSelectedElement:k.getSelectedElement,
reset:k.reset,selectElement:k.selectElement,selectRanges:k.selectRanges,createBookmarks2:k.createBookmarks2,createBookmarks:k.createBookmarks,getCommonAncestor:k.getCommonAncestor,scrollIntoView:k.scrollIntoView,selectBookmarks:k.selectBookmarks,removeAllRanges:k.removeAllRanges});r.on("instanceCreated",function(i){H(i.editor)})});
KISSY.Editor.add("styles",function(r){function E(A,K){for(var G in A)A[G]=A[G].replace(T,function(I,J){return K[J]})}function B(A,K){if(K){A=j.clone(A);E(A.attributes,K);E(A.styles,K)}var G=this.element=this.element=(A.element||"*").toLowerCase();this.type=this.type=G=="#"||N[G]?F.STYLE_BLOCK:O[G]?F.STYLE_OBJECT:F.STYLE_INLINE;this._={definition:A}}function H(A,K){var G=K?this.removeFromRange:this.applyToRange;A.body.focus();for(var I=new c(A),J=I.getRanges(),M=0;M<J.length;M++)G.call(this,J[M]);
I.selectRanges(J)}function z(A,K){var G;G=A.element;if(G=="*")G="span";G=new p(K.createElement(G));return C(G,A)}function C(A,K){var G=K._.definition,I=G.attributes;G=B.getStyleText(G);if(I)for(var J in I)A.attr(J,I[J]);if(G)A[0].style.cssText=G;return A}function v(A){var K=A.createBookmark(o),G=A.createIterator();G.enforceRealBlocks=o;G.enlargeBr=o;for(var I,J=A.document;I=G.getNextParagraph();){var M=z(this,J);I=I;var L=M;M=L._4e_name=="pre";var R=I._4e_name=="pre",X=!M&&R;if(M&&!R){R=I;L=L;X=R.html();
X=q(X,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");X=X.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");X=X.replace(/([ \t\n\r]+|&nbsp;)/g," ");X=X.replace(/<br\b[^>]*>/gi,"\n");if(D.ie){R=R[0].ownerDocument.createElement("div");R.appendChild(L[0]);L[0].outerHTML="<pre>"+X+"</pre>";L=new p(R.firstChild);L._4e_remove()}else L.html(X);L=L}else if(X)L=h(e(I),L);else I._4e_moveChildren(L);I[0].parentNode.replaceChild(L[0],I[0]);if(M){I=L;M=void 0;if((M=I._4e_previousSourceNode(o,g.NODE_ELEMENT))&&M._4e_name()==
"pre"){L=q(M.html(),/\n$/,"")+"\n\n"+q(I.html(),/^\n/,"");if(D.ie)I[0].outerHTML="<pre>"+L+"</pre>";else I.html(L);M._4e_remove()}}}A.moveToBookmark(K)}function q(A,K,G){var I="",J="";A=A.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(M,L,R){L&&(I=L);R&&(J=R);return""});return I+A.replace(K,G)+J}function e(A){var K=[];q(A._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(G,I,J){return I+"</pre>"+J+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(G,I){K.push(I)});return K}function h(A,K){for(var G=K[0].ownerDocument.createDocumentFragment(),I=0;I<A.length;I++){var J=A[I];J=J.replace(/(\r\n|\r)/g,"\n");J=q(J,/^[ \t]*\n/,"");J=q(J,/\n$/,"");J=q(J,/^[ \t]+|[ \t]+$/g,function(L,R){return L.length==1?"&nbsp;":R?" "+Array(L.length).join("&nbsp;"):Array(L.length).join("&nbsp;")+" "});J=J.replace(/\n/g,"<br>");J=J.replace(/[ \t]{2,}/g,function(L){return Array(L.length).join("&nbsp;")+" "});var M=K._4e_clone();M.html(J);G.appendChild(M[0])}return G}
function l(A){var K=A.document;if(A.collapsed){K=z(this,K);A.insertNode(K);A.moveToPosition(K,w.POSITION_BEFORE_END)}else{var G=this.element,I=this._.definition,J,M=r.XHTML_DTD[G]||(J=o,r.XHTML_DTD.span),L=A.createBookmark();A.enlarge(w.ENLARGE_ELEMENT);A.trim();var R=A.createBookmark(),X=R.startNode;R=R.endNode;for(var W=X,Z;W&&W[0];){var U=s;if(x._4e_equals(W,R)){W=i;U=o}else{var V=W[0].nodeType,ba=V==g.NODE_ELEMENT?W._4e_name():i;if(ba&&W.attr("_ke_bookmark")){W=W._4e_nextSourceNode(o);continue}if(!ba||
M[ba]&&(W._4e_position(R)|m.POSITION_PRECEDING|m.POSITION_IDENTICAL|m.POSITION_IS_CONTAINED)==m.POSITION_PRECEDING+m.POSITION_IDENTICAL+m.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(W))){var Y=W.parent();if(Y&&Y[0]&&((r.XHTML_DTD[Y._4e_name()]||r.XHTML_DTD.span)[G]||J)&&(!I.parentRule||I.parentRule(Y))){if(!Z&&(!ba||!r.XHTML_DTD.$removeEmpty[ba]||(W._4e_position(R)|m.POSITION_PRECEDING|m.POSITION_IDENTICAL|m.POSITION_IS_CONTAINED)==m.POSITION_PRECEDING+m.POSITION_IDENTICAL+m.POSITION_IS_CONTAINED)){Z=
new y(K);Z.setStartBefore(W)}if(V==g.NODE_TEXT||V==g.NODE_ELEMENT&&!W[0].childNodes.length){V=W;for(var $;!V[0].nextSibling&&($=V.parent(),M[$._4e_name()])&&($._4e_position(X)|m.POSITION_FOLLOWING|m.POSITION_IDENTICAL|m.POSITION_IS_CONTAINED)==m.POSITION_FOLLOWING+m.POSITION_IDENTICAL+m.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule($));)V=$;Z.setEndAfter(V);V[0].nextSibling||(U=o)}}else U=o}else U=o;W=W._4e_nextSourceNode()}if(U&&Z&&!Z.collapsed){U=z(this,K);for(V=Z.getCommonAncestor();U&&V&&
U[0]&&V[0];){if(V._4e_name()==G){for(var aa in I.attributes)U.attr(aa)==V.attr(aa)&&U[0].removeAttribute(aa);for(var ea in I.styles)U._4e_style(ea)==V._4e_style(ea)&&U._4e_style(ea,"");if(!U._4e_hasAttributes()){U=i;break}}V=V.parent()}if(U){U[0].appendChild(Z.extractContents());V=U;ba=n(this);Y=V.all(this.element);for(var ca=Y.length;--ca>=0;)k(this,new p(Y[ca]));var da=void 0;for(da in ba)if(da!=this.element){Y=V.all(da);for(ca=Y.length-1;ca>=0;ca--){var fa=new p(Y[ca]);b(fa,ba[da])}}Z.insertNode(U);
U._4e_mergeSiblings();D.ie||U[0].normalize()}Z=i}}X._4e_remove();R._4e_remove();A.moveToBookmark(L);A.shrink(w.SHRINK_TEXT)}}function f(A){A.enlarge(w.ENLARGE_ELEMENT);var K=A.createBookmark(),G=K.startNode;if(A.collapsed){for(var I=new Q(G.parent()),J,M=0,L;M<I.elements.length&&(L=I.elements[M]);M++){if(L==I.block||L==I.blockLimit)break;if(this.checkElementRemovable(L)){var R=A.checkBoundaryOfElement(L,w.END),X=!R&&A.checkBoundaryOfElement(L,w.START);if(X||R){J=L;J.match=X?"start":"end"}else{L._4e_mergeSiblings();
L._4e_name()==this.element?k(this,L):b(L,n(this)[L._4e_name()])}}}if(J&&J[0]){L=G;for(M=0;;M++){R=I.elements[M];if(x._4e_equals(R,J))break;else if(R.match)continue;else R=R._4e_clone();R[0].appendChild(L[0]);L=R}x[J.match=="start"?"insertBefore":"insertAfter"](L[0],J[0])}}else{var W=K.endNode,Z=this;I=function(){for(var U=new Q(G.parent()),V=new Q(W.parent()),ba=i,Y=i,$=0;$<U.elements.length;$++){var aa=U.elements[$];if(aa==U.block||aa==U.blockLimit)break;if(Z.checkElementRemovable(aa))ba=aa}for($=
0;$<V.elements.length;$++){aa=V.elements[$];if(aa==V.block||aa==V.blockLimit)break;if(Z.checkElementRemovable(aa))Y=aa}Y&&W._4e_breakParent(Y);ba&&G._4e_breakParent(ba)};I();for(J=new p(G[0].nextSibling);J[0]!==W[0];){M=J._4e_nextSourceNode();if(J[0]&&J[0].nodeType==g.NODE_ELEMENT&&this.checkElementRemovable(J)){J._4e_name()==this.element?k(this,J):b(J,n(this)[J._4e_name()]);if(M[0].nodeType==g.NODE_ELEMENT&&M._4e_contains(G)){I();M=new p(G[0].nextSibling)}}J=M}}A.moveToBookmark(K)}function t(A){var K=
{};A.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(G,I,J){K[I]=J});return K}function u(A,K){var G;if(K!==s){G=document.createElement("span");G.style.cssText=A;G=G.style.cssText||""}else G=A;return G.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function n(A){if(A._.overrides)return A._.overrides;var K=A._.overrides={},G=A._.definition.overrides;if(G){j.isArray(G)||(G=[G]);for(var I=0;I<G.length;I++){var J=G[I],M,L;if(typeof J==
"string")M=J.toLowerCase();else{M=J.element?J.element.toLowerCase():A.element;L=J.attributes}J=K[M]||(K[M]={});if(L){J=J.attributes=J.attributes||[];for(var R in L)J.push([R.toLowerCase(),L[R]])}}}return K}function k(A,K){var G=A._.definition,I=j.mix(j.mix({},G.attributes),n(A)[K._4e_name()]);G=G.styles;var J=j.isEmptyObject(I)&&j.isEmptyObject(G),M;for(M in I)if(!((M=="class"||A._.definition.fullMatch)&&K.attr(M)!=a(M,I[M]))){J=J||!!K._4e_hasAttribute(M);K.removeAttr(M)}for(var L in G)if(!(A._.definition.fullMatch&&
K._4e_style(L)!=a(L,G[L],o))){J=J||!!K._4e_style(L);K._4e_style(L,"")}J&&d(K)}function a(A,K,G){var I=new p("<span>");I[G?"_4e_style":"attr"](A,K);return I[G?"_4e_style":"attr"](A)}function b(A,K){var G=K&&K.attributes;if(G)for(var I=0;I<G.length;I++){var J=G[I][0],M;if(M=A.attr(J)){var L=G[I][1];if(L===i||L.test&&L.test(M)||typeof L=="string"&&M==L)A[0].removeAttribute(J)}}d(A)}function d(A){if(!A._4e_hasAttributes()){var K=A[0].firstChild,G=A[0].lastChild;A._4e_remove(o);if(K){K.nodeType==g.NODE_ELEMENT&&
x._4e_mergeSiblings(K);G&&!K===G&&G.nodeType==g.NODE_ELEMENT&&x._4e_mergeSiblings(G)}}}var o=true,s=false,i=null,j=KISSY,x=j.DOM,F={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},w=r.RANGE,c=r.Selection,g=r.NODE,m=r.POSITION,y=r.Range,p=j.Node,D=j.UA,Q=r.ElementPath,N={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},O={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/,T=/#\((.+?)\)/g;r.STYLE=F;B.prototype={apply:function(A){H.call(this,
A,s)},remove:function(A){H.call(this,A,o)},applyToRange:function(A){return(this.applyToRange=this.type==F.STYLE_INLINE?l:this.type==F.STYLE_BLOCK?v:this.type==F.STYLE_OBJECT?i:i).call(this,A)},removeFromRange:function(A){return(this.removeFromRange=this.type==F.STYLE_INLINE?f:i).call(this,A)},applyToObject:function(A){C(A,this)},checkElementRemovable:function(A,K){if(!A)return s;var G=this._.definition;if(A._4e_name()==this.element){if(!K&&!A._4e_hasAttributes())return o;var I=G._AC;if(I)G=I;else{I=
{};var J=0,M=G.attributes;if(M)for(var L in M){J++;I[L]=M[L]}if(M=B.getStyleText(G)){I.style||J++;I.style=M}I._length=J;G=G._AC=I}if(G._length){for(var R in G)if(R!="_length"){J=A.attr(R)||"";if(R=="style")a:{I=G[R];J=u(J,s);typeof I=="string"&&(I=t(I));typeof J=="string"&&(J=t(J));M=void 0;for(M in I)if(!(M in J&&(J[M]==I[M]||I[M]=="inherit"||J[M]=="inherit"))){I=s;break a}I=o}else I=G[R]==J;if(I){if(!K)return o}else if(K)return s}if(K)return o}else return o}if(R=n(this)[A._4e_name()]){if(!(G=R.attributes))return o;
for(I=0;I<G.length;I++){R=G[I][0];if(R=A.attr(R)){J=G[I][1];if(J===i||typeof J=="string"&&R==J||J.test&&J.test(R))return o}}}return s},checkActive:function(A){switch(this.type){case F.STYLE_BLOCK:return this.checkElementRemovable(A.block||A.blockLimit,o);case F.STYLE_OBJECT:case F.STYLE_INLINE:for(var K=A.elements,G=0,I;G<K.length;G++){I=K[G];if(!(this.type==F.STYLE_INLINE&&(x._4e_equals(I,A.block)||x._4e_equals(I,A.blockLimit))))if(!(this.type==F.STYLE_OBJECT&&!(I._4e_name()in O)))if(this.checkElementRemovable(I,
o))return o}}return s}};B.getStyleText=function(A){var K=A._ST;if(K)return K;K=A.styles;var G=A.attributes&&A.attributes.style||"",I="";if(G.length)G=G.replace(P,";");for(var J in K){var M=K[J],L=(J+":"+M).replace(P,";");if(M=="inherit")I+=L;else G+=L}if(G.length)G=u(G);G+=I;return A._ST=G};r.Style=B;r.Style=B;var S=B.prototype;r.Utils.extern(S,{apply:S.apply,remove:S.remove,applyToRange:S.applyToRange,removeFromRange:S.removeFromRange,applyToObject:S.applyToObject,checkElementRemovable:S.checkElementRemovable,
checkActive:S.checkActive})});
KISSY.Editor.add("htmlparser",function(){function r(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var E=KISSY,B=function(){},H=E.Editor,z=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,C={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},v=H.XHTML_DTD;E.augment(r,{onTagOpen:B,onTagClose:B,
onText:B,onCDATA:B,onComment:B,parse:function(q){for(var e,h,l=0,f;e=this._.htmlPartsRegex.exec(q);){h=e.index;if(h>l){l=q.substring(l,h);f?f.push(l):this.onText(l)}l=this._.htmlPartsRegex.lastIndex;if(h=e[1]){h=h.toLowerCase();if(f&&v.$cdata[h]){this.onCDATA(f.join(""));f=null}if(!f){this.onTagClose(h);continue}}if(f)f.push(e[0]);else if(h=e[3]){h=h.toLowerCase();if(!/="/.test(h)){var t={},u;e=e[4];var n=!!(e&&e.charAt(e.length-1)=="/");if(e)for(;u=z.exec(e);){var k=u[1].toLowerCase();u=u[2]||u[3]||
u[4]||"";t[k]=!u&&C[k]?k:u}this.onTagOpen(h,t,n);if(!f&&v.$cdata[h])f=[]}}else if(h=e[2])this.onComment(h)}q.length>l&&this.onText(q.substring(l,q.length))}});H.HtmlParser=r;H.HtmlParser=r});
KISSY.Editor.add("htmlparser-basicwriter",function(){function r(){this._={output:[]}}var E=KISSY,B=E.Editor,H=B.Utils;E.augment(r,{openTag:function(z){this._.output.push("<",z)},openTagClose:function(z,C){C?this._.output.push(" />"):this._.output.push(">")},attribute:function(z,C){if(typeof C=="string")C=H.htmlEncodeAttr(C);this._.output.push(" ",z,'="',C,'"')},closeTag:function(z){this._.output.push("</",z,">")},text:function(z){this._.output.push(z)},comment:function(z){this._.output.push("<!--",
z,"--\>")},write:function(z){this._.output.push(z)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(z){var C=this._.output.join("");z&&this.reset();return C}});B.HtmlParser.BasicWriter=r;B.HtmlParser.BasicWriter=r;E=r.prototype;B.Utils.extern(E,{openTag:E.openTag,openTagClose:E.openTagClose,attribute:E.attribute,closeTag:E.closeTag,text:E.text,comment:E.comment,write:E.write,reset:E.reset,getHtml:E.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function r(){r.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=C;this.sortAttributes=z;this._.indent=C;this._.indentation="";this._.rules={};var v=B.XHTML_DTD,q;for(q in H.mix({},v.$nonBodyContent,v.$block,v.$listItem,v.$tableContent))this.setRules(q,{indent:z,breakBeforeOpen:z,breakAfterOpen:z,breakBeforeClose:!v[q]["#"],breakAfterClose:z});this.setRules("br",
{breakAfterOpen:z});this.setRules("title",{indent:C,breakAfterOpen:C});this.setRules("style",{indent:C,breakBeforeClose:z});this.setRules("pre",{indent:C})}var E=KISSY,B=E.Editor,H=B.Utils,z=true,C=false;E.extend(r,B.HtmlParser.BasicWriter,{openTag:function(v){var q=this._.rules[v];if(this._.indent)this.indentation();else if(q&&q.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",v)},openTagClose:function(v,q){var e=this._.rules[v];if(q)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(e&&e.indent)this._.indentation+=this.indentationChars}e&&e.breakAfterOpen&&this.lineBreak()},attribute:function(v,q){if(typeof q=="string"){this.forceSimpleAmpersand&&(q=q.replace(/&amp;/g,"&"));q=H.htmlEncodeAttr(q)}this._.output.push(" ",v,'="',q,'"')},closeTag:function(v){var q=this._.rules[v];if(q&&q.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(q&&q.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",v,">");q&&q.breakAfterClose&&this.lineBreak()},text:function(v){if(this._.indent){this.indentation();v=H.ltrim(v)}this._.output.push(v)},comment:function(v){this._.indent&&this.indentation();this._.output.push("<!--",v,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=z},indentation:function(){this._.output.push(this._.indentation);this._.indent=C},setRules:function(v,q){var e=this._.rules[v];if(e)H.mix(e,
q);else this._.rules[v]=q}});B.HtmlParser.HtmlWriter=r;B.HtmlParser.HtmlWriter=r;E=r.prototype;B.Utils.extern(E,{openTag:E.openTag,openTagClose:E.openTagClose,attribute:E.attribute,closeTag:E.closeTag,text:E.text,comment:E.comment,lineBreak:E.lineBreak,indentation:E.indentation,setRules:E.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function r(){this.children=[];this.parent=H;this._={isBlockLike:E,hasInlineStarted:B}}var E=true,B=false,H=null,z=KISSY.Editor,C={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},v=KISSY,q=z.Utils,e=z.NODE,h=z.XHTML_DTD,l=q.mix({table:1,ul:1,ol:1,dl:1},h.table,h.ul,h.ol,h.dl),f=h.$list,t=h.$listItem;r.FromHtml=function(u,n){function k(g){var m;if(s.length>0)for(var y=0;y<s.length;y++){var p=s[y],D=p.name,Q=h[D],N=j.name&&h[j.name];
if((!N||N[D])&&(!g||!Q||Q[g]||!h[g])){if(!m){a();m=1}p=p.clone();p.parent=j;j=p;s.splice(y,1);y--}}}function a(){for(;i.length;)j.add(i.shift())}function b(g,m,y){m=m||j||o;if(n&&!m.type){var p,D;if((p=g.attributes&&(D=g.attributes._ke_real_element_type)?D:g.name)&&!(p in h.$body)&&!(p in h.$nonBodyContent)){p=j;j=m;d.onTagOpen(n,{});m=j;if(y)j=p}}if(g._.isBlockLike&&g.name!="pre"){y=g.children.length;if((p=g.children[y-1])&&p.type==e.NODE_TEXT)if(D=q.rtrim(p.value))p.value=D;else g.children.length=
y-1}m.add(g);if(g.returnPoint){j=g.returnPoint;delete g.returnPoint}}var d=new z.HtmlParser,o=new r,s=[],i=[],j=o,x=B,F;d.onTagOpen=function(g,m,y){var p=new z.HtmlParser.Element(g,m);if(p.isUnknown&&y)p.isEmpty=E;if(h.$removeEmpty[g])s.push(p);else{if(g=="pre")x=E;else if(g=="br"&&x){j.add(new z.HtmlParser.Text("\n"));return}if(g=="br")i.push(p);else{var D=j.name,Q=D&&(h[D]||(j._.isBlockLike?h.div:h.span));if(Q&&!p.isUnknown&&!j.isUnknown&&!Q[g]){Q=B;var N;if(g in f&&D in f){D=j.children;(D=D[D.length-
1])&&D.name in t||b(D=new z.HtmlParser.Element("li"),j);F=j;N=D}else if(g==D)b(j,j.parent);else{if(l[D])F||(F=j);else{b(j,j.parent,E);C[D]||s.unshift(j)}Q=E}j=N?N:j.returnPoint||j.parent;if(Q){d.onTagOpen.apply(this,arguments);return}}k(g);a();p.parent=j;p.returnPoint=F;F=0;if(p.isEmpty)b(p);else j=p}}};d.onTagClose=function(g){for(var m=s.length-1;m>=0;m--)if(g==s[m].name){s.splice(m,1);return}for(var y=[],p=[],D=j;D.type&&D.name!=g;){D._.isBlockLike||p.unshift(D);y.push(D);D=D.parent}if(D.type){for(m=
0;m<y.length;m++){var Q=y[m];b(Q,Q.parent)}j=D;if(j.name=="pre")x=B;D._.isBlockLike&&a();b(D,D.parent);if(D==j)j=j.parent;s=s.concat(p)}if(g=="body")n=B};d.onText=function(g){if(!j._.hasInlineStarted&&!x){g=q.ltrim(g);if(g.length===0)return}a();k();if(n&&(!j.type||j.name=="body")&&q.trim(g))this.onTagOpen(n,{});x||(g=g.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));j.add(new z.HtmlParser.Text(g))};d.onCDATA=function(){};d.onComment=function(g){j.add(new z.HtmlParser.Comment(g))};d.parse(u);for(a();j.type;){var w=
j.parent,c=j;if(n&&(!w.type||w.name=="body")&&!h.$body[c.name]){j=w;d.onTagOpen(n,{});w=j}w.add(c);j=w}return o};v.augment(r,{add:function(u){var n=this.children.length;if(n=n>0&&this.children[n-1]||H){if(u._.isBlockLike&&n.type==e.NODE_TEXT){n.value=q.rtrim(n.value);if(n.value.length===0){this.children.pop();this.add(u);return}}n.next=u}u.previous=n;u.parent=this;this.children.push(u);this._.hasInlineStarted=u.type==e.NODE_TEXT||u.type==e.NODE_ELEMENT&&!u._.isBlockLike},writeHtml:function(u,n){var k;
this.filterChildren=this.filterChildren=function(){var a=new z.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,a,n,E);a=a.getHtml();this.children=(new r.FromHtml(a)).children;k=1};!this.name&&n&&n.onFragment(this);this.writeChildrenHtml(u,k?H:n)},writeChildrenHtml:function(u,n){for(var k=0;k<this.children.length;k++)this.children[k].writeHtml(u,n)}});z.HtmlParser.Fragment=r;z.HtmlParser.Fragment=r;r.FromHtml=r.FromHtml;v=r.prototype;z.Utils.extern(v,{add:v.add,writeHtml:v.writeHtml,writeChildrenHtml:v.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function r(C,v){this.name=C;this.attributes=v||(v={});this.children=[];var q=v._ke_real_element_type||C,e=E.XHTML_DTD;q=!!(e.$nonBodyContent[q]||e.$block[q]||e.$listItem[q]||e.$tableContent[q]||e.$nonEditable[q]||q=="br");var h=!!e.$empty[C];this.isEmpty=h;this.isUnknown=!e[C];this._={isBlockLike:q,hasInlineStarted:h||!q}}var E=KISSY.Editor,B=E.NODE,H=function(C,v){C=C[0];v=v[0];return C<v?-1:C>v?1:0};KISSY.augment(r,{type:B.NODE_ELEMENT,add:E.HtmlParser.Fragment.prototype.add,
clone:function(){return new r(this.name,this.attributes)},writeHtml:function(C,v){var q=this.attributes,e=this,h=e.name,l,f,t,u;e.filterChildren=function(){if(!u){var a=new E.HtmlParser.BasicWriter;E.HtmlParser.Fragment.prototype.writeChildrenHtml.call(e,a,v);e.children=(new E.HtmlParser.Fragment.FromHtml(a.getHtml())).children;u=1}};e.filterChildren=e.filterChildren;if(v){for(;;){if(!(h=v.onElementName(h)))return;e.name=h;if(!(e=v.onElement(e)))return;e.parent=this.parent;if(e.name==h)break;if(e.type!=
B.NODE_ELEMENT){e.writeHtml(C,v);return}h=e.name;if(!h){this.writeChildrenHtml.call(e,C,u?null:v);return}}q=e.attributes}C.openTag(h,q);for(var n=[],k=0;k<2;k++)for(l in q){f=l;t=q[l];if(k==1)n.push([l,t]);else if(v){for(;;)if(f=v.onAttributeName(l))if(f!=l){delete q[l];l=f}else break;else{delete q[l];break}if(f)if((t=v.onAttribute(e,f,t))===false)delete q[f];else q[f]=t}}C.sortAttributes&&n.sort(H);q=n.length;for(k=0;k<q;k++){l=n[k];C.attribute(l[0],l[1])}C.openTagClose(h,e.isEmpty);if(!e.isEmpty){this.writeChildrenHtml.call(e,
C,u?null:v);C.closeTag(h)}},writeChildrenHtml:function(){E.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});E.HtmlParser.Element=r;E.HtmlParser.Element=r;var z=r.prototype;E.Utils.extern(z,{type:z.type,add:z.add,clone:z.clone,writeHtml:z.writeHtml,writeChildrenHtml:z.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function r(l){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};l&&this.addRules(l,10)}function E(l,f){for(var t=0;l&&t<f.length;t++){var u=f[t];l=l.replace(u[0],u[1])}return l}function B(l,f,t){if(typeof f=="function")f=[f];var u,n;n=l.length;var k=f&&f.length;if(k){for(u=0;u<n&&l[u].pri<t;u++);for(n=k-1;n>=0;n--)if(k=f[n]){k.pri=t;l.splice(u,0,k)}}}function H(l,f,t){if(f)for(var u in f){var n=l[u];l[u]=z(n,f[u],
t);n||l.$length++}}function z(l,f,t){if(f){f.pri=t;if(l){if(l.splice)B(l,f,t);else{l=l.pri>t?[f,l]:[l,f];l.filter=C}return l}else return f.filter=f}}function C(l){for(var f=l.type||l instanceof q.HtmlParser.Fragment,t=0;t<this.length;t++){if(f)var u=l.type,n=l.name;var k=this[t].apply(window,arguments);if(k===h)return k;if(f){if(k&&(k.name!=n||k.type!=u))return k}else if(typeof k!="string")return k;k!=undefined&&(l=k)}return l}var v=KISSY,q=v.Editor,e=q.NODE,h=false;v.augment(r,{addRules:function(l,
f){if(typeof f!="number")f=10;B(this._.elementNames,l.elementNames,f);B(this._.attributeNames,l.attributeNames,f);H(this._.elements,l.elements,f);H(this._.attributes,l.attributes,f);this._.text=z(this._.text,l.text,f)||this._.text;this._.comment=z(this._.comment,l.comment,f)||this._.comment;this._.root=z(this._.root,l.root,f)||this._.root},onElementName:function(l){return E(l,this._.elementNames)},onAttributeName:function(l){return E(l,this._.attributeNames)},onText:function(l){var f=this._.text;
return f?f.filter(l):l},onComment:function(l,f){var t=this._.comment;return t?t.filter(l,f):l},onFragment:function(l){var f=this._.root;return f?f.filter(l):l},onElement:function(l){for(var f=[this._.elements["^"],this._.elements[l.name],this._.elements.$],t,u=0;u<3;u++)if(t=f[u]){t=t.filter(l,this);if(t===h)return null;if(t&&t!=l)return this.onNode(t);if(l.parent&&!l.name)break}return l},onNode:function(l){var f=l.type;return f==e.NODE_ELEMENT?this.onElement(l):f==e.NODE_TEXT?new q.HtmlParser.Text(this.onText(l.value)):
null},onAttribute:function(l,f,t){if(f=this._.attributes[f]){l=f.filter(t,l,this);if(l===h)return h;if(typeof l!="undefined")return l}return t}});q.HtmlParser.Filter=r;v=r.prototype;q.Utils.extern(v,{addRules:v.addRules,onElementName:v.onElementName,onAttributeName:v.onAttributeName,onText:v.onText,onComment:v.onComment,onFragment:v.onFragment,onElement:v.onElement,onNode:v.onNode,onAttribute:v.onAttribute});q.HtmlParser.Filter=r});
KISSY.Editor.add("htmlparser-text",function(){function r(z){this.value=z;this._={isBlockLike:H}}var E=KISSY,B=E.Editor,H=false;E.augment(r,{type:B.NODE.NODE_TEXT,writeHtml:function(z,C){var v=this.value;C&&!(v=C.onText(v,this))||z.text(v)}});B.HtmlParser.Text=r;B.HtmlParser.Text=r});
KISSY.Editor.add("htmlparser-comment",function(){function r(H){this.value=H;this._={isBlockLike:false}}var E=KISSY.Editor,B=E.NODE;E.HtmlParser.Comment=r;E.HtmlParser.Comment=r;r.prototype={constructor:r,type:B.NODE_COMMENT,writeHtml:function(H,z){var C=this.value;if(z){if(!(C=z.onComment(C,this)))return;if(typeof C!="string"){C.parent=this.parent;C.writeHtml(H,z);return}}H.comment(C)}}});
