/*
 Constructor for kissy editor and module dependency definition
 thanks to CKSource's intelligent work on CKEditor
 @author: yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.0
 @buildtime: 2010-11-10 13:03:14
*/
KISSY.add("editor",function(p,z){function C(k,a){function b(t){for(var l=C.Env.mods,i=0;i<t.length;i++){for(var D=t[i],G=A,s=0;s<i;s++)if(D==t[s]){G=u;break}s=l[D];if(G&&s){G=p.clone(s);D=D+"_"+i;G.name=D;t[i]=D;l[D]||(l[D]=G)}}}var d=this;if(!(d instanceof C))return new C(k,a);if(p.isString(k))k=p.one(k);k=x._4e_wrap(k);a=a||{};a.pluginConfig=a.pluginConfig||{};d.cfg=a;a.pluginConfig=a.pluginConfig;d.cfg=a;p.app(d,p.EventTarget);var m=["htmldataprocessor","enterkey","clipboard"],v=A;d.use=function(t,
l){t=t.split(",");b(t);if(!v)for(var i=0;i<m.length;i++){var D=m[i];p.inArray(D,t)||t.unshift(D)}p.use.call(d,t.join(","),function(){d.ready(function(){l&&l.call(d);if(!v){d.setData(k.val());if(a.focus)d.focus();else{var G=d.getSelection();G&&G.removeAllRanges()}d.fire("save");v=u}})},{order:u,global:C});return d};d.use=d.use;d.init(k);return d}function H(k){var a=p.Config.debug;k=a?a==="dev"?"../src/"+k:k:k.replace(/\.(js|css)/i,"-min.$1");k+=k.indexOf("?")!=-1?"&":"?";k+="t="+encodeURIComponent("2010-11-10 13:03:14");
return k}var x=p.DOM,u=true,A=false;p.app(C,p.EventTarget);C.Config.base=p.Config.base+"editor/";var w=["separator","sourcearea/support","tabs","flashbridge","flashutils","clipboard",{name:"colorsupport",requires:["overlay"]},{name:"colorsupport/dialog"},{name:"forecolor",requires:["colorsupport"]},{name:"bgcolor",requires:["colorsupport"]},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},
{name:"flash",requires:["flash/support"]},{name:"flash/dialog"},{name:"flash/support",requires:["flashutils","contextmenu","fakeobjects","bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor"},{name:"image",requires:["contextmenu","bubbleview"]},{name:"image/dialog",requires:["tabs"]},"indent","justify",{name:"link",requires:["bubbleview"]},{name:"link/dialog"},"list","maximize",{name:"music",requires:["flash/support"]},{name:"music/dialog",requires:["flash/dialog"]},
"preview","removeformat",{name:"smiley"},{name:"sourcearea",requires:["sourcearea/support"]},{name:"table",requires:["contextmenu"]},{name:"table/dialog"},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],n,f,g,e,j={};n=0;for(f=w.length;n<f;n++){g=w[n];if(p.isString(g))g=w[n]={name:g+"",requires:null};e=g.requires||[];var y=["button"];g.name.indexOf("/dialog")!=-1&&y.push("overlay");g.requires=e.concat(y)}w=[{name:"localStorage",requires:["flashutils","flashbridge"]},
{name:"button"},{name:"dd"},{name:"progressbar"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(w);n=0;for(f=w.length;n<f;n++){g=w[n];e=g.name;j[e]={attach:A,charset:"utf-8",requires:g.requires,csspath:g.useCss?H("plugins/"+e+"/plugin.css"):z,path:H("plugins/"+e+"/plugin.js")}}C.add(j);p.Editor=C;p.Editor=C});
KISSY.Editor.add("utils",function(p){var z=null,C=KISSY,H=C.Node,x=C.DOM,u=C.UA,A=C.Event,w;w=u.ie?document.documentMode||u.ie:void 0;var n={debugUrl:function(f){var g=C.Config.debug;f=g?g==="dev"?"../src/"+f:f:f.replace(/\.(js|css)/i,"-min.$1");f+=f.indexOf("?")!=-1?"&":"?";f+="t="+encodeURIComponent("2010-11-17 18:19:09");return f},lazyRun:function(f,g,e){var j=f[g],y=f[e];f[g]=function(){j.apply(this,arguments);f[g]=f[e];return y.apply(this,arguments)}},getXY:function(f,g,e,j){e=e.defaultView||
e.parentWindow;f-=x.scrollLeft(e);g-=x.scrollTop(e);if(j)if(e!=(j.defaultView||j.parentWindow)&&e.frameElement){j=x._4e_getOffset(e.frameElement,j);f+=j.left;g+=j.top}return{left:f,top:g}},tryThese:function(){for(var f,g=0,e=arguments.length;g<e;g++){var j=arguments[g];try{f=j();break}catch(y){}}return f},arrayCompare:function(f,g){if(!f&&!g)return true;if(!f||!g||f.length!=g.length)return false;for(var e=0;e<f.length;e++)if(f[e]!==g[e])return false;return true},getByAddress:function(f,g,e){f=f.documentElement;
for(var j=0;f&&j<g.length;j++){var y=g[j];if(e)for(var k=-1,a=0;a<f.childNodes.length;a++){var b=f.childNodes[a];if(!(e===true&&b.nodeType==3&&b.previousSibling&&b.previousSibling.nodeType==3)){k++;if(k==y){f=b;break}}}else f=f.childNodes[y]}return f?new H(f):z},clearAllMarkers:function(f){for(var g in f)f[g]._4e_clearMarkers(f,true)},htmlEncodeAttr:function(f){return f.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(f){return f.replace(/^\s+/,"")},rtrim:function(f){return f.replace(/\s+$/,
"")},trim:function(f){return this.ltrim(this.rtrim(f))},mix:function(){for(var f={},g=0;g<arguments.length;g++)f=C.mix(f,arguments[g]);return f},isCustomDomain:function(){if(!u.ie)return false;var f=document.domain,g=window.location.hostname;return f!=g&&f!="["+g+"]"},duplicateStr:function(f,g){return Array(g+1).join(f)},throttle:function(f,g,e){e=e||150;if(e===-1)return function(){f.apply(g,arguments)};var j=(new Date).getTime();return function(){var y=(new Date).getTime();if(y-j>e){j=y;f.apply(g,
arguments)}}},buffer:function(f,g,e){e=e||0;var j=z;return function(){j&&clearTimeout(j);var y=arguments;j=setTimeout(function(){return f.apply(g,y)},e)}},isNumber:function(f){return/^\d+(.\d+)?$/.test(C.trim(f))},verifyInputs:function(f){for(var g=0;g<f.length;g++){var e=x._4e_wrap(f[g]),j=C.trim(e.val()),y=e.attr("data-verify");e=e.attr("data-warning");if(y&&!RegExp(y).test(j)){alert(e);return false}}return true},sourceDisable:function(f,g){f.on("sourcemode",g.disable,g);f.on("wysiwygmode",g.enable,
g)},resetInput:function(f){var g=f.attr("placeholder");if(g&&!u.webkit){f.addClass("ke-input-tip");f.val(g)}else u.webkit&&f.val("")},valInput:function(f,g){f.removeClass("ke-input-tip");f.val(g)},placeholder:function(f,g){f.attr("placeholder",g);if(!u.webkit){f.on("blur",function(){if(!C.trim(f.val())){f.addClass("ke-input-tip");f.val(g)}});f.on("focus",function(){f.removeClass("ke-input-tip");C.trim(f.val())==g&&f.val("")})}},clean:function(f){f=f[0]||f;for(var g=C.makeArray(f.childNodes),e=0;e<
g.length;e++){var j=g[e];j.nodeType==p.NODE.NODE_TEXT&&!C.trim(j.nodeValue)&&f.removeChild(j)}},htmlEncode:function(f){return!f?f:String(f).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(f){return!f?f:String(f).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(f,g){return f.toLowerCase()==g.toLowerCase()},normParams:function(f){f=C.clone(f);for(var g in f)if(f.hasOwnProperty(g)){var e=
f[g];if(C.isFunction(e))f[g]=e()}return f},doFormUpload:function(f,g,e){function j(){var v={responseText:"",responseXML:z};v.argument=f?f.argument:z;try{var t;if((t=u.ie?k.contentWindow.document:k.contentDocument||window.frames[y].document)&&t.body)v.responseText=t.body.innerHTML;v.responseXML=t&&t.XMLDocument?t.XMLDocument:t}catch(l){C.log(l)}A.remove(k,"load",j);f.callback&&f.callback(v);setTimeout(function(){x._4e_remove(k)},100)}var y=C.guid("form-upload-"),k=document.createElement("iframe");
k.id=y;k.name=y;k.className="ke-hidden";var a="document.open();"+(n.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(u.ie)k.src=u.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";C.log("doFormUpload : "+k.src);document.body.appendChild(k);if(u.ie)document.frames[y].name=y;a=x._4e_unwrap(f.form);var b={target:a.target,method:a.method,encoding:a.encoding,enctype:a.enctype,action:a.action};a.target=y;a.method="POST";a.enctype=a.encoding="multipart/form-data";
if(e)a.action=e;var d;if(g){d=[];g=p.Utils.normParams(g);for(var m in g)if(g.hasOwnProperty(m)){e=document.createElement("input");e.type="hidden";e.name=m;e.value=g[m];a.appendChild(e);d.push(e)}}A.on(k,"load",j);a.submit();a.target=b.target;a.method=b.method;a.enctype=b.enctype;a.encoding=b.encoding;a.action=b.action;if(d){g=0;for(m=d.length;g<m;g++)x._4e_remove(d[g])}return k},extern:function(f,g){for(var e in g)f[e]=g[e]},map:function(f,g){for(var e=0;e<f.length;e++)f[e]=g(f[e]);return f},ieEngine:w};
p.Utils=n;p.Utils=n;n.extern(n,{debugUrl:n.debugUrl,lazyRun:n.lazyRun,getXY:n.getXY,tryThese:n.tryThese,arrayCompare:n.arrayCompare,getByAddress:n.getByAddress,clearAllMarkers:n.clearAllMarkers,htmlEncodeAttr:n.htmlEncodeAttr,ltrim:n.ltrim,rtrim:n.rtrim,trim:n.trim,mix:n.mix,isCustomDomain:n.isCustomDomain,duplicateStr:n.duplicateStr,buffer:n.buffer,isNumber:n.isNumber,verifyInputs:n.verifyInputs,sourceDisable:n.sourceDisable,resetInput:n.resetInput,placeholder:n.placeholder,clean:n.clean,htmlEncode:n.htmlEncode,
htmlDecode:n.htmlDecode,equalsIgnoreCase:n.equalsIgnoreCase,normParams:n.normParams,throttle:n.throttle,doFormUpload:n.doFormUpload,map:n.map})});
KISSY.Editor.add("focusmanager",function(p){function z(){this.iframeFocus=n;w=this}function C(){this.iframeFocus=f;w=g}var H=KISSY,x=H.DOM,u=H.Event,A={},w;H={refreshAll:function(){for(var e in A){var j=A[e];j.document.designMode="off";j.document.designMode="on"}},currentInstance:function(){return w},getInstance:function(e){return A[e]},add:function(e){var j=x._4e_getWin(e.document);u.on(j,"focus",z,e);u.on(j,"blur",C,e)},register:function(e){A[e._UUID]=e},remove:function(e){delete A[e._UUID];var j=
x._4e_getWin(e.document);u.remove(j,"focus",z,e);u.remove(j,"blur",C,e)}};var n=true,f=false,g=null;p.focusManager=H;p.focusManager=H;p.getInstances=function(){return A};p.getInstances=p.getInstances});
KISSY.Editor.add("definition",function(p){var z=true,C=false,H=document,x=KISSY,u=x.UA,A=x.DOM,w=x.Node,n=x.Event,f=p.focusManager,g=p.Utils.tryThese,e=p.Utils.debugUrl("theme/editor-iframe.css"),j=1,y="document.open();"+(p.Utils.isCustomDomain()?'document.domain="'+H.domain+'";':"")+"document.close();",k="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(u.ie?"javascript:void(function(){"+encodeURIComponent(y)+"}())":"")+'"  tabIndex="'+(u.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";p.SOURCE_MODE=0;p.WYSIWYG_MODE=1;p.SOURCE_MODE=p.SOURCE_MODE;p.WYSIWYG_MODE=p.WYSIWYG_MODE;x.augment(p,{init:function(a){if(u.ie)A.addClass(H.body,"ie"+u.ie);else if(u.gecko)A.addClass(H.body,"gecko");else u.webkit&&A.addClass(H.body,"webkit");var b=this,d=new w(k.replace(/\$\(tabIndex\)/,
a.attr("tabIndex")));d.on("mousedown",function(t){if(u.webkit){var l=A._4e_name(t.target);if(l=="select"||l=="option")return z}t.halt()});a.on("mousedown",function(t){t.stopPropagation()});b.editorWrap=d;b._UUID=j++;f.register(b);b.wrap=d.one(".ke-textarea-wrap");b.wrap=b.wrap;b.iframe=b.wrap.one("iframe");b.iframe=b.iframe;b.toolBarDiv=d.one(".ke-editor-tools");b.toolBarDiv=b.toolBarDiv;b.textarea=a;b.textarea=b.textarea;b.statusDiv=d.one(".ke-editor-status");b.statusDiv=b.statusDiv;b.toolBarDiv._4e_unselectable();
b._commands={};b._dialogs={};var m=a._4e_style("width"),v=a._4e_style("height");if(m){d.css("width",m);a.css("width","100%")}b.textarea.css("display","none");d.insertAfter(a);b.wrap[0].appendChild(a[0]);if(v){b.wrap.css("height",v);a.css("height","100%")}d=b.iframe;b.on("dataReady",function(){b._ready=z;p.fire("instanceCreated",{editor:b})});u.gecko?d.on("load",b._setUpIFrame,b):b._setUpIFrame();b.cfg.attachForm&&a[0].form&&b._attachForm()},_attachForm:function(){(new w(this.textarea[0].form)).on("submit",
this.sync,this)},useDialog:function(a,b){var d=this,m=p.SimpleOverlay;m.loading();d.use(a,function(){var v=d.getDialog(a);b(v);m.unloading()})},addDialog:function(a,b){this._dialogs[a]=b},getDialog:function(a){return this._dialogs[a]},addPlugin:function(a){this.ready(a)},addCommand:function(a,b){this._commands[a]=b},hasCommand:function(a){return this._commands[a]},execCommand:function(a){var b=this._commands[a],d=x.makeArray(arguments);d.shift();d.unshift(this);return b.exec.apply(b,d)},getMode:function(){return this.textarea.css("display")==
"none"?p.WYSIWYG_MODE:p.SOURCE_MODE},getData:function(a){var b;b=this.getMode()==p.WYSIWYG_MODE?this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)b=a?this.htmlDataProcessor.toHtml(b,"p"):this.htmlDataProcessor.toServer(b,"p");b=x.trim(b);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(b))b="";return b},setData:function(a){var b=a;if(this.htmlDataProcessor)b=this.htmlDataProcessor.toDataFormat(a,"p");this.document.body.innerHTML=b;this.getMode()!=p.WYSIWYG_MODE&&this.textarea.val(a)},sync:function(){this.textarea.val(this.getData())},
baseZIndex:function(a){a=a||0;return a+(this.cfg.baseZIndex||0)},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(a){this.document.body.innerHTML=a},_prepareIFrameHtml:function(a){var b=this.cfg,d=b.customLink,m="";if(d)for(var v=0;v<d.length;v++)m+='<link href="'+d[v]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+p.Config.base+e+"' rel='stylesheet'/><style>"+(b.customStyle||"")+"</style>"+m+"</head><body class='ke-editor'>&nbsp;"+
(a?'<script id="ke_actscript" type="text/javascript">'+(p.Utils.isCustomDomain()?'document.domain="'+H.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':"")+"</body></html>"},getSelection:function(){return p.Selection.getSelection(this.document)},focus:function(){var a=this.document,b=A._4e_getWin(a);u.webkit&&b&&b.parent&&b.parent.focus();b&&b.focus();a&&a.body.focus();this.notifySelectionChange()},blur:function(){A._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},
addCustomStyle:function(a){var b=this.cfg,d=this.document;b.customStyle=b.customStyle||"";b.customStyle+="\n"+a;b=d.createElement("style");d.getElementsByTagName("head")[0].appendChild(b);if(b.styleSheet)b.styleSheet.cssText=a;else b.appendChild(d.createTextNode(a))},addCustomLink:function(a){var b=this.cfg,d=this.document;b.customLink=b.customLink||[];b.customLink.push(a);b=d.createElement("link");b.rel="stylesheet";d.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=
this.cfg,d=x.makeArray(this.document.getElementsByTagName("link")),m=0;m<d.length;m++)d[m].href==a&&A._4e_remove(d[m]);b.customLink=b.customLink||[];b=b.customLink;a=x.indexOf(a,b);a!=-1&&b.splice(a,1)},_setUpIFrame:function(){function a(){t=v.document;b.document=t;d.detach();t.open("text/html","replace");t.write(m);t.close()}var b=this,d=b.iframe,m=b._prepareIFrameHtml(b._UUID),v=d[0].contentWindow,t;try{t=v.document}catch(l){d[0].src=d[0].src;if(u.ie<7){setTimeout(a,10);return}}a()},ready:function(a){this._ready?
a():this.on("dataReady",a)},_monitor:function(){var a=this;a._monitorId&&clearTimeout(a._monitorId);a._monitorId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var d=b.getStartElement(),m=new p.ElementPath(d);if(!a.previousPath||!a.previousPath.compare(m)){a.previousPath=m;a.fire("selectionChange",{selection:b,path:m,element:d})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(a,b){var d=this;d.focus();var m=a._4e_name(),v=
p.XHTML_DTD,t=p.RANGE,l=p.NODE,i=v.$block[m],D=d.getSelection(),G=D&&D.getRanges(),s,c,h,o,q;if(!G||G.length==0){var r=arguments,B=r.callee;setTimeout(function(){B.apply(d,r)},30)}else{d.fire("save");for(var O=G.length-1;O>=0;O--){s=G[O];s.deleteContents();c=!O&&a||a._4e_clone(z);b&&b(c);if(i)for(;(o=s.getCommonAncestor(C,z))&&(q=v[o._4e_name()])&&!(q&&q[m]);)if(o._4e_name()in v.span)s.splitElement(o);else if(s.checkStartOfBlock()&&s.checkEndOfBlock()){s.setStartBefore(o);s.collapse(z);o._4e_remove()}else s.splitBlock();
s.insertNode(c);h||(h=c)}if(h){m=h._4e_nextSourceNode(z);v=d.document;q=p.XHTML_DTD;if(q.$inline[c._4e_name()]){m=new w(v.createTextNode(" "));m.insertAfter(h)}else if(m){if(m._4e_name()=="br"&&q[m.parent()._4e_name()].p){q=new w("<p>&nbsp;</p>",null,v);m[0].parentNode.replaceChild(q[0],m[0]);m=q}}else{q=new w("<p>&nbsp;</p>",null,v);q.insertAfter(h);m=q}s.moveToPosition(h,t.POSITION_AFTER_END);m&&m[0].nodeType==l.NODE_ELEMENT&&s.moveToElementEditablePosition(m);D.selectRanges([s]);d.focus();c&&c._4e_scrollIntoView();
setTimeout(function(){d.fire("save")},10);return c}}},insertHtml:function(a){var b=this;if(b.htmlDataProcessor)a=b.htmlDataProcessor.toDataFormat(a);if(u.webkit){var d=A.create(a,null,this.document);d=d.nodeType==11?x.makeArray(d.childNodes):[d];for(var m=0;m<d.length;m++)b.insertElement(new w(d[m]))}else{b.focus();m=(d=b.getSelection())&&d.getRanges();if(!m||m.length==0){var v=arguments,t=v.callee;setTimeout(function(){t.apply(b,v)},30)}else{b.fire("save");if(u.ie){d=d.getNative();d.type=="Control"&&
d.clear();d.createRange().pasteHTML(a)}else b.document.execCommand("inserthtml",C,a);b.focus();setTimeout(function(){b.fire("save")},10)}}}});p._initIFrame=function(a){function b(c){g(function(){v.designMode="on";setTimeout(function(){v.designMode="off";i.focus();if(!arguments.callee.retry)arguments.callee.retry=z},50)},function(){v.designMode="off";A.attr(i,"contentEditable",C);A.attr(i,"contentEditable",z);!c&&b(1)})}var d=f.getInstance(a);a=d.textarea[0];var m=d.iframe[0].contentWindow,v=d.document,
t=d.cfg,l=v.getElementById("ke_actscript");A._4e_remove(l);var i=v.body;if(u.ie){i.hideFocus=z;i.disabled=z;i.contentEditable=z;i.removeAttribute("disabled")}else setTimeout(function(){if(u.gecko||u.opera)i.contentEditable=z;else if(u.webkit)i.parentNode.contentEditable=z;else v.designMode="on"},0);if(u.webkit){n.on(v,"click",function(c){var h=new w(c.target);x.inArray(h._4e_name(),["input","select"])&&c.preventDefault()});n.on(v,"mouseup",function(c){var h=new w(c.target);x.inArray(h._4e_name(),
["input","textarea"])&&c.preventDefault()})}if(u.gecko||u.ie||u.opera){var D;D=new w(A.insertAfter((new w('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],a));D.on("focus",function(){d.focus()});d.activateGecko=function(){u.gecko&&d.iframeFocus&&D[0].focus()};d.on("destroy",function(){})}if(u.ie&&v.compatMode=="CSS1Compat"||u.gecko||u.opera){var G=new w(v.documentElement);G.on("mousedown",function(c){if(c.target==G[0]){u.gecko&&b(C);D[0].focus()}})}n.on(m,
"focus",function(){if(u.gecko)b(C);else u.opera&&i.focus();d.notifySelectionChange()});u.gecko&&n.on(d.document,"mousedown",function(){d.iframeFocus||b(C)});if(u.ie){n.on(v,"keydown",function(c){if(c.keyCode in{8:1,46:1}){var h=d.getSelection(),o=h.getSelectedElement();if(o){d.fire("save");var q=h.getRanges()[0].createBookmark();o._4e_remove();h.selectBookmarks([q]);d.fire("save");c.preventDefault()}}});if(v.compatMode=="CSS1Compat"){var s={33:1,34:1};n.on(v,"keydown",function(c){c.keyCode in s&&
setTimeout(function(){d.getSelection().scrollIntoView()},0)})}}setTimeout(function(){u.ie&&setTimeout(function(){if(v){i.runtimeStyle.marginBottom="0px";i.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){d.fire("dataReady");var c=t.disableObjectResizing,h=t.disableInlineTableEditing;if(c||h)try{v.execCommand("enableObjectResizing",C,!c);v.execCommand("enableInlineTableEditing",C,!h)}catch(o){n.on(i,u.ie?"resizestart":"resize",function(q){if(c||A._4e_name(q.target)==="table"&&h)q.preventDefault()})}},
10);u.webkit&&n.on(v,"mousedown",function(c){c=new w(c.target);x.inArray(c._4e_name(),["img","hr","input","textarea","select"])&&d.getSelection().selectElement(c)});u.gecko&&n.on(v,"dragstart",function(c){var h=new w(c.target);h._4e_name()==="img"&&/ke_/.test(h[0].className)&&c.preventDefault()});f.add(d)};y=p.prototype;p.Utils.extern(y,{setData:y.setData,getData:y.getData,insertElement:y.insertElement,insertHtml:y.insertHtml,ready:y.ready,addCustomStyle:y.addCustomStyle,addCommand:y.addCommand,hasCommand:y.hasCommand,
execCommand:y.execCommand,addPlugin:y.addPlugin,useDialog:y.useDialog,addDialog:y.addDialog,getDialog:y.getDialog,getMode:y.getMode,sync:y.sync,baseZIndex:y.baseZIndex,getSelection:y.getSelection,focus:y.focus,blur:y.blur,notifySelectionChange:y.notifySelectionChange})});
KISSY.Editor.add("zindex",function(){var p=KISSY.Editor;if(!p.zIndexManager){p.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};p.baseZIndex=function(z){var C=z,H=p.getInstances(),x;for(x in H){if(!H.hasOwnProperty(x))return;C=Math.max(C,H[x].baseZIndex(z))}return C};p.baseZIndex=p.baseZIndex;p.zIndexManager=p.zIndexManager}});
KISSY.Editor.add("dtd",function(p){p.XHTML_DTD=function(){function z(l){for(var i=arguments.length-1;i>0;)KISSY.mix(l,arguments[i--]);return l}var C={isindex:1,fieldset:1},H={input:1,button:1,select:1,textarea:1,label:1},x=z({a:1},H),u=z({iframe:1},x),A={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},w={ins:1,del:1,script:1,style:1},n=z({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},w),f=z({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},n),g=z({p:1},f);H=z({iframe:1},f,H);f={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var e=z({a:1},H),j={tr:1},y={"#":1},k=z({param:1},f),a=z({form:1},C,u,A,g),b={li:1},d={base:1,link:1,meta:1,title:1},m=z(d,{style:1,script:1}),v={head:1,body:1},t={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:z({html:1},v,d),$block:t,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:e,$body:z({script:1,style:1},t),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:v,head:m,style:y,body:a,base:{},link:{},meta:{},title:y,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:e,button:z(g,A),basefont:{},h5:e,h4:e,samp:e,h6:e,ol:b,h1:e,h3:e,option:y,h2:e,form:z(C,u,A,g),select:{optgroup:1,option:1},font:e,ins:e,menu:b,abbr:e,label:e,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:e,script:y,tfoot:j,cite:e,li:a,input:{},iframe:a,strong:e,textarea:y,noframes:a,big:e,small:e,span:e,hr:{},dt:e,sub:e,optgroup:{option:1},param:{},bdo:e,"var":e,div:a,object:k,sup:e,dd:a,strike:e,area:{},dir:b,map:z({area:1,form:1,p:1},C,w,A),applet:k,dl:{dt:1,dd:1},del:e,isindex:{},fieldset:z({legend:1},f),thead:j,ul:b,acronym:e,b:e,a:H,blockquote:a,caption:e,i:e,u:e,tbody:j,s:e,address:z(u,g),tt:e,legend:e,q:e,pre:z(n,x),p:e,em:e,dfn:e}}();p.XHTML_DTD=
p.XHTML_DTD});
KISSY.Editor.add("dom",function(p){function z(a){return a.replace(/-(\w)/g,function(b,d){return d.toUpperCase()})}var C=KISSY,H=C.DOM,x=C.UA,u=C.Node,A=p.Utils,w={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};p.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};p.NODE=p.NODE;p.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};p.POSITION=p.POSITION;var n=p.NODE,f=p.POSITION,g={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},e={hr:1},j=function(a){return a[0]||a},y=function(a){if(a&&!a[0])return new u(a);return a},k={_4e_wrap:y,_4e_unwrap:j,_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=j(a);b=j(b);
return a===b},_4e_isBlockBoundary:function(a,b){a=y(a);var d=C.mix(C.mix({},e),b||{});return g[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=j(a);for(var b=a.parentNode.childNodes,d=0;d<b.length;d++)if(b[d]===a)return d;return-1},_4e_first:function(a,b){a=j(a);var d=a.firstChild;if((d=d&&new u(d))&&b&&!b(d))d=d._4e_next(b);return d},_4e_move:function(a,b,d){a=j(a);H._4e_remove(a);
b=j(b);d?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_name:function(a){a=j(a);var b=a.nodeName.toLowerCase();if(x.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var d=a[0].attributes,m=b[0].attributes,v=d.length,t=m.length;if(v!=t)return false;for(var l=0;l<v;l++){var i=d[l],D=i.name;if(i.specified&&a.attr(D)!=b.attr(D))return false}if(A.ieEngine<8)for(l=0;l<t;l++){i=m[l];D=i.name;if(i.specified&&
a.attr(D)!=b.attr(D))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=j(a).childNodes;for(var b=0,d=a.length;b<d;b++){var m=a[b],v=m.nodeType;if(!(v==n.NODE_ELEMENT&&m.getAttribute("_ke_bookmark")))if(v==n.NODE_ELEMENT&&!k._4e_isEmptyInlineRemoveable(m)||v==n.NODE_TEXT&&C.trim(m.nodeValue))return false}return true},_4e_moveChildren:function(a,b,d){a=j(a);b=b[0]||b;if(a!=b)if(d)for(;d=a.lastChild;)b.insertBefore(a.removeChild(d),b.firstChild);else for(;d=a.firstChild;)b.appendChild(a.removeChild(d))},
_4e_mergeSiblings:function(){function a(b,d,m){if(d[0]&&d[0].nodeType==n.NODE_ELEMENT){for(var v=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){v.push(d);d=m?new u(d[0].nextSibling):new u(d[0].previousSibling);if(!d[0]||d[0].nodeType!=n.NODE_ELEMENT)return}if(b._4e_isIdentical(d)){for(var t=m?b[0].lastChild:b[0].firstChild;v.length;)v.shift()._4e_move(b,!m);d._4e_moveChildren(b,!m);d._4e_remove();t[0]&&t[0].nodeType==n.NODE_ELEMENT&&t._4e_mergeSiblings()}}}return function(b){if(b[0])if(w[b._4e_name()]||
b._4e_name()=="a"){a(b,new u(b[0].nextSibling),true);a(b,new u(b[0].previousSibling))}}}(),_4e_unselectable:x.gecko?function(a){a=j(a);a.style.MozUserSelect="none"}:x.webkit?function(a){a=j(a);a.style.KhtmlUserSelect="none"}:function(a){a=j(a);if(x.ie||x.opera){var b,d=0;for(a.unselectable="on";b=a.all[d++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable="on"}}},_4e_getOffset:function(a,b){a=j(a);var d,m=0;d=0;var v=a.ownerDocument.defaultView||
a.ownerDocument.parentWindow,t=a.ownerDocument,l=t.documentElement;b=b||t;if(a.getBoundingClientRect){if(a!==t.body&&l!==a){d=a.getBoundingClientRect();m=d.left+(b===t?H.scrollLeft(v):0);d=d.top+(b===t?H.scrollTop(v):0)}if(b)if(v!=(b.defaultView||b.parentWindow)&&v.frameElement){v=k._4e_getOffset(v.frameElement,b);m+=v.left;d+=v.top}}return{left:m,top:d}},_4e_getFrameDocument:function(a){return(a=j(a))&&a.contentWindow.document},_4e_splitText:function(a,b){a=j(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=
n.NODE_TEXT)){if(x.ie&&b==a.nodeValue.length){var m=d.createTextNode("");H.insertAfter(m,a);return new u(m)}m=new u(a.splitText(b));if(d.documentMode){d=d.createTextNode("");H.insertAfter(d,m[0]);H._4e_remove(d)}return m}},_4e_parents:function(a,b){a=y(a);var d=[];do d[b?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,b,d){a=j(a);a=a.cloneNode(b);if(!d){var m=function(v){if(v.nodeType==n.NODE_ELEMENT){v.removeAttribute("id");v=v.childNodes;for(var t=0;t<v.length;t++)m(v[t])}};
m(a)}return new u(a)},_4e_nextSourceNode:function(a,b,d,m){a=j(a);if(m&&!m.call){var v=m[0]||m;m=function(l){l=l[0]||l;return l!==v}}b=!b&&a.firstChild;var t=new u(a);if(!b){if(a.nodeType==n.NODE_ELEMENT&&m&&m(a,true)===false)return null;b=a.nextSibling}for(;!b&&(t=t.parent());){if(m&&m(t,true)===false)return null;b=t[0].nextSibling}if(!b)return null;b=H._4e_wrap(b);if(m&&m(b)===false)return null;if(d&&d!=b[0].nodeType)return b._4e_nextSourceNode(false,d,m);return b},_4e_previousSourceNode:function(a,
b,d,m){a=j(a);if(m&&!m.call){var v=m[0]||m;m=function(l){l=l[0]||l;return l!==v}}b=!b&&a.lastChild;var t=new u(a);if(!b){if(a.nodeType==n.NODE_ELEMENT&&m&&m(a,true)===false)return null;b=a.previousSibling}for(;!b&&(t=t.parent());){if(m&&m(t,true)===false)return null;b=t[0].previousSibling}if(!b)return null;b=H._4e_wrap(b);if(m&&m(b)===false)return null;if(d&&b[0].nodeType!=d)return b._4e_previousSourceNode(false,d,m);return b},_4e_contains:x.gecko?function(a,b){a=j(a);b=j(b);return!!(a.compareDocumentPosition(b)&
16)}:function(a,b){a=j(a);b=j(b);return b.nodeType!=n.NODE_ELEMENT?a.contains(b.parentNode):a!=b&&a.contains(b)},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=n.NODE_TEXT&&b._4e_contains(a))return b;var d=a[0].nodeType==n.NODE_TEXT?a.parent():a;do if(d[0].nodeType!=n.NODE_TEXT&&d._4e_contains(b))return d;while(d=d.parent());return null},_4e_ascendant:function(a,b,d){a=j(a);if(!d)a=a.parentNode;if(b&&!C.isFunction(b)){var m=b;b=function(v){return v._4e_name()==m}}for(;a&&
a.nodeType!=9;){if(!b||b(new u(a))===true)return new u(a);a=a.parentNode}return null},_4e_hasAttribute:A.ieEngine<9?function(a,b){a=j(a);var d=a.attributes[b];return!!(d&&d.specified)}:function(a,b){a=j(a);return a.hasAttribute(b)},_4e_hasAttributes:A.ieEngine<9?function(a){a=j(a);for(var b=a.attributes,d=0;d<b.length;d++){var m=b[d];switch(m.name){case "class":if(a.getAttribute("class"))return true;break;default:if(m.specified)return true}}return false}:function(a){a=j(a);x.gecko&&a.removeAttribute("_moz_dirty");
return a.hasAttributes()},_4e_position:function(a,b){var d=j(a),m=j(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(m);if(d==m)return f.POSITION_IDENTICAL;if(d.nodeType==n.NODE_ELEMENT&&m.nodeType==n.NODE_ELEMENT){if(d.contains){if(d.contains(m))return f.POSITION_CONTAINS+f.POSITION_PRECEDING;if(m.contains(d))return f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING}if("sourceIndex"in d)return d.sourceIndex<0||m.sourceIndex<0?f.POSITION_DISCONNECTED:d.sourceIndex<m.sourceIndex?f.POSITION_PRECEDING:
f.POSITION_FOLLOWING}d=a._4e_address();m=b._4e_address();for(var v=Math.min(d.length,m.length),t=0;t<=v-1;t++)if(d[t]!=m[t]){if(t<v)return d[t]<m[t]?f.POSITION_PRECEDING:f.POSITION_FOLLOWING;break}return d.length<m.length?f.POSITION_CONTAINS+f.POSITION_PRECEDING:f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING},_4e_address:function(a,b){a=j(a);for(var d=[],m=a.ownerDocument.documentElement,v=a;v&&v!=m;){var t=v.parentNode,l=-1;if(t){for(var i=0;i<t.childNodes.length;i++){var D=t.childNodes[i];if(!(b&&
D.nodeType==3&&D.previousSibling&&D.previousSibling.nodeType==3)){l++;if(D==v)break}}d.unshift(l)}v=t}return d},_4e_breakParent:function(a,b){var d=new p.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);var m=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(m,a[0].nextSibling)},_4e_style:function(a,b,d){a=y(a);if(d!==undefined)return a.css(b,d);a=j(a);return a.style[z(b)]},_4e_remove:function(a,b){var d=j(a),m=d.parentNode;if(m){if(b)for(var v;v=d.firstChild;)m.insertBefore(d.removeChild(v),
d);m.removeChild(d)}return a},_4e_trim:function(a){H._4e_ltrim(a);H._4e_rtrim(a)},_4e_ltrim:function(a){a=j(a);for(var b;b=a.firstChild;){if(b.nodeType==n.NODE_TEXT){var d=A.ltrim(b.nodeValue),m=b.nodeValue.length;if(d){if(d.length<m){(new u(b))._4e_splitText(m-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=j(a);for(var b;b=a.lastChild;){if(b.type==n.NODE_TEXT){var d=A.rtrim(b.nodeValue),m=b.nodeValue.length;if(d){if(d.length<m){(new u(b))._4e_splitText(d.length);
a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!x.ie&&!x.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=j(a);for(var b=a.lastChild;b&&b.nodeType==n.NODE_TEXT&&!C.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==n.NODE_TEXT||H._4e_name(b)!=="br"){b=x.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");x.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,
b){var d=j(a),m;do m=(d=d.previousSibling)&&new u(d);while(m&&b&&!b(m));return m},_4e_last:function(a,b){a=H._4e_wrap(a);var d=a[0].lastChild;if((d=d&&new u(d))&&b&&!b(d))d=d._4e_previous(b);return d},_4e_next:function(a,b){var d=j(a),m;do m=(d=d.nextSibling)&&new u(d);while(m&&b&&!b(m));return m},_4e_outerHtml:function(a){a=j(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,
b,d,m){a=H._4e_wrap(a);var v=a.data("list_marker_id")||a.data("list_marker_id",C.guid()).data("list_marker_id"),t=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[v]=a;t[d]=1;return a.data(d,m)},_4e_clearMarkers:function(a,b,d){a=y(a);var m=a.data("list_marker_names"),v=a.data("list_marker_id"),t;for(t in m)a.removeData(t);a.removeData("list_marker_names");if(d){a.removeData("list_marker_id");delete b[v]}},_4e_copyAttributes:function(a,b,d){a=j(a);b=y(b);var m=
a.attributes;d=d||{};for(var v=0;v<m.length;v++){var t=m[v],l=t.name.toLowerCase(),i;if(!(l in d))if(l=="checked"&&(i=H.attr(a,l)))b.attr(l,i);else if(t.specified||x.ie&&t.value&&l=="value"){i=H.attr(a,l);if(i===null)i=t.nodeValue;b.attr(l,i)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=H._4e_name(a);var b=p.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=y(a);var b=a[0].ownerDocument,d=H.scrollLeft(b),m=
H.scrollTop(b),v=a.offset(),t=v.left;v=v.top;if(H.viewportHeight(b)+m<v||v<m||H.viewportWidth(b)+d<t||t<d)a.scrollIntoView(b)},_4e_getElementsByTagName:function(a,b,d){a=j(a);if(!x.ie&&d)b=d+":"+b;d=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)d.push(new u(a[b]));return d}};C.DOM._4e_inject=function(a){C.mix(H,a);for(var b in a)a.hasOwnProperty(b)&&function(d){u.prototype[d]=function(){var m=[].slice.call(arguments,0);m.unshift(this);return a[d].apply(null,m)}}(b)};A.extern(k,{_4e_wrap:k._4e_wrap,
_4e_unwrap:k._4e_unwrap,_4e_equals:k._4e_equals,_4e_isBlockBoundary:k._4e_isBlockBoundary,_4e_getWin:k._4e_getWin,_4e_index:k._4e_index,_4e_first:k._4e_first,_4e_move:k._4e_move,_4e_name:k._4e_name,_4e_isIdentical:k._4e_isIdentical,_4e_isEmptyInlineRemoveable:k._4e_isEmptyInlineRemoveable,_4e_moveChildren:k._4e_moveChildren,_4e_mergeSiblings:k._4e_mergeSiblings,_4e_unselectable:k._4e_unselectable,_4e_getOffset:k._4e_getOffset,_4e_getFrameDocument:k._4e_getFrameDocument,_4e_splitText:k._4e_splitText,
_4e_parents:k._4e_parents,_4e_clone:k._4e_clone,_4e_nextSourceNode:k._4e_nextSourceNode,_4e_previousSourceNode:k._4e_previousSourceNode,_4e_contains:k._4e_contains,_4e_commonAncestor:k._4e_commonAncestor,_4e_ascendant:k._4e_ascendant,_4e_hasAttribute:k._4e_hasAttribute,_4e_hasAttributes:k._4e_hasAttributes,_4e_position:k._4e_position,_4e_address:k._4e_address,_4e_breakParent:k._4e_breakParent,_4e_style:k._4e_style,_4e_remove:k._4e_remove,_4e_trim:k._4e_trim,_4e_ltrim:k._4e_ltrim,_4e_rtrim:k._4e_rtrim,
_4e_appendBogus:k._4e_appendBogus,_4e_last:k._4e_last,_4e_previous:k._4e_previous,_4e_next:k._4e_next,_4e_outerHtml:k._4e_outerHtml,_4e_setMarker:k._4e_setMarker,_4e_clearMarkers:k._4e_clearMarkers,_4e_getUniqueId:k._4e_getUniqueId,_4e_copyAttributes:k._4e_copyAttributes,_4e_isEditable:k._4e_isEditable,_4e_scrollIntoView:k._4e_scrollIntoView,_4e_getElementsByTagName:k._4e_getElementsByTagName});H._4e_inject(k)});
KISSY.Editor.add("elementpath",function(p){function z(f){var g=u,e=u,j=[];for(f=f;f&&f[0];){if(f[0].nodeType==x.NODE_ELEMENT){if(!this.lastElement)this.lastElement=f;var y=f._4e_name();if(!e){if(!g&&A[y])g=f;if(w[y]){var k;if(k=!g){if(k=y=="div"){a:{k=f;k=k[0]||k;k=k.childNodes;for(var a=0,b=k.length;a<b;a++){var d=k[a];if(d.nodeType==x.NODE_ELEMENT&&H.$block[d.nodeName.toLowerCase()]){k=true;break a}}k=false}k=!k}k=k}if(k)g=f;else e=f}}j.push(f);if(y=="body")break}f=f.parent()}this.block=this.block=
g;this.blockLimit=this.blockLimit=e;this.elements=this.elements=j}var C=KISSY.DOM,H=p.XHTML_DTD,x=p.NODE,u=null,A={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},w={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};z.prototype={compare:function(f){var g=this.elements;f=f&&f.elements;if(!f||g.length!=f.length)return false;for(var e=0;e<g.length;e++)if(!C._4e_equals(g[e],f[e]))return false;return true},contains:function(f){for(var g=this.elements,e=0;e<
g.length;e++)if(g[e]._4e_name()in f)return g[e];return u}};p.ElementPath=p.ElementPath=z;var n=z.prototype;p.Utils.extern(n,{compare:n.compare,contains:n.contains})});
KISSY.Editor.add("walker",function(p){function z(j,y){if(this._.end)return A;var k,a=this.range,b,d=this.guard,m=this.type,v=j?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;a.trim();if(a.collapsed){this.end();return A}}if(!j&&!this._.guardLTR){var t=a.endContainer,l=new g(t[0].childNodes[a.endOffset]);this._.guardLTR=function(s,c){return(s=f._4e_wrap(s))&&s[0]&&(!c||!f._4e_equals(t,s))&&(!l[0]||!s._4e_equals(l))&&(s[0].nodeType!=n.NODE_ELEMENT||!c||s._4e_name()!="body")}}if(j&&
!this._.guardRTL){var i=a.startContainer,D=a.startOffset>0&&new g(i[0].childNodes[a.startOffset-1]);this._.guardRTL=function(s,c){return(s=f._4e_wrap(s))&&s[0]&&(!c||!s._4e_equals(i))&&(!D[0]||!s._4e_equals(D))&&(s[0].nodeType!=n.NODE_ELEMENT||!c||s._4e_name()!="body")}}var G=j?this._.guardRTL:this._.guardLTR;b=d?function(s,c){if(G(s,c)===u)return u;return d(s,c)}:G;if(this.current)k=this.current[v](u,m,b);else if(j){k=a.endContainer;if(a.endOffset>0){k=new g(k[0].childNodes[a.endOffset-1]);if(b(k)===
u)k=A}else k=b(k,x)===u?A:k._4e_previousSourceNode(x,m,b)}else{k=a.startContainer;if((k=new g(k[0].childNodes[a.startOffset]))&&k[0]){if(b(k)===u)k=A}else k=b(a.startContainer,x)===u?A:a.startContainer._4e_nextSourceNode(x,m,b)}for(;k&&k[0]&&!this._.end;){this.current=k;if(!this.evaluator||this.evaluator(k)!==u){if(!y)return k}else if(y&&this.evaluator)return u;k=k[v](u,m,b)}this.end();return this.current=A}function C(j){for(var y,k=A;y=z.call(this,j);)k=y;return k}function H(j){this.range=j;this._=
{}}var x=true,u=false,A=null,w=KISSY,n=p.NODE,f=w.DOM,g=w.Node;w.augment(H,{end:function(){this._.end=1},next:function(){return z.call(this)},previous:function(){return z.call(this,x)},checkForward:function(){return z.call(this,u,x)!==u},checkBackward:function(){return z.call(this,x,x)!==u},lastForward:function(){return C.call(this)},lastBackward:function(){return C.call(this,x)},reset:function(){delete this.current;this._={}}});H.blockBoundary=function(j){return function(y){y=f._4e_wrap(y);return!(y&&
y[0].nodeType==n.NODE_ELEMENT&&y._4e_isBlockBoundary(j))}};H.listItemBoundary=function(){return this.blockBoundary({br:1})};H.bookmark=function(j,y){function k(a){return a&&a[0]&&a._4e_name()=="span"&&a.attr("_ke_bookmark")}return function(a){var b,d;b=a&&a[0]&&a[0].nodeType==n.NODE_TEXT&&(d=a.parent())&&k(d);b=j?b:b||k(a);return y^b}};H.whitespaces=function(j){return function(y){y=(y=y[0]||y)&&y.nodeType==n.NODE_TEXT&&!w.trim(y.nodeValue);return j^y}};H.invisible=function(j){var y=H.whitespaces();
return function(k){k=y(k)||k[0].nodeType==n.NODE_ELEMENT&&!k[0].offsetHeight;return j^k}};p.Walker=H;p.Walker=H;var e=H.prototype;p.Utils.extern(e,{end:e.end,next:e.next,previous:e.previous,checkForward:e.checkForward,checkBackward:e.checkBackward,lastForward:e.lastForward,lastBackward:e.lastBackward,reset:e.reset});p.Utils.extern(H,{blockBoundary:H.blockBoundary,listItemBoundary:H.listItemBoundary,bookmark:H.bookmark,whitespaces:H.whitespaces,invisible:H.invisible})});
KISSY.Editor.add("range",function(p){function z(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=f;this.collapsed=w;this.document=c}function C(c){var h=c[0].nodeType!=e.NODE_TEXT&&c._4e_name()in m.$removeEmpty,o=!g.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return h||o||c}function H(c){return!D(c)&&!G(c)}function x(c){var h=n,o=k.bookmark(w);return function(q){if(o(q))return w;if(q[0].nodeType==e.NODE_TEXT){if(g.trim(q[0].nodeValue).length)return n}else if(q[0].nodeType==
e.NODE_ELEMENT)if(!i[q._4e_name()])if(!c&&!d.ie&&q._4e_name()=="br"&&!h)h=w;else return n;return w}}function u(c,h){function o(q){return q&&q.nodeName=="span"&&q.getAttribute("_ke_bookmark")}return function(q){var r,B;r=q&&!q.nodeName&&(B=q.parentNode)&&o(B);r=c?r:r||o(q);return h^r}}function A(c){return function(h){h=(h=h[0]||h)&&h.nodeType==e.NODE_TEXT&&!g.trim(h.nodeValue);return c^h}}p.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};p.RANGE=p.RANGE;var w=true,n=false,f=null,g=KISSY,e=p.NODE,j=p.RANGE,y=p.POSITION,k=p.Walker,a=g.DOM,b=p.Utils.getByAddress,d=g.UA,m=p.XHTML_DTD,v=p.ElementPath,t=g.Node,l={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};z.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return c.join("<br/>")};g.augment(z,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,h=this.startOffset;if(c[0].nodeType!=e.NODE_ELEMENT)if(h)h>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;h=this.endOffset;if(c[0].nodeType!=e.NODE_ELEMENT)if(h)h>=
c[0].nodeValue.length&&this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,h=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,j.POSITION_BEFORE_START);
h&&h._4e_name()=="span"&&h.attr("_ke_bookmark")&&this.setEndAt(h,j.POSITION_AFTER_END)},setStart:function(c,h){if(c[0].nodeType==e.NODE_ELEMENT&&l[c._4e_name()]){c=c.parent();h=c._4e_index()}this.startContainer=c;this.startOffset=h;if(!this.endContainer){this.endContainer=c;this.endOffset=h}this.updateCollapsed()},setEnd:function(c,h){if(c[0].nodeType==e.NODE_ELEMENT&&l[c._4e_name()]){c=c.parent();h=c._4e_index()+1}this.endContainer=c;this.endOffset=h;if(!this.startContainer){this.startContainer=
c;this.startOffset=h}this.updateCollapsed()},setStartAt:function(c,h){switch(h){case j.POSITION_AFTER_START:this.setStart(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==e.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setStartBefore(c);break;case j.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,h){switch(h){case j.POSITION_AFTER_START:this.setEnd(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==
e.NODE_TEXT?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setEndBefore(c);break;case j.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,h){var o=this.startContainer,q=this.endContainer,r=this.startOffset,B=this.endOffset,O,N=this.document,P;this.optimizeBookmark();if(q[0].nodeType==e.NODE_TEXT)q=q._4e_splitText(B);else if(q[0].childNodes.length>0)if(B>=q[0].childNodes.length){q=new t(q[0].appendChild(N.createTextNode("")));
P=w}else q=new t(q[0].childNodes[B]);if(o[0].nodeType==e.NODE_TEXT){o._4e_splitText(r);if(o._4e_equals(q))q=new t(o[0].nextSibling)}else if(r)if(r>=o[0].childNodes.length){O=new t(N.createTextNode(""));o.append(O);o=O;O=w}else o=new t(o[0].childNodes[r].previousSibling);else{O=new t(N.createTextNode(""));(r=o[0].firstChild)?a.insertBefore(O[0],r):o.append(O);o=O;O=w}r=o._4e_parents();B=q._4e_parents();var Q,U,T;for(Q=0;Q<r.length;Q++){U=r[Q];T=B[Q];if(!U._4e_equals(T))break}N=h;for(var S,E,K,F=Q;F<
r.length;F++){S=r[F];E=N&&!S._4e_equals(o)?N.appendChild(S._4e_clone()[0]):null;for(S=S[0].nextSibling;S;){if(a._4e_equals(B[F],S)||a._4e_equals(q,S))break;K=S.nextSibling;if(c==2)N.appendChild(S.cloneNode(w));else{a._4e_remove(S);c==1&&N.appendChild(S)}S=K}if(E)N=E}N=h;for(Q=Q;Q<B.length;Q++){S=B[Q];E=N&&c>0&&!S._4e_equals(q)?N.appendChild(S._4e_clone()[0]):null;if(!r[Q]||!S.parent()._4e_equals(r[Q].parent()))for(S=S[0].previousSibling;S;){if(a._4e_equals(r[Q],S)||a._4e_equals(o,S))break;K=S.previousSibling;
if(c==2)N.insertBefore(S.cloneNode(w),N.firstChild);else{a._4e_remove(S);c==1&&N.insertBefore(S,N.firstChild)}S=K}if(E)N=E}if(c==2){T=this.startContainer[0];if(T.nodeType==e.NODE_TEXT&&T.nextSibling&&T.nextSibling.nodeType==e.NODE_TEXT){T.data+=T.nextSibling.data;T.parentNode.removeChild(T.nextSibling)}T=this.endContainer[0];if(T.nodeType==e.NODE_TEXT&&T.nextSibling&&T.nextSibling.nodeType==e.NODE_TEXT){T.data+=T.nextSibling.data;T.parentNode.removeChild(T.nextSibling)}}else{if(U&&T&&(!o.parent()._4e_equals(U.parent())||
!q.parent()._4e_equals(T.parent()))){U=T._4e_index();O&&T.parent()._4e_equals(o.parent())&&U--;this.setStart(T.parent(),U)}this.collapse(w)}O&&o._4e_remove();P&&q[0].parentNode&&q._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=w},clone:function(){var c=new z(this.document);c.startContainer=this.startContainer;c.startOffset=this.startOffset;c.endContainer=
this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=e.NODE_ELEMENT||c.endContainer[0].nodeType!=e.NODE_ELEMENT)return f;var h=new p.Walker(c),o=u(w,undefined),q=A(w);c.evaluator=function(r){return q(r)&&o(r)};c=h.next();h.reset();h=h.previous();return c&&c._4e_equals(h)?c:f},shrink:function(c,h){if(!this.collapsed){c=c||j.SHRINK_TEXT;var o=this.clone(),q=this.startContainer,r=
this.endContainer,B=this.startOffset,O=this.endOffset,N=1,P=1;if(q&&q[0].nodeType==e.NODE_TEXT)if(B)if(B>=q[0].nodeValue.length)o.setStartAfter(q);else{o.setStartBefore(q);N=0}else o.setStartBefore(q);if(r&&r[0].nodeType==e.NODE_TEXT)if(O)if(O>=r[0].nodeValue.length)o.setEndAfter(r);else{o.setEndAfter(r);P=0}else o.setEndBefore(r);o=new k(o);o.evaluator=function(U){U=U[0]||U;return U.nodeType==(c==j.SHRINK_ELEMENT?e.NODE_ELEMENT:e.NODE_TEXT)};var Q;o.guard=function(U,T){U=U[0]||U;if(c==j.SHRINK_ELEMENT&&
U.nodeType==e.NODE_TEXT)return n;if(T&&U==Q)return n;if(!T&&U.nodeType==e.NODE_ELEMENT)Q=U;return w};if(N)(q=o[c==j.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(q,h?j.POSITION_AFTER_START:j.POSITION_BEFORE_START);if(P){o.reset();(o=o[c==j.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(o,h?j.POSITION_BEFORE_END:j.POSITION_AFTER_END)}return!!(N||P)}},getTouchedStartNode:function(){var c=this.startContainer;if(this.collapsed||c[0].nodeType!=e.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||
c},createBookmark2:function(c){var h=this.startContainer,o=this.endContainer,q=this.startOffset,r=this.endOffset,B,O;if(!h||!o)return{start:0,end:0};if(c){if(h[0].nodeType==e.NODE_ELEMENT)if((B=new t(h[0].childNodes[q]))&&B[0]&&B[0].nodeType==e.NODE_TEXT&&q>0&&B[0].previousSibling.nodeType==e.NODE_TEXT){h=B;q=0}for(;h[0].nodeType==e.NODE_TEXT&&(O=h._4e_previous())&&O[0].nodeType==e.NODE_TEXT;){h=O;q+=O[0].nodeValue.length}if(!this.collapsed){if(o[0].nodeType==e.NODE_ELEMENT)if((B=new t(o[0].childNodes[r]))&&
B[0]&&B[0].nodeType==e.NODE_TEXT&&r>0&&B[0].previousSibling.nodeType==e.NODE_TEXT){o=B;r=0}for(;o[0].nodeType==e.NODE_TEXT&&(O=o._4e_previous())&&O[0].nodeType==e.NODE_TEXT;){o=O;r+=O[0].nodeValue.length}}}return{start:h._4e_address(c),end:this.collapsed?f:o._4e_address(c),startOffset:q,endOffset:r,normalized:c,is2:w}},createBookmark:function(c){var h,o,q,r,B=this.collapsed;h=new t("<span>",f,this.document);h.attr("_ke_bookmark",1);h.css("display","none");h.html("&nbsp;");if(c){q=g.guid("ke_bm_");
h.attr("id",q+"S")}if(!B){o=h._4e_clone();o.html("&nbsp;");c&&o.attr("id",q+"E");r=this.clone();r.collapse();r.insertNode(o)}r=this.clone();r.collapse(w);r.insertNode(h);if(o){this.setStartAfter(h);this.setEndBefore(o)}else this.moveToPosition(h,j.POSITION_AFTER_END);return{startNode:c?q+"S":h,endNode:c?q+"E":o,serializable:c,collapsed:B}},moveToPosition:function(c,h){this.setStartAt(c,h);this.collapse(w)},trim:function(c,h){var o=this.startContainer,q=this.startOffset,r=this.collapsed;if((!c||r)&&
o[0]&&o[0].nodeType==e.NODE_TEXT){if(q)if(q>=o[0].nodeValue.length){q=o._4e_index()+1;o=o.parent()}else{var B=o._4e_splitText(q);q=o._4e_index()+1;o=o.parent();if(a._4e_equals(this.startContainer,this.endContainer))this.setEnd(B,this.endOffset-this.startOffset);else if(a._4e_equals(o,this.endContainer))this.endOffset+=1}else{q=o._4e_index();o=o.parent()}this.setStart(o,q);if(r){this.collapse(w);return}}o=this.endContainer;q=this.endOffset;if(!(h||r)&&o[0]&&o[0].nodeType==e.NODE_TEXT){if(q){q>=o.nodeValue.length||
o._4e_splitText(q);q=o._4e_index()+1}else q=o._4e_index();o=o.parent();this.setEnd(o,q)}},insertNode:function(c){this.optimizeBookmark();this.trim(n,w);var h=this.startContainer,o=h[0].childNodes[this.startOffset];o?a.insertBefore(c[0]||c,o):h[0].appendChild(c[0]||c);a._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},moveToBookmark:function(c){if(c.is2){var h=b(this.document,c.start,c.normalized),o=c.startOffset,q=c.end&&b(this.document,c.end,c.normalized);c=c.endOffset;
this.setStart(h,o);q?this.setEnd(q,c):this.collapse(w)}else{h=(o=c.serializable)?g.one("#"+c.startNode,this.document):c.startNode;c=o?g.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(h);h._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(w)}},getCommonAncestor:function(c,h){var o=this.startContainer,q=this.endContainer;o=a._4e_equals(o,q)?c&&o[0].nodeType==e.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new t(o[0].childNodes[this.startOffset]):o:o._4e_commonAncestor(q);
return h&&o[0].nodeType==e.NODE_TEXT?o.parent():o},enlarge:function(c){switch(c){case j.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var h=new t(this.document.body),o,q,r,B,O,N=n,P,Q;P=this.startContainer;Q=this.startOffset;if(P[0].nodeType==e.NODE_TEXT){if(Q){P=!g.trim(P[0].nodeValue.substring(0,Q)).length&&P;N=!!P}if(P)if(!(B=P[0].previousSibling))r=P.parent()}else{if(Q)B=P[0].childNodes[Q-1]||P[0].lastChild;B||(r=P)}for(;r||B;){if(r&&!B){if(!O&&a._4e_equals(r,c))O=w;if(!h._4e_contains(r))break;
if(!N||r.css("display")!="inline"){N=n;if(O)o=r;else this.setStartBefore(r)}B=r[0].previousSibling}for(;B;){P=n;if(B.nodeType==e.NODE_TEXT){Q=B.nodeValue;if(/[^\s\ufeff]/.test(Q))B=f;P=/[\s\ufeff]$/.test(Q)}else if(B.offsetWidth>0&&!B.getAttribute("_ke_bookmark"))if(N&&m.$removeEmpty[B.nodeName.toLowerCase()]){Q=a.text(B);if(/[^\s\ufeff]/.test(Q))B=f;else for(var U=B.all||B.getElementsByTagName("*"),T=0,S;S=U[T++];)if(!m.$removeEmpty[S.nodeName.toLowerCase()]){B=f;break}if(B)P=!!Q.length}else B=f;
if(P)if(N)if(O)o=r;else r&&this.setStartBefore(r);else N=w;if(B){P=B.previousSibling;if(!r&&!P){r=new t(B);B=f;break}B=P}else r=f}if(r)r=r.parent()}P=this.endContainer;Q=this.endOffset;r=B=f;O=N=n;if(P[0].nodeType==e.NODE_TEXT){P=!g.trim(P[0].nodeValue.substring(Q)).length&&P;N=!(P&&P[0].nodeValue.length);if(P)if(!(B=P[0].nextSibling))r=P.parent()}else(B=P[0].childNodes[Q])||(r=P);for(;r||B;){if(r&&!B){if(!O&&a._4e_equals(r,c))O=w;if(!h._4e_contains(r))break;if(!N||r.css("display")!="inline"){N=n;
if(O)q=r;else r&&this.setEndAfter(r)}B=r[0].nextSibling}for(;B;){P=n;if(B.nodeType==e.NODE_TEXT){Q=B.nodeValue;if(/[^\s\ufeff]/.test(Q))B=f;P=/^[\s\ufeff]/.test(Q)}else if(B.offsetWidth>0&&!B.getAttribute("_ke_bookmark"))if(N&&m.$removeEmpty[B.nodeName.toLowerCase()]){Q=a.text(B);if(/[^\s\ufeff]/.test(Q))B=f;else{U=B.all||B.getElementsByTagName("*");for(T=0;S=U[T++];)if(!m.$removeEmpty[S.nodeName.toLowerCase()]){B=f;break}}if(B)P=!!Q.length}else B=f;if(P)if(N)if(O)q=r;else this.setEndAfter(r);if(B){P=
B.nextSibling;if(!r&&!P){r=new t(B);B=f;break}B=P}else r=f}if(r)r=r.parent()}if(o&&q){c=o._4e_contains(q)?q:o;this.setStartBefore(c);this.setEndAfter(c)}break;case j.ENLARGE_BLOCK_CONTENTS:case j.ENLARGE_LIST_ITEM_CONTENTS:r=new z(this.document);h=new t(this.document.body);r.setStartAt(h,j.POSITION_AFTER_START);r.setEnd(this.startContainer,this.startOffset);r=new k(r);var E,K,F=k.blockBoundary(c==j.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:f),I=function(J){var L=F(J);L||(E=J);return L};o=function(J){var L=
I(J);if(!L&&J[0]&&J._4e_name()=="br")K=J;return L};r.guard=I;r=r.lastBackward();E=E||h;this.setStartAt(E,E._4e_name()!="br"&&(!r&&this.checkStartOfBlock()||r&&E._4e_contains(r))?j.POSITION_AFTER_START:j.POSITION_AFTER_END);r=this.clone();r.collapse();r.setEndAt(h,j.POSITION_BEFORE_END);r=new k(r);r.guard=c==j.ENLARGE_LIST_ITEM_CONTENTS?o:I;E=f;r=r.lastForward();E=E||h;this.setEndAt(E,!r&&this.checkEndOfBlock()||r&&E._4e_contains(r)?j.POSITION_BEFORE_END:j.POSITION_BEFORE_START);K&&this.setEndAfter(K)}},
checkStartOfBlock:function(){var c=this.startContainer,h=this.startOffset;if(h&&c[0].nodeType==e.NODE_TEXT)if(g.trim(c[0].nodeValue.substring(0,h)).length)return n;this.trim();c=new v(this.startContainer);h=this.clone();h.collapse(w);h.setStartAt(c.block||c.blockLimit,j.POSITION_AFTER_START);c=new k(h);c.evaluator=x(w);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,h=this.endOffset;if(c[0].nodeType==e.NODE_TEXT)if(g.trim(c[0].nodeValue.substring(h)).length)return n;this.trim();
c=new v(this.endContainer);h=this.clone();h.collapse(n);h.setEndAt(c.block||c.blockLimit,j.POSITION_BEFORE_END);c=new k(h);c.evaluator=x(n);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,h){var o=this.clone();o[h==j.START?"setStartAt":"setEndAt"](c,h==j.START?j.POSITION_AFTER_START:j.POSITION_BEFORE_END);
o=new k(o);o.evaluator=C;return o[h==j.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,h=this.endContainer,o=this.startOffset,q=this.endOffset,r;if(c[0].nodeType==e.NODE_ELEMENT){r=c[0].childNodes.length;if(r>o)c=new t(c[0].childNodes[o]);else if(r<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new t(c);c=c._4e_nextSourceNode()||c}}if(h[0].nodeType==e.NODE_ELEMENT){r=h[0].childNodes.length;if(r>q)h=(new t(h[0].childNodes[q]))._4e_previousSourceNode(w);
else if(r<1)h=h._4e_previousSourceNode();else{for(h=h[0];h.lastChild;)h=h.lastChild;h=new t(h)}}if(c._4e_position(h)&y.POSITION_FOLLOWING)c=h;return{startNode:c,endNode:h}},fixBlock:function(c,h){var o=this.createBookmark(),q=new t(this.document.createElement(h));this.collapse(c);this.enlarge(j.ENLARGE_BLOCK_CONTENTS);q[0].appendChild(this.extractContents());q._4e_trim();d.ie||q._4e_appendBogus();this.insertNode(q);this.moveToBookmark(o);return q},splitBlock:function(c){var h=new v(this.startContainer),
o=new v(this.endContainer),q=h.block,r=o.block,B=f;if(!h.blockLimit._4e_equals(o.blockLimit))return f;if(c!="br"){if(!q){q=this.fixBlock(w,c);r=(new v(this.endContainer)).block}r||(r=this.fixBlock(n,c))}c=q&&this.checkStartOfBlock();h=r&&this.checkEndOfBlock();this.deleteContents();if(q&&a._4e_equals(q,r))if(h){B=new v(this.startContainer);this.moveToPosition(r,j.POSITION_AFTER_END);r=f}else if(c){B=new v(this.startContainer);this.moveToPosition(q,j.POSITION_BEFORE_START);q=f}else{r=this.splitElement(q);
!d.ie&&!g.inArray(q._4e_name(),["ul","ol"])&&q._4e_appendBogus()}return{previousBlock:q,nextBlock:r,wasStartOfBlock:c,wasEndOfBlock:h,elementPath:B}},splitElement:function(c){if(!this.collapsed)return f;this.setEndAt(c,j.POSITION_BEFORE_END);var h=this.extractContents(),o=c._4e_clone(n);o[0].appendChild(h);o.insertAfter(c);this.moveToPosition(c,j.POSITION_AFTER_END);return o},moveToElementEditablePosition:function(c,h){var o,q=p.XHTML_DTD;if(q.$empty[c._4e_name()])return n;for(;c&&c[0].nodeType==
e.NODE_ELEMENT;){if(o=c._4e_isEditable())this.moveToPosition(c,h?j.POSITION_BEFORE_END:j.POSITION_AFTER_START);else if(q.$inline[c._4e_name()]){this.moveToPosition(c,h?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);return w}if((c=q.$empty[c._4e_name()]?c[h?"_4e_previous":"_4e_next"](H):c[h?"_4e_last":"_4e_first"](H))&&c[0].nodeType==e.NODE_TEXT){this.moveToPosition(c,h?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);return w}}return o},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,
c[0].nodeType==e.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var i={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},D=new k.whitespaces,G=new k.bookmark;p.Range=z;p.Range=z;var s=z.prototype;p.Utils.extern(s,{updateCollapsed:s.updateCollapsed,optimize:s.optimize,setStartAfter:s.setStartAfter,setEndAfter:s.setEndAfter,setStartBefore:s.setStartBefore,setEndBefore:s.setEndBefore,
optimizeBookmark:s.optimizeBookmark,setStart:s.setStart,setEnd:s.setEnd,setStartAt:s.setStartAt,setEndAt:s.setEndAt,execContentsAction:s.execContentsAction,collapse:s.collapse,clone:s.clone,getEnclosedNode:s.getEnclosedNode,shrink:s.shrink,getTouchedStartNode:s.getTouchedStartNode,createBookmark2:s.createBookmark2,createBookmark:s.createBookmark,moveToPosition:s.moveToPosition,trim:s.trim,insertNode:s.insertNode,moveToBookmark:s.moveToBookmark,getCommonAncestor:s.getCommonAncestor,enlarge:s.enlarge,
checkStartOfBlock:s.checkStartOfBlock,checkEndOfBlock:s.checkEndOfBlock,deleteContents:s.deleteContents,extractContents:s.extractContents,checkBoundaryOfElement:s.checkBoundaryOfElement,getBoundaryNodes:s.getBoundaryNodes,fixBlock:s.fixBlock,splitBlock:s.splitBlock,splitElement:s.splitElement,moveToElementEditablePosition:s.moveToElementEditablePosition,selectNodeContents:s.selectNodeContents})});
KISSY.Editor.add("domiterator",function(p){function z(k){if(!(arguments.length<1)){this.range=k;this.forceBrBreak=H;this.enlargeBr=C;this.enforceRealBlocks=H;this._||(this._={})}}var C=true,H=false,x=KISSY,u=x.UA,A=p.Walker,w=p.Range,n=p.RANGE,f=p.NODE,g=p.ElementPath,e=x.Node,j=x.DOM,y=/^[\r\n\t ]*$/;x.augment(z,{getNextParagraph:function(k){var a,b,d,m,v;if(!this._.lastNode){b=this.range.clone();b.shrink(n.SHRINK_ELEMENT,C);b.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:
n.ENLARGE_BLOCK_CONTENTS);var t=new A(b),l=A.bookmark(C,C);t.evaluator=l;this._.nextNode=t.next();t=new A(b);t.evaluator=l;t=t.previous();this._.lastNode=t._4e_nextSourceNode(C);if(this._.lastNode&&this._.lastNode[0].nodeType==f.NODE_TEXT&&!x.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){l=new w(b.document);l.moveToPosition(this._.lastNode,n.POSITION_AFTER_END);if(l.checkEndOfBlock()){l=new g(l.endContainer);this._.lastNode=(l.block||l.blockLimit)._4e_nextSourceNode(C)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new e(b.document.createTextNode(""));j.insertAfter(this._.lastNode[0],t[0])}b=null}l=this._.nextNode;t=this._.lastNode;for(this._.nextNode=null;l;){var i=H,D=l[0].nodeType!=f.NODE_ELEMENT,G=H;if(D){if(l[0].nodeType==f.NODE_TEXT)if(y.test(l[0].nodeValue))D=H}else{var s=l._4e_name();if(l._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(s=="br")D=C;else if(!b&&!l[0].childNodes.length&&s!="hr"){a=l;d=l._4e_equals(t);break}if(b){b.setEndAt(l,n.POSITION_BEFORE_START);if(s!="br")this._.nextNode=
l}i=C}else{if(l[0].firstChild){if(!b){b=new w(this.range.document);b.setStartAt(l,n.POSITION_BEFORE_START)}l=new e(l[0].firstChild);continue}D=C}}if(D&&!b){b=new w(this.range.document);b.setStartAt(l,n.POSITION_BEFORE_START)}d=(!i||D)&&l._4e_equals(t);if(b&&!i)for(;!l[0].nextSibling&&!d;){s=l.parent();if(s._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){i=C;d||s._4e_equals(t);break}l=s;D=C;d=l._4e_equals(t);G=C}D&&b.setEndAt(l,n.POSITION_AFTER_END);l=l._4e_nextSourceNode(G,null,t);if((d=!l)||i&&b)break}if(!a){if(!b){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new g(b.startContainer);l=a.blockLimit;i={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&i[l._4e_name()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=l;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new e(this.range.document.createElement(k||"p"));a[0].appendChild(b.extractContents());a._4e_trim();b.insertNode(a);m=v=C}else if(a._4e_name()!="li"){if(!b.checkStartOfBlock()||!b.checkEndOfBlock()){a=a._4e_clone(H);
a[0].appendChild(b.extractContents());a._4e_trim();v=b.splitBlock();m=!v.wasStartOfBlock;v=!v.wasEndOfBlock;b.insertNode(a)}}else if(!d)this._.nextNode=a._4e_equals(t)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(C,null,t)}if(m){b=new e(a[0].previousSibling);if(b[0]&&b[0].nodeType==f.NODE_ELEMENT)if(b._4e_name()=="br")b._4e_remove();else b[0].lastChild&&j._4e_name(b[0].lastChild)=="br"&&j._4e_remove(b[0].lastChild)}if(v){b=A.bookmark(H,C);m=new e(a[0].lastChild);if(m[0]&&m[0].nodeType==f.NODE_ELEMENT&&
m._4e_name()=="br")if(u.ie||m._4e_previous(b)||m._4e_next(b))m._4e_remove()}if(!this._.nextNode)this._.nextNode=d||a._4e_equals(t)?null:a._4e_nextSourceNode(C,null,t);return a}});w.prototype.createIterator=function(){return new z(this)}});
KISSY.Editor.add("selection",function(p){function z(l){this.document=this.document=l;this._={cache:{}};if(n.ie){var i=this.getNative().createRange();if(!i||i.item&&i.item(0).ownerDocument!=l||i.parentElement&&i.parentElement().ownerDocument!=l)this.isInvalid=x}}function C(l){l=new z(l);return!l||l.isInvalid?A:l}function H(l){var i=l.document,D=new e(i.body),G=new e(i.documentElement);if(n.ie){if(n.ie<8||document.documentMode==7)G.on("click",function(N){f._4e_name(N.target)==="html"&&l.getSelection().getRanges()[0].select()});
var s,c,h=1;G.on("mousedown",function(){h=0});G.on("mouseup",function(){h=1});D.on("focusin",function(N){if(f._4e_name(N.target)=="body")if(s){try{h&&s.select()}catch(P){}s=A}});D.on("focus",function(){c=x;q()});D.on("beforedeactivate",function(N){if(!N.relatedTarget){c=u;h=1}});g.on(f._4e_getWin(i),"blur",function(){i&&i.selection.empty()});D.on("mousedown",function(){o()});D.on("mouseup",function(){c=x;setTimeout(function(){q(x)},0)});var o=function(){c=u},q=function(N){if(c){var P=l.document,Q=
l.getSelection(),U=Q&&Q.getType(),T=Q&&Q.getNative();if(N&&T&&U==j.SELECTION_NONE)if(!P.queryCommandEnabled("InsertImage")){setTimeout(function(){q(x)},50);return}var S;if(!(T&&U==j.SELECTION_TEXT&&(S=f._4e_name(T.createRange().parentElement()))&&S in{input:1,textarea:1})){s=T&&Q.getRanges()[0];l._monitor()}}};D.on("keydown",o);D.on("keyup",function(){c=x;q()});g.on(i,"selectionchange",q)}else{g.on(i,"mouseup",l._monitor,l);g.on(i,"keyup",l._monitor,l)}var r={table:1,pre:1},B=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;)?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
O=p.Walker.whitespaces(x);l.on("selectionChange",function(N){var P=N.path;N=(N=N.selection)&&N.getRanges()[0];var Q=P.blockLimit;if(N)if(N.collapse&&!P.block&&Q._4e_name()=="body"){P=N.fixBlock(x,"p");if(P._4e_outerHtml().match(B))if((Q=P._4e_next(O))&&Q[0].nodeType==k.NODE_ELEMENT&&!r[Q._4e_name()]){N.moveToElementEditablePosition(Q);P._4e_remove()}else if((Q=P._4e_previous(O))&&Q[0].nodeType==k.NODE_ELEMENT&&!r[Q._4e_name()]){N.moveToElementEditablePosition(Q,Q._4e_outerHtml().match(B)?u:x);P._4e_remove()}N.select();
n.ie||l.notifySelectionChange()}})}p.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var x=true,u=false,A=null,w=KISSY,n=w.UA,f=w.DOM,g=w.Event,e=w.Node,j=p.SELECTION,y=p.RANGE,k=p.NODE,a=p.Walker,b=p.Range,d={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};w.augment(z,{getNative:n.ie?function(){var l=this._.cache;return l.nativeSel||(l.nativeSel=this.document.selection)}:function(){var l=
this._.cache;return l.nativeSel||(l.nativeSel=f._4e_getWin(this.document).getSelection())},getType:n.ie?function(){var l=this._.cache;if(l.type)return l.type;var i=j.SELECTION_NONE;try{var D=this.getNative(),G=D.type;if(G=="Text")i=j.SELECTION_TEXT;if(G=="Control")i=j.SELECTION_ELEMENT;if(D.createRange().parentElement)i=j.SELECTION_TEXT}catch(s){}return l.type=i}:function(){var l=this._.cache;if(l.type)return l.type;var i=j.SELECTION_TEXT,D=this.getNative();if(D){if(D.rangeCount==1){D=D.getRangeAt(0);
var G=D.startContainer;if(G==D.endContainer&&G.nodeType==k.NODE_ELEMENT&&D.endOffset-D.startOffset===1&&d[G.childNodes[D.startOffset].nodeName.toLowerCase()])i=j.SELECTION_ELEMENT}}else i=j.SELECTION_NONE;return l.type=i},getRanges:n.ie?function(){var l=function(i,D){i=i.duplicate();i.collapse(D);for(var G=i.parentElement(),s=G.childNodes,c,h=0;h<s.length;h++){var o=s[h];if(o.nodeType==k.NODE_ELEMENT){c=i.duplicate();c.moveToElementText(o);o=c.compareEndPoints("StartToStart",i);var q=c.compareEndPoints("EndToStart",
i);c.collapse();if(o>0)break;else if(!o||q==1&&o==-1)return{container:G,offset:h};else if(!q)return{container:G,offset:h+1};c=A}}if(!c){c=i.duplicate();c.moveToElementText(G);c.collapse(u)}c.setEndPoint("StartToStart",i);c=c.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;c>0;)c-=s[--h].nodeValue.length}catch(r){c=0}return c===0?{container:G,offset:h}:{container:s[h],offset:-c}};return function(){var i=this._.cache;if(i.ranges)return i.ranges;var D=this.getNative(),G=D&&D.createRange(),s=this.getType();
if(!D)return[];if(s==j.SELECTION_TEXT){D=new b(this.document);s=l(G,x);D.setStart(new e(s.container),s.offset);s=l(G);D.setEnd(new e(s.container),s.offset);return i.ranges=[D]}else if(s==j.SELECTION_ELEMENT){i=i.ranges=[];for(s=0;s<G.length;s++){var c=G.item(s),h=c.parentNode,o=0;for(D=new b(this.document);o<h.childNodes.length&&h.childNodes[o]!=c;o++);D.setStart(new e(h),o);D.setEnd(new e(h),o+1);i.push(D)}return i}return i.ranges=[]}}():function(){var l=this._.cache;if(l.ranges)return l.ranges;
var i=[],D=this.getNative();if(!D)return[];for(var G=0;G<D.rangeCount;G++){var s=D.getRangeAt(G),c=new b(this.document);c.setStart(new e(s.startContainer),s.startOffset);c.setEnd(new e(s.endContainer),s.endOffset);i.push(c)}return l.ranges=i},getStartElement:function(){var l=this._.cache;if(l.startElement!==undefined)return l.startElement;var i,D=this.getNative();switch(this.getType()){case j.SELECTION_ELEMENT:return this.getSelectedElement();case j.SELECTION_TEXT:var G=this.getRanges()[0];if(G)if(!G.collapsed){for(G.optimize();x;){i=
G.startContainer;if(G.startOffset==(i[0].nodeType===k.NODE_ELEMENT?i[0].childNodes.length:i[0].nodeValue.length)&&!i._4e_isBlockBoundary())G.setStartAfter(i);else break}i=G.startContainer;if(i[0].nodeType!=k.NODE_ELEMENT)return i.parent();i=new e(i[0].childNodes[G.startOffset]);if(!i[0]||i[0].nodeType!=k.NODE_ELEMENT)return G.startContainer;for(G=i[0].firstChild;G&&G.nodeType==k.NODE_ELEMENT;){i=new e(G);G=G.firstChild}return i}if(n.ie){G=D.createRange();G.collapse(x);i=G.parentElement()}else if((i=
D.anchorNode)&&i.nodeType!=k.NODE_ELEMENT)i=i.parentNode}return l.startElement=i?f._4e_wrap(i):A},getSelectedElement:function(){var l=this,i,D=l._.cache;if(D.selectedElement!==undefined)return D.selectedElement;if(n.ie){i=l.getNative().createRange();i=i.item&&i.item(0)}i||(i=function(){for(var G=l.getRanges()[0],s,c,h=2;h&&!((s=G.getEnclosedNode())&&s[0].nodeType==k.NODE_ELEMENT&&d[s._4e_name()]&&(c=s));h--)G.shrink(y.SHRINK_ELEMENT);return c&&c[0]}());return D.selectedElement=f._4e_wrap(i)},reset:function(){this._.cache=
{}},selectElement:function(l){var i;if(n.ie)try{i=this.document.body.createControlRange();i.addElement(l[0]);i.select()}catch(D){i=this.document.body.createTextRange();i.moveToElementText(l[0]);i.select()}finally{}else{i=this.document.createRange();i.selectNode(l[0]);l=this.getNative();l.removeAllRanges();l.addRange(i)}this.reset()},selectRanges:function(l){if(n.ie){if(l.length>1){var i=l[l.length-1];l[0].setEnd(i.endContainer,i.endOffset);l.length=1}l[0]&&l[0].select()}else{i=this.getNative();if(!i)return;
i.removeAllRanges();for(var D=0;D<l.length;D++){var G=l[D],s=this.document.createRange(),c=G.startContainer;G.collapsed&&n.gecko&&n.gecko<1.09&&c[0].nodeType==k.NODE_ELEMENT&&!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));s.setStart(c[0],G.startOffset);s.setEnd(G.endContainer[0],G.endOffset);i.addRange(s)}}this.reset()},createBookmarks2:function(l){for(var i=[],D=this.getRanges(),G=0;G<D.length;G++)i.push(D[G].createBookmark2(l));return i},createBookmarks:function(l,i){var D=
[],G=this.document,s;i=i||this.getRanges();for(var c=i.length,h=0;h<c;h++){D.push(s=i[h].createBookmark(l,x));var o=(l=s.serializable)?w.one("#"+s.startNode,G):s.startNode;s=l?w.one("#"+s.endNode,G):s.endNode;for(var q=h+1;q<c;q++){var r=i[q],B=r.startContainer,O=r.endContainer;f._4e_equals(B,o.parent())&&r.startOffset++;f._4e_equals(B,s.parent())&&r.startOffset++;f._4e_equals(O,o.parent())&&r.endOffset++;f._4e_equals(O,s.parent())&&r.endOffset++}}return D},selectBookmarks:function(l){for(var i=[],
D=0;D<l.length;D++){var G=new b(this.document);G.moveToBookmark(l[D]);i.push(G)}this.selectRanges(i);return this},getCommonAncestor:function(){var l=this.getRanges();return l[0].startContainer._4e_commonAncestor(l[l.length-1].endContainer)},scrollIntoView:function(){var l=this.getStartElement();l&&l._4e_scrollIntoView()},removeAllRanges:function(){var l=this.getNative();if(n.ie)l&&l.clear();else l&&l.removeAllRanges()}});var m={table:1,tbody:1,tr:1},v=a.whitespaces(x),t=/\ufeff|\u00a0/;b.prototype.select=
b.prototype.select=n.ie?function(l){var i=this.collapsed,D,G;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var s=this.startContainer[0].childNodes[this.startOffset];if(s.nodeType==k.NODE_ELEMENT){(new z(this.document)).selectElement(new e(s));return}}if(this.startContainer[0].nodeType==k.NODE_ELEMENT&&this.startContainer._4e_name()in m||this.endContainer[0].nodeType==k.NODE_ELEMENT&&this.endContainer._4e_name()in m)this.shrink(y.SHRINK_ELEMENT,x);var c=this.createBookmark();
s=c.startNode;var h;if(!i)h=c.endNode;c=this.document.body.createTextRange();c.moveToElementText(s[0]);c.moveStart("character",1);if(h){l=this.document.body.createTextRange();l.moveToElementText(h[0]);c.setEndPoint("EndToEnd",l);c.moveEnd("character",-1)}else{for(D=s[0].nextSibling;D&&!v(D);)D=D.nextSibling;D=!(D&&D.nodeValue&&D.nodeValue.match(t))&&(l||!s[0].previousSibling||s[0].previousSibling&&f._4e_name(s[0].previousSibling)=="br");G=this.document.createElement("span");G.innerHTML="&#65279;";
G=new e(G);f.insertBefore(G[0],s[0]);D&&f.insertBefore(this.document.createTextNode("\ufeff"),s[0])}this.setStartBefore(s);s._4e_remove();if(i){if(D){c.moveStart("character",-1);c.select();this.document.selection.clear()}else c.select();if(G){this.moveToPosition(G,y.POSITION_BEFORE_START);G._4e_remove()}}else{this.setEndBefore(h);h._4e_remove();c.select()}}:function(){var l=this.startContainer;this.collapsed&&l[0].nodeType==k.NODE_ELEMENT&&!l[0].childNodes.length&&l[0].appendChild(this.document.createTextNode(""));
var i=this.document.createRange();i.setStart(l[0],this.startOffset);try{i.setEnd(this.endContainer[0],this.endOffset)}catch(D){if(D.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(x);i.setEnd(this.endContainer[0],this.endOffset)}else throw D;}l=C(this.document).getNative();l.removeAllRanges();l.addRange(i)};z.getSelection=C;p.Selection=z;p.Selection=z;a=z.prototype;p.Utils.extern(a,{getNative:a.getNative,getType:a.getType,getRanges:a.getRanges,getStartElement:a.getStartElement,getSelectedElement:a.getSelectedElement,
reset:a.reset,selectElement:a.selectElement,selectRanges:a.selectRanges,createBookmarks2:a.createBookmarks2,createBookmarks:a.createBookmarks,getCommonAncestor:a.getCommonAncestor,scrollIntoView:a.scrollIntoView,selectBookmarks:a.selectBookmarks,removeAllRanges:a.removeAllRanges});p.on("instanceCreated",function(l){H(l.editor)})});
KISSY.Editor.add("styles",function(p){function z(E,K){for(var F in E)E[F]=E[F].replace(T,function(I,J){return K[J]})}function C(E,K){if(K){E=i.clone(E);z(E.attributes,K);z(E.styles,K)}var F=this.element=this.element=(E.element||"*").toLowerCase();this.type=this.type=F=="#"||P[F]?s.STYLE_BLOCK:Q[F]?s.STYLE_OBJECT:s.STYLE_INLINE;this._={definition:E}}function H(E,K){var F=K?this.removeFromRange:this.applyToRange;E.body.focus();for(var I=new h(E),J=I.getRanges(),L=0;L<J.length;L++)F.call(this,J[L]);
I.selectRanges(J)}function x(E,K){var F;F=E.element;if(F=="*")F="span";F=new B(K.createElement(F));return u(F,E)}function u(E,K){var F=K._.definition,I=F.attributes;F=C.getStyleText(F);if(I)for(var J in I)E.attr(J,I[J]);if(F)E[0].style.cssText=F;return E}function A(E){var K=E.createBookmark(v),F=E.createIterator();F.enforceRealBlocks=v;F.enlargeBr=v;for(var I,J=E.document;I=F.getNextParagraph();){var L=x(this,J);I=I;var M=L;L=M._4e_name=="pre";var R=I._4e_name=="pre",Y=!L&&R;if(L&&!R){R=I;M=M;Y=R.html();
Y=w(Y,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");Y=Y.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");Y=Y.replace(/([ \t\n\r]+|&nbsp;)/g," ");Y=Y.replace(/<br\b[^>]*>/gi,"\n");if(O.ie){R=R[0].ownerDocument.createElement("div");R.appendChild(M[0]);M[0].outerHTML="<pre>"+Y+"</pre>";M=new B(R.firstChild);M._4e_remove()}else M.html(Y);M=M}else if(Y)M=f(n(I),M);else I._4e_moveChildren(M);I[0].parentNode.replaceChild(M[0],I[0]);if(L){I=M;L=void 0;if((L=I._4e_previousSourceNode(v,o.NODE_ELEMENT))&&L._4e_name()==
"pre"){M=w(L.html(),/\n$/,"")+"\n\n"+w(I.html(),/^\n/,"");if(O.ie)I[0].outerHTML="<pre>"+M+"</pre>";else I.html(M);L._4e_remove()}}}E.moveToBookmark(K)}function w(E,K,F){var I="",J="";E=E.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(L,M,R){M&&(I=M);R&&(J=R);return""});return I+E.replace(K,F)+J}function n(E){var K=[];w(E._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(F,I,J){return I+"</pre>"+J+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(F,I){K.push(I)});return K}function f(E,K){for(var F=K[0].ownerDocument.createDocumentFragment(),I=0;I<E.length;I++){var J=E[I];J=J.replace(/(\r\n|\r)/g,"\n");J=w(J,/^[ \t]*\n/,"");J=w(J,/\n$/,"");J=w(J,/^[ \t]+|[ \t]+$/g,function(M,R){return M.length==1?"&nbsp;":R?" "+Array(M.length).join("&nbsp;"):Array(M.length).join("&nbsp;")+" "});J=J.replace(/\n/g,"<br>");J=J.replace(/[ \t]{2,}/g,function(M){return Array(M.length).join("&nbsp;")+" "});var L=K._4e_clone();L.html(J);F.appendChild(L[0])}return F}
function g(E){var K=E.document;if(E.collapsed){K=x(this,K);E.insertNode(K);E.moveToPosition(K,c.POSITION_BEFORE_END)}else{var F=this.element,I=this._.definition,J,L=p.XHTML_DTD[F]||(J=v,p.XHTML_DTD.span),M=E.createBookmark();E.enlarge(c.ENLARGE_ELEMENT);E.trim();var R=E.createBookmark(),Y=R.startNode;R=R.endNode;for(var X=Y,$;X&&X[0];){var V=t;if(G._4e_equals(X,R)){X=l;V=v}else{var W=X[0].nodeType,ca=W==o.NODE_ELEMENT?X._4e_name():l;if(ca&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(v);continue}if(!ca||
L[ca]&&(X._4e_position(R)|q.POSITION_PRECEDING|q.POSITION_IDENTICAL|q.POSITION_IS_CONTAINED)==q.POSITION_PRECEDING+q.POSITION_IDENTICAL+q.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(X))){var Z=X.parent();if(Z&&Z[0]&&((p.XHTML_DTD[Z._4e_name()]||p.XHTML_DTD.span)[F]||J)&&(!I.parentRule||I.parentRule(Z))){if(!$&&(!ca||!p.XHTML_DTD.$removeEmpty[ca]||(X._4e_position(R)|q.POSITION_PRECEDING|q.POSITION_IDENTICAL|q.POSITION_IS_CONTAINED)==q.POSITION_PRECEDING+q.POSITION_IDENTICAL+q.POSITION_IS_CONTAINED)){$=
new r(K);$.setStartBefore(X)}if(W==o.NODE_TEXT||W==o.NODE_ELEMENT&&!X[0].childNodes.length){W=X;for(var aa;!W[0].nextSibling&&(aa=W.parent(),L[aa._4e_name()])&&(aa._4e_position(Y)|q.POSITION_FOLLOWING|q.POSITION_IDENTICAL|q.POSITION_IS_CONTAINED)==q.POSITION_FOLLOWING+q.POSITION_IDENTICAL+q.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(aa));)W=aa;$.setEndAfter(W);W[0].nextSibling||(V=v)}}else V=v}else V=v;X=X._4e_nextSourceNode()}if(V&&$&&!$.collapsed){V=x(this,K);for(W=$.getCommonAncestor();V&&
W&&V[0]&&W[0];){if(W._4e_name()==F){for(var ba in I.attributes)V.attr(ba)==W.attr(ba)&&V[0].removeAttribute(ba);for(var fa in I.styles)V._4e_style(fa)==W._4e_style(fa)&&V._4e_style(fa,"");if(!V._4e_hasAttributes()){V=l;break}}W=W.parent()}if(V){V[0].appendChild($.extractContents());W=V;ca=k(this);Z=W.all(this.element);for(var da=Z.length;--da>=0;)a(this,new B(Z[da]));var ea=void 0;for(ea in ca)if(ea!=this.element){Z=W.all(ea);for(da=Z.length-1;da>=0;da--){var ga=new B(Z[da]);d(ga,ca[ea])}}$.insertNode(V);
V._4e_mergeSiblings();O.ie||V[0].normalize()}$=l}}Y._4e_remove();R._4e_remove();E.moveToBookmark(M);E.shrink(c.SHRINK_TEXT)}}function e(E){E.enlarge(c.ENLARGE_ELEMENT);var K=E.createBookmark(),F=K.startNode;if(E.collapsed){for(var I=new N(F.parent()),J,L=0,M;L<I.elements.length&&(M=I.elements[L]);L++){if(M==I.block||M==I.blockLimit)break;if(this.checkElementRemovable(M)){var R=E.checkBoundaryOfElement(M,c.END),Y=!R&&E.checkBoundaryOfElement(M,c.START);if(Y||R){J=M;J.match=Y?"start":"end"}else{M._4e_mergeSiblings();
M._4e_name()==this.element?a(this,M):d(M,k(this)[M._4e_name()])}}}if(J&&J[0]){M=F;for(L=0;;L++){R=I.elements[L];if(G._4e_equals(R,J))break;else if(R.match)continue;else R=R._4e_clone();R[0].appendChild(M[0]);M=R}G[J.match=="start"?"insertBefore":"insertAfter"](M[0],J[0])}}else{var X=K.endNode,$=this;I=function(){for(var V=new N(F.parent()),W=new N(X.parent()),ca=l,Z=l,aa=0;aa<V.elements.length;aa++){var ba=V.elements[aa];if(ba==V.block||ba==V.blockLimit)break;if($.checkElementRemovable(ba))ca=ba}for(aa=
0;aa<W.elements.length;aa++){ba=W.elements[aa];if(ba==W.block||ba==W.blockLimit)break;if($.checkElementRemovable(ba))Z=ba}Z&&X._4e_breakParent(Z);ca&&F._4e_breakParent(ca)};I();for(J=new B(F[0].nextSibling);J[0]!==X[0];){L=J._4e_nextSourceNode();if(J[0]&&J[0].nodeType==o.NODE_ELEMENT&&this.checkElementRemovable(J)){J._4e_name()==this.element?a(this,J):d(J,k(this)[J._4e_name()]);if(L[0].nodeType==o.NODE_ELEMENT&&L._4e_contains(F)){I();L=new B(F[0].nextSibling)}}J=L}}E.moveToBookmark(K)}function j(E){var K=
{};E.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(F,I,J){K[I]=J});return K}function y(E,K){var F;if(K!==t){F=document.createElement("span");F.style.cssText=E;F=F.style.cssText||""}else F=E;return F.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function k(E){if(E._.overrides)return E._.overrides;var K=E._.overrides={},F=E._.definition.overrides;if(F){i.isArray(F)||(F=[F]);for(var I=0;I<F.length;I++){var J=F[I],L,M;if(typeof J==
"string")L=J.toLowerCase();else{L=J.element?J.element.toLowerCase():E.element;M=J.attributes}J=K[L]||(K[L]={});if(M){J=J.attributes=J.attributes||[];for(var R in M)J.push([R.toLowerCase(),M[R]])}}}return K}function a(E,K){var F=E._.definition,I=D.mix(F.attributes,k(E)[K._4e_name()]);F=F.styles;var J=i.isEmptyObject(I)&&i.isEmptyObject(F),L;for(L in I)if(!((L=="class"||E._.definition.fullMatch)&&K.attr(L)!=b(L,I[L]))){J=J||!!K._4e_hasAttribute(L);K.removeAttr(L)}for(var M in F)if(!(E._.definition.fullMatch&&
K._4e_style(M)!=b(M,F[M],v))){J=J||!!K._4e_style(M);K._4e_style(M,"")}m(K)}function b(E,K,F){var I=new B("<span>");I[F?"_4e_style":"attr"](E,K);return I[F?"_4e_style":"attr"](E)}function d(E,K){var F=K&&K.attributes;if(F)for(var I=0;I<F.length;I++){var J=F[I][0],L;if(L=E.attr(J)){var M=F[I][1];if(M===l||M.test&&M.test(L)||typeof M=="string"&&L==M)E[0].removeAttribute(J)}}m(E)}function m(E){if(!E._4e_hasAttributes()){var K=E[0].firstChild,F=E[0].lastChild;E._4e_remove(v);if(K){K.nodeType==o.NODE_ELEMENT&&
G._4e_mergeSiblings(K);F&&K!=F&&F.nodeType==o.NODE_ELEMENT&&G._4e_mergeSiblings(F)}}}var v=true,t=false,l=null,i=KISSY,D=p.Utils,G=i.DOM,s={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},c=p.RANGE,h=p.Selection,o=p.NODE,q=p.POSITION,r=p.Range,B=i.Node,O=i.UA,N=p.ElementPath,P={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},Q={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},U=/\s*(?:;\s*|$)/,T=/#\((.+?)\)/g;p.STYLE=s;C.prototype={apply:function(E){H.call(this,
E,t)},remove:function(E){H.call(this,E,v)},applyToRange:function(E){return(this.applyToRange=this.type==s.STYLE_INLINE?g:this.type==s.STYLE_BLOCK?A:this.type==s.STYLE_OBJECT?l:l).call(this,E)},removeFromRange:function(E){return(this.removeFromRange=this.type==s.STYLE_INLINE?e:l).call(this,E)},applyToObject:function(E){u(E,this)},checkElementRemovable:function(E,K){if(!E)return t;var F=this._.definition;if(E._4e_name()==this.element){if(!K&&!E._4e_hasAttributes())return v;var I=F._AC;if(I)F=I;else{I=
{};var J=0,L=F.attributes;if(L)for(var M in L){J++;I[M]=L[M]}if(L=C.getStyleText(F)){I.style||J++;I.style=L}I._length=J;F=F._AC=I}if(F._length){for(var R in F)if(R!="_length"){J=E.attr(R)||"";if(R=="style")a:{I=F[R];J=y(J,t);typeof I=="string"&&(I=j(I));typeof J=="string"&&(J=j(J));L=void 0;for(L in I)if(!(L in J&&(J[L]==I[L]||I[L]=="inherit"||J[L]=="inherit"))){I=t;break a}I=v}else I=F[R]==J;if(I){if(!K)return v}else if(K)return t}if(K)return v}else return v}if(R=k(this)[E._4e_name()]){if(!(F=R.attributes))return v;
for(I=0;I<F.length;I++){R=F[I][0];if(R=E.attr(R)){J=F[I][1];if(J===l||typeof J=="string"&&R==J||J.test&&J.test(R))return v}}}return t},checkActive:function(E){switch(this.type){case s.STYLE_BLOCK:return this.checkElementRemovable(E.block||E.blockLimit,v);case s.STYLE_OBJECT:case s.STYLE_INLINE:for(var K=E.elements,F=0,I;F<K.length;F++){I=K[F];if(!(this.type==s.STYLE_INLINE&&(G._4e_equals(I,E.block)||G._4e_equals(I,E.blockLimit))))if(!(this.type==s.STYLE_OBJECT&&!(I._4e_name()in Q)))if(this.checkElementRemovable(I,
v))return v}}return t}};C.getStyleText=function(E){var K=E._ST;if(K)return K;K=E.styles;var F=E.attributes&&E.attributes.style||"",I="";if(F.length)F=F.replace(U,";");for(var J in K){var L=K[J],M=(J+":"+L).replace(U,";");if(L=="inherit")I+=M;else F+=M}if(F.length)F=y(F);F+=I;return E._ST=F};p.Style=C;p.Style=C;var S=C.prototype;p.Utils.extern(S,{apply:S.apply,remove:S.remove,applyToRange:S.applyToRange,removeFromRange:S.removeFromRange,applyToObject:S.applyToObject,checkElementRemovable:S.checkElementRemovable,
checkActive:S.checkActive})});
KISSY.Editor.add("htmlparser",function(){function p(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var z=KISSY,C=function(){},H=z.Editor,x=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,u={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},A=H.XHTML_DTD;z.augment(p,{onTagOpen:C,onTagClose:C,
onText:C,onCDATA:C,onComment:C,parse:function(w){for(var n,f,g=0,e;n=this._.htmlPartsRegex.exec(w);){f=n.index;if(f>g){g=w.substring(g,f);e?e.push(g):this.onText(g)}g=this._.htmlPartsRegex.lastIndex;if(f=n[1]){f=f.toLowerCase();if(e&&A.$cdata[f]){this.onCDATA(e.join(""));e=null}if(!e){this.onTagClose(f);continue}}if(e)e.push(n[0]);else if(f=n[3]){f=f.toLowerCase();if(!/="/.test(f)){var j={},y;n=n[4];var k=!!(n&&n.charAt(n.length-1)=="/");if(n)for(;y=x.exec(n);){var a=y[1].toLowerCase();y=y[2]||y[3]||
y[4]||"";j[a]=!y&&u[a]?a:y}this.onTagOpen(f,j,k);if(!e&&A.$cdata[f])e=[]}}else if(f=n[2])this.onComment(f)}w.length>g&&this.onText(w.substring(g,w.length))}});H.HtmlParser=p;H.HtmlParser=p});
KISSY.Editor.add("htmlparser-basicwriter",function(){function p(){this._={output:[]}}var z=KISSY,C=z.Editor,H=C.Utils;z.augment(p,{openTag:function(x){this._.output.push("<",x)},openTagClose:function(x,u){u?this._.output.push(" />"):this._.output.push(">")},attribute:function(x,u){if(typeof u=="string")u=H.htmlEncodeAttr(u);this._.output.push(" ",x,'="',u,'"')},closeTag:function(x){this._.output.push("</",x,">")},text:function(x){this._.output.push(x)},comment:function(x){this._.output.push("<!--",
x,"--\>")},write:function(x){this._.output.push(x)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(x){var u=this._.output.join("");x&&this.reset();return u}});C.HtmlParser.BasicWriter=p;C.HtmlParser.BasicWriter=p;z=p.prototype;C.Utils.extern(z,{openTag:z.openTag,openTagClose:z.openTagClose,attribute:z.attribute,closeTag:z.closeTag,text:z.text,comment:z.comment,write:z.write,reset:z.reset,getHtml:z.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function p(){p.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=u;this.sortAttributes=x;this._.indent=u;this._.indentation="";this._.rules={};var A=C.XHTML_DTD,w;for(w in H.mix({},A.$nonBodyContent,A.$block,A.$listItem,A.$tableContent))this.setRules(w,{indent:x,breakBeforeOpen:x,breakAfterOpen:x,breakBeforeClose:!A[w]["#"],breakAfterClose:x});this.setRules("br",
{breakAfterOpen:x});this.setRules("title",{indent:u,breakAfterOpen:u});this.setRules("style",{indent:u,breakBeforeClose:x});this.setRules("pre",{indent:u})}var z=KISSY,C=z.Editor,H=C.Utils,x=true,u=false;z.extend(p,C.HtmlParser.BasicWriter,{openTag:function(A){var w=this._.rules[A];if(this._.indent)this.indentation();else if(w&&w.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",A)},openTagClose:function(A,w){var n=this._.rules[A];if(w)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(n&&n.indent)this._.indentation+=this.indentationChars}n&&n.breakAfterOpen&&this.lineBreak()},attribute:function(A,w){if(typeof w=="string"){this.forceSimpleAmpersand&&(w=w.replace(/&amp;/g,"&"));w=H.htmlEncodeAttr(w)}this._.output.push(" ",A,'="',w,'"')},closeTag:function(A){var w=this._.rules[A];if(w&&w.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(w&&w.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",A,">");w&&w.breakAfterClose&&this.lineBreak()},text:function(A){if(this._.indent){this.indentation();A=H.ltrim(A)}this._.output.push(A)},comment:function(A){this._.indent&&this.indentation();this._.output.push("<!--",A,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=x},indentation:function(){this._.output.push(this._.indentation);this._.indent=u},setRules:function(A,w){var n=this._.rules[A];if(n)H.mix(n,
w);else this._.rules[A]=w}});C.HtmlParser.HtmlWriter=p;C.HtmlParser.HtmlWriter=p;z=p.prototype;C.Utils.extern(z,{openTag:z.openTag,openTagClose:z.openTagClose,attribute:z.attribute,closeTag:z.closeTag,text:z.text,comment:z.comment,lineBreak:z.lineBreak,indentation:z.indentation,setRules:z.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function p(){this.children=[];this.parent=H;this._={isBlockLike:z,hasInlineStarted:C}}var z=true,C=false,H=null,x=KISSY.Editor,u={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},A=KISSY,w=x.Utils,n=x.NODE,f=x.XHTML_DTD,g=w.mix({table:1,ul:1,ol:1,dl:1},f.table,f.ul,f.ol,f.dl),e=f.$list,j=f.$listItem;p.FromHtml=function(y,k){function a(h){var o;if(t.length>0)for(var q=0;q<t.length;q++){var r=t[q],B=r.name,O=f[B],N=i.name&&f[i.name];
if((!N||N[B])&&(!h||!O||O[h]||!f[h])){if(!o){b();o=1}r=r.clone();r.parent=i;i=r;t.splice(q,1);q--}}}function b(){for(;l.length;)i.add(l.shift())}function d(h,o,q){o=o||i||v;if(k&&!o.type){var r,B;if((r=h.attributes&&(B=h.attributes._ke_real_element_type)?B:h.name)&&!(r in f.$body)&&!(r in f.$nonBodyContent)){r=i;i=o;m.onTagOpen(k,{});o=i;if(q)i=r}}if(h._.isBlockLike&&h.name!="pre"){q=h.children.length;if((r=h.children[q-1])&&r.type==n.NODE_TEXT)if(B=w.rtrim(r.value))r.value=B;else h.children.length=
q-1}o.add(h);if(h.returnPoint){i=h.returnPoint;delete h.returnPoint}}var m=new x.HtmlParser,v=new p,t=[],l=[],i=v,D=C,G;m.onTagOpen=function(h,o,q){var r=new x.HtmlParser.Element(h,o);if(r.isUnknown&&q)r.isEmpty=z;if(f.$removeEmpty[h])t.push(r);else{if(h=="pre")D=z;else if(h=="br"&&D){i.add(new x.HtmlParser.Text("\n"));return}if(h=="br")l.push(r);else{var B=i.name,O=B&&(f[B]||(i._.isBlockLike?f.div:f.span));if(O&&!r.isUnknown&&!i.isUnknown&&!O[h]){O=C;var N;if(h in e&&B in e){B=i.children;(B=B[B.length-
1])&&B.name in j||d(B=new x.HtmlParser.Element("li"),i);G=i;N=B}else if(h==B)d(i,i.parent);else{if(g[B])G||(G=i);else{d(i,i.parent,z);u[B]||t.unshift(i)}O=z}i=N?N:i.returnPoint||i.parent;if(O){m.onTagOpen.apply(this,arguments);return}}a(h);b();r.parent=i;r.returnPoint=G;G=0;if(r.isEmpty)d(r);else i=r}}};m.onTagClose=function(h){for(var o=t.length-1;o>=0;o--)if(h==t[o].name){t.splice(o,1);return}for(var q=[],r=[],B=i;B.type&&B.name!=h;){B._.isBlockLike||r.unshift(B);q.push(B);B=B.parent}if(B.type){for(o=
0;o<q.length;o++){var O=q[o];d(O,O.parent)}i=B;if(i.name=="pre")D=C;B._.isBlockLike&&b();d(B,B.parent);if(B==i)i=i.parent;t=t.concat(r)}if(h=="body")k=C};m.onText=function(h){if(!i._.hasInlineStarted&&!D){h=w.ltrim(h);if(h.length===0)return}b();a();if(k&&(!i.type||i.name=="body")&&w.trim(h))this.onTagOpen(k,{});D||(h=h.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));i.add(new x.HtmlParser.Text(h))};m.onCDATA=function(){};m.onComment=function(h){i.add(new x.HtmlParser.Comment(h))};m.parse(y);for(b();i.type;){var s=
i.parent,c=i;if(k&&(!s.type||s.name=="body")&&!f.$body[c.name]){i=s;m.onTagOpen(k,{});s=i}s.add(c);i=s}return v};A.augment(p,{add:function(y){var k=this.children.length;if(k=k>0&&this.children[k-1]||H){if(y._.isBlockLike&&k.type==n.NODE_TEXT){k.value=w.rtrim(k.value);if(k.value.length===0){this.children.pop();this.add(y);return}}k.next=y}y.previous=k;y.parent=this;this.children.push(y);this._.hasInlineStarted=y.type==n.NODE_TEXT||y.type==n.NODE_ELEMENT&&!y._.isBlockLike},writeHtml:function(y,k){var a;
this.filterChildren=this.filterChildren=function(){var b=new x.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,b,k,z);b=b.getHtml();this.children=(new p.FromHtml(b)).children;a=1};!this.name&&k&&k.onFragment(this);this.writeChildrenHtml(y,a?H:k)},writeChildrenHtml:function(y,k){for(var a=0;a<this.children.length;a++)this.children[a].writeHtml(y,k)}});x.HtmlParser.Fragment=p;x.HtmlParser.Fragment=p;p.FromHtml=p.FromHtml;A=p.prototype;x.Utils.extern(A,{add:A.add,writeHtml:A.writeHtml,writeChildrenHtml:A.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function p(u,A){this.name=u;this.attributes=A||(A={});this.children=[];var w=A._ke_real_element_type||u,n=z.XHTML_DTD;w=!!(n.$nonBodyContent[w]||n.$block[w]||n.$listItem[w]||n.$tableContent[w]||n.$nonEditable[w]||w=="br");var f=!!n.$empty[u];this.isEmpty=f;this.isUnknown=!n[u];this._={isBlockLike:w,hasInlineStarted:f||!w}}var z=KISSY.Editor,C=z.NODE,H=function(u,A){u=u[0];A=A[0];return u<A?-1:u>A?1:0};KISSY.augment(p,{type:C.NODE_ELEMENT,add:z.HtmlParser.Fragment.prototype.add,
clone:function(){return new p(this.name,this.attributes)},writeHtml:function(u,A){var w=this.attributes,n=this,f=n.name,g,e,j,y;n.filterChildren=function(){if(!y){var b=new z.HtmlParser.BasicWriter;z.HtmlParser.Fragment.prototype.writeChildrenHtml.call(n,b,A);n.children=(new z.HtmlParser.Fragment.FromHtml(b.getHtml())).children;y=1}};n.filterChildren=n.filterChildren;if(A){for(;;){if(!(f=A.onElementName(f)))return;n.name=f;if(!(n=A.onElement(n)))return;n.parent=this.parent;if(n.name==f)break;if(n.type!=
C.NODE_ELEMENT){n.writeHtml(u,A);return}f=n.name;if(!f){this.writeChildrenHtml.call(n,u,y?null:A);return}}w=n.attributes}u.openTag(f,w);for(var k=[],a=0;a<2;a++)for(g in w){e=g;j=w[g];if(a==1)k.push([g,j]);else if(A){for(;;)if(e=A.onAttributeName(g))if(e!=g){delete w[g];g=e}else break;else{delete w[g];break}if(e)if((j=A.onAttribute(n,e,j))===false)delete w[e];else w[e]=j}}u.sortAttributes&&k.sort(H);w=k.length;for(a=0;a<w;a++){g=k[a];u.attribute(g[0],g[1])}u.openTagClose(f,n.isEmpty);if(!n.isEmpty){this.writeChildrenHtml.call(n,
u,y?null:A);u.closeTag(f)}},writeChildrenHtml:function(){z.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});z.HtmlParser.Element=p;z.HtmlParser.Element=p;var x=p.prototype;z.Utils.extern(x,{type:x.type,add:x.add,clone:x.clone,writeHtml:x.writeHtml,writeChildrenHtml:x.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function p(g){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};g&&this.addRules(g,10)}function z(g,e){for(var j=0;g&&j<e.length;j++){var y=e[j];g=g.replace(y[0],y[1])}return g}function C(g,e,j){if(typeof e=="function")e=[e];var y,k;k=g.length;var a=e&&e.length;if(a){for(y=0;y<k&&g[y].pri<j;y++);for(k=a-1;k>=0;k--)if(a=e[k]){a.pri=j;g.splice(y,0,a)}}}function H(g,e,j){if(e)for(var y in e){var k=g[y];g[y]=x(k,e[y],
j);k||g.$length++}}function x(g,e,j){if(e){e.pri=j;if(g){if(g.splice)C(g,e,j);else{g=g.pri>j?[e,g]:[g,e];g.filter=u}return g}else return e.filter=e}}function u(g){for(var e=g.type||g instanceof w.HtmlParser.Fragment,j=0;j<this.length;j++){if(e)var y=g.type,k=g.name;var a=this[j].apply(window,arguments);if(a===f)return a;if(e){if(a&&(a.name!=k||a.type!=y))return a}else if(typeof a!="string")return a;a!=undefined&&(g=a)}return g}var A=KISSY,w=A.Editor,n=w.NODE,f=false;A.augment(p,{addRules:function(g,
e){if(typeof e!="number")e=10;C(this._.elementNames,g.elementNames,e);C(this._.attributeNames,g.attributeNames,e);H(this._.elements,g.elements,e);H(this._.attributes,g.attributes,e);this._.text=x(this._.text,g.text,e)||this._.text;this._.comment=x(this._.comment,g.comment,e)||this._.comment;this._.root=x(this._.root,g.root,e)||this._.root},onElementName:function(g){return z(g,this._.elementNames)},onAttributeName:function(g){return z(g,this._.attributeNames)},onText:function(g){var e=this._.text;
return e?e.filter(g):g},onComment:function(g,e){var j=this._.comment;return j?j.filter(g,e):g},onFragment:function(g){var e=this._.root;return e?e.filter(g):g},onElement:function(g){for(var e=[this._.elements["^"],this._.elements[g.name],this._.elements.$],j,y=0;y<3;y++)if(j=e[y]){j=j.filter(g,this);if(j===f)return null;if(j&&j!=g)return this.onNode(j);if(g.parent&&!g.name)break}return g},onNode:function(g){var e=g.type;return e==n.NODE_ELEMENT?this.onElement(g):e==n.NODE_TEXT?new w.HtmlParser.Text(this.onText(g.value)):
null},onAttribute:function(g,e,j){if(e=this._.attributes[e]){g=e.filter(j,g,this);if(g===f)return f;if(typeof g!="undefined")return g}return j}});w.HtmlParser.Filter=p;A=p.prototype;w.Utils.extern(A,{addRules:A.addRules,onElementName:A.onElementName,onAttributeName:A.onAttributeName,onText:A.onText,onComment:A.onComment,onFragment:A.onFragment,onElement:A.onElement,onNode:A.onNode,onAttribute:A.onAttribute});w.HtmlParser.Filter=p});
KISSY.Editor.add("htmlparser-text",function(){function p(x){this.value=x;this._={isBlockLike:H}}var z=KISSY,C=z.Editor,H=false;z.augment(p,{type:C.NODE.NODE_TEXT,writeHtml:function(x,u){var A=this.value;u&&!(A=u.onText(A,this))||x.text(A)}});C.HtmlParser.Text=p;C.HtmlParser.Text=p});
KISSY.Editor.add("htmlparser-comment",function(){function p(H){this.value=H;this._={isBlockLike:false}}var z=KISSY.Editor,C=z.NODE;z.HtmlParser.Comment=p;z.HtmlParser.Comment=p;p.prototype={constructor:p,type:C.NODE_COMMENT,writeHtml:function(H,x){var u=this.value;if(x){if(!(u=x.onComment(u,this)))return;if(typeof u!="string"){u.parent=this.parent;u.writeHtml(H,x);return}}H.comment(u)}}});
