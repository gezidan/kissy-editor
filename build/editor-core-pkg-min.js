KISSY.add("editor",function(z,H){function I(m,p){var a=this;if(!(a instanceof I))return new I(m,p);if(z.isString(m))m=z.one(m);m=D._4e_wrap(m);p=p||{};p.pluginConfig=p.pluginConfig||{};a.cfg=p;z.app(a,z.EventTarget);a.use=function(c,d){if(z.isString(c))c=c.split(",");var e=c,g=[];g=z.indexOf("separator",e);var k=g!=-1;g=e.splice(0,k?g+1:e.length);k&&g.pop();g.length!=0?z.use.call(a,g.join(","),function(){k&&a.addPlugin(function(){I.Utils.addSeparator(a.toolBarDiv)});a.use(e,d)},{order:true,global:I}):
a.on("dataReady",function(){d&&d.call(a);a.setData(m.val());a.fire("save")});return a};a.init(m);return H}function x(m){if(!C)return m.replace(/\.(js|css)/i,"-min.$1");if(C==="dev")return"../src/"+m;return m}var D=z.DOM;z.app(I,z.EventTarget);I.Config.base=z.Config.base+"editor/";var C=z.Config.debug,q={htmlparser:{attach:false,path:x("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},r=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection",
"styles"],i=["flashbridge","flashutils","clipboard",{name:"colorsupport",requires:["overlay"]},{name:"forecolor",requires:["colorsupport"]},{name:"bgcolor",requires:["colorsupport"]},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["flashutils","contextmenu","fakeobjects","overlay","bubbleview"]},{name:"font",
requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview"]},"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize",{name:"music",requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},"sourcearea",{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",requires:["dd"]}],l=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},
{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],s,u,E,B;s=0;for(u=i.length;s<u;s++){E=i[s];if(z.isString(E))E=i[s]={name:E};E.requires=E.requires||[];E.requires=E.requires.concat(["button"])}i=
[{name:"localStorage",requires:["flashutils","flashbridge"]},{name:"button"},{name:"dd"},{name:"progressbar"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(i);s=0;for(u=i.length;s<u;s++){E=i[s];B=E.name;q[B]={attach:false,requires:E.requires,csspath:E.useCss?x("plugins/"+B+"/plugin.css"):H,path:x("plugins/"+B+"/plugin.js")}}s=0;for(u=l.length;s<u;s++){E=l[s];i=H;if(!z.isString(E)){i=
E.requires;E=E.name}q[E]={attach:false,requires:i,path:x("plugins/htmldataprocessor/htmlparser/"+E.substring(11)+".js")}}s=0;for(u=r.length;s<u;s++){E=r[s];q[E]={host:"editor",requires:s>0?r[s-1]:[]}}I.add(q);z.Editor=I});
KISSY.Editor.add("utils",function(z){var H=KISSY,I=H.Node,x=H.DOM,D=H.Config.debug,C=H.UA;z.Utils={debugUrl:function(q){if(!D)return q.replace(/\.(js|css)/i,"-min.$1");if(D==="dev")return"../src/"+q;return q},lazyRun:function(q,r,i){var l=q[r],s=q[i];q[r]=function(){l.apply(this,arguments);q[r]=q[i];return s.apply(this,arguments)}},getXY:function(q,r,i,l){i=i.defaultView||i.parentWindow;q-=x.scrollLeft(i);r-=x.scrollTop(i);if(l)if(i!=(l.defaultView||l.parentWindow)&&i.frameElement){l=x._4e_getOffset(i.frameElement,
l);q+=l.left;r+=l.top}return{left:q,top:r}},tryThese:function(){for(var q,r=0,i=arguments.length;r<i;r++){var l=arguments[r];try{q=l();break}catch(s){}}return q},arrayCompare:function(q,r){if(!q&&!r)return true;if(!q||!r||q.length!=r.length)return false;for(var i=0;i<q.length;i++)if(q[i]!==r[i])return false;return true},getByAddress:function(q,r,i){q=q.documentElement;for(var l=0;q&&l<r.length;l++){var s=r[l];if(i)for(var u=-1,E=0;E<q.childNodes.length;E++){var B=q.childNodes[E];if(!(i===true&&B.nodeType==
3&&B.previousSibling&&B.previousSibling.nodeType==3)){u++;if(u==s){q=B;break}}}else q=q.childNodes[s]}return q?new I(q):null},clearAllMarkers:function(q){for(var r in q)q[r]._4e_clearMarkers(q,true)},htmlEncodeAttr:function(q){return q.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(q){return q.replace(/^\s+/,"")},rtrim:function(q){return q.replace(/\s+$/,"")},trim:function(q){return this.ltrim(this.rtrim(q))},mix:function(){for(var q={},r=0;r<arguments.length;r++)q=
H.mix(q,arguments[r]);return q},isCustomDomain:function(){if(!C.ie)return false;var q=document.domain,r=window.location.hostname;return q!=r&&q!="["+r+"]"},addSeparator:function(q){(new H.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(q)},duplicateStr:function(q,r){return Array(r+1).join(q)},throttle:function(q,r,i){i=i||150;if(i===-1)return function(){q.apply(r,arguments)};var l=(new Date).getTime();return function(){var s=(new Date).getTime();if(s-l>i){l=s;q.apply(r,arguments)}}},
buffer:function(q,r,i){i=i||0;var l=null;return function(){l&&clearTimeout(l);var s=arguments;l=setTimeout(function(){return q.apply(r,s)},i)}},isNumber:function(q){return/^\d+(.\d+)?$/.test(H.trim(q))},verifyInputs:function(q){for(var r=0;r<q.length;r++){var i=x._4e_wrap(q[r]),l=H.trim(i.val()),s=i.attr("data-verify");i=i.attr("data-warning");if(s&&!RegExp(s).test(l)){alert(i);return}}return true},sourceDisable:function(q,r){q.on("sourcemode",r.disable,r);q.on("wysiwygmode",r.enable,r)},resetInput:function(q){var r=
q.attr("placeholder");if(r&&!C.webkit){q.val(r);q.addClass(".ke-input-tip")}},placeholder:function(q,r){q.attr("placeholder",r);if(!C.webkit){q.on("blur",function(){if(!H.trim(q.val())){q.val(r);q.addClass(".ke-input-tip")}});q.on("focus",function(){H.trim(q.val())==r&&q.val("");q.removeClass(".ke-input-tip")})}}}});
KISSY.Editor.add("focusmanager",function(z){function H(){this.iframeFocus=true;r=this}function I(){this.iframeFocus=false;r=null}var x=KISSY,D=x.DOM,C=x.Event;x={};var q={},r;x={refreshAll:function(){for(var i in q){var l=q[i];l.document.designMode="off";l.document.designMode="on"}},currentInstance:function(){return r},getInstance:function(i){return q[i]},add:function(i){var l=D._4e_getWin(i.document);C.on(l,"focus",H,i);C.on(l,"blur",I,i)},register:function(i){q[i._UUID]=i},remove:function(i){delete q[i._UUID];
var l=D._4e_getWin(i.document);C.remove(l,"focus",H,i);C.remove(l,"blur",I,i)}};z.focusManager=x});
KISSY.Editor.add("definition",function(z){function H(m){return l+"<html><head><title>kissy-editor</title><link href='"+z.Config.base+s+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(m?'<script id="ke_actscrpt" type="text/javascript">'+(z.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+m+'");<\/script>':"")}var I=KISSY,x=I.UA,D=I.DOM,C=I.Node,q=I.Event,r=z.focusManager,i=z.Utils.tryThese,l="<!doctype html>",s=
z.Utils.debugUrl("theme/editor-iframe.css"),u=1,E="document.open();"+(z.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",B="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(x.ie?"javascript:void(function(){"+encodeURIComponent(E)+"}())":"")+'"  tabIndex="'+
(x.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";z.SOURCE_MODE=0;z.WYSIWYG_MODE=1;I.augment(z,{init:function(m){if(x.ie)D.addClass(document.body,"ie"+x.ie);else if(x.gecko)D.addClass(document.body,"gecko");else x.webkit&&D.addClass(document.body,"webkit");var p=this,a=new C(B.replace(/\$\(tabIndex\)/,m.attr("tabIndex")));a.on("mousedown",function(e){if(x.webkit){var g=D._4e_name(e.target);if(g=="select"||g=="option")return true}e.halt()});
p.editorWrap=a;p._UUID=u++;r.register(p);p.wrap=a.one(".ke-textarea-wrap");p.iframe=p.wrap.one("iframe");p.toolBarDiv=a.one(".ke-editor-tools");p.textarea=m;p.statusDiv=a.one(".ke-editor-status");p.toolBarDiv._4e_unselectable();p._commands={};var c=m._4e_style("width"),d=m._4e_style("height");if(c){a.css("width",c);m.css("width","100%")}p.textarea.css("display","none");a.insertAfter(m);p.wrap[0].appendChild(m[0]);if(d){p.wrap.css("height",d);m.css("height","100%")}m=p.iframe;p.on("dataReady",function(){p.ready=
true;z.fire("instanceCreated",{editor:p})});x.gecko?m.on("load",p._setUpIFrame,p):p._setUpIFrame()},addCommand:function(m,p){this._commands[m]=p},hasCommand:function(m){return this._commands[m]},execCommand:function(m){this.fire("save");m=this._commands[m].exec(this);this.fire("save");return m},getMode:function(){return this.textarea.css("display")=="none"?z.WYSIWYG_MODE:z.SOURCE_MODE},getData:function(){var m;m=this.getMode()==z.WYSIWYG_MODE?this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(m,
"p");return m},setData:function(m){if(this.htmlDataProcessor)m=this.htmlDataProcessor.toDataFormat(m,"p");this.document.body.innerHTML=m;if(this.getMode()==z.WYSIWYG_MODE)this.document.body.innerHTML=m;else this.textarea.val(m)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(m){this.document.body.innerHTML=m},_hideSource:function(){this.iframe.css("display","");this.textarea.css("display","none");this.fire("wysiwygmode")},
_showSource:function(){this.textarea.css("display","");this.iframe.css("display","none");x.ie<8&&this.textarea.css("height",this.wrap.css("height"));this.fire("sourcemode")},_prepareIFrameHtml:H,getSelection:function(){var m=new z.Selection(this.document);return!m||m.isInvalid?null:m},focus:function(){var m=D._4e_getWin(this.document);x.webkit&&m&&m.parent&&m.parent.focus();m&&m.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){D._4e_getWin(this.document).blur();
this.document&&this.document.body.blur()},_setUpIFrame:function(){function m(){e=d.document;p.document=e;a.detach();e.open("text/html","replace");e.write(c);e.close()}var p=this,a=p.iframe,c=H(p._UUID),d=a[0].contentWindow,e;try{e=d.document}catch(g){a[0].src=a[0].src;if(x.ie&&x.ie<7){setTimeout(m,10);return}}m()},addPlugin:function(m){this.ready?m():this.on("dataReady",m)},_monitor:function(){var m=this;m._monitorId&&clearTimeout(m._monitorId);m._monitorId=setTimeout(function(){var p=m.getSelection();
if(p&&!p.isInvalid){p=p.getStartElement();var a=new z.ElementPath(p);if(!m.previousPath||!m.previousPath.compare(a)){m.previousPath=a;m.fire("selectionChange",{selection:m,path:a,element:p})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(m,p){var a=this;a.focus();var c=m._4e_name(),d=z.XHTML_DTD,e=z.RANGE,g=z.NODE,k=d.$block[c],b=a.getSelection(),f=b.getRanges(),h,j,n,v,K;a.fire("save");for(var O=f.length-1;O>=0;O--){h=f[O];h.deleteContents();
j=!O&&m||m._4e_clone(true);p&&p(j);if(k)for(;(v=h.getCommonAncestor(false,true))&&(K=d[v._4e_name()])&&!(K&&K[c]);)if(v._4e_name()in d.span)h.splitElement(v);else if(h.checkStartOfBlock()&&h.checkEndOfBlock()){h.setStartBefore(v);h.collapse(true);v._4e_remove()}else h.splitBlock();h.insertNode(j);n||(n=j)}c=n._4e_nextSourceNode(true);d=a.document;K=z.XHTML_DTD;if(K.$inline[j._4e_name()]){c=new C(d.createTextNode(" "));c.insertAfter(n)}else if(c){if(c._4e_name()=="br"&&K[c.parent()._4e_name()].p){K=
new C("<p>&nbsp;</p>",null,d);c[0].parentNode.replaceChild(K[0],c[0]);c=K}}else{K=new C("<p>&nbsp;</p>",null,d);K.insertAfter(n);c=K}h.moveToPosition(n,e.POSITION_AFTER_END);c&&c[0].nodeType==g.NODE_ELEMENT&&h.moveToElementEditablePosition(c);b.selectRanges([h]);a.focus();j&&j._4e_scrollIntoView();setTimeout(function(){a.fire("save")},10);return j},insertHtml:function(m){var p=this;if(p.htmlDataProcessor)m=p.htmlDataProcessor.toDataFormat(m);if(x.webkit){m=D.create(m,null,this.document);m=m.nodeType==
11?I.makeArray(m.childNodes):[m];for(var a=0;a<m.length;a++)p.insertElement(new C(m[a]))}else{p.focus();p.fire("save");a=p.getSelection();if(x.ie){a=a.getNative();a.type=="Control"&&a.clear();a.createRange().pasteHTML(m)}else p.document.execCommand("inserthtml",false,m);p.focus();setTimeout(function(){p.fire("save")},10)}}});z._initIFrame=function(m){function p(j){i(function(){d.designMode="on";setTimeout(function(){d.designMode="off";k.focus();if(!arguments.callee.retry)arguments.callee.retry=true},
10)},function(){d.designMode="off";D.attr(k,"contentEditable",false);D.attr(k,"contentEditable",true);!j&&p(1)})}var a=r.getInstance(m);m=a.textarea[0];var c=a.iframe[0].contentWindow,d=a.document,e=a.cfg,g=d.getElementById("ke_actscrpt");g.parentNode.removeChild(g);var k=d.body;if(x.ie){k.hideFocus=true;k.disabled=true;k.contentEditable=true;k.removeAttribute("disabled")}else setTimeout(function(){if(x.gecko||x.opera)k.contentEditable=true;else if(x.webkit)k.parentNode.contentEditable=true;else d.designMode=
"on"},0);if(x.webkit){q.on(d,"click",function(j){var n=new C(j.target);I.inArray(n._4e_name(),["input","select"])&&j.preventDefault()});q.on(d,"mouseup",function(j){var n=new C(j.target);I.inArray(n._4e_name(),["input","textarea"])&&j.preventDefault()})}if(x.gecko||x.ie||x.opera){var b;b=new C(D.insertAfter((new C('<span style="position:absolute; left:-10000"></span>'))[0],m));b.on("focus",function(){a.focus()});a.on("destroy",function(){})}if(x.ie&&d.compatMode=="CSS1Compat"||x.gecko||x.opera){var f=
new C(d.documentElement);f.on("mousedown",function(j){if(j.target===f[0]){x.gecko&&p(false);b[0].focus()}})}q.on(c,"focus",function(){if(x.gecko)p(false);else x.opera&&k.focus();a.notifySelectionChange()});x.gecko&&q.on(a.document,"mousedown",function(){a.iframeFocus||p(false)});if(x.ie){q.on(d,"keydown",function(j){if(j.keyCode in{8:1,46:1}){var n=a.getSelection(),v=n.getSelectedElement();if(v){a.fire("save");var K=n.getRanges()[0].createBookmark();v._4e_remove();n.selectBookmarks([K]);a.fire("save");
j.preventDefault()}}});if(d.compatMode=="CSS1Compat"){var h={33:1,34:1};q.on(d,"keydown",function(j){j.keyCode in h&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){x.ie&&setTimeout(function(){if(d){k.runtimeStyle.marginBottom="0px";k.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady");var j=e.disableObjectResizing,n=e.disableInlineTableEditing;if(j||n)try{d.execCommand("enableObjectResizing",false,!j);d.execCommand("enableInlineTableEditing",
false,!n)}catch(v){q.on(k,x.ie?"resizestart":"resize",function(K){if(j||D._4e_name(K.target)==="table"&&n)K.preventDefault()})}},10);x.webkit&&q.on(d,"mousedown",function(j){j=new C(j.target);I.inArray(j._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(j)});x.gecko&&q.on(d,"dragstart",function(j){var n=new C(j.target);n._4e_name()==="img"&&/ke_/.test(n[0].className)&&j.preventDefault()});r.add(a)};x.gecko&&function(){var m=document.body;if(m){var p=m.getAttribute("onpageshow");
m.setAttribute("onpageshow",(p?p+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(z){z.XHTML_DTD=function(){var H=function(k){for(var b=arguments.length-1;b>0;)KISSY.mix(k,arguments[b--]);return k},I={isindex:1,fieldset:1},x={input:1,button:1,select:1,textarea:1,label:1},D=H({a:1},x),C=H({iframe:1},D),q={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},r={ins:1,del:1,script:1,style:1},i=H({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},r),l=H({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},i),s=H({p:1},l);x=H({iframe:1},l,x);l={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var u=H({a:1},x),E={tr:1},B={"#":1},m=H({param:1},l),p=H({form:1},I,C,q,s),a={li:1},c={base:1,link:1,meta:1,title:1},d=H(c,{style:1,script:1}),e={head:1,body:1},g={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:H({html:1},e,c),$block:g,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:u,$body:H({script:1,style:1},g),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:e,head:d,style:B,body:p,base:{},link:{},meta:{},title:B,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:p,td:p,br:{},th:p,center:p,kbd:u,button:H(s,q),basefont:{},h5:u,h4:u,samp:u,h6:u,ol:a,h1:u,h3:u,option:B,h2:u,form:H(I,C,q,s),select:{optgroup:1,option:1},font:u,ins:u,menu:a,abbr:u,label:u,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:u,script:B,tfoot:E,cite:u,li:p,input:{},iframe:p,strong:u,textarea:B,noframes:p,big:u,small:u,span:u,hr:{},dt:u,sub:u,optgroup:{option:1},param:{},bdo:u,"var":u,div:p,object:m,sup:u,dd:p,strike:u,area:{},dir:a,map:H({area:1,form:1,p:1},I,r,q),applet:m,dl:{dt:1,dd:1},del:u,isindex:{},fieldset:H({legend:1},l),thead:E,ul:a,acronym:u,b:u,a:x,blockquote:p,caption:u,i:u,u:u,tbody:E,s:u,address:H(C,s),tt:u,legend:u,q:u,pre:H(i,D),p:u,em:u,dfn:u}}()});
KISSY.Editor.add("dom",function(z){function H(a){return a.replace(/-(\w)/g,function(c,d){return d.toUpperCase()})}var I=KISSY,x=I.DOM,D=I.UA,C=I.Node,q=z.Utils,r={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};z.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};z.POSITION={};var i=z.NODE,l=z.POSITION;l.POSITION_IDENTICAL=0;l.POSITION_DISCONNECTED=
1;l.POSITION_FOLLOWING=2;l.POSITION_PRECEDING=4;l.POSITION_IS_CONTAINED=8;l.POSITION_CONTAINS=16;var s={},u={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},E={hr:1},B=function(a){return a[0]||a},m=function(a){if(a&&!a[0])return new C(a);return a},p={_4e_wrap:m,_4e_equals:function(a,c){if(!a&&!c)return true;if(!a||!c)return false;a=B(a);c=B(c);return a===c},_4e_isBlockBoundary:function(a,
c){a=m(a);var d=I.mix(I.mix({},E),c||{});return u[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=B(a);for(var c=a.parentNode.childNodes,d=0;d<c.length;d++)if(c[d]===a)return d;return-1},_4e_first:function(a,c){a=B(a);var d=a.firstChild;if((d=d&&new C(d))&&c&&!c(d))d=d._4e_next(c);return d},_4e_move:function(a,c,d){a._4e_remove();a=B(a);c=B(c);d?c.insertBefore(a,c.firstChild):
c.appendChild(a)},_4e_name:function(a){a=B(a);var c=a.nodeName.toLowerCase();if(D.ie)if((a=a.scopeName)&&a!="HTML")c=a.toLowerCase()+":"+c;return c},_4e_isIdentical:function(a,c){if(a._4e_name()!=c._4e_name())return false;var d=a[0].attributes,e=c[0].attributes,g=d.length,k=e.length;if(!D.ie&&g!=k)return false;for(var b=0;b<g;b++){var f=d[b];if((!D.ie||f.specified&&f.nodeName!="_ke_expando")&&f.nodeValue!=c.attr(f.nodeName))return false}if(D.ie)for(b=0;b<k;b++){f=e[b];if(f.specified&&f.nodeName!=
"_ke_expando"&&f.nodeValue!=a.attr(f.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=B(a).childNodes;for(var c=0,d=a.length;c<d;c++){var e=a[c],g=e.nodeType;if(!(g==i.NODE_ELEMENT&&e.getAttribute("_ke_bookmark")))if(g==i.NODE_ELEMENT&&!p._4e_isEmptyInlineRemoveable(e)||g==i.NODE_TEXT&&I.trim(e.nodeValue))return false}return true},_4e_moveChildren:function(a,c,d){a=B(a);c=c[0]||c;if(a!=c)if(d)for(;d=a.lastChild;)c.insertBefore(a.removeChild(d),c.firstChild);else for(;d=
a.firstChild;)c.appendChild(a.removeChild(d))},_4e_mergeSiblings:function(){function a(c,d,e){if(d[0]&&d[0].nodeType==i.NODE_ELEMENT){for(var g=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){g.push(d);d=e?new C(d[0].nextSibling):new C(d[0].previousSibling);if(!d[0]||d[0].nodeType!=i.NODE_ELEMENT)return}if(c._4e_isIdentical(d)){for(var k=e?c[0].lastChild:c[0].firstChild;g.length;)g.shift()._4e_move(c,!e);d._4e_moveChildren(c,!e);d._4e_remove();k[0]&&k[0].nodeType==i.NODE_ELEMENT&&k._4e_mergeSiblings()}}}
return function(c){if(c[0])if(r[c._4e_name()]||c._4e_name()=="a"){a(c,new C(c[0].nextSibling),true);a(c,new C(c[0].previousSibling))}}}(),_4e_unselectable:D.gecko?function(a){a=B(a);a.style.MozUserSelect="none"}:D.webkit?function(a){a=B(a);a.style.KhtmlUserSelect="none"}:function(a){a=B(a);if(D.ie||D.opera){var c,d=0;for(a.unselectable="on";c=a.all[d++];)switch(c.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:c.unselectable="on"}}},_4e_getOffset:function(a,
c){a=B(a);var d,e=0;d=0;var g=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,k=a.ownerDocument,b=k.documentElement;c=c||k;if(a.getBoundingClientRect){if(a!==k.body&&b!==a){d=a.getBoundingClientRect();e=d.left+(c===k?x.scrollLeft(g):0);d=d.top+(c===k?x.scrollTop(g):0)}if(c)if(g!=(c.defaultView||c.parentWindow)&&g.frameElement){g=p._4e_getOffset(g.frameElement,c);e+=g.left;d+=g.top}}return{left:e,top:d}},_4e_getFrameDocument:function(a){return(a=B(a))&&a.contentWindow.document},_4e_splitText:function(a,
c){a=B(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=i.NODE_TEXT)){if(D.ie&&c==a.nodeValue.length){var e=d.createTextNode("");x.insertAfter(e,a);return e}e=new C(a.splitText(c));if(D.ie==8){d=d.createTextNode("");x.insertAfter(d,e[0]);d.parentNode.removeChild(d)}return e}},_4e_parents:function(a,c){a=m(a);var d=[];do d[c?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,c,d){a=B(a);a=a.cloneNode(c);if(!d){var e=function(g){if(g.nodeType==i.NODE_ELEMENT){g.removeAttribute("id",
false);g.removeAttribute("_ke_expando",false);g=g.childNodes;for(var k=0;k<g.length;k++)e(g[k])}};e(a)}return new C(a)},_4e_nextSourceNode:function(a,c,d,e){a=B(a);if(e&&!e.call){var g=e[0]||e;e=function(b){b=b[0]||b;return b!==g}}c=!c&&a.firstChild;var k=new C(a);if(!c){if(a.nodeType==i.NODE_ELEMENT&&e&&e(a,true)===false)return null;c=a.nextSibling}for(;!c&&(k=k.parent());){if(e&&e(k,true)===false)return null;c=k[0].nextSibling}if(!c)return null;c=x._4e_wrap(c);if(e&&e(c)===false)return null;if(d&&
d!=c[0].nodeType)return c._4e_nextSourceNode(false,d,e);return c},_4e_previousSourceNode:function(a,c,d,e){a=B(a);if(e&&!e.call){var g=e[0]||e;e=function(b){b=b[0]||b;return b!==g}}c=!c&&a.lastChild;var k=new C(a);if(!c){if(a.nodeType==i.NODE_ELEMENT&&e&&e(a,true)===false)return null;c=a.previousSibling}for(;!c&&(k=k.parent());){if(e&&e(k,true)===false)return null;c=k[0].previousSibling}if(!c)return null;c=x._4e_wrap(c);if(e&&e(c)===false)return null;if(d&&c[0].nodeType!=d)return c._4e_previousSourceNode(false,
d,e);return c},_4e_contains:D.ie||D.webkit?function(a,c){a=B(a);c=B(c);return c.nodeType!=i.NODE_ELEMENT?a.contains(c.parentNode):a!=c&&a.contains(c)}:function(a,c){a=B(a);c=B(c);return!!(a.compareDocumentPosition(c)&16)},_4e_commonAncestor:function(a,c){if(a._4e_equals(c))return a;if(c[0].nodeType!=i.NODE_TEXT&&c._4e_contains(a))return c;var d=a[0].nodeType==i.NODE_TEXT?a.parent():a;do if(d[0].nodeType!=i.NODE_TEXT&&d._4e_contains(c))return d;while(d=d.parent());return null},_4e_ascendant:function(a,
c,d){a=B(a);if(!d)a=a.parentNode;if(c&&!I.isFunction(c)){var e=c;c=function(g){return g._4e_name()==e}}for(;a&&a.nodeType!=9;){if(!c||c(new C(a))===true)return new C(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,c){a=B(a);var d=a.attributes.getNamedItem(c);return!!(d&&d.specified)},_4e_hasAttributes:D.ie?function(a){a=B(a);for(var c=a.attributes,d=0;d<c.length;d++){var e=c[d];switch(e.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(e.specified)return true}}return false}:
function(a){a=B(a);D.gecko&&a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,c){var d=B(a),e=B(c);if(d.compareDocumentPosition)return d.compareDocumentPosition(e);if(d==e)return l.POSITION_IDENTICAL;if(d.nodeType==i.NODE_ELEMENT&&e.nodeType==i.NODE_ELEMENT){if(d.contains){if(d.contains(e))return l.POSITION_CONTAINS+l.POSITION_PRECEDING;if(e.contains(d))return l.POSITION_IS_CONTAINED+l.POSITION_FOLLOWING}if("sourceIndex"in
d)return d.sourceIndex<0||e.sourceIndex<0?l.POSITION_DISCONNECTED:d.sourceIndex<e.sourceIndex?l.POSITION_PRECEDING:l.POSITION_FOLLOWING}d=a._4e_address();e=c._4e_address();for(var g=Math.min(d.length,e.length),k=0;k<=g-1;k++)if(d[k]!=e[k]){if(k<g)return d[k]<e[k]?l.POSITION_PRECEDING:l.POSITION_FOLLOWING;break}return d.length<e.length?l.POSITION_CONTAINS+l.POSITION_PRECEDING:l.POSITION_IS_CONTAINED+l.POSITION_FOLLOWING},_4e_address:function(a,c){a=B(a);for(var d=[],e=a.ownerDocument.documentElement,
g=a;g&&g!=e;){var k=g.parentNode,b=-1;if(k){for(var f=0;f<k.childNodes.length;f++){var h=k.childNodes[f];if(!(c&&h.nodeType==3&&h.previousSibling&&h.previousSibling.nodeType==3)){b++;if(h==g)break}}d.unshift(b)}g=k}return d},_4e_breakParent:function(a,c){var d=new z.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(c);var e=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(e,a[0].nextSibling)},_4e_style:function(a,c,d){if(d!==undefined)return a.css(c,d);a=a[0]||
a;return a.style[H(c)]},_4e_remove:function(a,c){var d=B(a),e=d.parentNode;if(e){if(c)for(var g;g=d.firstChild;)e.insertBefore(d.removeChild(g),d);e.removeChild(d)}return a},_4e_trim:function(a){x._4e_ltrim(a);x._4e_rtrim(a)},_4e_ltrim:function(a){a=B(a);for(var c;c=a.firstChild;){if(c.nodeType==i.NODE_TEXT){var d=q.ltrim(c.nodeValue),e=c.nodeValue.length;if(d){if(d.length<e){(new C(c))._4e_splitText(e-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(c);continue}}break}},_4e_rtrim:function(a){a=
B(a);for(var c;c=a.lastChild;){if(c.type==i.NODE_TEXT){var d=q.rtrim(c.nodeValue),e=c.nodeValue.length;if(d){if(d.length<e){(new C(c))._4e_splitText(d.length);a.removeChild(a.lastChild)}}else{a.removeChild(c);continue}}break}if(!D.ie&&!D.opera)(c=a.lastChild)&&c.nodeType==1&&c.nodeName.toLowerCase()=="br"&&c.parentNode.removeChild(c)},_4e_appendBogus:function(a){a=B(a);for(var c=a.lastChild;c&&c.nodeType==i.NODE_TEXT&&!I.trim(c.nodeValue);)c=c.previousSibling;if(!c||c.nodeType==i.NODE_TEXT||x._4e_name(c)!==
"br"){c=D.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");D.gecko&&c.setAttribute("type","_moz");a.appendChild(c)}},_4e_previous:function(a,c){var d=B(a),e;do e=(d=d.previousSibling)&&new C(d);while(e&&c&&!c(e));return e},_4e_last:function(a,c){a=x._4e_wrap(a);var d=a[0].lastChild;if((d=d&&new C(d))&&c&&!c(d))d=d._4e_previous(c);return d},_4e_next:function(a,c){var d=B(a),e;do e=(d=d.nextSibling)&&new C(d);while(e&&c&&!c(e));return e},_4e_outerHtml:function(a){a=B(a);
if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var c=a.ownerDocument.createElement("div");c.appendChild(a.cloneNode(true));return c.innerHTML},_4e_setMarker:function(a,c,d,e){a=x._4e_wrap(a);var g=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",I.guid())._4e_getData("list_marker_id"),k=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");c[g]=a;k[d]=1;return a._4e_setData(d,e)},_4e_clearMarkers:function(a,c,d){a=m(a);
var e=a._4e_getData("list_marker_names"),g=a._4e_getData("list_marker_id"),k;for(k in e)a._4e_removeData(k);a._4e_removeData("list_marker_names");if(d){a._4e_removeData("list_marker_id");delete c[g]}},_4e_setData:function(a,c,d){var e=x._4e_getUniqueId(a);(s[e]||(s[e]={}))[c]=d;return a},_4e_getData:function(a,c){a=B(a);var d=a.getAttribute("_ke_expando");return(d=d&&s[d])&&d[c]},_4e_removeData:function(a,c){a=B(a);var d=a.getAttribute("_ke_expando");var e=(d=d&&s[d])&&d[c];typeof e!="undefined"&&
d&&delete d[c];I.isEmptyObject(d)&&x._4e_clearData(a);return e||null},_4e_clearData:function(a){a=B(a);var c=a.getAttribute("_ke_expando");c&&delete s[c];c&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=B(a);var c=a.getAttribute("_ke_expando");if(c)return c;c=I.guid();a.setAttribute("_ke_expando",c);return c},_4e_copyAttributes:function(a,c,d){a=B(a);var e=a.attributes;d=d||{};for(var g=0;g<e.length;g++){var k=e[g],b=k.nodeName.toLowerCase(),f;if(!(b in d))if(b=="checked"&&(f=x.attr(a,
b)))c.attr(b,f);else if(k.specified||D.ie&&k.nodeValue&&b=="value"){f=x.attr(a,b);if(f===null)f=k.nodeValue;c.attr(b,f)}}if(a.style.cssText!=="")c[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=x._4e_name(a);var c=z.XHTML_DTD;return(a=!c.$nonEditable[a]&&(c[a]||c.span))&&a["#"]},_4e_scrollIntoView:function(a){a=m(a);var c=a[0].ownerDocument,d=x.scrollLeft(c),e=x.scrollTop(c),g=a.offset(),k=g.left;g=g.top;if(x.viewportHeight(c)+e<g||g<e||x.viewportWidth(c)+d<k||k<d)a.scrollIntoView(c)},
_4e_getElementsByTagName:function(a,c,d){a=B(a);if(!D.ie&&d)c=d+":"+c;d=[];a=a.getElementsByTagName(c);for(c=0;c<a.length;c++)d.push(new C(a[c]));return d}};I.DOM._4e_inject=function(a){I.mix(x,a);for(var c in a)a.hasOwnProperty(c)&&function(d){C.prototype[d]=function(){var e=[].slice.call(arguments,0);e.unshift(this);return a[d].apply(null,e)}}(c)};I.DOM._4e_inject(p)});
KISSY.Editor.add("elementpath",function(z){function H(l){var s=null,u=null,E=[];for(l=l;l&&l[0];){if(l[0].nodeType==C.NODE_ELEMENT){if(!this.lastElement)this.lastElement=l;var B=l._4e_name();if(q.ie&&l[0].scopeName!="HTML")B=l[0].scopeName.toLowerCase()+":"+B;if(!u){if(!s&&r[B])s=l;if(i[B]){var m;if(m=!s){if(m=B=="div"){a:{m=l;m=m[0]||m;m=m.childNodes;for(var p=0,a=m.length;p<a;p++){var c=m[p];if(c.nodeType==C.NODE_ELEMENT&&D.$block[c.nodeName.toLowerCase()]){m=true;break a}}m=false}m=!m}m=m}if(m)s=
l;else u=l}}E.push(l);if(B=="body")break}l=l.parent()}this.block=s;this.blockLimit=u;this.elements=E}var I=KISSY,x=I.DOM,D=z.XHTML_DTD,C=z.NODE,q=I.UA,r={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},i={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};H.prototype={compare:function(l){var s=this.elements;l=l&&l.elements;if(!l||s.length!=l.length)return false;for(var u=0;u<s.length;u++)if(!x._4e_equals(s[u],l[u]))return false;return true},contains:function(l){for(var s=
this.elements,u=0;u<s.length;u++)if(s[u]._4e_name()in l)return s[u];return null}};z.ElementPath=H});
KISSY.Editor.add("walker",function(z){function H(i,l){if(this._.end)return null;var s,u=this.range,E,B=this.guard,m=this.type,p=i?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;u.trim();if(u.collapsed){this.end();return null}}if(!i&&!this._.guardLTR){var a=u.endContainer,c=new r(a[0].childNodes[u.endOffset]);this._.guardLTR=function(k,b){return(k=q._4e_wrap(k))&&k[0]&&(!b||!q._4e_equals(a,k))&&(!c[0]||!k._4e_equals(c))&&(k[0].nodeType!=C.NODE_ELEMENT||!b||k._4e_name()!=
"body")}}if(i&&!this._.guardRTL){var d=u.startContainer,e=u.startOffset>0&&new r(d[0].childNodes[u.startOffset-1]);this._.guardRTL=function(k,b){return(k=q._4e_wrap(k))&&k[0]&&(!b||!k._4e_equals(d))&&(!e[0]||!k._4e_equals(e))&&(k[0].nodeType!=C.NODE_ELEMENT||!b||k._4e_name()!="body")}}var g=i?this._.guardRTL:this._.guardLTR;E=B?function(k,b){if(g(k,b)===false)return false;return B(k,b)}:g;if(this.current)s=this.current[p](false,m,E);else if(i){s=u.endContainer;if(u.endOffset>0){s=new r(s[0].childNodes[u.endOffset-
1]);if(E(s)===false)s=null}else s=E(s,true)===false?null:s._4e_previousSourceNode(true,m,E)}else{s=u.startContainer;if((s=new r(s[0].childNodes[u.startOffset]))&&s[0]){if(E(s)===false)s=null}else s=E(u.startContainer,true)===false?null:u.startContainer._4e_nextSourceNode(true,m,E)}for(;s&&s[0]&&!this._.end;){this.current=s;if(!this.evaluator||this.evaluator(s)!==false){if(!l)return s}else if(l&&this.evaluator)return false;s=s[p](false,m,E)}this.end();return this.current=null}function I(i){for(var l,
s=null;l=H.call(this,i);)s=l;return s}function x(i){this.range=i;this._={}}var D=KISSY,C=z.NODE,q=D.DOM,r=D.Node;D.augment(x,{end:function(){this._.end=1},next:function(){return H.call(this)},previous:function(){return H.call(this,true)},checkForward:function(){return H.call(this,false,true)!==false},checkBackward:function(){return H.call(this,true,true)!==false},lastForward:function(){return I.call(this)},lastBackward:function(){return I.call(this,true)},reset:function(){delete this.current;this._=
{}}});x.blockBoundary=function(i){return function(l){l=q._4e_wrap(l);return!(l&&l[0].nodeType==C.NODE_ELEMENT&&l._4e_isBlockBoundary(i))}};x.listItemBoundary=function(){return this.blockBoundary({br:1})};x.bookmark=function(i,l){function s(u){return u&&u[0]&&u._4e_name()=="span"&&u.attr("_ke_bookmark")}return function(u){var E,B;E=u&&u[0]&&u[0].nodeType==C.NODE_TEXT&&(B=u.parent())&&s(B);E=i?E:E||s(u);return l^E}};x.whitespaces=function(i){return function(l){l=(l=l[0]||l)&&l.nodeType==C.NODE_TEXT&&
!D.trim(l.nodeValue);return i^l}};x.invisible=function(i){var l=x.whitespaces();return function(s){s=l(s)||s[0].nodeType==C.NODE_ELEMENT&&!s[0].offsetHeight;return i^s}};z.Walker=x});
KISSY.Editor.add("range",function(z){function H(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=b}function I(b){var f=b[0].nodeType!=i.NODE_TEXT&&b._4e_name()in p.$removeEmpty,h=!r.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return f||h||b}function x(b){return!g(b)&&!k(b)}function D(b){var f=false,h=u.bookmark(true);return function(j){if(h(j))return true;if(j[0].nodeType==i.NODE_TEXT){if(r.trim(j[0].nodeValue).length)return false}else if(j[0].nodeType==
i.NODE_ELEMENT)if(!e[j._4e_name()])if(!b&&!m.ie&&j._4e_name()=="br"&&!f)f=true;else return false;return true}}function C(b,f){function h(j){return j&&j.nodeName=="span"&&j.getAttribute("_ke_bookmark")}return function(j){var n,v;n=j&&!j.nodeName&&(v=j.parentNode)&&h(v);n=b?n:n||h(j);return f^n}}function q(b){return function(f){f=(f=f[0]||f)&&f.nodeType==i.NODE_TEXT&&!r.trim(f.nodeValue);return b^f}}z.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var r=KISSY,i=z.NODE,l=z.RANGE,s=z.POSITION,u=z.Walker,E=r.DOM,B=z.Utils.getByAddress,m=r.UA,p=z.XHTML_DTD,a=z.ElementPath,c=r.Node,d={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};H.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return b.join("<br/>")};r.augment(H,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&E._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,f=this.startOffset;if(b[0].nodeType!=i.NODE_ELEMENT)if(f)f>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;f=this.endOffset;if(b[0].nodeType!=i.NODE_ELEMENT)if(f)f>=b[0].nodeValue.length&&
this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,f=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,l.POSITION_BEFORE_START);f&&f._4e_name()=="span"&&
f.attr("_ke_bookmark")&&this.setEndAt(f,l.POSITION_AFTER_END)},setStart:function(b,f){if(b[0].nodeType==i.NODE_ELEMENT&&d[b._4e_name()]){b=b.parent();f=b._4e_index()}this.startContainer=b;this.startOffset=f;if(!this.endContainer){this.endContainer=b;this.endOffset=f}this.updateCollapsed()},setEnd:function(b,f){if(b[0].nodeType==i.NODE_ELEMENT&&d[b._4e_name()]){b=b.parent();f=b._4e_index()+1}this.endContainer=b;this.endOffset=f;if(!this.startContainer){this.startContainer=b;this.startOffset=f}this.updateCollapsed()},
setStartAt:function(b,f){switch(f){case l.POSITION_AFTER_START:this.setStart(b,0);break;case l.POSITION_BEFORE_END:b[0].nodeType==i.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case l.POSITION_BEFORE_START:this.setStartBefore(b);break;case l.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,f){switch(f){case l.POSITION_AFTER_START:this.setEnd(b,0);break;case l.POSITION_BEFORE_END:b[0].nodeType==i.NODE_TEXT?this.setEnd(b,
b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case l.POSITION_BEFORE_START:this.setEndBefore(b);break;case l.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,f){var h=this.startContainer,j=this.endContainer,n=this.startOffset,v=this.endOffset,K,O;this.optimizeBookmark();if(j[0].nodeType==i.NODE_TEXT)j=j._4e_splitText(v);else if(j[0].childNodes.length>0)if(v>=j[0].childNodes.length){j=new c(j[0].appendChild(this.document.createTextNode("")));
O=true}else j=new c(j[0].childNodes[v]);if(h[0].nodeType==i.NODE_TEXT){h._4e_splitText(n);if(E._4e_equals(h,j))j=new c(h[0].nextSibling)}else if(n)if(n>=h[0].childNodes.length){K=new c(this.document.createTextNode(""));h[0].appendChild(K[0]);h=K;K=true}else h=new c(h[0].childNodes[n].previousSibling);else{K=new c(this.document.createTextNode(""));E.insertBefore(K[0],h[0].firstChild);h=K;K=true}n=h._4e_parents();v=j._4e_parents();var J,N,M;for(J=0;J<n.length;J++){N=n[J];M=v[J];if(N[0]!==M[0])break}for(var S=
f,o,A,t,w=J;w<n.length;w++){o=n[w];if(S&&o[0]!==h[0])A=S.appendChild(o._4e_clone()[0]);for(o=o[0].nextSibling;o;){if(v[w]&&o==v[w][0]||o==j[0])break;t=o.nextSibling;if(b==2)S.appendChild(o.cloneNode(true));else{o.parentNode.removeChild(o);b==1&&S.appendChild(o)}o=t}if(A)S=A}S=f;for(J=J;J<v.length;J++){o=v[J];if(b>0&&o[0]!==j[0])A=S.appendChild(o._4e_clone()[0]);if(!n[J]||o[0].parentNode!==n[J][0].parentNode)for(o=o[0].previousSibling;o;){if(n[J]&&o==n[J][0]||o===h[0])break;t=o.previousSibling;if(b==
2)S.insertBefore(o.cloneNode(true),S.firstChild);else{o.parentNode.removeChild(o);b==1&&S.insertBefore(o,S.firstChild)}o=t}if(A)S=A}if(b==2){M=this.startContainer[0];if(M.nodeType==i.NODE_TEXT&&M.nextSibling&&M.nextSibling.nodeType==i.NODE_TEXT){M.data+=M.nextSibling.data;M.parentNode.removeChild(M.nextSibling)}M=this.endContainer[0];if(M.nodeType==i.NODE_TEXT&&M.nextSibling&&M.nextSibling.nodeType==i.NODE_TEXT){M.data+=M.nextSibling.data;M.parentNode.removeChild(M.nextSibling)}}else{if(N&&M&&(h[0].parentNode!=
N[0].parentNode||j[0].parentNode!=M[0].parentNode)){N=M._4e_index();K&&M[0].parentNode==h[0].parentNode&&N--;this.setStart(M.parent(),N)}this.collapse(true)}K&&h._4e_remove();O&&j[0].parentNode&&j._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var b=new H(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;
b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=i.NODE_ELEMENT||b.endContainer[0].nodeType!=i.NODE_ELEMENT)return null;var f=new z.Walker(b),h=C(true,undefined),j=q(true);b.evaluator=function(n){return j(n)&&h(n)};b=f.next();f.reset();f=f.previous();return b&&b._4e_equals(f)?b:null},shrink:function(b,f){if(!this.collapsed){b=b||l.SHRINK_TEXT;var h=this.clone(),
j=this.startContainer,n=this.endContainer,v=this.startOffset,K=this.endOffset,O=1,J=1;if(j&&j[0].nodeType==i.NODE_TEXT)if(v)if(v>=j[0].nodeValue.length)h.setStartAfter(j);else{h.setStartBefore(j);O=0}else h.setStartBefore(j);if(n&&n[0].nodeType==i.NODE_TEXT)if(K)if(K>=n[0].nodeValue.length)h.setEndAfter(n);else{h.setEndAfter(n);J=0}else h.setEndBefore(n);h=new u(h);h.evaluator=function(M){M=M[0]||M;return M.nodeType==(b==l.SHRINK_ELEMENT?i.NODE_ELEMENT:i.NODE_TEXT)};var N;h.guard=function(M,S){M=
M[0]||M;if(b==l.SHRINK_ELEMENT&&M.nodeType==i.NODE_TEXT)return false;if(S&&M==N)return false;if(!S&&M.nodeType==i.NODE_ELEMENT)N=M;return true};if(O)(j=h[b==l.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(j,f?l.POSITION_AFTER_START:l.POSITION_BEFORE_START);if(J){h.reset();(h=h[b==l.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(h,f?l.POSITION_BEFORE_END:l.POSITION_AFTER_END)}return!!(O||J)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||b[0].nodeType!=
i.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var f=this.startContainer,h=this.endContainer,j=this.startOffset,n=this.endOffset,v,K;if(!f||!h)return{start:0,end:0};if(b){if(f[0].nodeType==i.NODE_ELEMENT)if((v=new c(f[0].childNodes[j]))&&v[0]&&v[0].nodeType==i.NODE_TEXT&&j>0&&v[0].previousSibling.nodeType==i.NODE_TEXT){f=v;j=0}for(;f[0].nodeType==i.NODE_TEXT&&(K=f._4e_previous())&&K[0].nodeType==i.NODE_TEXT;){f=K;j+=K[0].nodeValue.length}if(!this.collapsed){if(h[0].nodeType==
i.NODE_ELEMENT)if((v=new c(h[0].childNodes[n]))&&v[0]&&v[0].nodeType==i.NODE_TEXT&&n>0&&v[0].previousSibling.nodeType==i.NODE_TEXT){h=v;n=0}for(;h[0].nodeType==i.NODE_TEXT&&(K=h._4e_previous())&&K[0].nodeType==i.NODE_TEXT;){h=K;n+=K[0].nodeValue.length}}}return{start:f._4e_address(b),end:this.collapsed?null:h._4e_address(b),startOffset:j,endOffset:n,normalized:b,is2:true}},createBookmark:function(b){var f,h,j,n;f=new c("<span></span>",null,this.document);f.attr("_ke_bookmark",1);f.css("display","none");
f.html("&nbsp;");if(b){j=r.guid("ke_bm_");f.attr("id",j+"S")}if(!this.collapsed){h=f._4e_clone();h.html("&nbsp;");b&&h.attr("id",j+"E");n=this.clone();n.collapse();n.insertNode(h)}n=this.clone();n.collapse(true);n.insertNode(f);if(h){this.setStartAfter(f);this.setEndBefore(h)}else this.moveToPosition(f,l.POSITION_AFTER_END);return{startNode:b?j+"S":f,endNode:b?j+"E":h,serializable:b}},moveToPosition:function(b,f){this.setStartAt(b,f);this.collapse(true)},trim:function(b,f){var h=this.startContainer,
j=this.startOffset,n=this.collapsed;if((!b||n)&&h[0]&&h[0].nodeType==i.NODE_TEXT){if(j)if(j>=h[0].nodeValue.length){j=h._4e_index()+1;h=h.parent()}else{var v=h._4e_splitText(j);j=h._4e_index()+1;h=h.parent();if(E._4e_equals(this.startContainer,this.endContainer))this.setEnd(v,this.endOffset-this.startOffset);else if(E._4e_equals(h,this.endContainer))this.endOffset+=1}else{j=h._4e_index();h=h.parent()}this.setStart(h,j);if(n){this.collapse(true);return}}h=this.endContainer;j=this.endOffset;if(!(f||
n)&&h[0]&&h[0].nodeType==i.NODE_TEXT){if(j){j>=h.nodeValue.length||h._4e_splitText(j);j=h._4e_index()+1}else j=h._4e_index();h=h.parent();this.setEnd(h,j)}},insertNode:function(b){this.optimizeBookmark();this.trim(false,true);var f=this.startContainer,h=f[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);h?E.insertBefore(b[0]||b,h):f[0].appendChild(b[0]||b);E._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var f=
B(this.document,b.start,b.normalized),h=b.startOffset,j=b.end&&B(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(f,h);j?this.setEnd(j,b):this.collapse(true)}else{f=(h=b.serializable)?r.one("#"+b.startNode,this.document):b.startNode;b=h?r.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(f);f._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(b,f){var h=this.startContainer,j=this.endContainer;h=E._4e_equals(h,
j)?b&&h[0].nodeType==i.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new c(h[0].childNodes[this.startOffset]):h:h._4e_commonAncestor(j);return f&&h[0].nodeType==i.NODE_TEXT?h.parent():h},enlarge:function(b){switch(b){case l.ENLARGE_ELEMENT:if(this.collapsed)break;b=this.getCommonAncestor();var f=new c(this.document.body),h,j,n,v,K,O=false,J,N;J=this.startContainer;N=this.startOffset;if(J[0].nodeType==i.NODE_TEXT){if(N){J=!r.trim(J[0].nodeValue.substring(0,N)).length&&J;O=!!J}if(J)if(!(v=J[0].previousSibling))n=
J.parent()}else{if(N)v=J[0].childNodes[N-1]||J[0].lastChild;v||(n=J)}for(;n||v;){if(n&&!v){if(!K&&E._4e_equals(n,b))K=true;if(!f._4e_contains(n))break;if(!O||n.css("display")!="inline"){O=false;if(K)h=n;else this.setStartBefore(n)}v=n[0].previousSibling}for(;v;){J=false;if(v.nodeType==i.NODE_TEXT){N=v.nodeValue;if(/[^\s\ufeff]/.test(N))v=null;J=/[\s\ufeff]$/.test(N)}else if(v.offsetWidth>0&&!v.getAttribute("_ke_bookmark"))if(O&&p.$removeEmpty[v.nodeName.toLowerCase()]){N=E.text(v);if(/[^\s\ufeff]/.test(N))v=
null;else for(var M=v.all||v.getElementsByTagName("*"),S=0,o;o=M[S++];)if(!p.$removeEmpty[o.nodeName.toLowerCase()]){v=null;break}if(v)J=!!N.length}else v=null;if(J)if(O)if(K)h=n;else n&&this.setStartBefore(n);else O=true;if(v){J=v.previousSibling;if(!n&&!J){n=new c(v);v=null;break}v=J}else n=null}if(n)n=n.parent()}J=this.endContainer;N=this.endOffset;n=v=null;K=O=false;if(J[0].nodeType==i.NODE_TEXT){J=!r.trim(J[0].nodeValue.substring(N)).length&&J;O=!(J&&J[0].nodeValue.length);if(J)if(!(v=J[0].nextSibling))n=
J.parent()}else(v=J[0].childNodes[N])||(n=J);for(;n||v;){if(n&&!v){if(!K&&E._4e_equals(n,b))K=true;if(!f._4e_contains(n))break;if(!O||n.css("display")!="inline"){O=false;if(K)j=n;else n&&this.setEndAfter(n)}v=n[0].nextSibling}for(;v;){J=false;if(v.nodeType==i.NODE_TEXT){N=v.nodeValue;if(/[^\s\ufeff]/.test(N))v=null;J=/^[\s\ufeff]/.test(N)}else if(v.offsetWidth>0&&!v.getAttribute("_ke_bookmark"))if(O&&p.$removeEmpty[v.nodeName.toLowerCase()]){N=E.text(v);if(/[^\s\ufeff]/.test(N))v=null;else{M=v.all||
v.getElementsByTagName("*");for(S=0;o=M[S++];)if(!p.$removeEmpty[o.nodeName.toLowerCase()]){v=null;break}}if(v)J=!!N.length}else v=null;if(J)if(O)if(K)j=n;else this.setEndAfter(n);if(v){J=v.nextSibling;if(!n&&!J){n=new c(v);v=null;break}v=J}else n=null}if(n)n=n.parent()}if(h&&j){b=h._4e_contains(j)?j:h;this.setStartBefore(b);this.setEndAfter(b)}break;case l.ENLARGE_BLOCK_CONTENTS:case l.ENLARGE_LIST_ITEM_CONTENTS:n=new H(this.document);f=new c(this.document.body);n.setStartAt(f,l.POSITION_AFTER_START);
n.setEnd(this.startContainer,this.startOffset);n=new u(n);var A,t,w=u.blockBoundary(b==l.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),y=function(G){var F=w(G);F||(A=G);return F};h=function(G){var F=y(G);if(!F&&G[0]&&G._4e_name()=="br")t=G;return F};n.guard=y;n=n.lastBackward();A=A||f;this.setStartAt(A,A._4e_name()!="br"&&(!n&&this.checkStartOfBlock()||n&&A._4e_contains(n))?l.POSITION_AFTER_START:l.POSITION_AFTER_END);n=this.clone();n.collapse();n.setEndAt(f,l.POSITION_BEFORE_END);n=new u(n);n.guard=b==
l.ENLARGE_LIST_ITEM_CONTENTS?h:y;A=null;n=n.lastForward();A=A||f;this.setEndAt(A,!n&&this.checkEndOfBlock()||n&&A._4e_contains(n)?l.POSITION_BEFORE_END:l.POSITION_BEFORE_START);t&&this.setEndAfter(t)}},checkStartOfBlock:function(){var b=this.startContainer,f=this.startOffset;if(f&&b[0].nodeType==i.NODE_TEXT)if(r.trim(b[0].nodeValue.substring(0,f)).length)return false;this.trim();b=new a(this.startContainer);f=this.clone();f.collapse(true);f.setStartAt(b.block||b.blockLimit,l.POSITION_AFTER_START);
b=new u(f);b.evaluator=D(true);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,f=this.endOffset;if(b[0].nodeType==i.NODE_TEXT)if(r.trim(b[0].nodeValue.substring(f)).length)return false;this.trim();b=new a(this.endContainer);f=this.clone();f.collapse(false);f.setEndAt(b.block||b.blockLimit,l.POSITION_BEFORE_END);b=new u(f);b.evaluator=D(false);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,f){var h=this.clone();h[f==l.START?"setStartAt":"setEndAt"](b,f==l.START?l.POSITION_AFTER_START:l.POSITION_BEFORE_END);h=new u(h);h.evaluator=I;return h[f==l.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,f=this.endContainer,h=this.startOffset,j=this.endOffset,n;if(b[0].nodeType==i.NODE_ELEMENT){n=b[0].childNodes.length;if(n>
h)b=new c(b[0].childNodes[h]);else if(n<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new c(b);b=b._4e_nextSourceNode()||b}}if(f[0].nodeType==i.NODE_ELEMENT){n=f[0].childNodes.length;if(n>j)f=(new c(f[0].childNodes[j]))._4e_previousSourceNode(true);else if(n<1)f=f._4e_previousSourceNode();else{for(f=f[0];f.lastChild;)f=f.lastChild;f=new c(f)}}if(b._4e_position(f)&s.POSITION_FOLLOWING)b=f;return{startNode:b,endNode:f}},fixBlock:function(b,f){var h=this.createBookmark(),
j=new c(this.document.createElement(f));this.collapse(b);this.enlarge(l.ENLARGE_BLOCK_CONTENTS);j[0].appendChild(this.extractContents());j._4e_trim();m.ie||j._4e_appendBogus();this.insertNode(j);this.moveToBookmark(h);return j},splitBlock:function(b){var f=new a(this.startContainer),h=new a(this.endContainer),j=f.block,n=h.block,v=null;if(!f.blockLimit._4e_equals(h.blockLimit))return null;if(b!="br"){if(!j){j=this.fixBlock(true,b);n=(new a(this.endContainer)).block}n||(n=this.fixBlock(false,b))}b=
j&&this.checkStartOfBlock();f=n&&this.checkEndOfBlock();this.deleteContents();if(j&&E._4e_equals(j,n))if(f){v=new a(this.startContainer);this.moveToPosition(n,l.POSITION_AFTER_END);n=null}else if(b){v=new a(this.startContainer);this.moveToPosition(j,l.POSITION_BEFORE_START);j=null}else{n=this.splitElement(j);!m.ie&&!r.inArray(j._4e_name(),["ul","ol"])&&j._4e_appendBogus()}return{previousBlock:j,nextBlock:n,wasStartOfBlock:b,wasEndOfBlock:f,elementPath:v}},splitElement:function(b){if(!this.collapsed)return null;
this.setEndAt(b,l.POSITION_BEFORE_END);var f=this.extractContents(),h=b._4e_clone(false);h[0].appendChild(f);h.insertAfter(b);this.moveToPosition(b,l.POSITION_AFTER_END);return h},moveToElementEditablePosition:function(b,f){var h,j=z.XHTML_DTD;if(j.$empty[b._4e_name()])return false;for(;b&&b[0].nodeType==i.NODE_ELEMENT;){if(h=b._4e_isEditable())this.moveToPosition(b,f?l.POSITION_BEFORE_END:l.POSITION_AFTER_START);else if(j.$inline[b._4e_name()]){this.moveToPosition(b,f?l.POSITION_AFTER_END:l.POSITION_BEFORE_START);
return true}if((b=j.$empty[b._4e_name()]?b[f?"_4e_previous":"_4e_next"](x):b[f?"_4e_last":"_4e_first"](x))&&b[0].nodeType==i.NODE_TEXT){this.moveToPosition(b,f?l.POSITION_AFTER_END:l.POSITION_BEFORE_START);return true}}return h},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==i.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var e={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},g=new u.whitespaces,k=new u.bookmark;z.Range=H});
KISSY.Editor.add("domiterator",function(z){function H(B){if(!(arguments.length<1)){this.range=B;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var I=KISSY,x=I.UA,D=z.Walker,C=z.Range,q=z.RANGE,r=z.NODE,i=z.ElementPath,l=I.Node,s=I.DOM,u=/^[\r\n\t ]*$/,E=D.bookmark();I.augment(H,{getNextParagraph:function(B){var m,p,a,c,d;if(!this._.lastNode){p=this.range.clone();p.enlarge(this.forceBrBreak||!this.enlargeBr?q.ENLARGE_LIST_ITEM_CONTENTS:q.ENLARGE_BLOCK_CONTENTS);
var e=new D(p),g=D.bookmark(true,true);e.evaluator=g;this._.nextNode=e.next();e=new D(p);e.evaluator=g;e=e.previous();this._.lastNode=e._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==r.NODE_TEXT&&!I.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){g=new C(p.document);g.moveToPosition(this._.lastNode,q.POSITION_AFTER_END);if(g.checkEndOfBlock()){g=new i(g.endContainer);this._.lastNode=(g.block||g.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new l(p.document.createTextNode(""));s.insertAfter(this._.lastNode[0],e[0])}p=null}g=this._.nextNode;e=this._.lastNode;for(this._.nextNode=null;g;){var k=false,b=g[0].nodeType!=r.NODE_ELEMENT,f=false;if(b){if(g[0].nodeType==r.NODE_TEXT)if(u.test(g[0].nodeValue))b=false}else{var h=g._4e_name();if(g._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(h=="br")b=true;else if(!p&&!g[0].childNodes.length&&h!="hr"){m=g;a=g._4e_equals(e);break}if(p){p.setEndAt(g,q.POSITION_BEFORE_START);
if(h!="br")this._.nextNode=g}k=true}else{if(g[0].firstChild){if(!p){p=new C(this.range.document);p.setStartAt(g,q.POSITION_BEFORE_START)}g=new l(g[0].firstChild);continue}b=true}}if(b&&!p){p=new C(this.range.document);p.setStartAt(g,q.POSITION_BEFORE_START)}a=(!k||b)&&g._4e_equals(e);if(p&&!k)for(;!g[0].nextSibling&&!a;){h=g.parent();if(h._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){k=true;a||h._4e_equals(e);break}g=h;b=true;a=g._4e_equals(e);f=true}b&&p.setEndAt(g,q.POSITION_AFTER_END);g=g._4e_nextSourceNode(f,
null,e);a=!g;if((k||a)&&p){b=p.getBoundaryNodes();k=new i(p.startContainer);if(b.startNode.parent()._4e_equals(k.blockLimit)&&E(b.startNode)&&E(b.endNode)){p=null;this._.nextNode=null}else break}if(a)break}if(!m){if(!p){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}k=new i(p.startContainer);g=k.blockLimit;b={div:1,th:1,td:1};m=k.block;if((!m||!m[0])&&!this.enforceRealBlocks&&b[g._4e_name()]&&p.checkStartOfBlock()&&p.checkEndOfBlock())m=g;else if(!m||this.enforceRealBlocks&&
m._4e_name()=="li"){m=new l(this.range.document.createElement(B||"p"));m[0].appendChild(p.extractContents());m._4e_trim();p.insertNode(m);c=d=true}else if(m._4e_name()!="li"){if(!p.checkStartOfBlock()||!p.checkEndOfBlock()){m=m._4e_clone(false);m[0].appendChild(p.extractContents());m._4e_trim();d=p.splitBlock();c=!d.wasStartOfBlock;d=!d.wasEndOfBlock;p.insertNode(m)}}else if(!a)this._.nextNode=m._4e_equals(e)?null:p.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,e)}if(c){p=new l(m[0].previousSibling);
if(p[0]&&p[0].nodeType==r.NODE_ELEMENT)if(p._4e_name()=="br")p._4e_remove();else p[0].lastChild&&p[0].lastChild.nodeName.toLowerCase()=="br"&&s._4e_remove(p[0].lastChild)}if(d){p=D.bookmark(false,true);c=new l(m[0].lastChild);if(c[0]&&c[0].nodeType==r.NODE_ELEMENT&&c._4e_name()=="br")if(x.ie||c._4e_previous(p)||c._4e_next(p))c._4e_remove()}if(!this._.nextNode)this._.nextNode=a||m._4e_equals(e)?null:m._4e_nextSourceNode(true,null,e);return m}});C.prototype.createIterator=function(){return new H(this)}});
KISSY.Editor.add("selection",function(z){function H(c){this.document=c;this._={cache:{}};if(D.ie){var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!=c||d.parentElement&&d.parentElement().ownerDocument!=c)this.isInvalid=true}}function I(c){var d=c.document,e=new r(d.body),g=new r(d.documentElement);if(D.ie){if(D.ie<8||document.documentMode==7)g.on("click",function(j){C._4e_name(j.target)==="html"&&c.getSelection().getRanges()[0].select()});var k,b;e.on("focusin",function(j){if(j.target.nodeName.toUpperCase()==
"BODY")if(k){try{k.select()}catch(n){}k=null}});e.on("focus",function(){b=true;h()});e.on("beforedeactivate",function(j){j.relatedTarget||(b=false)});D.ie<8&&q.on(C._4e_getWin(d),"blur",function(){d.selection.empty()});e.on("mousedown",f);e.on("mouseup",function(){b=true;setTimeout(function(){h(true)},0)});e.on("keydown",f);e.on("keyup",function(){b=true;h()});q.on(d,"selectionchange",h);var f=function(){b=false},h=function(j){if(b){var n=c.document,v=c.getSelection(),K=v&&v.getType(),O=v&&v.getNative();
if(j&&O&&K==i.SELECTION_NONE)if(!n.queryCommandEnabled("InsertImage")){setTimeout(function(){h(true)},50);return}var J;if(!(O&&K==i.SELECTION_TEXT&&(J=C._4e_name(O.createRange().parentElement()))&&J in{input:1,textarea:1})){k=O&&v.getRanges()[0];c._monitor()}}}}else{q.on(d,"mouseup",c._monitor,c);q.on(d,"keyup",c._monitor,c)}}z.SELECTION={};var x=KISSY,D=x.UA,C=x.DOM,q=x.Event,r=x.Node,i=z.SELECTION,l=z.RANGE,s=z.NODE,u=z.Walker,E=z.Range;i.SELECTION_NONE=1;i.SELECTION_TEXT=2;i.SELECTION_ELEMENT=
3;var B={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};x.augment(H,{getNative:D.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=C._4e_getWin(this.document).getSelection())},getType:D.ie?function(){var c=this._.cache;if(c.type)return c.type;var d=i.SELECTION_NONE;try{var e=this.getNative(),g=
e.type;if(g=="Text")d=i.SELECTION_TEXT;if(g=="Control")d=i.SELECTION_ELEMENT;if(e.createRange().parentElement)d=i.SELECTION_TEXT}catch(k){}return c.type=d}:function(){var c=this._.cache;if(c.type)return c.type;var d=i.SELECTION_TEXT,e=this.getNative();if(e){if(e.rangeCount==1){e=e.getRangeAt(0);var g=e.startContainer;if(g==e.endContainer&&g.nodeType==s.NODE_ELEMENT&&e.endOffset-e.startOffset===1&&B[g.childNodes[e.startOffset].nodeName.toLowerCase()])d=i.SELECTION_ELEMENT}}else d=i.SELECTION_NONE;
return c.type=d},getRanges:D.ie?function(){var c=function(d,e){d=d.duplicate();d.collapse(e);for(var g=d.parentElement(),k=g.childNodes,b,f=0;f<k.length;f++){var h=k[f];if(h.nodeType==s.NODE_ELEMENT){b=d.duplicate();b.moveToElementText(h);h=b.compareEndPoints("StartToStart",d);var j=b.compareEndPoints("EndToStart",d);b.collapse();if(h>0)break;else if(!h||j==1&&h==-1)return{container:g,offset:f};else if(!j)return{container:g,offset:f+1};b=null}}if(!b){b=d.duplicate();b.moveToElementText(g);b.collapse(false)}b.setEndPoint("StartToStart",
d);b=b.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;b>0;)b-=k[--f].nodeValue.length}catch(n){b=0}return b===0?{container:g,offset:f}:{container:k[f],offset:-b}};return function(){var d=this._.cache;if(d.ranges)return d.ranges;var e=this.getNative(),g=e&&e.createRange(),k=this.getType();if(!e)return[];if(k==i.SELECTION_TEXT){e=new E(this.document);k=c(g,true);e.setStart(new r(k.container),k.offset);k=c(g);e.setEnd(new r(k.container),k.offset);return d.ranges=[e]}else if(k==i.SELECTION_ELEMENT){d=
this._.cache.ranges=[];for(k=0;k<g.length;k++){var b=g.item(k),f=b.parentNode,h=0;for(e=new E(this.document);h<f.childNodes.length&&f.childNodes[h]!=b;h++);e.setStart(new r(f),h);e.setEnd(new r(f),h+1);d.push(e)}return d}return d.ranges=[]}}():function(){var c=this._.cache;if(c.ranges)return c.ranges;var d=[],e=this.getNative();if(!e)return[];for(var g=0;g<e.rangeCount;g++){var k=e.getRangeAt(g),b=new E(this.document);b.setStart(new r(k.startContainer),k.startOffset);b.setEnd(new r(k.endContainer),
k.endOffset);d.push(b)}return c.ranges=d},getStartElement:function(){var c=this._.cache;if(c.startElement!==undefined)return c.startElement;var d,e=this.getNative();switch(this.getType()){case i.SELECTION_ELEMENT:return this.getSelectedElement();case i.SELECTION_TEXT:var g=this.getRanges()[0];if(g)if(!g.collapsed){for(g.optimize();;){d=g.startContainer;if(g.startOffset==(d[0].nodeType===s.NODE_ELEMENT?d[0].childNodes.length:d[0].nodeValue.length)&&!d._4e_isBlockBoundary())g.setStartAfter(d);else break}d=
g.startContainer;if(d[0].nodeType!=s.NODE_ELEMENT)return d.parent();d=new r(d[0].childNodes[g.startOffset]);if(!d[0]||d[0].nodeType!=s.NODE_ELEMENT)return g.startContainer;for(g=d[0].firstChild;g&&g.nodeType==s.NODE_ELEMENT;){d=new r(g);g=g.firstChild}return d}if(D.ie){g=e.createRange();g.collapse(true);d=g.parentElement()}else if((d=e.anchorNode)&&d.nodeType!=s.NODE_ELEMENT)d=d.parentNode}return c.startElement=d?C._4e_wrap(d):null},getSelectedElement:function(){var c=this._.cache;if(c.selectedElement!==
undefined)return c.selectedElement;var d=this,e;if(D.ie){e=d.getNative().createRange();e=e.item&&e.item(0)}e||(e=function(){for(var g=d.getRanges()[0],k,b,f=2;f&&!((k=g.getEnclosedNode())&&k[0].nodeType==s.NODE_ELEMENT&&B[k._4e_name()]&&(b=k));f--)g.shrink(l.SHRINK_ELEMENT);return b&&b[0]}());return c.selectedElement=C._4e_wrap(e)},reset:function(){this._.cache={}},selectElement:function(c){var d;if(D.ie)try{d=this.document.body.createControlRange();d.addElement(c[0]);d.select()}catch(e){d=this.document.body.createTextRange();
d.moveToElementText(c[0]);d.select()}finally{}else{d=this.document.createRange();d.selectNode(c[0]);c=this.getNative();c.removeAllRanges();c.addRange(d)}this.reset()},selectRanges:function(c){if(D.ie)c[0]&&c[0].select();else{var d=this.getNative();if(!d)return;d.removeAllRanges();for(var e=0;e<c.length;e++){var g=c[e],k=this.document.createRange(),b=g.startContainer;g.collapsed&&D.gecko&&D.gecko<1.09&&b[0].nodeType==s.NODE_ELEMENT&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));
k.setStart(b[0],g.startOffset);k.setEnd(g.endContainer[0],g.endOffset);d.addRange(k)}}this.reset()},createBookmarks2:function(c){for(var d=[],e=this.getRanges(),g=0;g<e.length;g++)d.push(e[g].createBookmark2(c));return d},createBookmarks:function(c){for(var d=[],e=this.getRanges(),g=e.length,k=this.document,b,f=0;f<g;f++){d.push(b=e[f].createBookmark(c,true));var h=(c=b.serializable)?x.one("#"+b.startNode,k):b.startNode;b=c?x.one("#"+b.endNode,k):b.endNode;for(var j=f+1;j<g;j++){var n=e[j],v=n.startContainer,
K=n.endContainer;C._4e_equals(v,h.parent())&&n.startOffset++;C._4e_equals(v,b.parent())&&n.startOffset++;C._4e_equals(K,h.parent())&&n.endOffset++;C._4e_equals(K,b.parent())&&n.endOffset++}}return d},selectBookmarks:function(c){for(var d=[],e=0;e<c.length;e++){var g=new E(this.document);g.moveToBookmark(c[e]);d.push(g)}this.selectRanges(d);return this},getCommonAncestor:function(){var c=this.getRanges();return c[0].startContainer._4e_commonAncestor(c[c.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});
z.Selection=H;var m={table:1,tbody:1,tr:1},p=u.whitespaces(true),a=/\ufeff|\u00a0/;E.prototype.select=D.ie?function(c){var d=this.collapsed,e,g;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var k=this.startContainer[0].childNodes[this.startOffset];if(k.nodeType==s.NODE_ELEMENT){(new H(this.document)).selectElement(new r(k));return}}if(this.startContainer[0].nodeType==s.NODE_ELEMENT&&this.startContainer._4e_name()in m||this.endContainer[0].nodeType==s.NODE_ELEMENT&&
this.endContainer._4e_name()in m)this.shrink(s.NODE_ELEMENT,true);var b=this.createBookmark();k=b.startNode;var f;if(!d)f=b.endNode;b=this.document.body.createTextRange();b.moveToElementText(k[0]);b.moveStart("character",1);if(f){c=this.document.body.createTextRange();c.moveToElementText(f[0]);b.setEndPoint("EndToEnd",c);b.moveEnd("character",-1)}else{for(e=k[0].nextSibling;e&&!p(e);)e=e.nextSibling;e=!(e&&e.nodeValue&&e.nodeValue.match(a))&&(c||!k[0].previousSibling||k[0].previousSibling&&C._4e_name(k[0].previousSibling)==
"br");g=this.document.createElement("span");g.innerHTML="&#65279;";g=new r(g);C.insertBefore(g[0],k[0]);e&&C.insertBefore(this.document.createTextNode("\ufeff"),k[0])}this.setStartBefore(k);k._4e_remove();if(d){if(e){b.moveStart("character",-1);b.select();this.document.selection.clear()}else b.select();if(g){this.moveToPosition(g,l.POSITION_BEFORE_START);g._4e_remove()}}else{this.setEndBefore(f);f._4e_remove();b.select()}}:function(){var c=this.startContainer;this.collapsed&&c[0].nodeType==s.NODE_ELEMENT&&
!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));var d=this.document.createRange();d.setStart(c[0],this.startOffset);try{d.setEnd(this.endContainer[0],this.endOffset)}catch(e){if(e.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);d.setEnd(this.endContainer[0],this.endOffset)}else throw e;}c=new H(this.document);c=(!c||c.isInvalid?null:c).getNative();c.removeAllRanges();c.addRange(d)};z.on("instanceCreated",function(c){I(c.editor)})});
KISSY.Editor.add("styles",function(z){function H(o,A){for(var t in o)o[t]=o[t].replace(S,function(w,y){return A[y]})}function I(o,A){if(A){o=e.clone(o);H(o.attributes,A);H(o.styles,A)}var t=this.element=(o.element||"*").toLowerCase();this.type=t=="#"||J[t]?k.STYLE_BLOCK:N[t]?k.STYLE_OBJECT:k.STYLE_INLINE;this._={definition:o}}function x(o,A){var t=A?this.removeFromRange:this.applyToRange;o.body.focus();for(var w=new f(o),y=w.getRanges(),G=0;G<y.length;G++)t.call(this,y[G]);w.selectRanges(y)}function D(o,
A){var t;t=o.element;if(t=="*")t="span";t=new v(A.createElement(t));return C(t,o)}function C(o,A){var t=A._.definition,w=t.attributes;t=I.getStyleText(t);if(w)for(var y in w)o.attr(y,w[y]);if(t)o[0].style.cssText=t;return o}function q(o){var A=o.createBookmark(true),t=o.createIterator();t.enforceRealBlocks=true;t.enlargeBr=true;for(var w,y=o.document;w=t.getNextParagraph();){var G=D(this,y);w=w;var F=G;G=F._4e_name=="pre";var L=w._4e_name=="pre",T=!G&&L;if(G&&!L){L=w;F=F;T=L.html();T=r(T,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,
"");T=T.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");T=T.replace(/([ \t\n\r]+|&nbsp;)/g," ");T=T.replace(/<br\b[^>]*>/gi,"\n");if(K.ie){L=L[0].ownerDocument.createElement("div");L.appendChild(F[0]);F[0].outerHTML="<pre>"+T+"</pre>";F=new v(L.firstChild);F._4e_remove()}else F.html(T);F=F}else if(T)F=l(i(w),F);else w._4e_moveChildren(F);w[0].parentNode.replaceChild(F[0],w[0]);if(G){w=F;G=void 0;if((G=w._4e_previousSourceNode(true,h.NODE_ELEMENT))&&G._4e_name()=="pre"){F=r(G.html(),/\n$/,"")+"\n\n"+
r(w.html(),/^\n/,"");if(K.ie)w[0].outerHTML="<pre>"+F+"</pre>";else w.html(F);G._4e_remove()}}}o.moveToBookmark(A)}function r(o,A,t){var w="",y="";o=o.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(G,F,L){F&&(w=F);L&&(y=L);return""});return w+o.replace(A,t)+y}function i(o){var A=[];r(o._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(t,w,y){return w+"</pre>"+y+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(t,
w){A.push(w)});return A}function l(o,A){for(var t=A[0].ownerDocument.createDocumentFragment(),w=0;w<o.length;w++){var y=o[w];y=y.replace(/(\r\n|\r)/g,"\n");y=r(y,/^[ \t]*\n/,"");y=r(y,/\n$/,"");y=r(y,/^[ \t]+|[ \t]+$/g,function(F,L){return F.length==1?"&nbsp;":L?" "+Array(F.length).join("&nbsp;"):Array(F.length).join("&nbsp;")+" "});y=y.replace(/\n/g,"<br>");y=y.replace(/[ \t]{2,}/g,function(F){return Array(F.length).join("&nbsp;")+" "});var G=A._4e_clone();G.html(y);t.appendChild(G[0])}return t}
function s(o){var A=o.document;if(o.collapsed){A=D(this,A);o.insertNode(A);o.moveToPosition(A,b.POSITION_BEFORE_END)}else{var t=this.element,w=this._.definition,y,G=z.XHTML_DTD[t]||(y=true,z.XHTML_DTD.span),F=o.createBookmark();o.enlarge(b.ENLARGE_ELEMENT);o.trim();var L=o.createBookmark(),T=L.startNode;L=L.endNode;for(var R=T,V;R&&R[0];){var P=false;if(g._4e_equals(R,L)){R=null;P=true}else{var Q=R[0].nodeType,Y=Q==h.NODE_ELEMENT?R._4e_name():null;if(Y&&R.attr("_ke_bookmark")){R=R._4e_nextSourceNode(true);
continue}if(!Y||G[Y]&&(R._4e_position(L)|j.POSITION_PRECEDING|j.POSITION_IDENTICAL|j.POSITION_IS_CONTAINED)==j.POSITION_PRECEDING+j.POSITION_IDENTICAL+j.POSITION_IS_CONTAINED&&(!w.childRule||w.childRule(R))){var U=R.parent();if(U&&U[0]&&((z.XHTML_DTD[U._4e_name()]||z.XHTML_DTD.span)[t]||y)&&(!w.parentRule||w.parentRule(U))){if(!V&&(!Y||!z.XHTML_DTD.$removeEmpty[Y]||(R._4e_position(L)|j.POSITION_PRECEDING|j.POSITION_IDENTICAL|j.POSITION_IS_CONTAINED)==j.POSITION_PRECEDING+j.POSITION_IDENTICAL+j.POSITION_IS_CONTAINED)){V=
new n(A);V.setStartBefore(R)}if(Q==h.NODE_TEXT||Q==h.NODE_ELEMENT&&!R[0].childNodes.length){Q=R;for(var W;!Q[0].nextSibling&&(W=Q.parent(),G[W._4e_name()])&&(W._4e_position(T)|j.POSITION_FOLLOWING|j.POSITION_IDENTICAL|j.POSITION_IS_CONTAINED)==j.POSITION_FOLLOWING+j.POSITION_IDENTICAL+j.POSITION_IS_CONTAINED&&(!w.childRule||w.childRule(W));)Q=W;V.setEndAfter(Q);Q[0].nextSibling||(P=true)}}else P=true}else P=true;R=R._4e_nextSourceNode()}if(P&&V&&!V.collapsed){P=D(this,A);for(Q=V.getCommonAncestor();P&&
Q&&P[0]&&Q[0];){if(Q._4e_name()==t){for(var X in w.attributes)P.attr(X)==Q.attr(X)&&P[0].removeAttribute(X);for(var aa in w.styles)P._4e_style(aa)==Q._4e_style(aa)&&P._4e_style(aa,"");if(!P._4e_hasAttributes()){P=null;break}}Q=Q.parent()}if(P){P[0].appendChild(V.extractContents());Q=P;Y=m(this);U=Q.all(this.element);for(var Z=U.length;--Z>=0;)p(this,new v(U[Z]));var $=void 0;for($ in Y)if($!=this.element){U=Q.all($);for(Z=U.length-1;Z>=0;Z--){var ba=new v(U[Z]);c(ba,Y[$])}}V.insertNode(P);P._4e_mergeSiblings();
K.ie||P[0].normalize()}V=null}}T._4e_remove();L._4e_remove();o.moveToBookmark(F);o.shrink(b.SHRINK_TEXT)}}function u(o){o.enlarge(b.ENLARGE_ELEMENT);var A=o.createBookmark(),t=A.startNode;if(o.collapsed){for(var w=new O(t.parent()),y,G=0,F;G<w.elements.length&&(F=w.elements[G]);G++){if(F==w.block||F==w.blockLimit)break;if(this.checkElementRemovable(F)){var L=o.checkBoundaryOfElement(F,b.END),T=!L&&o.checkBoundaryOfElement(F,b.START);if(T||L){y=F;y.match=T?"start":"end"}else{F._4e_mergeSiblings();
F._4e_name()==this.element?p(this,F):c(F,m(this)[F._4e_name()])}}}if(y&&y[0]){F=t;for(G=0;;G++){L=w.elements[G];if(g._4e_equals(L,y))break;else if(L.match)continue;else L=L._4e_clone();L[0].appendChild(F[0]);F=L}g[y.match=="start"?"insertBefore":"insertAfter"](F[0],y[0])}}else{var R=A.endNode,V=this;w=function(){for(var P=new O(t.parent()),Q=new O(R.parent()),Y=null,U=null,W=0;W<P.elements.length;W++){var X=P.elements[W];if(X==P.block||X==P.blockLimit)break;if(V.checkElementRemovable(X))Y=X}for(W=
0;W<Q.elements.length;W++){X=Q.elements[W];if(X==Q.block||X==Q.blockLimit)break;if(V.checkElementRemovable(X))U=X}U&&R._4e_breakParent(U);Y&&t._4e_breakParent(Y)};w();for(y=new v(t[0].nextSibling);y[0]!==R[0];){G=y._4e_nextSourceNode();if(y[0]&&y[0].nodeType==h.NODE_ELEMENT&&this.checkElementRemovable(y)){y._4e_name()==this.element?p(this,y):c(y,m(this)[y._4e_name()]);if(G[0].nodeType==h.NODE_ELEMENT&&G._4e_contains(t)){w();G=new v(t[0].nextSibling)}}y=G}}o.moveToBookmark(A)}function E(o){var A={};
o.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(t,w,y){A[w]=y});return A}function B(o,A){var t;if(A!==false){t=document.createElement("span");t.style.cssText=o;t=t.style.cssText||""}else t=o;return t.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function m(o){if(o._.overrides)return o._.overrides;var A=o._.overrides={},t=o._.definition.overrides;if(t){e.isArray(t)||(t=[t]);for(var w=0;w<t.length;w++){var y=t[w],G,F;if(typeof y==
"string")G=y.toLowerCase();else{G=y.element?y.element.toLowerCase():o.element;F=y.attributes}y=A[G]||(A[G]={});if(F){y=y.attributes=y.attributes||[];for(var L in F)y.push([L.toLowerCase(),F[L]])}}}return A}function p(o,A){var t=o._.definition,w=e.mix(e.mix({},t.attributes),m(o)[A._4e_name()]);t=t.styles;var y=e.isEmptyObject(w)&&e.isEmptyObject(t),G;for(G in w)if(!((G=="class"||o._.definition.fullMatch)&&A.attr(G)!=a(G,w[G]))){y=y||!!A._4e_hasAttribute(G);A.removeAttr(G)}for(var F in t)if(!(o._.definition.fullMatch&&
A._4e_style(F)!=a(F,t[F],true))){y=y||!!A._4e_style(F);A._4e_style(F,"")}y&&d(A)}function a(o,A,t){var w=new v("<span></span>");w[t?"_4e_style":"attr"](o,A);return w[t?"_4e_style":"attr"](o)}function c(o,A){var t=A&&A.attributes;if(t)for(var w=0;w<t.length;w++){var y=t[w][0],G;if(G=o.attr(y)){var F=t[w][1];if(F===null||F.test&&F.test(G)||typeof F=="string"&&G==F)o[0].removeAttribute(y)}}d(o)}function d(o){if(!o._4e_hasAttributes()){var A=o[0].firstChild,t=o[0].lastChild;o._4e_remove(true);if(A){A.nodeType==
h.NODE_ELEMENT&&g._4e_mergeSiblings(A);t&&!A===t&&t.nodeType==h.NODE_ELEMENT&&g._4e_mergeSiblings(t)}}}var e=KISSY,g=e.DOM,k=z.STYLE={},b=z.RANGE,f=z.Selection,h=z.NODE,j=z.POSITION,n=z.Range,v=e.Node,K=e.UA,O=z.ElementPath,J={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},N={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},M=/\s*(?:;\s*|$)/,S=/#\((.+?)\)/g;k.STYLE_BLOCK=1;k.STYLE_INLINE=2;k.STYLE_OBJECT=3;I.prototype={apply:function(o){x.call(this,
o,false)},remove:function(o){x.call(this,o,true)},applyToRange:function(o){return(this.applyToRange=this.type==k.STYLE_INLINE?s:this.type==k.STYLE_BLOCK?q:this.type==k.STYLE_OBJECT?null:null).call(this,o)},removeFromRange:function(o){return(this.removeFromRange=this.type==k.STYLE_INLINE?u:null).call(this,o)},applyToObject:function(o){C(o,this)},checkElementRemovable:function(o,A){if(!o)return false;var t=this._.definition;if(o._4e_name()==this.element){if(!A&&!o._4e_hasAttributes())return true;var w=
t._AC;if(w)t=w;else{w={};var y=0,G=t.attributes;if(G)for(var F in G){y++;w[F]=G[F]}if(G=I.getStyleText(t)){w.style||y++;w.style=G}w._length=y;t=t._AC=w}if(t._length){for(var L in t)if(L!="_length"){y=o.attr(L)||"";if(L=="style")a:{w=t[L];y=B(y,false);typeof w=="string"&&(w=E(w));typeof y=="string"&&(y=E(y));G=void 0;for(G in w)if(!(G in y&&(y[G]==w[G]||w[G]=="inherit"||y[G]=="inherit"))){w=false;break a}w=true}else w=t[L]==y;if(w){if(!A)return true}else if(A)return false}if(A)return true}else return true}if(L=
m(this)[o._4e_name()]){if(!(t=L.attributes))return true;for(w=0;w<t.length;w++){L=t[w][0];if(L=o.attr(L)){y=t[w][1];if(y===null||typeof y=="string"&&L==y||y.test&&y.test(L))return true}}}return false},checkActive:function(o){switch(this.type){case k.STYLE_BLOCK:return this.checkElementRemovable(o.block||o.blockLimit,true);case k.STYLE_OBJECT:case k.STYLE_INLINE:for(var A=o.elements,t=0,w;t<A.length;t++){w=A[t];if(!(this.type==k.STYLE_INLINE&&(g._4e_equals(w,o.block)||g._4e_equals(w,o.blockLimit))))if(!(this.type==
k.STYLE_OBJECT&&!(w._4e_name()in N)))if(this.checkElementRemovable(w,true))return true}}return false}};I.getStyleText=function(o){var A=o._ST;if(A)return A;A=o.styles;var t=o.attributes&&o.attributes.style||"",w="";if(t.length)t=t.replace(M,";");for(var y in A){var G=A[y],F=(y+":"+G).replace(M,";");if(G=="inherit")w+=F;else t+=F}if(t.length)t=B(t);t+=w;return o._ST=t};z.Style=I});
