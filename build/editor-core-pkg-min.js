KISSY.add("editor",function(z,H){function I(h,t){var a=this;if(!(a instanceof I))return new I(h,t);if(z.isString(h))h=z.one(h);h=E._4e_wrap(h);t=t||{};t.pluginConfig=t.pluginConfig||{};a.cfg=t;z.app(a,z.EventTarget);a.use=function(b,d){if(z.isString(b))b=b.split(",");var e=b,m=[];m=z.indexOf("separator",e);var l=m!=-1;m=e.splice(0,l?m+1:e.length);l&&m.pop();m.length!=0?z.use.call(a,m.join(","),function(){l&&a.addPlugin(function(){I.Utils.addSeparator(a.toolBarDiv)});a.use(e,d)},{order:true,global:I}):
a.on("dataReady",function(){d&&d.call(a);a.setData(h.val());a.fire("save")});return a};a.init(h);return H}function y(h){if(!C)return h.replace(/\.(js|css)/i,"-min.$1");if(C==="dev")return"../src/"+h;return h}var E=z.DOM;z.app(I,z.EventTarget);I.Config.base=z.Config.base+"editor/";var C=z.Config.debug,o={htmlparser:{attach:false,path:y("plugins/htmldataprocessor/htmlparser/htmlparser.js")}},q=["utils","focusmanager","definition","dtd","dom","elementpath","walker","range","domiterator","selection",
"styles"],g=["sourceareasupport","tabs","flashbridge","flashutils","clipboard",{name:"colorsupport",requires:["overlay"]},{name:"forecolor",requires:["colorsupport"]},{name:"bgcolor",requires:["colorsupport"]},{name:"elementpaths"},"enterkey",{name:"pagebreak",requires:["fakeobjects"]},{name:"fakeobjects",requires:["htmldataprocessor"]},{name:"draft",requires:["localStorage"]},{name:"flash",requires:["flashsupport"]},{name:"flashsupport",requires:["flashutils","contextmenu","fakeobjects","overlay",
"bubbleview"]},{name:"font",requires:["select"]},"format",{name:"htmldataprocessor",requires:["htmlparser-text"]},{name:"image",requires:["overlay","contextmenu","bubbleview","tabs"]},"indent","justify",{name:"link",requires:["bubbleview"]},"list","maximize",{name:"music",requires:["flashsupport"]},"preview","removeformat",{name:"smiley"},{name:"sourcearea",requires:["sourceareasupport"]},{name:"table",requires:["overlay","contextmenu"]},{name:"templates",requires:["overlay"]},"undo",{name:"resize",
requires:["dd"]}],i=[{name:"htmlparser-basicwriter",requires:["htmlparser"]},{name:"htmlparser-element",requires:["htmlparser-fragment"]},{name:"htmlparser-filter",requires:["htmlparser-element"]},{name:"htmlparser-fragment",requires:["htmlparser-htmlwriter"]},{name:"htmlparser-htmlwriter",requires:["htmlparser-basicwriter"]},{name:"htmlparser-text",requires:["htmlparser-comment"]},{name:"htmlparser-comment",requires:["htmlparser-filter"]}],r,u,D,v;r=0;for(u=g.length;r<u;r++){D=g[r];if(z.isString(D))D=
g[r]={name:D};D.requires=D.requires||[];D.requires=D.requires.concat(["button"])}g=[{name:"localStorage",requires:["flashutils","flashbridge"]},{name:"button"},{name:"dd"},{name:"progressbar"},{name:"overlay",requires:["dd"]},{name:"contextmenu",requires:["overlay"]},{name:"bubbleview",requires:["overlay"]},{name:"select",requires:["overlay"]}].concat(g);r=0;for(u=g.length;r<u;r++){D=g[r];v=D.name;o[v]={attach:false,requires:D.requires,csspath:D.useCss?y("plugins/"+v+"/plugin.css"):H,path:y("plugins/"+
v+"/plugin.js")}}r=0;for(u=i.length;r<u;r++){D=i[r];g=H;if(!z.isString(D)){g=D.requires;D=D.name}o[D]={attach:false,requires:g,path:y("plugins/htmldataprocessor/htmlparser/"+D.substring(11)+".js")}}r=0;for(u=q.length;r<u;r++){D=q[r];o[D]={host:"editor",requires:r>0?q[r-1]:[]}}I.add(o);z.Editor=I});
KISSY.Editor.add("utils",function(z){var H=KISSY,I=H.Node,y=H.DOM,E=H.Config.debug,C=H.UA;z.Utils={debugUrl:function(o){if(!E)return o.replace(/\.(js|css)/i,"-min.$1");if(E==="dev")return"../src/"+o;return o},lazyRun:function(o,q,g){var i=o[q],r=o[g];o[q]=function(){i.apply(this,arguments);o[q]=o[g];return r.apply(this,arguments)}},getXY:function(o,q,g,i){g=g.defaultView||g.parentWindow;o-=y.scrollLeft(g);q-=y.scrollTop(g);if(i)if(g!=(i.defaultView||i.parentWindow)&&g.frameElement){i=y._4e_getOffset(g.frameElement,
i);o+=i.left;q+=i.top}return{left:o,top:q}},tryThese:function(){for(var o,q=0,g=arguments.length;q<g;q++){var i=arguments[q];try{o=i();break}catch(r){}}return o},arrayCompare:function(o,q){if(!o&&!q)return true;if(!o||!q||o.length!=q.length)return false;for(var g=0;g<o.length;g++)if(o[g]!==q[g])return false;return true},getByAddress:function(o,q,g){o=o.documentElement;for(var i=0;o&&i<q.length;i++){var r=q[i];if(g)for(var u=-1,D=0;D<o.childNodes.length;D++){var v=o.childNodes[D];if(!(g===true&&v.nodeType==
3&&v.previousSibling&&v.previousSibling.nodeType==3)){u++;if(u==r){o=v;break}}}else o=o.childNodes[r]}return o?new I(o):null},clearAllMarkers:function(o){for(var q in o)o[q]._4e_clearMarkers(o,true)},htmlEncodeAttr:function(o){return o.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(o){return o.replace(/^\s+/,"")},rtrim:function(o){return o.replace(/\s+$/,"")},trim:function(o){return this.ltrim(this.rtrim(o))},mix:function(){for(var o={},q=0;q<arguments.length;q++)o=
H.mix(o,arguments[q]);return o},isCustomDomain:function(){if(!C.ie)return false;var o=document.domain,q=window.location.hostname;return o!=q&&o!="["+q+"]"},addSeparator:function(o){(new H.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(o)},duplicateStr:function(o,q){return Array(q+1).join(o)},throttle:function(o,q,g){g=g||150;if(g===-1)return function(){o.apply(q,arguments)};var i=(new Date).getTime();return function(){var r=(new Date).getTime();if(r-i>g){i=r;o.apply(q,arguments)}}},
buffer:function(o,q,g){g=g||0;var i=null;return function(){i&&clearTimeout(i);var r=arguments;i=setTimeout(function(){return o.apply(q,r)},g)}},isNumber:function(o){return/^\d+(.\d+)?$/.test(H.trim(o))},verifyInputs:function(o){for(var q=0;q<o.length;q++){var g=y._4e_wrap(o[q]),i=H.trim(g.val()),r=g.attr("data-verify");g=g.attr("data-warning");if(r&&!RegExp(r).test(i)){alert(g);return}}return true},sourceDisable:function(o,q){o.on("sourcemode",q.disable,q);o.on("wysiwygmode",q.enable,q)},resetInput:function(o){var q=
o.attr("placeholder");if(q&&!C.webkit){o.val(q);o.addClass("ke-input-tip")}else C.webkit&&o.val("")},placeholder:function(o,q){o.attr("placeholder",q);if(!C.webkit){o.on("blur",function(){if(!H.trim(o.val())){o.val(q);o.addClass("ke-input-tip")}});o.on("focus",function(){H.trim(o.val())==q&&o.val("");o.removeClass("ke-input-tip")})}},clean:function(o){o=o[0]||o;for(var q=H.makeArray(o.childNodes),g=0;g<q.length;g++){var i=q[g];i.nodeType==z.NODE.NODE_TEXT&&!H.trim(i.nodeValue)&&o.removeChild(i)}},
htmlEncode:function(o){return!o?o:String(o).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(o){return!o?o:String(o).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(o,q){return o.toLowerCase()==q.toLowerCase()}}});
KISSY.Editor.add("focusmanager",function(z){function H(){this.iframeFocus=true;q=this}function I(){this.iframeFocus=false;q=null}var y=KISSY,E=y.DOM,C=y.Event;y={};var o={},q;y={refreshAll:function(){for(var g in o){var i=o[g];i.document.designMode="off";i.document.designMode="on"}},currentInstance:function(){return q},getInstance:function(g){return o[g]},add:function(g){var i=E._4e_getWin(g.document);C.on(i,"focus",H,g);C.on(i,"blur",I,g)},register:function(g){o[g._UUID]=g},remove:function(g){delete o[g._UUID];
var i=E._4e_getWin(g.document);C.remove(i,"focus",H,g);C.remove(i,"blur",I,g)}};z.focusManager=y});
KISSY.Editor.add("definition",function(z){function H(h){return i+"<html><head><title>kissy-editor</title><link href='"+z.Config.base+r+"' rel='stylesheet'/></head><body class='ke-editor'>&nbsp;</body><html>"+(h?'<script id="ke_actscrpt" type="text/javascript">'+(z.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+h+'");<\/script>':"")}var I=KISSY,y=I.UA,E=I.DOM,C=I.Node,o=I.Event,q=z.focusManager,g=z.Utils.tryThese,i="<!doctype html>",r=
z.Utils.debugUrl("theme/editor-iframe.css"),u=1,D="document.open();"+(z.Utils.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();",v="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"'></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+(y.ie?"javascript:void(function(){"+encodeURIComponent(D)+"}())":"")+'"  tabIndex="'+
(y.webkit?-1:"$(tabIndex)")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>";z.SOURCE_MODE=0;z.WYSIWYG_MODE=1;I.augment(z,{init:function(h){if(y.ie)E.addClass(document.body,"ie"+y.ie);else if(y.gecko)E.addClass(document.body,"gecko");else y.webkit&&E.addClass(document.body,"webkit");var t=this,a=new C(v.replace(/\$\(tabIndex\)/,h.attr("tabIndex")));a.on("mousedown",function(e){if(y.webkit){var m=E._4e_name(e.target);if(m=="select"||m=="option")return true}e.halt()});
t.editorWrap=a;t._UUID=u++;q.register(t);t.wrap=a.one(".ke-textarea-wrap");t.iframe=t.wrap.one("iframe");t.toolBarDiv=a.one(".ke-editor-tools");t.textarea=h;t.statusDiv=a.one(".ke-editor-status");t.toolBarDiv._4e_unselectable();t._commands={};var b=h._4e_style("width"),d=h._4e_style("height");if(b){a.css("width",b);h.css("width","100%")}t.textarea.css("display","none");a.insertAfter(h);t.wrap[0].appendChild(h[0]);if(d){t.wrap.css("height",d);h.css("height","100%")}h=t.iframe;t.on("dataReady",function(){t.ready=
true;z.fire("instanceCreated",{editor:t})});y.gecko?h.on("load",t._setUpIFrame,t):t._setUpIFrame()},addCommand:function(h,t){this._commands[h]=t},hasCommand:function(h){return this._commands[h]},execCommand:function(h){var t=this._commands[h],a=I.makeArray(arguments);a.shift();a.unshift(this);this.fire("save");t=t.exec.apply(t,a);this.fire("save");return t},getMode:function(){return this.textarea.css("display")=="none"?z.WYSIWYG_MODE:z.SOURCE_MODE},getData:function(){var h;h=this.getMode()==z.WYSIWYG_MODE?
this.document.body.innerHTML:this.textarea.val();if(this.htmlDataProcessor)return this.htmlDataProcessor.toHtml(h,"p");return h},setData:function(h){if(this.htmlDataProcessor)h=this.htmlDataProcessor.toDataFormat(h,"p");this.document.body.innerHTML=h;if(this.getMode()==z.WYSIWYG_MODE)this.document.body.innerHTML=h;else this.textarea.val(h)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(h){this.document.body.innerHTML=
h},_prepareIFrameHtml:H,getSelection:function(){var h=new z.Selection(this.document);return!h||h.isInvalid?null:h},focus:function(){var h=E._4e_getWin(this.document);y.webkit&&h&&h.parent&&h.parent.focus();h&&h.focus();this.document&&this.document.body.focus();this.notifySelectionChange()},blur:function(){E._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},_setUpIFrame:function(){function h(){e=d.document;t.document=e;a.detach();e.open("text/html","replace");e.write(b);e.close()}
var t=this,a=t.iframe,b=H(t._UUID),d=a[0].contentWindow,e;try{e=d.document}catch(m){a[0].src=a[0].src;if(y.ie&&y.ie<7){setTimeout(h,10);return}}h()},addPlugin:function(h){this.ready?h():this.on("dataReady",h)},_monitor:function(){var h=this;h._monitorId&&clearTimeout(h._monitorId);h._monitorId=setTimeout(function(){var t=h.getSelection();if(t&&!t.isInvalid){t=t.getStartElement();var a=new z.ElementPath(t);if(!h.previousPath||!h.previousPath.compare(a)){h.previousPath=a;h.fire("selectionChange",{selection:h,
path:a,element:t})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(h,t){var a=this;a.focus();var b=h._4e_name(),d=z.XHTML_DTD,e=z.RANGE,m=z.NODE,l=d.$block[b],c=a.getSelection(),f=c.getRanges(),j,k,n,x,J;a.fire("save");for(var M=f.length-1;M>=0;M--){j=f[M];j.deleteContents();k=!M&&h||h._4e_clone(true);t&&t(k);if(l)for(;(x=j.getCommonAncestor(false,true))&&(J=d[x._4e_name()])&&!(J&&J[b]);)if(x._4e_name()in d.span)j.splitElement(x);else if(j.checkStartOfBlock()&&
j.checkEndOfBlock()){j.setStartBefore(x);j.collapse(true);x._4e_remove()}else j.splitBlock();j.insertNode(k);n||(n=k)}b=n._4e_nextSourceNode(true);d=a.document;J=z.XHTML_DTD;if(J.$inline[k._4e_name()]){b=new C(d.createTextNode(" "));b.insertAfter(n)}else if(b){if(b._4e_name()=="br"&&J[b.parent()._4e_name()].p){J=new C("<p>&nbsp;</p>",null,d);b[0].parentNode.replaceChild(J[0],b[0]);b=J}}else{J=new C("<p>&nbsp;</p>",null,d);J.insertAfter(n);b=J}j.moveToPosition(n,e.POSITION_AFTER_END);b&&b[0].nodeType==
m.NODE_ELEMENT&&j.moveToElementEditablePosition(b);c.selectRanges([j]);a.focus();k&&k._4e_scrollIntoView();setTimeout(function(){a.fire("save")},10);return k},insertHtml:function(h){var t=this;if(t.htmlDataProcessor)h=t.htmlDataProcessor.toDataFormat(h);if(y.webkit){h=E.create(h,null,this.document);h=h.nodeType==11?I.makeArray(h.childNodes):[h];for(var a=0;a<h.length;a++)t.insertElement(new C(h[a]))}else{t.focus();t.fire("save");a=t.getSelection();if(y.ie){a=a.getNative();a.type=="Control"&&a.clear();
a.createRange().pasteHTML(h)}else t.document.execCommand("inserthtml",false,h);t.focus();setTimeout(function(){t.fire("save")},10)}}});z._initIFrame=function(h){function t(k){g(function(){d.designMode="on";setTimeout(function(){d.designMode="off";l.focus();if(!arguments.callee.retry)arguments.callee.retry=true},50)},function(){d.designMode="off";E.attr(l,"contentEditable",false);E.attr(l,"contentEditable",true);!k&&t(1)})}var a=q.getInstance(h);h=a.textarea[0];var b=a.iframe[0].contentWindow,d=a.document,
e=a.cfg,m=d.getElementById("ke_actscrpt");m.parentNode.removeChild(m);var l=d.body;if(y.ie){l.hideFocus=true;l.disabled=true;l.contentEditable=true;l.removeAttribute("disabled")}else setTimeout(function(){if(y.gecko||y.opera)l.contentEditable=true;else if(y.webkit)l.parentNode.contentEditable=true;else d.designMode="on"},0);if(y.webkit){o.on(d,"click",function(k){var n=new C(k.target);I.inArray(n._4e_name(),["input","select"])&&k.preventDefault()});o.on(d,"mouseup",function(k){var n=new C(k.target);
I.inArray(n._4e_name(),["input","textarea"])&&k.preventDefault()})}if(y.gecko||y.ie||y.opera){var c;c=new C(E.insertAfter((new C('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>'))[0],h));c.on("focus",function(){a.focus()});a.activateGecko=function(){y.gecko&&a.iframeFocus&&c[0].focus()};a.on("destroy",function(){})}if(y.ie&&d.compatMode=="CSS1Compat"||y.gecko||y.opera){var f=new C(d.documentElement);f.on("mousedown",function(k){if(k.target===f[0]){y.gecko&&
t(false);c[0].focus()}})}o.on(b,"focus",function(){if(y.gecko)t(false);else y.opera&&l.focus();a.notifySelectionChange()});y.gecko&&o.on(a.document,"mousedown",function(){a.iframeFocus||t(false)});if(y.ie){o.on(d,"keydown",function(k){if(k.keyCode in{8:1,46:1}){var n=a.getSelection(),x=n.getSelectedElement();if(x){a.fire("save");var J=n.getRanges()[0].createBookmark();x._4e_remove();n.selectBookmarks([J]);a.fire("save");k.preventDefault()}}});if(d.compatMode=="CSS1Compat"){var j={33:1,34:1};o.on(d,
"keydown",function(k){k.keyCode in j&&setTimeout(function(){a.getSelection().scrollIntoView()},0)})}}setTimeout(function(){y.ie&&setTimeout(function(){if(d){l.runtimeStyle.marginBottom="0px";l.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){a.fire("dataReady");var k=e.disableObjectResizing,n=e.disableInlineTableEditing;if(k||n)try{d.execCommand("enableObjectResizing",false,!k);d.execCommand("enableInlineTableEditing",false,!n)}catch(x){o.on(l,y.ie?"resizestart":"resize",function(J){if(k||
E._4e_name(J.target)==="table"&&n)J.preventDefault()})}},10);y.webkit&&o.on(d,"mousedown",function(k){k=new C(k.target);I.inArray(k._4e_name(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(k)});y.gecko&&o.on(d,"dragstart",function(k){var n=new C(k.target);n._4e_name()==="img"&&/ke_/.test(n[0].className)&&k.preventDefault()});q.add(a)};y.gecko&&function(){var h=document.body;if(h){var t=h.getAttribute("onpageshow");h.setAttribute("onpageshow",(t?t+";":"")+"event.persisted && KISSY.Editor.focusManager.refreshAll();")}else window.addEventListener("load",
arguments.callee,false)}()});
KISSY.Editor.add("dtd",function(z){z.XHTML_DTD=function(){var H=function(l){for(var c=arguments.length-1;c>0;)KISSY.mix(l,arguments[c--]);return l},I={isindex:1,fieldset:1},y={input:1,button:1,select:1,textarea:1,label:1},E=H({a:1},y),C=H({iframe:1},E),o={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},q={ins:1,del:1,script:1,style:1},g=H({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,
u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},q),i=H({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},g),r=H({p:1},i);y=H({iframe:1},i,y);i={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,dir:1,map:1,
dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var u=H({a:1},y),D={tr:1},v={"#":1},h=H({param:1},i),t=H({form:1},I,C,o,r),a={li:1},b={base:1,link:1,meta:1,title:1},d=H(b,{style:1,script:1}),e={head:1,body:1},m={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:H({html:1},e,b),$block:m,
$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:u,$body:H({script:1,style:1},m),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:e,head:d,style:v,body:t,base:{},link:{},meta:{},title:v,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:t,td:t,br:{},th:t,center:t,kbd:u,button:H(r,o),basefont:{},h5:u,h4:u,samp:u,h6:u,ol:a,h1:u,h3:u,option:v,h2:u,form:H(I,C,o,r),select:{optgroup:1,option:1},font:u,ins:u,menu:a,abbr:u,label:u,table:{thead:1,
col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:u,script:v,tfoot:D,cite:u,li:t,input:{},iframe:t,strong:u,textarea:v,noframes:t,big:u,small:u,span:u,hr:{},dt:u,sub:u,optgroup:{option:1},param:{},bdo:u,"var":u,div:t,object:h,sup:u,dd:t,strike:u,area:{},dir:a,map:H({area:1,form:1,p:1},I,q,o),applet:h,dl:{dt:1,dd:1},del:u,isindex:{},fieldset:H({legend:1},i),thead:D,ul:a,acronym:u,b:u,a:y,blockquote:t,caption:u,i:u,u:u,tbody:D,s:u,address:H(C,r),tt:u,legend:u,q:u,pre:H(g,E),p:u,em:u,dfn:u}}()});
KISSY.Editor.add("dom",function(z){function H(a){return a.replace(/-(\w)/g,function(b,d){return d.toUpperCase()})}var I=KISSY,y=I.DOM,E=I.UA,C=I.Node,o=z.Utils,q={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};z.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};z.POSITION={};var g=z.NODE,i=z.POSITION;i.POSITION_IDENTICAL=0;i.POSITION_DISCONNECTED=
1;i.POSITION_FOLLOWING=2;i.POSITION_PRECEDING=4;i.POSITION_IS_CONTAINED=8;i.POSITION_CONTAINS=16;var r={},u={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},D={hr:1},v=function(a){return a[0]||a},h=function(a){if(a&&!a[0])return new C(a);return a},t={_4e_wrap:h,_4e_equals:function(a,b){if(!a&&!b)return true;if(!a||!b)return false;a=v(a);b=v(b);return a===b},_4e_isBlockBoundary:function(a,
b){a=h(a);var d=I.mix(I.mix({},D),b||{});return u[a.css("display")]||d[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=v(a);for(var b=a.parentNode.childNodes,d=0;d<b.length;d++)if(b[d]===a)return d;return-1},_4e_first:function(a,b){a=v(a);var d=a.firstChild;if((d=d&&new C(d))&&b&&!b(d))d=d._4e_next(b);return d},_4e_move:function(a,b,d){a._4e_remove();a=v(a);b=v(b);d?b.insertBefore(a,b.firstChild):
b.appendChild(a)},_4e_name:function(a){a=v(a);var b=a.nodeName.toLowerCase();if(E.ie)if((a=a.scopeName)&&a!="HTML")b=a.toLowerCase()+":"+b;return b},_4e_isIdentical:function(a,b){if(a._4e_name()!=b._4e_name())return false;var d=a[0].attributes,e=b[0].attributes,m=d.length,l=e.length;if(!E.ie&&m!=l)return false;for(var c=0;c<m;c++){var f=d[c];if((!E.ie||f.specified&&f.nodeName!="_ke_expando")&&f.nodeValue!=b.attr(f.nodeName))return false}if(E.ie)for(c=0;c<l;c++){f=e[c];if(f.specified&&f.nodeName!=
"_ke_expando"&&f.nodeValue!=a.attr(f.nodeName))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=v(a).childNodes;for(var b=0,d=a.length;b<d;b++){var e=a[b],m=e.nodeType;if(!(m==g.NODE_ELEMENT&&e.getAttribute("_ke_bookmark")))if(m==g.NODE_ELEMENT&&!t._4e_isEmptyInlineRemoveable(e)||m==g.NODE_TEXT&&I.trim(e.nodeValue))return false}return true},_4e_moveChildren:function(a,b,d){a=v(a);b=b[0]||b;if(a!=b)if(d)for(;d=a.lastChild;)b.insertBefore(a.removeChild(d),b.firstChild);else for(;d=
a.firstChild;)b.appendChild(a.removeChild(d))},_4e_mergeSiblings:function(){function a(b,d,e){if(d[0]&&d[0].nodeType==g.NODE_ELEMENT){for(var m=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemoveable();){m.push(d);d=e?new C(d[0].nextSibling):new C(d[0].previousSibling);if(!d[0]||d[0].nodeType!=g.NODE_ELEMENT)return}if(b._4e_isIdentical(d)){for(var l=e?b[0].lastChild:b[0].firstChild;m.length;)m.shift()._4e_move(b,!e);d._4e_moveChildren(b,!e);d._4e_remove();l[0]&&l[0].nodeType==g.NODE_ELEMENT&&l._4e_mergeSiblings()}}}
return function(b){if(b[0])if(q[b._4e_name()]||b._4e_name()=="a"){a(b,new C(b[0].nextSibling),true);a(b,new C(b[0].previousSibling))}}}(),_4e_unselectable:E.gecko?function(a){a=v(a);a.style.MozUserSelect="none"}:E.webkit?function(a){a=v(a);a.style.KhtmlUserSelect="none"}:function(a){a=v(a);if(E.ie||E.opera){var b,d=0;for(a.unselectable="on";b=a.all[d++];)switch(b.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:b.unselectable="on"}}},_4e_getOffset:function(a,
b){a=v(a);var d,e=0;d=0;var m=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,l=a.ownerDocument,c=l.documentElement;b=b||l;if(a.getBoundingClientRect){if(a!==l.body&&c!==a){d=a.getBoundingClientRect();e=d.left+(b===l?y.scrollLeft(m):0);d=d.top+(b===l?y.scrollTop(m):0)}if(b)if(m!=(b.defaultView||b.parentWindow)&&m.frameElement){m=t._4e_getOffset(m.frameElement,b);e+=m.left;d+=m.top}}return{left:e,top:d}},_4e_getFrameDocument:function(a){return(a=v(a))&&a.contentWindow.document},_4e_splitText:function(a,
b){a=v(a);var d=a.ownerDocument;if(!(!a||a.nodeType!=g.NODE_TEXT)){if(E.ie&&b==a.nodeValue.length){var e=d.createTextNode("");y.insertAfter(e,a);return new C(e)}e=new C(a.splitText(b));if(E.ie==8){d=d.createTextNode("");y.insertAfter(d,e[0]);d.parentNode.removeChild(d)}return e}},_4e_parents:function(a,b){a=h(a);var d=[];do d[b?"push":"unshift"](a);while(a=a.parent());return d},_4e_clone:function(a,b,d){a=v(a);a=a.cloneNode(b);if(!d){var e=function(m){if(m.nodeType==g.NODE_ELEMENT){m.removeAttribute("id",
false);m.removeAttribute("_ke_expando",false);m=m.childNodes;for(var l=0;l<m.length;l++)e(m[l])}};e(a)}return new C(a)},_4e_nextSourceNode:function(a,b,d,e){a=v(a);if(e&&!e.call){var m=e[0]||e;e=function(c){c=c[0]||c;return c!==m}}b=!b&&a.firstChild;var l=new C(a);if(!b){if(a.nodeType==g.NODE_ELEMENT&&e&&e(a,true)===false)return null;b=a.nextSibling}for(;!b&&(l=l.parent());){if(e&&e(l,true)===false)return null;b=l[0].nextSibling}if(!b)return null;b=y._4e_wrap(b);if(e&&e(b)===false)return null;if(d&&
d!=b[0].nodeType)return b._4e_nextSourceNode(false,d,e);return b},_4e_previousSourceNode:function(a,b,d,e){a=v(a);if(e&&!e.call){var m=e[0]||e;e=function(c){c=c[0]||c;return c!==m}}b=!b&&a.lastChild;var l=new C(a);if(!b){if(a.nodeType==g.NODE_ELEMENT&&e&&e(a,true)===false)return null;b=a.previousSibling}for(;!b&&(l=l.parent());){if(e&&e(l,true)===false)return null;b=l[0].previousSibling}if(!b)return null;b=y._4e_wrap(b);if(e&&e(b)===false)return null;if(d&&b[0].nodeType!=d)return b._4e_previousSourceNode(false,
d,e);return b},_4e_contains:E.ie||E.webkit?function(a,b){a=v(a);b=v(b);return b.nodeType!=g.NODE_ELEMENT?a.contains(b.parentNode):a!=b&&a.contains(b)}:function(a,b){a=v(a);b=v(b);return!!(a.compareDocumentPosition(b)&16)},_4e_commonAncestor:function(a,b){if(a._4e_equals(b))return a;if(b[0].nodeType!=g.NODE_TEXT&&b._4e_contains(a))return b;var d=a[0].nodeType==g.NODE_TEXT?a.parent():a;do if(d[0].nodeType!=g.NODE_TEXT&&d._4e_contains(b))return d;while(d=d.parent());return null},_4e_ascendant:function(a,
b,d){a=v(a);if(!d)a=a.parentNode;if(b&&!I.isFunction(b)){var e=b;b=function(m){return m._4e_name()==e}}for(;a&&a.nodeType!=9;){if(!b||b(new C(a))===true)return new C(a);a=a.parentNode}return null},_4e_hasAttribute:function(a,b){a=v(a);var d=a.attributes.getNamedItem(b);return!!(d&&d.specified)},_4e_hasAttributes:E.ie?function(a){a=v(a);for(var b=a.attributes,d=0;d<b.length;d++){var e=b[d];switch(e.nodeName){case "class":if(a.getAttribute("class"))return true;break;case "_ke_expando":continue;default:if(e.specified)return true}}return false}:
function(a){a=v(a);E.gecko&&a.removeAttribute("_moz_dirty");a=a.attributes;return a.length>1||a.length==1&&a[0].nodeName!="_ke_expando"},_4e_position:function(a,b){var d=v(a),e=v(b);if(d.compareDocumentPosition)return d.compareDocumentPosition(e);if(d==e)return i.POSITION_IDENTICAL;if(d.nodeType==g.NODE_ELEMENT&&e.nodeType==g.NODE_ELEMENT){if(d.contains){if(d.contains(e))return i.POSITION_CONTAINS+i.POSITION_PRECEDING;if(e.contains(d))return i.POSITION_IS_CONTAINED+i.POSITION_FOLLOWING}if("sourceIndex"in
d)return d.sourceIndex<0||e.sourceIndex<0?i.POSITION_DISCONNECTED:d.sourceIndex<e.sourceIndex?i.POSITION_PRECEDING:i.POSITION_FOLLOWING}d=a._4e_address();e=b._4e_address();for(var m=Math.min(d.length,e.length),l=0;l<=m-1;l++)if(d[l]!=e[l]){if(l<m)return d[l]<e[l]?i.POSITION_PRECEDING:i.POSITION_FOLLOWING;break}return d.length<e.length?i.POSITION_CONTAINS+i.POSITION_PRECEDING:i.POSITION_IS_CONTAINED+i.POSITION_FOLLOWING},_4e_address:function(a,b){a=v(a);for(var d=[],e=a.ownerDocument.documentElement,
m=a;m&&m!=e;){var l=m.parentNode,c=-1;if(l){for(var f=0;f<l.childNodes.length;f++){var j=l.childNodes[f];if(!(b&&j.nodeType==3&&j.previousSibling&&j.previousSibling.nodeType==3)){c++;if(j==m)break}}d.unshift(c)}m=l}return d},_4e_breakParent:function(a,b){var d=new z.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);var e=d.extractContents();d.insertNode(a._4e_remove());a[0].parentNode.insertBefore(e,a[0].nextSibling)},_4e_style:function(a,b,d){if(d!==undefined)return a.css(b,d);a=a[0]||
a;return a.style[H(b)]},_4e_remove:function(a,b){var d=v(a),e=d.parentNode;if(e){if(b)for(var m;m=d.firstChild;)e.insertBefore(d.removeChild(m),d);e.removeChild(d)}return a},_4e_trim:function(a){y._4e_ltrim(a);y._4e_rtrim(a)},_4e_ltrim:function(a){a=v(a);for(var b;b=a.firstChild;){if(b.nodeType==g.NODE_TEXT){var d=o.ltrim(b.nodeValue),e=b.nodeValue.length;if(d){if(d.length<e){(new C(b))._4e_splitText(e-d.length);a.removeChild(a.firstChild)}}else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){a=
v(a);for(var b;b=a.lastChild;){if(b.type==g.NODE_TEXT){var d=o.rtrim(b.nodeValue),e=b.nodeValue.length;if(d){if(d.length<e){(new C(b))._4e_splitText(d.length);a.removeChild(a.lastChild)}}else{a.removeChild(b);continue}}break}if(!E.ie&&!E.opera)(b=a.lastChild)&&b.nodeType==1&&b.nodeName.toLowerCase()=="br"&&b.parentNode.removeChild(b)},_4e_appendBogus:function(a){a=v(a);for(var b=a.lastChild;b&&b.nodeType==g.NODE_TEXT&&!I.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==g.NODE_TEXT||y._4e_name(b)!==
"br"){b=E.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");E.gecko&&b.setAttribute("type","_moz");a.appendChild(b)}},_4e_previous:function(a,b){var d=v(a),e;do e=(d=d.previousSibling)&&new C(d);while(e&&b&&!b(e));return e},_4e_last:function(a,b){a=y._4e_wrap(a);var d=a[0].lastChild;if((d=d&&new C(d))&&b&&!b(d))d=d._4e_previous(b);return d},_4e_next:function(a,b){var d=v(a),e;do e=(d=d.nextSibling)&&new C(d);while(e&&b&&!b(e));return e},_4e_outerHtml:function(a){a=v(a);
if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(true));return b.innerHTML},_4e_setMarker:function(a,b,d,e){a=y._4e_wrap(a);var m=a._4e_getData("list_marker_id")||a._4e_setData("list_marker_id",I.guid())._4e_getData("list_marker_id"),l=a._4e_getData("list_marker_names")||a._4e_setData("list_marker_names",{})._4e_getData("list_marker_names");b[m]=a;l[d]=1;return a._4e_setData(d,e)},_4e_clearMarkers:function(a,b,d){a=h(a);
var e=a._4e_getData("list_marker_names"),m=a._4e_getData("list_marker_id"),l;for(l in e)a._4e_removeData(l);a._4e_removeData("list_marker_names");if(d){a._4e_removeData("list_marker_id");delete b[m]}},_4e_setData:function(a,b,d){var e=y._4e_getUniqueId(a);(r[e]||(r[e]={}))[b]=d;return a},_4e_getData:function(a,b){a=v(a);var d=a.getAttribute("_ke_expando");return(d=d&&r[d])&&d[b]},_4e_removeData:function(a,b){a=v(a);var d=a.getAttribute("_ke_expando");var e=(d=d&&r[d])&&d[b];typeof e!="undefined"&&
d&&delete d[b];I.isEmptyObject(d)&&y._4e_clearData(a);return e||null},_4e_clearData:function(a){a=v(a);var b=a.getAttribute("_ke_expando");b&&delete r[b];b&&a.removeAttribute("_ke_expando")},_4e_getUniqueId:function(a){a=v(a);var b=a.getAttribute("_ke_expando");if(b)return b;b=I.guid();a.setAttribute("_ke_expando",b);return b},_4e_copyAttributes:function(a,b,d){a=v(a);var e=a.attributes;d=d||{};for(var m=0;m<e.length;m++){var l=e[m],c=l.nodeName.toLowerCase(),f;if(!(c in d))if(c=="checked"&&(f=y.attr(a,
c)))b.attr(c,f);else if(l.specified||E.ie&&l.nodeValue&&c=="value"){f=y.attr(a,c);if(f===null)f=l.nodeValue;b.attr(c,f)}}if(a.style.cssText!=="")b[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=y._4e_name(a);var b=z.XHTML_DTD;return(a=!b.$nonEditable[a]&&(b[a]||b.span))&&a["#"]},_4e_scrollIntoView:function(a){a=h(a);var b=a[0].ownerDocument,d=y.scrollLeft(b),e=y.scrollTop(b),m=a.offset(),l=m.left;m=m.top;if(y.viewportHeight(b)+e<m||m<e||y.viewportWidth(b)+d<l||l<d)a.scrollIntoView(b)},
_4e_getElementsByTagName:function(a,b,d){a=v(a);if(!E.ie&&d)b=d+":"+b;d=[];a=a.getElementsByTagName(b);for(b=0;b<a.length;b++)d.push(new C(a[b]));return d}};I.DOM._4e_inject=function(a){I.mix(y,a);for(var b in a)a.hasOwnProperty(b)&&function(d){C.prototype[d]=function(){var e=[].slice.call(arguments,0);e.unshift(this);return a[d].apply(null,e)}}(b)};I.DOM._4e_inject(t)});
KISSY.Editor.add("elementpath",function(z){function H(i){var r=null,u=null,D=[];for(i=i;i&&i[0];){if(i[0].nodeType==C.NODE_ELEMENT){if(!this.lastElement)this.lastElement=i;var v=i._4e_name();if(o.ie&&i[0].scopeName!="HTML")v=i[0].scopeName.toLowerCase()+":"+v;if(!u){if(!r&&q[v])r=i;if(g[v]){var h;if(h=!r){if(h=v=="div"){a:{h=i;h=h[0]||h;h=h.childNodes;for(var t=0,a=h.length;t<a;t++){var b=h[t];if(b.nodeType==C.NODE_ELEMENT&&E.$block[b.nodeName.toLowerCase()]){h=true;break a}}h=false}h=!h}h=h}if(h)r=
i;else u=i}}D.push(i);if(v=="body")break}i=i.parent()}this.block=r;this.blockLimit=u;this.elements=D}var I=KISSY,y=I.DOM,E=z.XHTML_DTD,C=z.NODE,o=I.UA,q={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},g={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};H.prototype={compare:function(i){var r=this.elements;i=i&&i.elements;if(!i||r.length!=i.length)return false;for(var u=0;u<r.length;u++)if(!y._4e_equals(r[u],i[u]))return false;return true},contains:function(i){for(var r=
this.elements,u=0;u<r.length;u++)if(r[u]._4e_name()in i)return r[u];return null}};z.ElementPath=H});
KISSY.Editor.add("walker",function(z){function H(g,i){if(this._.end)return null;var r,u=this.range,D,v=this.guard,h=this.type,t=g?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;u.trim();if(u.collapsed){this.end();return null}}if(!g&&!this._.guardLTR){var a=u.endContainer,b=new q(a[0].childNodes[u.endOffset]);this._.guardLTR=function(l,c){return(l=o._4e_wrap(l))&&l[0]&&(!c||!o._4e_equals(a,l))&&(!b[0]||!l._4e_equals(b))&&(l[0].nodeType!=C.NODE_ELEMENT||!c||l._4e_name()!=
"body")}}if(g&&!this._.guardRTL){var d=u.startContainer,e=u.startOffset>0&&new q(d[0].childNodes[u.startOffset-1]);this._.guardRTL=function(l,c){return(l=o._4e_wrap(l))&&l[0]&&(!c||!l._4e_equals(d))&&(!e[0]||!l._4e_equals(e))&&(l[0].nodeType!=C.NODE_ELEMENT||!c||l._4e_name()!="body")}}var m=g?this._.guardRTL:this._.guardLTR;D=v?function(l,c){if(m(l,c)===false)return false;return v(l,c)}:m;if(this.current)r=this.current[t](false,h,D);else if(g){r=u.endContainer;if(u.endOffset>0){r=new q(r[0].childNodes[u.endOffset-
1]);if(D(r)===false)r=null}else r=D(r,true)===false?null:r._4e_previousSourceNode(true,h,D)}else{r=u.startContainer;if((r=new q(r[0].childNodes[u.startOffset]))&&r[0]){if(D(r)===false)r=null}else r=D(u.startContainer,true)===false?null:u.startContainer._4e_nextSourceNode(true,h,D)}for(;r&&r[0]&&!this._.end;){this.current=r;if(!this.evaluator||this.evaluator(r)!==false){if(!i)return r}else if(i&&this.evaluator)return false;r=r[t](false,h,D)}this.end();return this.current=null}function I(g){for(var i,
r=null;i=H.call(this,g);)r=i;return r}function y(g){this.range=g;this._={}}var E=KISSY,C=z.NODE,o=E.DOM,q=E.Node;E.augment(y,{end:function(){this._.end=1},next:function(){return H.call(this)},previous:function(){return H.call(this,true)},checkForward:function(){return H.call(this,false,true)!==false},checkBackward:function(){return H.call(this,true,true)!==false},lastForward:function(){return I.call(this)},lastBackward:function(){return I.call(this,true)},reset:function(){delete this.current;this._=
{}}});y.blockBoundary=function(g){return function(i){i=o._4e_wrap(i);return!(i&&i[0].nodeType==C.NODE_ELEMENT&&i._4e_isBlockBoundary(g))}};y.listItemBoundary=function(){return this.blockBoundary({br:1})};y.bookmark=function(g,i){function r(u){return u&&u[0]&&u._4e_name()=="span"&&u.attr("_ke_bookmark")}return function(u){var D,v;D=u&&u[0]&&u[0].nodeType==C.NODE_TEXT&&(v=u.parent())&&r(v);D=g?D:D||r(u);return i^D}};y.whitespaces=function(g){return function(i){i=(i=i[0]||i)&&i.nodeType==C.NODE_TEXT&&
!E.trim(i.nodeValue);return g^i}};y.invisible=function(g){var i=y.whitespaces();return function(r){r=i(r)||r[0].nodeType==C.NODE_ELEMENT&&!r[0].offsetHeight;return g^r}};z.Walker=y});
KISSY.Editor.add("range",function(z){function H(c){this.endOffset=this.endContainer=this.startOffset=this.startContainer=null;this.collapsed=true;this.document=c}function I(c){var f=c[0].nodeType!=g.NODE_TEXT&&c._4e_name()in t.$removeEmpty,j=!q.trim(c[0].nodeValue);c=!!c.parent().attr("_ke_bookmark");return f||j||c}function y(c){return!m(c)&&!l(c)}function E(c){var f=false,j=u.bookmark(true);return function(k){if(j(k))return true;if(k[0].nodeType==g.NODE_TEXT){if(q.trim(k[0].nodeValue).length)return false}else if(k[0].nodeType==
g.NODE_ELEMENT)if(!e[k._4e_name()])if(!c&&!h.ie&&k._4e_name()=="br"&&!f)f=true;else return false;return true}}function C(c,f){function j(k){return k&&k.nodeName=="span"&&k.getAttribute("_ke_bookmark")}return function(k){var n,x;n=k&&!k.nodeName&&(x=k.parentNode)&&j(x);n=c?n:n||j(k);return f^n}}function o(c){return function(f){f=(f=f[0]||f)&&f.nodeType==g.NODE_TEXT&&!q.trim(f.nodeValue);return c^f}}z.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var q=KISSY,g=z.NODE,i=z.RANGE,r=z.POSITION,u=z.Walker,D=q.DOM,v=z.Utils.getByAddress,h=q.UA,t=z.XHTML_DTD,a=z.ElementPath,b=q.Node,d={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};H.prototype.toString=function(){var c=[];c.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);c.push((this.endContainer[0].id||this.endContainer[0].nodeName)+
":"+this.endOffset);return c.join("<br/>")};q.augment(H,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&D._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var c=this.startContainer,f=this.startOffset;if(c[0].nodeType!=g.NODE_ELEMENT)if(f)f>=c[0].nodeValue.length&&this.setStartAfter(c);else this.setStartBefore(c);c=this.endContainer;f=this.endOffset;if(c[0].nodeType!=g.NODE_ELEMENT)if(f)f>=c[0].nodeValue.length&&
this.setEndAfter(c);else this.setEndBefore(c)},setStartAfter:function(c){this.setStart(c.parent(),c._4e_index()+1)},setStartBefore:function(c){this.setStart(c.parent(),c._4e_index())},setEndAfter:function(c){this.setEnd(c.parent(),c._4e_index()+1)},setEndBefore:function(c){this.setEnd(c.parent(),c._4e_index())},optimizeBookmark:function(){var c=this.startContainer,f=this.endContainer;c&&c._4e_name()=="span"&&c.attr("_ke_bookmark")&&this.setStartAt(c,i.POSITION_BEFORE_START);f&&f._4e_name()=="span"&&
f.attr("_ke_bookmark")&&this.setEndAt(f,i.POSITION_AFTER_END)},setStart:function(c,f){if(c[0].nodeType==g.NODE_ELEMENT&&d[c._4e_name()]){c=c.parent();f=c._4e_index()}this.startContainer=c;this.startOffset=f;if(!this.endContainer){this.endContainer=c;this.endOffset=f}this.updateCollapsed()},setEnd:function(c,f){if(c[0].nodeType==g.NODE_ELEMENT&&d[c._4e_name()]){c=c.parent();f=c._4e_index()+1}this.endContainer=c;this.endOffset=f;if(!this.startContainer){this.startContainer=c;this.startOffset=f}this.updateCollapsed()},
setStartAt:function(c,f){switch(f){case i.POSITION_AFTER_START:this.setStart(c,0);break;case i.POSITION_BEFORE_END:c[0].nodeType==g.NODE_TEXT?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setStartBefore(c);break;case i.POSITION_AFTER_END:this.setStartAfter(c)}this.updateCollapsed()},setEndAt:function(c,f){switch(f){case i.POSITION_AFTER_START:this.setEnd(c,0);break;case i.POSITION_BEFORE_END:c[0].nodeType==g.NODE_TEXT?this.setEnd(c,
c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case i.POSITION_BEFORE_START:this.setEndBefore(c);break;case i.POSITION_AFTER_END:this.setEndAfter(c)}this.updateCollapsed()},execContentsAction:function(c,f){var j=this.startContainer,k=this.endContainer,n=this.startOffset,x=this.endOffset,J,M=this.document,K;this.optimizeBookmark();if(k[0].nodeType==g.NODE_TEXT)k=k._4e_splitText(x);else if(k[0].childNodes.length>0)if(x>=k[0].childNodes.length){k=new b(k[0].appendChild(M.createTextNode("")));
K=true}else k=new b(k[0].childNodes[x]);if(j[0].nodeType==g.NODE_TEXT){j._4e_splitText(n);if(j._4e_equals(k))k=new b(j[0].nextSibling)}else if(n)if(n>=j[0].childNodes.length){J=new b(M.createTextNode(""));j.append(J);j=J;J=true}else j=new b(j[0].childNodes[n].previousSibling);else{J=new b(M.createTextNode(""));(n=j[0].firstChild)?D.insertBefore(J[0],n):j.append(J);j=J;J=true}n=j._4e_parents();x=k._4e_parents();var N,P,O;for(N=0;N<n.length;N++){P=n[N];O=x[N];if(!P._4e_equals(O))break}M=f;for(var p,
B,s,w=N;w<n.length;w++){p=n[w];if(M&&!p._4e_equals(j))B=M.appendChild(p._4e_clone()[0]);for(p=p[0].nextSibling;p;){if(D._4e_equals(x[w],p)||D._4e_equals(k,p))break;s=p.nextSibling;if(c==2)M.appendChild(p.cloneNode(true));else{p.parentNode.removeChild(p);c==1&&M.appendChild(p)}p=s}if(B)M=B}M=f;for(N=N;N<x.length;N++){p=x[N];if(c>0&&!p._4e_equals(k))B=M.appendChild(p._4e_clone()[0]);if(!n[N]||!p.parent()._4e_equals(n[N].parent()))for(p=p[0].previousSibling;p;){if(D._4e_equals(n[N],p)||D._4e_equals(j,
p))break;s=p.previousSibling;if(c==2)M.insertBefore(p.cloneNode(true),M.firstChild);else{D._4e_remove(p);c==1&&M.insertBefore(p,M.firstChild)}p=s}if(B)M=B}if(c==2){O=this.startContainer[0];if(O.nodeType==g.NODE_TEXT&&O.nextSibling&&O.nextSibling.nodeType==g.NODE_TEXT){O.data+=O.nextSibling.data;O.parentNode.removeChild(O.nextSibling)}O=this.endContainer[0];if(O.nodeType==g.NODE_TEXT&&O.nextSibling&&O.nextSibling.nodeType==g.NODE_TEXT){O.data+=O.nextSibling.data;O.parentNode.removeChild(O.nextSibling)}}else{if(P&&
O&&(!j.parent()._4e_equals(P.parent())||!k.parent()._4e_equals(O.parent()))){P=O._4e_index();J&&O.parent()._4e_equals(j.parent())&&P--;this.setStart(O.parent(),P)}this.collapse(true)}J&&j._4e_remove();K&&k[0].parentNode&&k._4e_remove()},collapse:function(c){if(c){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=true},clone:function(){var c=new H(this.document);c.startContainer=this.startContainer;
c.startOffset=this.startOffset;c.endContainer=this.endContainer;c.endOffset=this.endOffset;c.collapsed=this.collapsed;return c},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=g.NODE_ELEMENT||c.endContainer[0].nodeType!=g.NODE_ELEMENT)return null;var f=new z.Walker(c),j=C(true,undefined),k=o(true);c.evaluator=function(n){return k(n)&&j(n)};c=f.next();f.reset();f=f.previous();return c&&c._4e_equals(f)?c:null},shrink:function(c,f){if(!this.collapsed){c=c||
i.SHRINK_TEXT;var j=this.clone(),k=this.startContainer,n=this.endContainer,x=this.startOffset,J=this.endOffset,M=1,K=1;if(k&&k[0].nodeType==g.NODE_TEXT)if(x)if(x>=k[0].nodeValue.length)j.setStartAfter(k);else{j.setStartBefore(k);M=0}else j.setStartBefore(k);if(n&&n[0].nodeType==g.NODE_TEXT)if(J)if(J>=n[0].nodeValue.length)j.setEndAfter(n);else{j.setEndAfter(n);K=0}else j.setEndBefore(n);j=new u(j);j.evaluator=function(P){P=P[0]||P;return P.nodeType==(c==i.SHRINK_ELEMENT?g.NODE_ELEMENT:g.NODE_TEXT)};
var N;j.guard=function(P,O){P=P[0]||P;if(c==i.SHRINK_ELEMENT&&P.nodeType==g.NODE_TEXT)return false;if(O&&P==N)return false;if(!O&&P.nodeType==g.NODE_ELEMENT)N=P;return true};if(M)(k=j[c==i.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(k,f?i.POSITION_AFTER_START:i.POSITION_BEFORE_START);if(K){j.reset();(j=j[c==i.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(j,f?i.POSITION_BEFORE_END:i.POSITION_AFTER_END)}return!!(M||K)}},getTouchedStartNode:function(){var c=this.startContainer;
if(this.collapsed||c[0].nodeType!=g.NODE_ELEMENT)return c;return c.childNodes[this.startOffset]||c},createBookmark2:function(c){var f=this.startContainer,j=this.endContainer,k=this.startOffset,n=this.endOffset,x,J;if(!f||!j)return{start:0,end:0};if(c){if(f[0].nodeType==g.NODE_ELEMENT)if((x=new b(f[0].childNodes[k]))&&x[0]&&x[0].nodeType==g.NODE_TEXT&&k>0&&x[0].previousSibling.nodeType==g.NODE_TEXT){f=x;k=0}for(;f[0].nodeType==g.NODE_TEXT&&(J=f._4e_previous())&&J[0].nodeType==g.NODE_TEXT;){f=J;k+=
J[0].nodeValue.length}if(!this.collapsed){if(j[0].nodeType==g.NODE_ELEMENT)if((x=new b(j[0].childNodes[n]))&&x[0]&&x[0].nodeType==g.NODE_TEXT&&n>0&&x[0].previousSibling.nodeType==g.NODE_TEXT){j=x;n=0}for(;j[0].nodeType==g.NODE_TEXT&&(J=j._4e_previous())&&J[0].nodeType==g.NODE_TEXT;){j=J;n+=J[0].nodeValue.length}}}return{start:f._4e_address(c),end:this.collapsed?null:j._4e_address(c),startOffset:k,endOffset:n,normalized:c,is2:true}},createBookmark:function(c){var f,j,k,n;f=new b("<span>",null,this.document);
f.attr("_ke_bookmark",1);f.css("display","none");f.html("&nbsp;");if(c){k=q.guid("ke_bm_");f.attr("id",k+"S")}if(!this.collapsed){j=f._4e_clone();j.html("&nbsp;");c&&j.attr("id",k+"E");n=this.clone();n.collapse();n.insertNode(j)}n=this.clone();n.collapse(true);n.insertNode(f);if(j){this.setStartAfter(f);this.setEndBefore(j)}else this.moveToPosition(f,i.POSITION_AFTER_END);return{startNode:c?k+"S":f,endNode:c?k+"E":j,serializable:c}},moveToPosition:function(c,f){this.setStartAt(c,f);this.collapse(true)},
trim:function(c,f){var j=this.startContainer,k=this.startOffset,n=this.collapsed;if((!c||n)&&j[0]&&j[0].nodeType==g.NODE_TEXT){if(k)if(k>=j[0].nodeValue.length){k=j._4e_index()+1;j=j.parent()}else{var x=j._4e_splitText(k);k=j._4e_index()+1;j=j.parent();if(D._4e_equals(this.startContainer,this.endContainer))this.setEnd(x,this.endOffset-this.startOffset);else if(D._4e_equals(j,this.endContainer))this.endOffset+=1}else{k=j._4e_index();j=j.parent()}this.setStart(j,k);if(n){this.collapse(true);return}}j=
this.endContainer;k=this.endOffset;if(!(f||n)&&j[0]&&j[0].nodeType==g.NODE_TEXT){if(k){k>=j.nodeValue.length||j._4e_splitText(k);k=j._4e_index()+1}else k=j._4e_index();j=j.parent();this.setEnd(j,k)}},insertNode:function(c){this.optimizeBookmark();this.trim(false,true);var f=this.startContainer,j=f[0].childNodes[this.startOffset];this.optimizeBookmark();this.trim(false,true);j?D.insertBefore(c[0]||c,j):f[0].appendChild(c[0]||c);D._4e_equals(c.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(c)},
moveToBookmark:function(c){if(c.is2){var f=v(this.document,c.start,c.normalized),j=c.startOffset,k=c.end&&v(this.document,c.end,c.normalized);c=c.endOffset;this.setStart(f,j);k?this.setEnd(k,c):this.collapse(true)}else{f=(j=c.serializable)?q.one("#"+c.startNode,this.document):c.startNode;c=j?q.one("#"+c.endNode,this.document):c.endNode;this.setStartBefore(f);f._4e_remove();if(c&&c[0]){this.setEndBefore(c);c._4e_remove()}else this.collapse(true)}},getCommonAncestor:function(c,f){var j=this.startContainer,
k=this.endContainer;j=D._4e_equals(j,k)?c&&j[0].nodeType==g.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new b(j[0].childNodes[this.startOffset]):j:j._4e_commonAncestor(k);return f&&j[0].nodeType==g.NODE_TEXT?j.parent():j},enlarge:function(c){switch(c){case i.ENLARGE_ELEMENT:if(this.collapsed)break;c=this.getCommonAncestor();var f=new b(this.document.body),j,k,n,x,J,M=false,K,N;K=this.startContainer;N=this.startOffset;if(K[0].nodeType==g.NODE_TEXT){if(N){K=!q.trim(K[0].nodeValue.substring(0,N)).length&&
K;M=!!K}if(K)if(!(x=K[0].previousSibling))n=K.parent()}else{if(N)x=K[0].childNodes[N-1]||K[0].lastChild;x||(n=K)}for(;n||x;){if(n&&!x){if(!J&&D._4e_equals(n,c))J=true;if(!f._4e_contains(n))break;if(!M||n.css("display")!="inline"){M=false;if(J)j=n;else this.setStartBefore(n)}x=n[0].previousSibling}for(;x;){K=false;if(x.nodeType==g.NODE_TEXT){N=x.nodeValue;if(/[^\s\ufeff]/.test(N))x=null;K=/[\s\ufeff]$/.test(N)}else if(x.offsetWidth>0&&!x.getAttribute("_ke_bookmark"))if(M&&t.$removeEmpty[x.nodeName.toLowerCase()]){N=
D.text(x);if(/[^\s\ufeff]/.test(N))x=null;else for(var P=x.all||x.getElementsByTagName("*"),O=0,p;p=P[O++];)if(!t.$removeEmpty[p.nodeName.toLowerCase()]){x=null;break}if(x)K=!!N.length}else x=null;if(K)if(M)if(J)j=n;else n&&this.setStartBefore(n);else M=true;if(x){K=x.previousSibling;if(!n&&!K){n=new b(x);x=null;break}x=K}else n=null}if(n)n=n.parent()}K=this.endContainer;N=this.endOffset;n=x=null;J=M=false;if(K[0].nodeType==g.NODE_TEXT){K=!q.trim(K[0].nodeValue.substring(N)).length&&K;M=!(K&&K[0].nodeValue.length);
if(K)if(!(x=K[0].nextSibling))n=K.parent()}else(x=K[0].childNodes[N])||(n=K);for(;n||x;){if(n&&!x){if(!J&&D._4e_equals(n,c))J=true;if(!f._4e_contains(n))break;if(!M||n.css("display")!="inline"){M=false;if(J)k=n;else n&&this.setEndAfter(n)}x=n[0].nextSibling}for(;x;){K=false;if(x.nodeType==g.NODE_TEXT){N=x.nodeValue;if(/[^\s\ufeff]/.test(N))x=null;K=/^[\s\ufeff]/.test(N)}else if(x.offsetWidth>0&&!x.getAttribute("_ke_bookmark"))if(M&&t.$removeEmpty[x.nodeName.toLowerCase()]){N=D.text(x);if(/[^\s\ufeff]/.test(N))x=
null;else{P=x.all||x.getElementsByTagName("*");for(O=0;p=P[O++];)if(!t.$removeEmpty[p.nodeName.toLowerCase()]){x=null;break}}if(x)K=!!N.length}else x=null;if(K)if(M)if(J)k=n;else this.setEndAfter(n);if(x){K=x.nextSibling;if(!n&&!K){n=new b(x);x=null;break}x=K}else n=null}if(n)n=n.parent()}if(j&&k){c=j._4e_contains(k)?k:j;this.setStartBefore(c);this.setEndAfter(c)}break;case i.ENLARGE_BLOCK_CONTENTS:case i.ENLARGE_LIST_ITEM_CONTENTS:n=new H(this.document);f=new b(this.document.body);n.setStartAt(f,
i.POSITION_AFTER_START);n.setEnd(this.startContainer,this.startOffset);n=new u(n);var B,s,w=u.blockBoundary(c==i.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),A=function(G){var F=w(G);F||(B=G);return F};j=function(G){var F=A(G);if(!F&&G[0]&&G._4e_name()=="br")s=G;return F};n.guard=A;n=n.lastBackward();B=B||f;this.setStartAt(B,B._4e_name()!="br"&&(!n&&this.checkStartOfBlock()||n&&B._4e_contains(n))?i.POSITION_AFTER_START:i.POSITION_AFTER_END);n=this.clone();n.collapse();n.setEndAt(f,i.POSITION_BEFORE_END);
n=new u(n);n.guard=c==i.ENLARGE_LIST_ITEM_CONTENTS?j:A;B=null;n=n.lastForward();B=B||f;this.setEndAt(B,!n&&this.checkEndOfBlock()||n&&B._4e_contains(n)?i.POSITION_BEFORE_END:i.POSITION_BEFORE_START);s&&this.setEndAfter(s)}},checkStartOfBlock:function(){var c=this.startContainer,f=this.startOffset;if(f&&c[0].nodeType==g.NODE_TEXT)if(q.trim(c[0].nodeValue.substring(0,f)).length)return false;this.trim();c=new a(this.startContainer);f=this.clone();f.collapse(true);f.setStartAt(c.block||c.blockLimit,i.POSITION_AFTER_START);
c=new u(f);c.evaluator=E(true);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,f=this.endOffset;if(c[0].nodeType==g.NODE_TEXT)if(q.trim(c[0].nodeValue.substring(f)).length)return false;this.trim();c=new a(this.endContainer);f=this.clone();f.collapse(false);f.setEndAt(c.block||c.blockLimit,i.POSITION_BEFORE_END);c=new u(f);c.evaluator=E(false);return c.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var c=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,c);return c},checkBoundaryOfElement:function(c,f){var j=this.clone();j[f==i.START?"setStartAt":"setEndAt"](c,f==i.START?i.POSITION_AFTER_START:i.POSITION_BEFORE_END);j=new u(j);j.evaluator=I;return j[f==i.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var c=this.startContainer,f=this.endContainer,j=this.startOffset,k=this.endOffset,n;if(c[0].nodeType==g.NODE_ELEMENT){n=c[0].childNodes.length;if(n>
j)c=new b(c[0].childNodes[j]);else if(n<1)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=new b(c);c=c._4e_nextSourceNode()||c}}if(f[0].nodeType==g.NODE_ELEMENT){n=f[0].childNodes.length;if(n>k)f=(new b(f[0].childNodes[k]))._4e_previousSourceNode(true);else if(n<1)f=f._4e_previousSourceNode();else{for(f=f[0];f.lastChild;)f=f.lastChild;f=new b(f)}}if(c._4e_position(f)&r.POSITION_FOLLOWING)c=f;return{startNode:c,endNode:f}},fixBlock:function(c,f){var j=this.createBookmark(),
k=new b(this.document.createElement(f));this.collapse(c);this.enlarge(i.ENLARGE_BLOCK_CONTENTS);k[0].appendChild(this.extractContents());k._4e_trim();h.ie||k._4e_appendBogus();this.insertNode(k);this.moveToBookmark(j);return k},splitBlock:function(c){var f=new a(this.startContainer),j=new a(this.endContainer),k=f.block,n=j.block,x=null;if(!f.blockLimit._4e_equals(j.blockLimit))return null;if(c!="br"){if(!k){k=this.fixBlock(true,c);n=(new a(this.endContainer)).block}n||(n=this.fixBlock(false,c))}c=
k&&this.checkStartOfBlock();f=n&&this.checkEndOfBlock();this.deleteContents();if(k&&D._4e_equals(k,n))if(f){x=new a(this.startContainer);this.moveToPosition(n,i.POSITION_AFTER_END);n=null}else if(c){x=new a(this.startContainer);this.moveToPosition(k,i.POSITION_BEFORE_START);k=null}else{n=this.splitElement(k);!h.ie&&!q.inArray(k._4e_name(),["ul","ol"])&&k._4e_appendBogus()}return{previousBlock:k,nextBlock:n,wasStartOfBlock:c,wasEndOfBlock:f,elementPath:x}},splitElement:function(c){if(!this.collapsed)return null;
this.setEndAt(c,i.POSITION_BEFORE_END);var f=this.extractContents(),j=c._4e_clone(false);j[0].appendChild(f);j.insertAfter(c);this.moveToPosition(c,i.POSITION_AFTER_END);return j},moveToElementEditablePosition:function(c,f){var j,k=z.XHTML_DTD;if(k.$empty[c._4e_name()])return false;for(;c&&c[0].nodeType==g.NODE_ELEMENT;){if(j=c._4e_isEditable())this.moveToPosition(c,f?i.POSITION_BEFORE_END:i.POSITION_AFTER_START);else if(k.$inline[c._4e_name()]){this.moveToPosition(c,f?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);
return true}if((c=k.$empty[c._4e_name()]?c[f?"_4e_previous":"_4e_next"](y):c[f?"_4e_last":"_4e_first"](y))&&c[0].nodeType==g.NODE_TEXT){this.moveToPosition(c,f?i.POSITION_AFTER_END:i.POSITION_BEFORE_START);return true}}return j},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,c[0].nodeType==g.NODE_TEXT?c[0].nodeValue.length:c[0].childNodes.length)}});var e={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,
strong:1,sub:1,sup:1,tt:1,u:1,"var":1},m=new u.whitespaces,l=new u.bookmark;z.Range=H});
KISSY.Editor.add("domiterator",function(z){function H(D){if(!(arguments.length<1)){this.range=D;this.forceBrBreak=false;this.enlargeBr=true;this.enforceRealBlocks=false;this._||(this._={})}}var I=KISSY,y=I.UA,E=z.Walker,C=z.Range,o=z.RANGE,q=z.NODE,g=z.ElementPath,i=I.Node,r=I.DOM,u=/^[\r\n\t ]*$/;E.bookmark();I.augment(H,{getNextParagraph:function(D){var v,h,t,a,b;if(!this._.lastNode){h=this.range.clone();h.shrink(o.SHRINK_ELEMENT,true);h.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:
o.ENLARGE_BLOCK_CONTENTS);var d=new E(h),e=E.bookmark(true,true);d.evaluator=e;this._.nextNode=d.next();d=new E(h);d.evaluator=e;d=d.previous();this._.lastNode=d._4e_nextSourceNode(true);if(this._.lastNode&&this._.lastNode[0].nodeType==q.NODE_TEXT&&!I.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){e=new C(h.document);e.moveToPosition(this._.lastNode,o.POSITION_AFTER_END);if(e.checkEndOfBlock()){e=new g(e.endContainer);this._.lastNode=(e.block||e.blockLimit)._4e_nextSourceNode(true)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new i(h.document.createTextNode(""));r.insertAfter(this._.lastNode[0],d[0])}h=null}e=this._.nextNode;d=this._.lastNode;for(this._.nextNode=null;e;){var m=false,l=e[0].nodeType!=q.NODE_ELEMENT,c=false;if(l){if(e[0].nodeType==q.NODE_TEXT)if(u.test(e[0].nodeValue))l=false}else{var f=e._4e_name();if(e._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(f=="br")l=true;else if(!h&&!e[0].childNodes.length&&f!="hr"){v=e;t=e._4e_equals(d);break}if(h){h.setEndAt(e,o.POSITION_BEFORE_START);
if(f!="br")this._.nextNode=e}m=true}else{if(e[0].firstChild){if(!h){h=new C(this.range.document);h.setStartAt(e,o.POSITION_BEFORE_START)}e=new i(e[0].firstChild);continue}l=true}}if(l&&!h){h=new C(this.range.document);h.setStartAt(e,o.POSITION_BEFORE_START)}t=(!m||l)&&e._4e_equals(d);if(h&&!m)for(;!e[0].nextSibling&&!t;){f=e.parent();if(f._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){m=true;t||f._4e_equals(d);break}e=f;l=true;t=e._4e_equals(d);c=true}l&&h.setEndAt(e,o.POSITION_AFTER_END);e=e._4e_nextSourceNode(c,
null,d);if((t=!e)||m&&h)break}if(!v){if(!h){this._.docEndMarker&&this._.docEndMarker._4e_remove();return this._.nextNode=null}v=new g(h.startContainer);e=v.blockLimit;m={div:1,th:1,td:1};v=v.block;if((!v||!v[0])&&!this.enforceRealBlocks&&m[e._4e_name()]&&h.checkStartOfBlock()&&h.checkEndOfBlock())v=e;else if(!v||this.enforceRealBlocks&&v._4e_name()=="li"){v=new i(this.range.document.createElement(D||"p"));v[0].appendChild(h.extractContents());v._4e_trim();h.insertNode(v);a=b=true}else if(v._4e_name()!=
"li"){if(!h.checkStartOfBlock()||!h.checkEndOfBlock()){v=v._4e_clone(false);v[0].appendChild(h.extractContents());v._4e_trim();b=h.splitBlock();a=!b.wasStartOfBlock;b=!b.wasEndOfBlock;h.insertNode(v)}}else if(!t)this._.nextNode=v._4e_equals(d)?null:h.getBoundaryNodes().endNode._4e_nextSourceNode(true,null,d)}if(a){h=new i(v[0].previousSibling);if(h[0]&&h[0].nodeType==q.NODE_ELEMENT)if(h._4e_name()=="br")h._4e_remove();else h[0].lastChild&&r._4e_name(h[0].lastChild)=="br"&&r._4e_remove(h[0].lastChild)}if(b){h=
E.bookmark(false,true);a=new i(v[0].lastChild);if(a[0]&&a[0].nodeType==q.NODE_ELEMENT&&a._4e_name()=="br")if(y.ie||a._4e_previous(h)||a._4e_next(h))a._4e_remove()}if(!this._.nextNode)this._.nextNode=t||v._4e_equals(d)?null:v._4e_nextSourceNode(true,null,d);return v}});C.prototype.createIterator=function(){return new H(this)}});
KISSY.Editor.add("selection",function(z){function H(b){this.document=b;this._={cache:{}};if(E.ie){var d=this.getNative().createRange();if(!d||d.item&&d.item(0).ownerDocument!=b||d.parentElement&&d.parentElement().ownerDocument!=b)this.isInvalid=true}}function I(b){var d=b.document,e=new q(d.body),m=new q(d.documentElement);if(E.ie){if(E.ie<8||document.documentMode==7)m.on("click",function(n){C._4e_name(n.target)==="html"&&b.getSelection().getRanges()[0].select()});var l,c,f=1;m.on("mousedown",function(){f=
0});m.on("mouseup",function(){f=1});e.on("focusin",function(n){if(C._4e_name(n.target)=="body")if(l){try{f&&l.select()}catch(x){}l=null}});e.on("focus",function(){c=true;k()});e.on("beforedeactivate",function(n){if(!n.relatedTarget){c=false;f=1}});o.on(C._4e_getWin(d),"blur",function(){d&&d.selection.empty()});e.on("mousedown",function(){j()});e.on("mouseup",function(){c=true;setTimeout(function(){k(true)},0)});e.on("keydown",j);e.on("keyup",function(){c=true;k()});o.on(d,"selectionchange",k);var j=
function(){c=false},k=function(n){if(c){var x=b.document,J=b.getSelection(),M=J&&J.getType(),K=J&&J.getNative();if(n&&K&&M==g.SELECTION_NONE)if(!x.queryCommandEnabled("InsertImage")){setTimeout(function(){k(true)},50);return}var N;if(!(K&&M==g.SELECTION_TEXT&&(N=C._4e_name(K.createRange().parentElement()))&&N in{input:1,textarea:1})){l=K&&J.getRanges()[0];b._monitor()}}}}else{o.on(d,"mouseup",b._monitor,b);o.on(d,"keyup",b._monitor,b)}}z.SELECTION={};var y=KISSY,E=y.UA,C=y.DOM,o=y.Event,q=y.Node,
g=z.SELECTION,i=z.RANGE,r=z.NODE,u=z.Walker,D=z.Range;g.SELECTION_NONE=1;g.SELECTION_TEXT=2;g.SELECTION_ELEMENT=3;var v={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};y.augment(H,{getNative:E.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=C._4e_getWin(this.document).getSelection())},getType:E.ie?
function(){var b=this._.cache;if(b.type)return b.type;var d=g.SELECTION_NONE;try{var e=this.getNative(),m=e.type;if(m=="Text")d=g.SELECTION_TEXT;if(m=="Control")d=g.SELECTION_ELEMENT;if(e.createRange().parentElement)d=g.SELECTION_TEXT}catch(l){}return b.type=d}:function(){var b=this._.cache;if(b.type)return b.type;var d=g.SELECTION_TEXT,e=this.getNative();if(e){if(e.rangeCount==1){e=e.getRangeAt(0);var m=e.startContainer;if(m==e.endContainer&&m.nodeType==r.NODE_ELEMENT&&e.endOffset-e.startOffset===
1&&v[m.childNodes[e.startOffset].nodeName.toLowerCase()])d=g.SELECTION_ELEMENT}}else d=g.SELECTION_NONE;return b.type=d},getRanges:E.ie?function(){var b=function(d,e){d=d.duplicate();d.collapse(e);for(var m=d.parentElement(),l=m.childNodes,c,f=0;f<l.length;f++){var j=l[f];if(j.nodeType==r.NODE_ELEMENT){c=d.duplicate();c.moveToElementText(j);j=c.compareEndPoints("StartToStart",d);var k=c.compareEndPoints("EndToStart",d);c.collapse();if(j>0)break;else if(!j||k==1&&j==-1)return{container:m,offset:f};
else if(!k)return{container:m,offset:f+1};c=null}}if(!c){c=d.duplicate();c.moveToElementText(m);c.collapse(false)}c.setEndPoint("StartToStart",d);c=c.text.replace(/(\r\n|\r)/g,"\n").length;try{for(;c>0;)c-=l[--f].nodeValue.length}catch(n){c=0}return c===0?{container:m,offset:f}:{container:l[f],offset:-c}};return function(){var d=this._.cache;if(d.ranges)return d.ranges;var e=this.getNative(),m=e&&e.createRange(),l=this.getType();if(!e)return[];if(l==g.SELECTION_TEXT){e=new D(this.document);l=b(m,
true);e.setStart(new q(l.container),l.offset);l=b(m);e.setEnd(new q(l.container),l.offset);return d.ranges=[e]}else if(l==g.SELECTION_ELEMENT){d=this._.cache.ranges=[];for(l=0;l<m.length;l++){var c=m.item(l),f=c.parentNode,j=0;for(e=new D(this.document);j<f.childNodes.length&&f.childNodes[j]!=c;j++);e.setStart(new q(f),j);e.setEnd(new q(f),j+1);d.push(e)}return d}return d.ranges=[]}}():function(){var b=this._.cache;if(b.ranges)return b.ranges;var d=[],e=this.getNative();if(!e)return[];for(var m=0;m<
e.rangeCount;m++){var l=e.getRangeAt(m),c=new D(this.document);c.setStart(new q(l.startContainer),l.startOffset);c.setEnd(new q(l.endContainer),l.endOffset);d.push(c)}return b.ranges=d},getStartElement:function(){var b=this._.cache;if(b.startElement!==undefined)return b.startElement;var d,e=this.getNative();switch(this.getType()){case g.SELECTION_ELEMENT:return this.getSelectedElement();case g.SELECTION_TEXT:var m=this.getRanges()[0];if(m)if(!m.collapsed){for(m.optimize();;){d=m.startContainer;if(m.startOffset==
(d[0].nodeType===r.NODE_ELEMENT?d[0].childNodes.length:d[0].nodeValue.length)&&!d._4e_isBlockBoundary())m.setStartAfter(d);else break}d=m.startContainer;if(d[0].nodeType!=r.NODE_ELEMENT)return d.parent();d=new q(d[0].childNodes[m.startOffset]);if(!d[0]||d[0].nodeType!=r.NODE_ELEMENT)return m.startContainer;for(m=d[0].firstChild;m&&m.nodeType==r.NODE_ELEMENT;){d=new q(m);m=m.firstChild}return d}if(E.ie){m=e.createRange();m.collapse(true);d=m.parentElement()}else if((d=e.anchorNode)&&d.nodeType!=r.NODE_ELEMENT)d=
d.parentNode}return b.startElement=d?C._4e_wrap(d):null},getSelectedElement:function(){var b=this._.cache;if(b.selectedElement!==undefined)return b.selectedElement;var d=this,e;if(E.ie){e=d.getNative().createRange();e=e.item&&e.item(0)}e||(e=function(){for(var m=d.getRanges()[0],l,c,f=2;f&&!((l=m.getEnclosedNode())&&l[0].nodeType==r.NODE_ELEMENT&&v[l._4e_name()]&&(c=l));f--)m.shrink(i.SHRINK_ELEMENT);return c&&c[0]}());return b.selectedElement=C._4e_wrap(e)},reset:function(){this._.cache={}},selectElement:function(b){var d;
if(E.ie)try{d=this.document.body.createControlRange();d.addElement(b[0]);d.select()}catch(e){d=this.document.body.createTextRange();d.moveToElementText(b[0]);d.select()}finally{}else{d=this.document.createRange();d.selectNode(b[0]);b=this.getNative();b.removeAllRanges();b.addRange(d)}this.reset()},selectRanges:function(b){if(E.ie)b[0]&&b[0].select();else{var d=this.getNative();if(!d)return;d.removeAllRanges();for(var e=0;e<b.length;e++){var m=b[e],l=this.document.createRange(),c=m.startContainer;
m.collapsed&&E.gecko&&E.gecko<1.09&&c[0].nodeType==r.NODE_ELEMENT&&!c[0].childNodes.length&&c[0].appendChild(this.document.createTextNode(""));l.setStart(c[0],m.startOffset);l.setEnd(m.endContainer[0],m.endOffset);d.addRange(l)}}this.reset()},createBookmarks2:function(b){for(var d=[],e=this.getRanges(),m=0;m<e.length;m++)d.push(e[m].createBookmark2(b));return d},createBookmarks:function(b){for(var d=[],e=this.getRanges(),m=e.length,l=this.document,c,f=0;f<m;f++){d.push(c=e[f].createBookmark(b,true));
var j=(b=c.serializable)?y.one("#"+c.startNode,l):c.startNode;c=b?y.one("#"+c.endNode,l):c.endNode;for(var k=f+1;k<m;k++){var n=e[k],x=n.startContainer,J=n.endContainer;C._4e_equals(x,j.parent())&&n.startOffset++;C._4e_equals(x,c.parent())&&n.startOffset++;C._4e_equals(J,j.parent())&&n.endOffset++;C._4e_equals(J,c.parent())&&n.endOffset++}}return d},selectBookmarks:function(b){for(var d=[],e=0;e<b.length;e++){var m=new D(this.document);m.moveToBookmark(b[e]);d.push(m)}this.selectRanges(d);return this},
getCommonAncestor:function(){var b=this.getRanges();return b[0].startContainer._4e_commonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){this.getStartElement()._4e_scrollIntoView()}});z.Selection=H;var h={table:1,tbody:1,tr:1},t=u.whitespaces(true),a=/\ufeff|\u00a0/;D.prototype.select=E.ie?function(b){var d=this.collapsed,e,m;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var l=this.startContainer[0].childNodes[this.startOffset];if(l.nodeType==
r.NODE_ELEMENT){(new H(this.document)).selectElement(new q(l));return}}if(this.startContainer[0].nodeType==r.NODE_ELEMENT&&this.startContainer._4e_name()in h||this.endContainer[0].nodeType==r.NODE_ELEMENT&&this.endContainer._4e_name()in h)this.shrink(i.SHRINK_ELEMENT,true);var c=this.createBookmark();l=c.startNode;var f;if(!d)f=c.endNode;c=this.document.body.createTextRange();c.moveToElementText(l[0]);c.moveStart("character",1);if(f){b=this.document.body.createTextRange();b.moveToElementText(f[0]);
c.setEndPoint("EndToEnd",b);c.moveEnd("character",-1)}else{for(e=l[0].nextSibling;e&&!t(e);)e=e.nextSibling;e=!(e&&e.nodeValue&&e.nodeValue.match(a))&&(b||!l[0].previousSibling||l[0].previousSibling&&C._4e_name(l[0].previousSibling)=="br");m=this.document.createElement("span");m.innerHTML="&#65279;";m=new q(m);C.insertBefore(m[0],l[0]);e&&C.insertBefore(this.document.createTextNode("\ufeff"),l[0])}this.setStartBefore(l);l._4e_remove();if(d){if(e){c.moveStart("character",-1);c.select();this.document.selection.clear()}else c.select();
if(m){this.moveToPosition(m,i.POSITION_BEFORE_START);m._4e_remove()}}else{this.setEndBefore(f);f._4e_remove();c.select()}}:function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==r.NODE_ELEMENT&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));var d=this.document.createRange();d.setStart(b[0],this.startOffset);try{d.setEnd(this.endContainer[0],this.endOffset)}catch(e){if(e.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(true);d.setEnd(this.endContainer[0],
this.endOffset)}else throw e;}b=new H(this.document);b=(!b||b.isInvalid?null:b).getNative();b.removeAllRanges();b.addRange(d)};z.on("instanceCreated",function(b){I(b.editor)})});
KISSY.Editor.add("styles",function(z){function H(p,B){for(var s in p)p[s]=p[s].replace(O,function(w,A){return B[A]})}function I(p,B){if(B){p=e.clone(p);H(p.attributes,B);H(p.styles,B)}var s=this.element=(p.element||"*").toLowerCase();this.type=s=="#"||K[s]?l.STYLE_BLOCK:N[s]?l.STYLE_OBJECT:l.STYLE_INLINE;this._={definition:p}}function y(p,B){var s=B?this.removeFromRange:this.applyToRange;p.body.focus();for(var w=new f(p),A=w.getRanges(),G=0;G<A.length;G++)s.call(this,A[G]);w.selectRanges(A)}function E(p,
B){var s;s=p.element;if(s=="*")s="span";s=new x(B.createElement(s));return C(s,p)}function C(p,B){var s=B._.definition,w=s.attributes;s=I.getStyleText(s);if(w)for(var A in w)p.attr(A,w[A]);if(s)p[0].style.cssText=s;return p}function o(p){var B=p.createBookmark(true),s=p.createIterator();s.enforceRealBlocks=true;s.enlargeBr=true;for(var w,A=p.document;w=s.getNextParagraph();){var G=E(this,A);w=w;var F=G;G=F._4e_name=="pre";var L=w._4e_name=="pre",T=!G&&L;if(G&&!L){L=w;F=F;T=L.html();T=q(T,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,
"");T=T.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");T=T.replace(/([ \t\n\r]+|&nbsp;)/g," ");T=T.replace(/<br\b[^>]*>/gi,"\n");if(J.ie){L=L[0].ownerDocument.createElement("div");L.appendChild(F[0]);F[0].outerHTML="<pre>"+T+"</pre>";F=new x(L.firstChild);F._4e_remove()}else F.html(T);F=F}else if(T)F=i(g(w),F);else w._4e_moveChildren(F);w[0].parentNode.replaceChild(F[0],w[0]);if(G){w=F;G=void 0;if((G=w._4e_previousSourceNode(true,j.NODE_ELEMENT))&&G._4e_name()=="pre"){F=q(G.html(),/\n$/,"")+"\n\n"+
q(w.html(),/^\n/,"");if(J.ie)w[0].outerHTML="<pre>"+F+"</pre>";else w.html(F);G._4e_remove()}}}p.moveToBookmark(B)}function q(p,B,s){var w="",A="";p=p.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(G,F,L){F&&(w=F);L&&(A=L);return""});return w+p.replace(B,s)+A}function g(p){var B=[];q(p._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(s,w,A){return w+"</pre>"+A+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(s,
w){B.push(w)});return B}function i(p,B){for(var s=B[0].ownerDocument.createDocumentFragment(),w=0;w<p.length;w++){var A=p[w];A=A.replace(/(\r\n|\r)/g,"\n");A=q(A,/^[ \t]*\n/,"");A=q(A,/\n$/,"");A=q(A,/^[ \t]+|[ \t]+$/g,function(F,L){return F.length==1?"&nbsp;":L?" "+Array(F.length).join("&nbsp;"):Array(F.length).join("&nbsp;")+" "});A=A.replace(/\n/g,"<br>");A=A.replace(/[ \t]{2,}/g,function(F){return Array(F.length).join("&nbsp;")+" "});var G=B._4e_clone();G.html(A);s.appendChild(G[0])}return s}
function r(p){var B=p.document;if(p.collapsed){B=E(this,B);p.insertNode(B);p.moveToPosition(B,c.POSITION_BEFORE_END)}else{var s=this.element,w=this._.definition,A,G=z.XHTML_DTD[s]||(A=true,z.XHTML_DTD.span),F=p.createBookmark();p.enlarge(c.ENLARGE_ELEMENT);p.trim();var L=p.createBookmark(),T=L.startNode;L=L.endNode;for(var S=T,V;S&&S[0];){var Q=false;if(m._4e_equals(S,L)){S=null;Q=true}else{var R=S[0].nodeType,Y=R==j.NODE_ELEMENT?S._4e_name():null;if(Y&&S.attr("_ke_bookmark")){S=S._4e_nextSourceNode(true);
continue}if(!Y||G[Y]&&(S._4e_position(L)|k.POSITION_PRECEDING|k.POSITION_IDENTICAL|k.POSITION_IS_CONTAINED)==k.POSITION_PRECEDING+k.POSITION_IDENTICAL+k.POSITION_IS_CONTAINED&&(!w.childRule||w.childRule(S))){var U=S.parent();if(U&&U[0]&&((z.XHTML_DTD[U._4e_name()]||z.XHTML_DTD.span)[s]||A)&&(!w.parentRule||w.parentRule(U))){if(!V&&(!Y||!z.XHTML_DTD.$removeEmpty[Y]||(S._4e_position(L)|k.POSITION_PRECEDING|k.POSITION_IDENTICAL|k.POSITION_IS_CONTAINED)==k.POSITION_PRECEDING+k.POSITION_IDENTICAL+k.POSITION_IS_CONTAINED)){V=
new n(B);V.setStartBefore(S)}if(R==j.NODE_TEXT||R==j.NODE_ELEMENT&&!S[0].childNodes.length){R=S;for(var W;!R[0].nextSibling&&(W=R.parent(),G[W._4e_name()])&&(W._4e_position(T)|k.POSITION_FOLLOWING|k.POSITION_IDENTICAL|k.POSITION_IS_CONTAINED)==k.POSITION_FOLLOWING+k.POSITION_IDENTICAL+k.POSITION_IS_CONTAINED&&(!w.childRule||w.childRule(W));)R=W;V.setEndAfter(R);R[0].nextSibling||(Q=true)}}else Q=true}else Q=true;S=S._4e_nextSourceNode()}if(Q&&V&&!V.collapsed){Q=E(this,B);for(R=V.getCommonAncestor();Q&&
R&&Q[0]&&R[0];){if(R._4e_name()==s){for(var X in w.attributes)Q.attr(X)==R.attr(X)&&Q[0].removeAttribute(X);for(var aa in w.styles)Q._4e_style(aa)==R._4e_style(aa)&&Q._4e_style(aa,"");if(!Q._4e_hasAttributes()){Q=null;break}}R=R.parent()}if(Q){Q[0].appendChild(V.extractContents());R=Q;Y=h(this);U=R.all(this.element);for(var Z=U.length;--Z>=0;)t(this,new x(U[Z]));var $=void 0;for($ in Y)if($!=this.element){U=R.all($);for(Z=U.length-1;Z>=0;Z--){var ba=new x(U[Z]);b(ba,Y[$])}}V.insertNode(Q);Q._4e_mergeSiblings();
J.ie||Q[0].normalize()}V=null}}T._4e_remove();L._4e_remove();p.moveToBookmark(F);p.shrink(c.SHRINK_TEXT)}}function u(p){p.enlarge(c.ENLARGE_ELEMENT);var B=p.createBookmark(),s=B.startNode;if(p.collapsed){for(var w=new M(s.parent()),A,G=0,F;G<w.elements.length&&(F=w.elements[G]);G++){if(F==w.block||F==w.blockLimit)break;if(this.checkElementRemovable(F)){var L=p.checkBoundaryOfElement(F,c.END),T=!L&&p.checkBoundaryOfElement(F,c.START);if(T||L){A=F;A.match=T?"start":"end"}else{F._4e_mergeSiblings();
F._4e_name()==this.element?t(this,F):b(F,h(this)[F._4e_name()])}}}if(A&&A[0]){F=s;for(G=0;;G++){L=w.elements[G];if(m._4e_equals(L,A))break;else if(L.match)continue;else L=L._4e_clone();L[0].appendChild(F[0]);F=L}m[A.match=="start"?"insertBefore":"insertAfter"](F[0],A[0])}}else{var S=B.endNode,V=this;w=function(){for(var Q=new M(s.parent()),R=new M(S.parent()),Y=null,U=null,W=0;W<Q.elements.length;W++){var X=Q.elements[W];if(X==Q.block||X==Q.blockLimit)break;if(V.checkElementRemovable(X))Y=X}for(W=
0;W<R.elements.length;W++){X=R.elements[W];if(X==R.block||X==R.blockLimit)break;if(V.checkElementRemovable(X))U=X}U&&S._4e_breakParent(U);Y&&s._4e_breakParent(Y)};w();for(A=new x(s[0].nextSibling);A[0]!==S[0];){G=A._4e_nextSourceNode();if(A[0]&&A[0].nodeType==j.NODE_ELEMENT&&this.checkElementRemovable(A)){A._4e_name()==this.element?t(this,A):b(A,h(this)[A._4e_name()]);if(G[0].nodeType==j.NODE_ELEMENT&&G._4e_contains(s)){w();G=new x(s[0].nextSibling)}}A=G}}p.moveToBookmark(B)}function D(p){var B={};
p.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(s,w,A){B[w]=A});return B}function v(p,B){var s;if(B!==false){s=document.createElement("span");s.style.cssText=p;s=s.style.cssText||""}else s=p;return s.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function h(p){if(p._.overrides)return p._.overrides;var B=p._.overrides={},s=p._.definition.overrides;if(s){e.isArray(s)||(s=[s]);for(var w=0;w<s.length;w++){var A=s[w],G,F;if(typeof A==
"string")G=A.toLowerCase();else{G=A.element?A.element.toLowerCase():p.element;F=A.attributes}A=B[G]||(B[G]={});if(F){A=A.attributes=A.attributes||[];for(var L in F)A.push([L.toLowerCase(),F[L]])}}}return B}function t(p,B){var s=p._.definition,w=e.mix(e.mix({},s.attributes),h(p)[B._4e_name()]);s=s.styles;var A=e.isEmptyObject(w)&&e.isEmptyObject(s),G;for(G in w)if(!((G=="class"||p._.definition.fullMatch)&&B.attr(G)!=a(G,w[G]))){A=A||!!B._4e_hasAttribute(G);B.removeAttr(G)}for(var F in s)if(!(p._.definition.fullMatch&&
B._4e_style(F)!=a(F,s[F],true))){A=A||!!B._4e_style(F);B._4e_style(F,"")}A&&d(B)}function a(p,B,s){var w=new x("<span></span>");w[s?"_4e_style":"attr"](p,B);return w[s?"_4e_style":"attr"](p)}function b(p,B){var s=B&&B.attributes;if(s)for(var w=0;w<s.length;w++){var A=s[w][0],G;if(G=p.attr(A)){var F=s[w][1];if(F===null||F.test&&F.test(G)||typeof F=="string"&&G==F)p[0].removeAttribute(A)}}d(p)}function d(p){if(!p._4e_hasAttributes()){var B=p[0].firstChild,s=p[0].lastChild;p._4e_remove(true);if(B){B.nodeType==
j.NODE_ELEMENT&&m._4e_mergeSiblings(B);s&&!B===s&&s.nodeType==j.NODE_ELEMENT&&m._4e_mergeSiblings(s)}}}var e=KISSY,m=e.DOM,l=z.STYLE={},c=z.RANGE,f=z.Selection,j=z.NODE,k=z.POSITION,n=z.Range,x=e.Node,J=e.UA,M=z.ElementPath,K={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},N={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/,O=/#\((.+?)\)/g;l.STYLE_BLOCK=1;l.STYLE_INLINE=2;l.STYLE_OBJECT=3;I.prototype={apply:function(p){y.call(this,
p,false)},remove:function(p){y.call(this,p,true)},applyToRange:function(p){return(this.applyToRange=this.type==l.STYLE_INLINE?r:this.type==l.STYLE_BLOCK?o:this.type==l.STYLE_OBJECT?null:null).call(this,p)},removeFromRange:function(p){return(this.removeFromRange=this.type==l.STYLE_INLINE?u:null).call(this,p)},applyToObject:function(p){C(p,this)},checkElementRemovable:function(p,B){if(!p)return false;var s=this._.definition;if(p._4e_name()==this.element){if(!B&&!p._4e_hasAttributes())return true;var w=
s._AC;if(w)s=w;else{w={};var A=0,G=s.attributes;if(G)for(var F in G){A++;w[F]=G[F]}if(G=I.getStyleText(s)){w.style||A++;w.style=G}w._length=A;s=s._AC=w}if(s._length){for(var L in s)if(L!="_length"){A=p.attr(L)||"";if(L=="style")a:{w=s[L];A=v(A,false);typeof w=="string"&&(w=D(w));typeof A=="string"&&(A=D(A));G=void 0;for(G in w)if(!(G in A&&(A[G]==w[G]||w[G]=="inherit"||A[G]=="inherit"))){w=false;break a}w=true}else w=s[L]==A;if(w){if(!B)return true}else if(B)return false}if(B)return true}else return true}if(L=
h(this)[p._4e_name()]){if(!(s=L.attributes))return true;for(w=0;w<s.length;w++){L=s[w][0];if(L=p.attr(L)){A=s[w][1];if(A===null||typeof A=="string"&&L==A||A.test&&A.test(L))return true}}}return false},checkActive:function(p){switch(this.type){case l.STYLE_BLOCK:return this.checkElementRemovable(p.block||p.blockLimit,true);case l.STYLE_OBJECT:case l.STYLE_INLINE:for(var B=p.elements,s=0,w;s<B.length;s++){w=B[s];if(!(this.type==l.STYLE_INLINE&&(m._4e_equals(w,p.block)||m._4e_equals(w,p.blockLimit))))if(!(this.type==
l.STYLE_OBJECT&&!(w._4e_name()in N)))if(this.checkElementRemovable(w,true))return true}}return false}};I.getStyleText=function(p){var B=p._ST;if(B)return B;B=p.styles;var s=p.attributes&&p.attributes.style||"",w="";if(s.length)s=s.replace(P,";");for(var A in B){var G=B[A],F=(A+":"+G).replace(P,";");if(G=="inherit")w+=F;else s+=F}if(s.length)s=v(s);s+=w;return p._ST=s};z.Style=I});
