KISSY.Editor.add("dragupload",function(o){function p(a){a=a.originalEvent.target;if(e.DOM._4e_name(a)=="img")l[a.src]=a}function r(a,g){var d=new FileReader;d.onload=function(f){var h=a.name;f=f.target.result;var b=new XMLHttpRequest;b.open("POST",s,true);b.onreadystatechange=function(){if(b.readyState==4){if(b.status==200||b.status==304){if(b.responseText!=""){var t=e.JSON.parse(b.responseText);g[0].src=t.imgUrl}}else{alert("\u670d\u52a1\u5668\u7aef\u51fa\u9519\uff01");g._4e_remove();e.log(b)}b.onreadystatechange=null}};var c="\r\n------kissy-editor-2.1\r\n";
c+='Content-Disposition: form-data; name="'+u+'"; filename="'+encodeURIComponent(h)+'"\r\n';c+="Content-Type: "+(a.type||"application/octet-stream")+"\r\n\r\n";c+=f+"\r\n";i=q.Utils.normParams(i);for(var n in i)if(i.hasOwnProperty(n)){c+="------kissy-editor-2.1\r\n";c+='Content-Disposition: form-data; name="'+n+'"\r\n\r\n';c+=i[n]+"\r\n"}c+="------kissy-editor-2.1--";b.setRequestHeader("Content-Type","multipart/form-data, boundary=----kissy-editor-2.1");b.sendAsBinary("Content-Type: multipart/form-data; boundary=----kissy-editor-2.1\r\nContent-Length: "+
c.length+"\r\n"+c+"\r\n");d.onload=null};d.readAsBinaryString(a)}var e=KISSY,q=e.Editor,v=e.Node,m=e.Event,j=o.cfg.pluginConfig.dragupload||{},u=j.fileInput||"Filedata",w=j.sizeLimit||Number.MAX_VALUE,i=j.serverParams||{},s=j.serverUrl||"",x=RegExp((j.surfix||"png,jpg,jpeg,gif").split(/,/).join("|")+"$","i"),k=o.document,l={};m.on(k,"dragenter dragover",function(a){a.halt();m.on(k,"DOMNodeInserted",p)});m.on(k,"drop",function(a){m.remove(k,"DOMNodeInserted",p);a.halt();a=a.originalEvent;e.log(a);
var g,d;if(e.isEmptyObject(l)){d=k.elementFromPoint(a.clientX,a.clientY);g=d.lastChild}else{e.each(l,function(c){g=c.nextSibling;d=c.parentNode;e.DOM._4e_remove(c)});l={}}a=a.dataTransfer;a.dropEffect="copy";if(a=a.files)for(var f=0;f<a.length;f++){var h=a[f],b=h.size;if(h.name.match(x))if(!(b/1E3>w)){b=new v("<img src='"+(q.Config.base+"../theme/loading.gif")+"'/>");d.insertBefore(b[0],g);r(h,b)}}});if(window.XMLHttpRequest&&!XMLHttpRequest.prototype.sendAsBinary)XMLHttpRequest.prototype.sendAsBinary=
function(a,g){for(var d=new BlobBuilder,f=a.length,h=new Uint8Array(f),b=0;b<f;b++)h[b]=a.charCodeAt(b);d.append(h.buffer);this.send(d.getBlob(g))}},{attach:false});
