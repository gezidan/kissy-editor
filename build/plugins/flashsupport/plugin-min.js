KISSY.Editor.add("flashsupport",function(l){var g=KISSY.Editor,m=KISSY,t=m.Event,u=g.ContextMenu,o=m.Node,p=g.BubbleView,v=g.TripleButton,w=g.SimpleOverlay,j=l.htmlDataProcessor,i="ke_flash",q=g.Utils.getFlashUrl;l=j&&j.dataFilter;var x=["img."+i];g.Flash||function(){function c(a){this.editor=a;this._init()}function f(a){return a._4e_ascendant(function(b){return b._4e_name()==="img"&&!!b.hasClass(i)},true)}var y=/\.swf(?:$|\?)/i;c.isFlashEmbed=function(a){a=a.attributes;return a.type=="application/x-shockwave-flash"||
y.test(a.src||"")};m.augment(c,{_config:function(){this._cls=i;this._type="flash";this._title="Flash\u5c5e\ufffd?";this._bodyHtml="<div><p><label>\u5730\u5740\ufffd?<input class='ke-flash-url' style='width:280px' value='\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf'/></label></p><p style='margin:5px 0'><label>\u5bbd\u5ea6\ufffd?<input class='ke-flash-width' style='width:110px' /></label>&nbsp;&nbsp;<label>\u9ad8\u5ea6\ufffd?input class='ke-flash-height' style='width:110px' /></label></p>";this._footHtml=
"<button class='ke-flash-ok'>\u786e\u5b9a</button> <button class='ke-flash-cancel'>\u53d6\u6d88</button></div>";this._contentCls="ke-toolbar-flash";this._tip="\u63d2\u5165Flash";this._contextMenu=z;this._flashRules=x},_init:function(){this._config();var a=this.editor,b={},d=this._contextMenu;a._toolbars=a._toolbars||{};a._toolbars[this._type]=this;this.el=new v({container:a.toolBarDiv,contentCls:this._contentCls,title:this._tip});this.el.on("click",this.show,this);if(d)for(var e in d)(function(h){b[h]=
function(){d[h](a)}})(e);u.register(a.document,{rules:this._flashRules,width:"120px",funcs:b});p.attach({pluginName:this._type,pluginInstance:this});t.on(a.document,"dblclick",this._dbclick,this);g.Utils.lazyRun(this,"_prepareShow","_realShow")},_getFlashUrl:function(a){return q(a)},_updateTip:function(a,b){b=this.editor.restoreRealElement(b);a.html(this._getFlashUrl(b));a.attr("href",this._getFlashUrl(b))},_dbclick:function(a){var b=new o(a.target);if(b._4e_name()==="img"&&b.hasClass(this._cls)){this.show(null,
b);a.halt()}},_prepareShow:function(){var a=new w({title:this._title,width:"350px",mask:true});a.body.html(this._bodyHtml);a.foot.html(this._footHtml);this.d=a;this._initD()},_realShow:function(){this.d.show()},_updateD:function(){var a=this.editor,b=this.selectedFlash;if(b){a=a.restoreRealElement(b);a.attr("width")&&this.dWidth.val(parseInt(a.attr("width")));a.attr("height")&&this.dHeight.val(parseInt(a.attr("height")));this.dUrl.val(q(a))}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://www.xxx.com/xxx.swf");
this.dWidth.val("");this.dHeight.val("")}},show:function(a,b){this._prepareShow();this.selectedFlash=b;this._updateD()},_initD:function(){var a=this,b=a.d;a.dHeight=b.el.one(".ke-flash-height");a.dWidth=b.el.one(".ke-flash-width");a.dUrl=b.el.one(".ke-flash-url");var d=b.el.one(".ke-flash-ok");b=b.el.one(".ke-flash-cancel");d.on("click",a._gen,a);b.on("click",function(){a.d.hide()})},_getDURl:function(){return this.dUrl.val()},_getDWidth:function(){return this.dWidth.val()},_getDHeight:function(){return this.dHeight.val()},
_gen:function(){var a=this.editor,b=this._getDURl(),d=this._getDWidth(),e=this._getDHeight();if(m.trim(b)){b="<object "+(d?" width='"+d+"' ":" ")+(e?" height='"+e+"' ":" ")+' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"  codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0"><param name="quality" value="high" /><param name="movie" value="'+b+'" /><embed '+(d?" width='"+d+"' ":" ")+(e?" height='"+e+"' ":" ")+'pluginspage="http://www.macromedia.com/go/getflashplayer" quality="high"  src="'+
b+'"  type="application/x-shockwave-flash"/></object>';d=new o(b,null,a.document);b=a.createFakeElement?a.createFakeElement(d,this._cls,this._type,true,b):d;b=a.insertElement(b);this.selectedFlash&&a.getSelection().selectElement(b);this.d.hide()}}});g.Flash=c;c.registerBubble=function(a,b,d){p.register({pluginName:a,func:d,init:function(){var e=this,h=e.el;h.html(b+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var r=h.one(".ke-bubbleview-url"),s=h.one(".ke-bubbleview-change");h=h.one(".ke-bubbleview-remove");s._4e_unselectable();r._4e_unselectable();h._4e_unselectable();s.on("click",function(k){e._plugin.show(null,e._selectedEl);k.halt()});h.on("click",function(k){var n=e._plugin;e._selectedEl._4e_remove();n.editor.notifySelectionChange();k.halt()});e.on("afterVisibleChange",function(k){var n=e._selectedEl;k.newVal&&n&&e._plugin._updateTip(r,n)})}})};c.registerBubble("flash","Flash \u7f51\u5740\ufffd?",
f);c.checkFlash=f;var z={"Flash\u5c5e\ufffd?":function(a){var b=a.getSelection();b=b&&b.getStartElement();b=f(b);a=a._toolbars.flash;b&&a.show(null,b)}};c.CLS_FLASH=i;c.TYPE_FLASH="flash"}();l&&l.addRules({elements:{object:function(c){var f=c.attributes;if(!(f.classid&&String(f.classid).toLowerCase())){for(f=0;f<c.children.length;f++)if(c.children[f].name=="embed"){if(!g.Flash.isFlashEmbed(c.children[f]))return null;return j.createFakeParserElement(c,i,"flash",true)}return null}return j.createFakeParserElement(c,
i,"flash",true)},embed:function(c){if(!g.Flash.isFlashEmbed(c))return null;return j.createFakeParserElement(c,i,"flash",true)}}},5)});
