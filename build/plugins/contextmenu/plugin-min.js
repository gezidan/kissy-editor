KISSY.Editor.add("contextmenu",function(){function e(a){this.cfg=a;i.Utils.lazyRun(this,"_prepareShow","_realShow")}function o(a,c){for(var b=0;b<c.length;b++){var d=c[b];if(j.isFunction(d)){if(d(new l(a)))return true}else if(p.test(a,d))return true}return false}var i=KISSY.Editor,j=KISSY,l=j.Node,p=j.DOM,n=j.Event;if(!i.ContextMenu){e.ATTRS={editor:{}};var f=[];e.register=function(a){var c=new e(a),b=a.editor.document;f.push({doc:b,rules:a.rules||[],instance:c});if(!b.ke_contextmenu){b.ke_contextmenu=
1;n.on(b,"mousedown",e.hide);n.on(b,"contextmenu",function(d){e.hide.call(this);for(var g=new l(d.target);g;){var k=false;if(g._4e_name()=="body")break;for(var h=0;h<f.length;h++){var m=f[h].instance,q=f[h].rules;if(b===f[h].doc&&o(g[0],q)){d.preventDefault();k=true;setTimeout(function(){m.show(i.Utils.getXY(d.pageX,d.pageY,b,document))},30);break}}if(k)break;g=g.parent()}})}return c};e.hide=function(){for(var a=0;a<f.length;a++){var c=f[a].instance;this===f[a].doc&&c.hide()}};var r=i.SimpleOverlay;
j.augment(e,{_init:function(){var a=this,c=a.cfg,b=c.funcs;a.elDom=new l("<div onmousedown='return false;'>");var d=a.elDom;a.el=new r({el:d,width:c.width,cls:"ke-menu"});for(var g in b){c=new l("<a href='#'>"+g+"</a>");d[0].appendChild(c[0]);(function(k,h){k._4e_unselectable();k.on("click",function(m){a.hide();m.halt();setTimeout(h,30)})})(c,b[g])}},hide:function(){this.el&&this.el.hide()},_realShow:function(a){i.fire("contextmenu",{contextmenu:this});this.el.show(a)},_prepareShow:function(){this._init()},
show:function(a){this._prepareShow(a)}});i.ContextMenu=e}});
