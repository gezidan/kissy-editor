KISSY.Editor.add("music",function(j){function k(a){return a.indexOf(m)!=-1}var e=KISSY.Editor,n=KISSY,i=e.Flash,f="ke_music",m="niftyplayer.swf",o=e.Utils.getFlashUrl,g=j.htmlDataProcessor,l=g&&g.dataFilter;l&&l.addRules({elements:{object:function(a){var d=a.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<a.children.length;d++)if(a.children[d].name=="embed"){if(!i.isFlashEmbed(a.children[d]))return null;if(k(a.children[d].attributes.src))return g.createFakeParserElement(a,f,
"music",true)}return null}for(d=0;d<a.children.length;d++){var h=a.children[d];if(h.name=="param"&&h.attributes.name=="movie")if(k(h.attributes.value))return g.createFakeParserElement(a,f,"music",true)}},embed:function(a){if(!i.isFlashEmbed(a))return null;if(k(a.attributes.src))return g.createFakeParserElement(a,f,"music",true)}}},4);e.MusicInserter||function(){function a(){a.superclass.constructor.apply(this,arguments)}function d(b){return b._4e_ascendant(function(c){return c._4e_name()==="img"&&
!!c.hasClass(f)},true)}function h(b){return b.replace(/^.+niftyplayer\.swf\?file=/,"")}var p=e.Config.base+'plugins/music/niftyplayer.swf?file=#(music)"',q=/#\(music\)/g,r=["img."+f];n.extend(a,i,{_config:function(){this._cls=f;this._type="music";this._title="\u97f3\u4e50\u5c5e\ufffd?";this._bodyHtml="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\ufffd?</span><input class='ke-music-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3'/></label></p></div>";
this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=s;this._flashRules=r},_initD:function(){var b=this,c=b.d;b.dUrl=c.el.one(".ke-music-url");var t=c.el.one(".ke-music-ok");c=c.el.one(".ke-music-cancel");t.on("click",b._gen,b);c.on("click",function(){b.d.hide()})},_getDWidth:function(){return"165"},_getDURl:function(){return p.replace(q,this.dUrl.val())},
_getDHeight:function(){return"37"},_getFlashUrl:function(b){return h(o(b))},_updateD:function(){var b=this.editor,c=this.selectedFlash;c?this.dUrl.val(this._getFlashUrl(b.restoreRealElement(c))):this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3")}});i.registerBubble("music","\u97f3\u4e50\u7f51\u5740\ufffd?",d);e.MusicInserter=a;var s={"\u7f16\u8f91\u97f3\u4e50":function(b){var c=b.getSelection();c=(c=c&&c.getStartElement())&&d(c);b=b._toolbars.music;if(c){b.selectedFlash=c;b.show()}}}}();
j.addPlugin(function(){new e.MusicInserter(j)})});
