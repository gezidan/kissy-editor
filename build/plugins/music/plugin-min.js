KISSY.Editor.add("music",function(k){function l(c){return c.indexOf(n)!=-1}var f=KISSY.Editor,i=KISSY,o=i.DOM,p=i.UA,q=i.Event,j=f.Flash,e="ke_music",n="niftyplayer.swf",g=k.htmlDataProcessor,m=g&&g.dataFilter;m&&m.addRules({elements:{object:function(c){var d=c.attributes;if(!(d.classid&&String(d.classid).toLowerCase())){for(d=0;d<c.children.length;d++)if(c.children[d].name=="embed"){if(!j.isFlashEmbed(c.children[d]))return null;if(l(c.children[d].attributes.src))return g.createFakeParserElement(c,
e,"music",true)}return null}for(d=0;d<c.children.length;d++){var h=c.children[d];if(h.name=="param"&&h.attributes.name=="movie")if(l(h.attributes.value))return g.createFakeParserElement(c,e,"music",true)}},embed:function(c){if(!j.isFlashEmbed(c))return null;if(l(c.attributes.src))return g.createFakeParserElement(c,e,"music",true)}}},4);f.MusicInserter||function(){function c(a){c.superclass.constructor.apply(this,arguments);a.cfg.disableObjectResizing||q.on(a.document.body,p.ie?"resizestart":"resize",
function(b){o.hasClass(b.target,e)&&b.preventDefault()})}function d(a){return a._4e_name()==="img"&&!!a.hasClass(e)&&a}function h(a){return a.replace(/^.+niftyplayer\.swf\?file=/,"")}var r=f.Config.base+"plugins/music/niftyplayer.swf?file=#(music)",s="<p><label><span style='color:#0066CC;font-weight:bold;'>\u97f3\u4e50\u7f51\u5740\uff1a </span><input class='ke-music-url' style='width:230px' value='\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3'/></label></p><p style='margin:5px 0'><label>\u5bf9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\u9f50\uff1a <select class='ke-music-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
f.Utils.duplicateStr("&nbsp;",1)+"<label>\u95f4\u8ddd\uff1a </span> <input class='ke-music-margin' style='width:60px' value='5'/> \u50cf\u7d20</label><p>",t=/#\(music\)/g,u=["img."+e];i.extend(c,j,{_config:function(){this._cls=e;this._type="music";this._title="\u97f3\u4e50\u5c5e\u6027";this._bodyHtml=s;this._footHtml="<button class='ke-music-ok'>\u786e\u5b9a</button> <button class='ke-music-cancel'>\u53d6\u6d88</button>";this._contentCls="ke-toolbar-music";this._tip="\u63d2\u5165\u97f3\u4e50";this._contextMenu=
v;this._flashRules=u},_initD:function(){var a=this,b=a.d;a.dUrl=b.el.one(".ke-music-url");a.dAlign=b.el.one(".ke-music-align");a.dMargin=b.el.one(".ke-music-margin");var w=b.el.one(".ke-music-ok");b=b.el.one(".ke-music-cancel");w.on("click",a._gen,a);b.on("click",function(){a.d.hide()})},_getDInfo:function(){return{url:r.replace(t,this.dUrl.val()),attrs:{width:165,height:37,align:this.dAlign.val(),style:"margin:"+(parseInt(this.dMargin.val())||0)+"px;"}}},_getFlashUrl:function(a){return h(c.superclass._getFlashUrl.call(this,
a))},_updateD:function(){var a=this.editor,b=this.selectedFlash;if(b){a=a.restoreRealElement(b);this.dUrl.val(this._getFlashUrl(a));this.dAlign.val(b.attr("align"));this.dMargin.val(parseInt(a._4e_style("margin"))||0)}else{this.dUrl.val("\u8bf7\u8f93\u5165\u5982 http://xxx.com/xx.mp3");this.dAlign.val("");this.dMargin.val("5")}}});j.registerBubble("music","\u97f3\u4e50\u7f51\u5740\uff1a ",d);f.MusicInserter=c;var v={"\u97f3\u4e50\u5c5e\u6027":function(a){var b=a.getSelection();b=(b=b&&b.getStartElement())&&
d(b);a=a._toolbars.music;b&&a.show(null,b)}}}();k.addPlugin(function(){new f.MusicInserter(k)})});
