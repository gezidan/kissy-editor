KISSY.Editor.add("list",function(y){var m=KISSY.Editor,r={ol:1,ul:1},z=["ol","ul"],s=KISSY,A=m.RANGE,F=m.ElementPath,B=m.Walker,o=m.NODE,C=s.UA,p=s.Node,n=s.DOM;m.List||function(){function D(a){this.type=a}function x(a){x.superclass.constructor.call(this,a);a=this.get("editor").toolBarDiv;this.el=new v({contentCls:this.get("contentCls"),title:this.get("title"),container:a});this.listCommand=new D(this.get("type"));this.listCommand.state=this.get("status");this._init()}var q={listToArray:function(a,
g,c,j,h){if(!r[a._4e_name()])return[];j||(j=0);c||(c=[]);for(var f=0,b=a[0].childNodes.length;f<b;f++){var d=new p(a[0].childNodes[f]);if(d._4e_name()=="li"){var e={parent:a,indent:j,element:d,contents:[]};if(h)e.grandparent=h;else{e.grandparent=a.parent();if(e.grandparent&&e.grandparent._4e_name()=="li")e.grandparent=e.grandparent.parent()}g&&d._4e_setMarker(g,"listarray_index",c.length);c.push(e);for(var i=0,k=d[0].childNodes.length,l;i<k;i++){l=new p(d[0].childNodes[i]);l[0].nodeType==o.NODE_ELEMENT&&
r[l._4e_name()]?q.listToArray(l,g,c,j+1,e.grandparent):e.contents.push(l)}}}return c},arrayToList:function(a,g,c,j){c||(c=0);if(!a||a.length<c+1)return null;for(var h=a[c].parent[0].ownerDocument,f=h.createDocumentFragment(),b=null,d=c,e=Math.max(a[c].indent,0),i=null;;){var k=a[d];if(k.indent==e){if(!b||a[d].parent._4e_name()!=b._4e_name()){b=a[d].parent._4e_clone(false,true);f.appendChild(b[0])}i=b[0].appendChild(k.element._4e_clone(false,true)[0]);for(var l=0;l<k.contents.length;l++)i.appendChild(k.contents[l]._4e_clone(true,
true)[0]);d++}else if(k.indent==Math.max(e,0)+1){d=q.arrayToList(a,null,d,j);i.appendChild(d.listNode);d=d.nextIndex}else if(k.indent==-1&&!c&&k.grandparent){i=r[k.grandparent._4e_name()]?k.element._4e_clone(false,true)[0]:k.grandparent._4e_name()!="td"?h.createElement(j):h.createDocumentFragment();for(l=0;l<k.contents.length;l++)i.appendChild(k.contents[l]._4e_clone(true,true)[0]);if(i.nodeType==o.NODE_DOCUMENT_FRAGMENT&&d!=a.length-1){i.lastChild&&i.lastChild.nodeType==o.NODE_ELEMENT&&i.lastChild.getAttribute("type")==
"_moz"&&n._4e_remove(i.lastChild);n._4e_appendBogus(i)}if(i.nodeType==o.NODE_ELEMENT&&n._4e_name(i)==j&&i.firstChild){n._4e_trim(i);b=i.firstChild;if(b.nodeType==o.NODE_ELEMENT&&n._4e_isBlockBoundary(b)){b=h.createDocumentFragment();n._4e_moveChildren(i,b);i=b}}b=n._4e_name(i);if(!C.ie&&(b=="div"||b=="p"))n._4e_appendBogus(i);f.appendChild(i);b=null;d++}else return null;if(a.length<=d||Math.max(a[d].indent,0)<e)break}if(g)for(a=new p(f.firstChild);a&&a[0];){a[0].nodeType==o.NODE_ELEMENT&&a._4e_clearMarkers(g,
true);a=a._4e_nextSourceNode()}return{listNode:f,nextIndex:d}}},G=/^h[1-6]$/;D.prototype={changeListType:function(a,g,c,j){var h=q.listToArray(g.root,c),f=[];for(a=0;a<g.contents.length;a++){var b=g.contents[a];b=b._4e_ascendant("li",true);if(!(!b||!b[0]||b._4e_getData("list_item_processed"))){f.push(b);b._4e_setMarker(c,"list_item_processed",true)}}b=new p(g.root[0].ownerDocument.createElement(this.type));for(a=0;a<f.length;a++){var d=f[a]._4e_getData("listarray_index");h[d].parent=b}c=q.arrayToList(h,
c,null,"p");var e;h=c.listNode.childNodes.length;for(a=0;a<h&&(e=new p(c.listNode.childNodes[a]));a++)e._4e_name()==this.type&&j.push(e);n.insertBefore(c.listNode,g.root[0]);g.root._4e_remove()},createList:function(a,g,c){var j=g.contents;a=g.root[0].ownerDocument;var h=[];if(j.length==1&&j[0][0]===g.root[0]){var f=new p(a.createElement("div"));j[0][0].nodeType!=o.NODE_TEXT&&j[0]._4e_moveChildren(f);j[0][0].appendChild(f[0]);j[0]=f}g=g.contents[0].parent();for(f=0;f<j.length;f++)g=g._4e_commonAncestor(j[f].parent());
for(f=0;f<j.length;f++)for(var b=j[f],d;d=b.parent();){if(d[0]===g[0]){h.push(b);break}b=d}if(!(h.length<1)){j=new p(h[h.length-1][0].nextSibling);f=new p(a.createElement(this.type));for(c.push(f);h.length;){c=h.shift();b=new p(a.createElement("li"));if(G.test(c._4e_name()))b[0].appendChild(c[0]);else{c._4e_copyAttributes(b);c._4e_moveChildren(b);c._4e_remove()}f[0].appendChild(b[0]);C.ie||b._4e_appendBogus()}j[0]?n.insertBefore(f[0],j[0]):g[0].appendChild(f[0])}},removeList:function(a,g,c){function j(l){if((i=
new p(e[l?"firstChild":"lastChild"]))&&!(i[0].nodeType==o.NODE_ELEMENT&&i._4e_isBlockBoundary())&&(k=g.root[l?"_4e_previous":"_4e_next"](B.whitespaces(true)))&&!(i[0].nodeType==o.NODE_ELEMENT&&k._4e_isBlockBoundary({br:1})))n[l?"insertBefore":"insertAfter"](a.document.createElement("br"),i[0])}for(var h=q.listToArray(g.root,c),f=[],b=0;b<g.contents.length;b++){var d=g.contents[b];d=d._4e_ascendant("li",true);if(!(!d||d._4e_getData("list_item_processed"))){f.push(d);d._4e_setMarker(c,"list_item_processed",
true)}}d=null;for(b=0;b<f.length;b++){d=f[b]._4e_getData("listarray_index");h[d].indent=-1;d=d}for(b=d+1;b<h.length;b++)if(h[b].indent>Math.max(h[b-1].indent,0)){f=h[b-1].indent+1-h[b].indent;for(d=h[b].indent;h[b]&&h[b].indent>=d;){h[b].indent+=f;b++}b--}var e=q.arrayToList(h,c,null,"p").listNode,i,k;j(true);j();n.insertBefore(e,g.root);g.root._4e_remove()},exec:function(a){var g=a.getSelection(),c=g&&g.getRanges();if(!(!c||c.length<1)){for(var j=g.createBookmarks(true),h=[],f={};c.length>0;){var b=
c.shift(),d=b.getBoundaryNodes(),e=d.startNode,i=d.endNode;e[0].nodeType==o.NODE_ELEMENT&&e._4e_name()=="td"&&b.setStartAt(d.startNode,A.POSITION_AFTER_START);i[0].nodeType==o.NODE_ELEMENT&&i._4e_name()=="td"&&b.setEndAt(d.endNode,A.POSITION_BEFORE_END);b=b.createIterator();for(b.forceBrBreak=false;d=b.getNextParagraph();){e=new F(d);i=e.elements;var k=null,l=false,t=e.blockLimit,u;for(e=i.length-1;e>=0&&(u=i[e]);e--)if(r[u._4e_name()]&&t.contains(u)){t._4e_removeData("list_group_object");if(e=u._4e_getData("list_group_object"))e.contents.push(d);
else{e={root:u,contents:[d]};h.push(e);u._4e_setMarker(f,"list_group_object",e)}l=true;break}if(!l)if(t._4e_getData("list_group_object"))t._4e_getData("list_group_object").contents.push(d);else{e={root:t,contents:[d]};t._4e_setMarker(f,"list_group_object",e);h.push(e)}}}for(c=[];h.length>0;){e=h.shift();if(this.state=="off")r[e.root._4e_name()]?this.changeListType(a,e,f,c):this.createList(a,e,c);else this.state=="on"&&r[e.root._4e_name()]&&this.removeList(a,e,f)}for(e=0;e<c.length;e++){k=c[e];var H=
this;(a=function(E){var w=k[E?"_4e_previous":"_4e_next"](B.whitespaces(true));if(w&&w[0]&&w._4e_name()==H.type){w._4e_remove();w._4e_moveChildren(k,E?true:false)}})();a(true)}m.Utils.clearAllMarkers(f);g.selectBookmarks(j)}}};var v=m.TripleButton;x.ATTRS={editor:{},type:{},contentCls:{}};s.extend(x,s.Base,{_init:function(){var a=this,g=a.get("editor"),c=a.el;a=a;c.on("offClick",a._change,a);g.on("selectionChange",a._selectionChange,a);m.Utils.sourceDisable(g,a)},disable:function(){this.el.set("state",
v.DISABLED)},enable:function(){this.el.set("state",v.OFF)},_change:function(){var a=this.get("editor");this.get("type");var g=this.el;a.fire("save");this.listCommand.state=g.get("state");this.listCommand.exec(a);a.fire("save");a.notifySelectionChange()},_selectionChange:function(a){this.get("editor");var g=this.get("type"),c=a.path,j;a=this.el;var h=c.blockLimit;if(c=c.elements)for(var f=0;f<c.length&&(j=c[f])&&j[0]!==h[0];f++){var b=s.indexOf(c[f]._4e_name(),z);if(b!==-1)if(z[b]===g){a.set("state",
v.ON);return}else break}a.set("state",v.OFF)}});m.ListUtils=q;m.List=x}();y.addPlugin(function(){new m.List({editor:y,title:"\u9879\u76ee\u5217\u8868",contentCls:"ke-toolbar-ul",type:"ul"});new m.List({editor:y,title:"\u7f16\u53f7\u5217\u8868",contentCls:"ke-toolbar-ol",type:"ol"})})});
