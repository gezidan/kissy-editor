KISSY.Editor.add("list",function(x){var m=KISSY.Editor,r={ol:1,ul:1},z=["ol","ul"],s=KISSY,A=m.RANGE,G=m.ElementPath,B=m.Walker,o=m.NODE,C=s.UA,p=s.Node,n=s.DOM;m.List||function(){function D(a){this.type=a}function w(a){w.superclass.constructor.call(this,a);a=this.get("editor").toolBarDiv;this.el=new u({contentCls:this.get("contentCls"),title:this.get("title"),container:a});this.listCommand=new D(this.get("type"));this.listCommand.state=this.get("status");this._init()}var q={listToArray:function(a,
h,d,j,i){if(!r[a._4e_name()])return[];j||(j=0);d||(d=[]);for(var e=0,b=a[0].childNodes.length;e<b;e++){var c=new p(a[0].childNodes[e]);if(c._4e_name()=="li"){var g={parent:a,indent:j,element:c,contents:[]};if(i)g.grandparent=i;else{g.grandparent=a.parent();if(g.grandparent&&g.grandparent._4e_name()=="li")g.grandparent=g.grandparent.parent()}h&&c._4e_setMarker(h,"listarray_index",d.length);d.push(g);for(var f=0,k=c[0].childNodes.length,l;f<k;f++){l=new p(c[0].childNodes[f]);l[0].nodeType==o.NODE_ELEMENT&&
r[l._4e_name()]?q.listToArray(l,h,d,j+1,g.grandparent):g.contents.push(l)}}}return d},arrayToList:function(a,h,d,j){d||(d=0);if(!a||a.length<d+1)return null;for(var i=a[d].parent[0].ownerDocument,e=i.createDocumentFragment(),b=null,c=d,g=Math.max(a[d].indent,0),f=null;;){var k=a[c];if(k.indent==g){if(!b||a[c].parent._4e_name()!=b._4e_name()){b=a[c].parent._4e_clone(false,true);e.appendChild(b[0])}f=b[0].appendChild(k.element._4e_clone(false,true)[0]);for(var l=0;l<k.contents.length;l++)f.appendChild(k.contents[l]._4e_clone(true,
true)[0]);c++}else if(k.indent==Math.max(g,0)+1){c=q.arrayToList(a,null,c,j);f.appendChild(c.listNode);c=c.nextIndex}else if(k.indent==-1&&!d&&k.grandparent){if(r[k.grandparent._4e_name()])f=k.element._4e_clone(false,true)[0];else if(k.grandparent._4e_name()!="td"){f=i.createElement(j);k.element._4e_copyAttributes(new p(f))}else f=i.createDocumentFragment();for(l=0;l<k.contents.length;l++)f.appendChild(k.contents[l]._4e_clone(true,true)[0]);if(f.nodeType==o.NODE_DOCUMENT_FRAGMENT&&c!=a.length-1){f.lastChild&&
f.lastChild.nodeType==o.NODE_ELEMENT&&f.lastChild.getAttribute("type")=="_moz"&&n._4e_remove(f.lastChild);n._4e_appendBogus(f)}if(f.nodeType==o.NODE_ELEMENT&&n._4e_name(f)==j&&f.firstChild){n._4e_trim(f);b=f.firstChild;if(b.nodeType==o.NODE_ELEMENT&&n._4e_isBlockBoundary(b)){b=i.createDocumentFragment();n._4e_moveChildren(f,b);f=b}}b=n._4e_name(f);if(!C.ie&&(b=="div"||b=="p"))n._4e_appendBogus(f);e.appendChild(f);b=null;c++}else return null;if(a.length<=c||Math.max(a[c].indent,0)<g)break}if(h)for(a=
new p(e.firstChild);a&&a[0];){a[0].nodeType==o.NODE_ELEMENT&&a._4e_clearMarkers(h,true);a=a._4e_nextSourceNode()}return{listNode:e,nextIndex:c}}},H=/^h[1-6]$/;D.prototype={changeListType:function(a,h,d,j){var i=q.listToArray(h.root,d),e=[];for(a=0;a<h.contents.length;a++){var b=h.contents[a];b=b._4e_ascendant("li",true);if(!(!b||!b[0]||b._4e_getData("list_item_processed"))){e.push(b);b._4e_setMarker(d,"list_item_processed",true)}}b=new p(h.root[0].ownerDocument.createElement(this.type));for(a=0;a<
e.length;a++){var c=e[a]._4e_getData("listarray_index");i[c].parent=b}d=q.arrayToList(i,d,null,"p");var g;i=d.listNode.childNodes.length;for(a=0;a<i&&(g=new p(d.listNode.childNodes[a]));a++)g._4e_name()==this.type&&j.push(g);n.insertBefore(d.listNode,h.root[0]);h.root._4e_remove()},createList:function(a,h,d){var j=h.contents;a=h.root[0].ownerDocument;var i=[];if(j.length==1&&j[0][0]===h.root[0]){var e=new p(a.createElement("div"));j[0][0].nodeType!=o.NODE_TEXT&&j[0]._4e_moveChildren(e);j[0][0].appendChild(e[0]);
j[0]=e}h=h.contents[0].parent();for(e=0;e<j.length;e++)h=h._4e_commonAncestor(j[e].parent());for(e=0;e<j.length;e++)for(var b=j[e],c;c=b.parent();){if(c[0]===h[0]){i.push(b);break}b=c}if(!(i.length<1)){j=new p(i[i.length-1][0].nextSibling);e=new p(a.createElement(this.type));for(d.push(e);i.length;){d=i.shift();b=new p(a.createElement("li"));if(H.test(d._4e_name()))b[0].appendChild(d[0]);else{d._4e_copyAttributes(b);d._4e_moveChildren(b);d._4e_remove()}e[0].appendChild(b[0]);C.ie||b._4e_appendBogus()}j[0]?
n.insertBefore(e[0],j[0]):h[0].appendChild(e[0])}},removeList:function(a,h,d){function j(l){if((f=new p(g[l?"firstChild":"lastChild"]))&&!(f[0].nodeType==o.NODE_ELEMENT&&f._4e_isBlockBoundary())&&(k=h.root[l?"_4e_previous":"_4e_next"](B.whitespaces(true)))&&!(f[0].nodeType==o.NODE_ELEMENT&&k._4e_isBlockBoundary({br:1})))n[l?"insertBefore":"insertAfter"](a.document.createElement("br"),f[0])}for(var i=q.listToArray(h.root,d),e=[],b=0;b<h.contents.length;b++){var c=h.contents[b];c=c._4e_ascendant("li",
true);if(!(!c||c._4e_getData("list_item_processed"))){e.push(c);c._4e_setMarker(d,"list_item_processed",true)}}c=null;for(b=0;b<e.length;b++){c=e[b]._4e_getData("listarray_index");i[c].indent=-1;c=c}for(b=c+1;b<i.length;b++)if(i[b].indent>Math.max(i[b-1].indent,0)){e=i[b-1].indent+1-i[b].indent;for(c=i[b].indent;i[b]&&i[b].indent>=c;){i[b].indent+=e;b++}b--}var g=q.arrayToList(i,d,null,"p").listNode,f,k;j(true);j(undefined);n.insertBefore(g,h.root);h.root._4e_remove()},exec:function(a){var h=a.getSelection(),
d=h&&h.getRanges();if(!(!d||d.length<1)){for(var j=h.createBookmarks(true),i=[],e={};d.length>0;){var b=d.shift(),c=b.getBoundaryNodes(),g=c.startNode,f=c.endNode;g[0].nodeType==o.NODE_ELEMENT&&g._4e_name()=="td"&&b.setStartAt(c.startNode,A.POSITION_AFTER_START);f[0].nodeType==o.NODE_ELEMENT&&f._4e_name()=="td"&&b.setEndAt(c.endNode,A.POSITION_BEFORE_END);b=b.createIterator();for(b.forceBrBreak=false;c=b.getNextParagraph();){f=new G(c);var k=f.elements,l=null,E=false,y=f.blockLimit,t;for(g=k.length-
1;g>=0&&(t=k[g]);g--)if(r[t._4e_name()]&&y.contains(t)){y._4e_removeData("list_group_object");if(g=t._4e_getData("list_group_object"))g.contents.push(c);else{g={root:t,contents:[c]};i.push(g);t._4e_setMarker(e,"list_group_object",g)}E=true;break}if(!E){f=y||f.block;if(f._4e_getData("list_group_object"))f._4e_getData("list_group_object").contents.push(c);else{g={root:f,contents:[c]};f._4e_setMarker(e,"list_group_object",g);i.push(g)}}}}for(d=[];i.length>0;){g=i.shift();if(this.state=="off")r[g.root._4e_name()]?
this.changeListType(a,g,e,d):this.createList(a,g,d);else this.state=="on"&&r[g.root._4e_name()]&&this.removeList(a,g,e)}for(g=0;g<d.length;g++){l=d[g];var I=this;(a=function(F){var v=l[F?"_4e_previous":"_4e_next"](B.whitespaces(true));if(v&&v[0]&&v._4e_name()==I.type){v._4e_remove();v._4e_moveChildren(l,F?true:false)}})();a(true)}m.Utils.clearAllMarkers(e);h.selectBookmarks(j)}}};var u=m.TripleButton;w.ATTRS={editor:{},type:{},contentCls:{}};s.extend(w,s.Base,{_init:function(){var a=this.get("editor");
this.el.on("offClick onClick",this._change,this);a.on("selectionChange",this._selectionChange,this);m.Utils.sourceDisable(a,this)},disable:function(){this.el.set("state",u.DISABLED)},enable:function(){this.el.set("state",u.OFF)},_change:function(){var a=this.get("editor");this.get("type");var h=this.el;a.fire("save");this.listCommand.state=h.get("state");this.listCommand.exec(a);a.fire("save");a.notifySelectionChange()},_selectionChange:function(a){this.get("editor");var h=this.get("type"),d=a.path,
j;a=this.el;var i=d.blockLimit;if(d=d.elements)for(var e=0;e<d.length&&(j=d[e])&&j[0]!==i[0];e++){var b=s.indexOf(d[e]._4e_name(),z);if(b!==-1)if(z[b]===h){a.set("state",u.ON);return}else break}a.set("state",u.OFF)}});m.ListUtils=q;m.List=w}();x.addPlugin(function(){new m.List({editor:x,title:"项目列表",contentCls:"ke-toolbar-ul",type:"ul"});new m.List({editor:x,title:"编号列表",contentCls:"ke-toolbar-ol",type:"ol"})})});
