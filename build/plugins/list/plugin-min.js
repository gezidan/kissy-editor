KISSY.Editor.add("list",function(x){var m=KISSY.Editor,r={ol:1,ul:1},z=["ol","ul"],s=KISSY,A=m.RANGE,G=m.ElementPath,B=m.Walker,n=m.NODE,C=s.UA,o=s.Node,p=s.DOM;m.List||function(){function D(b){this.type=b}function w(b){w.superclass.constructor.call(this,b);b=this.get("editor").toolBarDiv;this.el=new u({contentCls:this.get("contentCls"),title:this.get("title"),container:b});this.listCommand=new D(this.get("type"));this.listCommand.state=this.get("status");this._init()}var q={listToArray:function(b,
h,d,j,i){if(!r[b._4e_name()])return[];j||(j=0);d||(d=[]);for(var f=0,a=b[0].childNodes.length;f<a;f++){var c=new o(b[0].childNodes[f]);if(c._4e_name()=="li"){var g={parent:b,indent:j,element:c,contents:[]};if(i)g.grandparent=i;else{g.grandparent=b.parent();if(g.grandparent&&g.grandparent._4e_name()=="li")g.grandparent=g.grandparent.parent()}h&&c._4e_setMarker(h,"listarray_index",d.length);d.push(g);for(var e=0,k=c[0].childNodes.length,l;e<k;e++){l=new o(c[0].childNodes[e]);l[0].nodeType==n.NODE_ELEMENT&&
r[l._4e_name()]?q.listToArray(l,h,d,j+1,g.grandparent):g.contents.push(l)}}}return d},arrayToList:function(b,h,d,j){d||(d=0);if(!b||b.length<d+1)return null;for(var i=b[d].parent[0].ownerDocument,f=i.createDocumentFragment(),a=null,c=d,g=Math.max(b[d].indent,0),e=null;;){var k=b[c];if(k.indent==g){if(!a||b[c].parent._4e_name()!=a._4e_name()){a=b[c].parent._4e_clone(false,true);f.appendChild(a[0])}e=a[0].appendChild(k.element._4e_clone(false,true)[0]);for(var l=0;l<k.contents.length;l++)e.appendChild(k.contents[l]._4e_clone(true,
true)[0]);c++}else if(k.indent==Math.max(g,0)+1){c=q.arrayToList(b,null,c,j);e.appendChild(c.listNode);c=c.nextIndex}else if(k.indent==-1&&!d&&k.grandparent){if(r[k.grandparent._4e_name()])e=k.element._4e_clone(false,true)[0];else if(k.grandparent._4e_name()!="td"){e=i.createElement(j);k.element._4e_copyAttributes(new o(e))}else e=i.createDocumentFragment();for(l=0;l<k.contents.length;l++){a=k.contents[l]._4e_clone(true,true);e.nodeType==n.NODE_DOCUMENT_FRAGMENT&&k.element._4e_copyAttributes(new o(a));
e.appendChild(a[0])}if(e.nodeType==n.NODE_DOCUMENT_FRAGMENT&&c!=b.length-1){e.lastChild&&e.lastChild.nodeType==n.NODE_ELEMENT&&e.lastChild.getAttribute("type")=="_moz"&&p._4e_remove(e.lastChild);p._4e_appendBogus(e)}if(e.nodeType==n.NODE_ELEMENT&&p._4e_name(e)==j&&e.firstChild){p._4e_trim(e);a=e.firstChild;if(a.nodeType==n.NODE_ELEMENT&&p._4e_isBlockBoundary(a)){a=i.createDocumentFragment();p._4e_moveChildren(e,a);e=a}}a=p._4e_name(e);if(!C.ie&&(a=="div"||a=="p"))p._4e_appendBogus(e);f.appendChild(e);
a=null;c++}else return null;if(b.length<=c||Math.max(b[c].indent,0)<g)break}if(h)for(b=new o(f.firstChild);b&&b[0];){b[0].nodeType==n.NODE_ELEMENT&&b._4e_clearMarkers(h,true);b=b._4e_nextSourceNode()}return{listNode:f,nextIndex:c}}},H=/^h[1-6]$/;D.prototype={changeListType:function(b,h,d,j){var i=q.listToArray(h.root,d),f=[];for(b=0;b<h.contents.length;b++){var a=h.contents[b];a=a._4e_ascendant("li",true);if(!(!a||!a[0]||a._4e_getData("list_item_processed"))){f.push(a);a._4e_setMarker(d,"list_item_processed",
true)}}a=new o(h.root[0].ownerDocument.createElement(this.type));for(b=0;b<f.length;b++){var c=f[b]._4e_getData("listarray_index");i[c].parent=a}d=q.arrayToList(i,d,null,"p");var g;i=d.listNode.childNodes.length;for(b=0;b<i&&(g=new o(d.listNode.childNodes[b]));b++)g._4e_name()==this.type&&j.push(g);p.insertBefore(d.listNode,h.root[0]);h.root._4e_remove()},createList:function(b,h,d){var j=h.contents;b=h.root[0].ownerDocument;var i=[];if(j.length==1&&j[0][0]===h.root[0]){var f=new o(b.createElement("div"));
j[0][0].nodeType!=n.NODE_TEXT&&j[0]._4e_moveChildren(f);j[0][0].appendChild(f[0]);j[0]=f}h=h.contents[0].parent();for(f=0;f<j.length;f++)h=h._4e_commonAncestor(j[f].parent());for(f=0;f<j.length;f++)for(var a=j[f],c;c=a.parent();){if(c[0]===h[0]){i.push(a);break}a=c}if(!(i.length<1)){j=new o(i[i.length-1][0].nextSibling);f=new o(b.createElement(this.type));for(d.push(f);i.length;){d=i.shift();a=new o(b.createElement("li"));if(H.test(d._4e_name()))a[0].appendChild(d[0]);else{d._4e_copyAttributes(a);
d._4e_moveChildren(a);d._4e_remove()}f[0].appendChild(a[0]);C.ie||a._4e_appendBogus()}j[0]?p.insertBefore(f[0],j[0]):h[0].appendChild(f[0])}},removeList:function(b,h,d){function j(l){if((e=new o(g[l?"firstChild":"lastChild"]))&&!(e[0].nodeType==n.NODE_ELEMENT&&e._4e_isBlockBoundary())&&(k=h.root[l?"_4e_previous":"_4e_next"](B.whitespaces(true)))&&!(e[0].nodeType==n.NODE_ELEMENT&&k._4e_isBlockBoundary({br:1})))p[l?"insertBefore":"insertAfter"](b.document.createElement("br"),e[0])}for(var i=q.listToArray(h.root,
d),f=[],a=0;a<h.contents.length;a++){var c=h.contents[a];c=c._4e_ascendant("li",true);if(!(!c||c._4e_getData("list_item_processed"))){f.push(c);c._4e_setMarker(d,"list_item_processed",true)}}c=null;for(a=0;a<f.length;a++){c=f[a]._4e_getData("listarray_index");i[c].indent=-1;c=c}for(a=c+1;a<i.length;a++)if(i[a].indent>Math.max(i[a-1].indent,0)){f=i[a-1].indent+1-i[a].indent;for(c=i[a].indent;i[a]&&i[a].indent>=c;){i[a].indent+=f;a++}a--}var g=q.arrayToList(i,d,null,"p").listNode,e,k;j(true);j(undefined);
p.insertBefore(g,h.root);h.root._4e_remove()},exec:function(b){var h=b.getSelection(),d=h&&h.getRanges();if(!(!d||d.length<1)){for(var j=h.createBookmarks(true),i=[],f={};d.length>0;){var a=d.shift(),c=a.getBoundaryNodes(),g=c.startNode,e=c.endNode;g[0].nodeType==n.NODE_ELEMENT&&g._4e_name()=="td"&&a.setStartAt(c.startNode,A.POSITION_AFTER_START);e[0].nodeType==n.NODE_ELEMENT&&e._4e_name()=="td"&&a.setEndAt(c.endNode,A.POSITION_BEFORE_END);a=a.createIterator();for(a.forceBrBreak=false;c=a.getNextParagraph();){e=
new G(c);var k=e.elements,l=null,E=false,y=e.blockLimit,t;for(g=k.length-1;g>=0&&(t=k[g]);g--)if(r[t._4e_name()]&&y.contains(t)){y._4e_removeData("list_group_object");if(g=t._4e_getData("list_group_object"))g.contents.push(c);else{g={root:t,contents:[c]};i.push(g);t._4e_setMarker(f,"list_group_object",g)}E=true;break}if(!E){e=y||e.block;if(e._4e_getData("list_group_object"))e._4e_getData("list_group_object").contents.push(c);else{g={root:e,contents:[c]};e._4e_setMarker(f,"list_group_object",g);i.push(g)}}}}for(d=
[];i.length>0;){g=i.shift();if(this.state=="off")r[g.root._4e_name()]?this.changeListType(b,g,f,d):this.createList(b,g,d);else this.state=="on"&&r[g.root._4e_name()]&&this.removeList(b,g,f)}for(g=0;g<d.length;g++){l=d[g];var I=this;(b=function(F){var v=l[F?"_4e_previous":"_4e_next"](B.whitespaces(true));if(v&&v[0]&&v._4e_name()==I.type){v._4e_remove();v._4e_moveChildren(l,F?true:false)}})();b(true)}m.Utils.clearAllMarkers(f);h.selectBookmarks(j)}}};var u=m.TripleButton;w.ATTRS={editor:{},type:{},
contentCls:{}};s.extend(w,s.Base,{_init:function(){var b=this.get("editor");this.el.on("offClick onClick",this._change,this);b.on("selectionChange",this._selectionChange,this);m.Utils.sourceDisable(b,this)},disable:function(){this.el.set("state",u.DISABLED)},enable:function(){this.el.set("state",u.OFF)},_change:function(){var b=this.get("editor");this.get("type");var h=this.el;b.fire("save");this.listCommand.state=h.get("state");this.listCommand.exec(b);b.fire("save");b.notifySelectionChange()},_selectionChange:function(b){this.get("editor");
var h=this.get("type"),d=b.path,j;b=this.el;var i=d.blockLimit;if(d=d.elements)for(var f=0;f<d.length&&(j=d[f])&&j[0]!==i[0];f++){var a=s.indexOf(d[f]._4e_name(),z);if(a!==-1)if(z[a]===h){b.set("state",u.ON);return}else break}b.set("state",u.OFF)}});m.ListUtils=q;m.List=w}();x.addPlugin(function(){new m.List({editor:x,title:"项目列表",contentCls:"ke-toolbar-ul",type:"ul"});new m.List({editor:x,title:"编号列表",contentCls:"ke-toolbar-ol",type:"ol"})})});
