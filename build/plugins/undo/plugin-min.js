KISSY.Editor.add("undo",function(i){var f=KISSY,e=f.Editor,m=e.Utils.arrayCompare,n=f.UA,o=f.Event;e.UndoManager||function(){function j(a){var b=a._getRawData(),c;if(b)c=a.getSelection();this.contents=b;this.bookmarks=c&&c.createBookmarks2(true)}function g(a){this.history=[];this.index=-1;this.editor=a;this.bufferRunner=e.Utils.buffer(this.save,this,500);this._init()}f.augment(j,{equals:function(a){if(this.contents!=a.contents)return false;var b=this.bookmarks;a=a.bookmarks;if(b||a){if(!b||!a||b.length!=
a.length)return false;for(var c=0;c<b.length;c++){var d=b[c],k=a[c];if(d.startOffset!=k.startOffset||d.endOffset!=k.endOffset||!m(d.start,k.start)||!m(d.end,k.end))return false}}return true}});var l={16:1,17:1,18:1},h={37:1,38:1,39:1,40:1,33:1,34:1};f.augment(g,{_keyMonitor:function(){var a=this.editor;o.on([a.document,a.textarea],"keydown",function(b){var c=b.keyCode;if(!(c in h||c in l))if(c===90&&(b.ctrlKey||b.metaKey)){a.fire("restore",{d:-1});b.halt()}else if(c===89&&(b.ctrlKey||b.metaKey)){a.fire("restore",
{d:1});b.halt()}else a.fire("save",{buffer:1})})},_init:function(){var a=this,b=a.editor;b.on("save",function(c){if(b.getMode()==e.WYSIWYG_MODE)c.buffer?a.bufferRunner():a.save()});b.on("restore",function(c){b.getMode()==e.WYSIWYG_MODE&&a.restore(c)});a._keyMonitor()},save:function(){var a=this.history,b=this.index;a.length>b+1&&a.splice(b+1,a.length-b-1);var c=this.editor;b=a[a.length-1];var d=new j(c);if(!b||!b.equals(d)){a.length===30&&a.shift();a.push(d);this.index=b=a.length-1;c.fire("afterSave",
{history:a,index:b})}},restore:function(a){a=a.d;var b=this.history,c=this.editor,d=b[this.index+a];if(d){c._setRawData(d.contents);if(d.bookmarks)c.getSelection().selectBookmarks(d.bookmarks);else if(n.ie){d=c.document.body.createTextRange();d.collapse(true);d.select()}(d=c.getSelection())&&d.scrollIntoView();this.index+=a;c.fire("afterRestore",{history:b,index:this.index});c.notifySelectionChange()}}});e.UndoManager=g}();i.ready(function(){new e.UndoManager(i);var j={redo:1,undo:-1},g={mode:e.WYSIWYG_MODE,
init:function(){this.editor.on("afterSave afterRestore",this.cfg._respond,this);this.btn.disable()},offClick:function(){this.editor.fire("restore",{d:j[this.cfg.flag]})}},l=f.mix({title:"\u64a4\u9500",flag:"undo",contentCls:"ke-toolbar-undo",_respond:function(h){var a=this.btn;h.index>0?a.boff():a.disable()}},g,false);g=f.mix({title:"\u91cd\u505a",flag:"redo",contentCls:"ke-toolbar-redo",_respond:function(h){var a=this.btn;h.index<h.history.length-1?a.boff():a.disable()}},g,false);i.addButton("undo",l);i.addButton("undo",
g)})});
