KISSY.Editor.add("table",function(s,t){var k=KISSY.Editor,g=KISSY,m=g.Node,E=g.DOM,F=k.Walker,u=g.UA,G=k.NODE,H=k.TripleButton,I=k.SimpleOverlay,J=k.Utils.isNumber,K=k.ContextMenu,L=["tr","th","td","tbody","table"],n=g.trim,v;v=(u.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var o=s.htmlDataProcessor,x=o&&o.dataFilter;o=o&&o.htmlFilter;x&&x.addRules({elements:{table:function(i){i=i.attributes;var j=i["class"],q=parseInt(i.border,10);if(!q||q<=0)i["class"]=(j||"")+" ke_show_border"}}});o&&o.addRules({elements:{table:function(i){i=i.attributes;var j=i["class"];if(j)i["class"]=g.trim(j.replace("ke_show_border","").replace(/\s{2}/," "))}}});k.TableUI||function(){function i(a){this.editor=a;this.selectedTable=
null;a._toolbars=a._toolbars||{};a._toolbars.table=this;this._init()}function j(a){return n(a).length!=0}function q(a){function b(r){if(!(f.length>0))if(r[0].nodeType==G.NODE_ELEMENT&&y.test(r._4e_name())&&!r._4e_getData("selected_cell")){r._4e_setMarker(e,"selected_cell",true);f.push(r)}}for(var d=a.createBookmarks(),c=a.getRanges(),f=[],e={},l=0;l<c.length;l++){var h=c[l];if(h.collapsed){h=h.getCommonAncestor();(h=h._4e_ascendant("td",true)||h._4e_ascendant("th",true))&&f.push(h)}else{h=new F(h);
var p;for(h.guard=b;p=h.next();)if((p=p.parent())&&y.test(p._4e_name())&&!p._4e_getData("selected_cell")){p._4e_setMarker(e,"selected_cell",true);f.push(p)}}}k.Utils.clearAllMarkers(e);a.selectBookmarks(d);return f}function M(a){a=a.cells;for(var b=0;b<a.length;b++){a[b].innerHTML="";u.ie||(new m(a[b]))._4e_appendBogus()}}function z(a,b){if(a=a.getStartElement()._4e_ascendant("tr")){var d=a._4e_clone(true);d.insertBefore(a);M(b?d[0]:a[0])}}function w(a){if(a instanceof k.Selection){var b=q(a),d=b.length;
a=[];for(var c,f,e=0;e<d;e++){var l=b[e].parent(),h=l[0].rowIndex;!e&&(c=h-1);a[h]=l;e==d-1&&(f=h+1)}e=l._4e_ascendant("table");c=new m(f<e[0].rows.length&&e[0].rows[f]||c>0&&e[0].rows[c]||e[0].parentNode);for(e=a.length;e>=0;e--)a[e]&&w(a[e]);return c}else if(a instanceof m){e=a._4e_ascendant("table");e[0].rows.length==1?e._4e_remove():a._4e_remove()}return 0}function A(a,b){a=a.getStartElement();if(a=a._4e_ascendant("td",true)||a._4e_ascendant("th",true))for(var d=a._4e_ascendant("table"),c=a[0].cellIndex,
f=0;f<d[0].rows.length;f++){var e=d[0].rows[f];if(!(e.cells.length<c+1)){a=new m(e.cells[c].cloneNode(false));u.ie||a._4e_appendBogus();e=new m(e.cells[c]);b?a.insertBefore(e):a.insertAfter(e)}}}function N(a){var b=[],d=a[0]&&a[0]._4e_ascendant("table"),c,f,e,l;c=0;for(f=a.length;c<f;c++)b.push(a[c][0].cellIndex);b.sort();c=1;for(f=b.length;c<f;c++)if(b[c]-b[c-1]>1){e=b[c-1]+1;break}e||(e=b[0]>0?b[0]-1:b[b.length-1]+1);a=d[0].rows;c=0;for(f=a.length;c<f;c++)if(l=a[c].cells[e])break;return l?new m(l):
d._4e_previous()}function B(a){if(a instanceof k.Selection){var b=q(a),d=N(b);for(a=b.length-1;a>=0;a--)b[a]&&B(b[a]);return d}else if(a instanceof m){b=a._4e_ascendant("table");if(!b)return null;d=a[0].cellIndex;for(a=b[0].rows.length-1;a>=0;a--){var c=new m(b[0].rows[a]);if(!d&&c[0].cells.length==1)w(c);else c[0].cells[d]&&c[0].removeChild(c[0].cells[d])}}return null}function C(a,b){var d=new k.Range(a[0].ownerDocument);if(!d.moveToElementEditablePosition(a,b?true:t)){d.selectNodeContents(a);d.collapse(b?
false:true)}d.select(true)}g.augment(i,{_init:function(){var a=this.editor,b={};this.el=new H({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:a.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var d in D)(function(c){b[c]=function(){a.fire("save");D[c](a);a.fire("save")}})(d);K.register(a.document,{rules:L,width:"120px",funcs:b});k.Utils.lazyRun(this,"_prepareTableShow","_realTableShow")},_tableInit:function(){var a=this,b=new I({width:"350px",mask:true,title:"\u8868\u683c\u5c5e\u6027"});
b.body.html("<table class='ke-table-config'><tr><td><label>\u884c\u6570\uff1a <input value='2' class='ke-table-rows ke-table-create-only' size='6'/></label></td><td><label>\u5bbd\u5ea6\uff1a <input value='200' class='ke-table-width' size='6'/></label> <select class='ke-table-width-unit'><option value='px'>\u50cf\u7d20</option><option value='%'>\u767e\u5206\u6bd4</option></select></td></tr><tr><td><label>\u5217\u6570\uff1a <input class='ke-table-cols ke-table-create-only' value='3' size='6'/></label></td><td><label>\u9ad8\u5ea6\uff1a <input value='' class='ke-table-height' size='6'/></label> &nbsp;\u50cf\u7d20</select></td></tr><tr><td><label>\u5bf9\u9f50\uff1a <select class='ke-table-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option><option value='center'>\u4e2d\u95f4\u5bf9\u9f50</option></select></label></td><td><label>\u6807\u9898\u683c\uff1a <select class='ke-table-head ke-table-create-only'><option value=''>\u65e0</option><option value='1'>\u6709</option></select></td></tr><tr><td><label>\u8fb9\u6846\uff1a <input value='1' class='ke-table-border' size='6'/></label> &nbsp;\u50cf\u7d20</select></td><td></td></tr><tr><td colspan='2'><label>\u6807\u9898\uff1a<input class='ke-table-caption' style='width:270px'></label></td></tr></table>");
b.foot.html("<button class='ke-table-ok'>\u786e\u5b9a</button> <button class='ke-table-cancel'>\u53d6\u6d88</button>");b.twidth=b.body.one(".ke-table-width");b.theight=b.body.one(".ke-table-height");b.tborder=b.body.one(".ke-table-border");b.tcaption=b.body.one(".ke-table-caption");b.talign=b.body.one(".ke-table-align");b.trows=b.body.one(".ke-table-rows");b.tcols=b.body.one(".ke-table-cols");b.thead=b.body.one(".ke-table-head");var d=b.foot.one(".ke-table-ok"),c=b.foot.one(".ke-table-cancel");b.twidthunit=
b.body.one(".ke-table-width-unit");a.tableDialog=b;d.on("click",a._tableOk,a);b.on("hide",function(){a.selectedTable=null});c.on("click",function(){b.hide()})},_tableOk:function(){for(var a=this.tableDialog,b=a.el.all("input"),d=0;d<b.length;d++){var c=new m(b[d]);if(c[0]!=a.tcaption[0])if(g.trim(c.val())&&!J(c.val())){a=c.parent("label").text().replace(/[:\uff1a]/g,"");alert(a+"\u8bf7\u8f93\u5165\u6570\u5b57");return}}this.selectedTable?this._modifyTable():this._genTable()},_modifyTable:function(){var a=
this.tableDialog,b=this.selectedTable,d=b.one("caption");j(a.talign.val())&&b.attr("align",n(a.talign.val()));j(a.tborder.val())&&b.attr("border",n(a.tborder.val()));!j(a.tborder.val())||a.tborder.val()=="0"?b.addClass("ke_show_border"):b.removeClass("ke_show_border");j(a.twidth.val())&&b.css("width",n(a.twidth.val())+a.twidthunit.val());j(a.theight.val())&&b.css("height",n(a.theight.val()));if(j(a.tcaption.val()))d&&d[0]?d.html(n(a.tcaption.val())):(new m("<caption><span>"+n(a.tcaption.val())+"</span></caption>")).insertBefore(b[0].firstChild);
else d&&d._4e_remove();a.hide()},_genTable:function(){var a=this.tableDialog,b="<table ",d,c=parseInt(a.tcols.val())||1,f=parseInt(a.trows.val())||1,e=u.ie?"":"<br/>",l=this.editor;if(g.trim(a.talign.val()).length!=0)b+="align='"+g.trim(a.talign.val())+"' ";if(g.trim(a.tborder.val()).length!=0)b+="border='"+g.trim(a.tborder.val())+"' ";if(g.trim(a.twidth.val()).length!=0||g.trim(a.theight.val()).length!=0){b+="style='";if(g.trim(a.twidth.val()).length!=0)b+="width:"+g.trim(a.twidth.val())+a.twidthunit.val()+
";";if(g.trim(a.theight.val()).length!=0)b+="height:"+g.trim(a.theight.val())+"px;";b+="' "}if(g.trim(a.tborder.val()).length==0||g.trim(a.tborder.val())=="0")b+="class='ke_show_border' ";b+=">";if(g.trim(a.tcaption.val()))b+="<caption><span>"+g.trim(a.tcaption.val())+"</span></caption>";if(a.thead.val()){b+="<thead>";b+="<tr>";for(d=0;d<c;d++)b+="<th>"+e+"</th>";b+="</tr>";b+="</thead>";f-=1}b+="<tbody>";for(var h=0;h<f;h++){b+="<tr>";for(d=0;d<c;d++)b+="<td>"+e+"</td>";b+="</tr>"}b+="</tbody>";
b+="</table>";b=new m(b,null,l.document);l.insertElement(b);a.hide()},_fillTableDialog:function(){var a=this.tableDialog,b=this.selectedTable,d=b.one("caption");a.talign.val(b.attr("align")||"");a.tborder.val(b.attr("border")|"");var c=b._4e_style("width")||"";a.twidth.val(c.replace(/px|%/i,""));c.indexOf("%")!=-1?a.twidthunit.val("%"):a.twidthunit.val("px");a.theight.val((b._4e_style("height")||"").replace(/px|%/i,""));c="";if(d)c=d.text();a.tcaption.val(c);a.trows.val(b.one("tbody").children().length);
a.tcols.val(b.one("tr").children().length);a.thead.val(b._4e_first(function(f){return f._4e_name()=="thead"})?"1":"")},_realTableShow:function(){if(this.selectedTable){this._fillTableDialog();this.tableDialog.body.all(".ke-table-create-only").attr("disabled","disabled")}else this.tableDialog.body.all(".ke-table-create-only").removeAttr("disabled");this.tableDialog.show()},_prepareTableShow:function(){this._tableInit()},_tableShow:function(){this._prepareTableShow()}});var y=/^(?:td|th)$/,D={"\u8868\u683c\u5c5e\u6027":function(a){var b=
a.getSelection();if(b=(b=b&&b.getStartElement())&&b._4e_ascendant("table",true)){a=a._toolbars.table;a.selectedTable=b;a._tableShow()}},"\u5220\u9664\u8868\u683c":function(a){var b=(a=a.getSelection())&&a.getStartElement();if(b=b&&b._4e_ascendant("table",true)){a.selectElement(b);var d=a.getRanges()[0];d.collapse();a.selectRanges([d]);a=b.parent();a[0].childNodes.length==1&&a._4e_name()!="body"&&a._4e_name()!="td"?a._4e_remove():b._4e_remove()}},"\u5220\u9664\u884c ":function(a){a=a.getSelection();
C(w(a),t)},"\u5220\u9664\u5217 ":function(a){a=a.getSelection();(a=B(a))&&C(a,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(a){a=a.getSelection();z(a,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(a){a=a.getSelection();z(a,t)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(a){a=a.getSelection();A(a,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(a){a=a.getSelection();A(a,t)}};k.TableUI=i}();s.addPlugin(function(){var i=s.document;new k.TableUI(s);var j=E.create("<style>",
null,i);i.getElementsByTagName("head")[0].appendChild(j);if(j.styleSheet)j.styleSheet.cssText=v;else j.appendChild(i.createTextNode(v))})});
