KISSY.Editor.add("table",function(r,s){var o=KISSY,j=o.Editor,k=o.Node,C=j.Walker,t=o.UA,D=j.NODE,E=j.TripleButton,F=j.ContextMenu,G=["tr","th","td","tbody","table"],H=o.trim,v;v=(t.ie===6?["table.%2,","table.%2 td, table.%2 th,","{","border : #d3d3d3 1px dotted","}"]:[" table.%2,"," table.%2 > tr > td,  table.%2 > tr > th,"," table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,"," table.%2 > thead > tr > td,  table.%2 > thead > tr > th,"," table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th",
"{","border : #d3d3d3 1px dotted","}"]).join("").replace(/%2/g,"ke_show_border");var l=r.htmlDataProcessor,w=l&&l.dataFilter;l=l&&l.htmlFilter;w&&w.addRules({elements:{table:function(i){i=i.attributes;var m=i["class"],p=parseInt(i.border,10);if(!p||p<=0)i["class"]=(m||"")+" ke_show_border"}}});l&&l.addRules({elements:{table:function(i){i=i.attributes;var m=i["class"];if(m)i["class"]=H(m.replace("ke_show_border","").replace(/\s{2}/," "))}}});j.TableUI||function(){function i(a){this.editor=a;a._toolbars=
a._toolbars||{};a._toolbars.table=this;this._init()}function m(a){function d(q){if(!(f.length>0))if(q[0].nodeType==D.NODE_ELEMENT&&x.test(q._4e_name())&&!q.data("selected_cell")){q._4e_setMarker(e,"selected_cell",true);f.push(q)}}for(var b=a.createBookmarks(),c=a.getRanges(),f=[],e={},g=0;g<c.length;g++){var h=c[g];if(h.collapsed){h=h.getCommonAncestor();(h=h._4e_ascendant("td",true)||h._4e_ascendant("th",true))&&f.push(h)}else{h=new C(h);var n;for(h.guard=d;n=h.next();)if((n=n.parent())&&x.test(n._4e_name())&&
!n.data("selected_cell")){n._4e_setMarker(e,"selected_cell",true);f.push(n)}}}j.Utils.clearAllMarkers(e);a.selectBookmarks(b);return f}function p(a,d){var b=a.getStartElement()._4e_ascendant("tr");if(b){var c=b._4e_clone(true);c.insertBefore(b);b=(d?c[0]:b[0]).cells;for(c=0;c<b.length;c++){b[c].innerHTML="";t.ie||(new k(b[c]))._4e_appendBogus()}}}function u(a){if(a instanceof j.Selection){var d=m(a),b=d.length;a=[];for(var c,f,e=0;e<b;e++){var g=d[e].parent(),h=g[0].rowIndex;!e&&(c=h-1);a[h]=g;e==
b-1&&(f=h+1)}e=g._4e_ascendant("table");c=new k(f<e[0].rows.length&&e[0].rows[f]||c>0&&e[0].rows[c]||e[0].parentNode);for(e=a.length;e>=0;e--)a[e]&&u(a[e]);return c}else if(a instanceof k){e=a._4e_ascendant("table");e[0].rows.length==1?e._4e_remove():a._4e_remove()}return 0}function y(a,d){var b=a.getStartElement();if(b=b._4e_ascendant("td",true)||b._4e_ascendant("th",true))for(var c=b._4e_ascendant("table"),f=b[0].cellIndex,e=0;e<c[0].rows.length;e++){var g=c[0].rows[e];if(!(g.cells.length<f+1)){b=
new k(g.cells[f].cloneNode(false));t.ie||b._4e_appendBogus();g=new k(g.cells[f]);d?b.insertBefore(g):b.insertAfter(g)}}}function z(a){if(a instanceof j.Selection){var d=m(a),b,c=[];a=d[0]&&d[0]._4e_ascendant("table");var f,e,g;f=0;for(e=d.length;f<e;f++)c.push(d[f][0].cellIndex);c.sort();f=1;for(e=c.length;f<e;f++)if(c[f]-c[f-1]>1){g=c[f-1]+1;break}g||(g=c[0]>0?c[0]-1:c[c.length-1]+1);c=a[0].rows;f=0;for(e=c.length;f<e;f++)if(b=c[f].cells[g])break;b=b?new k(b):a._4e_previous();for(g=d.length-1;g>=
0;g--)d[g]&&z(d[g]);return b}else if(a instanceof k){d=a._4e_ascendant("table");if(!d)return null;b=a[0].cellIndex;for(g=d[0].rows.length-1;g>=0;g--){a=new k(d[0].rows[g]);if(!b&&a[0].cells.length==1)u(a);else a[0].cells[b]&&a[0].removeChild(a[0].cells[b])}}return null}function A(a,d){var b=new j.Range(a[0].ownerDocument);if(!b.moveToElementEditablePosition(a,d?true:s)){b.selectNodeContents(a);b.collapse(d?false:true)}b.select(true)}i.showBorderClassName="ke_show_border";o.augment(i,{_init:function(){var a=
this.editor,d={};this.el=new E({contentCls:"ke-toolbar-table",title:"\u63d2\u5165\u8868\u683c",container:a.toolBarDiv});this.el.on("offClick",this._tableShow,this);for(var b in B)(function(c){d[c]=function(){a.fire("save");B[c](a);a.fire("save")}})(b);F.register({editor:a,rules:G,width:"120px",funcs:d});j.Utils.sourceDisable(a,this)},disable:function(){this.el.disable()},enable:function(){this.el.enable()},_tableShow:function(a,d,b){this.editor.useDialog("table/dialog",function(c){c.show(d,b)})}});var x=/^(?:td|th)$/,
B={"\u8868\u683c\u5c5e\u6027":function(a){var d=a.getSelection(),b=d&&d.getStartElement();if(d=b&&b._4e_ascendant("table",true)){a=a._toolbars.table;b=b._4e_ascendant(function(c){c=c._4e_name();return c=="td"||c=="th"},true);a._tableShow(null,d,b)}},"\u5220\u9664\u8868\u683c":function(a){var d=(a=a.getSelection())&&a.getStartElement();if(d=d&&d._4e_ascendant("table",true)){a.selectElement(d);var b=a.getRanges()[0];b.collapse();a.selectRanges([b]);a=d.parent();a[0].childNodes.length==1&&a._4e_name()!="body"&&a._4e_name()!="td"?a._4e_remove():
d._4e_remove()}},"\u5220\u9664\u884c ":function(a){a=a.getSelection();A(u(a),s)},"\u5220\u9664\u5217 ":function(a){a=a.getSelection();(a=z(a))&&A(a,true)},"\u5728\u4e0a\u65b9\u63d2\u5165\u884c":function(a){a=a.getSelection();p(a,true)},"\u5728\u4e0b\u65b9\u63d2\u5165\u884c":function(a){a=a.getSelection();p(a,s)},"\u5728\u5de6\u4fa7\u63d2\u5165\u5217":function(a){a=a.getSelection();y(a,true)},"\u5728\u53f3\u4fa7\u63d2\u5165\u5217":function(a){a=a.getSelection();y(a,s)}};j.TableUI=i}();r.addPlugin(function(){new j.TableUI(r);r.addCustomStyle(v)})});
