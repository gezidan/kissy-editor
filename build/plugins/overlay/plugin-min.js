KISSY.Editor.add("overlay",function(q){function d(){d.superclass.constructor.apply(this,arguments);this._init()}var h=KISSY,i=h.Editor,l=h.UA,r=i.focusManager,f=h.Node,n=h.Event,g=h.DOM,j,k,o={left:"-9999px",top:"-9999px"},p=i.baseZIndex(11E3);if(!i.SimpleOverlay){d.mask=function(a){if(!j){j=new d({el:new f("<div>"),cls:"ke-mask",focusMgr:false,draggable:false});j.el.css({width:"100%","background-color":"#000000",height:g.docHeight(),opacity:0.15})}a=a||p;j.el.css("z-index",a);j.show({left:0,top:0})};
d.unmask=function(){j&&j.hide()};d.loading=function(a){if(!k){k=new d({el:new f("<div>"),focusMgr:false,cls:"ke-loading",shortkey:false,draggable:false});k.el.css({opacity:0.15,border:0})}var b,c,e;if(a){e=a.offset();b=a[0].offsetWidth;c=a[0].offsetHeight;a=a.css("z-index")+1}else{e={left:0,top:0};b="100%";c=g.docHeight();a=p}k.el.css({width:b,height:c,"z-index":a});k.show(e)};d.unloading=function(){k&&k.hide()};d.ATTRS={title:{value:""},width:{value:"500px"},height:{},cls:{},shortkey:{value:true},
visible:{value:false},zIndex:{value:q.baseZIndex(9999)},focusMgr:{value:true},mask:{value:false},draggable:{value:true}};h.extend(d,h.Base,{_init:function(){var a=this;a._createEl();var b=a.el;b.css("z-index",a.get("zIndex"));a.on("afterVisibleChange",function(c){if(c=c.newVal){typeof c=="boolean"?a.center():b.offset(c);a.fire("show")}else{b.css(o);a.fire("hide")}});if(a.get("focusMgr")){a._initFocusNotice();a.on("afterVisibleChange",a._editorFocusMg,a)}a.on("afterVisibleChange",function(c){c.newVal&&
a.get("shortkey")?a._register():a._unregister()});if(a.get("mask")){a.on("show",function(){d.mask(a.get("zIndex")-1)});a.on("hide",function(){d.unmask()})}a.on("afterZIndexChange",function(c){b.css("z-index",c.newVal)});i.Utils.lazyRun(this,"_prepareShow","_realShow")},_register:function(){n.on(document,"keydown",this._keydown,this)},_keydown:function(a){if(a.keyCode==27){this.hide();a.halt()}},_unregister:function(){n.remove(document,"keydown",this._keydown,this)},_createEl:function(){var a=this,
b=a.get("el");if(b){a.originalEl=b;if(!b[0].parentNode||b[0].parentNode.nodeType!=i.NODE.NODE_ELEMENT)b=(new f("<div class='ke-dialog'>")).append((new f("<div class='ke-dialog-wrapper'>")).append(b)).appendTo(document.body);else{var c=new f("<div class='ke-dialog'>");c.insertBefore(b);c.append((new f("<div class='ke-dialog-wrapper'>")).append(b));b=c}}else{b=(new f("<div class='ke-dialog' ><div class='ke-dialog-wrapper'><div class='ke-hd'><span class='ke-hd-title'>@title@</span><a class='ke-hd-x' href='#'><span class='ke-close'>X</span></a></div><div class='ke-bd'></div><div class='ke-ft'></div></div></div>".replace(/@title@/,
a.get("title")))).appendTo(document.body);c=b.one(".ke-hd");var e=a.get("height");a.body=b.one(".ke-bd");a.foot=b.one(".ke-ft");a._title=c.one("h1");b.one(".ke-hd-x").on("click",function(s){s.preventDefault();a.hide()});e&&a.body.css({height:e,overflow:"auto"});if(e=a.get("draggable")){var m={all:b,foot:a.foot,body:a.body,head:c};(e=e===true?c:m[e])&&new i.Drag({node:b,handlers:{id:e}})}}a.get("cls")&&b.addClass(a.get("cls"));a.get("width")&&b.css("width",a.get("width"));a.set("el",b);a.el=b;b.css(o)},
center:function(){var a=this.el,b=a.width(),c=a.height(),e=g.viewportWidth(),m=g.viewportHeight();b=(e-b)/2+g.scrollLeft();c=(m-c)/2+g.scrollTop();if(c-g.scrollTop()>200)c-=150;b=Math.max(b,g.scrollLeft());c=Math.max(c,g.scrollTop());a.css({left:b+"px",top:c+"px"})},_getFocusEl:function(){var a=this._focusEl;if(a)return a;return this._focusEl=a=(new f("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.el)},_initFocusNotice:function(){var a=
this,b=a._getFocusEl();b.on("focus",function(){a.fire("focus")});b.on("blur",function(){a.fire("blur")})},_editorFocusMg:function(a){var b=this._focusEditor;if(a.newVal){b=this._focusEditor=r.currentInstance();l.webkit||this._getFocusEl()[0].focus();if(l.ie&&b)if(a=b.document.selection.createRange())if(a.item&&a.item(0).ownerDocument==b.document){b=document.body.createTextRange();b.moveToElementText(this.el._4e_first()[0]);b.collapse(true);b.select()}}else b&&b.focus()},_prepareShow:function(){if(l.ie==
6){var a=new f("<iframe class='ke-dialog-iframe'></iframe>");a.css(h.mix({opacity:0}));a.insertBefore(this.el.one(".ke-dialog-wrapper"))}},loading:function(){d.loading(this.el)},unloading:function(){d.unloading()},_realShow:function(a){this.set("visible",a||true)},show:function(a){this._prepareShow(a)},hide:function(){this.set("visible",false)}});i.Utils.lazyRun(d.prototype,"_prepareLoading","_realLoading");i.SimpleOverlay=d}});
