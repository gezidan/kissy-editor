KISSY.Editor.add("overlay",function(){function e(){e.superclass.constructor.apply(this,arguments);this._init()}var l=KISSY.Editor,d=KISSY,g=d.UA,q=l.focusManager,m=d.Node,p=d.Event,h=d.DOM,f,i,j,n={left:"-9999px",top:"-9999px"};if(!l.SimpleOverlay){e.init=function(){var a=document.body,b={width:"100%",height:h.docHeight()+"px",opacity:0.4};d.mix(b,n);f=(new m('<div class="ke-mask">&nbsp;</div>')).appendTo(a);f.css(b);if(g.ie&&g.ie==6){j=(new m("<iframe class='ke-dialog-iframe'></iframe>")).appendTo(a);
i=(new m("<iframe class='ke-mask'></iframe>")).appendTo(a);d.all([i[0],j[0]]).css(b)}e.init=null};e.ATTRS={title:{value:""},width:{value:"450px"},visible:{value:false},focusMgr:{value:true},mask:{value:false},draggable:{value:true}};d.extend(e,d.Base,{_init:function(){var a=this;a._createEl();var b=a.el;a.on("afterVisibleChange",function(c){if(c=c.newVal){typeof c=="boolean"?a.center():b.offset(c);a.fire("show")}else{b.css(n);a.fire("hide")}});if(a.get("focusMgr")){a._initFocusNotice();a.on("afterVisibleChange",
a._editorFocusMg,a)}a.on("afterVisibleChange",function(c){c.newVal?a._register():a._unregister()});if(g.ie===6){a.on("show",function(){var c=b.width(),k=b.height();j.css({width:c+"px",height:k+"px"});j.css(b.offset())});a.on("hide",function(){j.css(n)})}if(a.get("mask")){a.on("show",function(){d.all([f[0],i&&i[0]]).css({left:"0px",top:"0px"})});a.on("hide",function(){d.all([f[0],i&&i[0]]).css(n)})}},_register:function(){p.on(document,"keydown",this._keydown,this);f&&f.on("click",this.hide,this)},
_keydown:function(a){if(a.keyCode==27){this.hide();a.halt()}},_unregister:function(){p.remove(document,"keydown",this._keydown,this);f&&f.detach("click",this.hide,this)},_createEl:function(){var a=this,b=a.get("el");if(!b){b=(new m("<div class='ke-dialog' style='width:@width@'><div class='ke-hd'><span class='ke-hd-title'>@title@</span><span class='ke-hd-x'><a class='ke-close' href='#'>X</a></span></div><div class='ke-bd'></div><div class='ke-ft'></div></div>".replace(/@width@/,a.get("width")).replace(/@title@/,
a.get("title")))).appendTo(document.body);var c=b.one(".ke-hd"),k=d.guid("ke-overlay-head-");a.body=b.one(".ke-bd");a.foot=b.one(".ke-ft");a._close=b.one(".ke-close");a._title=c.one("h1");a._close.on("click",function(o){o.preventDefault();a.hide()});if(a.get("draggable")){c[0].id=k;c=new l.Drag({node:b,handlers:{id:c}});g.ie===6&&c.on("move",function(){j.offset(b.offset())})}}a.set("el",b);a.el=b;b.css(n)},center:function(){var a=this.el,b=a.width(),c=a.height(),k=h.viewportWidth(),o=h.viewportHeight();
b=(k-b)/2+h.scrollLeft();c=(o-c)/2+h.scrollTop();if(c-h.scrollTop()>200)c-=150;a.css({left:b+"px",top:c+"px"})},_prepareShow:function(){e.init()},_getFocusEl:function(){if(this._focusEl)return this._focusEl;return this._focusEl=(new m("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.el)},_initFocusNotice:function(){var a=this,b=a._getFocusEl();b.on("focus",function(){a.fire("focus")});b.on("blur",function(){a.fire("blur")})},
_editorFocusMg:function(a){var b=this._focusEditor;if(a.newVal){b=this._focusEditor=q.currentInstance();g.webkit||this._getFocusEl()[0].focus();var c=this.el.one("input");if(c)setTimeout(function(){try{c[0].focus();c[0].select()}catch(k){}},0);else if(g.ie&&b)if(a=b.document.selection.createRange())if(a.item&&a.item(0).ownerDocument==b.document){b=document.body.createTextRange();b.moveToElementText(this.el._4e_first()[0]);b.collapse(true);b.select()}}else b&&b.focus()},_realShow:function(a){this.set("visible",
a||true)},show:function(a){this._prepareShow(a)},hide:function(){this.set("visible",false)}});l.Utils.lazyRun(e.prototype,"_prepareShow","_realShow");l.SimpleOverlay=e}});
