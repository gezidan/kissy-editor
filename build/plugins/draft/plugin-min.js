KISSY.Editor.add("draft",function(j){var h=KISSY,f=h.Editor;f.Draft||function(){function i(a,b,d){for(a+="";a.length<b;)a=d+a;return a}function k(a){if(h.isNumber(a))a=new Date(a);return a instanceof Date?[a.getFullYear(),"-",i(a.getMonth()+1,2,"0"),"-",i(a.getDate(),2,"0")," ",i(a.getHours(),2,"0"),":",i(a.getMinutes(),2,"0"),":",i(a.getSeconds(),2,"0")].join(""):a}function l(a){this.editor=a;this._init()}var m=h.Node,n=h.JSON,o=window[f.STORE];h.augment(l,{_init:function(){var a=this,b=a.editor,
d=b.statusDiv,c=b.cfg.pluginConfig;c.draft=c.draft||{};a.draftInterval=c.draft.interval=c.draft.interval||5;a.draftLimit=c.draft.limit=c.draft.limit||5;d=(new m("<div style='position:absolute;right:30px;bottom:0;width:600px'><span style=' vertical-align:middle;'>内容正文每"+c.draft.interval+"分钟自动保存一次。</span></div>")).appendTo(d);a.timeTip=(new m("<span style=' vertical-align:middle;margin:0 10px;'>")).appendTo(d);c=new f.Select({container:d,doc:b.document,width:"100px",popUpWidth:"220px",title:"恢复编辑历史"});
var g=new f.TripleButton({text:"立即保存",title:"立即保存",container:d}),e=o.getItem("ke-draft-save"),p=[];a.versions=c;if(e)p=h.isString(e)?n.parse(decodeURIComponent(e)):e;a.drafts=p;a.sync();g.on("click",function(){a.save(false)});setInterval(function(){a.save(true)},a.draftInterval*60*1E3);c.on("click",a.recover,a);a.holder=d;f.Utils.sourceDisable(b,a)},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var a=this.draftLimit,
b=this.timeTip,d=this.versions,c=this.drafts;c.length>a&&c.splice(0,c.length-a);a=[];for(var g,e=0;e<c.length;e++){g=c[e];g=(g.auto?"自动":"手动")+"保存于："+k(g.date);a.push({name:g,value:e})}d.set("items",a.reverse());b.html(g);o.setItem("ke-draft-save",encodeURIComponent(n.stringify(c)))},save:function(a){var b=this.drafts,d=j._getRawData();if(b[b.length-1]&&d==b[b.length-1].content)b.length-=1;this.drafts=b.concat({content:d,date:(new Date).getTime(),auto:a});this.sync()},recover:function(a){var b=this.editor,
d=this.drafts;a=a.newVal;this.versions.reset("value");if(confirm("确认恢复 "+k(d[a].date)+" 的编辑历史？")){b.fire("save");b._setRawData(d[a].content);b.fire("save")}}});f.Draft=l}();j.addPlugin(function(){f.storeReady(function(){new f.Draft(j)})})});
