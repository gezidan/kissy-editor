KISSY.Editor.add("draft",function(l){var g=KISSY,h=g.Editor;h.Draft||function(){function i(a,b,c){for(a+="";a.length<b;)a=c+a;return a}function m(a){if(g.isNumber(a))a=new Date(a);return a instanceof Date?[a.getFullYear(),"-",i(a.getMonth()+1,2,"0"),"-",i(a.getDate(),2,"0")," ",i(a.getHours(),2,"0"),":",i(a.getMinutes(),2,"0"),":",i(a.getSeconds(),2,"0")].join(""):a}function n(a){this.editor=a;this._init()}var j=g.Node,o=g.Event,p=g.JSON,q=window[h.STORE];g.augment(n,{_init:function(){var a=this,
b=a.editor,c=b.statusDiv,d=b.cfg.pluginConfig;d.draft=d.draft||{};a.draftInterval=d.draft.interval=d.draft.interval||5;a.draftLimit=d.draft.limit=d.draft.limit||5;c=(new j("<div class='ke-draft'><spa class='ke-draft-title'>\u5185\u5bb9\u6b63\u6587\u6bcf"+d.draft.interval+"\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(c);a.timeTip=(new j("<span class='ke-draft-time'>")).appendTo(c);var f=(new j("<a class='ke-button ke-draft-save-btn' style='vertical-align:middle;padding:1px 9px;'><span class='ke-draft-mansave'></span><span>\u7acb\u5373\u4fdd\u5b58</span></a>")).appendTo(c),
e=new h.Select({container:c,menuContainer:document.body,doc:b.document,width:"85px",popUpWidth:"225px",align:["r","t"],title:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"}),k=q.getItem("ke-draft-save"),r=[];a.versions=e;if(k)r=g.isString(k)?p.parse(decodeURIComponent(k)):k;a.drafts=r;a.sync();f.on("click",function(){a.save(false)});(function(){var s=b.textarea[0].form;s&&o.on(s,"submit",function(){a.save(false)})})();setInterval(function(){a.save(true)},a.draftInterval*60*1E3);e.on("click",a.recover,a);a.holder=c;if(d.draft.helpHtml){d=
new h.TripleButton({cls:"ke-draft-help",title:"\u5e2e\u52a9",text:"\u5e2e\u52a9",container:c});d.on("click",function(){a._prepareHelp()});h.Utils.lazyRun(a,"_prepareHelp","_realHelp");a.helpBtn=d.el}a._holder=c},_prepareHelp:function(){var a=this,b=a.editor,c=a.helpBtn,d=new j(b.cfg.pluginConfig.draft.helpHtml||""),f=new j("<div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;border-top-color:#CED5E0;'><div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;left:-8px;top:-10px;border-top-color:white;'></div></div>");
d.append(f);d.css({border:"1px solid #ACB4BE","text-align":"left"});a._help=new g.Overlay({content:d,width:d.width()+"px",mask:false});a._help.renderer();a._help.el.css("border","none");a._help.arrow=f;o.on([document,b.document],"click",function(e){e=e.target;e==c[0]||c.contains(e)||a._help.hide()})},_realHelp:function(){var a=this._help,b=this.helpBtn,c=a.arrow;a.show();b=b.offset();a.el.offset({left:b.left-a.el.width()+17,top:b.top-a.el.height()-7});c.offset({left:b.left-2,top:b.top-8})},disable:function(){this.holder.css("visibility",
"hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var a=this.draftLimit,b=this.timeTip,c=this.versions,d=this.drafts;d.length>a&&d.splice(0,d.length-a);a=[];for(var f,e=0;e<d.length;e++){f=d[e];f=(f.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e : "+m(f.date);a.push({name:f,value:e})}c.set("items",a.reverse());b.html(f);q.setItem("ke-draft-save",encodeURIComponent(p.stringify(d)))},save:function(a){var b=this.drafts,c=l.getData(true);if(c){if(b[b.length-1]&&c==b[b.length-1].content)b.length-=1;
this.drafts=b.concat({content:c,date:(new Date).getTime(),auto:a});this.sync()}},recover:function(a){var b=this.editor,c=this.drafts;a=a.newVal;this.versions.reset("value");if(confirm("\u786e\u8ba4\u6062\u590d "+m(c[a].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")){b.fire("save");b.setData(c[a].content);b.fire("save")}}});h.Draft=n}();l.addPlugin(function(){h.storeReady(function(){new h.Draft(l)})})});
