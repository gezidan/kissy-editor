KISSY.Editor.add("draft",function(j){var h=KISSY,g=h.Editor;g.Draft||function(){function i(a,b,c){for(a+="";a.length<b;)a=c+a;return a}function k(a){if(h.isNumber(a))a=new Date(a);return a instanceof Date?[a.getFullYear(),"-",i(a.getMonth()+1,2,"0"),"-",i(a.getDate(),2,"0")," ",i(a.getHours(),2,"0"),":",i(a.getMinutes(),2,"0"),":",i(a.getSeconds(),2,"0")].join(""):a}function l(a){this.editor=a;this._init()}var m=h.Node,n=h.JSON,o=window[g.STORE];h.augment(l,{_init:function(){var a=this,b=a.editor,
c=b.statusDiv,d=b.cfg.pluginConfig;d.draft=d.draft||{};a.draftInterval=d.draft.interval=d.draft.interval||5;a.draftLimit=d.draft.limit=d.draft.limit||5;c=(new m("<div class='ke-draft'><span style=' vertical-align:middle;'>内容正文每"+d.draft.interval+"分钟自动保存一次。</span></div>")).appendTo(c);a.timeTip=(new m("<span style=' vertical-align:middle;margin:0 10px;'>")).appendTo(c);d=new g.TripleButton({text:"立即保存",title:"立即保存",container:c});var e=new g.Select({container:c,doc:b.document,width:"100px",popUpWidth:"220px",
title:"恢复编辑历史"}),f=o.getItem("ke-draft-save"),p=[];a.versions=e;if(f)p=h.isString(f)?n.parse(decodeURIComponent(f)):f;a.drafts=p;a.sync();d.on("click",function(){a.save(false)});setInterval(function(){a.save(true)},a.draftInterval*60*1E3);e.on("click",a.recover,a);a.holder=c;g.Utils.sourceDisable(b,a)},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility","")},sync:function(){var a=this.draftLimit,b=this.timeTip,c=this.versions,d=this.drafts;d.length>
a&&d.splice(0,d.length-a);a=[];for(var e,f=0;f<d.length;f++){e=d[f];e=(e.auto?"自动":"手动")+"保存于："+k(e.date);a.push({name:e,value:f})}c.set("items",a.reverse());b.html(e);o.setItem("ke-draft-save",encodeURIComponent(n.stringify(d)))},save:function(a){var b=this.drafts,c=j._getRawData();if(b[b.length-1]&&c==b[b.length-1].content)b.length-=1;this.drafts=b.concat({content:c,date:(new Date).getTime(),auto:a});this.sync()},recover:function(a){var b=this.editor,c=this.drafts;a=a.newVal;this.versions.reset("value");
if(confirm("确认恢复 "+k(c[a].date)+" 的编辑历史？")){b.fire("save");b._setRawData(c[a].content);b.fire("save")}}});g.Draft=l}();j.addPlugin(function(){g.storeReady(function(){new g.Draft(j)})})});
