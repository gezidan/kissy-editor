KISSY.Editor.add("link",function(i){function k(j){return j._4e_ascendant(function(b){return b._4e_name()==="a"&&!!b.attr("href")},true)}var h=KISSY.Editor,l=h.Style,n=h.BubbleView,m={element:"a",attributes:{href:"#(href)",title:"#(title)",_ke_saved_href:"#(_ke_saved_href)",target:"#(target)"}};i.ready(function(){var j=i.addButton("link",{contentCls:"ke-toolbar-link",title:"\u63d2\u5165\u94fe\u63a5",mode:h.WYSIWYG_MODE,_getSelectedLink:function(){var b=this.editor.getSelection();if(b=b&&b.getStartElement())b=k(b);return b},
_getSelectionLinkUrl:function(){var b=this.cfg._getSelectedLink.call(this);if(b)return b.attr("_ke_saved_href")||b.attr("href")},_removeLink:function(b){var c=this.editor;c.fire("save");var d=c.getSelection(),f=d.getRanges()[0];if(f&&f.collapsed){f=d.createBookmarks();b._4e_remove(true);d.selectBookmarks(f)}else if(f){b=b[0];d=b.attributes;f={};for(var g=0;g<d.length;g++){var e=d[g];if(e.specified)f[e.name]=e.value}if(b.style.cssText)f.style=b.style.cssText;(new l(m,f)).remove(c.document)}c.fire("save");
c.notifySelectionChange()},_link:function(b){var c=this.editor,d=this.cfg._getSelectedLink.call(this);b._ke_saved_href=b.href;if(d){c.fire("save");d.attr(b);c.fire("save")}else{d=(d=c.getSelection())&&d.getRanges()[0];if(!d||d.collapsed){a=new Node("<a>"+url+"</a>",b,c.document);c.insertElement(a)}else{c.fire("save");(new l(m,b)).apply(c.document);c.fire("save")}}c.notifySelectionChange()},offClick:function(){var b=this;b.editor.useDialog("link/dialog",function(c){c.show(b)})}});n.register({pluginName:"link",
editor:i,pluginContext:j,func:k,init:function(){var b=this,c=b.get("contentEl");c.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>');var d=c.one(".ke-bubbleview-url"),f=c.one(".ke-bubbleview-change"),g=c.one(".ke-bubbleview-remove");h.Utils.preventFocus(c);f.on("click",function(e){b._plugin.call("offClick");e.halt()});g.on("click",function(e){b._plugin.call("_removeLink",
b._selectedEl);e.halt()});b.on("show",function(){var e=b._selectedEl;if(e){e=e.attr("_ke_saved_href")||e.attr("href");d.html(e);d.attr("href",e)}})}})})});
