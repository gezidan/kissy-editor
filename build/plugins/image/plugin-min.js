KISSY.Editor.add("image",function(v){var g=KISSY.Editor,l=KISSY,A=l.DOM,B=l.UA,C=l.JSON,t=l.Node,D=l.Event,w=g.BubbleView,E=g.SimpleOverlay;g.ImageInserter||function(){function q(a){q.superclass.constructor.call(this,a);this._init()}var r=function(a){return a._4e_name()==="img"&&!/(^|\s+)ke_/.test(a[0].className)&&a};A.addStyleSheet(".ke-image-wrap {margin:0;}","ke-image");var F=g.TripleButton;q.ATTRS={editor:{}};var u={"图片属性":function(a){var b=a.getSelection();b=b&&b.getStartElement();b=r(b);a=a._toolbars.image;
b&&a.show(null,b)}};l.extend(q,l.Base,{_init:function(){var a=this.get("editor"),b=a.toolBarDiv,d={};this.editor=a;this.el=new F({contentCls:"ke-toolbar-image",title:"插入图片",container:b});this.el.on("offClick",this.show,this);D.on(a.document,"dblclick",this._dblclick,this);g.Utils.lazyRun(this,"_prepare","_real");a._toolbars=a._toolbars||{};a._toolbars.image=this;if(u)for(var e in u)(function(f){d[f]=function(){u[f](a)}})(e);g.ContextMenu.register(a.document,{rules:[r],width:"120px",funcs:d});w.attach({pluginName:"image",
pluginInstance:this});g.Utils.sourceDisable(a,this)},disable:function(){this.el.disable()},enable:function(){this.el.boff()},_dblclick:function(a){var b=new t(a.target);if(r(b)){this.show(null,b);a.halt()}},_prepare:function(){var a=this,b=a.get("editor"),d,e,f;a.d=new E({title:"图片属性",mask:true});var i=a.d;i.body.html("<div class='ke-image-wrap'><ul class='ke-tabs ks-clear'><li rel='remote'>网络图片</li><li rel='local'>本地上传</li></ul><div style='padding:12px 20px 5px 20px;'><div class='ke-image-tabs-content-wrap' ><div><label><span class='ke-image-title'>图片地址： </span><input  data-verify='^https?://[^\\s]+$'  data-warning='网址格式为：http://' class='ke-img-url ke-input' style='width:390px;' value='http://'/></label></div><div><p><input class='ke-input ke-img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 373px;color:#969696;'/><button class='ke-image-up ke-button'>浏览...</button></p><div class='ke-img-up-extraHtml'></div></div></div><table style='width:100%;margin-top:8px;' class='ke-img-setting'><tr><td><label>宽度： <input  data-verify='^(自动|((?!0$)\\d+))$'  data-warning='宽度请输入正整数' class='ke-img-width ke-input' style='width:60px' value='自动'/> 像素 </label></td><td><label>高度： <input  data-verify='^(自动|((?!0$)\\d+))$'  data-warning='高度请输入正整数' class='ke-img-height ke-input' style='width:60px' value='自动'/> 像素 </label></td></tr><tr><td><label>对齐：<select class='ke-img-align'><option value='none'>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select></label></td><td><label>间距： <input  data-verify='^\\d+$'  data-warning='间距请输入非负整数' class='ke-img-margin ke-input' style='width:60px' value='5'/> 像素</label></td></tr></table></div></div>");
i.foot.html("<a class='ke-img-insert ke-button' style='margin-right:30px;'>确定</a> <a  class='ke-img-cancel ke-button'>取消</a>");a.content=i.el;var c=a.content,k=c.one(".ke-img-cancel"),m=c.one(".ke-img-insert");a.imgUrl=c.one(".ke-img-url");a.imgHeight=c.one(".ke-img-height");a.imgWidth=c.one(".ke-img-width");a.imgAlign=g.Select.decorate(c.one(".ke-img-align"));a.imgMargin=c.one(".ke-img-margin");k.on("click",function(s){a.d.hide();s.halt()});var j=(b.cfg.pluginConfig.image||{}).upload||null,o=new g.Tabs({tabs:c.one("ul.ke-tabs"),
contents:c.one("div.ke-image-tabs-content-wrap")});c.one(".ke-image-title");var p=new g.TripleButton({el:c.one(".ke-image-up"),cls:"ke-button",text:"浏&nbsp;览"});a.tab=o;var G=g.Utils.normParams,H=i.el.one(".ke-img-setting");m.on("click",function(){if(o.activate()=="local"&&d&&j){if(g.Utils.verifyInputs(H.all("input")))if(f.val()==e)alert("请先选择文件!");else{d.uploadAll(j.serverUrl,"POST",G(j.serverParams),j.fileInput);i.loading()}}else g.Utils.verifyInputs(i.el.all("input"))&&a._insert()});if(j){var n;
j.extraHtml&&c.one(".ke-img-up-extraHtml").html(j.extraHtml);var K=function(){var s=p.el.width()+38,x=p.el.height()+8;n=(new t("<div style='position:absolute;width:"+s+"px;height:"+x+"px;z-index:"+b.baseZIndex(9999)+";'>")).appendTo(c);var I=g.Config.base+g.Utils.debugUrl("plugins/uploader/uploader.swf");d=new g.FlashBridge({movie:I,methods:["removeFile","cancel","clearFileList","removeFile","disable","enable","upload","setAllowMultipleFiles","setFileFilters","uploadAll"],holder:n,attrs:{width:s,
height:x},params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,menu:true}});d.on("swfReady",function(){p.enable();d.setAllowMultipleFiles(false);d.setFileFilters([{extensions:"*.jpeg;*.jpg;*.png;*.gif",description:"图片文件( png,jpg,jpeg,gif )"}])});var y=j.sizeLimit||Number.MAX_VALUE;e="单张图片容量不超过 "+y/1E3+" M";f=c.one(".ke-img-local-url");f.val(e);d.on("fileSelect",function(h){h=h.fileList;for(var J in h){var z=h[J];if(Math.floor(z.size/1E3)>y){alert(e);f.val(e);d.clearFileList();break}f.val(z.name)}});
d.on("uploadStart",function(){d.clearFileList()});d.on("uploadCompleteData",function(h){h=l.trim(h.data).replace(/\\r||\\n/g,"");i.unloading();if(h){h=C.parse(h);if(h.error)alert(h.error);else{a.imgUrl.val(h.imgUrl);f.val(e);a._insert()}}});d.on("uploadError",function(h){i.unloading();f.val(e);alert(h.status)})};o.on("local",function(){n||K();n.offset(p.el.offset())});o.on("remote",function(){n&&n.offset({left:-9999,top:-9999})});p.disable()}else o.remove("local")},_updateTip:function(a,b){a.html(b.attr("src"));
a.attr("href",b.attr("src"))},_real:function(){this.d.show()},_insert:function(){var a=this.imgUrl.val(),b=parseInt(this.imgHeight.val()),d=this.get("editor"),e=parseInt(this.imgWidth.val()),f=this.imgAlign.val(),i=parseInt(this.imgMargin.val()),c="";if(b)c+="height:"+b+"px;";if(e)c+="width:"+e+"px;";if(f)c+="float:"+f+";";isNaN(i)||(c+="margin:"+i+"px;");if(c)c=" style='"+c+"' ";b=new t("<img "+c+"src='"+a+"' alt='' />",null,d.document);b=d.insertElement(b,function(k){k.on("abort error",function(){k.detach();
k[0].src=a})});this._selectedEl&&d.getSelection().selectElement(b);this.d.hide();d.notifySelectionChange()},_updateD:function(a){this._selectedEl=a;this.tab.activate("remote");if(a){this.imgUrl.val(a.attr("src"));this.imgHeight.val(a.height());this.imgWidth.val(a.width());this.imgAlign.val(a.css("float")||"none");this.imgMargin.val(parseInt(a._4e_style("margin"))||0)}else{this.imgUrl.val("http://");this.imgHeight.val("自动");this.imgWidth.val("自动");this.imgAlign.val("none");this.imgMargin.val("5")}},
show:function(a,b){this._prepare();this._updateD(b)}});g.ImageInserter=q;(function(a,b,d){w.register({pluginName:a,func:d,init:function(){var e=this,f=e.el;f.html(b+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">编辑</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">删除</span>');var i=f.one(".ke-bubbleview-url"),c=f.one(".ke-bubbleview-change");f=f.one(".ke-bubbleview-remove");c._4e_unselectable();i._4e_unselectable();
f._4e_unselectable();c.on("click",function(k){e._plugin.show(null,e._selectedEl);k.halt()});f.on("click",function(k){var m=e._plugin;if(B.webkit){var j=m.editor.getSelection().getRanges();j&&j[0]&&(j[0].collapse(true)||1)&&j[0].select()}e._selectedEl._4e_remove();e.hide();m.editor.notifySelectionChange();k.halt()});e.on("afterVisibleChange",function(k){var m=e._selectedEl;k.newVal&&m&&e._plugin._updateTip(i,m)})}})})("image","图片网址： ",r)}();v.addPlugin(function(){new g.ImageInserter({editor:v})})});
