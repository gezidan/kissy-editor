KISSY.Editor.add("image",function(o){var g=KISSY.Editor,j=KISSY,p=j.Node,r=j.Event,q=g.BubbleView,s=g.SimpleOverlay;g.ImageInserter||function(){function k(a){k.superclass.constructor.call(this,a);this._init()}var l=function(a){return a._4e_ascendant(function(b){return b._4e_name()==="img"&&!/(^|\s+)ke_/.test(b[0].className)},true)},t=g.TripleButton;k.ATTRS={editor:{}};var n={"\u56fe\u7247\u5c5e\u6027":function(a){var b=a.getSelection();b=b&&b.getStartElement();b=l(b);a=a._toolbars.image;b&&a.show(null,
b)}};j.extend(k,j.Base,{_init:function(){var a=this.get("editor"),b=a.toolBarDiv,e={};this.editor=a;this.el=new t({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",container:b});this.el.on("offClick",this.show,this);r.on(a.document,"dblclick",this._dblclick,this);g.Utils.lazyRun(this,"_prepare","_real");a._toolbars=a._toolbars||{};a._toolbars.image=this;if(n)for(var c in n)(function(d){e[d]=function(){n[d](a)}})(c);g.ContextMenu.register(a.document,{rules:[l],width:"120px",funcs:e});
q.attach({pluginName:"image",pluginInstance:this})},_dblclick:function(a){var b=new p(a.target);if(l(b)){this.show(null,b);a.halt()}},_prepare:function(){var a=this;a.get("editor");a.d=new s({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var b=a.d;b.body.html("<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></p><p style='margin:5px 0'><label><span style='color:#0066CC;font-weight:bold;'>\u9ad8\u5ea6\uff1a </span><input class='ke-img-height' style='width:90px' value='\u81ea\u52a8'/> px </label> &nbsp;<label><span style='color:#0066CC;font-weight:bold;'>\u5bbd\u5ea6\uff1a </span><input class='ke-img-width' style='width:90px' value='\u81ea\u52a8'/> px </label></p><p><label><span style='color:#0066CC;font-weight:bold;'>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></label></p></div>");
b.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");a.content=b.el;b=a.content;var e=b.one(".ke-img-cancel"),c=b.one(".ke-img-insert");a.imgUrl=b.one(".ke-img-url");a.imgHeight=b.one(".ke-img-height");a.imgWidth=b.one(".ke-img-width");a.imgAlign=b.one(".ke-img-align");e.on("click",function(d){a.d.hide();d.halt()});c.on("click",function(){a._insert()})},_updateTip:function(a,b){a.html(b.attr("src"));a.attr("href",b.attr("src"))},_real:function(){this.d.show()},
_insert:function(){var a=this.get("editor"),b=this.imgUrl.val();if(b){var e=parseInt(this.imgHeight.val()),c=parseInt(this.imgWidth.val()),d=this.imgAlign.val(),f="";if(e)f+="height:"+e+"px;";if(c)f+="width:"+c+"px;";if(d)f+="float:"+d+";margin:0 5px;";if(f)f=" style='"+f+"' ";b=new p("<img "+f+"src='"+b+"' alt='' />",null,a.document);b=a.insertElement(b,e||c?null:function(h){h.on("load",function(){h.detach();h.css({width:h.width()+"px",height:h.height()+"px"})})});this._selectedEl&&a.getSelection().selectElement(b);
this.d.hide();a.notifySelectionChange()}},_updateD:function(a){if(this._selectedEl=a){this.imgUrl.val(a.attr("src"));this.imgHeight.val(a.height());this.imgWidth.val(a.width());this.imgAlign.val(a._4e_style("float"))}else{this.imgUrl.val("http://");this.imgHeight.val("\u81ea\u52a8");this.imgWidth.val("\u81ea\u52a8");this.imgAlign.val()}},show:function(a,b){this._prepare();this._updateD(b)}});g.ImageInserter=k;(function(a,b,e){q.register({pluginName:a,func:e,init:function(){var c=this,d=c.el;d.html(b+
'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');var f=d.one(".ke-bubbleview-url"),h=d.one(".ke-bubbleview-change");d=d.one(".ke-bubbleview-remove");h._4e_unselectable();f._4e_unselectable();d._4e_unselectable();h.on("click",function(i){c._plugin.show(null,c._selectedEl);i.halt()});d.on("click",function(i){var m=c._plugin;c._selectedEl._4e_remove();
m.editor.notifySelectionChange();i.halt()});c.on("afterVisibleChange",function(i){var m=c._selectedEl;i.newVal&&m&&c._plugin._updateTip(f,m)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",l)}();o.addPlugin(function(){new g.ImageInserter({editor:o})})});
