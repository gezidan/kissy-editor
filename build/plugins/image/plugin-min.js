KISSY.Editor.add("image",function(q){var h=KISSY.Editor,i=KISSY,t=i.UA,r=i.Node,u=i.Event,s=h.BubbleView,v=h.SimpleOverlay;h.ImageInserter||function(){function l(a){l.superclass.constructor.call(this,a);this._init()}var m=function(a){return a._4e_name()==="img"&&!/(^|\s+)ke_/.test(a[0].className)&&a},o=h.TripleButton;l.ATTRS={editor:{}};var p={"\u56fe\u7247\u5c5e\u6027":function(a){var b=a.getSelection();b=b&&b.getStartElement();b=m(b);a=a._toolbars.image;b&&a.show(null,b)}};i.extend(l,i.Base,{_init:function(){var a=
this.get("editor"),b=a.toolBarDiv,e={};this.editor=a;this.el=new o({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",container:b});this.el.on("offClick",this.show,this);u.on(a.document,"dblclick",this._dblclick,this);h.Utils.lazyRun(this,"_prepare","_real");a._toolbars=a._toolbars||{};a._toolbars.image=this;if(p)for(var c in p)(function(d){e[d]=function(){p[d](a)}})(c);h.ContextMenu.register(a.document,{rules:[m],width:"120px",funcs:e});s.attach({pluginName:"image",pluginInstance:this});
h.Utils.sourceDisable(a,this)},disable:function(){this.el.set("state",o.DISABLED)},enable:function(){this.el.set("state",o.OFF)},_dblclick:function(a){var b=new r(a.target);if(m(b)){this.show(null,b);a.halt()}},_prepare:function(){var a=this;a.get("editor");a.d=new v({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var b=a.d;b.body.html("<table><tr><td colspan='2'><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input  data-verify='^https?://[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp://' class='ke-img-url' style='width:230px' value='http://'/></label></td></tr><tr><td><label><span>\u9ad8\u5ea6\uff1a </span><input  data-verify='^\u81ea\u52a8|((?!0$)\\d+(.\\d+)?)$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-img-height' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td><td><label><span>\u5bbd\u5ea6\uff1a </span><input  data-verify='^\u81ea\u52a8|((?!0$)\\d+(.\\d+)?)$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6570' class='ke-img-width' style='width:60px' value='\u81ea\u52a8'/> \u50cf\u7d20 </label></td></tr><tr><td><label><span>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></td><td><label><span>\u95f4\u8ddd\uff1a </span> <input  data-verify='^\\d+(.\\d+)?$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6570\u5b57' class='ke-img-margin' style='width:60px' value='5'/> \u50cf\u7d20</label></td></tr></table>");
b.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");a.content=b.el;b=a.content;var e=b.one(".ke-img-cancel"),c=b.one(".ke-img-insert");a.imgUrl=b.one(".ke-img-url");a.imgHeight=b.one(".ke-img-height");a.imgWidth=b.one(".ke-img-width");a.imgAlign=b.one(".ke-img-align");a.imgMargin=b.one(".ke-img-margin");e.on("click",function(d){a.d.hide();d.halt()});c.on("click",function(){a._insert()})},_updateTip:function(a,b){a.html(b.attr("src"));
a.attr("href",b.attr("src"))},_real:function(){this.d.show()},_insert:function(){var a=this.imgUrl.val();if(h.Utils.verifyInputs(this.d.el.all("input"))){var b=parseInt(this.imgHeight.val()),e=this.get("editor"),c=parseInt(this.imgWidth.val()),d=this.imgAlign.val(),j=parseInt(this.imgMargin.val()),f="";if(b)f+="height:"+b+"px;";if(c)f+="width:"+c+"px;";if(d)f+="float:"+d+";";isNaN(j)||(f+="margin:"+j+"px;");if(f)f=" style='"+f+"' ";a=new r("<img "+f+"src='"+a+"' alt='' />",null,e.document);a=e.insertElement(a,
b||c?null:function(g){g.on("load",function(){g.detach();g.css({width:g.width()+"px",height:g.height()+"px"})})});this._selectedEl&&e.getSelection().selectElement(a);this.d.hide();e.notifySelectionChange()}},_updateD:function(a){if(this._selectedEl=a){this.imgUrl.val(a.attr("src"));this.imgHeight.val(a.height());this.imgWidth.val(a.width());this.imgAlign.val(a._4e_style("float"));this.imgMargin.val(parseInt(a._4e_style("margin"))||0)}else{this.imgUrl.val("http://");this.imgHeight.val("\u81ea\u52a8");
this.imgWidth.val("\u81ea\u52a8");this.imgAlign.val();this.imgMargin.val("5")}},show:function(a,b){this._prepare();this._updateD(b)}});h.ImageInserter=l;(function(a,b,e){s.register({pluginName:a,func:e,init:function(){var c=this,d=c.el;d.html(b+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');var j=d.one(".ke-bubbleview-url"),
f=d.one(".ke-bubbleview-change");d=d.one(".ke-bubbleview-remove");f._4e_unselectable();j._4e_unselectable();d._4e_unselectable();f.on("click",function(g){c._plugin.show(null,c._selectedEl);g.halt()});d.on("click",function(g){var k=c._plugin;if(t.webkit){var n=k.editor.getSelection().getRanges();n&&n[0]&&(n[0].collapse(true)||1)&&n[0].select()}c._selectedEl._4e_remove();c.hide();k.editor.notifySelectionChange();g.halt()});c.on("afterVisibleChange",function(g){var k=c._selectedEl;g.newVal&&k&&c._plugin._updateTip(j,
k)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",m)}();q.addPlugin(function(){new h.ImageInserter({editor:q})})});
