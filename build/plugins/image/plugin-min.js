KISSY.Editor.add("image",function(n){var f=KISSY.Editor,g=KISSY,r=g.UA,s=g.Node,t=g.Event,o=f.BubbleView;f.ImageInserter||function(){function j(a){j.superclass.constructor.call(this,a);this._init()}var k=function(a){return a._4e_name()==="img"&&!/(^|\s+)ke_/.test(a[0].className)&&a},u=f.TripleButton;j.ATTRS={editor:{}};var m={"\u56fe\u7247\u5c5e\u6027":function(a){var b=a.getSelection();b=b&&b.getStartElement();b=k(b);a=a._toolbars.image;b&&a.show(null,b)}};g.extend(j,g.Base,{_init:function(){var a=this.get("editor"),
b=a.toolBarDiv,e={};this.editor=a;this.el=new u({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",container:b});this.el.on("offClick",this.show,this);t.on(a.document,"dblclick",this._dblclick,this);f.Utils.lazyRun(this,"_prepare","_real");a._toolbars=a._toolbars||{};a._toolbars.image=this;if(m){for(var c in m)(function(d){e[d]=function(){m[d](a)}})(c);f.ContextMenu.register({editor:a,rules:[k],width:"120px",funcs:e})}o.attach({pluginName:"image",pluginInstance:this});f.Utils.sourceDisable(a,this)},disable:function(){this.el.disable()},
enable:function(){this.el.boff()},_dblclick:function(a){var b=new s(a.target);if(k(b)){this.show(null,b);a.halt()}},_updateTip:function(a,b){var e=b.attr("src");a.html(e);a.attr("href",e)},show:function(a,b){this.get("editor").useDialog("image/dialog",function(e){e.show(b)},{mask:true})}});f.ImageInserter=j;(function(a,b,e){o.register({pluginName:a,func:e,init:function(){var c=this,d=c.el;d.html(b+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var p=d.one(".ke-bubbleview-url"),q=d.one(".ke-bubbleview-change");d=d.one(".ke-bubbleview-remove");q._4e_unselectable();p._4e_unselectable();d._4e_unselectable();q.on("click",function(h){c._plugin.show(null,c._selectedEl);h.halt()});d.on("click",function(h){var i=c._plugin;if(r.webkit){var l=i.editor.getSelection().getRanges();l&&l[0]&&(l[0].collapse(true)||1)&&l[0].select()}c._selectedEl._4e_remove();c.hide();i.editor.notifySelectionChange();h.halt()});c.on("afterVisibleChange",function(h){var i=
c._selectedEl;h.newVal&&i&&c._plugin._updateTip(p,i)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",k)}();n.addPlugin(function(){new f.ImageInserter({editor:n})})});
