KISSY.Editor.add("image",function(w){var g=KISSY.Editor,l=KISSY,B=l.DOM,C=l.UA,D=l.JSON,t=l.Node,E=l.Event,x=g.BubbleView,F=g.SimpleOverlay;g.ImageInserter||function(){function q(a){q.superclass.constructor.call(this,a);this._init()}var r=function(a){return a._4e_name()==="img"&&!/(^|\s+)ke_/.test(a[0].className)&&a};B.addStyleSheet(".ke-image-wrap {margin:0;}","ke-image");var u=g.TripleButton;q.ATTRS={editor:{}};var v={"图片属性":function(a){var c=a.getSelection();c=c&&c.getStartElement();c=r(c);a=a._toolbars.image;
c&&a.show(null,c)}};l.extend(q,l.Base,{_init:function(){var a=this.get("editor"),c=a.toolBarDiv,e={};this.editor=a;this.el=new u({contentCls:"ke-toolbar-image",title:"插入图片",container:c});this.el.on("offClick",this.show,this);E.on(a.document,"dblclick",this._dblclick,this);g.Utils.lazyRun(this,"_prepare","_real");a._toolbars=a._toolbars||{};a._toolbars.image=this;if(v)for(var d in v)(function(f){e[f]=function(){v[f](a)}})(d);g.ContextMenu.register(a.document,{rules:[r],width:"120px",funcs:e});x.attach({pluginName:"image",
pluginInstance:this});g.Utils.sourceDisable(a,this)},disable:function(){this.el.set("state",u.DISABLED)},enable:function(){this.el.set("state",u.OFF)},_dblclick:function(a){var c=new t(a.target);if(r(c)){this.show(null,c);a.halt()}},_prepare:function(){var a=this,c=a.get("editor"),e,d,f;a.d=new F({title:"图片属性",mask:true,width:"550px"});var k=a.d;k.body.html("<div class='ke-image-wrap'><ul class='ke-tabs ks-clear'><li rel='remote'>网络图片</li><li rel='local'>本地上传</li></ul><div style='padding:12px 0pt 5px 20px;'><div class='kee-image-tabs-content-wrap' ><div><label><span class='ke-image-title'>图片地址： </span><input  data-verify='^https?://[^\\s]+$'  data-warning='网址格式为：http://' class='ke-img-url ke-input' style='width:440px;' value='http://'/></label></div><div><p><input class='ke-input ke-img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 425px;color:#969696;'/><button class='ke-image-up ke-button'>浏览...</button></p><div class='ke-img-up-extraHtml'></div></div></div><table style='width:100%;margin-top:20px;'><tr><td><label>宽度： <input  data-verify='^(自动|((?!0$)\\d+))$'  data-warning='宽度请输入正整数' class='ke-img-width ke-input' style='width:60px' value='自动'/> 像素 </label></td><td><label>高度： <input  data-verify='^(自动|((?!0$)\\d+))$'  data-warning='高度请输入正整数' class='ke-img-height ke-input' style='width:60px' value='自动'/> 像素 </label></td></tr><tr><td><label>对齐：<select class='ke-img-align'><option value='none'>无</option><option value='left'>左对齐</option><option value='right'>右对齐</option></select></label></td><td><label>间距： <input  data-verify='^\\d+$'  data-warning='间距请输入非负整数' class='ke-img-margin ke-input' style='width:60px' value='5'/> 像素</label></td></tr></table></div></div>");
k.foot.html("<a class='ke-img-insert ke-button' style='margin-right:30px;'>确定</a> <a  class='ke-img-cancel ke-button'>取消</a>");a.content=k.el;var b=a.content,i=b.one(".ke-img-cancel"),m=b.one(".ke-img-insert");a.imgUrl=b.one(".ke-img-url");a.imgHeight=b.one(".ke-img-height");a.imgWidth=b.one(".ke-img-width");a.imgAlign=g.Select.decorate(b.one(".ke-img-align"));a.imgMargin=b.one(".ke-img-margin");i.on("click",function(s){a.d.hide();s.halt()});var j=(c.cfg.pluginConfig.image||{}).upload||null,o=new g.Tabs({tabs:b.one("ul.ke-tabs"),
contents:b.one("div.kee-image-tabs-content-wrap")});b.one(".ke-image-title");var p=new g.TripleButton({el:b.one(".ke-image-up"),cls:"ke-button",text:"浏&nbsp;览"});a.tab=o;var G=g.Utils.normParams;m.on("click",function(){if(o.activate()=="local"&&e&&j)if(f.val()==d)alert("请先选择文件!");else{e.uploadAll(j.serverUrl,"POST",G(j.serverParams),j.fileInput);k.loading()}else a._insert()});if(j){var n;j.extraHtml&&b.one(".ke-img-up-extraHtml").html(j.extraHtml);var J=function(){var s=p.el.width()+38,y=p.el.height()+
8;n=(new t("<div style='position:absolute;width:"+s+"px;height:"+y+"px;z-index:9999;'>")).appendTo(b);var H=g.Config.base+g.Utils.debugUrl("plugins/uploader/uploader.swf");e=new g.FlashBridge({movie:H,methods:["removeFile","cancel","clearFileList","removeFile","disable","enable","upload","setAllowMultipleFiles","setFileFilters","uploadAll"],holder:n,attrs:{width:s,height:y},params:{wmode:"transparent"},flashVars:{allowedDomain:location.hostname,menu:true}});e.on("swfReady",function(){p.enable();e.setAllowMultipleFiles(false);
e.setFileFilters([{extensions:"*.jpeg;*.jpg;*.png;*.gif",description:"图片文件( png,jpg,jpeg,gif )"}])});var z=j.sizeLimit||Number.MAX_VALUE;d="单张图片容量不超过 "+z/1E3+" M";f=b.one(".ke-img-local-url");f.val(d);e.on("fileSelect",function(h){h=h.fileList;for(var I in h){var A=h[I];if(Math.floor(A.size/1E3)>z){alert(d);f.val(d);e.clearFileList();break}f.val(A.name)}});e.on("uploadStart",function(){e.clearFileList()});e.on("uploadCompleteData",function(h){h=l.trim(h.data).replace(/\\r||\\n/g,"");k.unloading();
if(h){h=D.parse(h);if(h.error)alert(h.error);else{a.imgUrl.val(h.imgUrl);f.val(d);a._insert()}}});e.on("uploadError",function(h){k.unloading();f.val(d);alert(h.status)})};o.on("local",function(){n||J();n.offset(p.el.offset())});o.on("remote",function(){n&&n.offset({left:-9999,top:-9999})});p.disable()}else o.remove("local")},_updateTip:function(a,c){a.html(c.attr("src"));a.attr("href",c.attr("src"))},_real:function(){this.d.show()},_insert:function(){var a=this.imgUrl.val();if(g.Utils.verifyInputs(this.d.el.all("input"))){var c=
parseInt(this.imgHeight.val()),e=this.get("editor"),d=parseInt(this.imgWidth.val()),f=this.imgAlign.val(),k=parseInt(this.imgMargin.val()),b="";if(c)b+="height:"+c+"px;";if(d)b+="width:"+d+"px;";if(f)b+="float:"+f+";";isNaN(k)||(b+="margin:"+k+"px;");if(b)b=" style='"+b+"' ";a=new t("<img "+b+"src='"+a+"' alt='' />",null,e.document);a=e.insertElement(a,c||d?null:function(i){i.on("load",function(){i.detach();i.css({width:i.width()+"px",height:i.height()+"px"})})});this._selectedEl&&e.getSelection().selectElement(a);
this.d.hide();e.notifySelectionChange()}},_updateD:function(a){this._selectedEl=a;this.tab.activate("remote");if(a){this.imgUrl.val(a.attr("src"));this.imgHeight.val(a.height());this.imgWidth.val(a.width());this.imgAlign.val(a.css("float")||"none");this.imgMargin.val(parseInt(a._4e_style("margin"))||0)}else{this.imgUrl.val("http://");this.imgHeight.val("自动");this.imgWidth.val("自动");this.imgAlign.val("none");this.imgMargin.val("5")}},show:function(a,c){this._prepare();this._updateD(c)}});g.ImageInserter=
q;(function(a,c,e){x.register({pluginName:a,func:e,init:function(){var d=this,f=d.el;f.html(c+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">编辑</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">删除</span>');var k=f.one(".ke-bubbleview-url"),b=f.one(".ke-bubbleview-change");f=f.one(".ke-bubbleview-remove");b._4e_unselectable();k._4e_unselectable();f._4e_unselectable();b.on("click",function(i){d._plugin.show(null,
d._selectedEl);i.halt()});f.on("click",function(i){var m=d._plugin;if(C.webkit){var j=m.editor.getSelection().getRanges();j&&j[0]&&(j[0].collapse(true)||1)&&j[0].select()}d._selectedEl._4e_remove();d.hide();m.editor.notifySelectionChange();i.halt()});d.on("afterVisibleChange",function(i){var m=d._selectedEl;i.newVal&&m&&d._plugin._updateTip(k,m)})}})})("image","图片网址： ",r)}();w.addPlugin(function(){new g.ImageInserter({editor:w})})});
