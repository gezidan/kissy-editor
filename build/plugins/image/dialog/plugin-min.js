KISSY.Editor.add("image/dialog",function(r){function H(){h=new e.Dialog({autoRender:true,width:500,headerContent:"\u56fe\u7247",bodyContent:I,footerContent:J,mask:true});var a=h.get("el"),c=a.one(".ke-img-cancel"),f=a.one(".ke-img-insert"),g=e.Utils.verifyInputs,y=a.one(".ke-img-setting");z=a.one(".ke-img-upload-form");j=a.one(".ke-img-local-url");x=new e.Tabs({tabs:a.one("ul.ke-tabs"),contents:a.one("div.ke-image-tabs-content-wrap")});j.val(s);t=a.one(".ke-img-url");m=a.one(".ke-img-height");n=a.one(".ke-img-width");
p=a.one(".ke-img-ratio");A=e.Select.decorate(a.one(".ke-img-align"));B=a.one(".ke-img-margin");var d=e.Utils.placeholder;d(t,K);d(m,C);d(n,C);m.on("keyup",function(){var b=parseInt(m.val());!b||!p[0].checked||p[0].disabled||!u||n.val(Math.floor(b*u))});n.on("keyup",function(){var b=parseInt(n.val());!b||!p[0].checked||p[0].disabled||!u||m.val(Math.floor(b/u))});c.on("click",function(b){h.hide();b.halt()});var i=(new D("<a class='ke-button' style='position:absolute;z-index:"+e.baseZIndex(e.zIndexManager.LOADING_CANCEL)+
";left:-9999px;top:-9999px;'>\u53d6\u6d88\u4e0a\u4f20</a>")).appendTo(document.body),v=null;i.on("click",function(){h.unloading();if(v){L.remove(v,"load");M.remove(v)}i.css({left:-9999,top:-9999});v=null});f.on("click",function(){if(x.activate()=="local"&&k){if(g(y.all("input")))if(j.val()==s)alert("\u8bf7\u5148\u9009\u62e9\u6587\u4ef6!");else if(N.test(j.val())){h.loading();v=e.Utils.doFormUpload({form:z,callback:function(l){v=null;i.css({left:-9999,top:-9999});l=o.trim(l.responseText).replace(/\r|\n/g,"");h.unloading();try{l=O.parse(l)}catch(R){o.log(l);
l={error:"\u670d\u52a1\u5668\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5"}}if(l.error)alert(l.error);else{t.val(l.imgUrl);E()}}},k.serverParams,k.serverUrl);var b=h.get("el"),F=b.offset();i.css({left:F.left+b[0].offsetWidth/2.5,top:F.top+b[0].offsetHeight/1.5})}else{alert(P);z[0].reset();j.val(s)}}else g(a.all("input"))&&E()});if(k){k.extraHtml&&a.one(".ke-img-up-extraHtml").html(k.extraHtml);var G=a.one(".ke-image-up");c=k&&k.sizeLimit;w=(new D("<input type='file' style='position:absolute;cursor:pointer;left:"+(Q.ie?"360":"369")+"px;z-index:2;top:0px;height:26px;' size='1' name='"+
(k.fileInput||"Filedata")+"'/>")).insertAfter(j);if(c)s="\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7 "+c/1E3+" M";j.val(s);w.css({opacity:0});w.on("mouseenter",function(){G.addClass("ke-button-hover")});w.on("mouseleave",function(){G.removeClass("ke-button-hover")});w.on("change",function(){var b=w.val();j.val(b.replace(/.+[\/\\]/,""))})}else x.remove("local")}function E(){var a=t.val(),c=parseInt(m.val()),f=parseInt(n.val()),g=A.val(),y=parseInt(B.val()),d="";if(c)d+="height:"+c+"px;";if(f)d+="width:"+f+"px;";if(g)d+="float:"+g+
";";isNaN(y)||(d+="margin:"+y+"px;");if(d)d=" style='"+d+"' ";c=new D("<img "+d+"src='"+a+"' alt='' />",null,r.document);h.hide();r.insertElement(c,function(i){i.on("abort error",function(){i.detach();i[0].src=a})},function(i){q&&r.getSelection().selectElement(i);r.notifySelectionChange()})}var o=KISSY,e=o.Editor,M=o.DOM,Q=o.UA,O=o.JSON,D=o.Node,L=o.Event,K="http://",C="\u81ea\u52a8",I="<div class='ke-image-wrap'><ul class='ke-tabs ks-clear'><li rel='remote'>\u7f51\u7edc\u56fe\u7247</li><li rel='local'>\u672c\u5730\u4e0a\u4f20</li></ul><div style='padding:12px 20px 5px 20px;'><div class='ke-image-tabs-content-wrap' ><div><label><span class='ke-image-title'>\u56fe\u7247\u5730\u5740\uff1a </span><input  data-verify='^(https?:/)?/[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp:// \u6216 /' class='ke-img-url ke-input' style='width:390px;' /></label></div><div style='position:relative;'><form class='ke-img-upload-form'><p style='zoom:1;'><input class='ke-input ke-img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 368px;color:#969696;'/><a style='padding:3px 11px;position:absolute;left:390px;top:0px;z-index:1;' class='ke-image-up ke-button'>\u6d4f\u89c8...</a></p><div class='ke-img-up-extraHtml'></div></form></div></div><table style='width:100%;margin-top:8px;' class='ke-img-setting'><tr><td><label>\u5bbd\u5ea6\uff1a <input  data-verify='^("+
C+"|((?!0$)\\d+))?$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-width ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label></td><td><label>\u9ad8\u5ea6\uff1a <input  data-verify='^("+C+"|((?!0$)\\d+))?$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-height ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label><label><input type='checkbox' class='ke-img-ratio' style='vertical-align:middle;margin-left:5px;' checked='checked'/> \u9501\u5b9a\u9ad8\u5bbd\u6bd4</label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a<select class='ke-img-align'><option value='none'>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input  data-verify='^\\d+$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570' class='ke-img-margin ke-input' style='width:60px' value='0'/> \u50cf\u7d20</label></td></tr></table></div></div>",
J="<div style='padding:5px 20px 20px;'><a class='ke-img-insert ke-button' style='margin-right:30px;'>\u786e\u5b9a</a> <a  class='ke-img-cancel ke-button'>\u53d6\u6d88</a></div>",N=/(png|jpg|jpeg|gif)$/i,P="\u53ea\u5141\u8bb8\u540e\u7f00\u540d\u4e3apng,jpg,jpeg,gif\u7684\u56fe\u7247",h,x,t,m,n,A,p,B,u,j,w,z,s="\u8bf7\u70b9\u51fb\u6d4f\u89c8\u4e0a\u4f20\u56fe\u7247",q,k=(r.cfg.pluginConfig.image||{}).upload||null;e.use("overlay,tabs,select",function(){r.addDialog("image/dialog",{show:function(a){var c="remote",f=e.Utils.resetInput,g=e.Utils.valInput;if(q=a){g(t,q.attr("src"));a=q.width();f=q.height();g(m,f);g(n,
a);A.val(q.css("float")||"none");g=parseInt(q._4e_style("margin"))||0;B.val(g);p[0].disabled=false;u=a/f}else{if(x.getTab("local"))c="local";f(t);f(m);f(n);A.val("none");B.val(0);p[0].disabled=true;u=null}z[0].reset();j.val(s);x.activate(c);h.show()},hide:function(){h.hide()}});H()})},{attach:false});
