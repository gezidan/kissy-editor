KISSY.Editor.add("image/dialog",function(s){function K(){function j(b){if(b.files)return b.files[0].size;return 0}g=new c.Dialog({autoRender:true,width:500,headerContent:"\u56fe\u7247",bodyContent:L,footerContent:M,mask:true});var a=g.get("el"),d=a.one(".ke-img-cancel"),h=a.one(".ke-img-insert"),x=c.Utils.verifyInputs,i=a.one(".ke-img-setting");A=a.one(".ke-img-upload-form");k=a.one(".ke-img-local-url");y=new c.Tabs({tabs:a.one("ul.ke-tabs"),contents:a.one("div.ke-image-tabs-content-wrap")});k.val(t);u=a.one(".ke-img-url");
m=a.one(".ke-img-height");n=a.one(".ke-img-width");p=a.one(".ke-img-ratio");B=c.Select.decorate(a.one(".ke-img-align"));C=a.one(".ke-img-margin");var l=c.Utils.placeholder;l(u,N);l(m,D);l(n,D);m.on("keyup",function(){var b=parseInt(m.val());!b||!p[0].checked||p[0].disabled||!v||n.val(Math.floor(b*v))});n.on("keyup",function(){var b=parseInt(n.val());!b||!p[0].checked||p[0].disabled||!v||m.val(Math.floor(b/v))});d.on("click",function(b){g.hide();b.halt()});var E=(new F("<a class='ke-button' style='position:absolute;z-index:"+
c.baseZIndex(c.zIndexManager.LOADING_CANCEL)+";left:-9999px;top:-9999px;'>\u53d6\u6d88\u4e0a\u4f20</a>")).appendTo(document.body),w=null;E.on("click",function(){g.unloading();if(w){O.remove(w,"load");P.remove(w)}E.css({left:-9999,top:-9999});w=null});h.on("click",function(){if(y.activate()=="local"&&e){if(x(i.all("input")))if(k.val()==t)alert("\u8bf7\u5148\u9009\u62e9\u6587\u4ef6!");else if(Q.test(k.val())){var b=j(q[0]);if(z&&z<b/1E3)alert("\u4e0a\u4f20\u56fe\u7247\u6700\u5927\uff1a"+z/1E3+"M");else{g.loading();w=c.Utils.doFormUpload({form:A,callback:function(f){w=null;E.css({left:-9999,
top:-9999});f=o.trim(f.responseText).replace(/\r|\n/g,"");g.unloading();try{f=R.parse(f)}catch(U){o.log(f);f=null}f||(f={error:"\u670d\u52a1\u5668\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5"});if(f.error)alert(f.error);else{u.val(f.imgUrl);G()}}},e.serverParams,e.serverUrl);b=g.get("el");var H=b.offset();E.css({left:H.left+b[0].offsetWidth/2.5,top:H.top+b[0].offsetHeight/1.5})}}else{alert(S);A[0].reset();k.val(t)}}else x(a.all("input"))&&G()});if(e){e.extraHtml&&a.one(".ke-img-up-extraHtml").html(e.extraHtml);var I=a.one(".ke-image-up"),z=e&&e.sizeLimit;
q=(new F("<input type='file' style='position:absolute;cursor:pointer;left:"+(T.ie?"360":"369")+"px;z-index:2;top:0px;height:26px;' size='1' name='"+(e.fileInput||"Filedata")+"'/>")).insertAfter(k);if(z)t="\u5355\u5f20\u56fe\u7247\u5bb9\u91cf\u4e0d\u8d85\u8fc7 "+z/1E3+" M";k.val(t);q.css({opacity:0});q.on("mouseenter",function(){I.addClass("ke-button-hover")});q.on("mouseleave",function(){I.removeClass("ke-button-hover")});q.on("change",function(){var b=q.val();k.val(b.replace(/.+[\/\\]/,""))})}else y.remove("local")}function G(){var j=u.val(),
a=parseInt(m.val()),d=parseInt(n.val()),h=B.val(),x=parseInt(C.val()),i="";if(a)i+="height:"+a+"px;";if(d)i+="width:"+d+"px;";if(h)i+="float:"+h+";";isNaN(x)||(i+="margin:"+x+"px;");if(i)i=" style='"+i+"' ";a=new F("<img "+i+"src='"+j+"' alt='' />",null,s.document);g.hide();s.insertElement(a,function(l){l.on("abort error",function(){l.detach();l[0].src=j})},function(l){r&&s.getSelection().selectElement(l);s.notifySelectionChange()})}var o=KISSY,c=o.Editor,P=o.DOM,T=o.UA,R=o.JSON,F=o.Node,O=o.Event,
N="http://",D="\u81ea\u52a8",L="<div class='ke-image-wrap'><ul class='ke-tabs ks-clear'><li rel='remote'>\u7f51\u7edc\u56fe\u7247</li><li rel='local'>\u672c\u5730\u4e0a\u4f20</li></ul><div style='padding:12px 20px 5px 20px;'><div class='ke-image-tabs-content-wrap' ><div><label><span class='ke-image-title'>\u56fe\u7247\u5730\u5740\uff1a </span><input  data-verify='^(https?:/)?/[^\\s]+$'  data-warning='\u7f51\u5740\u683c\u5f0f\u4e3a\uff1ahttp:// \u6216 /' class='ke-img-url ke-input' style='width:390px;' /></label></div><div style='position:relative;'><form class='ke-img-upload-form'><p style='zoom:1;'><input class='ke-input ke-img-local-url' readonly='readonly' style='margin-right: 15px; vertical-align: middle; width: 368px;color:#969696;'/><a style='padding:3px 11px;position:absolute;left:390px;top:0px;z-index:1;' class='ke-image-up ke-button'>\u6d4f\u89c8...</a></p><div class='ke-img-up-extraHtml'></div></form></div></div><table style='width:100%;margin-top:8px;' class='ke-img-setting'><tr><td><label>\u5bbd\u5ea6\uff1a <input  data-verify='^("+
D+"|((?!0$)\\d+))?$'  data-warning='\u5bbd\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-width ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label></td><td><label>\u9ad8\u5ea6\uff1a <input  data-verify='^("+D+"|((?!0$)\\d+))?$'  data-warning='\u9ad8\u5ea6\u8bf7\u8f93\u5165\u6b63\u6574\u6570' class='ke-img-height ke-input' style='vertical-align:middle;width:60px' /> \u50cf\u7d20 </label><label><input type='checkbox' class='ke-img-ratio' style='vertical-align:middle;margin-left:5px;' checked='checked'/> \u9501\u5b9a\u9ad8\u5bbd\u6bd4</label></td></tr><tr><td><label>\u5bf9\u9f50\uff1a<select class='ke-img-align'><option value='none'>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select></label></td><td><label>\u95f4\u8ddd\uff1a <input  data-verify='^\\d+$'  data-warning='\u95f4\u8ddd\u8bf7\u8f93\u5165\u975e\u8d1f\u6574\u6570' class='ke-img-margin ke-input' style='width:60px' value='0'/> \u50cf\u7d20</label></td></tr></table></div></div>",
M="<div style='padding:5px 20px 20px;'><a class='ke-img-insert ke-button' style='margin-right:30px;'>\u786e\u5b9a</a> <a  class='ke-img-cancel ke-button'>\u53d6\u6d88</a></div>",g,y,u,m,n,B,p,C,v,k,q,A,t="\u8bf7\u70b9\u51fb\u6d4f\u89c8\u4e0a\u4f20\u56fe\u7247",r,e=(s.cfg.pluginConfig.image||{}).upload||null,J=e&&e.surfix||"png,jpg,jpeg,gif",Q=RegExp(J.split(/,/).join("|")+"$","i"),S="\u53ea\u5141\u8bb8\u540e\u7f00\u540d\u4e3a"+J+"\u7684\u56fe\u7247";c.use("overlay,tabs,select",function(){s.addDialog("image/dialog",{show:function(j){var a="remote",d=c.Utils.resetInput,h=c.Utils.valInput;if(r=j){h(u,r.attr("src"));
j=r.width();d=r.height();h(m,d);h(n,j);B.val(r.css("float")||"none");h=parseInt(r._4e_style("margin"))||0;C.val(h);p[0].disabled=false;v=j/d}else{if(y.getTab("local"))a="local";d(u);d(m);d(n);B.val("none");C.val(0);p[0].disabled=true;v=null}A[0].reset();k.val(t);y.activate(a);g.show()},hide:function(){g.hide()}});K()})},{attach:false});
