KISSY.Editor.add("htmldataprocessor",function(q){function w(a){if(/mso-list\s*:\s*Ignore/i.test(a.attributes&&a.attributes.style))return true;return n}function x(a,c){var b=new i.HtmlParser.Element("ke:listbullet"),d;if(a)if(a[2]){a=isNaN(a[1])?/^[a-z]+$/.test(a[1])?"lower-alpha":/^[A-Z]+$/.test(a[1])?"upper-alpha":"decimal":"decimal";d="ol"}else{a=/[l\u00B7\u2002]/.test(a[1])?"disc":/[\u006F\u00D8]/.test(a[1])?"circle":/[\u006E\u25C6]/.test(a[1])?"square":"disc";d="ul"}else{a="decimal";d="ol"}b.attributes=
{"ke:listtype":d,style:"list-style-type:"+a+";"};b.add(new i.HtmlParser.Text(c));return b}function D(a){var c=a.attributes,b;if((b=a.removeAnyChildWithName("ke:listbullet"))&&b.length&&(b=b[0])){a.name="ke:li";if(c.style)c.style=s([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(d){d=d.split(" ");d=d[3]||d[1]||d[0];d=parseInt(d,10);if(!p&&r&&d>r)p=d-r;c["ke:margin"]=r=d}]],n)(c.style,a)||"";b=b.attributes;a.addStyle(b.style);t.mix(c,b);return true}return false}function s(a,c){return function(b,
d){var f=[];b.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(g,e,j){e=e.toLowerCase();e=="font-family"&&(j=j.replace(/["']/g,""));for(var k,h,y,l=0;l<a.length;l++)if(a[l]){g=a[l][0];k=a[l][1];h=a[l][2];y=a[l][3];if(e.match(g)&&(!k||j.match(k))){e=y||e;c&&(h=h||j);if(typeof h=="function")h=h(j,d,e);if(h&&h.push){e=h[0];h=h[1]}typeof h=="string"&&f.push([e,h]);return}}!c&&f.push([e,j])});for(b=0;b<f.length;b++)f[b]=f[b].join(":");return f.length?f.join(";")+";":false}}
function z(a){a=a.children;for(var c,b,d,f,g,e,j,k=0;k<a.length;k++){c=a[k];if("ke:li"==c.name){c.name="li";b=c.attributes;d=c.attributes["ke:listtype"];f=parseInt(b["ke:indent"],10)||p&&Math.ceil(b["ke:margin"]/p)||1;b.style&&(b.style=s([["list-style-type",d=="ol"?"decimal":"disc"]],n)(b.style)||"");if(e){if(f>j){e=new i.HtmlParser.Element(d);e.add(c);g.add(e)}else{if(f<j){g=j-f;for(var h;g--&&(h=e.parent);)e=h.parent}e.add(c)}a.splice(k--,1)}else{e=new i.HtmlParser.Element(d);e.add(c);a[k]=e}g=
c;j=f}else e=null}p=0}var n=n,i=KISSY.Editor,t=KISSY,m=t.UA,E=i.NODE,o=i.HtmlParser,u=new o.Filter,v=new o.Filter,A=i.XHTML_DTD;if(!q.htmlDataProcessor){(function(){var a=i.HtmlParser.Fragment.prototype,c=i.HtmlParser.Element.prototype;a.onlyChild=c.onlyChild=function(){var b=this.children;return b.length==1&&b[0]||null};c.removeAnyChildWithName=function(b){for(var d=this.children,f=[],g,e=0;e<d.length;e++){g=d[e];if(g.name){if(g.name==b){f.push(g);d.splice(e--,1)}f=f.concat(g.removeAnyChildWithName(b))}}return f};
c.getAncestor=function(b){for(var d=this.parent;d&&!(d.name&&d.name.match(b));)d=d.parent;return d};a.firstChild=c.firstChild=function(b){for(var d,f=0;f<this.children.length;f++){d=this.children[f];if(b(d))return d;else if(d.name)if(d=d.firstChild(b))return d}return null};c.addStyle=function(b,d,f){var g="";if(typeof d=="string")g+=b+":"+d+";";else{if(typeof b=="object")for(var e in b){if(b.hasOwnProperty(e))g+=e+":"+b[e]+";"}else g+=b;f=d}if(!this.attributes)this.attributes={};b=this.attributes.style||
"";b=(f?[g,b]:[b,g]).join(";");this.attributes.style=b.replace(/^;|;(?=;)/,"")};A.parentOf=function(b){var d={};for(var f in this)if(f.indexOf("$")==-1&&this[f][b])d[f]=1;return d}})();var B=s([[/mso/i],[/font-size/i,"",function(a){for(var c=q.cfg.pluginConfig["font-size"],b=0;b<c.length;b++)if(a.toLowerCase()==c[b])return a;return false},"font-size"],[/font-family/i,"",function(a){for(var c=q.cfg.pluginConfig["font-family"],b=0;b<c.length;b++)if(a.toLowerCase()==c[b].toLowerCase())return a;return false},
"font-family"],[/line-height/i],[/display/i,/none/i]],n),p,r=0,F=A.parentOf("ol"),G={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren();z(a)},elements:{font:function(a){delete a.name},p:function(a){a.filterChildren();if(D(a))return n},$:function(a){var c=a.name||"";c.indexOf(":")!=-1&&c.indexOf("ke")==-1&&delete a.name;var b=a.attributes.style;if(c=="span"&&(!b||!B(b)))delete a.name;
if(c in F){a.filterChildren();z(a)}},table:function(a){var c=a.attributes.border;if(!c||c=="0")a.attributes["class"]="ke_show_border"},td:function(a){if(m.ie){a=a.children;var c=new i.HtmlParser.Text("&nbsp;");if(a.length)a[a.length-1].type!=E.NODE_TEXT&&a.push(c);else a.push(c)}},span:function(a){if(!m.gecko&&w(a.parent))return false;if(!m.gecko&&w(a)){a=(a=a.firstChild(function(b){return b.value||b.name=="img"}))&&(a.value||"l.");var c=a.match(/^([^\s]+?)([.)]?)$/);return x(c,a)}}},comment:!m.ie?
function(a,c){var b=a.match(/<img.*?>/);if(a=a.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/)){b=(c=a[1]||b&&"l.")&&c.match(/>([^\s]+?)([.)]?)</);return x(b,c)}if(m.gecko&&b){b=i.HtmlParser.Fragment.FromHtml(b[0]).children[0];(c=(c=(c=c.previous)&&c.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&c[1])&&(b.attributes.src=c);return b}return false}:function(){return false},attributes:{"class":function(a){if(/^ke_/.test(a))return a;return false},style:function(a){a=B(a);if(!a)return false;
return a}},attributeNames:[[/^on/,"ck_on"],[/^lang$/,""]]},C={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(a){var c=a.parent;if(c&&c.name=="object"){var b=c.attributes.width;c=c.attributes.height;b&&(a.attributes.width=b);c&&(a.attributes.height=c)}},param:function(a){a.children=[];a.isEmpty=true;return a},a:function(a){if(!(a.children.length||a.attributes.name))return false},td:function(a){for(var c=a.children,b=0;b<c.length;b++)if(c[b].name=="br"){c.splice(b,1);--b}if(!a.children.length){c=
new i.HtmlParser.Text("&nbsp;");a.children.push(c)}},span:function(a){if(!a.children.length)return false}},attributes:{style:function(a){if(!t.trim(a))return false}},attributeNames:[[/^ck_on/,"on"],[/^ke:.*$/,""]]};if(m.ie)C.attributes.style=function(a){return a.toLowerCase()};u.addRules(C);v.addRules(G);q.htmlDataProcessor={htmlFilter:u,dataFilter:v,toHtml:function(a,c){var b=new o.HtmlWriter;o.Fragment.FromHtml(a,c).writeHtml(b,u);return b.getHtml(true)},toDataFormat:function(a,c){if(m.gecko)a=
a.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var b=new o.BasicWriter;a=o.Fragment.FromHtml(a,c);b.reset();a.writeHtml(b,v);return b.getHtml(true)}}}});
