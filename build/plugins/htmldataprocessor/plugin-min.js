KISSY.Editor.add("htmldataprocessor",function(F){var y=y,z=KISSY,l=z.Editor,I=z.Node,u=z.UA,C=l.NODE,v=l.HtmlParser,A=new v.Filter,D=new v.Filter,G=l.XHTML_DTD;if(!F.htmlDataProcessor){(function(){var j=l.HtmlParser.Fragment.prototype,k=l.HtmlParser.Element.prototype;j.onlyChild=k.onlyChild=function(){var d=this.children;return d.length==1&&d[0]||null};k.removeAnyChildWithName=function(d){for(var f=this.children,h=[],m,g=0;g<f.length;g++){m=f[g];if(m.name){if(m.name==d){h.push(m);f.splice(g--,1)}h=
h.concat(m.removeAnyChildWithName(d))}}return h};k.getAncestor=function(d){for(var f=this.parent;f&&!(f.name&&f.name.match(d));)f=f.parent;return f};j.firstChild=k.firstChild=function(d){for(var f,h=0;h<this.children.length;h++){f=this.children[h];if(d(f))return f;else if(f.name)if(f=f.firstChild(d))return f}return null};k.addStyle=function(d,f,h){var m="";if(typeof f=="string")m+=d+":"+f+";";else{if(typeof d=="object")for(var g in d){if(d.hasOwnProperty(g))m+=g+":"+d[g]+";"}else m+=d;h=f}if(!this.attributes)this.attributes=
{};d=this.attributes.style||"";d=(h?[m,d]:[d,m]).join(";");this.attributes.style=d.replace(/^;|;(?=;)/,"")};G.parentOf=function(d){var f={},h;for(h in this)if(h.indexOf("$")==-1&&this[h][d])f[h]=1;return f}})();(function(){function j(a){if(/mso-list\s*:\s*Ignore/i.test(a.attributes&&a.attributes.style))return true;return y}function k(a,b){var c=new l.HtmlParser.Element("ke:listbullet"),e;if(a)if(a[2]){a=isNaN(a[1])?/^[a-z]+$/.test(a[1])?"lower-alpha":/^[A-Z]+$/.test(a[1])?"upper-alpha":"decimal":
"decimal";e="ol"}else{a=/[l\u00B7\u2002]/.test(a[1])?"disc":/[\u006F\u00D8]/.test(a[1])?"circle":/[\u006E\u25C6]/.test(a[1])?"square":"disc";e="ul"}else{a="decimal";e="ol"}c.attributes={"ke:listtype":e,style:"list-style-type:"+a+";"};c.add(new l.HtmlParser.Text(b));return c}function d(a){var b=a.attributes,c;if((c=a.removeAnyChildWithName("ke:listbullet"))&&c.length&&(c=c[0])){a.name="ke:li";if(b.style)b.style=f([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(e){e=e.split(" ");
e=e[3]||e[1]||e[0];e=parseInt(e,10);if(!g&&s&&e>s)g=e-s;b["ke:margin"]=s=e}]],y)(b.style,a)||"";c=c.attributes;a.addStyle(c.style);z.mix(b,c);return true}return false}function f(a,b){return function(c,e){var p=[];c.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(o,n,r){n=n.toLowerCase();n=="font-family"&&(r=r.replace(/["']/g,""));for(var B,q,H,x=0;x<a.length;x++)if(a[x]){o=a[x][0];B=a[x][1];q=a[x][2];H=a[x][3];if(n.match(o)&&(!B||r.match(B))){n=H||n;b&&(q=q||r);if(typeof q==
"function")q=q(r,e,n);if(q&&q.push){n=q[0];q=q[1]}typeof q=="string"&&p.push([n,q]);return}}!b&&p.push([n,r])});for(var t=0;t<p.length;t++)p[t]=p[t].join(":");return p.length?p.join(";")+";":false}}function h(a){a=a.children;for(var b,c,e,p,t,o,n,r=0;r<a.length;r++){b=a[r];if("ke:li"==b.name){b.name="li";b=b;c=b.attributes;e=b.attributes["ke:listtype"];p=parseInt(c["ke:indent"],10)||g&&Math.ceil(c["ke:margin"]/g)||1;c.style&&(c.style=f([["list-style-type",e=="ol"?"decimal":"disc"]],y)(c.style)||"");
if(o){if(p>n){o=new l.HtmlParser.Element(e);o.add(b);t.add(o)}else{if(p<n){t=n-p;for(var B;t--&&(B=o.parent);)o=B.parent}o.add(b)}a.splice(r--,1)}else{o=new l.HtmlParser.Element(e);o.add(b);a[r]=o}t=b;n=p}else o=null}g=0}var m=f([[/mso/i],[/^-ms/i],[/^-moz/i],[/^-webkit/i],[/line-height/i],[/display/i,/none/i]],y),g,s=0,w=G.parentOf("ol"),E={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren();
h(a)},elements:{font:function(a){delete a.name},p:function(a){a.filterChildren();if(d(a))return y},$:function(a){var b=a.name||"";b.indexOf(":")!=-1&&b.indexOf("ke")==-1&&delete a.name;var c=a.attributes.style;if(b=="span"&&(!c||!m(c)))delete a.name;if(b in w){a.filterChildren();h(a)}},span:function(a){if(!u.gecko&&j(a.parent))return false;if(!u.gecko&&j(a)){a=(a=a.firstChild(function(c){return c.value||c.name=="img"}))&&(a.value||"l.");var b=a.match(/^([^\s]+?)([.)]?)$/);return k(b,a)}},a:function(a){a=
a.attributes;if(a.href)a._ke_saved_href=a.href}},comment:!u.ie?function(a,b){var c=a.match(/<img.*?>/),e=a.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/);if(e){e=(c=e[1]||c&&"l.")&&c.match(/>([^\s]+?)([.)]?)</);return k(e,c)}if(u.gecko&&c){c=l.HtmlParser.Fragment.FromHtml(c[0]).children[0];(e=(e=(e=b.previous)&&e.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&e[1])&&(c.attributes.src=e);return c}return false}:function(){return false},attributes:{"class":function(a){if(/(^|\s+)ke_/.test(a))return a;
return false},style:function(a){a=m(a);if(!a)return false;return a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},i={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],elements:{embed:function(a){var b=a.parent;if(b&&b.name=="object"){var c=b.attributes.width;b=b.attributes.height;c&&(a.attributes.width=c);b&&(a.attributes.height=b)}},param:function(a){a.children=[];a.isEmpty=true;return a},a:function(a){if(!(a.children.length||a.attributes.name))return false;a=a.attributes;if(a._ke_saved_href)a.href=
a._ke_saved_href},td:function(a){for(var b=a.children,c=0;c<b.length;c++)if(b[c].name=="br"){b.splice(c,1);--c}if(!a.children.length){b=new l.HtmlParser.Text("&nbsp;");a.children.push(b)}},span:function(a){if(!a.children.length)return false}},attributes:{style:function(a){if(!z.trim(a))return false}},attributeNames:[[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,""]]};if(u.ie)i.attributes.style=function(a){return a.toLowerCase()};A.addRules(i);D.addRules(E)})();(function(){function j(i){for(var a=i.children.length,
b=i.children[a-1];b&&b.type==C.NODE_TEXT&&!z.trim(b.value);)b=i.children[--a];return b}function k(i){var a=j(i);return!a||a.type==C.NODE_ELEMENT&&a.name=="br"||i.name=="form"&&a.name=="input"}function d(i,a){var b=i.children,c=j(i);if(c){if((a||!u.ie)&&c.type==C.NODE_ELEMENT&&c.name=="br")b.pop();c.type==C.NODE_TEXT&&m.test(c.value)&&b.pop()}}function f(i){d(i,true);if(k(i))u.ie?i.add(new l.HtmlParser.Text("\u00a0")):i.add(new l.HtmlParser.Element("br",{}))}function h(i){d(i);k(i)&&i.add(new l.HtmlParser.Text("\u00a0"))}
var m=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,g=l.XHTML_DTD,s=l.Utils.mix({},g.$block,g.$listItem,g.$tableContent),w;for(w in s)"br"in g[w]||delete s[w];delete s.pre;g={elements:{}};var E={elements:{}};for(w in s){g.elements[w]=f;E.elements[w]=h}D.addRules(g);A.addRules(E)})();(function(){A.addRules({text:function(j){return j.replace(/\xa0/g,"&nbsp;")}})})();F.htmlDataProcessor={htmlFilter:A,dataFilter:D,toHtml:function(j,k){var d=new v.HtmlWriter;v.Fragment.FromHtml(j,k).writeHtml(d,A);return d.getHtml(true)},
toDataFormat:function(j,k){if(u.gecko)j=j.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var d=new I("<div>");d.html("a"+j);j=d.html().substr(1);d=new v.BasicWriter;var f=v.Fragment.FromHtml(j,k);d.reset();f.writeHtml(d,D);return d.getHtml(true)},toServer:function(j,k){var d=new v.BasicWriter;v.Fragment.FromHtml(j,k).writeHtml(d,A);return d.getHtml(true)}}}});
