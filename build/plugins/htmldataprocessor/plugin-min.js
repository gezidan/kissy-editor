KISSY.Editor.add("htmldataprocessor",function(u){function B(a){if(/mso-list\s*:\s*Ignore/i.test(a.attributes&&a.attributes.style))return true;return p}function C(a,d){var b=new k.HtmlParser.Element("ke:listbullet"),c;if(a)if(a[2]){a=isNaN(a[1])?/^[a-z]+$/.test(a[1])?"lower-alpha":/^[A-Z]+$/.test(a[1])?"upper-alpha":"decimal":"decimal";c="ol"}else{a=/[l\u00B7\u2002]/.test(a[1])?"disc":/[\u006F\u00D8]/.test(a[1])?"circle":/[\u006E\u25C6]/.test(a[1])?"square":"disc";c="ul"}else{a="decimal";c="ol"}b.attributes=
{"ke:listtype":c,style:"list-style-type:"+a+";"};b.add(new k.HtmlParser.Text(d));return b}function H(a){var d=a.attributes,b;if((b=a.removeAnyChildWithName("ke:listbullet"))&&b.length&&(b=b[0])){a.name="ke:li";if(d.style)d.style=z([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(c){c=c.split(" ");c=c[3]||c[1]||c[0];c=parseInt(c,10);if(!r&&v&&c>v)r=c-v;d["ke:margin"]=v=c}]],p)(d.style,a)||"";b=b.attributes;a.addStyle(b.style);w.mix(d,b);return true}return false}function z(a,d){return function(b,
c){var e=[];b.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(g,i,j){i=i.toLowerCase();i=="font-family"&&(j=j.replace(/["']/g,""));for(var n,f,m,l=0;l<a.length;l++)if(a[l]){g=a[l][0];n=a[l][1];f=a[l][2];m=a[l][3];if(i.match(g)&&(!n||j.match(n))){i=m||i;d&&(f=f||j);if(typeof f=="function")f=f(j,c,i);if(f&&f.push){i=f[0];f=f[1]}typeof f=="string"&&e.push([i,f]);return}}!d&&e.push([i,j])});for(var h=0;h<e.length;h++)e[h]=e[h].join(":");return e.length?e.join(";")+";":
false}}function D(a){a=a.children;for(var d,b,c,e,h,g,i,j=0;j<a.length;j++){d=a[j];if("ke:li"==d.name){d.name="li";d=d;b=d.attributes;c=d.attributes["ke:listtype"];e=parseInt(b["ke:indent"],10)||r&&Math.ceil(b["ke:margin"]/r)||1;b.style&&(b.style=z([["list-style-type",c=="ol"?"decimal":"disc"]],p)(b.style)||"");if(g){if(e>i){g=new k.HtmlParser.Element(c);g.add(d);h.add(g)}else{if(e<i){h=i-e;for(var n;h--&&(n=g.parent);)g=n.parent}g.add(d)}a.splice(j--,1)}else{g=new k.HtmlParser.Element(c);g.add(d);
a[j]=g}h=d;i=e}else g=null}r=0}var p=p,k=KISSY.Editor,w=KISSY,o=w.UA,x=k.NODE,q=k.HtmlParser,s=new q.Filter,y=new q.Filter,E=k.XHTML_DTD;if(!u.htmlDataProcessor){(function(){var a=k.HtmlParser.Fragment.prototype,d=k.HtmlParser.Element.prototype;a.onlyChild=d.onlyChild=function(){var b=this.children;return b.length==1&&b[0]||null};d.removeAnyChildWithName=function(b){for(var c=this.children,e=[],h,g=0;g<c.length;g++){h=c[g];if(h.name){if(h.name==b){e.push(h);c.splice(g--,1)}e=e.concat(h.removeAnyChildWithName(b))}}return e};
d.getAncestor=function(b){for(var c=this.parent;c&&!(c.name&&c.name.match(b));)c=c.parent;return c};a.firstChild=d.firstChild=function(b){for(var c,e=0;e<this.children.length;e++){c=this.children[e];if(b(c))return c;else if(c.name)if(c=c.firstChild(b))return c}return null};d.addStyle=function(b,c,e){var h="";if(typeof c=="string")h+=b+":"+c+";";else{if(typeof b=="object")for(var g in b){if(b.hasOwnProperty(g))h+=g+":"+b[g]+";"}else h+=b;e=c}if(!this.attributes)this.attributes={};b=this.attributes.style||
"";b=(e?[h,b]:[b,h]).join(";");this.attributes.style=b.replace(/^;|;(?=;)/,"")};E.parentOf=function(b){var c={},e;for(e in this)if(e.indexOf("$")==-1&&this[e][b])c[e]=1;return c}})();var A=k.Utils.equalsIgnoreCase,F=z([[/mso/i],[/font-size/i,"",function(a){for(var d=u.cfg.pluginConfig["font-size"].items,b=0;b<d.length;b++)if(A(a,d[b].value))return a;return false},"font-size"],[/font-family/i,"",function(a){for(var d=u.cfg.pluginConfig["font-family"].items,b=0;b<d.length;b++){var c=d[b].value.toLowerCase();
if(A(a,c)||A(a,d[b].name))return c}return false},"font-family"],[/line-height/i],[/display/i,/none/i]],p),r,v=0,I=E.parentOf("ol"),J={elementNames:[[/^script$/i,""],[/^iframe$/i,""],[/^style$/i,""],[/^link$/i,""],[/^meta$/i,""],[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],root:function(a){a.filterChildren();D(a)},elements:{font:function(a){delete a.name},p:function(a){a.filterChildren();if(H(a))return p},$:function(a){var d=a.name||"";d.indexOf(":")!=-1&&d.indexOf("ke")==-1&&delete a.name;var b=a.attributes.style;
if(d=="span"&&(!b||!F(b)))delete a.name;if(d in I){a.filterChildren();D(a)}},td:function(a){delete a.attributes.style},span:function(a){if(!o.gecko&&B(a.parent))return false;if(!o.gecko&&B(a)){a=(a=a.firstChild(function(b){return b.value||b.name=="img"}))&&(a.value||"l.");var d=a.match(/^([^\s]+?)([.)]?)$/);return C(d,a)}},a:function(a){a=a.attributes;if(a.href)a._ke_saved_href=a.href}},comment:!o.ie?function(a,d){var b=a.match(/<img.*?>/),c=a.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/);if(c){c=
(b=c[1]||b&&"l.")&&b.match(/>([^\s]+?)([.)]?)</);return C(c,b)}if(o.gecko&&b){b=k.HtmlParser.Fragment.FromHtml(b[0]).children[0];(c=(c=(c=d.previous)&&c.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/))&&c[1])&&(b.attributes.src=c);return b}return false}:function(){return false},attributes:{"class":function(a){if(/(^|\s+)ke_/.test(a))return a;return false},style:function(a){a=F(a);if(!a)return false;return a}},attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]]},G={elementNames:[[/^ke:/,""],[/^\?xml:namespace$/,
""]],elements:{embed:function(a){var d=a.parent;if(d&&d.name=="object"){var b=d.attributes.width;d=d.attributes.height;b&&(a.attributes.width=b);d&&(a.attributes.height=d)}},param:function(a){a.children=[];a.isEmpty=true;return a},a:function(a){if(!(a.children.length||a.attributes.name))return false;a=a.attributes;if(a._ke_saved_href)a.href=a._ke_saved_href},td:function(a){for(var d=a.children,b=0;b<d.length;b++)if(d[b].name=="br"){d.splice(b,1);--b}if(!a.children.length){d=new k.HtmlParser.Text("&nbsp;");
a.children.push(d)}},span:function(a){if(!a.children.length)return false}},attributes:{style:function(a){if(!w.trim(a))return false}},attributeNames:[[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,""]]};if(o.ie)G.attributes.style=function(a){return a.toLowerCase()};s.addRules(G);y.addRules(J);(function(){function a(f){for(var m=f.children.length,l=f.children[m-1];l&&l.type==x.NODE_TEXT&&!w.trim(l.value);)l=f.children[--m];return l}function d(f){var m=a(f);return!m||m.type==x.NODE_ELEMENT&&m.name=="br"||
f.name=="form"&&m.name=="input"}function b(f,m){var l=f.children,t=a(f);if(t){if((m||!o.ie)&&t.type==x.NODE_ELEMENT&&t.name=="br")l.pop();t.type==x.NODE_TEXT&&h.test(t.value)&&l.pop()}}function c(f){b(f,true);if(d(f))o.ie?f.add(new k.HtmlParser.Text("\u00a0")):f.add(new k.HtmlParser.Element("br",{}))}function e(f){b(f);d(f)&&f.add(new k.HtmlParser.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,g=k.XHTML_DTD,i=k.Utils.mix({},g.$block,g.$listItem,g.$tableContent),j;for(j in i)"br"in g[j]||delete i[j];delete i.pre;
g={elements:{}};var n={elements:{}};for(j in i){g.elements[j]=c;n.elements[j]=e}y.addRules(g);s.addRules(n)})();(function(){s.addRules({text:function(a){return a.replace(/&nbsp;/g,"\u00a0").replace(/\xa0/g,"&nbsp;")}})})();u.htmlDataProcessor={htmlFilter:s,dataFilter:y,toHtml:function(a,d){var b=new q.HtmlWriter;q.Fragment.FromHtml(a,d).writeHtml(b,s);return b.getHtml(true)},toDataFormat:function(a,d){if(o.gecko)a=a.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi,"$1$2$3");var b=new q.BasicWriter,
c=q.Fragment.FromHtml(a,d);b.reset();c.writeHtml(b,y);return b.getHtml(true)}}}});
