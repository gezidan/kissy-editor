KISSY.Editor.add("indent",function(m){var h=KISSY.Editor,k={ol:1,ul:1},l=KISSY,n=h.Walker,r=l.DOM,s=l.Node,y=l.UA,p=h.NODE;h.Indent||function(){function t(a){this.type=a;this.indentCssProperty="margin-left";this.indentOffset=40;this.indentUnit="px"}function u(a){return a.type=CKEDITOR.NODE_ELEMENT&&a.is("li")}function z(a,d,b){var c=d.startContainer;for(a=d.endContainer;c&&!c.parent()._4e_equals(b);)c=c.parent();for(;a&&!a.parent()._4e_equals(b);)a=a.parent();if(c&&a){var f=c;c=[];for(var e=false;!e;){if(f._4e_equals(a))e=
true;c.push(f);f=f.next()}if(!(c.length<1)){f=b._4e_parents(true);for(a=0;a<f.length;a++)if(k[f[a]._4e_name()]){b=f[a];break}f=this.type=="indent"?1:-1;a=c[0];e=c[c.length-1];c={};var g=h.ListUtils.listToArray(b,c),A=g[e.data("listarray_index")].indent;for(a=a.data("listarray_index");a<=e.data("listarray_index");a++){g[a].indent+=f;var v=g[a].parent;g[a].parent=new s(v[0].ownerDocument.createElement(v._4e_name()))}for(a=e.data("listarray_index")+1;a<g.length&&g[a].indent>A;a++)g[a].indent+=f;e=h.ListUtils.arrayToList(g,
c,null,"p",0);f=[];if(this.type=="outdent"){var q;if((q=b.parent())&&q._4e_name()=="li"){g=e.listNode.childNodes;var i;for(a=g.length-1;a>=0;a--)if((i=new s(g[a]))&&i._4e_name()=="li")f.push(i)}}if(e){r.insertBefore(e.listNode,b[0]);b._4e_remove()}if(f&&f.length)for(a=0;a<f.length;a++){for(i=b=f[a];(i=i.next())&&i._4e_name()in k;){y.ie&&!b._4e_first(function(w){return B(w)&&C(w)})&&b[0].appendChild(d.document.createTextNode("\u00a0"));b[0].appendChild(i[0])}r.insertAfter(b[0],q[0])}for(a in c)c[a]._4e_clearMarkers(c,
true)}}}function x(a,d){var b=parseInt(d._4e_style(this.indentCssProperty),10);if(isNaN(b))b=0;b+=(this.type=="indent"?1:-1)*this.indentOffset;if(b<0)return false;b=Math.max(b,0);b=Math.ceil(b/this.indentOffset)*this.indentOffset;d.css(this.indentCssProperty,b?b+this.indentUnit:"");d[0].style.cssText===""&&d[0].removeAttribute("style");return true}function o(a){o.superclass.constructor.call(this,a);a=this.get("editor").toolBarDiv;this.el=new j({container:a,contentCls:this.get("contentCls"),title:this.get("title")});
this.indentCommand=new t(this.get("type"));this._init()}var B=n.whitespaces(true),C=n.bookmark(false,true);l.augment(t,{exec:function(a){for(var d=a.getSelection(),b=d&&d.getRanges()[0],c=b.startContainer,f=b.endContainer,e=b.getCommonAncestor();e&&!(e[0].nodeType==p.NODE_ELEMENT&&k[e._4e_name()]);)e=e.parent();if(e&&c[0].nodeType==p.NODE_ELEMENT&&c._4e_name()in k){c=new n(b);c.evaluator=u;b.startContainer=c.next()}if(e&&f[0].nodeType==p.NODE_ELEMENT&&f._4e_name()in k){c=new n(b);c.evaluator=u;b.endContainer=
c.previous()}f=d.createBookmarks(true);if(e){for(c=e._4e_first();c&&c[0]&&c._4e_name()!="li";)c=c.next();var g=b.startContainer;(c[0]==g[0]||c.contains(g))&&x.call(this,a,e)||z.call(this,a,b,e)}else{b=b.createIterator();b.enforceRealBlocks=true;for(b.enlargeBr=true;e=b.getNextParagraph();)x.call(this,a,e)}d.selectBookmarks(f)}});var j=h.TripleButton;o.ATTRS={type:{},contentCls:{},editor:{}};l.extend(o,l.Base,{_init:function(){var a=this.get("editor"),d=this.el;d.on("offClick",this.exec,this);this.get("type")==
"outdent"?a.on("selectionChange",this._selectionChange,this):d.set("state",j.OFF);h.Utils.sourceDisable(a,this)},disable:function(){this.el.set("state",j.DISABLED)},enable:function(){this.el.set("state",j.OFF)},exec:function(){var a=this.get("editor"),d=this;a.fire("save");setTimeout(function(){d.indentCommand.exec(a);a.fire("save");a.notifySelectionChange()},10)},_selectionChange:function(a){this.get("editor");this.get("type");var d=a.path,b=d.blockLimit;a=this.el;if(d.contains(k))a.set("state",
j.OFF);else(d=d.block||b)&&d._4e_style(this.indentCommand.indentCssProperty)?a.set("state",j.OFF):a.set("state",j.DISABLED)}});h.Indent=o}();m.addPlugin(function(){m.addCommand("outdent",new h.Indent({editor:m,title:"\u51cf\u5c11\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-outdent",type:"outdent"}));m.addCommand("indent",new h.Indent({editor:m,title:"\u589e\u52a0\u7f29\u8fdb\u91cf ",contentCls:"ke-toolbar-indent",type:"indent"}))})});
